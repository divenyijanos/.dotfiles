0:very_active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$very_active_cutoff]
0:very_active_summary <- restrictDataToContacts(all_data, very_active_contacts) %>% calculateSummary()
0:very_active_summary %>%
0:plotOpenRateEvolutionWithPast(sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(very_active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:campaign_summary %>%
0:addWeekendToSummaries_() %>%
0:plotOpenRateEvolutionWithPast(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:source('global.R')
0:generateRelativeData(campaign_summary)
0:generateRelativeData(campaign_summary) %>%
0:.[, day := wday(send_day, label = TRUE)] %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE) +
0:facet_wrap(~ day, ncol = 1)
0:addWeekendToSummary(campaign_summary)
0:addWeekendToSummary_(campaign_summary)
0:campaign_summary %>%
0:plotOpenRateEvolutionWithPast(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:campaign_summary %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:source('global.R')
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:addWeekdayToDt_ <- function(dt) {
0:dt[, weekday := wday(send_day, label = TRUE)]
0:}
0:addWeekdayToDt_(campaign_summary)
0:campaign_summary %>% plotOpenRatesByDays()
0:source('global.R')
0:source('global.R')
0:source('global.R')
0:source('global.R')
0:past_campaign_data_by_segment <- restrictDataToContacts(past_campaign_data, contacts_to_restrict)
0:past_campaign_dates <- unique(
0:past_campaign_data_by_segment[, .(campaign_id, send_day)],
0:by = 'campaign_id',
0:mult = 'first'
0:) %>% .[, .(campaign_id, send_day = as.Date(send_day))]
0:past_campaign_data_by_segment <- mergeDateBack(past_campaign_data_by_segment, past_campaign_dates)
0:restricted_campaign_data <- restrictDataToContacts(campaign_data, contacts_to_restrict)
0:all_data <- combinePastAndSTO(restricted_campaign_data, past_campaign_data_by_segment)
0:rm(past_campaign_data_by_segment, restricted_campaign_data)
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:campaign_summary <- calculateSummary(all_data) %>%
0:addWeekdayToDt_() %>%
0:addWeekendToSummary_()
0:camapign_summary
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:campaign_summary
0:sapply(campaign_summary, class)
0:campaign_summary[weekday == 1]
0:campaign_summary[weekday == factor(1)]
0:campaign_summary[weekday]
0:campaign_summary[, weekday]
0:campaign_summary[weekday == 'Sun']
0:levels(campaign_summary$weekday)
0:generateRelativeData <- function(summary, wdays_to_keep = NULL) {
0:summary %>%
0:dcast(send_day + weekday + period ~ segment, value.var = c('open_rate')) %>%
0:`if`(is.null(wdays_to_keep), . , .[weekday %in% wdays_to_keep]) %>%
0:.[, relative_open_rate := sto / control] %>%
0:.[!is.na(sto)]
0:}
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData(campaign_summary, weekdays_to_keep = c('Tue', 'Wed', 'Thurs')) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData <- function(summary, weekdays_to_keep = NULL) {
0:summary %>%
0:dcast(send_day + weekday + period ~ segment, value.var = c('open_rate')) %>%
0:`if`(is.null(wdays_to_keep), . , .[weekday %in% wdays_to_keep]) %>%
0:.[, relative_open_rate := sto / control] %>%
0:.[!is.na(sto)]
0:}
0:generateRelativeData(campaign_summary, weekdays_to_keep = c('Tue', 'Wed', 'Thurs')) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData <- function(summary, weekdays_to_keep = NULL) {
0:summary %>%
0:dcast(send_day + weekday + period ~ segment, value.var = c('open_rate')) %>%
0:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
0:.[, relative_open_rate := sto / control] %>%
0:.[!is.na(sto)]
0:}
0:generateRelativeData(campaign_summary, weekdays_to_keep = c('Tue', 'Wed', 'Thurs')) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData(campaign_summary, weekdays_to_keep = c('Mon', 'Sun')) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE) +
0:facet_wrap(~ weekday, ncol = 1)
0:weekdays
0:lubridate::wday
0:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate(SETTINGS[[customer]]$start_date)
0:campaign_summary %>% plotOpenRatesByDays()
0:plotOpenRatesByDays <- function(summary) {
0:summary %>%
0:ggplot(aes(x = weekday, y = open_rate)) +
0:geom_boxplot(aes(col = segment), varwidth = T) +
0:facet_wrap(~ period) +
0:theme(legend.position = 'bottom')
0:}
0:campaign_summary %>% plotOpenRatesByDays()
0:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
0:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
0:active_summary <- restrictDataToContacts(all_data, active_contacts) %>% calculateSummary()
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:source('global.R')
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
0:active_summary <- restrictDataToContacts(all_data, active_contacts) %>% calculateSummary()
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:very_active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$very_active_cutoff]
0:very_active_summary <- restrictDataToContacts(all_data, very_active_contacts) %>% calculateSummary()
0:generateRelativeData(very_active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:campaign_summary %>%
0:plotOpenRateEvolutionWithPast(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:generateRelativeData(active_summary) %>%
0:addWeekendToSummary() %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
0:facet_grid(. ~ weekend)
0:plotRelativeOpenRateEvolution <- function(relative_data, sto_start_date, weekends = FALSE, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, offset = 2) {
0:p <- relative_data[send_day < Sys.Date() - offset] %>%
0:ggplot(aes(x = send_day, y = relative_open_rate)) +
0:geom_line() +
0:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
0:geom_hline(yintercept = 1, linetype = 'dashed') +
0:geom_vline(
0:aes(xintercept = as.numeric(as.Date(sto_start_date))),
0:linetype = 'dashed'
0:)
0:if (text) {
0:p <- p +
0:geom_text(
0:data = data.frame(x = as.Date(sto_start_date), y = 0.8),
0:aes(x, y, label = 'Start of STO'),
0:hjust = 1.1
0:)
0:}
0:if (trendlines) {
0:p <- p + geom_smooth(aes(group = send_day < as.Date(sto_start_date)), method = 'lm')
0:}
0:if (prior_change_dates) {
0:p <- p + geom_vline(
0:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
0:aes(xintercept = date),
0:linetype = 'dotted'
0:)
0:}
0:if (weekends) {
0:p <- p + facet_wrap(~ weekend)
0:}
0:p
0:}
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, weekend = TRUE)
0:generateRelativeData(active_summary)
0:generateRelativeData <- function(summary, weekdays_to_keep = NULL) {
0:summary %>%
0:dcast(send_day + weekday + weekend + period ~ segment, value.var = c('open_rate')) %>%
0:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
0:.[, relative_open_rate := sto / control] %>%
0:.[!is.na(sto)]
0:}
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, weekend = TRUE)
0:generateRelativeData(active_summary)
0:active_summary
0:active_summary[, .N, by = weekend]
0:source('global.R')
0:campaign_summary <- calculateSummary(all_data)
0:campaign_summary %>% plotOpenRatesByDays()
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, weekend = TRUE)
0:active_summary <- restrictDataToContacts(all_data, active_contacts) %>% calculateSummary()
0:generateRelativeData(active_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, weekend = TRUE)
0:mean_passed_time <- campaign_data[segment == 'sto'] %>%
0:copy() %>%
0:.[, passed_time := send_time - shift(send_time, 1), by = contact_id] %>%
0:.[, .(avg_passed_time = mean(passed_time)), by = send_day]
0:mean_passed_time
0:q()
0:source('global.R')
0:customer <- 'travelist_market'
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:reportStatistics(customer_data$campaign_data, customer, customer_data$campaigns, check_pairwise_common = FALSE)
0:contacts_to_restrict <- unique_contacts
0:contacts_to_restrict <- common_contacts
0:contacts_to_restrict <- unique_contacts
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:source('global.R')
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:plotSendTimeDistributionEvolution(all_data[segment == 'sto'])
0:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
0:calculateShareOfCommonContacts(667056, 689898, all_data)
0:all_data[period == 'sto']
0:calculateShareOfCommonContacts(667056, 669863, all_data)
0:calculateShareOfCommonContacts2 <- function(campaign_id1, campaign_id2, dt) {
0:merge(dt[campaign_id == campaign_id1, .(contact_id, c1 = campaign_id)], dt[campaing_id == campaign_id2, .(contact_id, c2 = campaign_id)], all = TRUE)
0:}
0:calculateShareOfCommonContacts2(667056, 669863, all_data)
0:calculateShareOfCommonContacts2 <- function(campaign_id1, campaign_id2, dt) {
0:merge(dt[campaign_id == campaign_id1, .(contact_id, c1 = campaign_id)], dt[campaign_id == campaign_id2, .(contact_id, c2 = campaign_id)], all = TRUE)
0:}
0:calculateShareOfCommonContacts2(667056, 669863, all_data)
0:calculateShareOfCommonContacts2 <- function(campaign_id1, campaign_id2, dt) {
0:merge(
0:dt[campaign_id == campaign_id1, .(contact_id, c1 = campaign_id)],
0:dt[campaign_id == campaign_id2, .(contact_id, c2 = campaign_id)],
0:by = 'contact_id', all = TRUE
0:)
0:}
0:calculateShareOfCommonContacts2(667056, 669863, all_data)
0:calculateShareOfCommonContacts2(667056, 669863, all_data)[.N, by = c1]
0:calculateShareOfCommonContacts2(667056, 669863, all_data)[, .N, by = c1]
0:calculateShareOfCommonContacts2(667056, 669863, all_data)[, .N, by = c2]
0:calculateShareOfCommonContacts <- function(campaign_id1, campaign_id2, dt) {
0:length(intersect(
0:dt[campaign_id == campaign_id1, contact_id],
0:dt[campaign_id == campaign_id2, contact_id]
0:)) / max(
0:nrow(dt[campaign_id == campaign_id1]),
0:nrow(dt[campaign_id == campaign_id2])
0:)
0:}
0:createCampaignIdsSummaryFromCampaignData <- function(dt) {
0:dt[
0:, .(first_send_day = min(send_day)), by = 'campaign_id'
0:] %>%
0:.[order(first_send_day),] %>%
0:.[, .(campaign_id, weekday = lubridate::wday(first_send_day))]
0:}
0:createCampaignIdsSummaryFromCampaignData(all_data[period == 'sto' & segment == 'segment'])
0:all_data[period == 'sto' & segment == 'segment']
0:all_data[period == 'sto' & segment == 'sto']
0:createCampaignIdsSummaryFromCampaignData(all_data[period == 'sto' & segment == 'sto'])
0:addWeekdayToDt_ <- function(dt, label = TRUE) {
0:dt[, weekday := wday(send_day, label = label)]
0:}
0:source('global.R')
0:pw_common_contacts <- sapply(
0:c('sto', 'control', 'both'),
0:getCommonContactMatrix, campaign_data = all_data,
0:simplify = FALSE
0:)
0:debug(getCommonContactMatrix)
0:pw_common_contacts <- sapply(
0:c('sto', 'control', 'both'),
0:getCommonContactMatrix, campaign_data = all_data,
0:simplify = FALSE
0:)
0:segment
0:campaign_ids
0:campaign_ids$campaign_id
0:campaign_ids
0:source('global.R')
0:pw_common_contacts <- sapply(
0:c('sto', 'control', 'both'),
0:getCommonContactMatrix, campaign_data = all_data,
0:simplify = FALSE
0:)
0:reportStatistics <- function(customer, customer_data, check_pairwise_common = FALSE) {
0:cat('\n===== ', customer, ' =====\n\n')
0:print(customer_data$campaign_data[, .(size = .N), keyby = .(segment, campaign_id)])
0:cat('\n')
0:unique_contacts <<- unique(customer_data$campaign_data[, .(segment, contact_id)])
0:print(unique_contacts[, .(n_unique_contacts = .N), by = segment])
0:cat('\n')
0:n_campaigns <- customer_data$campaign_data[segment == 'sto', uniqueN(campaign_id)]
0:common_contacts <<- customer_data$campaign_data[, .N, by = .(segment, contact_id)][N == n_campaigns, .(segment, contact_id)]
0:print(common_contacts[, .(n_common_contacts = .N), by = segment])
0:cat('\n')
0:sto_control_common_contacts <- intersect(unique_contacts[segment == 'sto'], unique_contacts[segment == 'control'])
0:if (length(sto_control_common_contacts) != 0) {
0:message('ALERT! There are common contacts within segments')
0:}
0:if (check_pairwise_common) {
0:pairwise_common_contacts <- calculateSharesOfCommonContacts(
0:customer_data$campaigns$sto,
0:customer_data$campaigns$control,
0:customer_data$campaign_data
0:)
0:if (any(pairwise_common_contacts > 0)) {
0:message('ALERT! There are common contacts within campaign pairs')
0:}
0:if (customer_data$campaign_data$control[, uniqueN(send_hour), by = campaign_id][, max(V1)] > 1) {
0:message('ALERT! There are more send hours in some of the control campaigns')
0:}
0:if (customer_data$campaign_data$sto[, uniqueN(send_hour), by = campaign_id][, min(V1)] == 1) {
0:message('ALERT! There are only one send hour in some of the STO campaigns')
0:}
0:}
0:print(
0:calculateContactOpenRate(customer_data$campaign_data) %>%
0:.[, .(share_non_responding = sum(open_rate == 0)/.N), by = segment]
0:)
0:}
0:pw_common_contacts
0:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
0:plotHeatmapOfCommonContacts(pw_common_contacts$control)
0:plotHeatmapOfCommonContacts(pw_common_contacts$both)
0:packrat::restore(prompt = FALSE)
0:customer <- 'batiwiz'
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:campaign_summary
0:customer_data
0:customer_data
0:first_sto_campaigns <- c(624729, 620608)
0:campaigns_to_restrict <- first_sto_campaigns
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:campaign_ids_0827 <- c(624568, 624531)
0:campaigns_to_restrict <- campaign_ids_0827
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:campaign_ids_0827 <- c(624568, 624531)
0:campaigns_to_restrict <- campaign_ids_0827
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE) +
0:facet_wrap(~ weekday, ncol = 1)
0:first_sto_campaigns <- c(624729, 620608)
0:campaigns_to_restrict <- first_sto_campaigns
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:campaign_summary <- calculateSummary(all_data)
0:campaign_summary
0:campaign_summary
0:campaign_ids_0827 <- c(624568, 624531)
0:campaigns_to_restrict <- campaign_ids_0827
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:campaign_summary <- calculateSummary(all_data)
0:campaign_summary
0:campaign_summary
0:campaign_ids_0927 <- c(718764, 718883, 718427, 718766)
0:campaigns_to_restrict <- campaign_ids_0927
0:contacts_to_restrict <- customer_data$campaign_data[
0:campaign_id %in% campaigns_to_restrict,
0:.(segment, contact_id)
0:]
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:campaign_summary <- calculateSummary(all_data)
0:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
0:generateRelativeData(campaign_summary) %>%
0:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
0:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate(SETTINGS[[customer]]$start_date)
0:campaign_summary %>% plotOpenRatesByDays()
0:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
0:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_start_date) {
0:dt_with_median_hours_to_open %>%
0:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
0:geom_point() +
0:geom_line(aes(group = weekday)) +
0:geom_vline(
0:aes(xintercept = as.numeric(as.Date(sto_start_date))),
0:linetype = 'dashed'
0:) +
0:scale_y_continuous(limits = 0) +
0:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
0:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
0:theme(legend.position = 'bottom') +
0:facet_wrap(~ segment)
0:}
0:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
0:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_start_date) {
0:dt_with_median_hours_to_open %>%
0:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
0:geom_point() +
0:geom_line(aes(group = weekday)) +
0:geom_vline(
0:aes(xintercept = as.numeric(as.Date(sto_start_date))),
0:linetype = 'dashed'
0:) +
0:expand_limits(y = 0) +
0:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
0:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
0:theme(legend.position = 'bottom') +
0:facet_wrap(~ segment)
0:}
0:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
0:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
0:aggregateVariability(sending_variability) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability) %>%
0:plotSendingVariability()
0:customer <- 'travelist_market'
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
0:contacts_to_restrict <- unique_contacts
0:all_data <- addPastData(customer, customer_data, contacts_to_restrict)
0:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
0:sending_variability2 <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
0:aggregateVariability(sending_variability2) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability2, by_active_status = TRUE) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability) %>%
0:plotSendingVariability()
0:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
0:plotSendingVariability()
0:source('global.R')
0:customer <- 'travelist_market'
0:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
0:transformPriorsToTwoHourSlots <- function(hourly_prior_dt, date) {
0:hourly_prior_dt[
0:,
0:.(open_rate = weighted.mean(open_rate, w = count)),
0:by = floor(hour/2)*2
0:] %>%
0:.[, .(open_rate, send_hour = sprintf('%02d', floor), date = date)] %>%
0:.[order(send_hour)]
0:}
0:priors_from_json <- rjson::fromJSON(file = 'data/priors.json')
0:priors <- lapply(
0:names(priors_from_json), function(day) {
0:rbindlist(priors_from_json[[day]]) %>%
0:transformPriorsToTwoHourSlots(date  = day)
0:}
0:) %>% rbindlist()
0:priors[date > '2016-09-30'] %>%
0:ggplot(aes(x = as.Date(date), y = open_rate, col = send_hour, group = send_hour)) +
0:geom_line(size = 1) +
0:xlab('sending day') +
0:ylab('prior') +
0:geom_vline(
0:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
0:aes(xintercept = date),
0:linetype = 'dotted'
0:)
0:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
0:plotSendTimeDistributionEvolution(customer_data[segment == 'sto'])
0:customer_data
0:plotSendTimeDistributionEvolution(customer_data$campaign_data[segment == 'sto'])
0:1-1/0.025
0:prior <- (1-.025)/.025
0:prior
0:prior2 <- (1-.0.23)/.023
0:prior2 <- (1-.023)/.023
0:rbeta(2, prior + 49)
0:rbeta(1, 2, prior + 49)
0:case1 <- rbeta(10000, 2, prior + 49)
0:case2 <- rbeta(10000, 2, prior2 + 49)
0:c1 <- data.table(c = 'case1', value = case1)
0:c2 <- data.table(c = 'case2', value = case2)
0:rbindlist(c1, c2) %>% ggplot(aes(value, fill = c) + geom_density(alpha = 0.5)
0:rbindlist(c1, c2) %>% ggplot(aes(value, fill = c)) + geom_density(alpha = 0.5)
0:rbindlist(list(c1, c2)) %>% ggplot(aes(value, fill = c)) + geom_density(alpha = 0.5)
1479213985271:setwd("~/teaching/BME_adat/201617")
1479214022800:library(readr)
1479214023049:library(dplyr)
1479214023291:library(ggplot2)
1479214067667:act <- read_csv('data/civil-rights-act.csv')
1479214119888:source('code/da_helper_functions.R')
1479214152384:source('~/.active-rstudio-document')
1479214237658:head(act)
1479214284803:act %>% group_by(party) %>% count(vote)
1479214359195:act %>% group_by(party) %>% summarise(sum(vote == 1)/n())
1479214366373:act %>% group_by(party) %>% summarise(share = sum(vote == 1)/n())
1479214368862:act %>% group_by(party) %>% count(vote)
1479214369027:act %>% group_by(party) %>% summarise(share = sum(vote == 1)/n())
1479214503236:lm1 <- lm(vote ~ party, data = act)
1479214509385:summary_r(lm1)
1479214540519:act %>% group_by(party) %>% summarise(share = sum(vote == 1)/n())
1479214541456:lm1
1479214674911:lm2 <- lm(vote ~ party + state, data = act)
1479214693597:stargazer_r(list(lm1, lm2))
1479215003000:lm3 <- lm(vote ~ state, data = act)
1479215008580:stargazer_r(list(lm1, lm2, lm3))
1479215179280:lm4 <- lm(party ~ state, data = act)
1479215209988:act %>% group_by(state) %>% count(party)
1479215254924:act %>% group_by(state) %>% summarise(sum(party == 'Democrat')/n())
1479216243578:easyshare <- read_csv('data/easyshare_sample.csv')
1479216292234:summary(easyshare)
1479216539716:easyshare <- easyshare %>%
1479216539716:mutate_all(funs(ifelse(. < 0, NA, .)))
1479216546758:summary(easyshare)
1479216736578:easyshare <- easyshare %>%
1479216736579:mutate_all(funs(ifelse(. < 0, NA, .))) %>%
1479216736580:mutate(notworking = ifelse(lm_status == 2, 0, 1),
1479216736581:twr = recall_1 + recall_2)
1479216737379:summary(easyshare)
1479216830212:lm1 <- lm(twr ~ notworking, data = easyshare)
1479216839339:stargazer_r(list(lm1))
1479217492771:lm2 <- lm(twr ~ notworking + eduyears, data = easyshare)
1479217498442:stargazer_r(list(lm1, lm2))
1479217572625:lm3 <- lm(twr ~ notworking + eduyears + age, data = easyshare)
1479217573154:stargazer_r(list(lm1, lm2, lm3))
1479217697996:easyshare <- mutate(easyshare, evtized = floor(age/10))
1479217702007:summary(easyshare)
1479217793707:lm4 <- lm(twr ~ notworking + eduyears + evtized, data = easyshare)
1479217806148:stargazer_r(list(lm1, lm2, lm3, lm4))
1479218231570:lm(formula = vote ~ party, act = filter(act, vote == 1)) %>% summary()
1479218245936:lm(formula = vote ~ party, data = filter(act, vote == 1)) %>% summary()
1479218452520:sum(with(act, state=='North'))/nrow(act)
1479218916789:act %>% count(state) %>% mutate(share = n/sum(n))
1479218942538:act %>% count(state)
1479218990090:act %>% count(state) %>% mutate(share = n/sum(n))
1479219028843:aggregate(vote~state, act, mean)
1479219331990:act %>% count(vote)
1479219338955:act %>% count(vote == 1)
1479219364351:act %>% count(vote == 1) %>% mutate(share = n/sum(n))
1479219377892:act %>% group_by(state) %>% count(vote == 1) %>% mutate(share = n/sum(n))
1479219384300:act %>% group_by(state) %>% summarise(mean(vote))
1479222276084:install.packages('ggplot2')
1479222279640:install.packages("ggplot2")
1479223210629:mydf <- data.frame(variable = c('a1', 'a5, 'a10'), value = c(1, 3, 9))
1479223217884:mydf <- data.frame(variable = c('a1', 'a5', 'a10'), value = c(1, 3, 9))
1479223273010:mydf
1479223291947:library(tidyr)
1479223319425:install.packages('readr')
1479223343671:mutate(mydf, vnum = extract_numeric(variable))
1479223348388:library(dplyr)
1479223349736:mutate(mydf, vnum = extract_numeric(variable))
1479223437694:mutate(mydf, vnum = parse_numeric(variable))
1479223444075:library(readr)
1479223445154:mutate(mydf, vnum = parse_numeric(variable))
1479223452389:mutate(mydf, vnum = parse_number(variable))
1479288743711:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479288746792:ggsave(file.path('figure', customer_name, paste0(segment, '_send_open_distances.png')), width = 11.75, height = 6.6875)
1479288782179:ggsave(file.path('figure', customer, paste0(segment, '_send_open_distances.png')), width = 11.75, height = 6.6875)
1479288845723:calculateMedianDistance(all_data) %>%
1479288845724:generateRelativeData(measure = 'median_hours_to_open') %>%
1479288845724:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday') +
1479288845725:ylab('relative median send-open distance in hours')
1479288852900:ggsave(file.path('figure', customer, 'relative_send_open_distances.png'), width = 11.75, height = 6.6875)
1479288923202:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479288926829:ggsave(file.path('figure', customer, 'send_open_distances.png'), width = 11.75, height = 6.6875)
1479289458629:generateRelativeData(calculateSummary(all_data, initial = 5)) %>%
1479289458630:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, facet = 'weekday')
1479289561065:generateRelativeData(campaign_summary) %>%
1479289561066:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T, offset = 3)
1479289561572:fig_name <- paste0('figure/', customer, '/relative-open-rate-all/', format(Sys.Date(), '%m%d'), '.png')
1479289580740:generateRelativeData(campaign_summary) %>%
1479289580741:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479289581492:fig_name <- paste0('figure/', customer, '/relative-open-rate-all/', format(Sys.Date(), '%m%d'), '.png')
1479289599629:generateRelativeData(campaign_summary) %>%
1479289599630:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE, facet = 'weekday')
1479289629662:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479289629663:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479289635249:x <- 5
1479289635811:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479289635812:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479289668029:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479289681456:generateRelativeData(campaign_summary) %>%
1479289681456:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479289771698:customer <- 'travelist_market'
1479289773001:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479290716898:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479290768524:customer_data$campaigns
1479290810392:contacts_to_restrict <- unique_contacts
1479290814505:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479291860064:saveRDS(all_data, file.path('data', paste0(customer, 'all_data.rds')))
1479292065502:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479295389267:all_data[campaign_id == 701805]
1479295823030:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 10000')
1479295827772:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479295833954:generateRelativeData(campaign_summary) %>%
1479295833954:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479295845916:fig_name <- paste0('figure/', customer, '/relative-open-rate-all/', format(Sys.Date(), '%m%d'), '.png')
1479295846465:ggsave(fig_name, width = 11.75, height = 6.6875)
1479295882738:all_data <- all_data[campaign_id != 701805]
1479295891941:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479295899458:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 10000')
1479295903816:generateRelativeData(campaign_summary) %>%
1479295903817:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479295906388:fig_name <- paste0('figure/', customer, '/relative-open-rate-all/', format(Sys.Date(), '%m%d'), '.png')
1479295907810:ggsave(fig_name, width = 11.75, height = 6.6875)
1479295910725:generateRelativeData(campaign_summary) %>%
1479295910726:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE, facet = 'weekday')
1479295914541:fig_name <- paste0('figure/', customer, '/relative-open-rate-all/daily_', format(Sys.Date(), '%m%d'), '.png')
1479295915262:ggsave(fig_name, width = 11.75, height = 11.75)
1479296073120:x <- 1
1479296073874:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296073874:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296164910:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate(SETTINGS[[customer]]$start_date)
1479296184574:generateRelativeData(campaign_summary) %>%
1479296184574:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE, color = 'weekday')
1479296219814:x <- 5
1479296220193:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296220194:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296225365:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479296227952:x <- 1
1479296228354:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296228355:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296233671:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479296234269:x <- 12
1479296236316:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296236317:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296242168:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479296249344:x <- 24
1479296249877:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296249878:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296253569:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479296259702:x <- 48
1479296260204:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296260205:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296263840:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479296277264:x <- 72
1479296277788:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296277788:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296287897:x <- 168
1479296289752:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479296289752:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479296295669:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479297958119:customer <- 'batiwiz'
1479297959606:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479298942786:all_data
1479298984807:campaign_summary
1479299293252:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1479299342827:calculateVariabilityOfLastSends <- function(contact_data, scope = 5) {
1479299342828:contact_data[
1479299342829:,
1479299342830:.(
1479299342830:send_day,
1479299342831:variability = partialUniqueN(send_hour, scope),
1479299342832:num_send = .N,
1479299342832:num_open = sum(opened)
1479299342833:),
1479299342833:by = contact_id
1479299342834:]
1479299342835:}
1479299347004:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1479299417083:aggregateVariability(sending_variability) %>%
1479299417084:plotSendingVariability()
1479299448030:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1479299448032:plotSendingVariability()
1479299582065:x <- 1
1479299582959:generateRelativeData(calculateSummary(restrictDataToContacts(all_data, active_contacts), initial = x)) %>%
1479299582960:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299590560:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479299592376:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479299594777:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479299603572:x <- 1
1479299604593:generateRelativeData(calculateSummary(restrictDataToContacts(all_data, active_contacts), initial = x)) %>%
1479299604594:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299653047:active_data <- restrictDataToContacts(all_data, active_contacts)
1479299667732:active_data
1479299701775:active_data[, mean(open_rate), by = contact_id]
1479299724111:active_data[, mean(opened), by = campaign_id]
1479299763297:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479299776680:customer <- 'travelist_market'
1479299780870:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479299782290:active_data <- restrictDataToContacts(all_data, active_contacts)
1479299785222:active_summary <- active_data %>% calculateSummary()
1479299791386:active_summary
1479299793410:active_summary
1479299803653:generateRelativeData(active_summary) %>%
1479299803654:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
1479299826397:x <- 1
1479299827361:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299827362:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299841343:x <- 5
1479299842098:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299842098:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299845536:x <- 12
1479299846340:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299846341:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299853800:x <- 24
1479299854628:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299854628:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299863233:x <- 168
1479299864268:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299864268:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479299947511:x <- 24
1479299948096:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479299948097:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479300013930:very_active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$very_active_cutoff]
1479300014768:very_active_data <- restrictDataToContacts(all_data, very_active_contacts)
1479300016133:very_active_summary <- restrictDataToContacts(all_data, very_active_contacts) %>% calculateSummary()
1479300018285:generateRelativeData(very_active_summary) %>%
1479300018285:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date)
1479300033653:generateRelativeData(very_active_summary) %>%
1479300033654:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, color = 'weekday')
1479300064778:very_active_summary
1479300096364:customer <- 'batiwiz'
1479300097659:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479300118224:campaign_ids_0927 <- c(718764, 718883, 718427, 718766)
1479300126846:campaigns_to_restrict <- campaign_ids_0927
1479300127510:contacts_to_restrict <- customer_data$campaign_data[
1479300127511:campaign_id %in% campaigns_to_restrict,
1479300127512:.(segment, contact_id)
1479300127512:]
1479300128956:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479300179172:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479300272610:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 10000')
1479300275910:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479300280707:generateRelativeData(campaign_summary) %>%
1479300280708:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479300342017:campaigns_to_restrict <- first_NA_campaigns
1479300342467:contacts_to_restrict <- customer_data$campaign_data[
1479300342468:campaign_id %in% campaigns_to_restrict,
1479300342469:.(segment, contact_id)
1479300342469:]
1479300346300:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479300378079:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479300384350:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 10000')
1479300390486:generateRelativeData(campaign_summary) %>%
1479300390487:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479300418733:generateRelativeData(campaign_summary) %>%
1479300418734:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE, facet = 'weekday')
1479300466967:campaign_summary %>% plotOpenRatesByDays()
1479300515491:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479300573202:calculateMedianDistance(all_data) %>%
1479300573203:generateRelativeData(measure = 'median_hours_to_open') %>%
1479300573203:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday') +
1479300573204:ylab('relative median send-open distance in hours')
1479300628203:x <- 1
1479300628855:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479300628855:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479300660459:x <- 12
1479300661327:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479300661327:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479300679255:x <- 168
1479300679977:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479300679978:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479300772606:campaign_ids_0827 <- c(624568, 624531)
1479300779945:campaigns_to_restrict <- campaign_ids_0827
1479300780942:contacts_to_restrict <- customer_data$campaign_data[
1479300780943:campaign_id %in% campaigns_to_restrict,
1479300780944:.(segment, contact_id)
1479300780944:]
1479300861760:source('~/projects/sto-ops/scripts/customer-sto-explore.R', echo=TRUE)
1479300900614:campaign_summary
1479301016040:campaign_summary %>%
1479301016041:ggplot(aes(send_day, open_rate * n, col = segment)) +
1479301016042:geom_line() +
1479301016042:geom_smooth(method = 'lm') +
1479301016043:geom_vline(
1479301016043:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301016043:linetype = 'dashed'
1479301016044:)
1479301046600:campaign_summary %>%
1479301046601:ggplot(aes(send_day, open_rate * n, col = segment)) +
1479301046601:geom_line() +
1479301046602:geom_smooth() +
1479301046602:geom_vline(
1479301046602:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301046603:linetype = 'dashed'
1479301046604:)
1479301079041:campaign_summary %>%
1479301079042:ggplot(aes(send_day, open_rate * n, col = segment)) +
1479301079042:geom_line() +
1479301079043:geom_smooth() +
1479301079043:geom_vline(
1479301079043:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301079044:linetype = 'dashed'
1479301079044:) +
1479301079044:facet_wrap(~ segment)
1479301108644:campaign_summary %>%
1479301108644:ggplot(aes(send_day, open_rate * n, col = segment)) +
1479301108645:geom_line() +
1479301108646:geom_smooth() +
1479301108646:geom_vline(
1479301108646:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301108646:linetype = 'dashed'
1479301108647:) +
1479301108647:facet_wrap(~ segment, ncol = 1, scales = 'free_y')
1479301237317:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479301288748:campaign_summary %>%
1479301288749:ggplot(aes(send_day, open_rate * n, col = segment)) +
1479301288750:geom_line() +
1479301288751:geom_smooth() +
1479301288751:geom_vline(
1479301288751:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301288752:linetype = 'dashed'
1479301288752:) +
1479301288752:facet_wrap(~ segment, ncol = 1, scales = 'free_y')
1479301397365:campaign_summary %>%
1479301397365:copy() %>%
1479301397366:.[, open_num := open_rate * n] %>%
1479301397366:generateRelativeData(measure = 'open_num')
1479301427702:campaign_summary %>%
1479301427703:copy() %>%
1479301427703:.[, open_num := open_rate * n] %>%
1479301427704:generateRelativeData(measure = 'open_num') %>%
1479301427704:plotRelativeOpenRateEvolution() +
1479301427704:ylabs('relative open number')
1479301444615:campaign_summary %>%
1479301444616:copy() %>%
1479301444617:.[, open_num := open_rate * n] %>%
1479301444617:generateRelativeData(measure = 'open_num') %>%
1479301444618:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
1479301444618:ylabs('relative open number')
1479301452905:campaign_summary %>%
1479301452905:copy() %>%
1479301452906:.[, open_num := open_rate * n] %>%
1479301452906:generateRelativeData(measure = 'open_num') %>%
1479301452906:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date) +
1479301452907:labs(y = 'relative open number')
1479301505425:campaign_summary %>%
1479301505426:copy() %>%
1479301505427:.[, open_num := open_rate * n] %>%
1479301505427:generateRelativeData(measure = 'open_num') %>%
1479301505427:ggplot(send_day, relative_open_rate) +
1479301505428:geom_vline(
1479301505428:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301505430:linetype = 'dashed'
1479301505431:) +
1479301505431:labs(y = 'relative open number')
1479301517818:campaign_summary %>%
1479301517818:copy() %>%
1479301517819:.[, open_num := open_rate * n] %>%
1479301517820:generateRelativeData(measure = 'open_num') %>%
1479301517820:ggplot(aes(send_day, relative_open_rate)) +
1479301517821:geom_vline(
1479301517821:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301517821:linetype = 'dashed'
1479301517822:) +
1479301517823:labs(y = 'relative open number')
1479301535815:campaign_summary %>%
1479301535816:copy() %>%
1479301535817:.[, open_num := open_rate * n] %>%
1479301535817:generateRelativeData(measure = 'open_num') %>%
1479301535818:ggplot(aes(x = send_day, y = relative_open_rate)) +
1479301535818:geom_vline(
1479301535819:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301535819:linetype = 'dashed'
1479301535819:) +
1479301535820:labs(y = 'relative open number')
1479301553757:%>%
1479301553757:copy() %>%
1479301553761:.[, open_num := open_rate * n] %>%
1479301553761:generateRelativeData(measure = 'open_num') %>%
1479301553762:sapply(class)
1479301556021:campaign_summary %>%
1479301556023:copy() %>%
1479301556023:.[, open_num := open_rate * n] %>%
1479301556024:generateRelativeData(measure = 'open_num') %>%
1479301556025:sapply(class)
1479301575117:campaign_summary %>%
1479301575118:copy() %>%
1479301575118:.[, open_num := open_rate * n] %>%
1479301575119:generateRelativeData(measure = 'open_num') %>%
1479301575120:ggplot(aes(x = send_day, y = relative_open_rate)) +
1479301575120:# geom_vline(
1479301575120:#     aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301575121:#     linetype = 'dashed'
1479301575121:# ) +
1479301575121:labs(y = 'relative open number')
1479301608567:campaign_summary %>%
1479301608567:copy() %>%
1479301608569:.[, open_num := open_rate * n] %>%
1479301608570:generateRelativeData(measure = 'open_num') %>%
1479301608571:ggplot(aes(x = send_day, y = relative_open_rate)) +
1479301608571:geom_point() +
1479301608572:geom_line() +
1479301608572:geom_vline(
1479301608572:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479301608573:linetype = 'dashed'
1479301608573:) +
1479301608573:labs(y = 'relative open number')
1479301633372:generateRelativeData(campaign_summary) %>%
1479301633373:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479301843834:campaign_ids_1026 <- c(815641, 817874, 816962, 817971)
1479301844817:campaigns_to_restrict <- campaign_ids_0827
1479301845296:contacts_to_restrict <- customer_data$campaign_data[
1479301845299:campaign_id %in% campaigns_to_restrict,
1479301845301:.(segment, contact_id)
1479301845301:]
1479301846396:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479301881167:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479301889007:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 10000')
1479301892843:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479301895684:generateRelativeData(campaign_summary) %>%
1479301895685:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479301936223:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479301944382:calculateMedianDistance(all_data) %>%
1479301944382:generateRelativeData(measure = 'median_hours_to_open') %>%
1479301944383:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday') +
1479301944383:ylab('relative median send-open distance in hours')
1479301970593:x <- 24
1479301971430:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479301971430:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479301979737:x <- 1
1479301980221:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479301980222:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479302035711:x <- 12
1479302036704:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479302036705:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479302869666:source('global.R')
1479302871401:customer <- 'batiwiz'
1479302873448:campaign_segments <- readSqlResult(
1479302874503:sql_file = 'sql/batiwiz_campaign_combined_segments.sql',
1479302875020:database_name = SETTINGS[[customer]]$suite,
1479302875625:customer_id = getIdFromName(customer),
1479302876015:start_date = SETTINGS[[customer]]$start_date
1479302876668:)
1479302918822:source('global.R')
1479302920105:customer <- 'batiwiz'
1479302923100:campaign_segments <- readSqlResult(
1479302923101:sql_file = 'sql/batiwiz_campaign_combined_segments.sql',
1479302923101:database_name = SETTINGS[[customer]]$suite,
1479302923102:customer_id = getIdFromName(customer),
1479302923102:start_date = SETTINGS[[customer]]$start_date
1479302923103:)
1479302925680:batiwiz_used_segment_names <- c(
1479302929078:'Actif 120J' = 'Opt-In and opened in last 120 days',
1479302929080:'Actif 120J - STO' = 'Opt-In and opened in last 120 days and STO flag == 1',
1479302929081:'lastestMembers120days' = 'Opt-In and registered in last 120 days',
1479302929081:'lastestMembers120days - STO' = 'Opt-In and registered in last 120 days and STO flag == 1',
1479302929082:'Acheteur' = 'has purchased',
1479302929083:'Acheteur - STO' = 'has purchased and STO flag == 1',
1479302929083:'ForcingPeople' = 'alain.ravel63@orange.fr or francois.dolhem@wanadoo.fr',
1479302929086:'Acheteur ForcingPeople' = 'has purchased and ForcingPeople',
1479302929087:'Non acheteur ForcingPeople' = 'hasnt purchased and ForcingPeople',
1479302929087:'Non Acheteur et Lastest members 120 jours STO' = 'hasnt purchased, STO, registered in the last 120 days',
1479302929088:'Non Acheteur et Lastest members 120 jours EXCSTO' = 'hasnt purchased, registered in the last 120 days',
1479302929088:'Non Acheteur et Actifs 120 jours STO' = 'hasnt purchased, STO, opened in the last 120 days',
1479302929089:'Non Acheteur et Actifs 120 jours EXCSTO' = 'hasnt purchased, opened in the last 120 days',
1479302929089:'Acheteur et Lastest members 120 jours STO' = 'purchased, STO, registered in the last 120 days',
1479302929090:'Acheteur et Lastest members 120 jours EXCSTO' = 'purchased, registered in the last 120 days',
1479302929090:'Acheteur et Actifs 120 jours STO' = 'purchased, STO, opened in the last 120 days',
1479302929091:'Acheteur et Actifs 120 jours EXCSTO' = 'purchased, opened in the last 120 days',
1479302929092:'SEGMENT EXCLUSION FILTRAGE CLOUDMARK' = 'email valid, optin, registered right after 2015 Xmas but did not open after Xmas campaigns',
1479302929092:'IMPORT CONTACTS MANQUANTS 24/06/2016' = 'contact list',
1479302929093:'IMPORT CONTACTS MANQUANTS 24/06/2016 - STO' = 'those from given contact list with STO',
1479302929099:'newsletterMonthly' = 'newsletterFrequency == 2',
1479302929100:'newsletterWeekly' = 'newsletterFrequency == 1',
1479302929101:'newsletterOff' = 'newsletterFrequency == 3',
1479302929102:'Clients deficient et inactifs' = 'multi dede only, SI inactive or defecting',
1479302929103:'Inactifs 120 jours' = 'multi dede only, did not open at all in last 120 days'
1479302929104:)
1479302937520:segment_definitions <- getSqlResult(
1479302937522:file_name = 'sql/segment_definitions.sql',
1479302937524:database_name = SETTINGS[[customer]]$suite,
1479302937526:customer_id  = getIdFromName(customer),
1479302937528:segment_names = str_c("('", str_c(names(batiwiz_used_segment_names), collapse = "', '"), "')")
1479302937529:) %>%
1479302937531:merge(., operators_in_section_targeting[, .(operator, op_name = name)], by = 'operator') %>%
1479302937533:.[, operator := NULL] %>%
1479302937535:.[, .(name, system_name, op_name, crit, b_crit, from_days)] %>%
1479302937537:.[order(name)]
1479302945451:import_userlist_id <- getSqlResult(
1479302945903:query = "SELECT id AS userlist_id
1479302946120:FROM userlists
1479302946333:WHERE name = 'IMPORT CONTACTS MANQUANTS 24/06/2016';",
1479302946600:database_name = SETTINGS[[customer]]$suite
1479302946899:)[, userlist_id]
1479302948369:imported_contacts <- getSqlResult(
1479302948515:query = "SELECT user_id as contact_id
1479302948678:FROM ul_#{customer_id}_#{userlist_id};",
1479302948883:database_name = SETTINGS[[customer]]$suite,
1479302949135:customer_id = getIdFromName(customer),
1479302949289:userlist_id = import_userlist_id
1479302949446:)
1479302985008:imported_contacts
1479303016476:merge(all_data, imported_contacts)
1479303022434:merge(all_data, imported_contacts, by = 'contact_id')
1479303096796:all <- merge(all_data, imported_contacts[, .(contact_id, imported = 1)], all = TRUE, by = 'contact_id')
1479303110689:all[, .N, by = imported]
1479303131129:all[is.na(imported), imported := 0]
1479303169962:all[, mean(imported), by = .(period, segment, campaign_id)]
1479303230420:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303230844:ggplot(aes(send_day, imported, col = segment)) +
1479303231166:geom_line()
1479303254288:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303254290:ggplot(aes(send_day, imported, col = segment)) +
1479303254291:geom_point() +
1479303254291:geom_line()
1479303294539:View(segment_definitions)
1479303743986:addSTOline <- function(plot, sto = TRUE, text = TRUE, prior_changes = TRUE) {
1479303743988:if (sto) {
1479303743989:plot <- plot +
1479303743989:geom_vline(
1479303743990:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479303743990:linetype = 'dashed'
1479303743991:)
1479303743992:}
1479303743992:if (text) {
1479303743993:plot <- plot +
1479303743993:geom_text(
1479303743997:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479303744002:aes(x, y, label = 'Start of STO'),
1479303744003:hjust = 1.1
1479303744004:)
1479303744004:}
1479303744005:if (prior_changes) {
1479303744005:plot <- plot + geom_vline(
1479303744006:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479303744006:aes(xintercept = date),
1479303744007:linetype = 'dotted'
1479303744008:)
1479303744008:}
1479303744009:plot
1479303744012:}
1479303754685:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303754686:ggplot(aes(send_day, imported, col = segment)) +
1479303754686:geom_point() +
1479303754687:geom_line() + addSTOline()
1479303762915:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303762916:ggplot(aes(send_day, imported, col = segment)) +
1479303762917:geom_point() +
1479303762917:geom_line() %>% addSTOline()
1479303823600:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303823601:ggplot(aes(send_day, imported, col = segment)) +
1479303823602:geom_point() +
1479303823602:geom_line() + geom_vline(aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))))
1479303844040:debug(addSTOline)
1479303848250:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303848251:ggplot(aes(send_day, imported, col = segment)) +
1479303848252:geom_point() +
1479303848253:geom_line() %>% addSTOline()
1479303852913:plot
1479303910484:undebug(addSTOline)
1479303919980:all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303919982:ggplot(aes(send_day, imported, col = segment)) +
1479303919983:geom_point() +
1479303919983:geom_line()
1479303930142:cucc <- all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479303930142:ggplot(aes(send_day, imported, col = segment)) +
1479303930143:geom_point() +
1479303930143:geom_line()
1479303938926:cucc %>% addSTOline()
1479303953443:cucc
1479303963375:cucc %>% addSTOline()
1479304013574:addSTOline <- function(plot, sto = TRUE, text = TRUE, prior_changes = TRUE) {
1479304013577:if (sto) {
1479304013577:plot <- plot +
1479304013578:geom_vline(
1479304013579:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date)), color = 'black'),
1479304013580:linetype = 'dashed'
1479304013580:)
1479304013581:}
1479304013581:if (text) {
1479304013582:plot <- plot +
1479304013583:geom_text(
1479304013583:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479304013584:aes(x, y, label = 'Start of STO'),
1479304013584:hjust = 1.1
1479304013585:)
1479304013586:}
1479304013587:if (prior_changes) {
1479304013588:plot <- plot + geom_vline(
1479304013588:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479304013589:aes(xintercept = date),
1479304013590:linetype = 'dotted'
1479304013590:)
1479304013591:}
1479304013592:plot
1479304013592:}
1479304016161:cucc %>% addSTOline()
1479304073467:addSTOline <- function(plot, sto = TRUE, text = TRUE, prior_changes = TRUE) {
1479304073468:if (sto) {
1479304073468:plot <- plot +
1479304073469:geom_vline(
1479304073469:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date)), color = 'black'),
1479304073470:linetype = 'dashed'
1479304073471:)
1479304073472:}
1479304073473:if (text) {
1479304073474:plot <- plot +
1479304073475:geom_text(
1479304073476:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479304073477:aes(x, y, label = 'Start of STO'),
1479304073477:color = 'black', hjust = 1.1
1479304073478:)
1479304073481:}
1479304073482:if (prior_changes) {
1479304073483:plot <- plot + geom_vline(
1479304073483:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479304073484:aes(xintercept = date),
1479304073485:color = 'black', linetype = 'dotted'
1479304073486:)
1479304073487:}
1479304073487:plot
1479304073489:}
1479304076237:cucc %>% addSTOline()
1479304113175:addSTOline <- function(plot, sto = TRUE, text = TRUE, prior_changes = TRUE) {
1479304113175:if (sto) {
1479304113176:plot <- plot +
1479304113177:geom_vline(
1479304113177:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479304113178:color = 'black', linetype = 'dashed'
1479304113178:)
1479304113179:}
1479304113180:if (text) {
1479304113180:plot <- plot +
1479304113181:geom_text(
1479304113184:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479304113187:aes(x, y, label = 'Start of STO'),
1479304113188:color = 'black', hjust = 1.1
1479304113189:)
1479304113190:}
1479304113191:if (prior_changes) {
1479304113191:plot <- plot + geom_vline(
1479304113192:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479304113193:aes(xintercept = date),
1479304113194:color = 'black', linetype = 'dotted'
1479304113194:)
1479304113195:}
1479304113196:plot
1479304113197:}
1479304115540:cucc %>% addSTOline()
1479304285147:p <- all[, .(imported = mean(imported)), by = .(segment, send_day, campaign_id)] %>%
1479304285726:ggplot(aes(send_day, imported, col = segment)) +
1479304286004:geom_point() +
1479304286354:geom_line()
1479304288652:addSTOline(p)
1479304352829:all[, .(open_rate), mean(opened), by = .(segment, contact_id, imported)]
1479304366201:all[, .(open_rate = mean(opened), by = .(segment, contact_id, imported)]
1479304371633:all[, .(open_rate = mean(opened)), by = .(segment, contact_id, imported)]
1479304407674:all[, .(open_rate = mean(opened)), by = .(segment, contact_id, imported)] %>%
1479304408333:.[, mean(open_rate), by = .(segment, imported)]
1479304446121:all[, .(open_rate = mean(opened)), by = .(segment, period, contact_id, imported)] %>%
1479304446606:.[, mean(open_rate), by = .(period, segment, imported)]
1479304454696:all[, .(open_rate = mean(opened)), by = .(segment, period, contact_id, imported)] %>%
1479304454985:.[, mean(open_rate), keyby = .(period, segment, imported)]
1479304465966:all[, .(open_rate = mean(opened)), by = .(segment, period, contact_id, imported)] %>%
1479304466160:.[, mean(open_rate), keyby = .(period, imported, segment)]
1479304524783:all[, .(open_rate = mean(opened)), by = .(segment, period, contact_id, imported)] %>%
1479304525218:.[, .(open_rate = mean(open_rate), .N), keyby = .(period, imported, segment)]
1479304765504:reportStatistics('batiwiz', customer_data)
1479304789214:all_data[, .N, by = .(segment, campaing_id)]
1479304792566:all_data[, .N, by = .(segment, campaign_id)]
1479304800551:all_data[, .N, by = .(segment, send_day, campaign_id)]
1479304844114:all_data[, .N, by = .(segment, send_day)] %>% ggplot(aes(send_day, N, col = segment)) + geom_line() + geom_point()
1479304867385:p <- all_data[, .N, by = .(segment, send_day)] %>% ggplot(aes(send_day, N, col = segment)) + geom_line() + geom_point()
1479304872980:addSTOline(p)
1479304952495:generateRelativeData(campaign_summary) %>%
1479304953148:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479305382789:all_data[, .N, keyby = send_day]
1479305423222:all_data[, uniqueN(campaign_id), keyby = send_day]
1479305535850:customer_data$campaigns
1479305657213:campaign_ids_1111 <- c(875298, 875488, 875502, 875540)
1479305662410:campaigns_to_restrict <- campaign_ids_1111
1479305668139:contacts_to_restrict <- customer_data$campaign_data[
1479305668140:campaign_id %in% campaigns_to_restrict,
1479305668140:.(segment, contact_id)
1479305668141:]
1479305674589:contacts_to_restrict
1479305770701:campaign_ids_1111 <- c(875298, 875488)
1479305771566:campaigns_to_restrict <- campaign_ids_1111
1479305771829:contacts_to_restrict <- customer_data$campaign_data[
1479305772146:campaign_id %in% campaigns_to_restrict,
1479305772569:.(segment, contact_id)
1479305772930:]
1479305774146:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = TRUE)
1479305836578:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479305872398:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 0')
1479305874157:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479305883306:generateRelativeData(campaign_summary) %>%
1479305883854:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479305943774:campaign_summary
1479305986994:campaign_ids_1111 <- c(875505, 875540)
1479305990918:campaigns_to_restrict <- campaign_ids_1111
1479305991218:contacts_to_restrict <- customer_data$campaign_data[
1479305991559:campaign_id %in% campaigns_to_restrict,
1479305991770:.(segment, contact_id)
1479305991916:]
1479305993153:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479306012383:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479306019868:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 0')
1479306024267:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479306039201:contacts_to_restrict
1479306053617:contacts_to_restrict[, .N, by = segment]
1479306066041:customer_data$campaigns
1479306077355:campaign_ids_1111 <- c(875502, 875540)
1479306078380:campaigns_to_restrict <- campaign_ids_1111
1479306079336:contacts_to_restrict <- customer_data$campaign_data[
1479306079516:campaign_id %in% campaigns_to_restrict,
1479306079680:.(segment, contact_id)
1479306079980:]
1479306083613:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479306107643:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 0')
1479306110105:campaign_summary
1479306112889:campaign_summary
1479306134041:contacts_to_restrict[, .N, by = segment]
1479306182934:customer_data$campaign_data[, .N, keyby = .(send_day, segment)]
1479306219469:generateRelativeData(campaign_summary) %>%
1479306220143:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479306249013:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479306367092:customer_data$campaign_data[, .N, keyby = .(send_day, segment)] %>% ggplot(aes(send_day, N, col = segment)) + geom_point() + geom_line()
1479306405366:p <- customer_data$campaign_data[, .N, keyby = .(send_day, segment)] %>% ggplot(aes(send_day, N, col = segment)) + geom_point() + geom_line()
1479306409405:addSTOline(p)
1479306533204:campaign_summary <- calculateSummary(all_data, campaign_condition = '(n > 29000 & n < 45000) | (n > 110000')
1479306546102:campaign_summary <- calculateSummary(all_data, campaign_condition = '(n > 29000 & n < 45000) | (n > 110000)')
1479306552287:campaign_summary
1479306553783:campaign_summary
1479306563587:generateRelativeData(campaign_summary) %>%
1479306564371:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479306606060:campaign_summary <- calculateSummary(all_data)
1479306611129:campaign_summary
1479306668501:p <- all_data[, .N, keyby = .(send_day, segment)] %>% ggplot(aes(send_day, N, col = segment)) + geom_point() + geom_line()
1479306675309:addSTOline(p)
1479306764656:campaigns_to_restrict
1479306859911:contacts_to_restrict_first <- customer_data$campaign_data[
1479306859911:campaign_id %in% first_sto_campaigns,
1479306859912:.(segment, contact_id)
1479306859913:]
1479306863053:first_sto_campaigns <- c(624729, 620608)
1479306865360:contacts_to_restrict_first <- customer_data$campaign_data[
1479306865858:campaign_id %in% first_sto_campaigns,
1479306866180:.(segment, contact_id)
1479306866634:]
1479306867584:contacts_to_restrict_last <- customer_data$campaign_data[
1479306867930:campaign_id %in% campaign_ids_1111,
1479306868180:.(segment, contact_id)
1479306868711:]
1479306873283:contacts_to_restrict
1479306912165:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = 'contact_id')
1479306925360:contacts_to_restrict
1479306937516:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1479306945405:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479306977848:p <- all_data[, .N, keyby = .(send_day, segment)] %>% ggplot(aes(send_day, N, col = segment)) + geom_point() + geom_line()
1479306990144:addSTOline(p)
1479307004536:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479307012687:campaign_summary <- calculateSummary(all_data)
1479307015613:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479307020521:generateRelativeData(campaign_summary) %>%
1479307021836:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479307202104:generateRelativeData(campaign_summary) %>%
1479307202670:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = FALSE, text = FALSE, facet = 'weekday')
1479307325016:all_data[period == 'past', .(share = .N/sum(.N)), by = .(campaign_id, segment)]
1479307364429:all_data[period == 'past', .N, by = .(campaign_id, segment)] %>%
1479307364829:.[, .(N, N/sum(N)), by = campaign_id]
1479307381966:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307382335:.[, .(N, N/sum(N)), by = campaign_id]
1479307400257:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307400850:.[, .(N, share = N/sum(N)), by = .(campaign_id, send_day)]
1479307420453:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307420848:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)]
1479307440724:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307440951:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307441102:summary()
1479307464769:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307465137:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307465520:.[N >= 100]
1479307522006:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307522470:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307522821:.[N >= 100 & segment == 'sto'] %>%
1479307523180:ggplot(aes(send_day, share)) + geom_point()
1479307538051:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307538284:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307538481:.[N >= 100 & segment == 'sto'] %>%
1479307538855:ggplot(aes(send_day, share)) + geom_point() + extend_limits(y = 0)
1479307544758:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307545073:.[N >= 100 & segment == 'sto'] %>%
1479307545426:ggplot(aes(send_day, share)) + geom_point() + extend_limit(y = 0)
1479307547580:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307547905:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307548071:.[N >= 100 & segment == 'sto'] %>%
1479307548232:ggplot(aes(send_day, share)) + geom_point() + extend_limit(y = 0)
1479307569887:all_data[period == 'past', .N, by = .(campaign_id, send_day, segment)] %>%
1479307570430:.[, .(N, share = N/sum(N), segment), by = .(campaign_id, send_day)] %>%
1479307570581:.[N >= 100 & segment == 'sto'] %>%
1479307570957:ggplot(aes(send_day, share)) + geom_point() + expand_limits(y = 0)
1479307791731:all_data
1479307810834:all_data[period == 'past', .N, by = contact_id]
1479307828483:all_data[period == 'past', .N, by = contact_id] %>% ggplot(aes(N)) + geom_histogram()
1479307867580:all_data[period == 'past', .N, by = contact_id] %>% summary()
1479307953518:all_data[period == 'past', .(segment, .N), by = contact_id][N >= 70]
1479307967582:all_data[period == 'past', .(segment, .N), by = contact_id][N >= 70, .(contact_id, segment)]
1479307973517:contacts_to_restrict <- all_data[period == 'past', .(segment, .N), by = contact_id][N >= 70, .(contact_id, segment)]
1479307984624:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479308029845:all_data
1479308039005:all_data[period == 'past', .N, by = contact_id] %>% ggplot(aes(N)) + geom_histogram()
1479308045302:contacts_to_restrict <- all_data[period == 'past', .(segment, .N), by = contact_id][N >= 70, .(contact_id, segment)]
1479308103900:contacts_to_restrict
1479308141606:contacts_to_restrict <- all_data[period == 'past', .(segment, .N), by = .(segment, contact_id)] %>%
1479308141606:.[N >= 70, .(contact_id, segment)]
1479308150926:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479308220898:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479308224583:campaign_summary <- calculateSummary(all_data)
1479308227296:plotOpenRateEvolutionWithPast(campaign_summary, sto_start_date = SETTINGS[[customer]]$start_date)
1479308234997:generateRelativeData(campaign_summary) %>%
1479308235443:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F)
1479308259557:generateRelativeData(campaign_summary) %>%
1479308259948:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = T)
1479308461384:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479308472033:calculateMedianDistance(all_data) %>%
1479308472509:generateRelativeData(measure = 'median_hours_to_open') %>%
1479308475376:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday') +
1479308476604:ylab('relative median send-open distance in hours')
1479308538252:x <- 5
1479308538996:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479308539461:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479308558852:generateRelativeData(calculateSummary(all_data, initial = x))
1479308573202:cucc <- generateRelativeData(calculateSummary(all_data, initial = x))
1479308604676:cucc[weekday == 'Mon']
1479308674084:cucc[weekday == 'Thurs']
1479308817489:x <- 168
1479308818028:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479308818777:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479308869745:x <- 12
1479308870148:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479308871525:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479308879809:x <- 1
1479308880351:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479308880867:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479308898727:x <- 12
1479308899212:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479308902198:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479308955952:contacts_to_restrict[, .N, by = segment]
1479309771740:all_data
1479309778796:all_data[segment == 'control']
1479309799855:all_data[segment == 'control', .(campaign_id, send_hour)]
1479309808072:all_data[segment == 'control', .(campaign_id, send_hour, period)] %>% unique()
1479309821142:all_data[segment == 'control', .(campaign_id, send_hour, period)] %>% unique() %>% .[, .N, by = send_hour]
1479309827310:all_data[segment == 'control', .(campaign_id, send_hour, period)] %>% unique() %>% .[, .N, keyby = send_hour]
1479310306613:x <- 1
1479310307151:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310307151:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310312216:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479310315232:x <- 5
1479310315616:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310315616:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310317628:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479310318446:x <- 12
1479310318943:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310318944:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310321511:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479310322549:x <- 24
1479310322628:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310322629:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310325371:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479310326599:x <- 48
1479310326700:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310326701:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310329297:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479310333361:x <- 168
1479310333766:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479310333767:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479310336666:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479311033128:customer <- 'travelist_market'
1479311034432:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479311119104:source('global.R')
1479311120476:customer <- 'batiwiz'
1479311122653:customer <- 'travelist_market'
1479311128064:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479311185112:plotSendTimeDistributionEvolution(customer_data$campaign_data[segment == 'sto'])
1479312431186:my_plot_function <- function(plot) {
1479312431187:plot + geom_vline(xintercept = 1, linetype = 'dashed')
1479312431188:}
1479312436809:data(mtcars)
1479312449628:library(ggplot2)
1479312480507:mtcars %>%
1479312480508:ggplot() +
1479312480509:geom_point(aes(mpg, wt))
1479312487451:library(magrittr)
1479312488969:mtcars %>%
1479312488970:ggplot() +
1479312488971:geom_point(aes(mpg, wt))
1479312498166:my_plot_function <- function(plot) {
1479312498167:plot + geom_vline(yintercept = 3, linetype = 'dashed')
1479312498168:}
1479312508015:mtcars %>%
1479312508016:ggplot() +
1479312508017:geom_point(aes(mpg, wt)) %>%
1479312508019:my_plot_function()
1479312517621:p <- mtcars %>%
1479312517622:ggplot() +
1479312517623:geom_point(aes(mpg, wt)) %>%
1479312517625:my_plot_function(p)
1479312519334:p <- mtcars %>%
1479312519335:ggplot() +
1479312519336:geom_point(aes(mpg, wt)) %>%
1479312519336:my_plot_function(p)
1479312525632:p <- mtcars %>%
1479312525637:ggplot() +
1479312525638:geom_point(aes(mpg, wt))
1479312526112:my_plot_function(p)
1479312532139:my_plot_function <- function(plot) {
1479312532140:plot + geom_hline(yintercept = 3, linetype = 'dashed')
1479312532141:}
1479312533093:p <- mtcars %>%
1479312533094:ggplot() +
1479312533095:geom_point(aes(mpg, wt))
1479312533452:my_plot_function(p)
1479312549295:mtcars %>%
1479312549296:ggplot() +
1479312549297:geom_point(aes(mpg, wt)) %>%
1479312549298:my_plot_function()
1479312558861:mtcars %>%
1479312558862:{ggplot() +
1479312558864:geom_point(aes(mpg, wt))} %>%
1479312558865:my_plot_function()
1479312765164:mtcars %>%
1479312765165:ggplot() +
1479312765169:geom_point(aes(mpg, wt)) %>%
1479312765170:class()
1479312781656:mtcars %>%
1479312781656:{ggplot() +
1479312781660:geom_point(aes(mpg, wt))} %>%
1479312781661:class()
1479312792464:mtcars %>%
1479312792465:{ggplot() +
1479312792466:geom_point(aes(mpg, wt))} %>%
1479312792467:my_plot_function()
1479312941304:mtcars %>%
1479312941305:ggplot() +
1479312941307:geom_point(aes(mpg, wt)) %>%
1479312941307:my_plot_function()
1479312966900:mtcars %>%
1479312966901:ggplot() +
1479312966903:geom_point(aes(mpg, wt)) %>%
1479312966904:my_plot_function()
1479312972766:debug(my_plot_function)
1479312973961:mtcars %>%
1479312973962:ggplot() +
1479312973963:geom_point(aes(mpg, wt)) %>%
1479312973963:my_plot_function()
1479312978435:class(plot)
1479313560893:library(ggplot2)
1479313561262:library(magrittr)
1479313561937:my_plot_function <- function(plot) {
1479313561938:geom_hline(yintercept = 3, linetype = 'dashed')
1479313561940:}
1479313562967:mtcars %>%
1479313562967:ggplot() +
1479313562968:geom_point(aes(mpg, wt)) + my_plot_function()
1479313571495:mtcars %>%
1479313571496:ggplot() +
1479313571497:geom_point(aes(mpg, wt))
1479313842164:mtcars %>%
1479313842166:(ggplot() +
1479313842167:geom_point(aes(mpg, wt))) %>%
1479313842168:my_plot_function()
1479313846972:mtcars %>%
1479313846977:(ggplot() +
1479313846978:geom_point(aes(mpg, wt))) %>%
1479313846979:my_plot_function()
1479313851147:mtcars %>%
1479313851149:(ggplot() +
1479313851149:geom_point(aes(mpg, wt))) %>%
1479313851150:my_plot_function(.)
1479313861728:(mtcars %>%
1479313861728:ggplot() +
1479313861729:geom_point(aes(mpg, wt))) %>%
1479313861730:my_plot_function()
1479313866008:(mtcars %>%
1479313866008:ggplot() +
1479313866010:geom_point(aes(mpg, wt))) %>%
1479313866011:my_plot_function()
1479313870684:mtcars %>%
1479313870685:(ggplot() +
1479313870686:geom_point(aes(mpg, wt))) %>%
1479313870687:my_plot_function()
1479313878975:mtcars %>%
1479313878976:(ggplot() +
1479313878977:geom_point(aes(mpg, wt))) %>%
1479313878977:my_plot_function()
1479313903642:mtcars %>%
1479313903643:{ggplot() +
1479313903644:geom_point(aes(mpg, wt))} %>%
1479313903645:my_plot_function()
1479313921223:mtcars %>%
1479313921224:ggplot() +
1479313921225:geom_point(aes(mpg, wt)) %>%
1479313921225:my_plot_function()
1479313927695:mtcars %>%
1479313927696:ggplot() +
1479313927697:geom_point(aes(mpg, wt)) %>%
1479313927697:my_plot_function()
1479314018902:my_plot_function <- function(plot) {
1479314018903:plot + geom_hline(yintercept = 3, linetype = 'dashed')
1479314018905:}
1479314024491:mtcars %>%
1479314024492:(ggplot() +
1479314024493:geom_point(aes(mpg, wt))) %>%
1479314024494:my_plot_function()
1479323490427:(mtcars %>%
1479323490428:ggplot() +
1479323490430:geom_point(aes(mpg, wt))) %>%
1479323490431:my_plot_function()
1479369359568:library(ggplot2)
1479369360158:library(magrittr)
1479369362471:my_plot_function <- function() {
1479369362472:geom_hline(yintercept = 3, linetype = 'dashed')
1479369362473:}
1479369364403:mtcars %>%
1479369364403:ggplot() +
1479369364404:geom_point(aes(mpg, wt)) + my_plot_function()
1479369461218:my_plot_function <- function() {
1479369461219:geom_hline(yintercept = 3, linetype = 'dashed') +
1479369461219:geom_vline(xintercept = 20)
1479369461220:}
1479369462002:mtcars %>%
1479369462002:ggplot() +
1479369462003:geom_point(aes(mpg, wt)) + my_plot_function()
1479369487307:my_plot_function <- function() {
1479369487308:list(geom_hline(yintercept = 3, linetype = 'dashed'),
1479369487309:geom_vline(xintercept = 20))
1479369487310:}
1479369487822:mtcars %>%
1479369487823:ggplot() +
1479369487831:geom_point(aes(mpg, wt)) + my_plot_function()
1479369617313:library(data.table)
1479369626858:installed.packages(data.table)
1479369635488:installed.packages('data.table')
1479378262235:my_plot_function <- function(hline = TRUE) {
1479378262236:plot_list <- list(geom_hline(yintercept = 3, linetype = 'dashed'))
1479378262237:if (hline) {
1479378262237:plot_list <- list(plot_list, geom_vline(xintercept = 20))
1479378262237:}
1479378262238:}
1479378264769:mtcars %>%
1479378264769:ggplot() +
1479378264770:geom_point(aes(mpg, wt)) + my_plot_function()
1479378268108:mtcars %>%
1479378268108:ggplot() +
1479378268109:geom_point(aes(mpg, wt)) + my_plot_function(F)
1479378277327:my_plot_function <- function(hline = TRUE) {
1479378277328:plot_list <- list(geom_hline(yintercept = 3, linetype = 'dashed'))
1479378277328:if (hline) {
1479378277329:plot_list <- list(plot_list, geom_vline(xintercept = 20))
1479378277331:}
1479378277332:plot_list
1479378277333:}
1479378278120:mtcars %>%
1479378278120:ggplot() +
1479378278121:geom_point(aes(mpg, wt)) + my_plot_function(F)
1479378296760:list()
1479378408740:source('global.R')
1479378432915:customer <- 'travelist_market'
1479378435953:readRDS(file.path('data', paste0(customer, 'all_data.rds')))
1479378469411:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479378484224:all_data <- readRDS(file.path('data', paste0(customer, 'all_data.rds')))
1479378544007:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479378548330:all_data <- all_data[campaign_id != 701805]
1479378550776:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479378557178:campaign_summary <- calculateSummary(all_data)
1479378566969:campaign_summary
1479378568241:campaign_summary
1479378583225:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line()
1479378596036:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() %>% addSTOline()
1479378620179:addSTOline <- function(sto_line = TRUE, text = TRUE, prior_changes = TRUE) {
1479378620180:plot_list <- list()
1479378620181:if (sto_line) {
1479378620182:plot_list <- list(
1479378620182:plot_list,
1479378620183:geom_vline(
1479378620183:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378620184:color = 'black', linetype = 'dashed'
1479378620185:)
1479378620185:)
1479378620186:}
1479378620186:if (text) {
1479378620187:plot_list <- list(
1479378620188:plot_list,
1479378620188:geom_text(
1479378620189:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479378620190:aes(x, y, label = 'Start of STO'),
1479378620190:color = 'black', hjust = 1.1
1479378620191:)
1479378620192:)
1479378620192:}
1479378620193:if (prior_changes) {
1479378620194:plot_list <- list(
1479378620195:plot_list,
1479378620196:geom_vline(
1479378620197:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378620197:aes(xintercept = date),
1479378620198:color = 'black', linetype = 'dotted'
1479378620199:)
1479378620199:)
1479378620200:}
1479378620201:plot_list
1479378620202:}
1479378622674:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() %>% addSTOline()
1479378643636:debug(addSTOline)
1479378644780:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() %>% addSTOline()
1479378675960:addSTOline <- function(layer, sto_line = TRUE, text = TRUE, prior_changes = TRUE) {
1479378675964:plot_list <- list()
1479378675966:if (sto_line) {
1479378675967:plot_list <- list(
1479378675968:plot_list,
1479378675969:geom_vline(
1479378675969:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378675970:color = 'black', linetype = 'dashed'
1479378675971:)
1479378675973:)
1479378675973:}
1479378675974:if (text) {
1479378675974:plot_list <- list(
1479378675975:plot_list,
1479378675976:geom_text(
1479378675976:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479378675977:aes(x, y, label = 'Start of STO'),
1479378675978:color = 'black', hjust = 1.1
1479378675978:)
1479378675979:)
1479378675980:}
1479378675981:if (prior_changes) {
1479378675981:plot_list <- list(
1479378675982:plot_list,
1479378675983:geom_vline(
1479378675984:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378675985:aes(xintercept = date),
1479378675986:color = 'black', linetype = 'dotted'
1479378675986:)
1479378675986:)
1479378675987:}
1479378675987:plot_list
1479378675988:}
1479378681930:addSTOline <- function(layer, sto_line = TRUE, text = TRUE, prior_changes = TRUE) {
1479378681931:plot_list <- list()
1479378681932:if (sto_line) {
1479378681933:plot_list <- list(
1479378681934:plot_list,
1479378681935:geom_vline(
1479378681936:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378681937:color = 'black', linetype = 'dashed'
1479378681937:)
1479378681938:)
1479378681938:}
1479378681939:if (text) {
1479378681939:plot_list <- list(
1479378681940:plot_list,
1479378681940:geom_text(
1479378681943:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479378681944:aes(x, y, label = 'Start of STO'),
1479378681945:color = 'black', hjust = 1.1
1479378681946:)
1479378681947:)
1479378681948:}
1479378681949:if (prior_changes) {
1479378681950:plot_list <- list(
1479378681950:plot_list,
1479378681953:geom_vline(
1479378681954:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378681955:aes(xintercept = date),
1479378681959:color = 'black', linetype = 'dotted'
1479378681963:)
1479378681964:)
1479378681966:}
1479378681968:plot_list
1479378681971:}
1479378700279:addSTOline <- function(layer, sto_line = TRUE, text = TRUE, prior_changes = TRUE) {
1479378700281:plot_list <- list()
1479378700282:if (sto_line) {
1479378700283:plot_list <- list(
1479378700284:plot_list,
1479378700285:geom_vline(
1479378700285:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378700286:color = 'black', linetype = 'dashed'
1479378700287:)
1479378700287:)
1479378700290:}
1479378700291:if (text) {
1479378700292:plot_list <- list(
1479378700293:plot_list,
1479378700294:geom_text(
1479378700294:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = 0.8),
1479378700295:aes(x, y, label = 'Start of STO'),
1479378700296:color = 'black', hjust = 1.1
1479378700297:)
1479378700298:)
1479378700299:}
1479378700300:if (prior_changes) {
1479378700300:plot_list <- list(
1479378700301:plot_list,
1479378700302:geom_vline(
1479378700303:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378700304:aes(xintercept = date),
1479378700304:color = 'black', linetype = 'dotted'
1479378700305:)
1479378700306:)
1479378700307:}
1479378700308:plot_list
1479378700309:}
1479378705718:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() %>% addSTOline()
1479378725806:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() %>% addSTOline(sto_line = FALSE)
1479378743895:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() %>% addSTOline(sto_line = FALSE)
1479378760496:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() %>% addSTOline()
1479378784907:addSTOline <- function(layer, sto_line = TRUE, text = TRUE, y_pos = 0.8, prior_changes = TRUE) {
1479378784908:plot_list <- list()
1479378784909:if (sto_line) {
1479378784909:plot_list <- list(
1479378784910:plot_list,
1479378784911:geom_vline(
1479378784912:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378784912:color = 'black', linetype = 'dashed'
1479378784913:)
1479378784914:)
1479378784914:}
1479378784915:if (text) {
1479378784916:plot_list <- list(
1479378784917:plot_list,
1479378784919:geom_text(
1479378784920:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = y_pos),
1479378784921:aes(x, y, label = 'Start of STO'),
1479378784921:color = 'black', hjust = 1.1
1479378784922:)
1479378784923:)
1479378784923:}
1479378784924:if (prior_changes) {
1479378784925:plot_list <- list(
1479378784925:plot_list,
1479378784926:geom_vline(
1479378784927:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378784928:aes(xintercept = date),
1479378784928:color = 'black', linetype = 'dotted'
1479378784929:)
1479378784930:)
1479378784931:}
1479378784932:plot_list
1479378784934:}
1479378787671:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() %>% addSTOline()
1479378795465:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() %>% addSTOline(y_pos = 0.1)
1479378800025:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() %>% addSTOline(y_pos = 0.07)
1479378816074:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() + addSTOline(y_pos = 0.07)
1479378830594:addSTOline <- function(sto_line = TRUE, text = TRUE, y_pos = 0.8, prior_changes = TRUE) {
1479378830595:plot_list <- list()
1479378830596:if (sto_line) {
1479378830597:plot_list <- list(
1479378830597:plot_list,
1479378830598:geom_vline(
1479378830598:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378830599:color = 'black', linetype = 'dashed'
1479378830599:)
1479378830600:)
1479378830600:}
1479378830602:if (text) {
1479378830604:plot_list <- list(
1479378830605:plot_list,
1479378830606:geom_text(
1479378830606:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = y_pos),
1479378830607:aes(x, y, label = 'Start of STO'),
1479378830608:color = 'black', hjust = 1.1
1479378830609:)
1479378830610:)
1479378830610:}
1479378830611:if (prior_changes) {
1479378830612:plot_list <- list(
1479378830612:plot_list,
1479378830613:geom_vline(
1479378830614:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378830614:aes(xintercept = date),
1479378830615:color = 'black', linetype = 'dotted'
1479378830616:)
1479378830617:)
1479378830618:}
1479378830619:plot_list
1479378830620:}
1479378833492:campaign_summary %>% ggplot(aes(send_day, open_rate, col = segment)) + geom_line() + geom_point() + addSTOline(y_pos = 0.07)
1479378900182:addSTOline <- function(sto_line = TRUE, sto_text = TRUE, y_pos = 0.8, prior_changes = TRUE) {
1479378900184:plot_list <- list()
1479378900184:if (sto_line) {
1479378900185:plot_list <- list(
1479378900187:plot_list,
1479378900189:geom_vline(
1479378900190:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479378900191:color = 'black', linetype = 'dashed'
1479378900193:)
1479378900193:)
1479378900194:}
1479378900201:if (sto_text) {
1479378900202:plot_list <- list(
1479378900206:plot_list,
1479378900207:geom_text(
1479378900207:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = y_pos),
1479378900208:aes(x, y, label = 'Start of STO'),
1479378900209:color = 'black', hjust = 1.1
1479378900210:)
1479378900210:)
1479378900211:}
1479378900212:if (prior_changes) {
1479378900213:plot_list <- list(
1479378900213:plot_list,
1479378900214:geom_vline(
1479378900215:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479378900216:aes(xintercept = date),
1479378900217:color = 'black', linetype = 'dotted'
1479378900218:)
1479378900219:)
1479378900221:}
1479378900222:plot_list
1479378900223:}
1479378902890:plotSendingVariability <- function(dt) {
1479378902891:p <- ggplot(dt, aes(x = send_day, y = variability)) +
1479378902893:scale_y_continuous(limit = c(0, 5))
1479378902893:if ('activity' %in% names(dt)) {
1479378902894:p <- p + geom_line(aes(color = activity), size = 2)
1479378902894:} else {
1479378902897:p <- p + geom_line(size = 2)
1479378902897:}
1479378902898:p + addSTOline(sto_line = FALSE, sto_text = FALSE)
1479378902899:}
1479378913592:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1479379001185:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1479379001186:plotSendingVariability()
1479379040015:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open) {
1479379040016:dt_with_median_hours_to_open %>%
1479379040017:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
1479379040017:geom_point() +
1479379040018:geom_line(aes(group = weekday)) +
1479379040018:addSTOline() +
1479379040019:expand_limits(y = 0) +
1479379040019:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1479379040020:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1479379040020:theme(legend.position = 'bottom') +
1479379040021:facet_wrap(~ segment)
1479379040021:}
1479379044646:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(SETTINGS[[customer]]$start_date)
1479379052046:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen()
1479379203772:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479379203773:dt_with_median_hours_to_open %>%
1479379203773:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
1479379203774:geom_point() +
1479379203775:geom_line(aes(group = weekday)) +
1479379203775:addSTOline(sto_line, sto_text, prior_change_dates) +
1479379203775:expand_limits(y = 0) +
1479379203776:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1479379203776:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1479379203777:theme(legend.position = 'bottom') +
1479379203778:facet_wrap(~ segment)
1479379203778:}
1479379219077:aggregateVariability(sending_variability) %>%
1479379219079:plotSendingVariability()
1479379228832:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen()
1479379240727:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479379264333:debug(plotMedianHoursToOpen)
1479379265740:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479379310300:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479379310303:dt_with_median_hours_to_open %>%
1479379310303:ggplot(aes(x = send_day, y = median_hours_to_open)) +
1479379310304:geom_point(aes(col = weekday)) +
1479379310305:geom_line(aes(group = weekday)) +
1479379310305:addSTOline(sto_line, sto_text, prior_change_dates) +
1479379310306:expand_limits(y = 0) +
1479379310307:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1479379310308:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1479379310308:theme(legend.position = 'bottom') +
1479379310309:facet_wrap(~ segment)
1479379310309:}
1479379312223:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479379325274:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open) {
1479379325275:dt_with_median_hours_to_open %>%
1479379325276:ggplot(aes(x = send_day, y = median_hours_to_open)) +
1479379325276:geom_point(aes(col = weekday)) +
1479379325277:geom_line(aes(group = weekday)) +
1479379325277:addSTOline() +
1479379325278:expand_limits(y = 0) +
1479379325278:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1479379325279:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1479379325280:theme(legend.position = 'bottom') +
1479379325280:facet_wrap(~ segment)
1479379325281:}
1479379328181:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479379332062:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen()
1479379390444:addSTOline <- function(sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1479379390445:plot_list <- list()
1479379390445:if (sto_line) {
1479379390446:plot_list <- list(
1479379390446:plot_list,
1479379390447:geom_vline(
1479379390447:aes(xintercept = as.numeric(as.Date(SETTINGS[[customer]]$start_date))),
1479379390448:color = 'black', linetype = 'dashed'
1479379390449:)
1479379390449:)
1479379390450:}
1479379390450:if (sto_text) {
1479379390451:plot_list <- list(
1479379390451:plot_list,
1479379390452:geom_text(
1479379390453:data = data.frame(x = as.Date(SETTINGS[[customer]]$start_date), y = text_position),
1479379390453:aes(x, y, label = 'Start of STO'),
1479379390454:color = 'black', hjust = 1.1
1479379390455:)
1479379390457:)
1479379390459:}
1479379390460:if (prior_changes) {
1479379390461:plot_list <- list(
1479379390462:plot_list,
1479379390463:geom_vline(
1479379390463:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1479379390465:aes(xintercept = date),
1479379390466:color = 'black', linetype = 'dotted'
1479379390467:)
1479379390468:)
1479379390469:}
1479379390470:plot_list
1479379390472:}
1479379427586:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479379427589:dt_with_median_hours_to_open %>%
1479379427589:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
1479379427590:geom_point() +
1479379427590:geom_line(aes(group = weekday)) +
1479379427591:addSTOline(sto_line, sto_text, prior_change_dates) +
1479379427592:expand_limits(y = 0) +
1479379427592:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1479379427593:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1479379427594:theme(legend.position = 'bottom') +
1479379427594:facet_wrap(~ segment)
1479379427595:}
1479379433272:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen()
1479379440391:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479379535899:plotRelativeOpenRateEvolution <- function(relative_data, color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, offset = 2) {
1479379535900:p <- relative_data[send_day < Sys.Date() - offset] %>%
1479379535902:ggplot(aes(x = send_day, y = relative_open_rate))
1479379535903:if (is.null(color)) {
1479379535903:p <- p +
1479379535904:geom_line() +
1479379535905:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1479379535905:} else {
1479379535906:p <- p +
1479379535907:geom_point(aes_string(color = color)) +
1479379535908:geom_line(aes_string(color = color))
1479379535909:}
1479379535909:if (trendlines) {
1479379535910:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1479379535911:}
1479379535912:if (!is.null(facet)) {
1479379535913:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1479379535914:}
1479379535916:p + addSTOline(TRUE, text, prior_change_dates)
1479379535917:}
1479379559443:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1479379651606:plotRelativeOpenRateEvolution <- function(relative_data, color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, offset = 2) {
1479379651607:p <- relative_data[send_day < Sys.Date() - offset] %>%
1479379651608:ggplot(aes(x = send_day, y = relative_open_rate)) +
1479379651608:geom_hline(yintercept = 1, linetype = 'dashed')
1479379651609:if (is.null(color)) {
1479379651609:p <- p +
1479379651610:geom_line() +
1479379651610:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1479379651611:} else {
1479379651612:p <- p +
1479379651612:geom_point(aes_string(color = color)) +
1479379651613:geom_line(aes_string(color = color))
1479379651613:}
1479379651614:if (trendlines) {
1479379651615:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1479379651616:}
1479379651616:if (!is.null(facet)) {
1479379651618:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1479379651619:}
1479379651620:p + addSTOline(TRUE, text, prior_change_dates)
1479379651621:}
1479379654501:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1479379686784:campaign_summary %>% plotOpenRatesByDays()
1479379694604:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479379698231:plotWeeklyRelativeOpenRate <- function(weekly_aggregates, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479379698232:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479379698233:geom_hline(yintercept = 1, linetype = 'dashed') +
1479379698233:geom_line(data = weekly_aggregates[num_campaign >= 5], aes(x = week_of_year, y = relative_open_rate)) +
1479379698234:geom_point(aes(fill = factor(num_campaign)), colour = 'white', size = 3, pch = 21) +
1479379698235:addSTOline(sto_line, sto_text, prior_change_dates) +
1479379698236:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479379698237:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1479379698238:theme(legend.position = 'bottom')
1479379698240:}
1479379701648:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479379744440:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1479379761434:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F)
1479379772037:plotOpenRateEvolutionWithPast(campaign_summary)
1479379791272:plotOpenRateEvolutionWithPast <- function(summary_with_past, offset = 2) {
1479379791273:summary_with_past %>%
1479379791274:plotOpenRateEvolution(offset) +
1479379791275:addSTOline()
1479379791275:}
1479379794475:plotOpenRateEvolutionWithPast(campaign_summary)
1479379823220:plotOpenRateEvolutionWithPast <- function(summary_with_past, offset = 2) {
1479379823220:summary_with_past %>%
1479379823221:plotOpenRateEvolution(offset) +
1479379823222:addSTOline(text_position = 0)
1479379823222:}
1479379827269:plotOpenRateEvolutionWithPast(campaign_summary)
1479379863249:plotSendTimeDistributionEvolution <- function(campaign_data) {
1479379863249:calculateSendDistribution(campaign_data[segment == 'sto']) %>%
1479379863250:.[order(send_hour)] %>%
1479379863251:ggplot(aes(x = send_day, y = n)) +
1479379863251:geom_area(aes(fill = factor(send_hour))) +
1479379863252:addSTOline(sto_line = FALSE, sto_text = FALSE)
1479379863252:}
1479379876757:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479380084890:plotOpenRateEvolutionWithPast(campaign_summary)
1479380086348:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F)
1479380088852:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1479380096740:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479380108285:plotWeeklyRelativeOpenRate <- function(weekly_aggregates, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479380108285:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479380108286:geom_hline(yintercept = 1, linetype = 'dashed') +
1479380108287:geom_line(data = weekly_aggregates[num_campaign >= 5], aes(x = week_of_year, y = relative_open_rate)) +
1479380108288:geom_point(aes(fill = factor(num_campaign)), colour = 'white', size = 3, pch = 21) +
1479380108288:addSTOline(sto_line, sto_text, prior_change_dates) +
1479380108289:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479380108290:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1479380108291:theme(legend.position = 'bottom')
1479380108292:}
1479380112017:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479380123925:plotWeeklyRelativeOpenRate <- function(weekly_aggregates, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1479380123926:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479380123927:geom_hline(yintercept = 1, linetype = 'dashed') +
1479380123928:geom_line(data = weekly_aggregates[num_campaign >= 5], aes(x = week_of_year, y = relative_open_rate)) +
1479380123928:geom_point(aes(fill = factor(num_campaign)), colour = 'white', size = 3, pch = 21) +
1479380123929:# addSTOline(sto_line, sto_text, prior_change_dates) +
1479380123930:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479380123930:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1479380123931:theme(legend.position = 'bottom')
1479380123932:}
1479380129559:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479380154956:plotWeeklyRelativeOpenRate <- function(weekly_aggregates) {
1479380154957:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479380154959:geom_hline(yintercept = 1, linetype = 'dashed') +
1479380154959:geom_line(data = weekly_aggregates[num_campaign >= 5], aes(x = week_of_year, y = relative_open_rate)) +
1479380154960:geom_point(aes(fill = factor(num_campaign)), colour = 'white', size = 3, pch = 21) +
1479380154961:addSTOline() +
1479380154961:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479380154962:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1479380154963:theme(legend.position = 'bottom')
1479380154964:}
1479380158360:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479380193753:plotWeeklyRelativeOpenRate <- function(weekly_aggregates) {
1479380193753:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479380193754:geom_hline(yintercept = 1, linetype = 'dashed') +
1479380193755:geom_line(data = weekly_aggregates[num_campaign >= 5], aes(x = week_of_year, y = relative_open_rate)) +
1479380193756:geom_point(aes(fill = factor(num_campaign)), colour = 'white', size = 3, pch = 21) +
1479380193757:geom_vline(
1479380193758:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479380193759:linetype = 'dashed'
1479380193760:) +
1479380193760:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479380193760:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1479380193761:theme(legend.position = 'bottom')
1479380193761:}
1479380196467:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479380400103:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479380402567:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479380404075:active_data <- restrictDataToContacts(all_data, active_contacts)
1479380406450:active_summary <- active_data %>% calculateSummary()
1479380408034:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479380413512:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(col = 'weekday')
1479380421905:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(color = 'weekday')
1479380442075:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479380443896:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479380464483:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479385717112:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479385789793:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479385795316:contacts_to_restrict <- unique_contacts
1479385800606:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479386404562:all_data <- all_data[campaign_id != 701805]
1479386412276:campaign_summary <- calculateSummary(all_data)
1479386418686:plotOpenRateEvolutionWithPast(campaign_summary)
1479386420577:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F)
1479386431587:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479386439544:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1479386449344:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479386460444:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479386462039:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479386462049:active_data <- restrictDataToContacts(all_data, active_contacts)
1479386464594:active_summary <- active_data %>% calculateSummary()
1479386465988:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479386468399:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479386499525:very_active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$very_active_cutoff]
1479386501104:very_active_data <- restrictDataToContacts(all_data, very_active_contacts)
1479386502612:very_active_summary <- restrictDataToContacts(all_data, very_active_contacts) %>% calculateSummary()
1479386512991:generateRelativeData(very_active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479386526372:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479386550801:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479386550801:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479386558927:x <- 2
1479386560385:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479386560385:plotRelativeOpenRateEvolution(sto_start_date = SETTINGS[[customer]]$start_date, trendlines = F, color = 'weekday')
1479386575077:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479386575080:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479386600322:x <- 2
1479386600876:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479386600877:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479386610684:x <- 12
1479386611167:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479386611168:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479386633955:x <- 168
1479386634488:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479386634489:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479386972372:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479387007120:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479387289843:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479482395292:library(readr)
1479482395647:library(dplyr)
1479482396028:library(ggplot2)
1479482413692:na <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479482419799:head(na)
1479482421123:group_by(na,school8) %>%
1479482421126:filter(school8=="Elite6") %>%
1479482421127:summarise(n=n())
1479482679694:school_type<-group_by(na,school8) %>%
1479482679694:count(school8)
1479482690175:school_type
1479482697902:na %>%
1479482697905:mutate(school8=factor(school8)) %>%
1479482697906:ggplot(aes(x=log(math8),fill=school8))+
1479482697906:geom_density(alpha=0.3)
1479482712845:na %>%
1479482712846:mutate(school8=factor(school8)) %>%
1479482712847:ggplot(aes(x=log(reading8),fill=school8))+
1479482712847:geom_density(alpha=0.3)
1479482721401:math8_clean<-group_by(na,math8) %>%
1479482721403:filter(math8!="NA")
1479482723029:math8_clean_with_dummy<-math8_clean %>%
1479482723030:mutate(school8=ifelse(school8=="Primary",1,2))
1479482724989:lm(formula = math8~school8,data = math8_clean_with_dummy) %>%
1479482724989:summary()
1479482765447:lm(school8~math8,filter(math8_clean_with_dummy,school8==1))
1479482766270:lm(school8~math8,filter(math8_clean_with_dummy,school8==2))
1479482939373:cohort <- read.csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479482941566:library(readr)
1479482941821:library(dplyr)
1479482942269:library(ggplot2)
1479482942621:cohort <- read.csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479482943818:summary(cohort)
1479482946373:table(cohort$school8)
1479482950668:cohort %>%
1479482950668:group_by(school8)%>%
1479482950669:ggplot()+
1479482950669:geom_jitter(aes(x=school8, y=reading8))
1479482964436:lm(math8~school8, data=cohort)
1479483052838:source("~/teaching/BME_adat/201617/code/da_helper_functions.R")
1479483072722:lm1 <- lm(math8 ~ school8, cohort)
1479483073714:lm1
1479483079443:stargazer_r(lm1)
1479483084106:library(car)
1479483086715:stargazer_r(lm1)
1479483092379:stargazer_r(lm1, digits = 1)
1479483115290:lm2 <- lm(read8 ~ school8, cohort)
1479483119359:lm2 <- lm(reading8 ~ school8, cohort)
1479483130860:stargazer_r(list(lm1, lm2), digits = 1)
1479483163595:lm1 <- lm(math8 ~ school8, cohort)
1479483168658:lm2 <- lm(math8 ~ school8 + math6, cohort)
1479483168733:lm3 <- lm(math8 ~ school8 + math6 + reading8, cohort)
1479483168953:lm4 <- lm(math8 ~ school8 + math6 + reading8 + med8 + fed8, cohort)
1479483175385:stargazer_r(list(lm1, lm2, lm3, lm4), digits = 1)
1479483259419:cohort["improvement"] <- cohort$math8+cohort$reading8-cohort$math6-cohort$reading6
1479483260202:lm(improvement~school8, data=cohort)
1479483403076:library(readr)
1479483403392:library(dplyr)
1479483403739:library(ggplot2)
1479483404226:NABC<-read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479483405099:head(NABC)
1479483408181:group_by(NABC,school8) %>%
1479483408181:filter(school8=="Elite6") %>%
1479483408182:summarise(n=n())
1479483410539:school_type<-group_by(NABC,school8) %>%
1479483410540:count(school8)
1479483413755:Elite6=5127
1479483414219:Primary=81311
1479483414611:Total=Elite6+Primary
1479483414932:share_of_elite6<-Elite6/Total
1479483417275:NABC %>%
1479483417276:mutate(school8=factor(school8)) %>%
1479483417276:ggplot(aes(x=log(math8),fill=school8))+
1479483417277:geom_density(alpha=0.3)
1479483421134:NABC %>%
1479483421134:mutate(school8=factor(school8)) %>%
1479483421135:ggplot(aes(x=log(reading8),fill=school8))+
1479483421135:geom_density(alpha=0.3)
1479483426085:math8_clean<-group_by(NABC,math8) %>%
1479483426086:filter(math8!="NA")
1479483430925:math8_clean_with_dummy<-math8_clean %>%
1479483430926:mutate(school8=ifelse(school8=="Primary",1,2))
1479483432902:lm(formula = math8~school8,data = math8_clean_with_dummy) %>%
1479483432902:summary()
1479483434008:lm(school8~math8,filter(math8_clean_with_dummy,school8==1))
1479483434666:lm(school8~math8,filter(math8_clean_with_dummy,school8==2))
1479483518913:library(readr)
1479483519478:library(ggplot2)
1479483519895:library(dplyr)
1479483530988:data <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479483533058:data %>%
1479483533060:group_by(school8) %>% count("ID") %>%
1479483533060:mutate(share = 86528) %>% mutate(school_type_share = n/share * 100)
1479483595188:data %>%
1479483595188:group_by(school8) %>% summarise(avg_math_points = mean(math8, na.rm = TRUE)) %>%
1479483595189:ggplot(aes(x = school8, y = avg_math_points, fill = school8)) + geom_bar(stat = "identity")
1479483602971:lm(math8 ~ school8 == "Primary", data = data) %>% summary()
1479483606828:lm(math8 ~ school8 == "Elite6", data = data) %>% summary()
1479483681232:data <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479483681759:head(data)
1479483682288:View(data)
1479483687001:data %>%
1479483687002:filter(school8 == "Elite6") %>%
1479483687003:summarise(n=n())
1479483709431:data %>%
1479483709431:filter(school8=="Elite6") %>%
1479483709432:summarise(n=n()) %>%
1479483709432:mutate(share=86528) %>%
1479483709433:mutate(Elite6_share = n/share*100)
1479483714363:data %>%
1479483714363:ggplot(aes(x=school8, y=reading8)) +
1479483714364:geom_jitter()
1479483718133:data %>%
1479483718133:ggplot(aes(x=school8, y=math8)) +
1479483718134:geom_jitter()
1479483724043:data %>%
1479483724044:group_by(school8) %>%
1479483724045:summarise(avg_reading_points=mean(reading8, na.rm = TRUE)) %>%
1479483724045:ggplot(aes(x=school8, y=avg_reading_points))+
1479483724046:geom_bar(stat = "identity")
1479483728367:data %>%
1479483728368:group_by(school8) %>%
1479483728368:summarise(avg_math_points=mean(math8, na.rm = TRUE)) %>%
1479483728368:ggplot(aes(x=school8, y=avg_math_points))+
1479483728369:geom_bar(stat = "identity")
1479483732378:data_clean <- na.omit(data)
1479483733867:lm(data=data_clean, math8~school8)
1479483743670:lm(data=data_clean, reading8~school8)
1479483853777:adat <- read_excel('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479483854400:head(adat)
1479483856755:library(dplyr)
1479483857176:library(ggplot2)
1479483857671:library(readr)
1479483863265:adat <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479483864470:head(adat)
1479483866738:adat%>%
1479483866739:filter(school8 == "Elite6") %>%
1479483866739:count(id)%>%
1479483866740:summarise(n=n())
1479483867857:adat%>%
1479483867857:count(id)%>%
1479483867858:summarise(n=n())
1479483871217:adat %>%
1479483871218:group_by(school8) %>%
1479483871218:count("id") %>%
1479483871219:mutate(osszes = 86528)%>%
1479483871219:mutate(osszes_share = n/osszes * 100)
1479483872433:adat%>%
1479483872434:ggplot(aes(x = math8, y = school8))+geom_jitter()
1479483873715:math8_clean<-group_by(adat,math8) %>% filter(math8!="NA")
1479483877051:head(math8_clean)
1479483877058:lm(math8 ~ school8 == "Primary", data = math8_clean)
1479483879712:lm(math8 ~ school8 == "Elite6", data = math8_clean)
1479483881458:math6_clean<-group_by(math8_clean,math6) %>%  filter(math6!="NA")
1479483882952:head(math6_clean)
1479483883721:lm(math6 ~ school8 == "Primary", data = math6_clean)
1479483884513:lm(math6 ~ school8 == "Elite6", data = math6_clean)
1479484115093:cohort_clean <- sample_cohort_2010 %>%
1479484115094:mutate(reading8 = ifelse(reading8 > 3, NA, reading8)) %>%
1479484115095:mutate(math6 = ifelse(math6 > 3, NA, math6)) %>%
1479484115095:mutate(math8 = ifelse(math8 > 3, NA, math8)) %>%
1479484115096:mutate(reading6 = ifelse(reading6 > 3, NA, reading6)) %>%
1479484115096:filter(school8)%>%
1479484115097:mean(sample_cohort_2010, na.rm = TRUE)
1479484136151:cohort_clean <- cohort %>%
1479484136152:mutate(reading8 = ifelse(reading8 > 3, NA, reading8)) %>%
1479484136152:mutate(math6 = ifelse(math6 > 3, NA, math6)) %>%
1479484136153:mutate(math8 = ifelse(math8 > 3, NA, math8)) %>%
1479484136153:mutate(reading6 = ifelse(reading6 > 3, NA, reading6)) %>%
1479484136153:filter(school8)%>%
1479484136154:mean(sample_cohort_2010, na.rm = TRUE)
1479484144041:sample_cohort_2010 <- read_csv('sample_cohort_2010')
1479484162534:sample_cohort_2010 <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479484164894:cohort_clean <- sample_cohort_2010 %>%
1479484164894:mutate(reading8 = ifelse(reading8 > 3, NA, reading8)) %>%
1479484164895:mutate(math6 = ifelse(math6 > 3, NA, math6)) %>%
1479484164896:mutate(math8 = ifelse(math8 > 3, NA, math8)) %>%
1479484164896:mutate(reading6 = ifelse(reading6 > 3, NA, reading6)) %>%
1479484164897:filter(school8)%>%
1479484164898:mean(sample_cohort_2010, na.rm = TRUE)
1479484173937:cohort_clean <- sample_cohort_2010 %>%
1479484173938:mutate(reading8 = ifelse(reading8 > 3, NA, reading8)) %>%
1479484173939:mutate(math6 = ifelse(math6 > 3, NA, math6)) %>%
1479484173939:mutate(math8 = ifelse(math8 > 3, NA, math8)) %>%
1479484173940:mutate(reading6 = ifelse(reading6 > 3, NA, reading6)) %>%
1479484173941:filter(school8)%>%
1479484173942:mean(sample_cohort_2010, na.rm = TRUE)
1479484179521:cohort_clean <- sample_cohort_2010 %>%
1479484179522:mutate(reading8 = ifelse(reading8 > 3, NA, reading8)) %>%
1479484179522:mutate(math6 = ifelse(math6 > 3, NA, math6)) %>%
1479484179522:mutate(math8 = ifelse(math8 > 3, NA, math8)) %>%
1479484179523:mutate(reading6 = ifelse(reading6 > 3, NA, reading6)) %>%
1479484179523:mean(sample_cohort_2010, na.rm = TRUE)
1479484183162:sample_cohort_2010%>%
1479484183162:mutate(school8 = ifelse(school8 == "Elite6", 'six-class', '8-class'))%>%
1479484183163:group_by(school8)%>%
1479484183164:count('Elite6')
1479484185026:sample_cohort_2010 %>%
1479484185027:group_by(school8) %>%
1479484185028:select(math8, school8) %>%
1479484185028:summarise(n=n())
1479484188188:sample_cohort_2010%>%
1479484188188:mutate(school8 = ifelse(school8 == 'Primary', 'Primary', 'Elite6')%>%
1479484188190:sample_cohort_2010%>%
1479484188190:select('Primary')
1479484195104:sample_cohort_2010%>%
1479484195105:mutate(school8 = ifelse(school8 == 'Primary', 'Primary', 'Elite6')%>%
1479484195106:sample_cohort_2010%>%
1479484195106:select('Primary')
1479484205796:sample_cohort_2010%>%
1479484205796:group_by(school8)%>%
1479484205797:select(math8, school8)%>%
1479484205797:summarise(n=n(), mean(math8, na.rm = TRUE))
1479484208167:lm(math8 ~ school8, sample_cohort_2010)
1479484222833:cohort_clean <- sample_cohort_2010%>%
1479484222836:as.numeric(as.character(exo.1.4.mad.values))%>%
1479484222836:max(sample_cohort_2010, na.rm=TRUE)
1479484225508:cohort_clean <- sample_cohort_2010%>%
1479484225509:as.numeric(as.character(exo.1.4.mad.values))%>%
1479484225510:max(sample_cohort_2010, na.rm=TRUE)
1479484227187:cohort_clean <- sample_cohort_2010%>%
1479484227188:as.numeric(as.character(exo.1.4.mad.values))%>%
1479484227188:max(sample_cohort_2010, na.rm=TRUE)
1479484229757:a <- sample_cohort_2010("10","28","3","NA")%>%
1479484229758:which(as.numeric(a) == min(as.numeric(a)))
1479484231945:integer(0)
1479548051703:library(readr)
1479548052371:library(dplyr)
1479548052867:library(ggplot2)
1479548058523:cohort <- read.csv(''~/teaching/BME_adat/201617/data/sample_cohort_2010.csv'')
1479548068555:cohort <- read.csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479548070118:summary(cohort)
1479548070596:table(cohort$school8)
1479548074159:cohort %>%
1479548074161:group_by(school8) %>%
1479548074162:ggplot() +
1479548074162:geom_jitter(aes(x=school8, y=reading8))
1479548084516:lm(math8~school8, data=cohort)
1479548087570:cohort["improvement"] <- cohort$math8+cohort$reading8-cohort$math6-cohort$reading6
1479548088103:lm(improvement~school8, data=cohort)
1479548198681:sample
1479548204717:sample <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479548206809:sample %>%
1479548206810:group_by(school8) %>%
1479548206811:count("ID") %>%
1479548206811:mutate(share = 86528) %>%
1479548206812:mutate(school_type_share = n/share * 100)
1479548210371:sample %>%
1479548210373:group_by(school8) %>%
1479548210373:summarise(avg_mathpoints = mean(math8, na.rm = TRUE)) %>%
1479548210374:ggplot(aes(x = school8, y = avg_mathpoints, fill = school8)) +
1479548210374:geom_bar(stat = "identity")
1479548212156:sample %>%
1479548212157:group_by(school8) %>%
1479548212158:summarise(avg_readpoints = mean(reading8, na.rm = TRUE)) %>%
1479548212159:ggplot(aes(x = school8, y = avg_readpoints, fill = school8)) +
1479548212160:geom_bar(stat = "identity")
1479548214479:lm(math8 ~ school8=="Primary", data = sample) %>%
1479548214480:summary()
1479548218329:lm(math8 ~ school8=="Elite6", data = sample) %>%
1479548218330:summary()
1479548222989:lm(math8+reading8 ~ school8=="Primary", data = sample) %>%
1479548222990:summary()
1479548225269:lm(math8+reading8 ~ school8=="Elite6", data = sample) %>%
1479548225274:summary()
1479548273776:sc2010 <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv'
1479548273776:)
1479548274873:sc2010
1479548278186:sc2010 %>%
1479548278187:group_by(school8) %>%
1479548278187:summarise(number_of_students = n()) %>%
1479548278188:mutate(sum_students = sum(number_of_students)) %>%
1479548278188:mutate(share_of_students=
1479548278188:number_of_students/sum_students*100) %>%
1479548278189:select(school8, number_of_students, share_of_students) %>%
1479548278189:filter(school8 == 'Elite6')
1479548283826:sc_clean <- sc2010 %>%
1479548283827:drop_na()
1479548285687:sc_clean %>%
1479548285691:select(id, school8, math8) %>%
1479548285691:filter(school8 == 'Primary') %>%
1479548285692:ggplot(aes(x = math8)) +
1479548285692:geom_histogram()+
1479548285692:labs(title = 'Primary_math8_distribution')
1479548297626:library(tidyr)
1479548300252:sc_clean <- sc2010 %>%
1479548300252:drop_na()
1479548301195:sc_clean %>%
1479548301196:select(id, school8, math8) %>%
1479548301197:filter(school8 == 'Primary') %>%
1479548301197:ggplot(aes(x = math8)) +
1479548301197:geom_histogram()+
1479548301198:labs(title = 'Primary_math8_distribution')
1479548305613:sc_clean %>%
1479548305614:select(id, school8, math8) %>%
1479548305615:filter(school8 == 'Elite6') %>%
1479548305615:ggplot(aes(x = math8)) +
1479548305616:geom_histogram()+
1479548305616:labs(title = 'Elite6_math8_distribution')
1479548315478:lm(math8 ~ school8 == "Primary", sc_clean) %>%
1479548315480:summary()
1479548317648:lm(math8 ~ school8 == "Elite6", sc_clean) %>%
1479548317649:summary()
1479548320349:lm(math6 ~ school8 == 'Elite6', sc_clean) %>%
1479548320349:summary()
1479548334170:lm(math8 ~ school8 == "Elite6", sc_clean) %>%
1479548334171:summary()
1479548338433:lm(math6 ~ school8 == 'Elite6', sc_clean) %>%
1479548338433:summary()
1479548388415:read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479548389590:school <- read_csv("sample_cohort_2010.csv")
1479548400899:school <- read_csv('~/teaching/BME_adat/201617/data/sample_cohort_2010.csv')
1479548402949:school %>%
1479548402950:group_by(school8) %>%
1479548402951:count("ID") %>%
1479548402951:mutate(sum = 86528) %>%
1479548402951:mutate(school_type_share = n/sum * 100)
1479548406954:school %>%
1479548406954:group_by(school8) %>%
1479548406955:summarise(avg_math_points = mean(math8, na.rm = TRUE)) %>%
1479548406955:ggplot(aes(x = school8, y = avg_math_points, fill = school8)) +
1479548406955:geom_bar(stat = "identity")
1479548408439:school %>%
1479548408439:group_by(school8) %>%
1479548408440:summarise(avg_reading_points = mean(reading8, na.rm = TRUE)) %>%
1479548408441:ggplot(aes(x = school8, y = avg_reading_points, fill = school8)) +
1479548408441:geom_bar(stat = "identity")
1479548411521:lm(math8 ~ school8 == "Primary", data = school) %>%
1479548411521:summary()
1479548412059:lm(math8 ~ school8 == "Elite6", data = school) %>%
1479548412059:summary()
1479548413411:math6_cleaned <- school %>%
1479548413412:group_by(school8, math6) %>%
1479548413412:filter(math6!="NA")
1479548414343:lm(math6 ~ school8 == "Primary", data = math6_cleaned)
1479548414824:lm(math6 ~ school8 == "Elite6", data = math6_cleaned)
1479725157657:source('global.R')
1479725159261:customer <- 'batiwiz'
1479725739934:contact_list_id <- getSqlResult(
1479725740601:query = "SELECT id
1479725741032:FROM userlists
1479725741462:WHERE customer = 286367817
1479725741878:AND name = 'REAL_ACT_20_STO'",
1479725742317:database_name = SETTINGS[[customer]]$suite,
1479725742878:customer_id  = getIdFromName(customer)
1479725743701:)
1479725749907:contact_list_id
1479725772895:customer <- 'travelist_market'
1479725777212:contact_list_id <- getSqlResult(
1479725777212:query = "SELECT id
1479725777213:FROM userlists
1479725777214:WHERE customer = 286367817
1479725777214:AND name = 'REAL_ACT_20_STO'",
1479725777215:database_name = SETTINGS[[customer]]$suite
1479725777215:)
1479725794311:contact_list_id <- getSqlResult(
1479725794884:query = "SELECT id
1479725795072:FROM userlists
1479725795222:WHERE customer = 286367817
1479725795379:AND name = 'REAL_ACT_20_STO'",
1479725795579:database_name = SETTINGS[[customer]]$suite
1479725795863:) %>% .[, id]
1479727688233:customer <- 'batiwiz'
1479727689608:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479727741833:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479728969466:campaign_ids_1111 <- c(875502, 875540)
1479728971521:campaigns_to_restrict <- campaign_ids_1111
1479728972076:contacts_to_restrict <- customer_data$campaign_data[
1479728973041:campaign_id %in% campaigns_to_restrict,
1479728973506:.(segment, contact_id)
1479728974595:]
1479728976348:contacts_to_restrict_first <- customer_data$campaign_data[
1479728976843:campaign_id %in% first_sto_campaigns,
1479728977197:.(segment, contact_id)
1479728977554:]
1479728978032:contacts_to_restrict_last <- customer_data$campaign_data[
1479728978376:campaign_id %in% campaign_ids_1111,
1479728978743:.(segment, contact_id)
1479728979165:]
1479728980143:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1479728981833:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479729022763:first_sto_campaigns <- c(624729, 620608)
1479729024662:contacts_to_restrict_first <- customer_data$campaign_data[
1479729024910:campaign_id %in% first_sto_campaigns,
1479729025213:.(segment, contact_id)
1479729025528:]
1479729025841:contacts_to_restrict_last <- customer_data$campaign_data[
1479729026180:campaign_id %in% campaign_ids_1111,
1479729026458:.(segment, contact_id)
1479729026801:]
1479729027429:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1479729031647:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479729117551:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479729161686:all_data
1479729184838:all_data[, .N, by = .(campaign_id, send_hour)][, .N, by = campaign_id][N < 12]
1479729196237:all_data[period == 'sto', .N, by = .(campaign_id, send_hour)][, .N, by = campaign_id][N < 12]
1479729208921:all_data[period == 'sto' & segment = 'sto', .N, by = .(campaign_id, send_hour)][, .N, by = campaign_id][N < 12]
1479729213625:all_data[period == 'sto' & segment == 'sto', .N, by = .(campaign_id, send_hour)][, .N, by = campaign_id][N < 12]
1479729227224:all_data[period == 'sto' & segment == 'sto', .N, by = .(campaign_id, send_day, send_hour)][, .N, by = .(send_day, campaign_id)][N < 12]
1479729250153:all_data[period == 'sto' & segment == 'sto', .N, by = .(campaign_id, send_day, send_hour)][, .N, by = .(send_day, campaign_id)]
1479729282100:all_data[period == 'sto' & segment == 'sto' & send_day < '2016-09-15', .N, by = .(campaign_id, send_day, send_hour)][, .N, by = .(send_day, campaign_id)]
1479729580142:all_data[period == 'sto' & segment == 'sto', .N, by = .(campaign_id, send_day, send_hour)][send_day > '2016-09-15']
1479729587399:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day > '2016-09-15']
1479729596530:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15']
1479729608205:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01']
1479729618617:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & send_hour == 12]
1479729624544:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & send_hour == 16]
1479729706628:customer_data$campaigns
1479729718395:customer_data$campaigns[sto == 664220]
1479729775156:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & campaign_id == 664220]
1479729883415:all_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & campaign_id == 664220][, sum(N)]
1479729918114:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & campaign_id == 664220][, sum(N)]
1479729924917:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day < '2016-09-15' & send_day > '2016-09-01' & campaign_id == 664220]
1479730017128:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day == '2016-09-09' & campaign_id == 664220]
1479730021280:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day == '2016-09-09']
1479730024751:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day == '2016-09-10']
1479730048001:customer_data$campaigns[send_day == '2016-09-10']
1479730097955:customer_data$campaign_data[period == 'sto' & segment == 'sto', .N, keyby = .(campaign_id, send_day, send_hour)][send_day == '2016-09-10'][, sum(N)]
1479730124660:customer_data$campaign_data[period == 'sto' & segment == 'control', .N, keyby = .(campaign_id, send_day, send_hour)][send_day == '2016-09-10'][, sum(N)]
1479730340342:all_data[period == 'past', .N, by = contact_id]
1479730389995:all_data[period == 'past', .N, by = contact_id][, quantile(N, seq(0, 1, 0.1))]
1479730431637:contacts_receiving_past_campaings <- all_data[period == 'past', .N, by = .(segment, contact_id)][N >= 70, .(segment, contact_id)]
1479730487443:# restrict to past campaign receivers as well
1479730491704:all_data[period == 'past', .N, by = contact_id][, quantile(N, seq(0, 1, 0.1))]
1479730492166:contacts_to_restrict <- all_data[period == 'past', .N, by = .(segment, contact_id)][N >= 70, .(segment, contact_id)]
1479730493057:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479730626049:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479730633233:campaign_summary <- calculateSummary(all_data)
1479730635623:plotOpenRateEvolutionWithPast(campaign_summary)
1479730640869:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479730744160:fig_name <- file.path('figure', customer, 'relative-open-rate_segment-past-stable.png')
1479730745618:ggsave(fig_name, width = 11.75, height = 6.6875)
1479730810491:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T, color = 'weekday')
1479730820365:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479739012461:source('global.R')
1479739013938:customer <- 'travelist_market'
1479739014957:our_STO_contactlist_id <- getSqlResult(
1479739015735:query = "SELECT id
1479739015978:FROM userlists
1479739016153:WHERE customer = 286367817
1479739016330:AND name = 'REAL_ACT_20_STO'",
1479739016533:database_name = SETTINGS[[customer]]$suite
1479739016871:) %>% .[, id]
1479739077822:all_segment_data <- readSqlResultLocal(
1479739077823:file_name = 'sql/travelist_history.sql',
1479739077824:refetch = TRUE
1479739077824:)
1479739118189:all_segment_data <- readSqlResultLocal(
1479739118934:file_name = 'sql/travelist_history.sql',
1479739119490:data_file = 'travelist_STO20_history',
1479739119940:refetch = TRUE
1479739120695:)
1479739135507:all_segment_data <- readSqlResultLocal(
1479739136189:file_name = 'sql/travelist_random_check.sql',
1479739136503:data_file = 'travelist_STO20_history',
1479739136795:refetch = TRUE
1479739137212:)
1479739234818:contact_list_id
1479739313494:all_segment_data
1479739321188:all_segment_data[, .N, by = contact_id]
1479739334814:our_STO_contactlist_id <- getSqlResult(
1479739334815:query = "SELECT id
1479739334816:FROM userlists
1479739334816:WHERE customer = 286367817
1479739334817:AND name = 'REAL_ACT_20_STO'",
1479739334817:database_name = SETTINGS[[customer]]$suite
1479739334818:) %>% .[, id]
1479739338947:our_STO_contacts <- getSqlResult(
1479739338947:query = "SELECT user_id as contact_id
1479739338948:FROM ul_286367817_#{userlist_id};",
1479739338948:database_name = SETTINGS[[customer]]$suite,
1479739338949:userlist_id = our_STO_contactlist_id
1479739338949:)
1479739346742:our_STO_contacts
1479739372773:?merge
1479739470516:data_by_segment <- merge(
1479739471036:all_segment_data,
1479739471454:our_STO_contacts[, .(contact_id, segment = 'sto')],
1479739471876:all.x = TRUE, by = 'contact_id'
1479739473175:)
1479739478000:data_by_segment
1479739503715:data_by_segment <- merge(
1479739504171:all_segment_data,
1479739504353:our_STO_contacts[, .(contact_id, segment = 'sto')],
1479739504532:all.x = TRUE, by = 'contact_id'
1479739504715:) %>%
1479739504978:.[is.na(segment), segment := 'control'] %>%
1479739505353:.[]
1479739517031:data_by_segment[, .N, by = segment]
1479739540958:all_segment_data <- readSqlResultLocal(
1479739540958:file_name = 'sql/travelist_random_check.sql',
1479739540959:data_file = 'travelist_STO20_history',
1479739540959:refetch = TRUE
1479739540960:)
1479743613837:all_segment_data
1479743632645:data_by_segment <- merge(
1479743632646:all_segment_data,
1479743632646:our_STO_contacts[, .(contact_id, segment = 'sto')],
1479743632647:all.x = TRUE, by = 'contact_id'
1479743632648:) %>%
1479743632648:.[is.na(segment), segment := 'control'] %>%
1479743632649:.[]
1479743724874:data_by_segment[, .N, by = segment]
1479743757578:data_by_segment[!bounced, mean(opened), by = .(segment, contact_id)]
1479743773759:data_by_segment
1479743783624:data_by_segment[!bounced]
1479743786813:data_by_segment[bounced]
1479743792689:data_by_segment[bounced == FALSE]
1479743810218:data_by_segment[bounced == FALSE, mean(opened), by = .(segment, contact_id)]
1479743829889:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1479743830520:.[, mean(open_rate), by = segment]
1479743875527:calculateSummary(data_by_segment)
1479744003299:calculateSummary <- function(campaign_data, initial = Inf, contact_condition = 'TRUE', campaign_condition = 'TRUE', by = c('period', 'segment', 'send_day')) {
1479744003300:campaign_data %>%
1479744003301:.[bounced == FALSE & eval(parse(text = contact_condition))] %>%
1479744003301:calculateCampaignOpenRate(by = by, initial = initial) %>%
1479744003302:.[eval(parse(text = campaign_condition))] %>%
1479744003303:addWeekdayToDt_() %>%
1479744003304:addWeekendToSummary_()
1479744003306:}
1479744040164:calculateSummary(data_by_segment, by = c('segment', 'send_day'))
1479744169901:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'))
1479744183850:history_summary %>% plotOpenRateEvolution()
1479744210493:history_summary %>% plotRelativeOpenRateEvolution()
1479744220160:generateRelativeData(history_summary) %>% plotRelativeOpenRateEvolution()
1479744228109:generateRelativeData(history_summary)
1479744272258:history_summary %>%
1479744272258:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744272259:.[, relative_open_rate := sto / control] %>%
1479744272260:.[!is.na(sto)]
1479744282114:history_summary %>%
1479744282117:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744282117:.[, relative_open_rate := sto / control] %>%
1479744282118:.[!is.na(sto)] %>%
1479744282118:plotRelativeOpenRateEvolution()
1479744291932:history_summary %>%
1479744291933:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744291933:.[, relative_open_rate := sto / control] %>%
1479744291934:.[!is.na(sto)] %>%
1479744291934:plotRelativeOpenRateEvolution(FALSE, FALSE, FALSE)
1479744329130:history_summary %>%
1479744329131:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744329131:.[, relative_open_rate := sto / control] %>%
1479744329132:.[!is.na(sto)] %>%
1479744329133:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE
1479744334830:)
1479744383903:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479744384300:scale_y_continuous(limits = c(0.975, 1.025))
1479744386143:history_summary %>%
1479744386412:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744386612:.[, relative_open_rate := sto / control] %>%
1479744386812:.[!is.na(sto)] %>%
1479744387025:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479744387338:scale_y_continuous(limits = c(0.975, 1.025))
1479744423919:history_summary %>% plotOpenRateEvolution()
1479744872347:history_summary %>%
1479744872349:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744872349:.[, relative_open_rate := sto / control] %>%
1479744872350:.[!is.na(sto)] %>%
1479744872350:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479744872351:scale_y_continuous(limits = c(0.975, 1.025))
1479744890844:history_summary %>%
1479744891291:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479744891566:.[, relative_open_rate := sto / control] %>%
1479744891844:.[!is.na(sto)] %>%
1479744892184:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479744892464:scale_y_continuous(limits = c(0.95, 1.05))
1479811888440:all_segment_id <- getSqlResult(
1479811888443:query = "SELECT id, countusers
1479811888445:FROM userlists
1479811888446:WHERE customer = 286367817
1479811888446:AND description = 'Program Id: 5426'",
1479811888447:database_name = SETTINGS[[customer]]$suite
1479811888448:) %>% [countusers < 1000000, id]
1479811894750:all_segment_id <- getSqlResult(
1479811894751:query = "SELECT id, countusers
1479811894751:FROM userlists
1479811894752:WHERE customer = 286367817
1479811894752:AND description = 'Program Id: 5426'",
1479811894753:database_name = SETTINGS[[customer]]$suite
1479811894754:) %>% .[countusers < 1000000, id]
1479811931563:all_segment_id
1479811935314:all_contacts <- getSqlResult(
1479811935314:query = "SELECT user_id as contact_id
1479811935315:FROM ul_286367817_#{userlist_id};",
1479811935315:database_name = SETTINGS[[customer]]$suite,
1479811935316:userlist_id = all_segment_id
1479811935316:)
1479812052869:contacts_by_segment <- merge(
1479812052870:all_contacts[, .(contact_id, all = 'all')],
1479812052871:our_STO_contacts[, .(contact_id, segment = 'sto')],
1479812052871:all = TRUE, by = 'contact_id'
1479812052872:)
1479812057682:contacts_by_segment
1479812061833:contacts_by_segment[is.na(all)]
1479812080308:contacts_by_segment <- merge(
1479812080310:all_contacts,
1479812080310:our_STO_contacts[, .(contact_id, segment = 'sto')],
1479812080311:all = TRUE, by = 'contact_id'
1479812080311:) %>%
1479812080311:.[is.na(segment), segment := 'control'] %>%
1479812080312:.[]
1479812083915:contacts_by_segment
1479812090211:contacts_by_segment[, .N, by = segment]
1479812633726:contacts_by_segment <- merge(
1479812633726:all_contacts,
1479812633727:our_STO_contacts[, .(contact_id, sto = 1)],
1479812633728:all = TRUE, by = 'contact_id'
1479812633728:) %>%
1479812633729:.[is.na(segment), sto := 0] %>%
1479812633729:.[]
1479812649280:contacts_by_segment <- merge(
1479812650552:all_contacts,
1479812651621:our_STO_contacts[, .(contact_id, sto = 1)],
1479812652530:all = TRUE, by = 'contact_id'
1479812653079:) %>%
1479812653471:.[is.na(sto), sto := 0] %>%
1479812653886:.[]
1479812661816:contacts_by_segment
1479812667161:contacts_by_segment[, .N, by =sto]
1479812733883:try <- contacts_by_segment[1:3]
1479812734796:try
1479812771392:paste(try[, .(contact_id, sto)], sep = ',')
1479812781128:paste(try[, .(contact_id, sto)], sep = ',', by = .EACHI)
1479812795561:paste(try[, .(contact_id, sto), by = .EACHI], sep = ',')
1479812832346:try[, paste0(contact_id, sto), sep = ',']
1479812840306:try[, paste0(contact_id, sto, sep = ',')]
1479812855188:try[, paste0(contact_id, sto, collapse = ',')]
1479812969337:mapply(c, try)
1479812995303:mapply(paste, try)
1479813013788:mapply(FUN = paste(., collapse = ','), try)
1479813031684:mapply(FUN = function(...) paste(..., collapse = ','), try)
1479813045093:mapply(FUN = function(...) paste(..., sep = ','), try)
1479813079973:try
1479813101143:try[, .(result = paste(contact_id, sto, sep = ','))]
1479813113353:try[, paste(contact_id, sto, sep = ','))]
1479813114832:try[, paste(contact_id, sto, sep = ',')]
1479813151097:try[, paste(contact_id, sto, sep = ',')]
1479813162304:try[, paste(contact_id, sto, sep = ',')] %>% paste(collapse = ',')
1479813168395:try[, paste(contact_id, sto, sep = ',')] %>% paste(collapse = '),(')
1479813175080:try[, paste(contact_id, sto, sep = ',')] %>% paste(collapse = ',')
1479813237165:createStringValuesForSQLWith <- function(dt) {
1479813237166:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1479813237166:paste(collapse = ',')
1479813237167:}
1479813245832:createStringValuesForSQLWith(try)
1479813527464:data_by_segment <- readSqlResultLocal(
1479813527464:file_name = 'sql/travelist_random_check.sql',
1479813527465:string_value = createStringValuesForSQLWith(contacts_by_segment[1:3])
1479813527466:data_file = 'travelist_STO20_history.csv',
1479813527466:refetch = TRUE
1479813527467:)
1479813537024:data_by_segment <- readSqlResultLocal(
1479813537430:file_name = 'sql/travelist_random_check.sql',
1479813537726:string_value = createStringValuesForSQLWith(contacts_by_segment[1:3]),
1479813537997:data_file = 'travelist_STO20_history.csv',
1479813538641:refetch = TRUE
1479813539510:)
1479813593716:data_by_segment <- readSqlResultLocal(
1479813594316:file_name = 'sql/travelist_random_check.sql',
1479813594526:data_file = 'travelist_STO20_history.csv',
1479813594715:values_string = createStringValuesForSQLWith(contacts_by_segment[1:3]),
1479813595135:refetch = TRUE
1479813595466:)
1479813632719:data_by_segment
1479813637601:data_by_segment[, .N, by = contact_id]
1479813653370:data_by_segment <- readSqlResultLocal(
1479813653371:file_name = 'sql/travelist_random_check.sql',
1479813653371:data_file = 'travelist_STO20_history.csv',
1479813653372:values_string = createStringValuesForSQLWith(contacts_by_segment),
1479813653372:refetch = TRUE
1479813653373:)
1479820672867:data_by_segment
1479820683151:data_by_segment[, segment := ifelse(sto == 1, 'sto', 'control')]
1479820699987:data_by_segment[, .N, by = segment]
1479820704065:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1479820705468:.[, mean(open_rate), by = segment]
1479820762392:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'))
1479820808082:history_summary %>% plotOpenRateEvolution()
1479820839491:history_summary %>%
1479820839877:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479820840217:.[, relative_open_rate := sto / control] %>%
1479820840545:.[!is.na(sto)] %>%
1479820840902:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479820841250:scale_y_continuous(limits = c(0.95, 1.05))
1479820955779:data_by_segment[, .(contact_id, segment)] %>% unique()
1479820996341:data_by_segment[, .(contact_id, segment)] %>% unique() %>% .[, .N, by = segment]
1479821280788:data_by_segment[, .(contact_id, segment)] %>% unique() %>% .[, .N, by = segment][, .(segment, N, sum = sum(N))]
1479821295658:data_by_segment[, .(contact_id, segment)] %>% unique() %>% .[, .N, by = segment] %>% .[, .(segment, N, sum = sum(N))]
1479821494466:data_by_segment[, .N, by = .(campaign_id, segment)]
1479821521039:data_by_segment[, .N, by = .(campaign_id, segment)][, N/sum(N), by = campaign_id]
1479821549050:data_by_segment[, .N, by = .(campaign_id, segment)][, .(segment, N/sum(N)), by = campaign_id]
1479821593858:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N/sum(N)), by = .(send_day, campaign_id)]
1479821632017:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)]
1479821647398:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)][N >= 10]
1479821698485:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'), campaign_condition = 'N > 10')
1479821724777:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)][N >= 10] %>% ggplot(aes(send_day, share, col = segment)) + geom_line()
1479821743832:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)][N >= 10] %>% ggplot(aes(send_day, share, col = segment)) + geom_line() + geom_point()
1479821758979:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)][N >= 100] %>% ggplot(aes(send_day, share, col = segment)) + geom_line() + geom_point()
1479821795686:data_by_segment[, .N, by = .(send_day, campaign_id, segment)][, .(segment, N, share = N/sum(N)), by = .(send_day, campaign_id)][N >= 1000] %>% ggplot(aes(send_day, share, col = segment)) + geom_line() + geom_point()
1479821823059:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'), campaign_condition = 'num_send > 10')
1479821844890:history_summary
1479821854896:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'), campaign_condition = 'n > 100')
1479821889123:history_summary %>% plotOpenRateEvolution()
1479821896822:history_summary %>%
1479821897264:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479821897577:.[, relative_open_rate := sto / control] %>%
1479821897857:.[!is.na(sto)] %>%
1479821898175:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479821898518:scale_y_continuous(limits = c(0.95, 1.05))
1479821907371:history_summary <- calculateSummary(data_by_segment, by = c('segment', 'send_day'), campaign_condition = 'n > 1000')
1479821948763:history_summary %>% plotOpenRateEvolution()
1479821961346:big_campaigns <- data_by_segment[, .N, by = campaign_id]
1479821968768:big_campaigns
1479821986193:big_campaigns[N > 10000]
1479821992977:big_campaigns[N > 100000]
1479822002972:big_campaigns <- data_by_segment[, .N, by = campaign_id][N > 100000]
1479822047056:data_by_segment_big_campaigns <- merge(data_by_segment, big_campaigns, by = 'campaign_id')
1479822138664:history_summary <- calculateSummary(data_by_segment_big_campaigns, by = c('segment', 'send_day'))
1479822170897:history_summary %>% plotOpenRateEvolution()
1479822188383:history_summary %>%
1479822188385:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479822188390:.[, relative_open_rate := sto / control] %>%
1479822188391:.[!is.na(sto)] %>%
1479822188392:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479822188393:scale_y_continuous(limits = c(0.95, 1.05))
1479822400318:contacts_by_segment
1479822409624:contacts_by_segment[, .N, by = sto]
1479822441273:data_by_segment[, .N, by = contact_id][, .N, by = segment]
1479822451853:data_by_segment[, .N, by = contact_id][, .N, by = sto]
1479822465667:data_by_segment[, .N, by = .(segment, contact_id)][, .N, by = segment]
1479822474784:contacts_by_segment[, .N, by = sto]
1479823666074:data_by_segment[, .N, by = .(segment, contact_id)]
1479823834146:data_by_segment[, .N, by = .(segment, contact_id)] %>% ggplot(aes(N, fill = segment)) + geom_density(alpha =0.6)
1479827587883:random_segments <- data_by_segment[, .(contact_id)] %>% unique %>%
1479827589440:.[, rand1 := sample(c('sto', 'control'), size = .N, replace = TRUE, probs = c(0.2, 0.8))]
1479827609022:?sample
1479827618008:random_segments <- data_by_segment[, .(contact_id)] %>% unique %>%
1479827618009:.[, rand1 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))]
1479827623780:random_segments
1479827625837:random_segments
1479827694907:random_segments <- data_by_segment[, .(contact_id)] %>% unique %>%
1479827694908:.[, rand1 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479827694909:.[, rand2 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479827694909:.[, rand3 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479827694909:.[, rand4 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479827694910:.[]
1479827702323:random_segments
1479827719513:data_by_segment_random <- merge(data_by_segment, random_segments, by = 'contact_id')
1479827803997:history_summary <- calculateSummary(data_by_segment_random, by = c('rand1', 'send_day'))
1479827864653:history_summary %>%
1479827864654:dcast(send_day + weekday + weekend ~ segment, value.var = 'open_rate') %>%
1479827864655:.[, relative_open_rate := sto / control] %>%
1479827864656:.[!is.na(sto)] %>%
1479827864657:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479827864657:scale_y_continuous(limits = c(0.95, 1.05))
1479827875675:history_summary %>%
1479827876195:dcast(send_day + weekday + weekend ~ rand1, value.var = 'open_rate') %>%
1479827876466:.[, relative_open_rate := sto / control] %>%
1479827876680:.[!is.na(sto)] %>%
1479827877078:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479827877487:scale_y_continuous(limits = c(0.95, 1.05))
1479827898015:history_summary <- calculateSummary(data_by_segment_random, by = c('rand2', 'send_day'))
1479827916498:history_summary %>%
1479827917256:dcast(send_day + weekday + weekend ~ rand2, value.var = 'open_rate') %>%
1479827917682:.[, relative_open_rate := sto / control] %>%
1479827918004:.[!is.na(sto)] %>%
1479827918336:plotRelativeOpenRateEvolution(prior_change_dates = FALSE, text = FALSE) +
1479827918719:scale_y_continuous(limits = c(0.95, 1.05))
1479828796834:trydt
1479828798130:try
1479828908800:data_by_segment_random
1479828921548:history_summary
1479829120292:history_summary <-  data_by_segment_random[bounced == FALSE & 1:1000] %>%
1479829120293:lapply(
1479829120294:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829120294:function(segment_var) {
1479829120294:calculateCampaignOpenRate(by = c(segment_var, 'send_day'))
1479829120295:}
1479829120295:)
1479829182970:history_summary <- lapply(
1479829182971:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829182972:function(segment_var) {
1479829182973:calculateCampaignOpenRate(
1479829182974:dt = data_by_segment_random[bounced == FALSE & 1:1000],
1479829182976:by = c(segment_var, 'send_day')
1479829182977:)
1479829182978:}
1479829182982:)
1479829285335:history_summary <- lapply(
1479829285336:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829285337:function(segment_var) {
1479829285340:calculateCampaignOpenRate(
1479829285341:dt = data_by_segment_random[1:1000],
1479829285342:by = c(segment_var, 'send_day')
1479829285343:)
1479829285343:}
1479829285344:)
1479829290186:history_summary
1479829365051:history_summary <- lapply(
1479829365052:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829365052:function(segment_var) {
1479829365053:calculateCampaignOpenRate(
1479829365054:dt = data_by_segment_random[1:1000],
1479829365054:by = c(segment_var, 'send_day')
1479829365055:)
1479829365055:} %>%
1479829365056:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829365056:.[, relative_open_rate := sto/control]
1479829365057:)
1479829368821:history_summary
1479829431694:history_summary <- lapply(
1479829431695:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829431695:function(segment_var) {
1479829431696:calculateCampaignOpenRate(
1479829431696:dt = data_by_segment_random[1:1000],
1479829431697:by = c(segment_var, 'send_day')
1479829431698:)
1479829431698:} %>%
1479829431699:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829431699:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479829431700:)
1479829435544:history_summary
1479829493658:history_summary <- lapply(
1479829493659:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829493659:function(segment_var) {
1479829493660:calculateCampaignOpenRate(
1479829493660:dt = data_by_segment_random[1:1000],
1479829493661:by = c(segment_var, 'send_day')
1479829493661:)
1479829493662:} %>%
1479829493662:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829493663:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479829493663:) %>%
1479829493664:rbindlist() %>%
1479829493665:ggplot(aes(send_day, realtive_open_rate, col = segment)) +
1479829493665:geom_line() + geom_point() +
1479829493666:geom_hline(yintercept = 1, linetype = 'dashed')
1479829502697:lapply(
1479829502697:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829502698:function(segment_var) {
1479829502699:calculateCampaignOpenRate(
1479829502699:dt = data_by_segment_random[1:1000],
1479829502700:by = c(segment_var, 'send_day')
1479829502700:)
1479829502701:} %>%
1479829502701:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829502702:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479829502703:) %>%
1479829502704:rbindlist() %>%
1479829502705:ggplot(aes(send_day, realtive_open_rate, col = segment)) +
1479829502705:geom_line() + geom_point() +
1479829502706:geom_hline(yintercept = 1, linetype = 'dashed')
1479829542174:history_summary <- calculateSummary(data_by_segment)
1479829599798:lapply(
1479829600037:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829600368:function(segment_var) {
1479829600370:calculateCampaignOpenRate(
1479829600371:dt = data_by_segment_random[1:1000],
1479829600372:by = c(segment_var, 'send_day')
1479829600373:)
1479829600373:} %>%
1479829600562:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829600758:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479829601133:) %>%
1479829601530:rbindlist() %>%
1479829601956:ggplot(aes(send_day, relative_open_rate, col = segment)) +
1479829602246:geom_line() + geom_point() +
1479829602629:geom_hline(yintercept = 1, linetype = 'dashed')
1479829639903:history_summaries <- lapply(
1479829639904:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479829639905:function(segment_var) {
1479829639905:calculateCampaignOpenRate(
1479829639905:dt = data_by_segment_random[bounced == FALSE],
1479829639906:by = c(segment_var, 'send_day')
1479829639907:)
1479829639907:} %>%
1479829639907:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479829639908:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479829639909:)
1479829799102:history_summaries %>%
1479829799108:rbindlist() %>%
1479829799109:ggplot(aes(send_day, relative_open_rate, col = segment)) +
1479829799115:geom_line() + geom_point() +
1479829799115:geom_hline(yintercept = 1, linetype = 'dashed')
1479829852265:history_summaries %>%
1479829852272:rbindlist() %>%
1479829852274:ggplot(aes(send_day, relative_open_rate, col = segment)) +
1479829852276:geom_line() + geom_point() +
1479829852278:geom_hline(yintercept = 1, linetype = 'dashed') +
1479829852279:scale_y_continuous(limits = c(0.975, 1.025))
1479829870290:history_summaries %>%
1479829870668:rbindlist() %>%
1479829870860:ggplot(aes(send_day, relative_open_rate, col = segment)) +
1479829871025:geom_line() + geom_point() +
1479829871369:geom_hline(yintercept = 1, linetype = 'dashed') +
1479829871709:scale_y_continuous(limits = c(0.95, 1.05))
1479900400071:source('global.R')
1479900401787:customer <- 'travelist_market'
1479900404299:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479901499140:history_summaries %>%
1479901499141:rbindlist() %>%
1479901499141:plotly(send_day, relative_open_rate, color = segment)
1479901512580:history_summaries %>%
1479901512581:rbindlist() %>%
1479901512581:plot_ly(send_day, relative_open_rate, color = segment)
1479901581947:history_summaries %>%
1479901581949:rbindlist() %>%
1479901581949:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479901581949:add_trace(x = send_day, y = 1, line = list(dash = 'dashed'))
1479901596061:history_summaries %>%
1479901596062:rbindlist() %>%
1479901596062:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479901596063:add_trace(y = 1, line = list(dash = 'dashed'))
1479901636749:history_summaries %>%
1479901636751:rbindlist() %>%
1479901636751:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479901636752:add_trace(x = c(min(send_day), max(send_day)), y = 1, line = list(dash = 'dashed'))
1479901646536:history_summaries %>%
1479901646537:rbindlist() %>%
1479901646537:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479901646537:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), line = list(dash = 'dashed'))
1479901911119:history_summaries %>%
1479901911120:rbindlist() %>%
1479901911121:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment)
1479901965784:packageVersion('plotly')
1479901973097:install.packages('plotly')
1479901993892:library(plotly)
1479902011052:packageVersion('plotly')
1479902018864:history_summaries %>%
1479902018864:rbindlist() %>%
1479902018865:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment)
1479902112000:packageVersion(dplyr)
1479902171367:p <- plot_ly(history_summaries, x = ~send_day, y = ~relative_open_rate)
1479902190067:p <- plot_ly(history_summaries, x = send_day, y = relative_open_rate)
1479902346678:history_summaries %>%
1479902346678:rbindlist() %>%
1479902346679:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment) %>%
1479902346679:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), line = list(dash = 'dashed'))
1479902356284:history_summaries %>%
1479902356285:rbindlist() %>%
1479902356285:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902356286:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), line = list(dash = 'dashed'))
1479902367972:history_summaries %>%
1479902367973:rbindlist() %>%
1479902367974:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902367975:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = 'dashed'))
1479902461908:history_summaries %>%
1479902461909:rbindlist() %>%
1479902461910:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902461910:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash))
1479902488637:history_summaries %>%
1479902488637:rbindlist() %>%
1479902488638:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902488638:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = "solid"))
1479902494212:history_summaries %>%
1479902494213:rbindlist() %>%
1479902494214:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902494215:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = "dashed"))
1479902498657:history_summaries %>%
1479902498657:rbindlist() %>%
1479902498658:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902498659:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = "dash"))
1479902503453:history_summaries %>%
1479902503453:rbindlist() %>%
1479902503454:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902503455:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = "dot"))
1479902509783:history_summaries %>%
1479902509785:rbindlist() %>%
1479902509785:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902509787:add_trace(x = c(min(send_day), max(send_day)), y = c(1, 1), mode = 'lines', line = list(dash = "dot", color = 'gray'))
1479902564884:history_summaries %>%
1479902564887:rbindlist() %>%
1479902564888:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902564889:add_trace(
1479902564890:x = c(min(send_day), max(send_day)), y = c(1, 1),
1479902564890:mode = 'lines', line = list(dash = "dot", color = 'gray'), showlegend = FALSE
1479902564890:)
1479902655460:history_summaries %>%
1479902655460:rbindlist() %>%
1479902655461:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479902655461:add_trace(
1479902655461:x = c(min(send_day), max(send_day)), y = c(1, 1),
1479902655462:mode = 'lines', line = list(dash = "dot", color = 'gray'), showlegend = FALSE
1479902655462:) %>%
1479902655462:layout(yaxis = list(range = c(0.95, 1.05)))
1479902676436:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479902698237:contacts_to_restrict <- unique_contacts
1479902738385:contacts_to_restrict <- unique_contacts
1479903086216:if (customer == 'travelist_market') {
1479903086219:all_data <- all_data[campaign_id != 701805]
1479903086219:}
1479903102488:all_data %>%
1479903102489:.[segment == 'control' & period == 'sto'] %>%
1479903102490:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1479903102490:ggplot(aes(x = send_day, y = min_send_hour)) +
1479903102490:geom_point()
1479903107087:all_data %>%
1479903107088:.[, .N, by = .(send_day, segment)] %>%
1479903107089:ggplot(aes(x = send_day, y = N, col = segment)) +
1479903107089:geom_point() + geom_line() +
1479903107089:addSTOline(text_position = 0) +
1479903107090:expand_limits(y = 0)
1479903123651:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479903132453:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479903405410:if (customer == 'travelist_market') {
1479903405421:all_data <- all_data[campaign_id != 701805]
1479903405428:}
1479903416556:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479903428670:campaign_summary <- calculateSummary(all_data)
1479903438907:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479903454860:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1479903470833:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479903478330:campaign_summary %>% plotOpenRatesByDays()
1479903500914:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479903502255:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479903502261:active_data <- restrictDataToContacts(all_data, active_contacts)
1479903504607:active_summary <- active_data %>% calculateSummary()
1479903505776:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479903536131:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479903544212:very_active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$very_active_cutoff]
1479903544992:very_active_data <- restrictDataToContacts(all_data, very_active_contacts)
1479903546366:very_active_summary <- restrictDataToContacts(all_data, very_active_contacts) %>% calculateSummary()
1479903548470:generateRelativeData(very_active_summary) %>% plotRelativeOpenRateEvolution()
1479903552643:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479903561476:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479903573405:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479903600707:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1479903611564:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1479903634806:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479903673317:campaign_summary
1479903690879:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479903722370:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479903805609:customer_data$campaign_data[, .N, by = .(segment, contact_id)]
1479903846396:customer_data$campaign_data[, .N, by = .(segment, contact_id)][, .N, by = N]
1479903850900:customer_data$campaign_data[, .N, by = .(segment, contact_id)][, .N, keyby = N]
1479903954862:customer_data$campaigns
1479903969416:customer_data$campaigns[, .(sto)]
1479904112797:customer_data$campaign_data[, uniqueN(campaign_id), by = .(segment)]
1479904165046:unique_contacts
1479904169678:unique_contacts[, .N, by = segment]
1479904190587:calculateMedianDistance(all_data) %>%
1479904190589:generateRelativeData(measure = 'median_hours_to_open') %>%
1479904190589:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479904190590:ylab('relative median send-open distance in hours')
1479904215536:calculateMedianDistance(active_data) %>%
1479904215540:generateRelativeData(measure = 'median_hours_to_open') %>%
1479904215540:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479904215541:ylab('relative median send-open distance in hours')
1479904228595:x <- 2
1479904229248:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479904229249:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479904235156:ggsave(file.path('figure', customer, paste0('first', x, 'hour_relative.png')), width = 11.75, height = 6.6875)
1479904244989:x <- 168
1479904245654:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479904245656:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479904253835:x <- 12
1479904254365:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479904254367:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479904724196:getContactlistId <- function(contactlist_name) {
1479904724197:getSqlResult(
1479904724198:query = paste0("SELECT id
1479904724198:FROM userlists
1479904724199:WHERE customer = 286367817
1479904724200:AND name = ", contactlist_name),
1479904724200:database_name = SETTINGS[[customer]]$suite
1479904724201:) %>% .[, id]
1479904724202:}
1479904725482:getListOfContacts <- function(contactlist_id) {
1479904725484:getSqlResult(
1479904725485:query = "SELECT user_id as contact_id
1479904725486:FROM ul_286367817_#{userlist_id};",
1479904725486:database_name = SETTINGS[[customer]]$suite,
1479904725487:userlist_id = contactlist_id
1479904725488:)
1479904725488:}
1479904726538:our_STO_contactlist_id <- getContactlistId('REAL_AKT_20_STO')
1479904771057:getContactlistId('REAL_AKT_20_STO', debug = TRUE)
1479904789112:debug(getContactlistId)
1479904791108:getContactlistId('REAL_AKT_20_STO', debug = TRUE)
1479904794517:getContactlistId('REAL_AKT_20_STO')
1479904803022:debug(getSqlResult)
1479904806092:query
1479904858798:t
1479904858802:getContactlistId <- function(contactlist_name) {
1479904858804:getSqlResult(
1479904858805:query = paste0("SELECT id
1479904858806:FROM userlists
1479904858806:WHERE customer = 286367817
1479904858807:AND name = \\'", contactlist_name, "\\'"),
1479904858808:database_name = SETTINGS[[customer]]$suite
1479904858808:) %>% .[, id]
1479904858808:}
1479904858813:Q
1479904858893:\
1479904862227:getContactlistId <- function(contactlist_name) {
1479904862228:getSqlResult(
1479904862228:query = paste0("SELECT id
1479904862228:FROM userlists
1479904862229:WHERE customer = 286367817
1479904862229:AND name = \\'", contactlist_name, "\\'"),
1479904862230:database_name = SETTINGS[[customer]]$suite
1479904862230:) %>% .[, id]
1479904862231:}
1479904866886:getContactlistId('REAL_AKT_20_STO')
1479904872083:query
1479904903137:getContactlistId <- function(contactlist_name) {
1479904903138:getSqlResult(
1479904903138:query = paste0("SELECT id
1479904903139:FROM userlists
1479904903139:WHERE customer = 286367817
1479904903139:AND name = '", contactlist_name, "'"),
1479904903140:database_name = SETTINGS[[customer]]$suite
1479904903140:) %>% .[, id]
1479904903140:}
1479904903143:Q
1479904907527:getContactlistId <- function(contactlist_name) {
1479904907528:getSqlResult(
1479904907528:query = paste0("SELECT id
1479904907529:FROM userlists
1479904907529:WHERE customer = 286367817
1479904907529:AND name = '", contactlist_name, "'"),
1479904907530:database_name = SETTINGS[[customer]]$suite
1479904907530:) %>% .[, id]
1479904907530:}
1479904910840:getContactlistId('REAL_AKT_20_STO')
1479904912455:query
1479904973349:undebug(getSqlResult)
1479905041172:our_STO_contacts <- getListOfContacts(getContactlistId('REAL_AKT_20_STO'))
1479905052099:our_STO_contactlist_id
1479905054601:our_STO_contacts
1479905076233:our_control_contacts <- getListOfContacts(getContactlistId('REAL_AKT_20_CONTROL'))
1479905095277:our_control_contacts <- getListOfContacts(getContactlistId('REAL_AKT_20_CONTROL'))
1479905104733:getContactlistId('REAL_AKT_20_CONTROL')
1479905115584:our_control_contacts <- getListOfContacts(getContactlistId('REAL_AKT_80_CONTROL'))
1479905131896:our_control_contacts <- getListOfContacts(getContactlistId('REAL_AKT_80_CONTROL'))
1479905146263:our_control_contacts
1479905292278:contacts_by_segment <- lapply(0:1, function(i) {
1479905292278:segment <- c('REAL_AKT_20_STO', 'REAL_AKT_80_CONTROL')[i + 1]
1479905292280:getListOfContacts(getContactlistId(segment)) %>%
1479905292281:.[, sto := i]
1479905292282:}) %>% rbindlist()
1479905329937:lapply(0:1, function(i) {
1479905329938:segment <- c('REAL_AKT_20_STO', 'REAL_AKT_80_CONTROL')[i + 1]
1479905332702:}
1479905334558:)
1479905343338:contacts_by_segment <- lapply(0:1, function(i) {
1479905343339:segment <- c('REAL_AKT_20_STO', 'REAL_AKT_80_CONTROL')[i + 1]
1479905343340:getListOfContacts(getContactlistId(segment)) %>%
1479905343340:.[, sto := i]
1479905343341:}) %>% rbindlist()
1479905358952:contacts_by_segment
1479905362854:contacts_by_segment[, .N, by = sto]
1479905375231:createStringValuesForSQLWith <- function(dt) {
1479905375232:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1479905375233:paste(collapse = ',')
1479905375234:}
1479905382046:data_by_segment <- readSqlResultLocal(
1479905382046:file_name = 'sql/travelist_random_check.sql',
1479905382047:data_file = 'travelist_STO20_history.csv',
1479905382048:values_string = createStringValuesForSQLWith(contacts_by_segment),
1479905382048:refetch = TRUE
1479905382049:)
1479911137467:data_by_segment[, segment := ifelse(sto == 1, 'sto', 'control')]
1479911153806:data_by_segment[, .N, by = segment]
1479911154709:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1479911172470:.[, mean(open_rate), by = segment]
1479911193073:random_segments <- data_by_segment[, .(contact_id)] %>% unique %>%
1479911193076:.[, rand1 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479911193088:.[, rand2 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479911193107:.[, rand3 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479911193117:.[, rand4 := sample(c('sto', 'control'), size = .N, replace = TRUE, prob = c(0.2, 0.8))] %>%
1479911193153:.[]
1479911206643:data_by_segment_random <- merge(data_by_segment, random_segments, by = 'contact_id')
1479911306576:history_summaries <- lapply(
1479911306587:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479911306597:function(segment_var) {
1479911306605:calculateCampaignOpenRate(
1479911306607:dt = data_by_segment_random[bounced == FALSE],
1479911306615:by = c(segment_var, 'send_day')
1479911306621:)
1479911306627:} %>%
1479911306631:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479911306638:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479911306644:)
1479911548120:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1479911548142:function(segment_var) {
1479911548148:calculateCampaignOpenRate(
1479911548156:dt = data_by_segment_random[bounced == FALSE],
1479911548168:by = c(segment_var, 'send_day')
1479911548175:)
1479911548185:} %>%
1479911548202:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1479911548209:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1479911548280:)
1479911612054:history_summaries %>%
1479911612057:rbindlist() %>%
1479911612060:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1479911612061:add_trace(
1479911612062:x = c(min(send_day), max(send_day)), y = c(1, 1),
1479911612062:mode = 'lines', line = list(dash = "dot", color = 'gray'), showlegend = FALSE
1479911612063:) %>%
1479911612064:layout(yaxis = list(range = c(0.95, 1.05)))
1479922464678:customer <- 'batiwiz'
1479922470061:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479922975461:plotOpenRateEvolutionWithPast(campaign_summary)
1479922980654:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479922995529:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1479923059793:campaign_summary %>% plotOpenRatesByDays()
1479923104603:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution()
1479923113981:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479923123228:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, facet = 'weekday')
1479923132110:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = TRUE, facet = 'weekday')
1479923161972:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, facet = 'weekday')
1479923183958:generateRelativeData(active_summary) %>% plotRelativeOpenRateEvolution(trendlines = FALSE, color = 'weekday')
1479923205028:generateRelativeData(very_active_summary) %>% plotRelativeOpenRateEvolution()
1479923214955:generateRelativeData(very_active_summary) %>% plotRelativeOpenRateEvolution(color = 'weekday', trendline = F)
1479923226704:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1479923237468:all_data[period == 'sto' & segment == 'sto'] %>%
1479923237469:calculateCumulativeOpenRate() %>%
1479923237469:merge(
1479923237471:campaign_summary[period == 'sto' & segment == 'control', .(send_day, control_open_rate = open_rate)],
1479923237471:by = 'send_day'
1479923237472:) %>%
1479923237472:.[, .(send_day, hours_to_open, relative_rate = cumulative_open_rate / control_open_rate)] %>%
1479923237472:plotCumulatingOpenRates()
1479923310732:all_data %>% plotCumulatingOpenRatesForGivenDate('2016-11-17')
1479923386719:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479923417519:calculateMedianDistance(all_data) %>%
1479923417520:generateRelativeData(measure = 'median_hours_to_open') %>%
1479923417521:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479923417524:ylab('relative median send-open distance in hours')
1479923437455:x <- 12
1479923438456:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479923438456:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479923465692:x <- 2
1479923466309:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479923466312:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479923544925:x <- 24
1479923545425:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479923545426:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479923575157:x <- 24
1479923576068:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479923576073:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479923622852:x <- 12
1479923623538:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479923623539:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479923651207:x <- 1
1479923651966:generateRelativeData(calculateSummary(active_data, initial = x)) %>%
1479923651967:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479927773978:customer <- 'batiwiz'
1479927783578:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1479929359214:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479929375497:campaign_ids_1111 <- c(875502, 875540)
1479929377217:campaigns_to_restrict <- campaign_ids_1111
1479929377915:contacts_to_restrict <- customer_data$campaign_data[
1479929377916:campaign_id %in% campaigns_to_restrict,
1479929377918:.(segment, contact_id)
1479929377918:]
1479929379581:contacts_to_restrict_first <- customer_data$campaign_data[
1479929379582:campaign_id %in% first_sto_campaigns,
1479929379583:.(segment, contact_id)
1479929379583:]
1479929380610:contacts_to_restrict_last <- customer_data$campaign_data[
1479929380612:campaign_id %in% campaign_ids_1111,
1479929380613:.(segment, contact_id)
1479929380614:]
1479929382085:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1479929384050:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479967429607:if (customer == 'batiwiz') {
1479967429649:# intersection with sto campaigns, pair of control campaign
1479967429655:all_data <- all_data[! campaign_id %in% c(667052, 617331)]
1479967429676:}
1479967433186:all_data[period == 'past', .N, by = contact_id][, quantile(N, seq(0, 1, 0.1))]
1479967437754:contacts_to_restrict <- all_data[period == 'past', .N, by = .(segment, contact_id)][N >= 70, .(segment, contact_id)]
1479967441343:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479967467929:all_data %>%
1479967467934:.[segment == 'control' & period == 'sto'] %>%
1479967467943:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1479967467950:ggplot(aes(x = send_day, y = min_send_hour)) +
1479967467972:geom_point()
1479967478013:all_data %>%
1479967478017:.[, .N, by = .(send_day, segment)] %>%
1479967478021:ggplot(aes(x = send_day, y = N, col = segment)) +
1479967478022:geom_point() + geom_line() +
1479967478023:addSTOline(text_position = 0) +
1479967478023:expand_limits(y = 0)
1479967489259:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479967550671:campaign_summary <- calculateSummary(all_data)
1479967554257:plotOpenRateEvolutionWithPast(campaign_summary)
1479967617768:campaign_summary %>%
1479967617769:ggplot(aes(send_day, open_rate, color = segment)) +
1479967617770:geom_line() +
1479967617771:addSTOline()
1479967618191:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479967641115:campaign_summary %>%
1479967641116:ggplot(aes(send_day, open_rate, color = segment)) +
1479967641117:geom_line() +
1479967641118:addSTOline(y_position = 0.18)
1479967656390:campaign_summary %>%
1479967656391:ggplot(aes(send_day, open_rate, color = segment)) +
1479967656392:geom_line() +
1479967656392:addSTOline(text_position = 0.18)
1479967669821:campaign_summary %>%
1479967669822:ggplot(aes(send_day, open_rate, color = segment)) +
1479967669822:geom_line() +
1479967669823:addSTOline(text_position = 0.18) +
1479967669824:geom_smooth()
1479967720202:?geom_smooth
1479967728117:campaign_summary %>%
1479967728118:ggplot(aes(send_day, open_rate, color = segment)) +
1479967728118:geom_line() +
1479967728119:addSTOline(text_position = 0.18) +
1479967728120:geom_smooth(span = 0.5)
1479967742147:campaign_summary %>%
1479967742148:ggplot(aes(send_day, open_rate, color = segment)) +
1479967742148:geom_line() +
1479967742149:addSTOline(text_position = 0.18) +
1479967742149:geom_smooth(span = 0.3)
1479967812202:campaign_summary %>%
1479967812204:ggplot(aes(send_day, open_rate, color = segment)) +
1479967812204:geom_line() +
1479967812205:addSTOline(text_position = 0.18) +
1479967812205:geom_smooth(span = 0.3) +
1479967812206:labs(x = 'Day', y = 'Open rate') +
1479967812208:theme(legend.position = 'bottom')
1479967829093:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1479967879446:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) + labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = 'Send hour')
1479967895376:?scale_fill_discrete
1479967952828:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) + labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour'))
1479967985283:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) +
1479967985286:labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour')) + theme(legend.position = 'bottom')
1479968001604:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) +
1479968001610:labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour'), nrow = 1) + theme(legend.position = 'bottom')
1479968015813:?legend
1479968032617:?theme
1479968074808:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) +
1479968074809:labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour', nrow = 1)) + theme(legend.position = 'bottom')
1479968126344:all_data
1479968146234:all_data[, mean(opened), by = contact_id][, mean(V2)]
1479968149504:all_data[, mean(opened), by = contact_id]
1479968154616:all_data[, mean(opened), by = contact_id][, mean(V1)]
1479968167306:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T)
1479968193289:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T) +
1479968193290:labs(x = 'Send day', y = 'Relative open rate')
1479968230471:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = T, color = 'weekday') +
1479968230483:labs(x = 'Send day', y = 'Relative open rate')
1479968252980:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479968252983:labs(x = 'Send day', y = 'Relative open rate') +
1479968252984:theme(legend.position = 'bottom')
1479968279315:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479968279317:labs(x = 'Send day', y = 'Relative open rate') +
1479968279318:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1479968279318:theme(legend.position = 'bottom')
1479968353387:plotRelativeOpenRateEvolution <- function(relative_data, color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, text_position = 0.8, offset = 2) {
1479968353404:p <- relative_data[send_day < Sys.Date() - offset] %>%
1479968353415:ggplot(aes(x = send_day, y = relative_open_rate)) +
1479968353417:geom_hline(yintercept = 1, linetype = 'dashed')
1479968353421:if (is.null(color)) {
1479968353422:p <- p +
1479968353433:geom_line() +
1479968353436:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1479968353439:} else {
1479968353440:p <- p +
1479968353444:geom_point(aes_string(color = color)) +
1479968353456:geom_line(aes_string(color = color))
1479968353459:}
1479968353460:if (trendlines) {
1479968353461:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1479968353461:}
1479968353463:if (!is.null(facet)) {
1479968353465:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1479968353467:}
1479968353468:p + addSTOline(TRUE, text, prior_change_dates, text_position)
1479968353472:}
1479968356525:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday', text_position = 0.9) +
1479968356525:labs(x = 'Send day', y = 'Relative open rate') +
1479968356526:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1479968356526:theme(legend.position = 'bottom')
1479968387400:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479968435896:aggregateSummaryToWeeks(campaign_summary)
1479968441581:aggregateSummaryToWeeks(campaign_summary) %>% .[]
1479968507597:aggregateSummaryToWeeks(campaign_summary) %>%
1479968507599:ggplot(data = weekly_aggregates, aes(x = week_of_year, y = relative_open_rate)) +
1479968507600:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968507601:geom_line() +
1479968507602:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968507602:geom_vline(
1479968507603:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968507603:linetype = 'dashed'
1479968507604:) +
1479968507604:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05))
1479968517488:aggregateSummaryToWeeks(campaign_summary) %>%
1479968517488:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968517489:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968517490:geom_line() +
1479968517491:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968517493:geom_vline(
1479968517496:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968517496:linetype = 'dashed'
1479968517497:) +
1479968517497:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05))
1479968539713:aggregateSummaryToWeeks(campaign_summary) %>%
1479968539715:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968539716:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968539716:geom_line() +
1479968539717:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968539724:geom_vline(
1479968539725:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968539725:linetype = 'dashed'
1479968539726:) +
1479968539728:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1479968539728:labs(x = 'Send week', y = 'Relative open rate')
1479968575838:aggregateSummaryToWeeks(campaign_summary) %>%
1479968575840:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968575842:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968575842:geom_line() +
1479968575846:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968575847:geom_vline(
1479968575847:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968575848:linetype = 'dashed'
1479968575848:) +
1479968575849:scale_y_continuous(breaks = seq(0.9, 1.15, 0.05)) +
1479968575849:labs(x = 'Send week', y = 'Relative open rate')
1479968591483:aggregateSummaryToWeeks(campaign_summary) %>%
1479968591485:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968591485:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968591485:geom_line() +
1479968591486:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968591486:geom_vline(
1479968591487:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968591488:linetype = 'dashed'
1479968591488:) +
1479968591488:scale_y_continuous(breaks = seq(0.85, 1.15, 0.05)) +
1479968591489:labs(x = 'Send week', y = 'Relative open rate')
1479968610407:aggregateSummaryToWeeks(campaign_summary) %>%
1479968610408:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968610408:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968610409:geom_line() +
1479968610409:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968610411:geom_vline(
1479968610411:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968610412:linetype = 'dashed'
1479968610413:) +
1479968610415:scale_y_continuous(breaks = seq(0.85, 1.15, 0.05), limits = c(0.85, 1.15)) +
1479968610416:labs(x = 'Send week', y = 'Relative open rate')
1479968624404:aggregateSummaryToWeeks(campaign_summary) %>%
1479968624407:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968624407:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968624408:geom_line() +
1479968624409:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968624410:geom_vline(
1479968624410:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968624411:linetype = 'dashed'
1479968624411:) +
1479968624413:scale_y_continuous(limits = c(0.9, 1.15)) +
1479968624414:labs(x = 'Send week', y = 'Relative open rate')
1479968632714:aggregateSummaryToWeeks(campaign_summary) %>%
1479968632714:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968632715:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968632715:geom_line() +
1479968632716:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968632716:geom_vline(
1479968632716:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968632717:linetype = 'dashed'
1479968632717:) +
1479968632718:scale_y_continuous(limits = c(0.95, 1.15)) +
1479968632719:labs(x = 'Send week', y = 'Relative open rate')
1479968679798:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479968723562:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479968753099:active_data <- restrictDataToContacts(all_data, active_contacts)
1479968766234:active_summary <- active_data %>% calculateSummary()
1479968768378:aggregateSummaryToWeeks(active_summary) %>%
1479968768380:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968768383:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968768384:geom_line() +
1479968768384:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968768386:geom_vline(
1479968768387:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968768387:linetype = 'dashed'
1479968768393:) +
1479968768394:scale_y_continuous(limits = c(0.95, 1.15)) +
1479968768394:labs(x = 'Send week', y = 'Relative open rate')
1479968790095:aggregateSummaryToWeeks(campaign_summary) %>%
1479968790097:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968790097:geom_hline(yintercept = 1, linetype = 'dashed') +
1479968790098:geom_line() +
1479968790098:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968790099:geom_vline(
1479968790099:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968790100:linetype = 'dashed'
1479968790101:) +
1479968790104:scale_y_continuous(limits = c(0.95, 1.15)) +
1479968790104:labs(x = 'Send week', y = 'Relative open rate')
1479968866807:campaign_summary
1479968921261:aggregateSummaryToWeeks <- function(summary) {
1479968921266:summary %>%
1479968921266:.[, week_of_year := week(send_day)] %>%
1479968921267:.[
1479968921268:, .(num_campaign = .N, avg_open_rate = mean(open_rate)),
1479968921269:by = .(segment, week_of_year)
1479968921270:] %>%
1479968921270:dcast(week_of_year + num_campaign ~ segment, value.var = 'avg_open_rate') %>%
1479968921270:.[, `:=`(relative_open_rate = sto / control, open_rate_diff = sto - control)]
1479968921272:}
1479968944913:aggregateSummaryToWeeks(campaign_summary) %>%
1479968944914:ggplot(aes(x = week_of_year, y = relative_open_rate)) +
1479968944914:geom_hline(yintercept = 0, linetype = 'dashed') +
1479968944915:geom_line() +
1479968944915:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968944916:geom_vline(
1479968944917:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968944918:linetype = 'dashed'
1479968944919:) +
1479968944920:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479968944922:labs(x = 'Send week', y = 'Relative open rate')
1479968956453:aggregateSummaryToWeeks(campaign_summary) %>%
1479968956453:ggplot(aes(x = week_of_year, y = open_rate_diff)) +
1479968956454:geom_hline(yintercept = 0, linetype = 'dashed') +
1479968956455:geom_line() +
1479968956455:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968956457:geom_vline(
1479968956459:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968956461:linetype = 'dashed'
1479968956462:) +
1479968956462:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479968956465:labs(x = 'Send week', y = 'Relative open rate')
1479968982052:aggregateSummaryToWeeks(campaign_summary) %>%
1479968982054:ggplot(aes(x = week_of_year, y = open_rate_diff)) +
1479968982055:geom_hline(yintercept = 0, linetype = 'dashed') +
1479968982059:geom_line() +
1479968982060:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968982060:geom_vline(
1479968982060:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968982061:linetype = 'dashed'
1479968982061:) +
1479968982061:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479968982062:labs(x = 'Send week', y = 'Difference in open rates')
1479968998830:aggregateSummaryToWeeks(active_summary) %>%
1479968998831:ggplot(aes(x = week_of_year, y = open_rate_diff)) +
1479968998832:geom_hline(yintercept = 0, linetype = 'dashed') +
1479968998832:geom_line() +
1479968998832:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479968998833:geom_vline(
1479968998833:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479968998833:linetype = 'dashed'
1479968998834:) +
1479968998834:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479968998835:labs(x = 'Send week', y = 'Difference in open rates')
1479970443450:contact_past_open_rates
1479970449496:all_data
1479970641751:campaign_summary_active <- merge(all_data, contact_past_open_rates, by = 'contact_id') %>%
1479970642602:.[, active := ifelse(n*open_rate >= SETTINGS[[customer]]$active_cutoff, 'active', 'inactive')]
1479970662154:campaign_summary_active
1479970663366:campaign_summary_active
1479970678972:all_data_active <- merge(all_data, contact_past_open_rates, by = 'contact_id') %>%
1479970679381:.[, active := ifelse(n*open_rate >= SETTINGS[[customer]]$active_cutoff, 'active', 'inactive')] %>%
1479970679571:.[]
1479970725186:campaign_summary_active <- calculateSummary(all_data_active, by = c('period', 'send_day', 'segment', 'active'))
1479970747996:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1479970748555:.[, active := ifelse(n*open_rate >= SETTINGS[[customer]]$active_cutoff, 'active', 'inactive')] %>%
1479970748960:.[]
1479970766192:campaign_summary_active <- calculateSummary(all_data_active, by = c('period', 'send_day', 'segment', 'active'))
1479970775512:campaign_summary_active
1479970776584:campaign_summary_active
1479970868021:generateRelativeData(campaign_summary_active) %>%
1479970868022:ggplot(aes(x = send_day, y = diff_open_rate)) +
1479970868025:geom_hline(yintercept = 0, linetype = 'dashed') +
1479970868026:geom_line() +
1479970868027:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479970868027:addSTOline(text_position = -0.02) +
1479970868029:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479970868030:labs(x = 'Send week', y = 'Difference in open rates')
1479970879399:generateRelativeData <- function(summary, weekdays_to_keep = NULL, measure = 'open_rate') {
1479970879404:summary %>%
1479970879405:dcast(send_day + weekday + weekend + period ~ segment, value.var = measure) %>%
1479970879406:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
1479970879407:.[, `:=`(relative_open_rate = sto / control, diff_open_rate = sto - control)] %>%
1479970879409:.[!is.na(sto)]
1479970879410:}
1479970978728:generateRelativeData(campaign_summary_active)
1479971019645:campaign_summary_active
1479971027847:generateRelativeData <- function(summary, weekdays_to_keep = NULL, measure = 'open_rate') {
1479971027849:summary %>%
1479971027849:dcast(send_day + weekday + weekend + period + active ~ segment, value.var = measure) %>%
1479971027850:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
1479971027850:.[, `:=`(relative_open_rate = sto / control, diff_open_rate = sto - control)] %>%
1479971027851:.[!is.na(sto)]
1479971027851:}
1479971031622:generateRelativeData(campaign_summary_active)
1479971082466:base_by = c('send_day', 'period', 'weekday', 'weekend')
1479971085295:additional_by = NULL
1479971090092:c(base_by, additional_by)
1479971114566:dcast_formula <- paste(c(base_by, additional_by), collapse = '+')
1479971163417:generateRelativeData <- function(summary, weekdays_to_keep = NULL, measure = 'open_rate', base_by = c('send_day', 'period', 'weekday', 'weekend'), additional_by = NULL) {
1479971163418:dcast_formula <- paste(paste(c(base_by, additional_by), collapse = '+'), segment, sep = '~')
1479971163418:summary %>%
1479971163419:dcast(as.formula(dcast_formula), value.var = measure) %>%
1479971163420:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
1479971163422:.[, `:=`(relative_measure = sto / control, diff_measure = sto - control)] %>%
1479971163427:.[!is.na(sto)]
1479971163427:}
1479971251523:source('global.R')
1479971265429:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('active'))
1479971284811:campaign_summary_active
1479971286005:campaign_summary_active
1479971292244:generateRelativeData(campaign_summary_active, additional_by = 'active')
1479971322996:campaign_summary_active
1479971343012:generateRelativeData <- function(summary, weekdays_to_keep = NULL, measure = 'open_rate', base_by = c('send_day', 'period', 'weekday', 'weekend'), additional_by = NULL) {
1479971343014:dcast_formula <- paste(paste(c(base_by, additional_by), collapse = '+'), 'segment', sep = '~')
1479971343015:summary %>%
1479971343016:dcast(as.formula(dcast_formula), value.var = measure) %>%
1479971343017:`if`(is.null(weekdays_to_keep), . , .[weekday %in% weekdays_to_keep]) %>%
1479971343018:.[, `:=`(relative_measure = sto / control, diff_measure = sto - control)] %>%
1479971343020:.[!is.na(sto)]
1479971343021:}
1479971347811:generateRelativeData(campaign_summary_active, additional_by = 'active')
1479971378695:generateRelativeData(campaign_summary_active, additional_by = 'active') %>%
1479971378697:ggplot(aes(x = send_day, y = diff_measure)) +
1479971378698:geom_hline(yintercept = 0, linetype = 'dashed') +
1479971378699:geom_line() +
1479971378699:geom_point(aes(fill = active), colour = 'white', size = 3, pch = 21) +
1479971378700:addSTOline(text_position = -0.02) +
1479971378700:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479971378700:labs(x = 'Send week', y = 'Difference in open rates')
1479971467178:summary
1479971473562:campaign_summary
1479973428516:aggregateSummaryToWeeks(campaign_summary_active)
1479973434881:aggregateSummaryToWeeks(campaign_summary_active) %>%
1479973434882:.[]
1479973712118:campaign_summary
1479973728863:campaign_summary[, week_of_year := week(send_day)][]
1479973748496:campaign_summary[, week_of_year := week(send_day)][, lapply(.SD, mean), .SDcols = c('open_rate', 'sd')]
1479973758657:campaign_summary[, week_of_year := week(send_day)][, list(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd')]
1479973858770:campaign_summary[, week_of_year := week(send_day)][, list(lapply(.SD, mean), n = .N), .SDcols = c('open_rate', 'sd')]
1479973938889:campaign_summary[, week_of_year := week(send_day)][, c(lapply(.SD, mean), n = .N), .SDcols = c('open_rate', 'sd')]
1479974131511:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure_cols = 'open_rate') {
1479974131513:summary %>%
1479974131514:.[, week_of_year := week(send_day)] %>%
1479974131515:.[
1479974131516:, c(num_campaign = .N, lapply(.SD, mean)),
1479974131517:by = c(c('segment', 'week_of_year'), additional_by),
1479974131518:.SDcols = measure_cols
1479974131519:] %>%
1479974131520:dcast(week_of_year + num_campaign ~ segment, value.var = measure_cols) %>%
1479974131520:.[, `:=`(relative_open_rate = sto / control, diff_open_rate = sto - control)]
1479974131521:}
1479974142712:debug(aggregateSummaryToWeeks)
1479974153271:aggregateSummaryToWeeks(campaign_summary_active)
1479974301206:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(num_campaign = .N, lapply(.SD, mean)), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974308574:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(.N, lapply(.SD, mean)), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974323985:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), num_campaign = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974365586:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974381136:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974402934:campaign_summary[, week_of_year := week(send_day)][, list(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd')]
1479974410228:campaign_summary[, week_of_year := week(send_day)][, c(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd')]
1479974415811:campaign_summary[, week_of_year := week(send_day)] %>% .[, c(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd')]
1479974445052:campaign_summary[, week_of_year := week(send_day)][, c(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd')]
1479974449399:campaign_summary[, week_of_year := week(send_day)][, c(n = .N, lapply(.SD, mean)), .SDcols = c('open_rate', 'sd'), by = 'period']
1479974477978:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate']
1479974489205:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N ~ segment)
1479974495415:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N ~ segment, value.var = 'open_rate')
1479974516378:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N ~ segment, value.var = 'open_rate')
1479974573835:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N ~ segment + active, value.var = 'open_rate')
1479974582772:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year', 'active'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N ~ segment + active, value.var = 'open_rate')
1479974599117:campaign_summary_active %>% .[, week_of_year := week(send_day)] %>% .[, c(lapply(.SD, mean), n = .N), by = c('segment', 'week_of_year', 'active'), .SDcols = 'open_rate'] %>% dcast(week_of_year + N + active ~ segment, value.var = 'open_rate')
1479974659052:paste('week_of_year + N', additional_by, collapse = '+')
1479974699711:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure_var = 'open_rate') {
1479974699712:summary %>%
1479974699714:.[, week_of_year := week(send_day)] %>%
1479974699722:.[
1479974699724:, c(.N, lapply(.SD, mean)),
1479974699726:by = c(c('segment', 'week_of_year'), additional_by),
1479974699728:.SDcols = measure_var
1479974699728:] %>%
1479974699730:dcast(
1479974699730:as.formula(paste(paste('week_of_year + N', additional_by, collapse = '+'), 'segment', sep = '~'),
1479974699732:value.var = measure_var
1479974699733:) %>%
1479974699735:.[, `:=`(relative = sto / control, diff = sto - control)]
1479974699736:}
1479974714543:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure_var = 'open_rate') {
1479974714546:summary %>%
1479974714548:.[, week_of_year := week(send_day)] %>%
1479974714549:.[
1479974714550:, c(.N, lapply(.SD, mean)),
1479974714552:by = c(c('segment', 'week_of_year'), additional_by),
1479974714552:.SDcols = measure_var
1479974714554:] %>%
1479974714554:dcast(
1479974714555:as.formula(paste(paste('week_of_year + N', additional_by, collapse = '+'), 'segment', sep = '~')),
1479974714556:value.var = measure_var
1479974714557:) %>%
1479974714557:.[, `:=`(relative = sto / control, diff = sto - control)]
1479974714558:}
1479974751819:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974751820:.[]
1479974786682:additional_by <- 'active'
1479974792350:paste(paste('week_of_year + N', additional_by, collapse = '+'), 'segment', sep = '~')
1479974808399:paste(paste(c('week_of_year + N', additional_by), collapse = '+'), 'segment', sep = '~')
1479974814312:additional_by <- NULL
1479974824281:paste(paste(c('week_of_year + N', additional_by), collapse = '+'), 'segment', sep = '~')
1479974833430:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure_var = 'open_rate') {
1479974833431:summary %>%
1479974833432:.[, week_of_year := week(send_day)] %>%
1479974833432:.[
1479974833433:, c(.N, lapply(.SD, mean)),
1479974833433:by = c(c('segment', 'week_of_year'), additional_by),
1479974833435:.SDcols = measure_var
1479974833436:] %>%
1479974833437:dcast(
1479974833438:as.formula(paste(paste(c('week_of_year + N', additional_by), collapse = '+'), 'segment', sep = '~')),
1479974833440:value.var = measure_var
1479974833441:) %>%
1479974833442:.[, `:=`(relative = sto / control, diff = sto - control)]
1479974833443:}
1479974838253:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974838253:.[]
1479974856683:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974856685:.[]
1479974856716:ggplot(aes(x = week_of_year, y = diff)) +
1479974856717:geom_hline(yintercept = 0, linetype = 'dashed') +
1479974856717:geom_line() +
1479974856719:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479974856721:geom_vline(
1479974856722:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479974856724:linetype = 'dashed'
1479974856726:) +
1479974856726:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479974856728:labs(x = 'Send week', y = 'Difference in open rates')
1479974866124:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974866127:.[] %>%
1479974866129:ggplot(aes(x = week_of_year, y = diff)) +
1479974866130:geom_hline(yintercept = 0, linetype = 'dashed') +
1479974866131:geom_line() +
1479974866132:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479974866133:geom_vline(
1479974866134:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479974866136:linetype = 'dashed'
1479974866139:) +
1479974866141:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479974866142:labs(x = 'Send week', y = 'Difference in open rates')
1479974884230:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974884231:.[] %>%
1479974884232:ggplot(aes(x = week_of_year, y = diff, color = active)) +
1479974884232:geom_hline(yintercept = 0, linetype = 'dashed') +
1479974884233:geom_line() +
1479974884234:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21) +
1479974884234:geom_vline(
1479974884235:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479974884235:linetype = 'dashed'
1479974884235:) +
1479974884236:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479974884237:labs(x = 'Send week', y = 'Difference in open rates')
1479974904555:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974904556:.[] %>%
1479974904558:ggplot(aes(x = week_of_year, y = diff, fill = active)) +
1479974904560:geom_hline(yintercept = 0, linetype = 'dashed') +
1479974904561:geom_line() +
1479974904563:geom_point(colour = 'white', size = 3, pch = 21) +
1479974904564:geom_vline(
1479974904564:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479974904564:linetype = 'dashed'
1479974904565:) +
1479974904565:#scale_y_continuous(limits = c(0.95, 1.15)) +
1479974904566:labs(x = 'Send week', y = 'Difference in open rates')
1479974924556:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479974924561:.[] %>%
1479974924564:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479974924569:geom_hline(yintercept = 0, linetype = 'dashed') +
1479974924570:geom_line() +
1479974924573:geom_point(colour = 'white', size = 3, pch = 21) +
1479974924576:geom_vline(
1479974924577:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479974924579:linetype = 'dashed'
1479974924580:) +
1479974924581:labs(x = 'Send week', y = 'Difference in open rates')
1479975035338:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479975035340:.[] %>%
1479975035340:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479975035341:geom_hline(yintercept = 0, linetype = 'dashed') +
1479975035342:geom_line() +
1479975035343:geom_point(colour = 'white', size = 3, pch = 21) +
1479975035344:geom_vline(
1479975035345:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479975035346:linetype = 'dashed'
1479975035350:) +
1479975035355:labs(x = 'Send week', y = 'Difference in open rates') +
1479975035355:scale_color_discrete(guide = guide_legend(nrow = 1))
1479975053684:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479975053685:.[] %>%
1479975053687:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479975053688:geom_hline(yintercept = 0, linetype = 'dashed') +
1479975053689:geom_line() +
1479975053691:geom_point(colour = 'white', size = 3, pch = 21) +
1479975053693:geom_vline(
1479975053695:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479975053697:linetype = 'dashed'
1479975053698:) +
1479975053699:labs(x = 'Send week', y = 'Difference in open rates') +
1479975053700:theme(legend.position = 'bottom') +
1479975053701:scale_color_discrete(guide = guide_legend(nrow = 1))
1479975083016:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1479975128936:calculateMedianDistance(all_data) %>%
1479975128938:generateRelativeData(measure = 'median_hours_to_open') %>%
1479975128939:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479975128939:ylab('relative median send-open distance in hours')
1479975140253:calculateMedianDistance(all_data) %>%
1479975140254:generateRelativeData(measure = 'median_hours_to_open')
1479975179080:plotRelativeOpenRateEvolution <- function(relative_data, color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, text_position = 0.8, offset = 2) {
1479975179081:p <- relative_data[send_day < Sys.Date() - offset] %>%
1479975179082:ggplot(aes(x = send_day, y = relative_measure)) +
1479975179083:geom_hline(yintercept = 1, linetype = 'dashed')
1479975179084:if (is.null(color)) {
1479975179085:p <- p +
1479975179086:geom_line() +
1479975179087:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1479975179088:} else {
1479975179089:p <- p +
1479975179091:geom_point(aes_string(color = color)) +
1479975179092:geom_line(aes_string(color = color))
1479975179093:}
1479975179095:if (trendlines) {
1479975179096:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1479975179096:}
1479975179097:if (!is.null(facet)) {
1479975179098:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1479975179099:}
1479975179100:p + addSTOline(TRUE, text, prior_change_dates, text_position) +
1479975179101:labs(x = 'Send day', y = 'Relative open rate')
1479975179103:}
1479975191202:calculateMedianDistance(all_data) %>%
1479975191204:generateRelativeData(measure = 'median_hours_to_open') %>%
1479975191204:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479975255769:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, text = TRUE, text_position = 0.8, offset = 2) {
1479975255771:p <- relative_data[send_day < Sys.Date() - offset] %>%
1479975255772:ggplot(aes(x = send_day, y = relative_measure)) +
1479975255774:geom_hline(yintercept = 1, linetype = 'dashed')
1479975255775:if (is.null(color)) {
1479975255775:p <- p +
1479975255776:geom_line() +
1479975255777:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1479975255778:} else {
1479975255778:p <- p +
1479975255780:geom_point(aes_string(color = color)) +
1479975255781:geom_line(aes_string(color = color))
1479975255782:}
1479975255783:if (trendlines) {
1479975255784:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1479975255784:}
1479975255785:if (!is.null(facet)) {
1479975255786:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1479975255788:}
1479975255790:p + addSTOline(TRUE, text, prior_change_dates, text_position) +
1479975255791:labs(x = 'Send day', y = paste('Relative', variable))
1479975255792:}
1479975261895:calculateMedianDistance(all_data) %>%
1479975261896:generateRelativeData(measure = 'median_hours_to_open') %>%
1479975261896:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday') +
1479975261897:ylab('relative median send-open distance in hours')
1479975289629:calculateMedianDistance(all_data) %>%
1479975289630:generateRelativeData(measure = 'median_hours_to_open') %>%
1479975289631:plotRelativeOpenRateEvolution(trendlines = F, variable = 'median send-open distance (hours)', color = 'weekday')
1479975303917:calculateMedianDistance(all_data) %>%
1479975303918:generateRelativeData(measure = 'median_hours_to_open') %>%
1479975303919:plotRelativeEvolution(trendlines = F, variable = 'median send-open distance (hours)', color = 'weekday')
1479976643736:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479976643738:plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday')
1479976655353:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479976655354:plotRelativeEvolution(trendlines = F, color = 'weekday')
1479977052695:calculateSummary(all_data)
1479977060930:campaign_summary
1479977402665:calculateMedianDistance(all_data)
1479977410106:calculateMedianDistance(all_data) %>% .[]
1479977427066:calculateMedianDistance(all_data) %>% .[median_hours_to_open < 4.2]
1479977440298:calculateMedianDistance(all_data) %>% .[segment == 'control' & median_hours_to_open < 4.2]
1479977443807:calculateMedianDistance(all_data) %>% .[segment == 'control' & median_hours_to_open < 4.5]
1479977448971:calculateMedianDistance(all_data) %>% .[segment == 'control' & median_hours_to_open < 4.3]
1479977471307:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1479977504588:x <- 2
1479977504589:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1479977504590:plotRelativeEvolution(trendlines = F, color = 'weekday')
1479977539188:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1479977539189:plotSendingVariability()
1479977581074:sending_variability
1479977652247:calculateVariabilityOfLastSends <- function(contact_data, scope = 5) {
1479977652248:contact_data[
1479977652249:,
1479977652249:.(
1479977652250:send_day,
1479977652250:activity,
1479977652251:variability = partialUniqueN(send_hour, scope),
1479977652252:num_send = .N,
1479977652252:num_open = sum(opened)
1479977652253:),
1479977652254:by = contact_id
1479977652256:]
1479977652257:}
1479977653191:aggregateVariability <- function(variability_dt, by_active_status = FALSE) {
1479977653192:if (by_active_status) {
1479977653194:by <- c('send_day', 'activity')
1479977653195:} else {
1479977653196:by <- c('send_day')
1479977653197:}
1479977653197:variability_dt[num_send == max(num_send), .(variability = mean(variability)), keyby = by]
1479977653198:}
1479977677928:sending_variability <- calculateVariabilityOfLastSends(all_data_active[period == 'sto' & segment == 'sto'], scope = 5)
1479977684750:all_data_active
1479977738216:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1479977738217:.[, activity := ifelse(n*open_rate >= SETTINGS[[customer]]$active_cutoff, 'active', 'inactive')] %>%
1479977738218:.[]
1479977759390:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('active'))
1479977768466:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1479977776416:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479977776417:.[] %>%
1479977776417:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479977776418:geom_hline(yintercept = 0, linetype = 'dashed') +
1479977776418:geom_line() +
1479977776419:geom_point(colour = 'white', size = 3, pch = 21) +
1479977776419:geom_vline(
1479977776420:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479977776420:linetype = 'dashed'
1479977776420:) +
1479977776421:labs(x = 'Send week', y = 'Difference in open rates') +
1479977776421:theme(legend.position = 'bottom') +
1479977776422:scale_color_discrete(guide = guide_legend(nrow = 1))
1479977782255:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479977782760:.[] %>%
1479977783053:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = active)) +
1479977783270:geom_hline(yintercept = 0, linetype = 'dashed') +
1479977783446:geom_line() +
1479977783620:geom_point(colour = 'white', size = 3, pch = 21) +
1479977783787:geom_vline(
1479977783932:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479977784091:linetype = 'dashed'
1479977784240:) +
1479977784396:labs(x = 'Send week', y = 'Difference in open rates') +
1479977784570:theme(legend.position = 'bottom') +
1479977784903:scale_color_discrete(guide = guide_legend(nrow = 1))
1479977806334:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479977806335:.[] %>%
1479977806335:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479977806336:geom_hline(yintercept = 0, linetype = 'dashed') +
1479977806336:geom_line() +
1479977806337:geom_point(colour = 'white', size = 3, pch = 21) +
1479977806338:geom_vline(
1479977806338:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479977806339:linetype = 'dashed'
1479977806339:) +
1479977806340:labs(x = 'Send week', y = 'Difference in open rates') +
1479977806340:theme(legend.position = 'bottom') +
1479977806341:scale_color_discrete(guide = guide_legend(nrow = 1))
1479979930628:source('global.R')
1479979931872:customer <- 'travelist_market'
1479979945237:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479979948687:source('global.R')
1479979991118:install.packages("ggplot2")
1479980008494:source('global.R')
1479980015916:customer <- 'travelist_market'
1479980029242:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1479980063772:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1479980081276:contacts_to_restrict <- unique_contacts
1479980092054:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1479980369696:if (customer == 'travelist_market') {
1479980369697:all_data <- all_data[campaign_id != 701805]
1479980369702:}
1479980386621:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479980391042:campaign_summary <- calculateSummary(all_data)
1479980401488:campaign_summary %>%
1479980401490:ggplot(aes(send_day, open_rate, color = segment)) +
1479980401492:geom_line() +
1479980401493:addSTOline(text_position = 0.18) +
1479980401494:geom_smooth(span = 0.3) +
1479980401495:labs(x = 'Day', y = 'Open rate') +
1479980401495:theme(legend.position = 'bottom')
1479980418988:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479980447194:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure_var = 'open_rate') {
1479980447194:summary %>%
1479980447195:.[, week_of_year := week(send_day)] %>%
1479980447196:.[
1479980447198:, c(.N, lapply(.SD, mean)),
1479980447199:by = c(c('segment', 'week_of_year'), additional_by),
1479980447202:.SDcols = measure_var
1479980447203:] %>%
1479980447204:dcast(
1479980447205:as.formula(paste(paste(c('week_of_year + N', additional_by), collapse = '+'), 'segment', sep = '~')),
1479980447206:value.var = measure_var
1479980447208:) %>%
1479980447208:.[, `:=`(relative = sto / control, diff = sto - control)]
1479980447209:}
1479980450959:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1479980460243:aggregateSummaryToWeeks(campaign_summary)
1479980465099:aggregateSummaryToWeeks(campaign_summary) %>% .[]
1479980542887:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479980542889:.[] %>%
1479980542890:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479980542890:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980542890:geom_line() +
1479980542891:geom_point(colour = 'white', size = 3, pch = 21) +
1479980542891:geom_vline(
1479980542891:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980542892:linetype = 'dashed'
1479980542893:) +
1479980542894:labs(x = 'Send week', y = 'Difference in open rates') +
1479980542895:theme(legend.position = 'bottom') +
1479980542895:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980549076:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1479980552139:active_contacts <- contact_past_open_rates[n*open_rate >= SETTINGS[[customer]]$active_cutoff]
1479980553703:active_data <- restrictDataToContacts(all_data, active_contacts)
1479980557165:active_summary <- active_data %>% calculateSummary()
1479980562114:active_summary
1479980563538:active_summary
1479980610880:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1479980610881:.[, activity := ifelse(n*open_rate >= SETTINGS[[customer]]$active_cutoff, 'active', 'inactive')] %>%
1479980610883:.[]
1479980624452:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('active'))
1479980642301:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1479980655341:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479980655343:.[] %>%
1479980655343:ggplot(aes(x = week_of_year, y = diff, fill = active, color = active)) +
1479980655344:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980655344:geom_line() +
1479980655344:geom_point(colour = 'white', size = 3, pch = 21) +
1479980655345:geom_vline(
1479980655345:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980655345:linetype = 'dashed'
1479980655346:) +
1479980655347:labs(x = 'Send week', y = 'Difference in open rates') +
1479980655349:theme(legend.position = 'bottom') +
1479980655350:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980662848:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'active') %>%
1479980662849:.[] %>%
1479980662849:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = active)) +
1479980662850:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980662850:geom_line() +
1479980662851:geom_point(colour = 'white', size = 3, pch = 21) +
1479980662851:geom_vline(
1479980662852:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980662852:linetype = 'dashed'
1479980662853:) +
1479980662853:labs(x = 'Send week', y = 'Difference in open rates') +
1479980662853:theme(legend.position = 'bottom') +
1479980662854:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980673115:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980673116:.[] %>%
1479980673117:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = active)) +
1479980673117:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980673118:geom_line() +
1479980673118:geom_point(colour = 'white', size = 3, pch = 21) +
1479980673119:geom_vline(
1479980673119:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980673120:linetype = 'dashed'
1479980673120:) +
1479980673121:labs(x = 'Send week', y = 'Difference in open rates') +
1479980673121:theme(legend.position = 'bottom') +
1479980673122:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980687572:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980687572:.[] %>%
1479980687573:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479980687573:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980687574:geom_line() +
1479980687574:geom_point(colour = 'white', size = 3, pch = 21) +
1479980687574:geom_vline(
1479980687575:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980687575:linetype = 'dashed'
1479980687575:) +
1479980687576:labs(x = 'Send week', y = 'Difference in open rates') +
1479980687576:theme(legend.position = 'bottom') +
1479980687576:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980714304:campaign_summary_active
1479980726481:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980726481:.[]
1479980738402:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980738403:.[N >= 5] %>%
1479980738404:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479980738404:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980738404:geom_line() +
1479980738405:geom_point(colour = 'white', size = 3, pch = 21) +
1479980738405:geom_vline(
1479980738405:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980738406:linetype = 'dashed'
1479980738406:) +
1479980738406:labs(x = 'Send week', y = 'Difference in open rates') +
1479980738407:theme(legend.position = 'bottom') +
1479980738407:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980755101:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980755103:.[N >= 6] %>%
1479980755103:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479980755104:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980755104:geom_line() +
1479980755104:geom_point(colour = 'white', size = 3, pch = 21) +
1479980755105:geom_vline(
1479980755105:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980755105:linetype = 'dashed'
1479980755106:) +
1479980755106:labs(x = 'Send week', y = 'Difference in open rates') +
1479980755106:theme(legend.position = 'bottom') +
1479980755107:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980762445:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980762447:.[N >= 4] %>%
1479980762448:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479980762448:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980762448:geom_line() +
1479980762449:geom_point(colour = 'white', size = 3, pch = 21) +
1479980762449:geom_vline(
1479980762449:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980762450:linetype = 'dashed'
1479980762450:) +
1479980762451:labs(x = 'Send week', y = 'Difference in open rates') +
1479980762451:theme(legend.position = 'bottom') +
1479980762451:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980775779:week(Sys.Date())
1479980840283:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980840284:.[N >= 4] %>%
1479980840285:ggplot(aes(x = week_of_year, y = rate, fill = activity, color = activity)) +
1479980840285:geom_hline(yintercept = 0, linetype = 'dashed') +
1479980840286:geom_line() +
1479980840286:geom_point(colour = 'white', size = 3, pch = 21) +
1479980840286:geom_vline(
1479980840287:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980840287:linetype = 'dashed'
1479980840287:) +
1479980840288:labs(x = 'Send week', y = 'Difference in open rates') +
1479980840288:theme(legend.position = 'bottom') +
1479980840289:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980858926:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980858927:.[N >= 4] %>%
1479980858927:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1479980858927:geom_hline(yintercept = 1, linetype = 'dashed') +
1479980858928:geom_line() +
1479980858928:geom_point(colour = 'white', size = 3, pch = 21) +
1479980858929:geom_vline(
1479980858929:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980858929:linetype = 'dashed'
1479980858930:) +
1479980858930:labs(x = 'Send week', y = 'Difference in open rates') +
1479980858930:theme(legend.position = 'bottom') +
1479980858931:scale_color_discrete(guide = guide_legend(nrow = 1))
1479980881711:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479980881712:.[N >= 4] %>%
1479980881712:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1479980881712:geom_hline(yintercept = 1, linetype = 'dashed') +
1479980881713:geom_line() +
1479980881713:geom_point(colour = 'white', size = 3, pch = 21) +
1479980881714:geom_vline(
1479980881714:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479980881715:linetype = 'dashed'
1479980881716:) +
1479980881716:labs(x = 'Send week', y = 'Relative open rate') +
1479980881716:theme(legend.position = 'bottom') +
1479980881717:scale_color_discrete(guide = guide_legend(nrow = 1))
1479985883717:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1479985883725:plotSendingVariability()
1479990226935:calculateMedianDistance(all_data) %>% .[segment == 'control' & median_hours_to_open < 4.3]
1479990249383:customer_data$campaigns[, .(send_day, sto_name, control_name)]
1479990286687:customer_data$campaigns[, .(send_day, sto_name, control_name)][send_day %in% ('2016-09-15', '2016-10-24', '2016-11-11')]
1479990326706:strange_dates <- calculateMedianDistance(all_data) %>% .[segment == 'control' & median_hours_to_open < 4.3, send_day]
1479990329673:strange_dates
1479990338093:customer_data$campaigns[, .(send_day, sto_name, control_name)][send_day %in% strange_dates]
1479990365166:campaign_summary
1479990372794:campaign_summary[send_day %in% strange_dates]
1479990462155:campaign_summary[send_day %in% c('2016-11-12', strange_dates)]
1479990468252:campaign_summary[send_day %in% c('2016-11-13', strange_dates)]
1479990471447:campaign_summary[send_day %in% c('2016-11-14', strange_dates)]
1479990475803:campaign_summary[send_day %in% c('2016-11-15', strange_dates)]
1479990480020:campaign_summary[send_day %in% c('2016-11-16', strange_dates)]
1479990484854:campaign_summary
1479990495276:campaign_summary[send_day %in% c(as.Date('2016-11-15'), strange_dates)]
1479990522601:all_data[send_day %in% strange_dates]
1479990563959:strange <- all_data[send_day %in% strange_dates]
1479990565458:strange
1479990580062:strange[, median(hours_to_open), by = .(send_day, segment)]
1479990585463:strange[, median(hours_to_open, na.rm = T), by = .(send_day, segment)]
1479990610213:strange <- all_data[send_day %in% c(as.Date('2016-11-15'), strange_dates)]
1479990759160:strange[, median(hours_to_open, na.rm = T), by = .(send_day, segment)]
1479990774797:strange <- all_data[send_day %in% c(as.Date('2016-11-15', '2016-11-17'), strange_dates)]
1479990776861:strange[, median(hours_to_open, na.rm = T), by = .(send_day, segment)]
1479990789690:strange <- all_data[send_day %in% c(as.Date('2016-11-15'), as.Date('2016-11-17'), strange_dates)]
1479990791285:strange[, median(hours_to_open, na.rm = T), by = .(send_day, segment)]
1479990814260:strange[, .(median_hto = median(hours_to_open, na.rm = T), mean(opened)), by = .(send_day, segment)]
1479990846672:strange[, .(median_hto = median(hours_to_open, na.rm = T), or = mean(opened), mean(send_hour)), by = .(send_day, segment)]
1479990887213:strange <- all_data[send_day %in% c(as.Date('2016-11-15'), as.Date('2016-11-17'), as.Date('2016-10-25'), strange_dates)]
1479990889173:strange[, .(median_hto = median(hours_to_open, na.rm = T), or = mean(opened), mean(send_hour)), by = .(send_day, segment)]
1479990923309:strange[send_hour == 7 & segment == 'control' & period = 'sto']
1479990930976:strange[send_hour == 7 & segment == 'control' & period == 'sto']
1479990939505:strange[send_hour == 7 & segment == 'control' & period == 'sto'][, .N, by = campaign_id]
1479990954989:strange[send_hour == 15 & segment == 'control' & period == 'sto'][, .N, by = campaign_id]
1479990974575:strange[send_hour == 4 & segment == 'control' & period == 'sto'][, .N, by = campaign_id]
1479991047285:strange[segment == 'control' & period == 'sto', .(campaign_id, send_hour)][, .N, by = .(campaign_id, send_hour)]
1479991062275:all_data[segment == 'control' & period == 'sto', .(campaign_id, send_hour)][, .N, by = .(campaign_id, send_hour)]
1479991096124:all_data[segment == 'control' & period == 'sto', .(campaign_id, send_hour)][, .(n = .N, median_h = median(hours_to_open, na.rm = TRUE)), by = .(campaign_id, send_hour)]
1479991106739:all_data[segment == 'control' & period == 'sto', .(campaign_id, hours_to_open, send_hour)][, .(n = .N, median_h = median(hours_to_open, na.rm = TRUE)), by = .(campaign_id, send_hour)]
1479991195340:contact_past_open_rates
1479991206614:contact_past_open_rates[, quantile(open_rate, seq(0, 1, 0.1))]
1479991226622:contact_past_open_rates[, quantile(n*open_rate, seq(0, 1, 0.1))]
1479991287060:all_data_active[, .(contact_id, activity)] %>% unique() %>% .[, .N, by = activity]
1479991326193:contact_past_open_rates[, quantile(n*open_rate, seq(0, 1, 0.25))]
1479991451130:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1479991451132:.[, activity := ifelse(
1479991451135:n*open_rate >= 22, 'q4', ifelse(
1479991451137:n*open_rate >= 6, 'q3', ifelse(
1479991451139:n*open_rate >= 2, 'q2', 'q1'
1479991451141:)
1479991451143:))] %>%
1479991451147:.[]
1479991470132:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1479991482847:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479991482853:.[N >= 4] %>%
1479991482855:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1479991482857:geom_hline(yintercept = 1, linetype = 'dashed') +
1479991482860:geom_line() +
1479991482861:geom_point(colour = 'white', size = 3, pch = 21) +
1479991482863:geom_vline(
1479991482864:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479991482867:linetype = 'dashed'
1479991482869:) +
1479991482871:labs(x = 'Send week', y = 'Relative open rate') +
1479991482879:theme(legend.position = 'bottom') +
1479991482886:scale_color_discrete(guide = guide_legend(nrow = 1))
1479991520446:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479991520447:.[N >= 4] %>%
1479991520447:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479991520448:geom_hline(yintercept = 1, linetype = 'dashed') +
1479991520451:geom_line() +
1479991520452:geom_point(colour = 'white', size = 3, pch = 21) +
1479991520453:geom_vline(
1479991520455:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479991520455:linetype = 'dashed'
1479991520458:) +
1479991520459:labs(x = 'Send week', y = 'Relative open rate') +
1479991520460:theme(legend.position = 'bottom') +
1479991520461:scale_color_discrete(guide = guide_legend(nrow = 1))
1479991531734:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479991531737:.[N >= 4] %>%
1479991531738:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1479991531738:geom_hline(yintercept = 0, linetype = 'dashed') +
1479991531739:geom_line() +
1479991531740:geom_point(colour = 'white', size = 3, pch = 21) +
1479991531740:geom_vline(
1479991531741:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479991531743:linetype = 'dashed'
1479991531744:) +
1479991531744:labs(x = 'Send week', y = 'Relative open rate') +
1479991531754:theme(legend.position = 'bottom') +
1479991531755:scale_color_discrete(guide = guide_legend(nrow = 1))
1479991554599:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479991554600:.[N >= 4] %>%
1479991554601:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1479991554602:geom_hline(yintercept = 1, linetype = 'dashed') +
1479991554602:geom_line() +
1479991554603:geom_point(colour = 'white', size = 3, pch = 21) +
1479991554604:geom_vline(
1479991554605:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479991554605:linetype = 'dashed'
1479991554605:) +
1479991554606:labs(x = 'Send week', y = 'Relative open rate') +
1479991554606:theme(legend.position = 'bottom') +
1479991554607:scale_color_discrete(guide = guide_legend(nrow = 1))
1479991653507:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1479991653509:.[, activity := ifelse(
1479991653509:n*open_rate >= 22, 'top25', ifelse(
1479991653510:n*open_rate >= 6, 'middle5075', ifelse(
1479991653511:n*open_rate >= 2, 'middle2550', 'bottom25'
1479991653513:)
1479991653513:))] %>%
1479991653514:.[]
1479991691306:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1479991694857:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1479991694859:.[N >= 4] %>%
1479991694859:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1479991694860:geom_hline(yintercept = 1, linetype = 'dashed') +
1479991694860:geom_line() +
1479991694861:geom_point(colour = 'white', size = 3, pch = 21) +
1479991694861:geom_vline(
1479991694861:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1479991694862:linetype = 'dashed'
1479991694862:) +
1479991694863:labs(x = 'Send week', y = 'Relative open rate') +
1479991694863:theme(legend.position = 'bottom') +
1479991694864:scale_color_discrete(guide = guide_legend(nrow = 1))
1479991764655:sending_variability <- calculateVariabilityOfLastSends(all_data_active[period == 'sto' & segment == 'sto'], scope = 5)
1480003210842:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1480003210843:plotSendingVariability()
1480003273032:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1480003273033:plotSendingVariability() +
1480003273033:labs(x = 'Send day', y = 'Number of different slots sent in last 5 mails')
1480003273451:mean_passed_time <- all_data[segment == 'sto'] %>%
1480003273452:copy() %>%
1480003273452:.[, passed_time := send_hour - shift(send_hour, 1), by = contact_id] %>%
1480003273453:.[, .(avg_passed_time = mean(passed_time)), by = send_day]
1480003328833:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1480003328834:plotSendingVariability() +
1480003328834:labs(x = 'Send day', y = 'Number of different slots sent in last 5 mails') +
1480003328835:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480003328835:theme(legend.position = 'bottom')
1480004296391:library(caret)
1480004298591:library(ROCR)
1480004300717:source('global.R')
1480004304604:getPurchaseData <- function(customer_name) {
1480004304605:readInRawData('purchase', customer_name = customer_name, start_date = '2015-06-08', end_date = '2016-09-12') %>%
1480004304606:.[!is.na(contact_id)] %>%
1480004304606:cleanRefunds() %>%
1480004304607:aggregateToDailyPurchase() %>%
1480004304607:createWeekSequence_()
1480004304608:}
1480004305818:getEmailRateData <- function(customer_name, start_date) {
1480004305819:readInRawData('email_rates', customer_name = customer_name, start_date = start_date, end_date = '2016-09-12') %>%
1480004305820:createWeekSequence_()
1480004305821:}
1480004307222:getEmailNumberData <- function(customer_name, start_date) {
1480004307222:readInRawData('email_numbers', customer_name = customer_name, start_date = start_date, end_date = '2016-09-12') %>%
1480004307224:createWeekSequence_()
1480004307224:}
1480004326060:purchase_dt <- getPurchaseData('evolution_slimming')
1480004341965:email_number_dt <- getEmailNumberData('evolution_slimming', start_date = '2015-06-08')
1480004391652:email_number_dt <- getEmailNumberData('evolution_slimming', start_date = '2015-05-04')
1480004419579:getEmailRateData <- function(customer_name, start_date) {
1480004419582:readInRawData('email_rates', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480004419584:createWeekSequence_()
1480004419584:}
1480004421524:getEmailNumberData <- function(customer_name, start_date) {
1480004421525:readInRawData('email_numbers', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480004421526:createWeekSequence_()
1480004421527:}
1480004432782:getPurchaseData <- function(customer_name) {
1480004432784:readInRawData('purchase', customer_name = customer_name, start_date = '2015-05-04', end_date = '2016-08-01') %>%
1480004432785:.[!is.na(contact_id)] %>%
1480004432785:cleanRefunds() %>%
1480004432786:aggregateToDailyPurchase() %>%
1480004432786:createWeekSequence_()
1480004432787:}
1480004433903:getEmailRateData <- function(customer_name, start_date) {
1480004433904:readInRawData('email_rates', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480004433905:createWeekSequence_()
1480004433905:}
1480004434737:getEmailNumberData <- function(customer_name, start_date) {
1480004434737:readInRawData('email_numbers', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480004434738:createWeekSequence_()
1480004434739:}
1480004437158:purchase_dt <- getPurchaseData('evolution_slimming')
1480004440522:email_number_dt <- getEmailNumberData('evolution_slimming', start_date = '2015-05-04')
1480004449943:splitData <- function(purchase_data, email_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open')) {
1480004449944:default_pars <- list(
1480004449945:purchase_dt = purchase_data, email_dt = email_data,
1480004449946:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1480004449946:email_aggregation_frequency = email_aggregation_frequency,
1480004449947:email_features = email_features
1480004449947:)
1480004449948:list(
1480004449949:train = do.call(
1480004449949:putTogetherDataForTargetPeriod,
1480004449950:c(target_year = 2016, target_week = 33, default_pars)
1480004449950:),
1480004449951:test = do.call(
1480004449951:putTogetherDataForTargetPeriod,
1480004449952:c(target_year = 2016, target_week = 35, default_pars)
1480004449953:)
1480004449953:)
1480004449954:}
1480004454904:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1480016466875:library(readr)
1480016467819:library(readxl)
1480016468178:library(dplyr)
1480016468816:library(ggplot2)
1480016480414:medicines <- read_excel("tmp/medicines_vegleges.xlsx")
1480016483048:medicines
1480016493804:medicines %>%
1480016493805:group_by(GXOX) %>%
1480016493806:count(GXOX)
1480016620441:m2 <- read_excel('tmp/medicines_vegleges2.xlsx')
1480016733216:medicines %>%
1480016733217:group_by(GXOX) %>%
1480016733217:summarize(avg_sell = mean(`selling unit pharmacy`)) %>%
1480016733218:ggplot(aes(x = GXOX, y = avg_sell, fill = GXOX)) +
1480016733218:geom_bar(stat = "identity")
1480016749964:medicines %>%
1480016749964:group_by(GXOX) %>%
1480016749965:summarize(sum(`selling unit pharmacy`))
1480016755211:medicines %>%
1480016755214:group_by(GXOX) %>%
1480016755216:summarize(avg_sell_hospital = mean(`selling unit hospital`)) %>%
1480016755216:ggplot(aes(x = GXOX, y = avg_sell_hospital, fill = GXOX)) +
1480016755217:geom_bar(stat = "identity")
1480016757912:medicines %>%
1480016757913:group_by(GXOX) %>%
1480016757914:summarize(sum(`selling unit hospital`))
1480016759991:medicines %>%
1480016759992:group_by(Manufacturer) %>%
1480016759993:count(Manufacturer) %>%
1480016759993:arrange(-n) %>%
1480016759993:slice(1:10) %>%
1480016759994:ggplot(aes(x = Manufacturer, y = n, fill = Manufacturer)) +
1480016759994:geom_bar(stat = "identity")
1480016817052:medicines %>%
1480016817053:group_by(Manufacturer) %>%
1480016817053:count(Manufacturer) %>%
1480016817054:arrange(-n) %>%
1480016817054:rename(n, medicines) %>%
1480016817054:slice(1:10) %>%
1480016817054:ggplot(aes(x = Manufacturer, y = n, fill = Manufacturer)) +
1480016817055:geom_bar(stat = "identity")
1480016825454:?rename
1480016849279:medicines %>%
1480016849280:group_by(Manufacturer) %>%
1480016849281:count(Manufacturer) %>%
1480016849281:arrange(-n) %>%
1480016849281:rename(medicines = n) %>%
1480016849281:slice(1:10) %>%
1480016849282:ggplot(aes(x = Manufacturer, y = n, fill = Manufacturer)) +
1480016849282:geom_bar(stat = "identity")
1480016858577:medicines %>%
1480016858578:group_by(Manufacturer) %>%
1480016858579:count(Manufacturer) %>%
1480016858579:arrange(-n) %>%
1480016858580:rename(medicines = n)
1480016870328:medicines %>%
1480016870330:group_by(Manufacturer) %>%
1480016870330:count(Manufacturer) %>%
1480016870331:arrange(-n) %>%
1480016870331:rename(medicines = n) %>%
1480016870331:slice(1:10) %>%
1480016870332:ggplot(aes(x = Manufacturer, y = medicines, fill = Manufacturer)) +
1480016870332:geom_bar(stat = "identity")
1480016922181:medicines %>%
1480016922181:group_by(Manufacturer) %>%
1480016922182:count(Manufacturer) %>%
1480016922183:arrange(-n) %>%
1480016922183:slice(1:10) %>%
1480016922183:ggplot(aes(x = Manufacturer, y = n, fill = Manufacturer)) +
1480016922183:geom_bar(stat = "identity") +
1480016922184:labs(y = 'medicines')
1480016932087:medicines %>%
1480016932089:group_by(Manufacturer) %>%
1480016932089:summarise(sum(`selling unit pharmacy`))
1480016939044:medicines %>%
1480016939044:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480016939045:select(Brand, Manufacturer, sumunit) %>%
1480016939045:arrange(-sumunit) %>%
1480016939046:slice(1:5) %>%
1480016939046:ggplot(aes(x = Brand, y = sumunit, fill = Brand)) +
1480016939046:geom_bar(stat = "identity")
1480017025927:medicines %>%
1480017025928:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480017025929:select(Brand, Manufacturer, sumunit) %>%
1480017025929:arrange(-sumunit) %>%
1480017025929:slice(1:5) %>%
1480017025930:ggplot(aes(x = Brand, y = sumunit, fill = Brand)) +
1480017025930:geom_bar(stat = "identity") +
1480017025930:scale_y_continuous(labels = comma)
1480017035218:medicines %>%
1480017035219:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480017035220:select(Brand, Manufacturer, sumunit) %>%
1480017035220:arrange(-sumunit) %>%
1480017035220:slice(1:5) %>%
1480017035221:ggplot(aes(x = Brand, y = sumunit, fill = Brand)) +
1480017035221:geom_bar(stat = "identity") +
1480017035221:scale_y_continuous(labels = scales::comma)
1480017071016:library(scales)
1480017073950:medicines %>%
1480017073950:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480017073951:select(Brand, Manufacturer, sumunit) %>%
1480017073951:arrange(-sumunit) %>%
1480017073951:slice(1:5) %>%
1480017073952:ggplot(aes(x = Brand, y = sumunit, fill = Brand)) +
1480017073952:geom_bar(stat = "identity") +
1480017073952:scale_y_continuous(labels = comma)
1480017132896:medicines %>%
1480017132897:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480017132898:select(Manufacturer, sumunit)
1480017186745:medicines %>%
1480017186746:mutate(sumunit = `selling unit hospital`+`selling unit pharmacy`) %>%
1480017186748:select(Manufacturer, sumunit) %>%
1480017186748:group_by(Manufacturer) %>%
1480017186749:summarise(sum(sumunit))
1480017232457:source('~/tmp/medicines.R')
1480018831217:debug(generateLabelsForTargetPeriod)
1480018837495:splitData <- function(purchase_data, email_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open')) {
1480018837496:default_pars <- list(
1480018837497:purchase_dt = purchase_data, email_dt = email_data,
1480018837498:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1480018837499:email_aggregation_frequency = email_aggregation_frequency,
1480018837500:email_features = email_features
1480018837501:)
1480018837503:list(
1480018837503:train = do.call(
1480018837504:putTogetherDataForTargetPeriod,
1480018837505:c(target_year = 2016, target_week = 33, default_pars)
1480018837506:),
1480018837507:test = do.call(
1480018837507:putTogetherDataForTargetPeriod,
1480018837509:c(target_year = 2016, target_week = 35, default_pars)
1480018837510:)
1480018837511:)
1480018837512:}
1480018838677:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1480018852705:splitData <- function(purchase_data, email_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open')) {
1480018852706:default_pars <- list(
1480018852707:purchase_dt = purchase_data, email_dt = email_data,
1480018852707:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1480018852708:email_aggregation_frequency = email_aggregation_frequency,
1480018852709:email_features = email_features
1480018852710:)
1480018852711:list(
1480018852712:train = do.call(
1480018852712:putTogetherDataForTargetPeriod,
1480018852713:c(target_year = 2016, target_week = 33, default_pars)
1480018852714:),
1480018852715:test = do.call(
1480018852716:putTogetherDataForTargetPeriod,
1480018852717:c(target_year = 2016, target_week = 35, default_pars)
1480018852719:)
1480018852723:)
1480018852724:}
1480018854283:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1480018900600:purchase_dt
1480018912743:library(caret)
1480018914971:library(ROCR)
1480018916358:source('global.R')
1480018919098:getPurchaseData <- function(customer_name) {
1480018919099:readInRawData('purchase', customer_name = customer_name, start_date = '2015-05-04', end_date = '2016-08-01') %>%
1480018919100:.[!is.na(contact_id)] %>%
1480018919100:cleanRefunds() %>%
1480018919101:aggregateToDailyPurchase() %>%
1480018919101:createWeekSequence_()
1480018919103:}
1480018920280:getEmailRateData <- function(customer_name, start_date) {
1480018920281:readInRawData('email_rates', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480018920282:createWeekSequence_()
1480018920282:}
1480018922085:getEmailNumberData <- function(customer_name, start_date) {
1480018922086:readInRawData('email_numbers', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1480018922087:createWeekSequence_()
1480018922088:}
1480018924189:purchase_dt <- getPurchaseData('evolution_slimming')
1480018929510:email_number_dt <- getEmailNumberData('evolution_slimming', start_date = '2015-05-04')
1480018962104:splitData <- function(purchase_data, email_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open')) {
1480018962106:default_pars <- list(
1480018962107:purchase_dt = purchase_data, email_dt = email_data,
1480018962108:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1480018962108:email_aggregation_frequency = email_aggregation_frequency,
1480018962109:email_features = email_features
1480018962109:)
1480018962110:list(
1480018962111:train = do.call(
1480018962111:putTogetherDataForTargetPeriod,
1480018962112:c(target_year = 2016, target_week = 27, default_pars)
1480018962113:),
1480018962113:test = do.call(
1480018962116:putTogetherDataForTargetPeriod,
1480018962117:c(target_year = 2016, target_week = 29, default_pars)
1480018962118:)
1480018962118:)
1480018962119:}
1480018964467:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1480018980726:data_14months_number <- splitData(purchase_dt, email_number_dt, email_features = c('num_click', 'num_open'))
1480019006922:n_rfm6 <- nrow(data_6months_number$train[bought_last_period == 1])
1480019007681:n_rfm <- nrow(data_14months_number$train[bought_last_period == 1])
1480019008461:n_click <- nrow(data_14months_number$train[sum_click + bought_last_period > 0])
1480019008979:n_open <- nrow(data_14months_number$train[sum_open + bought_last_period > 0])
1480019010010:methods = c(
1480019010880:'bought in last 6 months', 'bought in last 14 months',
1480019012603:'bought or clicked in last 14 months', 'bought or opened in last 14 months'
1480019015905:)
1480019017096:coverage <- data.table(
1480019017907:method = methods,
1480019018320:n = c(n_rfm6, n_rfm, n_click, n_open)
1480019018717:)
1480019019601:ggplot(coverage, aes(method, n)) +
1480019020047:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480019020514:geom_text(
1480019020952:aes(y = 10^3, label = format(n, big.mark = ',')),
1480019021378:hjust = 0, color = 'white'
1480019021818:) +
1480019022314:coord_flip() +
1480019023047:scale_x_discrete(limits = methods)
1480019058912:ggplot(coverage, aes(method, n)) +
1480019058913:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480019058913:geom_text(
1480019058914:aes(y = 10^3, label = format(n, big.mark = ',')),
1480019058914:hjust = 0, color = 'white'
1480019058914:) +
1480019058915:coord_flip() +
1480019058915:scale_x_discrete(limits = methods) +
1480019058915:scale_y_continuous(label = scales::comma)
1480019091540:ggplot(coverage, aes(method, n)) +
1480019091543:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480019091543:geom_text(
1480019091544:aes(y = 10^3, label = format(n, big.mark = ',')),
1480019091545:hjust = 0, color = 'white'
1480019091546:) +
1480019091546:coord_flip() +
1480019091547:scale_x_discrete(limits = methods) +
1480019091548:scale_y_continuous(label = scales::comma) +
1480019091548:labs(x = '', y = 'number of observations')
1480019116083:ggsave('figures/evolution_slimming_coverage.png', scale = 0.9, width = 12, height = 6)
1480019186793:rfm6_glm <- train(
1480019186794:purchased ~ recency + frequency + monetary + bought_last_period,
1480019186794:data = data_6months_number$train[sum_click + bought_last_period > 0],
1480019186795:method = 'glm',
1480019186796:family = 'binomial'
1480019186796:)
1480019197440:summary(rfm6_glm)
1480019197472:rfm_glm <- train(
1480019197473:purchased ~ recency + frequency + monetary + bought_last_period,
1480019197473:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480019197473:method = 'glm',
1480019197474:family = 'binomial'
1480019197474:)
1480019213106:summary(rfm_glm)
1480019213137:rfm_click <- train(
1480019213138:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480019213138:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480019213138:method = 'glm',
1480019213139:family = 'binomial'
1480019213139:)
1480019227115:summary(rfm_click)
1480019227143:rfm_click_open <- train(
1480019227143:purchased ~ recency + frequency + monetary + bought_last_period + sum_open + sum_click,
1480019227144:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480019227144:method = 'glm',
1480019227144:family = 'binomial'
1480019227145:)
1480019241504:summary(rfm_click_open)
1480019241532:calculateAUC <- function(prediction, label) {
1480019241532:predictions <- prediction(prediction, label)
1480019241533:perf <- performance(predictions, measure = "auc")
1480019241533:round(perf@y.values[[1]]*100, 2)
1480019241533:}
1480019241534:createROCDf <- function(prediction, label) {
1480019241534:predictions <- prediction(prediction, label)
1480019241535:perf <- performance(predictions, measure = "tpr", x.measure = "fpr")
1480019241536:roc_df <- data.frame(
1480019241537:FPR = perf@x.values[[1]],
1480019241539:TPR = perf@y.values[[1]],
1480019241539:cutoff = perf@alpha.values[[1]]
1480019241539:)
1480019241540:}
1480019241540:plotROC <- function(models, ROCcolors = c('darkblue', 'darkgreen', 'darkred', 'orange', 'black')) {
1480019241541:results <- lapply(models, function(m) {
1480019241541:prediction <- predict(m$model, m$test, 'prob')$yes
1480019241542:label <- m$test$purchased
1480019241542:list(
1480019241542:ROCdf = createROCDf(prediction, label),
1480019241542:AUC = calculateAUC(prediction, label)
1480019241543:)
1480019241544:})
1480019241545:ROCplot <- ggplot() +
1480019241545:geom_segment(
1480019241545:aes(x = 0, y = 0, xend = 1, yend = 1),
1480019241546:linetype = "dotted", col = "black"
1480019241546:) +
1480019241546:scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1480019241547:scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1480019241547:xlab("False Positive Rate") + ylab("True Positive Rate")
1480019241548:for (i in seq_along(results)) {
1480019241548:ROCplot <- ROCplot +
1480019241549:geom_line(data = results[[i]]$ROCdf, aes(FPR, TPR), size = 2, col = ROCcolors[i])
1480019241550:}
1480019241552:n_estimation = nrow(models[[1]]$test)
1480019241553:ROCplot +
1480019241554:geom_text(
1480019241555:aes(
1480019241556:x = 0.55, y = seq_len(length(results))/10,
1480019241558:label = paste0(names(results), ': ', sapply(results, function(x) x$AUC), '%')
1480019241558:),
1480019241559:hjust = 0, col = ROCcolors[seq_len(length(results))]
1480019241559:) +
1480019241560:geom_text(
1480019241561:aes(
1480019241562:x = 0, y = 0.9, hjust = 0,
1480019241562:label = paste('Estimated for', format(n_estimation, big.mark = ','), 'persons')
1480019241563:)
1480019241564:)
1480019241566:}
1480019264777:email_models_6months <- list(
1480019266807:RFM_6 = list(
1480019267231:model = rfm6_glm,
1480019267609:test = data_6months_number$test[bought_last_period == 1]
1480019267843:),
1480019268161:RFM_14 = list(
1480019268659:model = rfm_glm,
1480019269108:test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])
1480019269664:),
1480019269999:RFM_click = list(model = rfm_click, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])),
1480019270349:RFM_click_open = list(model = rfm_click_open, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)]))
1480019270707:)
1480019272505:plotROC(email_models_6months)
1480019311787:ggsave("figures/roc_japancentre_email_6months.png", scale = 0.9, width = 6, height = 6)
1480019318398:email_models_14months <- list(
1480019318887:RFM_click = list(
1480019319287:model = rfm_click,
1480019319482:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019319660:),
1480019319848:RFM_click_open = list(
1480019320319:model = rfm_click_open,
1480019320745:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019328233:)
1480019330430:plotROC(email_models_14months)
1480019342644:email_models_14months <- list(
1480019343047:RFM_click = list(
1480019343256:model = rfm_click,
1480019343470:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019343729:),
1480019343958:RFM_click_open = list(
1480019344205:model = rfm_click_open,
1480019344687:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019346808:)
1480019346976:)
1480019348250:plotROC(email_models_14months)
1480019356108:ggsave("figures/roc_japancentre_email_clicked14months.png", scale = 0.9, width = 8, height = 8)
1480019392015:purchase_cols <- c('purchased', 'recency', 'frequency', 'bought_last_period')
1480019392991:getNumClickColumns <- function(dt) {
1480019392996:grep('num_click_[0-9]+$', names(dt), value = TRUE)
1480019392996:}
1480019394006:data_period4_all <- data_14months_number_by_period4$train[
1480019395106:sum_click + bought_last_period > 0,
1480019395512:c(purchase_cols, getNumClickColumns(data_14months_number_by_period4$train)),
1480019395980:with = FALSE
1480019396429:]
1480019426229:data_14months_number_by_period4 <- splitData(purchase_dt, email_number_dt, email_features = c('num_click', 'num_open'), email_aggregation_frequency = 4)
1480019503170:rfm_click_by_period4_all <- train(
1480019504066:purchased ~ .,
1480019504472:data = data_period4_all,
1480019504889:method = 'glm',
1480019505250:family = 'binomial'
1480019506014:)
1480019516372:getNumClickColumns <- function(dt) {
1480019516374:grep('num_click_[0-9]+$', names(dt), value = TRUE)
1480019516375:}
1480019518671:data_period4_all <- data_14months_number_by_period4$train[
1480019519151:sum_click + bought_last_period > 0,
1480019519470:c(purchase_cols, getNumClickColumns(data_14months_number_by_period4$train)),
1480019519899:with = FALSE
1480019520323:]
1480019555284:generateAggregated_ <- function(dt) {
1480019555285:dt[, sum_click := rowSums(.SD), .SDcols = grep('num_click', names(dt), value = TRUE)] %>%
1480019555286:.[
1480019555286:,
1480019555287:`:=`(
1480019555287:num_click_2_3 = num_click_2 + num_click_3,
1480019555288:num_click_4_7 = num_click_4 + num_click_5 + num_click_6 + num_click_7
1480019555289:)
1480019555289:] %>%
1480019555290:.[, num_click_old := sum_click - num_click_1 - num_click_2_3]
1480019555290:}
1480019557092:lapply(data_14months_number_by_period4, generateAggregated_)
1480019570773:data_period4_all <- data_14months_number_by_period4$train[
1480019571642:sum_click + bought_last_period > 0,
1480019572076:c(purchase_cols, getNumClickColumns(data_14months_number_by_period4$train)),
1480019572502:with = FALSE
1480019572915:]
1480019631458:getNumColumns <- function(dt) {
1480019631458:grep('num_[a-z]+_[0-9]+$', names(dt), value = TRUE)
1480019631460:}
1480019660620:rfm_click_by_period4_recent <- train(
1480019661131:purchased ~ recency + frequency + monetary + bought_last_period + num_click_1 + num_click_2 + num_click_3 + num_click_old,
1480019661446:data = data_14months_number_by_period4$train[sum_click + bought_last_period > 0],
1480019661700:method = 'glm',
1480019662045:family = 'binomial'
1480019662399:)
1480019679709:summary(rfm_click_by_period4_recent)
1480019695480:email_models_14months <- list(
1480019699950:RFM_click = list(
1480019700432:model = rfm_click,
1480019700866:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019701310:),
1480019701702:RFM_click_open = list(
1480019702087:model = rfm_click_open,
1480019702553:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019702956:),
1480019703479:RFM_click_by_period4_all = list(
1480019704117:model = rfm_click_by_period4_all,
1480019704791:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019709582:)
1480019710070:)
1480019723100:email_models_14months <- list(
1480019723464:RFM_click = list(
1480019723804:model = rfm_click,
1480019724031:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019724239:),
1480019724465:RFM_click_open = list(
1480019724674:model = rfm_click_open,
1480019725042:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019725604:),
1480019727323:RFM_click_by_period_recent = list(
1480019727594:model = rfm_click_by_period4_recent,
1480019727954:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019729464:)
1480019729853:)
1480019731536:plotROC(email_models_14months)
1480019758689:rfm_click_by_period4_all <- train(
1480019758691:purchased ~ .,
1480019758692:data = data_period4_all,
1480019758692:method = 'glm',
1480019758693:family = 'binomial'
1480019758693:)
1480019785891:summary(rfm_click_by_period4_all)
1480019785915:rfm_click_by_period4_stepwise <- train(
1480019785916:purchased ~ recency + frequency + monetary + bought_last_period + num_click_1 + num_click_2_3 + num_click_4_7 + num_click_old,
1480019785917:data = data_14months_number_by_period4$train[sum_click + bought_last_period > 0],
1480019785917:method = 'glm',
1480019785917:family = 'binomial'
1480019785917:)
1480019802021:summary(rfm_click_by_period4_stepwise)
1480019824696:email_models_14months <- list(
1480019824697:RFM_click = list(
1480019824698:model = rfm_click,
1480019824698:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019824698:),
1480019824699:RFM_click_open = list(
1480019824699:model = rfm_click_open,
1480019824699:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019824700:),
1480019824700:RFM_click_by_period4_all = list(
1480019824701:model = rfm_click_by_period4_all,
1480019824701:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019824702:),
1480019824702:RFM_click_by_period_recent = list(
1480019824703:model = rfm_click_by_period4_recent,
1480019824703:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019824703:),
1480019824704:RFM_click_by_period_stepwise = list(
1480019824704:model = rfm_click_by_period4_stepwise,
1480019824705:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019824705:)
1480019824706:)
1480019863308:plotROC(email_models_6months)
1480019875996:ggsave("figures/roc_evolution_slimming_email_6months.png", scale = 0.9, width = 6, height = 6)
1480019878331:email_models_14months <- list(
1480019878758:RFM_click = list(
1480019878953:model = rfm_click,
1480019879145:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019879320:),
1480019879520:RFM_click_open = list(
1480019879659:model = rfm_click_open,
1480019879814:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019879967:),
1480019880147:RFM_click_by_period4_all = list(
1480019880314:model = rfm_click_by_period4_all,
1480019880486:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019880654:),
1480019880828:RFM_click_by_period_recent = list(
1480019881009:model = rfm_click_by_period4_recent,
1480019881166:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019881347:),
1480019881516:RFM_click_by_period_stepwise = list(
1480019881694:model = rfm_click_by_period4_stepwise,
1480019881889:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019882094:)
1480019882648:)
1480019883877:plotROC(email_models_14months)
1480019906832:ggsave("figures/roc_evolution_slimming_email_clicked14months.png", scale = 0.9, width = 8, height = 8)
1480019908497:email_models_14months_nobuy <- list(
1480019908936:RFM_click = list(model = rfm_click, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480019909171:RFM_click_open = list(model = rfm_click_open, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480019909412:RFM_click_by_period = list(model = rfm_click_by_period, test = merge(data_14months_number_by_period$test, data_14months_number$test[sum_click > 0 & bought_last_period == 0, .(contact_id)])[, num_click_old := num_click_4 + num_click_5 + num_click_6 + num_click_7 + num_click_8])
1480019910111:)
1480019911449:plotROC(email_models_14months_nobuy)
1480019989208:email_models_14months <- list(
1480019989208:RFM_click = list(
1480019989210:model = rfm_click,
1480019989210:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019989210:),
1480019989211:RFM_click_open = list(
1480019989211:model = rfm_click_open,
1480019989211:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480019989212:),
1480019989212:RFM_click_by_period_all = list(
1480019989212:model = rfm_click_by_period4_all,
1480019989213:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019989213:),
1480019989214:RFM_click_by_period_recent = list(
1480019989214:model = rfm_click_by_period4_recent,
1480019989215:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019989215:),
1480019989216:RFM_click_by_period_stepwise = list(
1480019989217:model = rfm_click_by_period4_stepwise,
1480019989218:test = data_14months_number_by_period4$test[sum_click + bought_last_period > 0]
1480019989219:)
1480019989219:)
1480019990765:plotROC(email_models_14months)
1480019995138:ggsave("figures/roc_evolution_slimming_email_clicked14months.png", scale = 0.9, width = 8, height = 8)
1480020015370:email_models_14months_nobuy <- list(
1480020015720:RFM_click = list(model = rfm_click, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020016146:RFM_click_open = list(model = rfm_click_open, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020018990:RFM_click_by_period = list(model = RFM_click_by_period4_stepwise, test = merge(data_14months_number_by_period$test, data_14months_number$test[sum_click > 0 & bought_last_period == 0, .(contact_id)])[, num_click_old := num_click_4 + num_click_5 + num_click_6 + num_click_7 + num_click_8])
1480020019606:)
1480020029873:email_models_14months_nobuy <- list(
1480020030123:RFM_click = list(model = rfm_click, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020030310:RFM_click_open = list(model = rfm_click_open, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020030718:RFM_click_by_period = list(model = rfm_click_by_period4_stepwise, test = merge(data_14months_number_by_period$test, data_14months_number$test[sum_click > 0 & bought_last_period == 0, .(contact_id)])[, num_click_old := num_click_4 + num_click_5 + num_click_6 + num_click_7 + num_click_8])
1480020031136:)
1480020045866:RFM_click_by_period = list(model = rfm_click_by_period4_stepwise, test = merge(data_14months_number_by_period4$test, data_14months_number$test[sum_click > 0 & bought_last_period == 0, .(contact_id)])[, num_click_old := num_click_4 + num_click_5 + num_click_6 + num_click_7 + num_click_8])
1480020048399:email_models_14months_nobuy <- list(
1480020049075:RFM_click = list(model = rfm_click, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020049364:RFM_click_open = list(model = rfm_click_open, test = data_14months_number$test[sum_click > 0 & bought_last_period == 0]),
1480020049981:RFM_click_by_period = list(model = rfm_click_by_period4_stepwise, test = merge(data_14months_number_by_period4$test, data_14months_number$test[sum_click > 0 & bought_last_period == 0, .(contact_id)])[, num_click_old := num_click_4 + num_click_5 + num_click_6 + num_click_7 + num_click_8])
1480020050541:)
1480020052657:plotROC(email_models_14months_nobuy)
1480020078785:ggsave("figures/roc_evolution_slimming_email_clicked14months_nobuy.png", scale = 0.9, width = 6, height = 6)
1480020330125:data_14months_number$train %>%
1480020332210:.[, table(actual_cart_value == 0)]
1480020354704:data_14months_number$train %>%
1480020355188:.[, table(actual_cart_value == 0, purchased)]
1480020422771:data_14months_number$train %>%
1480020423223:ggplot(aes(actual_cart_value)) + geom_density
1480020435722:data_14months_number$train %>%
1480020436284:ggplot(aes(actual_cart_value)) + geom_density()
1480020446468:data_14months_number$train %>%
1480020446990:ggplot(aes(log(actual_cart_value))) + geom_density()
1480020463991:data_14months_number$train %>%
1480020464405:ggplot(aes(actual_cart_value)) + geom_density() +
1480020464758:scale_x_log10()
1480020555981:rfm_cartvalue <- train(
1480020555982:log(actual_cart_value) ~ recency + frequency + monetary + bought_last_period + sum_click,
1480020555982:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480020555983:method = 'glm'
1480020555983:)
1480020603480:data_14months_number$train %>%
1480020603481:ggplot(aes(last_purchase, actual_cart_value)) + geom_point() +
1480020603482:scale_x_log10()
1480020630188:data_14months_number$train %>%
1480020630188:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1480020630189:scale_x_log10() +
1480020630190:scale_y_log10()
1480020651400:rfm_cartvalue <- train(
1480020651400:actual_cart_value ~ recency + frequency + monetary + bought_last_period + sum_click,
1480020651401:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480020651402:method = 'glm'
1480020651402:)
1480020677788:data_14months_number$train[actual_cart_value > 0] %>%
1480020677788:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1480020677789:scale_x_log10() +
1480020677790:scale_y_log10()
1480020689675:data_14months_number$train[actual_cart_value > 0 & last_purchase > 0] %>%
1480020690145:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1480020690562:scale_x_log10() +
1480020690945:scale_y_log10()
1480020702238:data_14months_number$train[actual_cart_value > 0 & last_purchase > 0] %>%
1480020702238:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1480020702239:scale_x_log10() +
1480020702240:scale_y_log10() +
1480020702246:geom_smooth()
1480020713407:summary(rfm_cartvalue)
1480020767979:data_14months_number$train[actual_cart_value > 0 & bought_last_period > 0] %>%
1480020768386:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1480020768699:scale_x_log10() +
1480020769005:scale_y_log10() +
1480020769365:geom_smooth()
1480020777821:rfm_cartvalue <- train(
1480020777822:actual_cart_value ~ recency + frequency + monetary + bought_last_period + sum_click,
1480020777823:data = data_14months_number$train[bought_last_period > 0],
1480020777823:method = 'glm'
1480020777824:)
1480020812931:rfm_cartvalue <- train(
1480020812932:actual_cart_value ~ recency + frequency + monetary + sum_click,
1480020812933:data = data_14months_number$train[bought_last_period > 0],
1480020812933:method = 'glm'
1480020812933:)
1480020823852:summary(rfm_cartvalue)
1480020963674:data_14_months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480020964348:.[, .(
1480020964934:mean((actual_cart_value - last_purchase)^2),
1480020965526:mean((actual_cart_value - predict(rfm_cartvalue, .))))]
1480020973729:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480020974249:.[, .(
1480020974645:mean((actual_cart_value - last_purchase)^2),
1480020975101:mean((actual_cart_value - predict(rfm_cartvalue, .))))]
1480021003852:predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0])
1480021018316:data_14months_number$test$actual_cart_value - predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0])
1480021034707:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]$actual_cart_value - predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0])
1480021049936:mean((data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]$actual_cart_value - predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]))^2)
1480021071212:(data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]$actual_cart_value - predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]))^2
1480021089678:sqrt(mean((data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]$actual_cart_value - predict(rfm_cartvalue, data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0]))^2))
1480021120309:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021120309:.[, .(
1480021120310:sqrt(mean((actual_cart_value - last_purchase)^2)),
1480021120310:sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2))
1480021120311:)]
1480021142773:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021142773:.[, .(
1480021142774:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1480021142775:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2))
1480021142776:)]
1480021196192:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021196195:.[, .(actual_cart_value, last_purchase, predict(rfm_cartvalue, .))]
1480021208160:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021208858:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))]
1480021224890:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021225432:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021225714:dcast()
1480021282983:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021283450:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021284098:melt()
1480021334582:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021335062:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021339976:melt(variable.name = 'model')
1480021355999:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021356000:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021356001:melt(variable.name = 'model') %>%
1480021356002:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.8)
1480021376779:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021376783:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021376783:melt(variable.name = 'model') %>%
1480021376784:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.8) +
1480021376784:scale_x_log10()
1480021389986:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021389987:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021389988:melt(variable.name = 'model') %>%
1480021389988:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021389989:scale_x_log10()
1480021414052:rfm_cartvalue <- train(
1480021414052:actual_cart_value ~ recency + frequency + monetary + sum_click,
1480021414053:data = data_14months_number$train[bought_last_period > 0 & actual_cart_value > 0],
1480021414054:method = 'glm'
1480021414054:)
1480021414723:summary(rfm_cartvalue)
1480021418145:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021418538:.[, .(
1480021418871:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1480021419209:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2))
1480021419599:)]
1480021422751:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021423093:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021423381:melt(variable.name = 'model') %>%
1480021423717:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021424109:scale_x_log10()
1480021473080:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021473080:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021473082:melt(variable.name = 'model') %>%
1480021473082:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021473083:scale_x_log10() +
1480021473084:scale_fill_discrete() +
1480021473085:labs(x = '') +
1480021473086:theme(legend.position = 'bottom')
1480021482976:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021482976:melt(variable.name = 'model') %>%
1480021482977:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021482977:scale_x_log10() +
1480021482978:labs(x = '') +
1480021482978:theme(legend.position = 'bottom')
1480021490380:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021490383:.[, .(actual_cart_value, last_purchase, rfm_click_model = predict(rfm_cartvalue, .))] %>%
1480021490384:melt(variable.name = 'model') %>%
1480021490385:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021490385:scale_x_log10() +
1480021490386:labs(x = '') +
1480021490386:theme(legend.position = 'bottom')
1480021648001:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021648001:.[, .(actual_cart_value, last_purchase)] %>%
1480021648002:melt() %>%
1480021648003:ggplot(aes(value, fill = model)) + geom_density(alpha = 0.5) +
1480021648003:scale_x_log10() +
1480021648004:scale_fill_discrete(guide = guide_legend('')) +
1480021648005:labs(x = '') +
1480021648006:theme(legend.position = 'bottom')
1480021658355:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1480021658356:.[, .(actual_cart_value, last_purchase)] %>%
1480021658357:melt() %>%
1480021658358:ggplot(aes(value, fill = variable)) + geom_density(alpha = 0.5) +
1480021658358:scale_x_log10() +
1480021658359:scale_fill_discrete(guide = guide_legend('')) +
1480021658359:labs(x = '') +
1480021658360:theme(legend.position = 'bottom')
1480021707237:ggsave('figures/evolution_slimming_cart_value.png', scale = 0.9, width = 12, height = 6)
1480022966106:source('global.R')
1480022967409:customer <- 'batiwiz'
1480022967409:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1480023041280:source('global.R')
1480023042788:customer <- 'batiwiz'
1480023043397:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480023043398:campaign_ids_1111 <- c(875502, 875540)
1480023043401:campaigns_to_restrict <- campaign_ids_1111
1480023043406:contacts_to_restrict <- customer_data$campaign_data[
1480023043407:campaign_id %in% campaigns_to_restrict,
1480023043409:.(segment, contact_id)
1480023043410:]
1480023043411:contacts_to_restrict_first <- customer_data$campaign_data[
1480023043411:campaign_id %in% first_sto_campaigns,
1480023043412:.(segment, contact_id)
1480023046014:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1480023186443:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480023196045:campaign_ids_1111 <- c(875502, 875540)
1480023203372:contacts_to_restrict_first <- customer_data$campaign_data[
1480023203376:campaign_id %in% first_sto_campaigns,
1480023203377:.(segment, contact_id)
1480023203378:]
1480023203831:contacts_to_restrict_last <- customer_data$campaign_data[
1480023203832:campaign_id %in% campaign_ids_1111,
1480023203833:.(segment, contact_id)
1480023203833:]
1480023204943:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1480023209202:contacts_to_restrict_first <- customer_data$campaign_data[
1480023209203:campaign_id %in% first_sto_campaigns,
1480023209203:.(segment, contact_id)
1480023209204:]
1480023213688:first_sto_campaigns <- c(620608, 620629)
1480023220045:contacts_to_restrict_first <- customer_data$campaign_data[
1480023220045:campaign_id %in% first_sto_campaigns,
1480023220046:.(segment, contact_id)
1480023220047:]
1480023221972:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1480023223812:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1480023252204:saveRDS(all_data, file.path('data', paste0(customer, 'all_data.rds')))
1480023318374:if (customer == 'batiwiz') {
1480023318375:# intersection with sto campaigns, pair of control campaign
1480023318376:all_data <- all_data[! campaign_id %in% c(667052, 617331)]
1480023318376:}
1480023322394:all_data[period == 'past', .N, by = contact_id][, quantile(N, seq(0, 1, 0.1))]
1480023323161:contacts_to_restrict <- all_data[period == 'past', .N, by = .(segment, contact_id)][N >= 70, .(segment, contact_id)]
1480023323906:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1480023505716:x <- 2
1480023506494:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480023506494:plotRelativeEvolution(trendlines = F, color = 'weekday')
1480023528070:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480023528072:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480023528072:labs(y = 'Relative open rate in first 2 hour')
1480023556644:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480023556645:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480023556646:labs(y = 'Relative open rate in first 2 hour') +
1480023556646:theme(legend.position = 'bottom')
1480023574965:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480023574966:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480023574968:labs(y = 'Relative open rate in first 2 hour') +
1480023574968:theme(legend.position = 'bottom') +
1480023574969:scale_color_discrete(guide = guide_legend(nrow = 1))
1480056614333:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480056614337:.[N >= 4] %>%
1480056614337:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480056614338:geom_hline(yintercept = 1, linetype = 'dashed') +
1480056614338:geom_line() +
1480056614339:geom_point(colour = 'white', size = 3, pch = 21) +
1480056614339:geom_vline(
1480056614339:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480056614340:linetype = 'dashed'
1480056614340:) +
1480056614341:labs(x = 'Send week', y = 'Relative open rate') +
1480056614341:theme(legend.position = 'bottom') +
1480056614342:scale_color_discrete(guide = guide_legend(nrow = 1))
1480056619193:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1480056623791:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480056623791:.[, activity := ifelse(
1480056623792:n*open_rate >= 22, 'top25', ifelse(
1480056623792:n*open_rate >= 6, 'middle5075', ifelse(
1480056623793:n*open_rate >= 2, 'middle2550', 'bottom25'
1480056623793:)
1480056623793:))] %>%
1480056623794:.[]
1480056636079:customer
1480056638963:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1480056646456:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480056646457:.[, activity := ifelse(
1480056646458:n*open_rate >= 22, 'top25', ifelse(
1480056646458:n*open_rate >= 6, 'middle5075', ifelse(
1480056646459:n*open_rate >= 2, 'middle2550', 'bottom25'
1480056646459:)
1480056646460:))] %>%
1480056646460:.[]
1480056654973:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1480056656970:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480056656971:.[N >= 4] %>%
1480056656972:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480056656972:geom_hline(yintercept = 1, linetype = 'dashed') +
1480056656973:geom_line() +
1480056656973:geom_point(colour = 'white', size = 3, pch = 21) +
1480056656973:geom_vline(
1480056656974:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480056656974:linetype = 'dashed'
1480056656974:) +
1480056656975:labs(x = 'Send week', y = 'Relative open rate') +
1480056656975:theme(legend.position = 'bottom') +
1480056656975:scale_color_discrete(guide = guide_legend(nrow = 1))
1480060028558:ggplot(coverage, aes(method, n)) +
1480060028559:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480060028559:geom_text(
1480060028560:aes(y = 10^3, label = format(n, big.mark = ',')),
1480060028560:hjust = 0, color = 'white'
1480060028560:) +
1480060028561:coord_flip() +
1480060028561:scale_x_discrete(limits = methods) +
1480060028561:scale_y_continuous(label = scales::comma) +
1480060028561:labs(x = '', y = 'number of observations')
1480060041746:ggplot(coverage, aes(method, n)) +
1480060041747:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480060041748:geom_text(
1480060041748:aes(y = 10^3, label = format(n, big.mark = ',')),
1480060041749:hjust = 0, color = 'white'
1480060041749:) +
1480060041750:coord_flip() +
1480060041750:scale_x_discrete(limits = methods) +
1480060041751:scale_y_continuous(label = scales::comma) +
1480060041752:labs(x = '', y = 'number of observations')
1480060050586:ggplot(coverage, aes(method, n)) +
1480060050589:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480060050590:geom_text(
1480060050591:aes(y = 10^3, label = format(n, big.mark = ',')),
1480060050594:hjust = 0, color = 'white'
1480060050595:) +
1480060050595:coord_flip() +
1480060050597:scale_x_discrete(limits = methods) +
1480060050597:scale_y_continuous(label = scales::comma) +
1480060050600:labs(x = '', y = 'number of observations')
1480060057313:ggsave('figures/evolution_slimming_coverage.png', scale = 0.8, width = 12, height = 6)
1480060101020:ggsave('figures/evolution_slimming_coverage.png', scale = 0.8, width = 12, height = 6)
1480060141792:plotROC(email_models_6months)
1480060162191:ggsave("figures/roc_evolution_slimming_email_6months.png", scale = 0.9, width = 8, height = 8)
1480060167865:plotROC(email_models_14months)
1480060179465:ggsave("figures/roc_evolution_slimming_email_clicked14months.png", scale = 0.9, width = 8, height = 8)
1480060186139:plotROC(email_models_14months_nobuy)
1480060186642:ggsave("figures/roc_evolution_slimming_email_clicked14months_nobuy.png", scale = 0.9, width = 8, height = 8)
1480062793223:n_send <- 271945
1480062797479:n_send <- 271945
1480062803265:methods = c(
1480062803266:'bought in last 6 months', 'bought in last 14 months',
1480062803267:'bought or clicked in last 14 months', 'bought or opened in last 14 months'
1480062803267:)
1480062803268:coverage <- data.table(
1480062803268:method = methods,
1480062803269:n = c(n_rfm6/n_send, n_rfm/n_send, n_click/n_send, n_open/n_send)
1480062803269:)
1480062822627:ggplot(coverage, aes(method, n)) +
1480062822628:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8)
1480062855254:?format
1480062890726:ggplot(coverage, aes(method, n)) +
1480062890726:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480062890727:geom_text(
1480062890727:aes(y = 0.02, label = paste0(n*100, '%')),
1480062890728:hjust = 0, color = 'white'
1480062890728:) +
1480062890728:coord_flip() +
1480062890729:scale_x_discrete(limits = methods) +
1480062890729:scale_y_continuous(label = scales::percent) +
1480062890729:labs(x = '', y = 'number of observations')
1480062904684:ggplot(coverage, aes(method, n)) +
1480062904684:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480062904685:geom_text(
1480062904685:aes(y = 0.02, label = paste0(round(n*100, 1), '%')),
1480062904686:hjust = 0, color = 'white'
1480062904686:) +
1480062904687:coord_flip() +
1480062904688:scale_x_discrete(limits = methods) +
1480062904688:scale_y_continuous(label = scales::percent) +
1480062904689:labs(x = '', y = 'number of observations')
1480062919045:ggsave('figures/evolution_slimming_coverage_percent.png', scale = 0.8, width = 12, height = 6)
1480063036856:ggplot(coverage, aes(method, n)) +
1480063036857:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1480063036857:geom_text(
1480063036858:aes(y = 0.02, label = paste0(round(n*100, 1), '%')),
1480063036858:hjust = 0, color = 'white'
1480063036858:) +
1480063036859:coord_flip() +
1480063036859:scale_x_discrete(limits = methods) +
1480063036860:scale_y_continuous(label = scales::percent) +
1480063036860:labs(x = '', y = 'percent of contacts who got emails')
1480063069108:ggsave('figures/evolution_slimming_coverage_percent.png', scale = 0.8, width = 12, height = 6)
1480065139469:sqrt(650000)
1480065147369:0.005/800
1480067237984:rfm_click_tree <- train(
1480067237984:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480067237985:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480067237986:method = 'tree'
1480067237986:)
1480067237986:summary(rfm_click_tree)
1480067240775:rfm_click_tree <- train(
1480067240776:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480067240777:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480067240777:method = 'tree'
1480067240778:)
1480067241055:summary(rfm_click_tree)
1480067259691:rfm_click_tree <- train(
1480067259692:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480067259693:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480067259694:method = 'rpart'
1480067259694:)
1480067278354:summary(rfm_click_tree)
1480067298563:rfm_click_rf <- train(
1480067298563:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480067298564:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480067298564:method = 'rf'
1480067298565:)
1480067513212:contact_past_open_rates
1480067522897:contact_past_open_rates[, table(n)]
1480067618774:all_data_active2 <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480067618775:.[, activity := cut(
1480067618775:open_rate,
1480067618776:breaks = quantile(open_rate, probs = seq(0, 1, by = 1/4)),
1480067618777:labels = c('bottom25', 'middle2550', 'middle5075', 'top25'),
1480067618778:right = FALSE
1480067618778:)] %>%
1480067618779:.[]
1480067631349:all_data_active[, table(activity)]
1480067635282:all_data_active2[, table(activity)]
1480067647306:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480067647306:.[, activity := cut(
1480067647307:open_rate,
1480067647307:breaks = quantile(open_rate, probs = seq(0, 1, by = 1/4)),
1480067647308:labels = c('bottom25', 'middle2550', 'middle5075', 'top25'),
1480067647308:right = FALSE
1480067647308:)] %>%
1480067647308:.[]
1480067651861:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1480067657504:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480067657504:.[N >= 4] %>%
1480067657505:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480067657506:geom_hline(yintercept = 1, linetype = 'dashed') +
1480067657506:geom_line() +
1480067657506:geom_point(colour = 'white', size = 3, pch = 21) +
1480067657507:geom_vline(
1480067657507:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480067657508:linetype = 'dashed'
1480067657508:) +
1480067657508:labs(x = 'Send week', y = 'Relative open rate') +
1480067657509:theme(legend.position = 'bottom') +
1480067657509:scale_color_discrete(guide = guide_legend(nrow = 1))
1480067672723:all_data_active[, table(activity)]
1480067679931:all_data_active[, table(activity, useNA = 'always')]
1480067694517:all_data_active[is.na(activity)]
1480067715256:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480067715258:.[, activity := cut(
1480067715258:open_rate,
1480067715258:breaks = quantile(open_rate, probs = seq(0, 1.01, by = 1/4)),
1480067715259:labels = c('bottom25', 'middle2550', 'middle5075', 'top25'),
1480067715259:right = FALSE
1480067715259:)] %>%
1480067715260:.[]
1480067727669:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1480067730730:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480067730731:.[N >= 4] %>%
1480067730731:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480067730732:geom_hline(yintercept = 1, linetype = 'dashed') +
1480067730733:geom_line() +
1480067730734:geom_point(colour = 'white', size = 3, pch = 21) +
1480067730735:geom_vline(
1480067730736:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480067730736:linetype = 'dashed'
1480067730737:) +
1480067730737:labs(x = 'Send week', y = 'Relative open rate') +
1480067730738:theme(legend.position = 'bottom') +
1480067730738:scale_color_discrete(guide = guide_legend(nrow = 1))
1480067756544:?cut
1480067866527:all_data_active <- merge(all_data, contact_past_open_rates, by = c('segment', 'contact_id')) %>%
1480067866529:.[, activity := cut(
1480067866530:open_rate,
1480067866530:breaks = quantile(open_rate, probs = seq(0, 1, by = 1/4)),
1480067866531:labels = c('bottom25', 'middle2550', 'middle5075', 'top25'),
1480067866531:right = FALSE, include.lowest = TRUE
1480067866531:)] %>%
1480067866532:.[]
1480067870955:campaign_summary_active <- calculateSummary(all_data_active, additional_by = c('activity'))
1480067873524:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480067873525:.[N >= 4] %>%
1480067873525:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480067873526:geom_hline(yintercept = 1, linetype = 'dashed') +
1480067873526:geom_line() +
1480067873526:geom_point(colour = 'white', size = 3, pch = 21) +
1480067873527:geom_vline(
1480067873527:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480067873528:linetype = 'dashed'
1480067873528:) +
1480067873529:labs(x = 'Send week', y = 'Relative open rate') +
1480067873529:theme(legend.position = 'bottom') +
1480067873530:scale_color_discrete(guide = guide_legend(nrow = 1))
1480069025432:rfm_click_nnet <- train(
1480069025434:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480069025435:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480069025435:method = 'nnet'
1480069025435:)
1480069521804:rfm_click_gbm <- train(
1480069521806:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1480069521806:data = data_14months_number$train[sum_click + bought_last_period > 0],
1480069521806:method = 'gbm'
1480069521807:)
1480069745538:methods <- list(
1480069745539:glm = list(
1480069745540:model = rfm_click,
1480069745540:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069745541:),
1480069745542:tree = list(
1480069745543:model = rfm_click_tree,
1480069745544:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069745545:),
1480069745546:forest = list(
1480069745547:model = rfm_click_rf,
1480069745548:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069745548:),
1480069745548:neuralnet = list(
1480069745549:model = rfm_click_nnet,
1480069745549:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069745550:),
1480069745550:gbm = list(
1480069745551:model = rfm_click_gbm,
1480069745551:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069745552:)
1480069745552:)
1480069770687:plotROC(methods)
1480069834342:methods <- list(
1480069834342:tree = list(
1480069834343:model = rfm_click_tree,
1480069834344:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069834344:),
1480069834344:forest = list(
1480069834344:model = rfm_click_rf,
1480069834345:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069834345:),
1480069834345:gbm = list(
1480069834346:model = rfm_click_gbm,
1480069834346:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069834346:),
1480069834347:glm = list(
1480069834347:model = rfm_click,
1480069834347:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069834348:),
1480069834349:neuralnet = list(
1480069834350:model = rfm_click_nnet,
1480069834351:test = data_14months_number$test[sum_click + bought_last_period > 0]
1480069834353:)
1480069834353:)
1480069838885:plotROC(methods)
1480069861349:ggsave("figures/roc_evolution_slimming_methods.png", scale = 0.9, width = 8, height = 8)
1480070629127:q()
1480071477516:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480071477516:.[N >= 4] %>%
1480071477517:ggplot(aes(x = week_of_year, y = diff, fill = activity, color = activity)) +
1480071477517:geom_hline(yintercept = 0, linetype = 'dashed') +
1480071477518:geom_line() +
1480071477518:geom_point(colour = 'white', size = 3, pch = 21) +
1480071477518:geom_vline(
1480071477519:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480071477519:linetype = 'dashed'
1480071477519:) +
1480071477520:labs(x = 'Send week', y = 'Relative open rate') +
1480071477520:theme(legend.position = 'bottom') +
1480071477520:scale_color_discrete(guide = guide_legend(nrow = 1))
1480071896802:aggregateSummaryToWeeks(campaign_summary_active, additional_by = 'activity') %>%
1480071896803:.[N >= 4] %>%
1480071896803:ggplot(aes(x = week_of_year, y = relative, fill = activity, color = activity)) +
1480071896804:geom_hline(yintercept = 1, linetype = 'dashed') +
1480071896804:geom_line() +
1480071896804:geom_point(colour = 'white', size = 3, pch = 21) +
1480071896805:geom_vline(
1480071896805:aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480071896805:linetype = 'dashed'
1480071896806:) +
1480071896806:labs(x = 'Send week', y = 'Relative open rate') +
1480071896807:theme(legend.position = 'bottom') +
1480071896807:scale_color_discrete(guide = guide_legend(nrow = 1))
1480320690728:df <- data.frame(xyz = 'a')
1480320694787:df$x
1480320723893:library(tibble)
1480320735691:df$xyz
1480320743498:df <- tibble(xyz = 'a')
1480320743995:df$xyz
1480320754440:library(data.table)
1480320763361:df <- data.table(xyz = 'a')
1480320763716:df$xyz
1480320772699:is.data.frame(df[, "xyz"])
1480320775221:df <- tibble(xyz = 'a')
1480320776932:is.data.frame(df[, "xyz"])
1480320805716:is.data.frame(df, .(xyz))
1480320816826:is.data.frame(df[, .(xyz)])
1480320819926:df <- data.table(xyz = 'a')
1480320821182:is.data.frame(df[, .(xyz)])
1480320865313:tibble(x = list(1:2, 3:5))
1480320874672:data.table(x = list(1:2, 3:5))
1480320975363:5 -> a
1480320976256:a
1480323699163:?tribble
1480323780018:?invoke_map
1480323783702:library(purrr)
1480323787838:?invoke_map
1480323816345:invoke(runif, n = 10)
1480323820230:runif(n = 10)
1480323871539:list(m1 = mean, m2 = median) %>% invoke_map(x = rcauchy(100))
1480324186802:?pwalk
1480324371473:install.packages('data.table')
1480324376374:install.packages("data.table")
1480324392126:library(data.table)
1480324503861:X = data.table(x = c(1,1,1,2,2,5,6), y = 1:7, key = "x")
1480324503865:Y = data.table(x = c(2,6), z = letters[2:1], key = "x")
1480324513148:X
1480324513868:Y
1480324517256:X[Y]
1480324573193:X[Y, .N]
1480324588245:X[Y, .N, by = .EACHI]
1480324599061:X
1480324603157:X[, .N]
1480324607339:X[, .N, by = .EACHI]
1480324611879:X[, .N]
1480324613882:X[x, .N]
1480324772802:?fwrite
1480325359838:data(Orange)
1480325369095:install.packages('ggrepel')
1480325379014:library(ggplot2)
1480325392291:install.packages('ggplot2')
1480325395042:install.packages("ggplot2")
1480325401769:install.packages('plotly')
1480325407356:library(ggplot2)
1480325407965:library(ggrepel)
1480325416115:sessionInfo()
1480325542931:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line()
1480325586011:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange(age == max(age), aes(label = paste("Tree", Tree)))))
1480325600955:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age), aes(label = paste("Tree", Tree)))))
1480325603456:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age, aes(label = paste("Tree", Tree)))))
1480325608753:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)))))
1480325611121:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree))))
1480325612214:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)))
1480325632227:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)))
1480325634026:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)))
1480325653412:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree))) + expand_limits(x = 2000)
1480325659715:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree))) + expand_limits(x = 1800)
1480325672935:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 6) + expand_limits(x = 1800)
1480325685107:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 45) + expand_limits(x = 1800)
1480325690144:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 45) + expand_limits(x = 1600)
1480325695000:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 45) + expand_limits(x = 1700)
1480325708678:?nudge_x
1480325711756:??nudge_x
1480325716361:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 45) + expand_limits(x = 1700)
1480325720727:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 0) + expand_limits(x = 1700)
1480325724549:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 100) + expand_limits(x = 1700)
1480325734157:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 1000) + expand_limits(x = 1700)
1480325738401:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 10) + expand_limits(x = 1700)
1480325743062:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 20) + expand_limits(x = 1700)
1480325833575:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 100) + expand_limits(x = 1700)
1480325841013:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 1000) + expand_limits(x = 1700)
1480325860732:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 10000) + expand_limits(x = 11500)
1480325879582:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 1) + expand_limits(x = 11500)
1480325885220:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 10) + expand_limits(x = 11500)
1480325891959:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 50) + expand_limits(x = 11500)
1480325899631:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 50)
1480325909085:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 50) + expand_limits(x = 1750)
1480325912519:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_x = 50) + expand_limits(x = 1700)
1480325929817:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10) + expand_limits(x = 1700)
1480325940822:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10) + expand_limits(y = 250)
1480325991387:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, box.padding = unit(0.2, 'lines')) + expand_limits(y = 250)
1480326013920:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, box.padding = unit(0.2, 'lines'), color = 'black') + expand_limits(y = 250)
1480326023394:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, box.padding = unit(0.2, 'lines')) + expand_limits(y = 250)
1480326060356:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, segment.color = '') + expand_limits(y = 250)
1480326070586:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, segment.size = 0) + expand_limits(y = 250)
1480326080776:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == max(age)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, nudge_x = 0, segment.size = 0) + expand_limits(y = 250)
1480326112384:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == 1200)), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, nudge_x = 0, segment.size = 0) + expand_limits(y = 250)
1480326133650:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == 1200), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, nudge_x = 0, segment.size = 0)) + expand_limits(y = 250)
1480326154977:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == 1200), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, nudge_x = 0, segment.size = 0) + expand_limits(y = 250)
1480326169040:ggplot(Orange, aes(age, circumference, color = Tree)) + geom_line() + geom_text_repel(data = subset(Orange, age == 1200), aes(label = paste("Tree", Tree)), size = 4, nudge_y = 10, nudge_x = 0, segment.size = 0) + expand_limits(y = 250)
1480326173824:Orange[age == 1200]
1480326178493:Orange
1480336727295:?do
1480336729600:??do
1480336749613:library(dplyr)
1480336751021:??do
1480336753925:?do
1480336781361:by_cyl <- group_by(mtcars, cyl)
1480336781955:do(by_cyl, head(., 2))
1480336810665:setDT(mtcarc) %>% .[1:2, , by = cyl]
1480336815088:library(data.table)
1480336817566:setDT(mtcarc) %>% .[1:2, , by = cyl]
1480336823382:setDT(mtcars) %>% .[1:2, , by = cyl]
1480336837735:setDT(data(mtcars)) %>% .[1:2, , by = cyl]
1480336849047:data(mtcars)
1480336855856:mtcars
1480336857528:setDT(mtcars) %>% .[1:2, , by = cyl]
1480336865433:setDT(mtcars) %>% .[1:2, .SD, by = cyl]
1480336889829:group_by(mtcars, cyl) %>% do(head(., 2))
1480336900514:setDT(mtcars) %>% .[1:2, mpg, by = cyl]
1480336917201:setDT(mtcars) %>% .[, head(mpg), by = cyl]
1480336921834:setDT(mtcars) %>% .[, head(mpg, 2), by = cyl]
1480336927507:setDT(mtcars) %>% .[, head(.SD, 2), by = cyl]
1480336929164:group_by(mtcars, cyl) %>% do(head(., 2))
1480336957904:lm(mpg ~ cyl, mtcars)
1480336965974:library(broom)
1480336970783:install.packages('broom')
1480336983969:library(broom)
1480336991398:lm(mpg ~ cyl, mtcars) %>% tidy()
1480337013658:lm(mpg ~ cyl, mtcars) %>% tidy() %>% select(p.value)
1480337032328:lm(mpg ~ cyl, mtcars) %>% tidy() %>% filter(term == 'cyl') %>% select(p.value)
1480337038974:lm(mpg ~ cyl, mtcars) %>% tidy() %>% class()
1480337053280:models <- by_cyl %>% do(mod = lm(mpg ~ disp, data = .))
1480337056643:models
1480337063561:models %>% tidy()
1480337068141:models %>% tidy(mod)
1480337081252:models %>% tidy(mod) %>% filter(cyl) %>% select(p.value)
1480337086645:models %>% tidy(mod) %>% filter(cyl == 4) %>% select(p.value)
1480337101252:models %>% tidy(mod) %>% filter(term == 'disp') %>% select(cyl, p.value)
1480337139512:modelsDT <- setDT(mtcars) %>% .[, lm(mpg ~ disp), by = cyl]
1480337186881:getPvalue <- function(model) {
1480337186882:model %>% tidy() %>% filter(term == 'disp') %>% select(p.value)
1480337186883:}
1480337194454:modelsDT <- setDT(mtcars) %>% .[, getPvalue(lm(mpg ~ disp)), by = cyl]
1480337197587:modelsDT
1480347587996:library(emsconnectr)
1480347616759:library(emsconnectr)
1480347654346:emsconnectr::getListOfCustomersWithAttributes()
1480347669847:emsconnectr::getListOfCustomersWithAttributes
1480347709450:emsconnectr::getListOfCustomersWithAttributes(TRUE, TRUE, 'data', )
1480347723382:listAvailableCustomerAttributes()
1480347739010:listAvailableCustomerAttributes
1480347753604:listAvailableCustomerAttributes('data')
1480347823512:emsconnectr::getListOfCustomersWithAttributes(TRUE, TRUE, 'data', c('id', 'xpress_job_dbhost_id'))
1480347838050:emsconnectr::getListOfCustomersWithAttributes(TRUE, TRUE, 'data', c('id', suite = 'xpress_job_dbhost_id'))
1480347969589:cucc <- emsconnectr::getListOfCustomersWithAttributes(TRUE, TRUE, 'data', c('id', suite = 'xpress_job_dbhost_id'))
1480348067770:cucc[, .N, by = suite]
1480348091031:cucc
1480348915498:cucc <- getListOfActivelyPayingCustomers()
1480348920528:cucc
1480348946040:cucc[, quantile(customer_id, seq(0, 1, 0.1))]
1480348956429:cucc[, quantile(customer_id, seq(0, 1, 0.1))]
1480348971071:cucc[, quantile(customer_id, probs = seq(0, 1, 0.1))]
1480348976833:cucc[, quantile(customer_id, probs = seq(0.1, 1, 0.1))]
1480348982730:cucc[, quantile(customer_id)]
1480348987139:cucc
1480348990569:cucc$customer_id
1480348999929:cucc[, quantile(as.numeric(customer_id), probs = seq(0.1, 1, 0.1))]
1480408211858:setwd("~/tmp/sandbox")
1480408217362:library(ggplot2)
1480408217650:library(readr)
1480408217666:library(dplyr)
1480408217870:mydata <- read_csv("mydata.csv")
1480408229199:invetsmentsMean <- mean(mydata$raisedAmt, na.rm = TRUE)
1480408229200:invetsmentsMean
1480408229201:#Median of investments
1480408229201:invetsmentsMedian <- median(mydata$raisedAmt, na.rm = TRUE)
1480408229202:invetsmentsMedian
1480408229203:#Variancia of investments
1480408229203:invetsmentsVar <- var(mydata$raisedAmt, na.rm = TRUE)
1480408229204:invetsmentsVar
1480408229205:#Minimum of investments
1480408229205:invetsmentsMin <- min(mydata$raisedAmt, na.rm = TRUE)
1480408229207:invetsmentsMin
1480408229209:#Maximum of investments
1480408229210:invetsmentsMax <- max(mydata$raisedAmt, na.rm = TRUE)
1480408229212:invetsmentsMax
1480408229214:#Average of investments in CA
1480408229215:invetsmentsMeanCA <- mean(mydata$raisedAmt[mydata$state == "CA"], na.rm = TRUE)
1480408229217:invetsmentsMeanCA
1480408229218:#Average of investments in AZ
1480408229218:invetsmentsMeanAZ <- mean(mydata$raisedAmt[mydata$state == "AZ"], na.rm = TRUE)
1480408229219:invetsmentsMeanAZ
1480408229219:CAdataInv <- mydata$raisedAmt[mydata$state == "CA"]
1480408229220:hist(CAdataInv) #Ca-ban felvett pnz hisztogramja
1480408252093:mydata
1480408261888:summary(mydata)
1480408290240:#Round investments - scatter chart
1480408290243:mydata$round[mydata$round == "angel"] <- 1
1480408290244:mydata$round[mydata$round == "seed"] <- 2
1480408290245:mydata$round[mydata$round == "a"] <- 3
1480408290245:mydata$round[mydata$round == "b"] <- 4
1480408290246:mydata$round[mydata$round == "c"] <- 5
1480408290246:mydata$round[mydata$round == "d"] <- 6
1480408290248:mydata
1480408290263:myDataRegression <- mydata[!(mydata$round == "debt_round" | mydata$round =="unattributed" | mydata$round =="e" ),]
1480408290264:data = data.frame(round= myDataRegression$round, money=myDataRegression$raisedAmt)
1480408290267:ggplot(data, aes(round, money)) + geom_point() #round investments
1480408311472:mydata <- read_csv("mydata.csv")
1480408313100:mydata
1480408349201:ggplot(data, aes(round, money)) + geom_point()
1480408367970:ggplot(mydata, aes(round, money)) + geom_point()
1480408390923:ggplot(mydata, aes(round, raisedAmt)) + geom_point()
1480408416396:library(forcats)
1480408421484:install.packages('forcats')
1480408534940:ggplot(mydata, aes(fct_relevel(round, 'seed', 'angel'), raisedAmt)) + geom_point()
1480408539503:library(forcats)
1480408540743:ggplot(mydata, aes(fct_relevel(round, 'seed', 'angel'), raisedAmt)) + geom_point()
1480408584291:ordered.factor
1480408588959:?ordered
1480408680240:mydata <- mydata %>%
1480408680240:mutate(round = ordered(round, c('angel', 'seed', 'a', 'b', 'c', 'd', 'e', 'debt_round', 'unattributed')))
1480408718658:mydata <- mydata %>%
1480408718659:mutate(round = ordered(round, c('angel', 'seed', 'a', 'b', 'c', 'd', 'e', 'debt_round', 'unattributed')))
1480408718662:ggplot(mydata, aes(round, raisedAmt)) + geom_point()
1480408784669:mydata %>%
1480408784669:filter(round != 'debt_round', round != 'unattributed', round != 'e') %>%
1480408784670:ggplot(aes(round, raisedAmt)) + geom_point()
1480408807960:invetsmentsMeanFA <- sum(mydata$raisedAmt[mydata$company == "Facebook"], na.rm = TRUE)
1480408807961:invetsmentsMeanFA
1480408807961:#Average of investments in Tesla
1480408807962:invetsmentsMeanTE <- sum(mydata$raisedAmt[mydata$company == "Tesla Motors"], na.rm = TRUE)
1480408807962:invetsmentsMeanTE
1480408807963:#Average of investments in Ustream
1480408807964:invetsmentsMeanUS <- sum(mydata$raisedAmt[mydata$company == "Ustream"], na.rm = TRUE)
1480408807964:invetsmentsMeanUS
1480408807966:#Average of investments in Twitter
1480408807966:invetsmentsMeanTW <- sum(mydata$raisedAmt[mydata$company == "Twitter"], na.rm = TRUE)
1480408807967:invetsmentsMeanTW
1480408807968:#Average of investments in LinkedIn
1480408807968:invetsmentsMeanLI <- sum(mydata$raisedAmt[mydata$company == "LinkedIn"], na.rm = TRUE)
1480408807969:invetsmentsMeanLI
1480408807969:#Average of investments in YouTube
1480408807970:invetsmentsMeanYO <- sum(mydata$raisedAmt[mydata$company == "YouTube"], na.rm = TRUE)
1480408807970:invetsmentsMeanYO
1480408807971:invN = c("Facebook","Tesla Motors", "Ustream", "Twitter", "LinkedIn", "YouTube")
1480408807974:invP = c(invetsmentsMeanFA, invetsmentsMeanTE, invetsmentsMeanUS, invetsmentsMeanTW, invetsmentsMeanLI, invetsmentsMeanYO)
1480408807976:barData= data.frame(invN, invP)
1480408807978:ggplot(barData, aes(invN,invP)) +
1480408807978:geom_bar(stat = "identity")+
1480408807979:labs(title="inv")+ scale_x_discrete("Company investments comparison")
1480408898684:mydata %>%
1480408898685:group_by(company) %>%
1480408898686:summarise(investment = sum(raisedAmt)) %>%
1480408898687:ggplot(aes(company, investment)) +
1480408898687:geom_bar(stat = 'identity') +
1480408898687:labs(title="inv", x = "Company investments comparison")
1480408937473:companies = c("Facebook","Tesla Motors", "Ustream", "Twitter", "LinkedIn", "YouTube")
1480408937474:mydata %>%
1480408937474:filter(company %in% companies) %>%
1480408937475:group_by(company) %>%
1480408937475:summarise(investment = sum(raisedAmt)) %>%
1480408937476:ggplot(aes(company, investment)) +
1480408937477:geom_bar(stat = 'identity') +
1480408937478:labs(title="inv", x = "Company investments comparison")
1480412222609:q()
1480412268523:source('global.R')
1480412280373:customer_data <- getCampaignDataForCustomer(customer, refetch = FALSE)
1480412287024:customer <- 'travelist_market'
1480412288435:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1480413297413:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480413309413:contacts_to_restrict <- unique_contacts
1480413315986:if (customer == 'travelist_market') {
1480413315987:all_data <- all_data[campaign_id != 701805]
1480413315988:}
1480413321683:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1480413602780:if (customer == 'travelist_market') {
1480413602783:all_data <- all_data[campaign_id != 701805]
1480413602784:}
1480413620480:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) +
1480413620482:labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour', nrow = 1)) + theme(legend.position = 'bottom')
1480414444575:home_location_availability <- fread('data/home_location_availability_by_customer.csv')
1480414449056:home_location_availability <- fread('data/home_location_availability_by_customer.csv')
1480418643363:campaign_summary <- calculateSummary(all_data)
1480418647140:plotOpenRateEvolutionWithPast(campaign_summary)
1480418653556:campaign_summary %>%
1480418653557:ggplot(aes(send_day, open_rate, color = segment)) +
1480418653558:geom_line() +
1480418653558:addSTOline(text_position = 0.18) +
1480418653558:geom_smooth(span = 0.3) +
1480418653559:labs(x = 'Day', y = 'Open rate') +
1480418653559:theme(legend.position = 'bottom')
1480418663528:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(trendlines = F, color = 'weekday', text_position = 0.9) +
1480418663530:labs(x = 'Send day', y = 'Relative open rate') +
1480418663532:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480418663533:theme(legend.position = 'bottom')
1480418678238:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9) +
1480418678239:labs(x = 'Send day', y = 'Relative open rate') +
1480418678240:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480418678240:theme(legend.position = 'bottom')
1480418702455:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1480418743222:plotOpenRateEvolutionWithPast(campaign_summary)
1480485561342:library(readr)
1480485590093:library(readr)
1480485590691:library(dplyr)
1480485591239:library(nycflights13)
1480485592801:flights %>%
1480485592802:summarise(mean(dep_delay, na.rm = TRUE))
1480485595293:flights %>%
1480485595294:filter(dest == 'ANC') %>%
1480485595295:summarise(mean(dep_delay, na.rm = TRUE))
1480485601674:flights %>%
1480485601674:filter(dep_delay == max(dep_delay, na.rm = TRUE)) %>%
1480485601675:select(dest)
1480506267258:source('global.R')
1480506270748:customer <- 'travelist_market'
1480506271889:id <- getIdFromName(customer)
1480506272927:segments <- c('REAL_AKT_20_STO', 'REAL_AKT_80_CONTROL')
1480506274727:getContactlistId <- function(contactlist_name) {
1480506274728:getSqlResult(
1480506274729:query = paste0("SELECT id
1480506274729:FROM userlists
1480506274729:WHERE customer = #{customer_id}
1480506274730:AND name = '", contactlist_name, "'"),
1480506274731:database_name = SETTINGS[[customer]]$suite,
1480506274731:customer_id = id
1480506274732:) %>% .[, id]
1480506274733:}
1480506278143:getListOfContacts <- function(contactlist_id) {
1480506278145:getSqlResult(
1480506278145:query = "SELECT user_id as contact_id
1480506278146:FROM ul_#{customer_id}_#{userlist_id};",
1480506278147:database_name = SETTINGS[[customer]]$suite,
1480506278147:customer_id = id,
1480506278148:userlist_id = contactlist_id
1480506278149:)
1480506278150:}
1480506287585:contacts_by_segment <- lapply(0:1, function(i) {
1480506287586:segment <- segments[i + 1]
1480506287586:getListOfContacts(getContactlistId(segment)) %>%
1480506287586:.[, sto := i]
1480506287587:}) %>% rbindlist()
1480506507077:source('global.R')
1480506508306:customer <- 'travelist_market'
1480506509638:id <- getIdFromName(customer)
1480506511045:segments <- c('REAL_AKT_20_STO', 'REAL_AKT_80_CONTROL')
1480506512411:getContactlistId <- function(contactlist_name) {
1480506512411:getSqlResult(
1480506512412:query = paste0("SELECT id
1480506512413:FROM userlists
1480506512413:WHERE customer = #{customer_id}
1480506512413:AND name = '", contactlist_name, "'"),
1480506512413:database_name = SETTINGS[[customer]]$suite,
1480506512414:customer_id = id
1480506512414:) %>% .[, id]
1480506512414:}
1480506513763:getListOfContacts <- function(contactlist_id) {
1480506513764:getSqlResult(
1480506513765:query = "SELECT user_id as contact_id
1480506513766:FROM ul_#{customer_id}_#{userlist_id};",
1480506513766:database_name = SETTINGS[[customer]]$suite,
1480506513767:customer_id = id,
1480506513767:userlist_id = contactlist_id
1480506513768:)
1480506513770:}
1480506515040:contacts_by_segment <- lapply(0:1, function(i) {
1480506515040:segment <- segments[i + 1]
1480506515041:getListOfContacts(getContactlistId(segment)) %>%
1480506515041:.[, sto := i]
1480506515042:}) %>% rbindlist()
1480506546688:contacts_by_segment
1480506551610:contacts_by_segment[, .N, by = stop()]
1480506553407:contacts_by_segment[, .N, by = sto]
1480506578125:contacts_by_segment
1480506649812:contacts_by_segment <- lapply(0:1, function(i) {
1480506649813:segment <- segments[i + 1]
1480506649814:getListOfContacts(getContactlistId(segment)) %>%
1480506649814:.[, sto := i]
1480506649814:}) %>% rbindlist()
1480506655881:segments <- c('REAL_AKT_80_CONTROL', 'REAL_AKT_20_STO')
1480506766176:contacts_by_segment <- lapply(0:1, function(i) {
1480506766176:segment <- segments[i + 1]
1480506766177:getListOfContacts(getContactlistId(segment)) %>%
1480506766177:.[, sto := i]
1480506766178:}) %>% rbindlist()
1480506995601:contacts_by_segment <- lapply(0:1, function(i) {
1480506995601:segment <- segments[i + 1]
1480506995602:getListOfContacts(getContactlistId(segment)) %>%
1480506995602:.[, sto := i]
1480506995603:}) %>% rbindlist()
1480506999432:contacts_by_segment <- lapply(0:1, function(i) {
1480506999433:segment <- segments[i + 1]
1480506999434:getListOfContacts(getContactlistId(segment)) %>%
1480506999434:.[, sto := i]
1480506999435:}) %>% rbindlist()
1480507022284:contacts_by_segment[, .N, by = sto]
1480507183762:rm(list = ls())
1480507202813:source('global.R')
1480507205923:customer <- 'travelist_market'
1480507206902:id <- getIdFromName(customer)
1480507208389:segments <- c('REAL_AKT_80_CONTROL', 'REAL_AKT_20_STO')
1480507211541:getContactlistId <- function(contactlist_name) {
1480507211542:getSqlResult(
1480507211542:query = paste0("SELECT id
1480507211543:FROM userlists
1480507211543:WHERE customer = #{customer_id}
1480507211543:AND name = '", contactlist_name, "'"),
1480507211544:database_name = SETTINGS[[customer]]$suite,
1480507211544:customer_id = id
1480507211544:) %>% .[, id]
1480507211545:}
1480507212206:getListOfContacts <- function(contactlist_id) {
1480507212206:getSqlResult(
1480507212207:query = "SELECT user_id as contact_id
1480507212208:FROM ul_#{customer_id}_#{userlist_id};",
1480507212208:database_name = SETTINGS[[customer]]$suite,
1480507212209:customer_id = id,
1480507212209:userlist_id = contactlist_id
1480507212209:)
1480507212210:}
1480507214483:contacts_by_segment <- lapply(0:1, function(i) {
1480507214483:segment <- segments[i + 1]
1480507214484:getListOfContacts(getContactlistId(segment)) %>%
1480507214485:.[, sto := i]
1480507214486:}) %>% rbindlist()
1480507236067:contacts_by_segment <- lapply(0:1, function(i) {
1480507236068:segment <- segments[i + 1]
1480507236069:getListOfContacts(getContactlistId(segment)) %>%
1480507236070:.[, sto := i]
1480507236071:}) %>% rbindlist()
1480507296700:contacts_by_segment <- lapply(0:1, function(i) {
1480507296701:segment <- segments[i + 1]
1480507296702:getListOfContacts(getContactlistId(segment)) %>%
1480507296702:.[, sto := i]
1480507296702:}) %>% rbindlist()
1480507346547:contacts_by_segment <- lapply(0:1, function(i) {
1480507346548:segment <- segments[i + 1]
1480507346548:contact_list_id <- getContactlistId(segment)
1480507346549:getListOfContacts(contact_list_id) %>%
1480507346549:.[, sto := i]
1480507346549:}) %>% rbindlist()
1480507502530:contacts_by_segment <- lapply(0:1, function(i) {
1480507502531:segments[i + 1] %>%
1480507502532:getContactlistId() %>%
1480507502532:getListOfContacts(contact_list_id) %>%
1480507502532:.[, sto := i]
1480507502533:}) %>% rbindlist()
1480507510853:contacts_by_segment <- lapply(0:1, function(i) {
1480507510853:segments[i + 1] %>%
1480507510854:getContactlistId() %>%
1480507510854:getListOfContacts() %>%
1480507510855:.[, sto := i]
1480507514550:}) %>% rbindlist()
1480507525473:contacts_by_segment <- lapply(0:1, function(i) {
1480507525474:segments[i + 1] %>%
1480507525475:getContactlistId() %>%
1480507525475:getListOfContacts() %>%
1480507525475:.[, sto := i]
1480507525476:}) %>% rbindlist()
1480507573465:createStringValuesForSQLWith <- function(dt) {
1480507573466:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480507573467:paste(collapse = ',')
1480507573468:}
1480507577141:data_by_segment <- readSqlResultLocal(
1480507577142:file_name = 'sql/random_segment_check.sql',
1480507577142:data_file = paste0(customer, '_random_segment_history.csv'),
1480507577143:values_string = createStringValuesForSQLWith(contacts_by_segment),
1480507577143:refetch = TRUE
1480507577143:)
1480507619776:data_by_segment <- readSqlResultLocal(
1480507619779:file_name = 'sql/random_segment_check.sql',
1480507619779:data_file = paste0(customer, '_random_segment_history.csv'),
1480507619779:customer_id = id,
1480507619780:values_string = createStringValuesForSQLWith(contacts_by_segment),
1480507619780:refetch = TRUE
1480507619780:)
1480512390252:list.files('src', full.names = TRUE, pattern = '*.R')
1480512403396:list.files('../geo-location/src', full.names = TRUE, pattern = '*.R')
1480512408090:list.files('../geo-location/src', full.names = TRUE)
1480512468151:data_by_segment[, segment := ifelse(sto == 1, 'sto', 'control')]
1480512663886:trydt <- data_by_segment[1:100000]
1480512676319:trydt[, segment := ifelse(sto == 1, 'sto', 'control')]
1480512679113:trydt <- data_by_segment[1:1000000]
1480512680426:trydt[, segment := ifelse(sto == 1, 'sto', 'control')]
1480512702591:packrat::extlib('microbenchmark')
1480512720165:packrat::extlib(microbenchmark)
1480512726739:packrat::extlib('microbenchmark')
1480512736339:install.packages('microbenchmark')
1480512789912:microbenchmark(trydt[, segment1 := ifelse(sto == 1, 'sto', 'control')])
1480512797665:library(microbenchmark)
1480512809674:microbenchmark(trydt[1:10, segment1 := ifelse(sto == 1, 'sto', 'control')])
1480512895092:cucc <- c(c('a', 'b'), c(1, 2))
1480512896580:cucc
1480512902557:cucc <- outer(c('a', 'b'), c(1, 2))
1480512906312:?outer
1480512912715:cucc <- outer(c('a', 'b'), c(1, 2), paste)
1480512914069:cucc
1480513072833:microbenchmark(trydt[, segment1 := ifelse(sto == 1, 'sto', 'control')], unit = 's')
1480513141492:microbenchmark(trydt[, segment1 := ifelse(sto == 1, 'sto', 'control')], unit = 's', times = 1)
1480513170921:microbenchmark(trydt[, segment := ifelse(sto == 1, 'sto', 'control')], trydt[, segment := c('control', 'segment')[sto + 1]], unit = 's', times = 1)
1480513202050:data_by_segment[, segment := c('control', 'segment')[sto + 1]]
1480513206421:data_by_segment[, .N, by = segment]
1480513210190:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1480513210780:.[, mean(open_rate), by = segment]
1480513223093:addRandomSegments <- function(dt, n = 5, p = c(0.5, 0.5)) {
1480513223094:random_names <- sapply(1:n, function(i) paste0('rand#', i))
1480513223094:unique(dt[, .(contact_id)]) %>%
1480513223095:.[, (random_names) := replicate(
1480513223096:n,
1480513223096:sample(c('control', 'sto'), size = .N, replace = TRUE, prob = p),
1480513223097:simplify = FALSE
1480513223098:)] %>%
1480513223098:merge(dt, ., by = 'contact_id')
1480513223099:}
1480513226425:data_by_segment_random <- addRandomSegments(data_by_segment, p = c(0.8, 0.2))
1480513305644:history_summaries <- lapply(
1480513305649:c('segment', 'rand1', 'rand2', 'rand3', 'rand4'),
1480513305649:function(segment_var) {
1480513305649:calculateCampaignOpenRate(
1480513305649:dt = data_by_segment_random[bounced == FALSE],
1480513305650:by = c(segment_var, 'send_day')
1480513305650:)
1480513305650:} %>%
1480513305651:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480513305651:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480513305651:)
1480513364872:data_by_segment
1480513372194:data_by_segment_random
1480513404201:c('segment', grep(names(data_by_segment_random), 'rand', value = T))
1480513412029:?grep
1480513425697:c('segment', grep('rand', names(data_by_segment_random), value = T))
1480513502538:history_summaries <- lapply(
1480513502539:c('segment', grep('rand', names(data_by_segment_random), value = T)),
1480513502540:function(segment_var) {
1480513502540:calculateCampaignOpenRate(
1480513502540:dt = data_by_segment_random[bounced == FALSE],
1480513502541:by = c(segment_var, 'send_day')
1480513502541:) %>%
1480513502541:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480513502542:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480513502542:}
1480513502542:)
1480513565792:calculateCampaignOpenRate(data_by_segment_random, by = c('segment', 'send_day'))
1480513596759:calculateCampaignOpenRate(data_by_segment_random, by = c('segment', 'send_day')) %>% dcast(send_day ~ segment, value.var = 'open_rate')
1480513622043:data_by_segment[, segment := c('control', 'sto')[sto + 1]]  # much faster then ifelse()
1480513628937:addRandomSegments <- function(dt, n = 5, p = c(0.5, 0.5)) {
1480513628938:random_names <- sapply(1:n, function(i) paste0('rand#', i))
1480513628938:unique(dt[, .(contact_id)]) %>%
1480513628938:.[, (random_names) := replicate(
1480513628939:n,
1480513628939:sample(c('control', 'sto'), size = .N, replace = TRUE, prob = p),
1480513628940:simplify = FALSE
1480513628940:)] %>%
1480513628940:merge(dt, ., by = 'contact_id')
1480513628941:}
1480513631442:data_by_segment_random <- addRandomSegments(data_by_segment, p = c(0.8, 0.2))
1480513697384:history_summaries <- lapply(
1480513697386:c('segment', grep('rand', names(data_by_segment_random), value = T)),
1480513697386:function(segment_var) {
1480513697386:calculateCampaignOpenRate(
1480513697387:dt = data_by_segment_random[bounced == FALSE],
1480513697387:by = c(segment_var, 'send_day')
1480513697388:) %>%
1480513697388:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480513697388:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480513697389:}
1480513697389:)
1480513767344:c('segment', grep('rand', names(data_by_segment_random), value = T))
1480513781787:data_by_segment_random
1480513810853:calculateCampaignOpenRate(data_by_segment_random[bounced == FALSE], by = c('rand#1', 'send_day'))
1480513858650:calculateCampaignOpenRate(data_by_segment_random[bounced == FALSE], by = c('rand#1', 'send_day')) %>% dcast(send_day ~ rand#1)
1480513867464:, value.var = 'open_rate')
1480513907352:addRandomSegments <- function(dt, n = 5, p = c(0.5, 0.5)) {
1480513907353:random_names <- sapply(1:n, function(i) paste0('rand', i))
1480513907354:unique(dt[, .(contact_id)]) %>%
1480513907354:.[, (random_names) := replicate(
1480513907354:n,
1480513907355:sample(c('control', 'sto'), size = .N, replace = TRUE, prob = p),
1480513907355:simplify = FALSE
1480513907356:)] %>%
1480513907356:merge(dt, ., by = 'contact_id')
1480513907356:}
1480513907357:data_by_segment_random <- addRandomSegments(data_by_segment, p = c(0.8, 0.2))
1480513972962:history_summaries <- lapply(
1480513972964:c('segment', grep('rand', names(data_by_segment_random), value = T)),
1480513972964:function(segment_var) {
1480513972965:calculateCampaignOpenRate(
1480513972965:dt = data_by_segment_random[bounced == FALSE],
1480513972966:by = c(segment_var, 'send_day')
1480513972966:) %>%
1480513972966:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480513972967:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480513972967:}
1480513972968:)
1480514163569:history_summaries %>%
1480514163570:rbindlist() %>%
1480514163571:plot_ly(x = send_day, y = relative_open_rate, color = segment) %>%
1480514163573:add_trace(
1480514163574:x = c(min(send_day), max(send_day)), y = c(1, 1),
1480514163577:mode = 'lines', line = list(dash = "dot", color = 'gray'), showlegend = FALSE
1480514163587:) %>%
1480514163587:layout(yaxis = list(range = c(0.95, 1.05)))
1480514169088:history_summaries
1480514178010:history_summaries %>%
1480514178011:rbindlist()
1480514183418:history_summaries %>%
1480514183418:rbindlist() %>%
1480514183419:plot_ly(x = send_day, y = relative_open_rate, color = segment)
1480514198197:history_summaries %>%
1480514198199:rbindlist() %>%
1480514198199:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment)
1480514220746:history_summaries %>%
1480514220748:rbindlist() %>%
1480514220748:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment, mode = 'lines')
1480514347811:history_summaries %>%
1480514347814:rbindlist() %>%
1480514347815:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment, type = 'scatter', mode = 'lines') %>%
1480514347816:add_trace(
1480514347817:x = c(min(send_day), max(send_day)), y = c(1, 1),
1480514347817:mode = 'lines', line = list(dash = "dot", color = 'gray'), showlegend = FALSE
1480514347818:)
1480514429553:?plotly::add_lines
1480514520568:history_summaries %>%
1480514520568:rbindlist() %>%
1480514520569:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment) %>%
1480514520571:add_lines() %>%
1480514520571:layout(yaxis = list(range = c(0.95, 1.05)))
1480514532356:history_summaries %>%
1480514532357:rbindlist() %>%
1480514532358:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment) %>%
1480514532358:add_lines() %>%
1480514532358:add_lines(y = 1) %>%
1480514532359:layout(yaxis = list(range = c(0.95, 1.05)))
1480514577895:history_summaries %>%
1480514577896:rbindlist() %>%
1480514577897:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment) %>%
1480514577898:add_lines() %>%
1480514577898:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE) %>%
1480514577898:layout(yaxis = list(range = c(0.95, 1.05)))
1480514595112:history_summaries %>%
1480514595121:rbindlist() %>%
1480514595121:plot_ly(x = ~send_day, y = ~relative_open_rate, color = ~segment) %>%
1480514595121:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE) %>%
1480514595121:add_lines() %>%
1480514595122:layout(yaxis = list(range = c(0.95, 1.05)))
1480514626729:data_by_segment[, .N, by =send_day]
1480514737460:data_by_segment_random[send_day < '2016-11-30']
1480515564300:source('global.R')
1480515565483:customer <- 'travelist_market'
1480515566284:id <- getIdFromName(customer)
1480515566834:segments <- c('REAL_AKT_80_CONTROL', 'REAL_AKT_20_STO')
1480515567901:getContactlistId <- function(contactlist_name) {
1480515567901:getSqlResult(
1480515567902:query = paste0("SELECT id
1480515567903:FROM userlists
1480515567903:WHERE customer = #{customer_id}
1480515567903:AND name = '", contactlist_name, "'"),
1480515567904:database_name = SETTINGS[[customer]]$suite,
1480515567904:customer_id = id
1480515567905:) %>% .[, id]
1480515567905:}
1480515568174:getListOfContacts <- function(contactlist_id) {
1480515568175:getSqlResult(
1480515568176:query = "SELECT user_id as contact_id
1480515568176:FROM ul_#{customer_id}_#{userlist_id};",
1480515568177:database_name = SETTINGS[[customer]]$suite,
1480515568177:customer_id = id,
1480515568178:userlist_id = contactlist_id
1480515568178:)
1480515568178:}
1480515568579:createStringValuesForSQLWith <- function(dt) {
1480515568580:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480515568582:paste(collapse = ',')
1480515568583:}
1480515569916:contacts_by_segment <- lapply(0:1, function(i) {
1480515569917:segments[i + 1] %>%
1480515569917:getContactlistId() %>%
1480515569918:getListOfContacts() %>%
1480515569918:.[, sto := i]
1480515569918:}) %>% rbindlist()
1480515624922:customre <- 'lingualeo'
1480515626353:id <- getIdFromName(customer)
1480515627706:segments <- c('STO-CONTROL', 'STO-TEST')
1480515628974:getContactlistId <- function(contactlist_name) {
1480515628977:getSqlResult(
1480515628977:query = paste0("SELECT id
1480515628978:FROM userlists
1480515628978:WHERE customer = #{customer_id}
1480515628978:AND name = '", contactlist_name, "'"),
1480515628978:database_name = SETTINGS[[customer]]$suite,
1480515628979:customer_id = id
1480515628979:) %>% .[, id]
1480515628979:}
1480515630566:getListOfContacts <- function(contactlist_id) {
1480515630568:getSqlResult(
1480515630568:query = "SELECT user_id as contact_id
1480515630569:FROM ul_#{customer_id}_#{userlist_id};",
1480515630570:database_name = SETTINGS[[customer]]$suite,
1480515630570:customer_id = id,
1480515630571:userlist_id = contactlist_id
1480515630571:)
1480515630571:}
1480515632515:createStringValuesForSQLWith <- function(dt) {
1480515632516:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480515632517:paste(collapse = ',')
1480515632518:}
1480515633499:contacts_by_segment <- lapply(0:1, function(i) {
1480515633500:segments[i + 1] %>%
1480515633503:getContactlistId() %>%
1480515633504:getListOfContacts() %>%
1480515633504:.[, sto := i]
1480515633505:}) %>% rbindlist()
1480515645140:segmetns
1480515650069:segments
1480515742700:segments <- c('STO-TEST-CONTROL', 'STO-TEST')
1480515743734:getContactlistId <- function(contactlist_name) {
1480515743735:getSqlResult(
1480515743735:query = paste0("SELECT id
1480515743736:FROM userlists
1480515743736:WHERE customer = #{customer_id}
1480515743736:AND name = '", contactlist_name, "'"),
1480515743737:database_name = SETTINGS[[customer]]$suite,
1480515743737:customer_id = id
1480515743737:) %>% .[, id]
1480515743738:}
1480515744231:getListOfContacts <- function(contactlist_id) {
1480515744231:getSqlResult(
1480515744232:query = "SELECT user_id as contact_id
1480515744232:FROM ul_#{customer_id}_#{userlist_id};",
1480515744233:database_name = SETTINGS[[customer]]$suite,
1480515744233:customer_id = id,
1480515744234:userlist_id = contactlist_id
1480515744234:)
1480515744234:}
1480515745082:createStringValuesForSQLWith <- function(dt) {
1480515745083:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480515745083:paste(collapse = ',')
1480515745084:}
1480515745812:contacts_by_segment <- lapply(0:1, function(i) {
1480515745813:segments[i + 1] %>%
1480515745813:getContactlistId() %>%
1480515745814:getListOfContacts() %>%
1480515745814:.[, sto := i]
1480515745814:}) %>% rbindlist()
1480515760691:getContactlistId(segments[1])
1480516481856:getSegmentId <- function(segment_name) {
1480516481856:getSqlResult(
1480516481857:query = paste0("SELECT id
1480516481857:FROM ugroup_definitions
1480516481857:WHERE customer = #{customer_id}
1480516481858:AND name = '", segment_name, "'"),
1480516481858:database_name = SETTINGS[[customer]]$suite,
1480516481858:customer_id = id
1480516481859:) %>% .[, id]
1480516481859:}
1480516483353:getContactlistId <- function(contactlist_name = NULL, segment_id = NULL) {
1480516483355:if (!is.null(segment_id)) {
1480516483356:query_end = paste0("AND ugroup_def = ", segment_id)
1480516483356:} else if (!is.null(name)) {
1480516483356:query_end = paste0("AND name = '", contactlist_name, "'")
1480516483357:} else {
1480516483357:stop('Please specify either contactlist name or segment id')
1480516483357:}
1480516483358:getSqlResult(
1480516483358:query = paste0("SELECT id
1480516483359:FROM userlists
1480516483359:WHERE customer = #{customer_id}"
1480516483360:query_end),
1480516483360:database_name = SETTINGS[[customer]]$suite,
1480516483361:customer_id = id
1480516483361:) %>% .[, id]
1480516483362:}
1480516484098:getListOfContacts <- function(contactlist_id) {
1480516484098:getSqlResult(
1480516484099:query = "SELECT user_id as contact_id
1480516484100:FROM ul_#{customer_id}_#{userlist_id};",
1480516484100:database_name = SETTINGS[[customer]]$suite,
1480516484101:customer_id = id,
1480516484101:userlist_id = contactlist_id
1480516484101:)
1480516484102:}
1480516484996:createStringValuesForSQLWith <- function(dt) {
1480516484996:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480516484997:paste(collapse = ',')
1480516484998:}
1480516606224:source('global.R')
1480516795090:source('global.R')
1480516797063:customer <- 'lingualeo'
1480516797948:id <- getIdFromName(customer)
1480516848347:getSegmentId <- function(customer, segment_name) {
1480516848347:getSqlResult(
1480516848348:query = paste0("SELECT id
1480516848349:FROM ugroup_definitions
1480516848349:WHERE customer = #{customer_id}
1480516848350:AND name = '", segment_name, "'"),
1480516848350:database_name = SETTINGS[[customer]]$suite,
1480516848351:customer_id = getIdFromName(customer)
1480516848352:) %>% .[, id]
1480516848353:}
1480516849532:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480516849533:if (!is.null(segment_id)) {
1480516849534:query_end = paste0("AND ugroup_def = ", segment_id)
1480516849536:} else if (!is.null(name)) {
1480516849537:query_end = paste0("AND name = '", contactlist_name, "'")
1480516849538:} else {
1480516849540:stop('Please specify either contactlist name or segment id')
1480516849541:}
1480516849543:getSqlResult(
1480516849544:query = paste0("SELECT id
1480516849544:FROM userlists
1480516849545:WHERE customer = #{customer_id}"
1480516849545:query_end),
1480516849546:database_name = SETTINGS[[customer]]$suite,
1480516849547:customer_id = getIdFromName(customer)
1480516849563:) %>% .[, id]
1480516849563:}
1480516887234:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480516887235:if (!is.null(segment_id)) {
1480516887235:query_end = paste0("AND ugroup_def = ", segment_id)
1480516887236:} else if (!is.null(name)) {
1480516887237:query_end = paste0("AND name = '", contactlist_name, "'")
1480516887237:} else {
1480516887238:stop('Please specify either contactlist name or segment id')
1480516887238:}
1480516887241:getSqlResult(
1480516887242:query = paste0("SELECT id
1480516887243:FROM userlists
1480516887245:WHERE customer = #{customer_id}",
1480516887246:query_end),
1480516887248:database_name = SETTINGS[[customer]]$suite,
1480516887248:customer_id = getIdFromName(customer)
1480516887249:) %>% .[, id]
1480516887250:}
1480516890124:getListOfContacts <- function(customer, contactlist_id) {
1480516890130:getSqlResult(
1480516890130:query = "SELECT user_id as contact_id
1480516890131:FROM ul_#{customer_id}_#{userlist_id};",
1480516890133:database_name = SETTINGS[[customer]]$suite,
1480516890134:customer_id = getIdFromName(customer),
1480516890136:userlist_id = contactlist_id
1480516890139:)
1480516890141:}
1480516899077:getSegmentId(SETTINGS[[customer]]$segments[1])
1480516905287:getSegmentId(customer, SETTINGS[[customer]]$segments[1])
1480516949809:getContactlistId(customer, segment_id = 330743)
1480516968175:debug(getContactlistId)
1480516969110:getContactlistId(customer, segment_id = 330743)
1480516987491:getSqlResult(
1480516987492:query = paste0("SELECT id
1480516987493:FROM userlists
1480516987494:WHERE customer = #{customer_id}",
1480516987494:query_end),
1480516987494:database_name = SETTINGS[[customer]]$suite,
1480516987495:customer_id = getIdFromName(customer)
1480516987495:)
1480517041434:source('global.R')
1480517042632:customer <- 'lingualeo'
1480517043707:getSegmentId <- function(customer, segment_name) {
1480517043708:getSqlResult(
1480517043710:query = paste0("SELECT id
1480517043711:FROM ugroup_definitions
1480517043712:WHERE customer = #{customer_id}
1480517043713:AND name = '", segment_name, "'"),
1480517043713:database_name = SETTINGS[[customer]]$suite,
1480517043714:customer_id = getIdFromName(customer)
1480517043714:) %>% .[, id]
1480517043715:}
1480517044441:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480517044442:if (!is.null(segment_id)) {
1480517044443:query_end = paste0("AND ugroup_def = ", segment_id)
1480517044443:} else if (!is.null(name)) {
1480517044444:query_end = paste0("AND name = '", contactlist_name, "'")
1480517044445:} else {
1480517044446:stop('Please specify either contactlist name or segment id')
1480517044447:}
1480517044447:getSqlResult(
1480517044448:query = paste0("SELECT id
1480517044448:FROM userlists
1480517044449:WHERE customer = #{customer_id}",
1480517044449:query_end),
1480517044450:database_name = SETTINGS[[customer]]$suite,
1480517044450:customer_id = getIdFromName(customer)
1480517044451:) %>% .[, id]
1480517044452:}
1480517045129:getListOfContacts <- function(customer, contactlist_id) {
1480517045130:getSqlResult(
1480517045131:query = "SELECT user_id as contact_id
1480517045131:FROM ul_#{customer_id}_#{userlist_id};",
1480517045131:database_name = SETTINGS[[customer]]$suite,
1480517045132:customer_id = getIdFromName(customer),
1480517045132:userlist_id = contactlist_id
1480517045133:)
1480517045133:}
1480517046223:createStringValuesForSQLWith <- function(dt) {
1480517046224:dt[, paste0('(', paste(contact_id, sto, sep = ','), ')')] %>%
1480517046225:paste(collapse = ',')
1480517046227:}
1480517068018:getSegmentId(customer, SETTINGS[[customer]]$segments[1])
1480517089445:getSegmentId(customer, SETTINGS[[customer]]$segments[1])
1480517106445:getContactlistId(customer, segment_id = 330743)
1480517155765:getIdFromName('lingualeo')
1480517204280:debug(getContactlistId)
1480517207190:getContactlistId(customer, segment_id = 330743)
1480517219771:paste0("SELECT id
1480517219773:FROM userlists
1480517219773:WHERE customer = #{customer_id}",
1480517219774:query_end)
1480517226243:paste0("SELECT id
1480517226243:FROM userlists
1480517226244:WHERE customer = #{customer_id}",
1480517226244:query_end)
1480517251922:getSegmentId <- function(customer, segment_name) {
1480517251924:getSqlResult(
1480517251924:query = paste0("SELECT id
1480517251926:FROM ugroup_definitions
1480517251927:WHERE customer = #{customer_id}
1480517251927:AND name = '", segment_name, "'"),
1480517251928:database_name = SETTINGS[[customer]]$suite,
1480517251929:customer_id = getIdFromName(customer)
1480517251929:) %>% .[, id]
1480517251930:}
1480517253238:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480517253240:if (!is.null(segment_id)) {
1480517253241:query_end = paste("AND ugroup_def =", segment_id)
1480517253242:} else if (!is.null(name)) {
1480517253243:query_end = paste("AND name ='", contactlist_name, "'")
1480517253244:} else {
1480517253246:stop('Please specify either contactlist name or segment id')
1480517253249:}
1480517253250:getSqlResult(
1480517253251:query = paste0("SELECT id
1480517253253:FROM userlists
1480517253254:WHERE customer = #{customer_id}",
1480517253255:query_end),
1480517253256:database_name = SETTINGS[[customer]]$suite,
1480517253257:customer_id = getIdFromName(customer)
1480517253257:) %>% .[, id]
1480517253258:}
1480517263289:getContactlistId(customer, segment_id = 330743)
1480517279478:t
1480517280825:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480517280826:if (!is.null(segment_id)) {
1480517280827:query_end = paste("AND ugroup_def =", segment_id)
1480517280827:} else if (!is.null(name)) {
1480517280828:query_end = paste("AND name ='", contactlist_name, "'")
1480517280829:} else {
1480517280829:stop('Please specify either contactlist name or segment id')
1480517280830:}
1480517280831:getSqlResult(
1480517280831:query = paste("SELECT id
1480517280832:FROM userlists
1480517280832:WHERE customer = #{customer_id}",
1480517280833:query_end),
1480517280834:database_name = SETTINGS[[customer]]$suite,
1480517280834:customer_id = getIdFromName(customer)
1480517280835:) %>% .[, id]
1480517280835:}
1480517285001:getContactlistId(customer, segment_id = 330743)
1480517409592:lapply(SETTINGS[[customer]]$segments, getSegmentId, customer = customer)
1480517630496:getDataForSegments <- function(customer) {
1480517630497:if (SETTINGS[[customer]]$random_type == 'segment') {
1480517630498:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480517630498:getSegmentId(customer, s) %>% getContactlistId(customer, segment_id = .)
1480517630499:})
1480517630500:} else {
1480517630501:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480517630502:getContactlistId(customer, contactlist_name = s)
1480517630503:})
1480517630504:}
1480517630504:contacts_by_segment <- lapply(0:1, function(i) {
1480517630505:getListOfContacts(clist_ids[i + 1])[, sto := i]
1480517630506:}) %>% rbindlist()
1480517630506:# data_by_segment <- readSqlResultLocal(
1480517630507:#     file_name = 'sql/random_segment_check.sql',
1480517630508:#     data_file = paste0(customer, '_random_segment_history.csv'),
1480517630509:#     customer_id = id,
1480517630510:#     values_string = createStringValuesForSQLWith(contacts_by_segment),
1480517630510:#     refetch = TRUE
1480517630511:# )
1480517630511:}
1480517637096:getDataForSegments('lingualeo')
1480517658588:debug(getDataForSegments)
1480517659720:getDataForSegments('lingualeo')
1480517672927:clist_ids
1480517687394:getListOfContacts(clist_ids[1])
1480517693300:getListOfContacts(clist_ids[[1])
1480517697150:getListOfContacts(clist_ids[[1][1])
1480517703261:getListOfContacts(clist_ids[[1]])
1480517705651:getListOfContacts(clist_ids[[1]][1])
1480517711244:clist_ids[[1]]
1480517713050:clist_ids[[1]][1]
1480517714731:clist_ids[[1]]
1480517740682:getListOfContacts('lingualeo', clist_ids[[1]])
1480517746419:getDataForSegments <- function(customer) {
1480517746420:if (SETTINGS[[customer]]$random_type == 'segment') {
1480517746421:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480517746421:getSegmentId(customer, s) %>% getContactlistId(customer, segment_id = .)
1480517746423:})
1480517746424:} else {
1480517746426:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480517746427:getContactlistId(customer, contactlist_name = s)
1480517746429:})
1480517746431:}
1480517746432:contacts_by_segment <- lapply(0:1, function(i) {
1480517746433:getListOfContacts(customer, clist_ids[[i + 1]])[, sto := i]
1480517746433:}) %>% rbindlist()
1480517746434:# data_by_segment <- readSqlResultLocal(
1480517746435:#     file_name = 'sql/random_segment_check.sql',
1480517746436:#     data_file = paste0(customer, '_random_segment_history.csv'),
1480517746437:#     customer_id = id,
1480517746438:#     values_string = createStringValuesForSQLWith(contacts_by_segment),
1480517746438:#     refetch = TRUE
1480517746440:# )
1480517746440:}
1480517753055:getDataForSegments('lingualeo')
1480517780325:getDataForSegments('lingualeo') %>% print()
1480517797335:getDataForSegments('lingualeo') %>% .[, .N, by = sto]
1480517811605:getDataForSegments('travelist') %>% .[, .N, by = sto]
1480517815981:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480517842732:debug(getDataForSegments)
1480517844050:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480517857579:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480517870177:SETTINGS[[customer]]$segments
1480517894100:getContactlistId(customer, SETTINGS[[custome]]$segments[1])
1480517902178:getContactlistId(customer, contactlist_name = SETTINGS[[custome]]$segments[1])
1480517908245:getContactlistId(customer, SETTINGS[[custome]]$segments[1])
1480517929455:debug(getContactlistId)
1480517931323:getContactlistId(customer, SETTINGS[[custome]]$segments[1])
1480517967771:getContactlistId(customer, SETTINGS[[custome]]$segments[1])
1480517989442:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480517989442:if (!is.null(segment_id)) {
1480517989443:query_end = paste("AND ugroup_def =", segment_id)
1480517989444:} else if (!is.null(contactlist_name)) {
1480517989444:query_end = paste("AND name ='", contactlist_name, "'")
1480517989445:} else {
1480517989445:stop('Please specify either contactlist name or segment id')
1480517989446:}
1480517989446:getSqlResult(
1480517989447:query = paste("SELECT id
1480517989448:FROM userlists
1480517989448:WHERE customer = #{customer_id}",
1480517989449:query_end),
1480517989450:database_name = SETTINGS[[customer]]$suite,
1480517989451:customer_id = getIdFromName(customer)
1480517989452:) %>% .[, id]
1480517989453:}
1480517998210:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480518008214:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480518016166:clist_ids
1480518055564:getContactListId('travelist_market', contactlist_name = 'REAL_AKT_80_CONTROL')
1480518062922:getContactlistId('travelist_market', contactlist_name = 'REAL_AKT_80_CONTROL')
1480518178259:debug(getContactlistId)
1480518179504:getContactlistId('travelist_market', contactlist_name = 'REAL_AKT_80_CONTROL')
1480518192009:paste("SELECT id
1480518192010:FROM userlists
1480518192010:WHERE customer = #{customer_id}",
1480518192011:query_end)
1480518240435:getContactlistId <- function(customer, contactlist_name = NULL, segment_id = NULL) {
1480518240436:if (!is.null(segment_id)) {
1480518240437:query_end = paste0("AND ugroup_def = ", segment_id)
1480518240437:} else if (!is.null(contactlist_name)) {
1480518240438:query_end = paste0("AND name = '", contactlist_name, "'")
1480518240438:} else {
1480518240439:stop('Please specify either contactlist name or segment id')
1480518240439:}
1480518240440:getSqlResult(
1480518240441:query = paste("SELECT id
1480518240442:FROM userlists
1480518240443:WHERE customer = #{customer_id}",
1480518240445:query_end),
1480518240446:database_name = SETTINGS[[customer]]$suite,
1480518240447:customer_id = getIdFromName(customer)
1480518240447:) %>% .[, id]
1480518240448:}
1480518246937:undebug(getDataForSegments)
1480518254840:getDataForSegments('travelist_market')
1480518264920:getDataForSegments('travelist_market') %>% .[, .N, by = sto]
1480518296391:customer <- 'lingualeo'
1480518299626:data_by_segment <- getDataForSegments(customer)
1480518329993:source('global.R')
1480518333671:customer <- 'lingualeo'
1480518334999:data_by_segment <- getDataForSegments(customer)
1480518364084:getDataForSegments <- function(customer) {
1480518364085:if (SETTINGS[[customer]]$random_type == 'segment') {
1480518364086:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480518364086:getSegmentId(customer, s) %>% getContactlistId(customer, segment_id = .)
1480518364086:})
1480518364087:} else {
1480518364087:clist_ids <- lapply(SETTINGS[[customer]]$segments, function(s) {
1480518364087:getContactlistId(customer, contactlist_name = s)
1480518364088:})
1480518364088:}
1480518364089:contacts_by_segment <- lapply(0:1, function(i) {
1480518364089:getListOfContacts(customer, clist_ids[[i + 1]])[, sto := i]
1480518364089:}) %>% rbindlist()
1480518364090:data_by_segment <- readSqlResultLocal(
1480518364090:file_name = 'sql/random_segment_check.sql',
1480518364090:data_file = paste0(customer, '_random_segment_history.csv'),
1480518364091:customer_id = getIdFromName(customer),
1480518364092:values_string = createStringValuesForSQLWith(contacts_by_segment),
1480518364092:refetch = TRUE
1480518364093:)
1480518364093:}
1480518367584:data_by_segment <- getDataForSegments(customer)
1480518656442:data_by_segment
1480518678043:data_by_segment[, segment := c('control', 'sto')[sto + 1]]  # much faster then ifelse()
1480518682955:data_by_segment[, .N, by = segment]
1480518685881:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1480518686934:.[, mean(open_rate), by = segment]
1480518691325:addRandomSegments <- function(dt, n = 5, p = c(0.5, 0.5)) {
1480518691330:random_names <- sapply(1:n, function(i) paste0('rand', i))
1480518691332:unique(dt[, .(contact_id)]) %>%
1480518691333:.[, (random_names) := replicate(
1480518691334:n,
1480518691335:sample(c('control', 'sto'), size = .N, replace = TRUE, prob = p),
1480518691335:simplify = FALSE
1480518691336:)] %>%
1480518691338:merge(dt, ., by = 'contact_id')
1480518691339:}
1480518693102:data_by_segment_random <- addRandomSegments(data_by_segment, p = c(0.8, 0.2))
1480518696204:history_summaries <- lapply(
1480518696875:c('segment', grep('rand', names(data_by_segment_random), value = T)),
1480518697319:function(segment_var) {
1480518697320:calculateCampaignOpenRate(
1480518697321:dt = data_by_segment_random[bounced == FALSE],
1480518697322:by = c(segment_var, 'send_day')
1480518697322:) %>%
1480518697323:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480518697323:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480518697324:}
1480518697651:)
1480518702104:history_summaries %>%
1480518702537:rbindlist() %>%
1480518702958:plot_ly(x = ~send_day) %>%
1480518703403:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE) %>%
1480518703834:add_lines() %>%
1480518704275:layout(yaxis = list(range = c(0.95, 1.05)))
1480518730379:history_summaries %>%
1480518730380:rbindlist() %>%
1480518730381:plot_ly(x = ~send_day) %>%
1480518730381:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE) %>%
1480518730382:add_lines(y = ~relative_open_rate) %>%
1480518730382:layout(yaxis = list(range = c(0.95, 1.05)))
1480518741523:history_summaries %>%
1480518741524:rbindlist() %>%
1480518741524:plot_ly(x = ~send_day) %>%
1480518741525:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE) %>%
1480518741525:add_lines(y = ~relative_open_rate, color = ~segment) %>%
1480518741525:layout(yaxis = list(range = c(0.95, 1.05)))
1480518762070:history_summaries %>%
1480518762071:rbindlist() %>%
1480518762072:plot_ly(x = ~send_day) %>%
1480518762072:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1480518762073:add_lines(y = ~relative_open_rate, color = ~segment) %>%
1480518762073:layout(yaxis = list(range = c(0.95, 1.05)))
1480518780260:history_summaries %>%
1480518780262:rbindlist() %>%
1480518780263:plot_ly(x = ~send_day) %>%
1480518780263:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1480518780263:add_lines(y = ~relative_open_rate, color = ~segment) %>%
1480518780264:layout(yaxis = list(range = c(0.9, 1.1)))
1480518811436:history_summaries
1480518841896:calculateCampaignOpenRate(data_by_segment[bounced == F], by = c('segment', 'send_day'))
1480579719696:source('global.R')
1480579721181:customer <- 'batiwiz'
1480579722581:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1480582903062:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480587901887:first_sto_campaigns <- c(620608, 620629)
1480587904447:campaign_ids_1111 <- c(875502, 875540)
1480587906875:campaigns_to_restrict <- campaign_ids_1111
1480587907346:contacts_to_restrict <- customer_data$campaign_data[
1480587907346:campaign_id %in% campaigns_to_restrict,
1480587907347:.(segment, contact_id)
1480587907347:]
1480587909881:contacts_to_restrict_first <- customer_data$campaign_data[
1480587909882:campaign_id %in% first_sto_campaigns,
1480587909883:.(segment, contact_id)
1480587909883:]
1480587911150:contacts_to_restrict_last <- customer_data$campaign_data[
1480587911151:campaign_id %in% campaign_ids_1111,
1480587911152:.(segment, contact_id)
1480587911152:]
1480587912385:contacts_to_restrict <- merge(contacts_to_restrict_first, contacts_to_restrict_last, by = c('contact_id', 'segment'))
1480587915377:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1480587942934:if (customer == 'batiwiz') {
1480587942935:# intersection with sto campaigns, pair of control campaign
1480587942936:all_data <- all_data[! campaign_id %in% c(667052, 617331)]
1480587942936:}
1480587949266:contacts_to_restrict <- all_data[period == 'past', .N, by = .(segment, contact_id)][N >= 70, .(segment, contact_id)]
1480587951236:all_data <- addPastData(customer, customer_data, contacts_to_restrict, refetch = FALSE)
1480587975969:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto']) +
1480587975971:labs(y = 'Number of sends', x = 'Day') + scale_fill_discrete(guide = guide_legend('Send hour', nrow = 1)) + theme(legend.position = 'bottom')
1480587994651:campaign_summary <- calculateSummary(all_data)
1480587996846:plotOpenRateEvolutionWithPast(campaign_summary)
1480588015256:campaign_summary
1480588021652:campaign_summary[segment == 'control']
1480588028362:campaign_summary[segment == 'control'][order(send_day)]
1480588072194:customer_data$campaigns
1480588093342:customer_data$campaigns[send_day == '2016-11-25']
1480588131314:campaign_summary %>%
1480588131314:ggplot(aes(send_day, open_rate, color = segment)) +
1480588131315:geom_line() +
1480588131315:addSTOline(text_position = 0.18) +
1480588131316:geom_smooth(span = 0.3) +
1480588131316:labs(x = 'Day', y = 'Open rate') +
1480588131316:theme(legend.position = 'bottom')
1480588139695:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9) +
1480588139695:labs(x = 'Send day', y = 'Relative open rate') +
1480588139696:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480588139697:theme(legend.position = 'bottom')
1480588202254:customer_data$campaign_data
1480588234166:customer_data$campaign_data[bounced == F, mean(opened), by = .(segment, send_day, campaign_id)]
1480588256165:customer_data$campaign_data[bounced == F, mean(opened), by = .(segment, send_day, campaign_id)][send_day > '2016-11-20']
1480588321877:customer_data$campaign_data[bounced == F, .(open_rate = mean(opened), .N), by = .(segment, send_day, campaign_id)][send_day > '2016-11-20']
1480589743483:customer_data$campaigns[send_day == '2016-11-25']
1480596882694:source('global.R')
1480596883943:customer <- 'travelist_market'
1480596888774:data_by_segment <- getDataForSegments(customer)
1480600564900:library(data.table)
1480600664179:update.packages()
1480604715269:packrat::restore(prompt = FALSE)
1480604769095:data_by_segment[, segment := c('control', 'sto')[sto + 1]]  # much faster then ifelse()
1480605048352:data_by_segment[, .N, by = segment]
1480605052505:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1480605052508:.[, mean(open_rate), by = segment]
1480605119774:calculateSummary <- function(data, segment_var = 'segment') {
1480605119776:calculateCampaignOpenRate(
1480605119776:dt = data[bounced == FALSE],
1480605119777:by = c(segment_var, 'send_day')
1480605119777:) %>%
1480605119778:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480605119778:.[, `:=`(relative_open_rate = sto/control, segment = segment_var)]
1480605119779:}
1480605210350:calculateSummary(data_by_segment)
1480605333469:summary <- calculateSummary(data_by_segment)
1480606099180:summary %>%
1480606099185:plot_ly(x = ~send_day) %>%
1480606099186:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1480606099188:add_lines(y = ~relative_open_rate, color = ~segment) %>%
1480606099190:layout(yaxis = list(range = c(0.9, 1.1)))
1480606138874:summary %>%
1480606138875:plot_ly(x = ~send_day) %>%
1480606138876:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1480606138877:add_lines(y = ~relative_open_rate, color = ~segment) %>%
1480606138878:layout(yaxis = list(range = c(0.95, 1.05)))
1480606168061:summary %>%
1480606168062:plot_ly(x = ~send_day) %>%
1480606168063:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1480606168063:add_lines(y = ~relative_open_rate, color = ~segment, showlegend = FALSE) %>%
1480606168063:layout(yaxis = list(range = c(0.95, 1.05)))
1480606383634:install.packages('webshot')
1480606458755:library(webshot)
1480606475183:summary %>%
1480606475183:plotRelativeEvolution()
1480606489173:summary %>%
1480606489175:plotRelativeEvolution(variable = 'relative_open_rate')
1480606568106:calculateSummary <- function(data, segment_var = 'segment') {
1480606568107:calculateCampaignOpenRate(
1480606568108:dt = data[bounced == FALSE],
1480606568109:by = c(segment_var, 'send_day')
1480606568109:) %>%
1480606568110:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1480606568111:.[, `:=`(relative_measure = sto/control, segment = segment_var)]
1480606568112:}
1480606580204:summary
1480606597884:setnames(summary, c('send_day', 'control', 'sto', 'relative_measure', 'segment'))
1480606602312:summary %>%
1480606602312:plotRelativeEvolution()
1480606622972:summary %>% plotRelativeEvolution(text = FALSE, prior_change_dates = FALSE)
1480606638064:summary %>% plotRelativeEvolution(text = FALSE, prior_change_dates = FALSE, trendlines = FALSE)
1480667622603:source('global.R')
1480667626826:customer <- 'lingualeo'
1480667640706:source('global.R')
1480667673912:q()
1480667734228:source('global.R')
1480667737630:customer <- 'lingualeo'
1480667739644:data_by_segment <- getDataForSegments(customer)
1480667830263:source('global.R')
1480667833995:data_by_segment <- getDataForSegments(customer)
1480667879447:data.table(contact_id = NULL, sto = NULL)
1480667889246:data.table(contact_id = NA, sto = NA)
1480667896890:?data.table
1480667940864:data.table(contact_id, sto)
1480667951574:data.table(contact_id=(), sto=())
1480667962667:data.table(contact_id=1, sto=1)[0]
1480667976771:source('global.R')
1480667977986:customer <- 'lingualeo'
1480667979243:data_by_segment <- getDataForSegments(customer)
1480668374717:source('global.R')
1480668376766:data_by_segment <- getDataForSegments(customer)
1480668386307:customer <- 'travelist_market'
1480668406941:data_by_segment <- getDataForSegments(customer)
1480668466072:debug(getDataForSegments)
1480668467610:data_by_segment <- getDataForSegments(customer)
1480668496086:debug(readSqlFile)
1480668521540:undebug(getDataForSegments)
1480668525487:readSqlResult()
1480668527219:readSqlResult
1480668552866:debug(readSqlResult)
1480668555966:data_by_segment <- getDataForSegments(customer)
1480668568978:fpath
1480668770821:source('global.R')
1480668773534:data_by_segment <- getDataForSegments(customer)
1480668868857:data_by_segment
1480668986602:customer <- 'batiwiz'
1480668988336:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1480669002384:undebug(readSqlResult)
1480669011541:undebug(readSqlFile)
1480669014377:customer_data <- getCampaignDataForCustomer(customer, refetch = TRUE)
1480669979016:customer_data
1480669995469:customer_data$campaigns
1480670000072:customer_data$campaign_data
1480670131221:customer_data$campaigns
1480670133048:customer_data
1480671980032:q()
1480672021892:customer <- 'batiwiz'
1480672049703:segment_name <- 'TD120EXCSTO'
1480672060957:source('global.R')
1480672110581:getSqlResult('sql/campaigns_to_segment.sql', customer_id = getIdFromName(customer), segment_name = segment_name, start_date = '2016-09-01')
1480672141198:getSqlResult('sql/campaigns_to_segment.sql', customer_id = getIdFromName(customer), segment_name = segment_name, start_date = '2016-09-01', database_name = SETTINGS[[customer]]$suite)
1480672178300:getSqlResult('sql/campaigns_to_segment.sql', customer_id = getIdFromName(customer), segment_name = segment_name, start_date = '2016-09-01', database_name = SETTINGS[[customer]]$suite)
1480672651244:getIdFromName('edigital')
1480673834487:queryListOfCampaigns('batiwiz')
1480673872507:queryListOfCampaigns('batiwiz', SETTINGS[[customer]]$independent)
1480676429429:sessionInfo()
1480676435704:library(purrr)
1480676543047:map(c(1,2,3), ~ `+`(10, .))
1480676572229:map(c(1,2,3), ~ `+`(10, .) %>% `-`(20, .))
1480676743335:source('global.R')
1480676980425:source('global.R')
1480676994516:source('global.R')
1480676998414:customer <- 'lingualeo'
1480677017034:program <- 'test'
1480677018377:data_by_segment <- getDataForSegments(customer, program)
1480677066319:source('global.R')
1480677069168:data_by_segment <- getDataForSegments(customer, program)
1480677097610:data_by_segment <- getDataForSegments(customer, program, refetch = TRUE)
1480677318998:data_by_segment <- getDataForSegments(customer, program, refetch = TRUE)
1480677372122:source('global.R')
1480677373600:customer <- 'lingualeo'
1480677374267:program <- 'test'
1480677375771:data_by_segment <- getDataForSegments(customer, program, refetch = FALSE)
1480677407673:debug(readSqlResult)
1480677412008:data_by_segment <- getDataForSegments(customer, program, refetch = FALSE)
1480677428506:fpath
1480677483868:source('global.R')
1480677485811:data_by_segment <- getDataForSegments(customer, program, refetch = FALSE)
1480677852397:getCampaignsForProgram <- function(customer, program, start_date) {
1480677852399:program_properties <- SETTINGS[[customer]][['programs']][[program]]
1480677852400:readSqlResult(
1480677852400:sql_file = 'sql/campaigns_for_segment.sql',
1480677852400:customer_id = getIdFromName(customer),
1480677852401:start_date = start_date,
1480677852401:segment_name = program_properties[['names']][['sto']]
1480677852402:)
1480677852403:}
1480677876272:getCampaignsForProgram(customer, program)
1480677892378:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480678813493:devtools::document()
1480679594109:install.packages('emsconnectr', type = 'source')
1480679638916:devtools::install_github('rstats-db/bigrquery')
1480679692802:install.packages('emsconnectr', type = 'source')
1480679733193:packrat::snapshot(prompt = FALSE)
1480679849943:source('global.R')
1480679854731:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480679857929:customer <- 'lingualeo'
1480679858267:program <- 'test'
1480679861083:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480680140963:source('global.R')
1480680143916:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480680200969:program
1480680235453:debug(readSqlResult)
1480680238169:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480680316198:getCampaignsForProgram <- function(customer, program, start_date) {
1480680316198:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480680316200:readSqlResult(
1480680316200:sql_file = 'sql/campaigns_for_segment.sql',
1480680316201:database_name = SETTINGS[[customer]]$suite,
1480680316201:customer_id = getIdFromName(customer),
1480680316201:start_date = start_date,
1480680316202:segment_name = program_properties$names$sto
1480680316203:)
1480680316204:}
1480680323786:undebug(readSqlResult)
1480680325855:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480680371335:getCampaignsForProgram(customer, program, start_date = '2016-10-10')
1480680379433:getCampaignsForProgram(customer, program, start_date = '2016-10-10', refetch = TRUE)
1480680406488:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480680406488:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480680406489:readSqlResult(
1480680406490:sql_file = 'sql/campaigns_for_segment.sql',
1480680406491:database_name = SETTINGS[[customer]]$suite,
1480680406492:customer_id = getIdFromName(customer),
1480680406493:start_date = start_date,
1480680406494:segment_name = program_properties$names$sto,
1480680406495:refetch = refetch
1480680406495:)
1480680406496:}
1480680411788:getCampaignsForProgram(customer, program, start_date = '2016-10-10', refetch = TRUE)
1480680463605:getCampaignsForProgram('batiwiz', 'TD120', start_date = '2016-10-10', refetch = TRUE)
1480680479531:getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480680568186:customer <- 'batiwiz'
1480680569796:all_campaigns_old <- queryListOfCampaigns(customer, SETTINGS[[customer]]$independent) %>%
1480680569797:matchCampaignPairs(deduplicate = SETTINGS[[customer]]$deduplicate)
1480680590275:all_campaigns_old <- queryListOfCampaigns(customer, FALSE) %>%
1480680590275:matchCampaignPairs(deduplicate = TRUE)
1480680826562:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480680826563:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480680826564:map(
1480680826564:c('sto', 'control'),
1480680826565:~ readSqlResult(
1480680826565:sql_file = 'sql/campaigns_for_segment.sql',
1480680826566:database_name = SETTINGS[[customer]]$suite,
1480680826566:customer_id = getIdFromName(customer),
1480680826566:start_date = start_date,
1480680826566:segment_name = program_properties$names[[.]],
1480680826567:refetch = refetch
1480680826567:) %>%
1480680826567:.[, segment := .x]
1480680826568:)
1480680826568:}
1480680834746:getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480680848740:sessionInfo()
1480680934787:source('global.R')
1480680941081:getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480680962875:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480680967134:a
1480681009440:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480681009441:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480681009442:map(
1480681009442:c('sto', 'control'),
1480681009442:~ readSqlResult(
1480681009443:sql_file = 'sql/campaigns_for_segment.sql',
1480681009443:database_name = SETTINGS[[customer]]$suite,
1480681009444:customer_id = getIdFromName(customer),
1480681009444:start_date = start_date,
1480681009445:segment_name = program_properties$names[[.]],
1480681009445:refetch = refetch
1480681009446:)
1480681009446:)
1480681009447:}
1480681012612:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480681033605:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480681037164:a
1480681279138:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480681279139:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480681279139:map(
1480681279140:c('sto', 'control'),
1480681279141:~ readSqlResult(
1480681279141:sql_file = 'sql/campaigns_for_segment.sql',
1480681279142:database_name = SETTINGS[[customer]]$suite,
1480681279142:customer_id = getIdFromName(customer),
1480681279143:start_date = start_date,
1480681279144:segment_name = program_properties$names[[.]],
1480681279144:refetch = refetch
1480681279145:)[, segment := .]
1480681279146:)
1480681279148:}
1480681282355:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480681285391:a
1480681333871:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480681333873:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480681333873:map(
1480681333874:c('sto', 'control'),
1480681333874:~ readSqlResult(
1480681333875:sql_file = 'sql/campaigns_for_segment.sql',
1480681333875:database_name = SETTINGS[[customer]]$suite,
1480681333876:customer_id = getIdFromName(customer),
1480681333876:start_date = start_date,
1480681333877:segment_name = program_properties$names[[.]],
1480681333877:refetch = refetch
1480681333878:)[, segment := .]
1480681333881:) %>% rbindlist()
1480681333882:}
1480681335911:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = TRUE)
1480681354015:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = FALSE)
1480681354871:a
1480681492511:getCampaignsForProgram <- function(customer, program, start_date, refetch) {
1480681492512:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480681492513:sapply(
1480681492513:c('sto', 'control'),
1480681492514:function(segment) {
1480681492514:readSqlResult(
1480681492515:sql_file = 'sql/campaigns_for_segment.sql',
1480681492515:database_name = SETTINGS[[customer]]$suite,
1480681492516:customer_id = getIdFromName(customer),
1480681492516:start_date = start_date,
1480681492517:segment_name = program_properties$names[[segment]],
1480681492518:refetch = refetch
1480681492519:)
1480681492520:},
1480681492522:simplify = FALSE
1480681492523:)
1480681492523:}
1480681496683:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-10-10', refetch = FALSE)
1480681497590:a
1480681623550:matchCampaignPairs <- function(campaigns) {
1480681623551:merge(campaigns$sto, campaigns$control, by = 'send_day', all = T) %>%
1480681623551:.[, .(
1480681623552:sto = campaign_id.x, control = campaign_id.y,
1480681623552:sto_name = campaign_name.x, control_name = campaign_name.y,
1480681623553:sto_segment = target_segment.x, control_segment = target_segment.y
1480681623553:)] %>%
1480681623553:.[order(sto)]
1480681623554:}
1480681628342:matchCampaignPairs(a)
1480681915282:getCampaignsForProgram(customer, program, start_date = '2016-06-01')
1480681921012:getCampaignsForProgram(customer, program, start_date = '2016-06-01', refetch = FALSE)
1480681993619:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-06-10', refetch = FALSE)
1480681997709:a
1480682506053:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = FALSE) {
1480682506054:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480682506055:map(
1480682506055:c('sto', 'control'),
1480682506056:~ readSqlResult(
1480682506057:sql_file = 'sql/campaigns_for_segment.sql',
1480682506058:database_name = SETTINGS[[customer]]$suite,
1480682506059:customer_id = getIdFromName(customer),
1480682506059:start_date = start_date,
1480682506060:segment_name = program_properties$names[[.]],
1480682506061:refetch = refetch
1480682506061:)[, segment := .]
1480682506063:) %>% rbindlist()
1480682506064:}
1480682512163:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-06-10', refetch = FALSE)
1480682513233:a
1480682858214:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-06-10', refetch = FALSE)
1480683172325:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1480683172327:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480683172328:map(
1480683172329:c('sto', 'control'),
1480683172331:~ readSqlResult(
1480683172332:sql_file = 'sql/campaigns_for_segment.sql',
1480683172334:database_name = SETTINGS[[customer]]$suite,
1480683172335:result_file_name = str_c(customer, program, 'campaigns', sep = '_')
1480683172335:customer_id = getIdFromName(customer),
1480683172336:start_date = start_date,
1480683172336:segment_name = program_properties$names[[.]],
1480683172337:refetch = refetch
1480683172338:)[, segment := .]
1480683172338:) %>% rbindlist()
1480683172339:}
1480683180182:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1480683180182:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480683180183:map(
1480683180184:c('sto', 'control'),
1480683180184:~ readSqlResult(
1480683180185:sql_file = 'sql/campaigns_for_segment.sql',
1480683180185:database_name = SETTINGS[[customer]]$suite,
1480683180186:result_file_name = str_c(customer, program, 'campaigns', sep = '_'),
1480683180186:customer_id = getIdFromName(customer),
1480683180187:start_date = start_date,
1480683180188:segment_name = program_properties$names[[.]],
1480683180188:refetch = refetch
1480683180189:)[, segment := .]
1480683180190:) %>% rbindlist()
1480683180190:}
1480683185686:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-06-10', refetch = FALSE)
1480683215283:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1480683215284:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480683215285:map(
1480683215285:c('sto', 'control'),
1480683215286:~ readSqlResult(
1480683215287:sql_file = 'sql/campaigns_for_segment.sql',
1480683215287:database_name = SETTINGS[[customer]]$suite,
1480683215288:result_file_name = str_c(customer, program, ., 'campaigns', sep = '_'),
1480683215288:customer_id = getIdFromName(customer),
1480683215289:start_date = start_date,
1480683215289:segment_name = program_properties$names[[.]],
1480683215290:refetch = refetch
1480683215291:)[, segment := .]
1480683215292:) %>% rbindlist()
1480683215294:}
1480683218613:a <- getCampaignsForProgram('batiwiz', 'NA-TD120', start_date = '2016-06-10', refetch = FALSE)
1480683285920:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480683285923:all_campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480683285924:all_campaign_data <- readSqlResult(
1480683285925:sql_file = 'sql/opens_for_campaign_ids.sql',
1480683285925:result_file_name = str_c(customer, program, sep = '_'),
1480683285926:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480683285927:start_date = all_campaigns[, min(send_day)],
1480683285927:customer_id = getIdFromName(customer_name),
1480683285928:refetch = refetch
1480683285930:)
1480683285934:# campaigns <- addDatesToCampaigns(all_campaigns, all_campaign_data) %>%
1480683285936:#     excludeNonSTO(all_campaign_data) %>%
1480683285937:#     excludeRecentCampaigns()
1480683285940:# campaign_data <- keepRelevantCampaignsWithUnifiedSendDay(all_campaign_data, campaigns) %>%
1480683285941:#     addOpenedBounced_()
1480683285942:list(campaign_data = campaign_data, campaigns = campaigns)
1480683285943:}
1480683300543:customer
1480683302574:program
1480683307408:program <- 'TD120'
1480683318543:b <- getCampaignDataForCustomer()
1480683593052:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480683593053:all_campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480683593054:all_campaign_data <- readSqlResult(
1480683593054:sql_file = 'sql/opens_for_campaign_ids.sql',
1480683593054:result_file_name = str_c(customer, program, sep = '_'),
1480683593055:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480683593055:start_date = all_campaigns[, min(send_day)],
1480683593056:customer_id = getIdFromName(customer),
1480683593057:refetch = refetch
1480683593058:)
1480683593060:# campaigns <- addDatesToCampaigns(all_campaigns, all_campaign_data) %>%
1480683593061:#     excludeNonSTO(all_campaign_data) %>%
1480683593062:#     excludeRecentCampaigns()
1480683593064:# campaign_data <- keepRelevantCampaignsWithUnifiedSendDay(all_campaign_data, campaigns) %>%
1480683593065:#     addOpenedBounced_()
1480683593066:list(campaign_data = campaign_data, campaigns = campaigns)
1480683593067:}
1480683596255:b <- getCampaignDataForCustomer()
1480683607236:b <- getCampaignDataForCustomer(customer, program)
1480684051041:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480684051042:all_campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480684051043:all_campaign_data <- readSqlResult(
1480684051043:sql_file = 'sql/opens_for_campaign_ids.sql',
1480684051044:result_file_name = str_c(customer, program, sep = '_'),
1480684051046:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480684051048:start_date = all_campaigns[, min(send_day)],
1480684051050:customer_id = getIdFromName(customer),
1480684051052:refetch = refetch
1480684051053:)
1480684051055:# campaigns <- addDatesToCampaigns(all_campaigns, all_campaign_data) %>%
1480684051056:#     excludeNonSTO(all_campaign_data) %>%
1480684051057:#     excludeRecentCampaigns()
1480684051058:# campaign_data <- keepRelevantCampaignsWithUnifiedSendDay(all_campaign_data, campaigns) %>%
1480684051059:#     addOpenedBounced_()
1480684051060:list(campaign_data = all_campaign_data, campaigns = all_campaigns)
1480684051061:}
1480684056408:b <- getCampaignDataForCustomer(customer, program, FALSE)
1480684059402:b
1480684177739:b$campaign_data[, .N, by = send_hour]
1480684182612:b$campaign_data[, .N, keyby = send_hour]
1480684234054:b$campaign_data[1:10, .(send_hour)]
1480684237654:b$campaign_data[1:10, .(send_time)]
1480684272701:sapply(b$campaign_data, class)
1480684356093:b <- getCampaignDataForCustomer(customer, program, TRUE)
1480684426697:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480684426699:all_campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480684426700:all_campaign_data <- readSqlResult(
1480684426701:sql_file = 'sql/opens_for_campaign_ids.sql',
1480684426701:result_file_name = str_c(customer, program, sep = '_'),
1480684426704:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480684426705:start_date = all_campaigns[, min(send_day)],
1480684426705:start_date = all_campaigns[, max(send_day)],
1480684426706:customer_id = getIdFromName(customer),
1480684426707:refetch = refetch
1480684426707:)
1480684426709:# campaigns <- addDatesToCampaigns(all_campaigns, all_campaign_data) %>%
1480684426709:#     excludeNonSTO(all_campaign_data) %>%
1480684426710:#     excludeRecentCampaigns()
1480684426714:# campaign_data <- keepRelevantCampaignsWithUnifiedSendDay(all_campaign_data, campaigns) %>%
1480684426716:#     addOpenedBounced_()
1480684426718:list(campaign_data = all_campaign_data, campaigns = all_campaigns)
1480684426720:}
1480684430152:b <- getCampaignDataForCustomer(customer, program, TRUE)
1480684448890:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480684448891:all_campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480684448895:all_campaign_data <- readSqlResult(
1480684448896:sql_file = 'sql/opens_for_campaign_ids.sql',
1480684448897:result_file_name = str_c(customer, program, sep = '_'),
1480684448898:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480684448899:start_date = all_campaigns[, min(send_day)],
1480684448899:end_date = all_campaigns[, max(send_day)],
1480684448900:customer_id = getIdFromName(customer),
1480684448901:refetch = refetch
1480684448902:)
1480684448903:# campaigns <- addDatesToCampaigns(all_campaigns, all_campaign_data) %>%
1480684448904:#     excludeNonSTO(all_campaign_data) %>%
1480684448905:#     excludeRecentCampaigns()
1480684448906:# campaign_data <- keepRelevantCampaignsWithUnifiedSendDay(all_campaign_data, campaigns) %>%
1480684448906:#     addOpenedBounced_()
1480684448907:list(campaign_data = all_campaign_data, campaigns = all_campaigns)
1480684448908:}
1480684451786:b <- getCampaignDataForCustomer(customer, program, TRUE)
1480684804464:b
1480684901029:c <- fread('data/batiwiz_TD120.csv')
1480684910416:head(c)
1480684922930:head(b$campaign_data)
1480684963996:?fwrite
1480684991137:sapply(b$campaign_data, class)
1480685164572:b
1480685388208:program <- 'A-TD120'
1480685396477:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1480685396478:program_properties <- SETTINGS[[customer]]$programs[[program]]
1480685396479:map(
1480685396485:c('sto', 'control'),
1480685396487:~ readSqlResult(
1480685396489:sql_file = 'sql/campaigns_for_segment.sql',
1480685396490:database_name = SETTINGS[[customer]]$suite,
1480685396492:result_file_name = str_c(customer, program, ., 'campaigns', sep = '_'),
1480685396494:customer_id = getIdFromName(customer),
1480685396499:start_date = start_date,
1480685396501:segment_name = program_properties$names[[.]],
1480685396502:refetch = refetch
1480685396503:)[, segment := .]
1480685396504:) %>% rbindlist()
1480685396505:}
1480685419248:a <- getCampaignsForProgram('batiwiz', program, refetch = FALSE)
1480685422950:a
1480685433807:a[, max(send_day)]
1480685493036:b
1480685516623:b$campaign_data
1480685811310:merge(b$campaign_data[, send_day := NULL], b$campaigns, by = 'campaign_id')
1480685854320:b$campaign_data
1480685883237:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480685883238:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480685883239:opens_data <- readSqlResult(
1480685883241:sql_file = 'sql/opens_for_campaign_ids.sql',
1480685883243:result_file_name = str_c(customer, program, sep = '_'),
1480685883244:campaign_id_list = createStringListFromVector(all_campaigns[, campaign_id]),
1480685883246:start_date = all_campaigns[, min(send_day)],
1480685883247:end_date = all_campaigns[, max(send_day)],
1480685883249:customer_id = getIdFromName(customer),
1480685883250:refetch = refetch
1480685883250:)
1480685883252:merge(opens_data[, send_day := NULL], campaigns, by = 'campaign_id')
1480685883253:}
1480685892203:b <- getCampaignDataForCustomer(customer, program, FALSE)
1480685906853:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480685906854:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480685906856:opens_data <- readSqlResult(
1480685906857:sql_file = 'sql/opens_for_campaign_ids.sql',
1480685906857:result_file_name = str_c(customer, program, sep = '_'),
1480685906860:campaign_id_list = createStringListFromVector(campaigns[, campaign_id]),
1480685906862:start_date = campaigns[, min(send_day)],
1480685906864:end_date = campaigns[, max(send_day)],
1480685906866:customer_id = getIdFromName(customer),
1480685906867:refetch = refetch
1480685906869:)
1480685906871:merge(opens_data[, send_day := NULL], campaigns, by = 'campaign_id')
1480685906872:}
1480685908870:b <- getCampaignDataForCustomer(customer, program, FALSE)
1480685943015:b
1480686048240:customer_data <- b
1480686048918:b
1480686054737:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480686142985:reportStatistics <- function(customer, program_data, check_pairwise_common = FALSE) {
1480686142986:cat('\n===== ', customer, ' =====\n\n')
1480686142989:print(program_data[, .(size = .N), keyby = .(segment, campaign_id)])
1480686142991:cat('\n')
1480686142993:unique_contacts <<- unique(program_data[, .(segment, contact_id)])
1480686142994:print(unique_contacts[, .(n_unique_contacts = .N), by = segment])
1480686142995:cat('\n')
1480686142998:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1480686142999:common_contacts <<- program_data[, .N, by = .(segment, contact_id)][N == n_campaigns, .(segment, contact_id)]
1480686143000:print(common_contacts[, .(n_common_contacts = .N), by = segment])
1480686143001:cat('\n')
1480686143002:sto_control_common_contacts <- intersect(unique_contacts[segment == 'sto'], unique_contacts[segment == 'control'])
1480686143003:if (length(sto_control_common_contacts) != 0) {
1480686143004:message('ALERT! There are common contacts within segments')
1480686143005:}
1480686143006:if (check_pairwise_common) {
1480686143007:pairwise_common_contacts <- calculateSharesOfCommonContacts(
1480686143008:program_data[segment == 'sto'],
1480686143009:program_data[segment == 'control'],
1480686143010:program_data
1480686143010:)
1480686143011:if (any(pairwise_common_contacts > 0)) {
1480686143012:message('ALERT! There are common contacts within campaign pairs')
1480686143013:}
1480686143014:if (program_data$campaign_data$control[, uniqueN(send_hour), by = campaign_id][, max(V1)] > 1) {
1480686143015:message('ALERT! There are more send hours in some of the control campaigns')
1480686143016:}
1480686143017:if (program_data$campaign_data$sto[, uniqueN(send_hour), by = campaign_id][, min(V1)] == 1) {
1480686143019:message('ALERT! There are only one send hour in some of the STO campaigns')
1480686143020:}
1480686143021:}
1480686143023:print(
1480686143025:calculateContactOpenRate(program_data$campaign_data) %>%
1480686143026:.[, .(share_non_responding = sum(open_rate == 0)/.N), by = segment]
1480686143029:)
1480686143030:}
1480686145489:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480686186970:reportStatistics <- function(customer, program_data, check_pairwise_common = FALSE) {
1480686186971:cat('\n===== ', customer, ' =====\n\n')
1480686186973:print(program_data[, .(size = .N), keyby = .(segment, campaign_id)])
1480686186974:cat('\n')
1480686186975:unique_contacts <<- unique(program_data[, .(segment, contact_id)])
1480686186977:print(unique_contacts[, .(n_unique_contacts = .N), by = segment])
1480686186978:cat('\n')
1480686186980:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1480686186981:common_contacts <<- program_data[, .N, by = .(segment, contact_id)][N == n_campaigns, .(segment, contact_id)]
1480686186983:print(common_contacts[, .(n_common_contacts = .N), by = segment])
1480686186984:cat('\n')
1480686186985:sto_control_common_contacts <- intersect(unique_contacts[segment == 'sto'], unique_contacts[segment == 'control'])
1480686186986:if (length(sto_control_common_contacts) != 0) {
1480686186987:message('ALERT! There are common contacts within segments')
1480686186988:}
1480686186989:if (check_pairwise_common) {
1480686186990:pairwise_common_contacts <- calculateSharesOfCommonContacts(
1480686186991:program_data[segment == 'sto'],
1480686186992:program_data[segment == 'control'],
1480686186993:program_data
1480686186994:)
1480686186995:if (any(pairwise_common_contacts > 0)) {
1480686186996:message('ALERT! There are common contacts within campaign pairs')
1480686186996:}
1480686186997:if (program_data[segment == 'control'][, uniqueN(send_hour), by = campaign_id][, max(V1)] > 1) {
1480686186998:message('ALERT! There are more send hours in some of the control campaigns')
1480686186998:}
1480686186999:if (program_data[segment == 'sto'][, uniqueN(send_hour), by = campaign_id][, min(V1)] == 1) {
1480686187000:message('ALERT! There are only one send hour in some of the STO campaigns')
1480686187000:}
1480686187001:}
1480686187003:print(
1480686187005:calculateContactOpenRate(program_data) %>%
1480686187006:.[, .(share_non_responding = sum(open_rate == 0)/.N), by = segment]
1480686187008:)
1480686187009:}
1480686189511:reportStatistics(customer, customer_data, check_pairwise_common = FALSE)
1480686194582:reportStatistics(customer, customer_data, check_pairwise_common = TRUE)
1480686403025:b
1480686405433:c
1480686415879:c[, min(send_day)]
1480686518724:program_data <- excludeNewlyRegisteredContacts(program_data)
1480686565248:program_data
1480686568672:b
1480686573609:program_data <- excludeNewlyRegisteredContacts(b)
1480686576280:program_data
1480686577461:b
1480686595151:b[, .N, by = contact_id]
1480686605071:program_data[, .N, by = contact_id]
1480686677987:plotSendTimeDistributionEvolution(program_data[segment == 'sto'])
1480686689930:program_data <- b
1480686699915:plotSendTimeDistributionEvolution(program_data[segment == 'sto'])
1480686727249:program_data
1480686738133:program_data[segment == 'sto']
1480686799391:plotSendTimeDistributionEvolution(program_data)
1480686822678:calculateSendDistribution(program_data[segment == 'sto'])
1480686839252:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)]
1480686867461:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n))
1480686878852:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n)) + geom_area()
1480686883662:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n)) + geom_point()
1480686916120:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n)) + geom_line(aes(fill = factor(send_hour)))
1480686921574:calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n)) + geom_area(aes(fill = factor(send_hour)))
1480686952924:p <- calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)] %>% ggplot(aes(x = send_day, y = n))
1480686953756:p
1480686965797:list(p)
1480686981094:p <- calculateSendDistribution(program_data[segment == 'sto']) %>% .[order(send_hour)]
1480686982055:p
1480686996264:ggplot(p, aes(send_day, n)) + geom_point()
1480687013640:ggplot(p, aes(send_day, n)) + geom_point(aes(fill = factor(send_hour)))
1480687022211:ggplot(p, aes(send_day, n)) + geom_point(aes(color = factor(send_hour)))
1480687052373:ggplot(p, aes(send_day, n)) + geom_area(aes(fill = factor(send_hour)))
1480687070171:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_area(aes(fill = factor(send_hour)))
1480687083474:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_point(aes(color = factor(send_hour)))
1480687155419:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_area()
1480687180545:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_ribbon()
1480687192801:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_bar()
1480687197980:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_col()
1480687209353:ggplot(p[send_hour != 3], aes(send_day, n)) + geom_col(aes(fill = factor(send_hour)))
1480687312299:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1480687312300:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1480687312300:.[, send_day := as.Date(send_day)]
1480687312302:opens_data <- readSqlResult(
1480687312302:sql_file = 'sql/opens_for_campaign_ids.sql',
1480687312303:result_file_name = str_c(customer, program, sep = '_'),
1480687312304:campaign_id_list = createStringListFromVector(campaigns[, campaign_id]),
1480687312305:start_date = campaigns[, min(send_day)],
1480687312305:end_date = campaigns[, max(send_day)],
1480687312306:customer_id = getIdFromName(customer),
1480687312306:refetch = refetch
1480687312307:)
1480687312308:merge(opens_data[, send_day := NULL], campaigns, by = 'campaign_id')
1480687312309:}
1480687325050:program_data <- getCampaignDataForCustomer(customer, program, FALSE)
1480687327942:program_data
1480687337765:program_data %>% sapply(class)
1480687348697:plotSendTimeDistributionEvolution(program_data)
1480687426932:plotSendTimeDistributionEvolution <- function(campaign_data) {
1480687426938:calculateSendDistribution(campaign_data[segment == 'sto']) %>%
1480687426938:.[order(send_hour)] %>%
1480687426939:ggplot(aes(x = send_day, y = n)) +
1480687426939:geom_area(aes(fill = factor(send_hour))) +
1480687426941:addSTOline(sto_line = FALSE, sto_text = FALSE) +
1480687426942:theme(legend.position = 'bottom') +
1480687426942:scale_fill_discrete(guide = guide_legend('send hour', nrow = 1))
1480687426946:}
1480687429428:plotSendTimeDistributionEvolution(program_data)
1480687516551:generateRelativeData(calculateSummary(program_data), base_by = c('send_day'))
1480687534351:calculateSummary(program_data, base_by = c('segment', 'send_day'))
1480687538851:a <- calculateSummary(program_data, base_by = c('segment', 'send_day'))
1480687539438:a
1480687540358:a
1480687551811:generateRelativeData(a, base_by = c('send_day'))
1480687558155:generateRelativeData(a, base_by = c('send_day')) %>% plotRelativeEvolution()
1480687572064:generateRelativeData(a, base_by = c('send_day')) %>% plotRelativeEvolution(text = FALSE)
1480687620644:generateRelativeData(a, base_by = c('send_day')) %>% plotRelativeEvolution(text = FALSE, trendlines = FALSE)
1480687688723:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, text = TRUE, text_position = 0.8, offset = 2) {
1480687688724:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480687688725:ggplot(aes(x = send_day, y = relative_measure)) +
1480687688726:geom_hline(yintercept = 1, linetype = 'dashed')
1480687688726:if (is.null(color)) {
1480687688727:p <- p +
1480687688728:geom_line() +
1480687688729:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480687688729:} else {
1480687688730:p <- p +
1480687688731:geom_point(aes_string(color = color)) +
1480687688731:geom_line(aes_string(color = color))
1480687688732:}
1480687688733:if (trendlines) {
1480687688734:p <- p + geom_smooth(aes(group = send_day < as.Date(SETTINGS[[customer]]$start_date)), method = 'lm')
1480687688736:}
1480687688738:if (!is.null(facet)) {
1480687688739:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480687688740:}
1480687688741:p + addSTOline(sto_line, text, prior_change_dates, text_position) +
1480687688742:labs(x = 'Send day', y = paste('Relative', variable))
1480687688742:}
1480687698831:generateRelativeData(a, base_by = c('send_day')) %>% plotRelativeEvolution(sto_line = FALSE, text = FALSE, trendlines = FALSE)
1480689927407:Sys.Date - period(2, 'month')
1480689934826:Sys.Date() - period(2, 'month')
1480689955226:'2016-12-01' - period(2, 'month')
1480689967868:as.Date('2016-12-01') - period(2, 'month')
1480690043925:as.Date(Sys.Date())
1480690290190:dt <- data.table(x = 1)
1480690301623:names(dt)
1480690305581:name(dt)
1480690637534:program
1480690660679:customer <- 'lingualeo'
1480690662729:program <- 'test'
1480690668821:source('global.R')
1480690698581:source('global.R')
1480690729286:data_by_segment <- getContactlistsForSegments(customer, program) %>%
1480690729287:getHistoricalOpensForContactlists(customer, contactlists_dt = ., contactlists_name = program, refetch = FALSE)
1480690762520:data_by_segment <- getContactlistsForSegments(customer, program) %>%
1480690762725:getHistoricalOpensForContactlists(customer, contactlists_dt = ., contactlists_name = program, refetch = FALSE)
1480690777680:source('global.R')
1480690779537:data_by_segment <- getContactlistsForSegments(customer, program) %>%
1480690779805:getHistoricalOpensForContactlists(customer, contactlists_dt = ., contactlists_name = program, refetch = FALSE)
1480691359060:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1480691359061:getHistoricalOpensForContactlists(customer, contactlists_dt = ., contactlists_name = program, end_date = '2016-12-02', refetch = FALSE)
1480691363499:source('global.R')
1480691365683:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1480691365896:getHistoricalOpensForContactlists(customer, contactlists_dt = ., contactlists_name = program, end_date = '2016-12-02', refetch = FALSE)
1480691443983:data_by_segment
1480691602821:program_data
1480691654531:b
1480691655455:c
1480691660745:c[send_day == min(send_day)]
1480691666111:c
1480691740495:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch)
1480691744652:campaigns <- getCampaignsForProgram(customer, program, refetch = F)
1480691768189:campaigns <- getCampaignsForProgram('batiwiz', 'TD-120', refetch = F)
1480691844447:campaigns <- getCampaignsForProgram(customer, program, refetch = F)
1480691852596:statement
1480691906276:campaigns <- getCampaignsForProgram('batiwiz', 'TD-120', refetch = F)
1480691914234:campaigns <- getCampaignsForProgram('batiwiz', 'TD-120', refetch = F)
1480691922476:statement
1480691976512:source('global.R')
1480691980550:campaigns <- getCampaignsForProgram('batiwiz', 'TD-120', refetch = F)
1480692005930:campaigns <- getCampaignsForProgram('batiwiz', 'TD120', refetch = F)
1480692009559:campaigns
1480692051276:campaigns <- getCampaignsForProgram('batiwiz', 'TD120', refetch = F)
1480692052881:campaigns <- getCampaignsForProgram('batiwiz', 'TD120', refetch = F)
1480692053733:campaigns <- getCampaignsForProgram('batiwiz', 'TD120', refetch = F)
1480692054523:campaigns <- getCampaignsForProgram('batiwiz', 'TD120', refetch = F)
1480692167271:program_data
1480692262247:getListOFFirstSTOReceivers <- function(customer, program, program_data) {
1480692262247:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480692262248:campaign_ids <- campaigns[send_day == min(send_day), .(campaign_id)]
1480692262249:merge(
1480692262250:program_data[, .(contact_id, sto = as.numeric(segment == 'sto'))],
1480692262251:campaign_ids, by = 'campaign_id'
1480692262252:)
1480692262253:}
1480692271276:getListOfFirstSTOReceivers <- function(customer, program, program_data) {
1480692271278:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480692271279:campaign_ids <- campaigns[send_day == min(send_day), .(campaign_id)]
1480692271280:merge(
1480692271281:program_data[, .(contact_id, sto = as.numeric(segment == 'sto'))],
1480692271282:campaign_ids, by = 'campaign_id'
1480692271283:)
1480692271284:}
1480692281693:getListOfFirstSTOReceivers(program_data)
1480692296241:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480692296243:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480692296244:campaign_ids <- campaigns[send_day == min(send_day), .(campaign_id)]
1480692296246:merge(
1480692296247:program_data[, .(contact_id, sto = as.numeric(segment == 'sto'))],
1480692296248:campaign_ids, by = 'campaign_id'
1480692296249:)
1480692296250:}
1480692306114:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'TD120')
1480692349291:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480692349292:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480692349294:campaign_ids <- campaigns[send_day == min(send_day), .(campaign_id)]
1480692349296:merge(
1480692349296:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1480692349297:campaign_ids, by = 'campaign_id'
1480692349298:) %>%
1480692349298:.[, campaign_id := NULL] %>%
1480692349299:.[]
1480692349300:}
1480692351531:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'TD120')
1480692363865:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'A-TD120')
1480692370478:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'A-TD120')[, .N, by = sto]
1480692379679:program_data
1480692401243:getCampaignsForProgram('batiwiz', 'A-TD120', F)
1480692444889:getCampaignsForProgram('batiwiz', 'A-TD120', TRUE)
1480692572836:getSqlResult(file_name = 'sql/campaigns_for_segment.sql', database_name = 'suite11', customer_id = getIdFromName('batiwiz'), start_date = '2016-07-01', segment_name = 'A-TD120STO')
1480692584039:getSqlResult(file_name = 'sql/campaigns_for_segment.sql', database_name = 'suite11', customer_id = getIdFromName('batiwiz'), start_date = '2016-07-01', segment_name = 'A-TD120EXCSTO')
1480692631802:getCampaignsForProgram('batiwiz', 'A-TD120', refetch = TRUE)
1480692650538:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'A-TD120')[, .N, by = sto]
1480692677854:program_data
1480692686050:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'A-TD120')
1480692691873:getListOfFirstSTOReceivers(program_data, 'batiwiz', 'A-TD120')[, .N, by = sto]
1480692706271:campaigns <- getCampaignsForProgram('batiwiz', 'A-TD120', refetch = TRUE)
1480692711103:campaigns
1480692717855:campaign_ids <- campaigns[send_day == min(send_day), .(campaign_id)]
1480692721149:campaign_ids
1480692737148:campaigns[campaign_id %in% campaign_ids]
1480692751839:merge(campaigns, campaign_ids, by = 'campaign_id')
1480692767842:program_data
1480692791629:program_data[campaign_id %in% c(680809, 681842)]
1480692796358:program_data[campaign_id %in% c(680809, 681842)][, .N, by = segment]
1480692818659:program_data[campaign_id == 681842]
1480692908527:program_data <- getCampaignDataForCustomer('batiwiz', 'A-TD120')
1480693005664:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480693005665:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693005666:campaign_ids <- campaigns[send_day == min(send_day) + 1, .(campaign_id)]
1480693005666:merge(
1480693005667:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1480693005668:campaign_ids,
1480693005668:by = 'campaign_id'
1480693005669:) %>%
1480693005670:.[, campaign_id := NULL] %>%
1480693005670:.[]
1480693005671:}
1480693054453:getListOfFirstSTOReceivers(program_data, customer, program)
1480693177001:getCampaignsForProgram('batiwiz', 'A-TD120', F)
1480693186208:getCampaignsForProgram('batiwiz', 'A-TD120', refetch = F)
1480693189735:getCampaignsForProgram('batiwiz', 'A-TD120', refetch = T)
1480693273358:getCampaignsForProgram('batiwiz', 'A-TD120', refetch = T)
1480693285599:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480693285600:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693285601:campaign_ids <- campaigns[segment == 'sto'][send_day == min(send_day), .(campaign_id)]
1480693285604:merge(
1480693285604:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1480693285605:campaign_ids,
1480693285606:by = 'campaign_id'
1480693285606:) %>%
1480693285607:.[, campaign_id := NULL] %>%
1480693285608:.[]
1480693285608:}
1480693293197:getListOfFirstSTOReceivers(program_data, customer, program)
1480693316992:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693323136:campaigns
1480693339797:program
1480693348263:program <- 'A-TD120'
1480693350991:customer
1480693355258:customer <- 'batiwiz'
1480693360019:getListOfFirstSTOReceivers(program_data, customer, program)
1480693366786:getListOfFirstSTOReceivers(program_data, customer, program)[, .N, by =sto]
1480693376356:getCampaignsForProgram(customer, program, refetch = FALSE)
1480693382389:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693385917:campaign_ids <- campaigns[segment == 'sto'][send_day == min(send_day), .(campaign_id)]
1480693390007:campaign_ids
1480693437160:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480693437160:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693437161:start_date <- campaigns[segment == 'sto', min(send_day)]
1480693437164:campaign_ids <- campaigns[send_day == 'start_date']
1480693437164:merge(
1480693437165:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1480693437166:campaign_ids,
1480693437166:by = 'campaign_id'
1480693437167:) %>%
1480693437168:.[, campaign_id := NULL] %>%
1480693437168:.[]
1480693437169:}
1480693441357:getCampaignsForProgram(customer, program, refetch = FALSE)
1480693445773:getListOfFirstSTOReceivers(program_data, customer, program)
1480693455947:start_date <- campaigns[segment == 'sto', min(send_day)]
1480693458754:start_date
1480693473256:campaign_ids <- campaigns[send_day == 'start_date', .(campaign_id)]
1480693476615:campaign_ids
1480693486682:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1480693486685:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480693486686:start_date <- campaigns[segment == 'sto', min(send_day)]
1480693486687:campaign_ids <- campaigns[send_day == start_date, .(campaign_id)]
1480693486687:merge(
1480693486688:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1480693486688:campaign_ids,
1480693486689:by = 'campaign_id'
1480693486690:) %>%
1480693486691:.[, campaign_id := NULL] %>%
1480693486694:.[]
1480693486696:}
1480693491654:getListOfFirstSTOReceivers(program_data, customer, program)
1480693497591:getListOfFirstSTOReceivers(program_data, customer, program)[, .N, by= sto]
1480693948472:program_data
1480694000179:customer <- 'batiwiz'
1480694000788:program <- 'TD120'
1480694003663:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480694011515:program_data
1480694456012:addPastData <- function(customer, program, program_data, refetch = FALSE) {
1480694456012:past_data <- getHistoricalOpensForContactlists(
1480694456016:customer,
1480694456017:contactlists_dt = getListOfFirstSTOReceivers(program_data, customer, program),
1480694456019:contactlists_name = str_c(program, 'starters', sep = '_'),
1480694456020:end_date = program_data[segment == 'sto', min(send_day)],
1480694456020:refetch = refetch
1480694456021:)
1480694456022:combinePastAndSTO(past_data, program_data)
1480694456023:}
1480694504028:source('global.R')
1480694506222:customer <- 'batiwiz'
1480694506600:program <- 'TD120'
1480694508344:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480694514411:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480694537382:program_data
1480694577979:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1480694755319:head(program_data)
1480694764439:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480694786570:all_data <- addPastData(customer, program_data, refetch = FALSE)
1480694830036:source('global.R')
1480694863933:source('global.R')
1480694869695:customer <- 'batiwiz'
1480694872884:program <- 'TD120'
1480694874420:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480694878529:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480694901150:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695019528:addPastData <- function(customer, program, program_data, refetch = FALSE) {
1480695019530:past_data <- getHistoricalOpensForContactlists(
1480695019530:customer,
1480695019531:contactlists_dt = getListOfFirstSTOReceivers(program_data, customer, program),
1480695019531:contactlists_name = str_c(program, 'starters', sep = '_'),
1480695019532:end_date = program_data[segment == 'sto', min(send_day)],
1480695019533:refetch = refetch
1480695019533:)
1480695019533:combinePastAndSTO(past_data[, period := 'past'], program_data[, period := 'sto'])
1480695019534:}
1480695024055:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695052071:getHistoricalOpensForContactlists(customer, program, program_data)
1480695069145:getHistoricalOpensForContactlists(customer, program, program_data, end_date = '2016-08-25')
1480695242465:addPastData <- function(customer, program, program_data, refetch = FALSE) {
1480695242471:past_data <- getHistoricalOpensForContactlists(
1480695242472:customer,
1480695242473:contactlists_dt = getListOfFirstSTOReceivers(program_data, customer, program),
1480695242475:contactlists_name = str_c(program, 'starters', sep = '_'),
1480695242476:end_date = program_data[segment == 'sto', min(send_day)],
1480695242477:refetch = refetch
1480695242478:) %>% .[, segment := c('control', 'sto')[sto + 1]]
1480695242479:combinePastAndSTO(past_data[, period := 'past'], program_data[, period := 'sto'])
1480695242480:}
1480695250093:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695256370:source('global.R')
1480695257811:customer <- 'batiwiz'
1480695258498:program <- 'TD120'
1480695259111:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480695263123:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695309332:combinePastAndSTO <- function(past, sto) {
1480695309333:browser()
1480695309333:variables <- c('contact_id', 'campaign_id', 'send_day', 'send_hour', 'bounced', 'opened', 'hours_to_open', 'period', 'segment')
1480695309334:rbindlist(list(past[, variables, with = FALSE], sto[, variables, with = FALSE]))
1480695309334:}
1480695312241:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695314687:past
1480695315772:sto
1480695340217:sapply(past, class)
1480695344880:sapply(sto, class)
1480695428401:addPastData <- function(customer, program, program_data, refetch = FALSE) {
1480695428403:past_data <- getHistoricalOpensForContactlists(
1480695428403:customer,
1480695428404:contactlists_dt = getListOfFirstSTOReceivers(program_data, customer, program),
1480695428405:contactlists_name = str_c(program, 'starters', sep = '_'),
1480695428405:end_date = program_data[segment == 'sto', min(send_day)],
1480695428406:refetch = refetch
1480695428407:) %>% .[, segment := c('control', 'sto')[sto + 1]] %>% .[, send_day := as.Date(send_day)]
1480695428407:combinePastAndSTO(past_data[, period := 'past'], program_data[, period := 'sto'])
1480695428408:}
1480695451231:addPastData <- function(customer, program, program_data, refetch = FALSE) {
1480695451232:past_data <- getHistoricalOpensForContactlists(
1480695451233:customer,
1480695451233:contactlists_dt = getListOfFirstSTOReceivers(program_data, customer, program),
1480695451234:contactlists_name = str_c(program, 'starters', sep = '_'),
1480695451234:end_date = program_data[segment == 'sto', min(send_day)],
1480695451235:refetch = refetch
1480695451236:) %>% .[, segment := c('control', 'sto')[sto + 1]] %>% .[, send_day := as.Date(send_day)]  # TODO: change it to faster way
1480695451236:combinePastAndSTO(past_data[, period := 'past'], program_data[, period := 'sto'])
1480695451237:}
1480695455638:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480695473529:all_data
1480695485986:campaign_summary <- calculateSummary(all_data)
1480695488871:plotOpenRateEvolutionWithPast(campaign_summary)
1480695550104:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(sto_line = FALSE, trendlines = F, color = 'weekday', text_position = 0.9) +
1480695550677:labs(x = 'Send day', y = 'Relative open rate') +
1480695551060:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480695551441:theme(legend.position = 'bottom')
1480695571091:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(sto_line = FALSE, text = FALSE, trendlines = F, color = 'weekday', text_position = 0.9) +
1480695571509:labs(x = 'Send day', y = 'Relative open rate') +
1480695571899:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480695572338:theme(legend.position = 'bottom')
1480754097263:campaign_summary
1480755658235:campaigns
1480755677184:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1480755677185:.[, send_day := as.Date(send_day)]
1480755682383:campaigns <- getCampaignsForProgram(customer, program, refetch = F) %>%
1480755682384:.[, send_day := as.Date(send_day)]
1480755684273:campaigns
1480755685847:campaigns
1480757133288:program_data
1480757140854:program_data[period == 'sto', min(send_day)]
1480757149541:program_data[period == 'past', max(send_day)]
1480757159007:all_data[period == 'past', max(send_day)]
1480757196206:generateRelativeData(all_data)
1480757202400:generateRelativeData(all_data)
1480757208330:generateRelativeData(campaign_summary)
1480757219952:generateRelativeData(campaign_summary)[period == 'past']
1480757223808:generateRelativeData(campaign_summary)[period == 'past', max(send_day)]
1480757277382:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480757277382:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480757277383:ggplot(aes(x = send_day, y = relative_measure)) +
1480757277384:geom_hline(yintercept = 1, linetype = 'dashed')
1480757277385:if (is.null(color)) {
1480757277386:p <- p +
1480757277388:geom_line() +
1480757277388:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480757277389:} else {
1480757277391:p <- p +
1480757277391:geom_point(aes_string(color = color)) +
1480757277392:geom_line(aes_string(color = color))
1480757277393:}
1480757277394:if (trendlines) {
1480757277395:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480757277396:}
1480757277396:if (!is.null(facet)) {
1480757277397:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480757277398:}
1480757277398:p + addSTOline(sto_line, sto_text, prior_change_dates, text_position) +
1480757277399:labs(x = 'Send day', y = paste('Relative', variable))
1480757277400:}
1480757523940:source('global.R')
1480757550192:source('global.R')
1480757565846:source('global.R')
1480757570960:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480757578312:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480757633516:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480757651935:plotSendTimeDistributionEvolution(program_data)
1480757670033:campaign_summary <- calculateSummary(all_data)
1480757673279:plotOpenRateEvolutionWithPast(campaign_summary)
1480757694284:plotOpenRateEvolutionWithPast <- function(summary_with_past, offset = 2) {
1480757694285:summary_with_past %>%
1480757694286:plotOpenRateEvolution(offset) +
1480757694286:addSTOline(start_date = summary_with_past[period == 'past', max(send_day)], text_position = 0)
1480757694287:}
1480757698259:plotOpenRateEvolutionWithPast(campaign_summary)
1480757735087:source('global.R')
1480757740776:plotOpenRateEvolutionWithPast(campaign_summary)
1480757753950:debug(plotOpenRateEvolutionWithPast)
1480757755271:plotOpenRateEvolutionWithPast(campaign_summary)
1480757780736:summary_with_past %>% plotOpenRateEvolution()
1480757812448:campaign_summary %>% plotOpenRateEvolution()
1480757853316:campaign_summary %>% plotOpenRateEvolution() + addSTOline(summary_with_past[period == 'past', max(send_day)])
1480757861497:campaign_summary %>% plotOpenRateEvolution() + addSTOline(campaign_summary[period == 'past', max(send_day)])
1480757932060:campaign_summary[period == 'past', max(send_day)]
1480757938867:DATE <- campaign_summary[period == 'past', max(send_day)]
1480757945404:campaign_summary %>% plotOpenRateEvolution() + addSTOline(DATE)
1480757951677:campaign_summary %>% plotOpenRateEvolution() + addSTOline(start_date = DATE)
1480758059241:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758059242:plot_list <- list()
1480758059243:if (sto_line) {
1480758059244:date_df <- data.table(x = start_date, y = text_position)
1480758059245:plot_list <- list(
1480758059246:plot_list,
1480758059247:geom_vline(
1480758059248:data = date_df
1480758059248:aes(xintercept = x),
1480758059249:color = 'black', linetype = 'dashed'
1480758059249:)
1480758059249:)
1480758059250:if (sto_text) {
1480758059250:plot_list <- list(
1480758059250:plot_list,
1480758059251:geom_text(
1480758059252:data = data.frame(x = start_date, y = text_position),
1480758059253:aes(x, y, label = 'Start of STO'),
1480758059253:color = 'black', hjust = 1.1
1480758059254:)
1480758059254:)
1480758059255:}
1480758059256:}
1480758059256:if (prior_changes) {
1480758059257:plot_list <- list(
1480758059257:plot_list,
1480758059257:geom_vline(
1480758059257:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758059258:aes(xintercept = date),
1480758059258:color = 'black', linetype = 'dotted'
1480758059258:)
1480758059259:)
1480758059260:}
1480758059261:plot_list
1480758059263:}
1480758062734:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758062735:plot_list <- list()
1480758062736:if (sto_line) {
1480758062736:date_df <- data.table(x = start_date, y = text_position)
1480758062737:plot_list <- list(
1480758062738:plot_list,
1480758062738:geom_vline(
1480758062740:data = date_df
1480758062741:aes(xintercept = x),
1480758062742:color = 'black', linetype = 'dashed'
1480758062743:)
1480758062744:)
1480758062744:if (sto_text) {
1480758062745:plot_list <- list(
1480758062745:plot_list,
1480758062746:geom_text(
1480758062746:data = data.frame(x = start_date, y = text_position),
1480758062747:aes(x, y, label = 'Start of STO'),
1480758062747:color = 'black', hjust = 1.1
1480758062748:)
1480758062749:)
1480758062749:}
1480758062750:}
1480758062751:if (prior_changes) {
1480758062751:plot_list <- list(
1480758062751:plot_list,
1480758062752:geom_vline(
1480758062752:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758062753:aes(xintercept = date),
1480758062753:color = 'black', linetype = 'dotted'
1480758062754:)
1480758062755:)
1480758062755:}
1480758062757:plot_list
1480758062757:}
1480758079034:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758079035:plot_list <- list()
1480758079036:if (sto_line) {
1480758079036:date_df <- data.table(x = start_date, y = text_position)
1480758079037:plot_list <- list(
1480758079038:plot_list,
1480758079039:geom_vline(
1480758079041:data = date_df,
1480758079042:aes(xintercept = x),
1480758079043:color = 'black', linetype = 'dashed'
1480758079043:)
1480758079044:)
1480758079045:if (sto_text) {
1480758079046:plot_list <- list(
1480758079046:plot_list,
1480758079047:geom_text(
1480758079048:data = data.frame(x = start_date, y = text_position),
1480758079048:aes(x, y, label = 'Start of STO'),
1480758079049:color = 'black', hjust = 1.1
1480758079050:)
1480758079050:)
1480758079051:}
1480758079052:}
1480758079052:if (prior_changes) {
1480758079053:plot_list <- list(
1480758079054:plot_list,
1480758079055:geom_vline(
1480758079056:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758079057:aes(xintercept = date),
1480758079058:color = 'black', linetype = 'dotted'
1480758079059:)
1480758079060:)
1480758079061:}
1480758079062:plot_list
1480758079062:}
1480758084060:campaign_summary %>% plotOpenRateEvolution() + addSTOline(DATE)
1480758114354:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758114355:plot_list <- list()
1480758114356:if (sto_line) {
1480758114358:date_df <- data.table(x = start_date, y = text_position)
1480758114359:plot_list <- list(
1480758114360:plot_list,
1480758114361:geom_vline(
1480758114362:data = date_df,
1480758114363:aes(xintercept = as.numeric(x)),
1480758114366:color = 'black', linetype = 'dashed'
1480758114367:)
1480758114368:)
1480758114369:if (sto_text) {
1480758114370:plot_list <- list(
1480758114371:plot_list,
1480758114372:geom_text(
1480758114373:data = data.frame(x = start_date, y = text_position),
1480758114374:aes(x, y, label = 'Start of STO'),
1480758114375:color = 'black', hjust = 1.1
1480758114376:)
1480758114376:)
1480758114377:}
1480758114378:}
1480758114379:if (prior_changes) {
1480758114380:plot_list <- list(
1480758114380:plot_list,
1480758114382:geom_vline(
1480758114383:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758114384:aes(xintercept = date),
1480758114385:color = 'black', linetype = 'dotted'
1480758114386:)
1480758114387:)
1480758114388:}
1480758114389:plot_list
1480758114390:}
1480758116797:campaign_summary %>% plotOpenRateEvolution() + addSTOline(DATE)
1480758180871:source('global.R')
1480758186342:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1480758193679:campaign_summary <- calculateSummary(all_data)
1480758194843:plotOpenRateEvolutionWithPast(campaign_summary)
1480758207530:campaign_summary %>%
1480758207531:ggplot(aes(send_day, open_rate, color = segment)) +
1480758207531:geom_line() +
1480758207532:addSTOline(text_position = 0.18) +
1480758207532:geom_smooth(span = 0.3) +
1480758207533:labs(x = 'Day', y = 'Open rate') +
1480758207533:theme(legend.position = 'bottom')
1480758294946:program_data[period == 'past']
1480758299254:program_data[period == 'past', max(send_day)]
1480758355309:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758355310:if (start_date == NULL) {
1480758355310:start_date <- .[period == 'past', max(send_day)]
1480758355311:}
1480758355311:plot_list <- list()
1480758355312:if (sto_line) {
1480758355313:date_df <- data.table(x = start_date, y = text_position)
1480758355313:plot_list <- list(
1480758355314:plot_list,
1480758355315:geom_vline(
1480758355316:data = date_df,
1480758355317:aes(xintercept = as.numeric(x)),
1480758355318:color = 'black', linetype = 'dashed'
1480758355320:)
1480758355321:)
1480758355322:if (sto_text) {
1480758355323:plot_list <- list(
1480758355324:plot_list,
1480758355325:geom_text(
1480758355326:data = data.frame(x = start_date, y = text_position),
1480758355327:aes(x, y, label = 'Start of STO'),
1480758355328:color = 'black', hjust = 1.1
1480758355328:)
1480758355329:)
1480758355331:}
1480758355332:}
1480758355333:if (prior_changes) {
1480758355334:plot_list <- list(
1480758355335:plot_list,
1480758355338:geom_vline(
1480758355339:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758355340:aes(xintercept = date),
1480758355342:color = 'black', linetype = 'dotted'
1480758355343:)
1480758355344:)
1480758355345:}
1480758355346:plot_list
1480758355347:}
1480758360776:campaign_summary %>%
1480758361264:ggplot(aes(send_day, open_rate, color = segment)) +
1480758361662:geom_line() +
1480758362092:addSTOline(text_position = 0.18) +
1480758362498:geom_smooth(span = 0.3) +
1480758362981:labs(x = 'Day', y = 'Open rate') +
1480758363593:theme(legend.position = 'bottom')
1480758374547:campaign_summary
1480758377567:campaign_summary[period == 'past']
1480758382969:campaign_summary[period == 'past', max(send_day)]
1480758397857:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1480758397858:plot_list <- list()
1480758397860:if (sto_line) {
1480758397861:date_df <- data.table(x = start_date, y = text_position)
1480758397862:plot_list <- list(
1480758397864:plot_list,
1480758397865:geom_vline(
1480758397866:data = date_df,
1480758397866:aes(xintercept = as.numeric(x)),
1480758397867:color = 'black', linetype = 'dashed'
1480758397867:)
1480758397869:)
1480758397870:if (sto_text) {
1480758397872:plot_list <- list(
1480758397873:plot_list,
1480758397874:geom_text(
1480758397875:data = data.frame(x = start_date, y = text_position),
1480758397875:aes(x, y, label = 'Start of STO'),
1480758397876:color = 'black', hjust = 1.1
1480758397877:)
1480758397878:)
1480758397879:}
1480758397879:}
1480758397880:if (prior_changes) {
1480758397881:plot_list <- list(
1480758397882:plot_list,
1480758397883:geom_vline(
1480758397884:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1480758397885:aes(xintercept = date),
1480758397886:color = 'black', linetype = 'dotted'
1480758397887:)
1480758397889:)
1480758397890:}
1480758397891:plot_list
1480758397892:}
1480758418425:campaign_summary %>%
1480758418425:ggplot(aes(send_day, open_rate, color = segment)) +
1480758418426:geom_line() +
1480758418426:addSTOline(start_date = .[period == 'past', max(send_day)], text_position = 0.18) +
1480758418427:geom_smooth(span = 0.3) +
1480758418427:labs(x = 'Day', y = 'Open rate') +
1480758418427:theme(legend.position = 'bottom')
1480758428853:campaign_summary %>%
1480758429286:ggplot(aes(send_day, open_rate, color = segment)) +
1480758429470:geom_line() +
1480758429661:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], text_position = 0.18) +
1480758429827:geom_smooth(span = 0.3) +
1480758430127:labs(x = 'Day', y = 'Open rate') +
1480758430584:theme(legend.position = 'bottom')
1480758540665:plotOpenRateEvolution <- function(campaign_summary, offset = 2) {
1480758540666:campaign_summary[send_day < Sys.Date() - offset] %>%
1480758540667:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758540668:geom_line(aes(group = segment)) +
1480758540668:geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758540669:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment), alpha = 0.3)
1480758540669:}
1480758552011:plotOpenRateEvolution(campaign_summary)
1480758576311:plotOpenRateEvolution <- function(campaign_summary, offset = 2) {
1480758576312:campaign_summary[send_day < Sys.Date() - offset] %>%
1480758576313:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758576314:geom_line(aes(group = segment)) +
1480758576315:geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758576315:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758576316:}
1480758579441:plotOpenRateEvolution(campaign_summary)
1480758710426:plotOpenRateEvolution <- function(campaign_summary, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758710426:campaign_summary[send_day < Sys.Date() - offset] %>%
1480758710427:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758710428:geom_line(aes(group = segment)) +
1480758710428:geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758710429:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3) +
1480758710429:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, text_position)
1480758710430:}
1480758713045:plotOpenRateEvolution(campaign_summary)
1480758742440:plotOpenRateEvolution <- function(campaign_summary, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758742441:campaign_summary[send_day < Sys.Date() - offset] %>%
1480758742441:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758742442:geom_line(aes(group = segment)) +
1480758742443:geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758742443:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3) +
1480758742444:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position)
1480758742445:}
1480758744136:plotOpenRateEvolution(campaign_summary)
1480758828269:plotOpenRateEvolution <- function(campaign_summary, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758828269:campaign_summary[send_day < Sys.Date() - offset] %>%
1480758828270:p <- ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758828271:geom_line(aes(group = segment)) +
1480758828271:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position)
1480758828272:if (smooth) {
1480758828273:p
1480758828273:} else {
1480758828274:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758828275:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758828276:}
1480758828277:}
1480758831200:plotOpenRateEvolution(campaign_summary)
1480758855486:plotOpenRateEvolution <- function(campaign_summary, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758855487:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480758855488:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758855488:geom_line(aes(group = segment)) +
1480758855489:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position)
1480758855491:if (smooth) {
1480758855493:p
1480758855494:} else {
1480758855495:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758855496:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758855497:}
1480758855498:}
1480758857701:plotOpenRateEvolution(campaign_summary)
1480758893841:plotOpenRateEvolution <- function(campaign_summary, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758893843:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480758893844:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758893845:geom_line(aes(group = segment)) +
1480758893847:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position) +
1480758893847:x = 'Day', y = 'Open rate') +
1480758893848:theme(legend.position = 'bottom')
1480758893854:if (smooth) {
1480758893854:p + geom_smooth(span = 0.3)
1480758893855:} else {
1480758893855:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758893856:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758893856:}
1480758893857:}
1480758902215:plotOpenRateEvolution <- function(campaign_summary, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758902216:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480758902217:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758902218:geom_line(aes(group = segment)) +
1480758902218:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position) +
1480758902219:labs(x = 'Day', y = 'Open rate') +
1480758902220:theme(legend.position = 'bottom')
1480758902220:if (smooth) {
1480758902221:p + geom_smooth(span = 0.3)
1480758902222:} else {
1480758902223:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758902223:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758902225:}
1480758902227:}
1480758905740:plotOpenRateEvolution(campaign_summary)
1480758914186:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480758947532:plotOpenRateEvolution <- function(campaign_summary, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480758947532:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480758947533:ggplot(aes(x = send_day, y = open_rate, color = segment)) +
1480758947534:geom_line(aes(group = segment)) +
1480758947534:addSTOline(start_date = campaign_summary[period == 'past', max(send_day)], sto_line, sto_text, prior_changes, text_position) +
1480758947535:labs(x = 'Day', y = 'Open rate') +
1480758947536:theme(legend.position = 'bottom')
1480758947536:if (smooth) {
1480758947537:p + geom_smooth(aes(fill = segment), span = 0.3)
1480758947539:} else {
1480758947540:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480758947542:geom_ribbon(aes(min = open_rate + 2*sd/sqrt(n), max = open_rate - 2*sd/sqrt(n), fill = segment, color = NULL), alpha = 0.3)
1480758947544:}
1480758947545:}
1480758950646:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480759082998:plotRateEvolution <- function(campaign_summary, rate = 'open', smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480759082999:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480759082999:ggplot(aes_string(x = 'send_day', y = 'open_rate', color = 'segment')) +
1480759083001:geom_line(aes(group = segment)) +
1480759083002:addSTOline(
1480759083003:start_date = campaign_summary[period == 'past', max(send_day)],
1480759083004:sto_line, sto_text, prior_changes, text_position
1480759083005:) +
1480759083006:labs(x = 'Day', y = 'Open rate') +
1480759083007:theme(legend.position = 'bottom')
1480759083007:if (smooth) {
1480759083008:p + geom_smooth(aes(fill = segment), span = 0.3)
1480759083009:} else {
1480759083010:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480759083011:geom_ribbon(
1480759083012:aes_string(
1480759083012:min = 'open_rate' + 2*sd/sqrt('n'),
1480759083013:max = 'open_rate' - 2*sd/sqrt('n'),
1480759083014:fill = 'segment', color = NULL
1480759083015:),
1480759083015:alpha = 0.3
1480759083016:)
1480759083017:}
1480759083019:}
1480759087721:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480759208015:plotRateEvolution <- function(campaign_summary, rate = 'open', smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480759208016:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480759208017:ggplot(aes_string(x = 'send_day', y = str_c(rate, 'rate', sep = '_'), color = 'segment')) +
1480759208017:geom_line(aes(group = segment)) +
1480759208018:addSTOline(
1480759208019:start_date = campaign_summary[period == 'past', max(send_day)],
1480759208020:sto_line, sto_text, prior_changes, text_position
1480759208020:) +
1480759208021:labs(x = 'Day', y = str_c(str_to_title(rate), 'rate', sep = ' ')) +
1480759208022:theme(legend.position = 'bottom')
1480759208023:if (smooth) {
1480759208024:p + geom_smooth(aes(fill = segment), span = 0.3)
1480759208025:} else {
1480759208026:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480759208027:geom_ribbon(
1480759208029:aes_string(
1480759208030:min = str_c(rate, 'rate', sep = '_') + 2*sd/sqrt('n'),
1480759208031:max = str_c(rate, 'rate', sep = '_') - 2*sd/sqrt('n'),
1480759208032:fill = 'segment', color = NULL
1480759208032:),
1480759208033:alpha = 0.3
1480759208034:)
1480759208035:}
1480759208036:}
1480759210828:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480759219569:plotOpenRateEvolution(campaign_summary, rate = 'click', smooth = TRUE)
1480759248355:plotOpenRateEvolution(campaign_summary)
1480759255755:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480759263367:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9) +
1480759264111:labs(x = 'Send day', y = 'Relative open rate') +
1480759264673:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759265751:theme(legend.position = 'bottom')
1480759382825:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480759382826:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480759382827:ggplot(aes(x = send_day, y = relative_measure)) +
1480759382827:geom_hline(yintercept = 1, linetype = 'dashed')
1480759382828:if (is.null(color)) {
1480759382829:p <- p +
1480759382829:geom_line() +
1480759382831:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480759382833:} else {
1480759382834:p <- p +
1480759382835:geom_point(aes_string(color = color)) +
1480759382836:geom_line(aes_string(color = color))
1480759382837:}
1480759382838:if (trendlines) {
1480759382839:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480759382840:}
1480759382840:if (!is.null(facet)) {
1480759382841:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480759382842:}
1480759382843:p + addSTOline(
1480759382844:start_date = relative_data[period == 'past', max(send_day)],
1480759382845:sto_line, sto_text, prior_change_dates, text_position
1480759382846:) +
1480759382847:labs(x = 'Send day', y = paste('Relative', str_replace(variable, '_', ' ')) +
1480759382849:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759382850:theme(legend.position = 'bottom')
1480759382851:}
1480759411820:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480759411822:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480759411822:ggplot(aes(x = send_day, y = relative_measure)) +
1480759411823:geom_hline(yintercept = 1, linetype = 'dashed')
1480759411823:if (is.null(color)) {
1480759411824:p <- p +
1480759411825:geom_line() +
1480759411825:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480759411826:} else {
1480759411827:p <- p +
1480759411827:geom_point(aes_string(color = color)) +
1480759411828:geom_line(aes_string(color = color))
1480759411829:}
1480759411830:if (trendlines) {
1480759411830:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480759411832:}
1480759411833:if (!is.null(facet)) {
1480759411835:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480759411836:}
1480759411838:p + addSTOline(
1480759411839:start_date = relative_data[period == 'past', max(send_day)],
1480759411840:sto_line, sto_text, prior_change_dates, text_position
1480759411841:) +
1480759411842:labs(x = 'Send day', y = str_c('Relative', str_replace(variable, '_', ' ')), sep = ' ') +
1480759411843:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759411844:theme(legend.position = 'bottom')
1480759411845:}
1480759416573:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480759431769:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480759431769:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480759431770:ggplot(aes(x = send_day, y = relative_measure)) +
1480759431771:geom_hline(yintercept = 1, linetype = 'dashed')
1480759431771:if (is.null(color)) {
1480759431772:p <- p +
1480759431773:geom_line() +
1480759431774:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480759431775:} else {
1480759431776:p <- p +
1480759431776:geom_point(aes_string(color = color)) +
1480759431777:geom_line(aes_string(color = color))
1480759431778:}
1480759431778:if (trendlines) {
1480759431780:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480759431781:}
1480759431782:if (!is.null(facet)) {
1480759431782:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480759431783:}
1480759431784:p + addSTOline(
1480759431785:start_date = relative_data[period == 'past', max(send_day)],
1480759431786:sto_line, sto_text, prior_change_dates, text_position
1480759431787:) +
1480759431787:labs(x = 'Send day', y = str_c('Relative', str_replace(variable, '_', ' '), sep = ' ')) +
1480759431788:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759431790:theme(legend.position = 'bottom')
1480759431792:}
1480759434677:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480759443563:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1480759480192:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480759480193:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480759480194:ggplot(aes(x = send_day, y = relative_measure)) +
1480759480195:geom_hline(yintercept = 1, linetype = 'dashed')
1480759480196:if (is.null(color)) {
1480759480196:p <- p +
1480759480197:geom_line() +
1480759480198:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480759480199:} else {
1480759480203:p <- p +
1480759480205:geom_point(aes_string(color = color)) +
1480759480206:geom_line(aes_string(color = color))
1480759480208:}
1480759480208:if (trendlines) {
1480759480210:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480759480211:}
1480759480211:if (!is.null(facet)) {
1480759480212:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480759480216:}
1480759480218:p + addSTOline(
1480759480218:start_date = relative_data[period == 'past', max(send_day)],
1480759480219:sto_line, sto_text, prior_change_dates, text_position
1480759480220:) +
1480759480221:labs(x = 'Send day', y = str_c('Relative', str_replace(variable, '_', ' '), sep = ' '))
1480759480222:# scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759480223:# theme(legend.position = 'bottom')
1480759480224:}
1480759484266:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480759488659:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, text = FALSE, facet = 'weekday')
1480759523645:relative_data <- generateRelativeData(campaign_summary)
1480759526140:relative_data
1480759531383:sapply(relative_data, class)
1480759562116:trendlines <- FALSE
1480759565948:facet = 'weekday'
1480759574546:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = 'weekday')
1480759590897:plotRelativeEvolution <- function(relative_data, variable = 'open_rate', color = NULL, facet = NULL, cols = NULL, trendlines = TRUE, prior_change_dates = TRUE, sto_line = TRUE, sto_text = TRUE, text_position = 0.8, offset = 2) {
1480759590898:p <- relative_data[send_day < Sys.Date() - offset] %>%
1480759590899:ggplot(aes(x = send_day, y = relative_measure)) +
1480759590899:geom_hline(yintercept = 1, linetype = 'dashed')
1480759590900:if (is.null(color)) {
1480759590901:p <- p +
1480759590901:geom_line() +
1480759590902:geom_point(fill = 'black', colour = 'white', size = 3, pch = 21)
1480759590903:} else {
1480759590903:p <- p +
1480759590904:geom_point(aes_string(color = color)) +
1480759590904:geom_line(aes_string(color = color))
1480759590905:}
1480759590907:if (trendlines) {
1480759590908:p <- p + geom_smooth(aes(group = send_day < relative_data[period == 'past', max(send_day)]), method = 'lm')
1480759590909:}
1480759590909:if (!is.null(facet)) {
1480759590910:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1480759590911:}
1480759590912:p + addSTOline(
1480759590913:start_date = relative_data[period == 'past', max(send_day)],
1480759590914:sto_line, sto_text, prior_change_dates, text_position
1480759590915:) +
1480759590916:labs(x = 'Send day', y = str_c('Relative', str_replace(variable, '_', ' '), sep = ' ')) +
1480759590917:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480759590918:theme(legend.position = 'bottom')
1480759590919:}
1480759594667:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480759597482:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = 'weekday')
1480759612975:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeOpenRate()
1480759619337:aggregateSummaryToWeeks(campaign_summary)
1480759626206:hey <- aggregateSummaryToWeeks(campaign_summary)
1480759626912:hey
1480759628233:hey
1480759776656:plotWeeklyRelativeMeasure <- function(weekly_aggregates, relative = TRUE, weekly_num = 5) {
1480759776657:yvar <- ifelse(relative, 'relative', 'diff')
1480759776658:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480759776659:geom_hline(yintercept = 1, linetype = 'dashed') +
1480759776659:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480759776659:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480759776660:# geom_vline(
1480759776660:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480759776661:#     linetype = 'dashed'
1480759776661:# ) +
1480759776662:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1480759776662:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480759776663:theme(legend.position = 'bottom')
1480759776664:}
1480759787859:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeMeasure()
1480759923762:plotWeeklyRelativeMeasure <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, weekly_num = 5) {
1480759923763:yvar <- ifelse(relative, 'relative', 'diff')
1480759923764:ytitle <- ifelse(relative, 'Relative', 'Difference in')
1480759923765:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480759923766:geom_hline(yintercept = 1, linetype = 'dashed') +
1480759923766:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480759923767:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480759923767:# geom_vline(
1480759923768:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480759923768:#     linetype = 'dashed'
1480759923769:# ) +
1480759923769:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1480759923770:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480759923771:theme(legend.position = 'bottom') +
1480759923771:labs(x = 'Week of year', y = str_c(ytitle, variable, sep = ' ')
1480759923772:}
1480759930250:plotWeeklyRelativeMeasure <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, weekly_num = 5) {
1480759930251:yvar <- ifelse(relative, 'relative', 'diff')
1480759930252:ytitle <- ifelse(relative, 'Relative', 'Difference in')
1480759930252:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480759930253:geom_hline(yintercept = 1, linetype = 'dashed') +
1480759930254:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480759930254:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480759930256:# geom_vline(
1480759930257:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480759930258:#     linetype = 'dashed'
1480759930259:# ) +
1480759930260:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1480759930261:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480759930262:theme(legend.position = 'bottom') +
1480759930262:labs(x = 'Week of year', y = str_c(ytitle, variable, sep = ' '))
1480759930263:}
1480759937458:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeMeasure()
1480759995947:campaign_summary
1480760004581:relative_data
1480760135268:source('global.R')
1480760159509:cucc <- aggregateSummaryToWeeks(campaign_summary)
1480760160342:cucc
1480760161677:cucc
1480760325900:plotWeeklyRelativeEvolution <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, weekly_num = 5) {
1480760325901:if (relative) {
1480760325902:yvar <- 'relative_measure'
1480760325902:ytitle <- 'Relative'
1480760325904:intercept <- 1
1480760325905:} else {
1480760325906:yvar <- 'diff_measure'
1480760325907:ytitle <- 'Difference in'
1480760325907:intercept <- 0
1480760325908:}
1480760325909:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480760325909:geom_hline(yintercept = intercept, linetype = 'dashed') +
1480760325910:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480760325911:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480760325912:# geom_vline(
1480760325912:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480760325913:#     linetype = 'dashed'
1480760325914:# ) +
1480760325914:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1480760325915:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480760325916:theme(legend.position = 'bottom') +
1480760325917:labs(x = 'Week of year', y = str_c(ytitle, variable, sep = ' '))
1480760325917:}
1480760340838:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480760364236:plotWeeklyRelativeEvolution <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, weekly_num = 5) {
1480760364237:if (relative) {
1480760364237:yvar <- 'relative_measure'
1480760364238:ytitle <- 'Relative'
1480760364238:intercept <- 1
1480760364239:} else {
1480760364240:yvar <- 'diff_measure'
1480760364241:ytitle <- 'Difference in'
1480760364242:intercept <- 0
1480760364242:}
1480760364244:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480760364245:geom_hline(yintercept = intercept, linetype = 'dashed') +
1480760364245:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480760364246:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480760364247:# geom_vline(
1480760364248:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480760364249:#     linetype = 'dashed'
1480760364249:# ) +
1480760364250:scale_y_continuous(breaks = seq(0.85, 1.05, 0.05)) +
1480760364251:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480760364252:theme(legend.position = 'bottom') +
1480760364252:labs(x = 'Week of year', y = str_c(ytitle, str_replace(variable, '_', ' '), sep = ' '))
1480760364253:}
1480760368198:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480760372315:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(relative = FALSE)
1480760386227:plotWeeklyRelativeEvolution <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, weekly_num = 5) {
1480760386228:if (relative) {
1480760386229:yvar <- 'relative_measure'
1480760386229:ytitle <- 'Relative'
1480760386230:intercept <- 1
1480760386230:} else {
1480760386231:yvar <- 'diff_measure'
1480760386232:ytitle <- 'Difference in'
1480760386232:intercept <- 0
1480760386233:}
1480760386234:ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480760386235:geom_hline(yintercept = intercept, linetype = 'dashed') +
1480760386236:geom_line(data = weekly_aggregates[N >= weekly_num]) +
1480760386238:geom_point(aes(fill = factor(N)), colour = 'white', size = 3, pch = 21) +
1480760386239:# geom_vline(
1480760386240:#     aes(xintercept = week(as.Date(SETTINGS[[customer]]$start_date))),
1480760386241:#     linetype = 'dashed'
1480760386242:# ) +
1480760386242:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480760386243:theme(legend.position = 'bottom') +
1480760386244:labs(x = 'Week of year', y = str_c(ytitle, str_replace(variable, '_', ' '), sep = ' '))
1480760386245:}
1480760388908:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(relative = FALSE)
1480760408291:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(relative = TRUE)
1480760414284:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(relative = FALSE)
1480765762386:cucc
1480765835736:aggregateSummaryToWeeks <- function(summary, additional_by = NULL, measure = 'open_rate') {
1480765835737:summary %>%
1480765835738:.[, week_of_year := week(send_day)] %>%
1480765835739:.[
1480765835740:, c(.N, lapply(.SD, mean)),
1480765835741:by = c(c('period', 'segment', 'week_of_year'), additional_by),
1480765835742:.SDcols = measure
1480765835743:] %>%
1480765835743:dcast(
1480765835744:as.formula(paste(paste(c('week_of_year + period + N', additional_by), collapse = '+'), 'segment', sep = '~')),
1480765835745:value.var = measure
1480765835746:) %>%
1480765835747:.[, `:=`(relative_measure = sto / control, diff_measure = sto - control)]
1480765835748:}
1480765842774:cucc <- aggregateSummaryToWeeks(campaign_summary)
1480765843954:cucc
1480765845515:cucc
1480765879386:plotWeeklyRelativeEvolution <- function(weekly_aggregates, variable = 'open_rate', relative = TRUE, filter_dots = TRUE, weekly_num = 5) {
1480765879387:if (relative) {
1480765879387:yvar <- 'relative_measure'
1480765879388:ytitle <- 'Relative'
1480765879388:intercept <- 1
1480765879389:} else {
1480765879390:yvar <- 'diff_measure'
1480765879390:ytitle <- 'Difference in'
1480765879391:intercept <- 0
1480765879391:}
1480765879397:p <- ggplot(data = weekly_aggregates, aes_string(x = 'week_of_year', y = yvar)) +
1480765879398:geom_hline(yintercept = intercept, linetype = 'dashed') +
1480765879401:geom_line(data = weekly_aggregates[N >= weekly_num])
1480765879402:if (filter_dots) {
1480765879403:p <- p + geom_point(data = weekly_aggregates[N >= weekly_num], fill = 'black', color = 'white', size = 3, pch = 21)
1480765879404:} else {
1480765879405:p <- p + geom_point(aes(fill = factor(N)), color = 'white', size = 3, pch = 21)
1480765879405:}
1480765879406:p
1480765879407:geom_vline(
1480765879408:aes(xintercept = weekly_aggregates[period == 'past', max(week_of_year)]),
1480765879410:linetype = 'dashed'
1480765879412:) +
1480765879413:scale_fill_discrete(guide = guide_legend('#campaigns', nrow = 1)) +
1480765879414:theme(legend.position = 'bottom') +
1480765879415:labs(x = 'Week of year', y = str_c(ytitle, str_replace(variable, '_', ' '), sep = ' '))
1480765879417:}
1480766575787:cucc %>% plotWeeklyRelativeEvolution()
1480766611853:source('global.R')
1480766613114:cucc %>% plotWeeklyRelativeEvolution()
1480766627695:cucc %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1480766645157:cucc
1480766749581:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480766756117:campaign_summary %>% plotOpenRatesByDays()
1480766763564:contact_past_open_rates <- calculateContactOpenRate(all_data[period == 'past'])
1480766774756:contact_past_open_rates
1480766945306:all_data
1480766973547:trydt <- all_data[contact_id %in% c(304305871, 779399947)]
1480766975258:trydt
1480767000742:trydt
1480767023066:trydt[, open_rate := mean(opened)][]
1480767056012:tryd[, table(contact_id, opened)]
1480767059443:trydt[, table(contact_id, opened)]
1480767074250:trydt[, open_rate := mean(opened), by = contact_id][]
1480767091144:trydt[period == 'past', open_rate := mean(opened), by = contact_id][]
1480767099700:trydt[period == 'past', open_rate := mean(opened), by = contact_id]
1480767102182:trydt
1480767105563:trydt[]
1480767109180:trydt[period == 'past', open_rate := mean(opened), by = contact_id]
1480767117248:trydt[, open_rate := NULL]
1480767118460:trydt[period == 'past', open_rate := mean(opened), by = contact_id]
1480767124118:trydt[period == 'past', open_rate := mean(opened), by = contact_id][]
1480767328382:trydt[, open_rate := mean(.SD[period == 'past', open_rate]), by = contact_id]
1480767330886:trydt[, open_rate := mean(.SD[period == 'past', open_rate]), by = contact_id][]
1480767354199:trydt[, open_rate := min(.SD[period == 'past', send_day]), by = contact_id][]
1480767358055:trydt[, open_rate := min(.SD[period == 'sto', send_day]), by = contact_id][]
1480767368750:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open]), by = contact_id][]
1480767377906:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767395289:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767402249:trydt[, min(hours_to_open)]
1480767409136:trydt[, min(hours_to_open, na.rm = TRUE)]
1480767426830:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767434714:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767442475:trydt[, open_rate := NULL]
1480767443470:trydt[, open_rate := min(.SD[period == 'sto', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767455890:trydt[, open_rate := min(.SD[period == 'past', hours_to_open], na.rm = TRUE), by = contact_id][]
1480767589733:trydt
1480767596698:trydt[, open_rate := NULL]
1480767598821:trydt
1480767601119:addActivity_ <- function(all_data) {
1480767601119:all_data[, past_open_rate := mean(.SD[period == 'past', opened]), by = contact_id] %>%
1480767601120:.[, activity := cut(
1480767601121:past_open_rate,
1480767601121:breaks = quantile(past_open_rate, probs = seq(0, 1, by = 1/4)),
1480767601122:labels = c('bottom25', 'middle2550', 'middle5075', 'top25'),
1480767601122:right = FALSE, include.lowest = TRUE
1480767601123:)] %>%
1480767601123:.[]
1480767601124:}
1480767606244:addActivity_(trydt)
1480767622076:trydt <- all_data
1480767625680:addActivity_(trydt)
1480767995821:customer <- 'batiwiz'
1480767996055:program <- 'TD120'
1480767999393:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480768022622:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480768034482:all_data %>%
1480768034484:.[segment == 'control' & period == 'sto'] %>%
1480768034485:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1480768034487:ggplot(aes(x = send_day, y = min_send_hour)) +
1480768034489:geom_point()
1480768039008:all_data %>%
1480768039009:.[, .N, by = .(send_day, segment)] %>%
1480768039010:ggplot(aes(x = send_day, y = N, col = segment)) +
1480768039010:geom_point() + geom_line() +
1480768039010:addSTOline(text_position = 0) +
1480768039011:expand_limits(y = 0)
1480768065663:all_data %>%
1480768065663:.[, .N, by = .(send_day, segment)] %>%
1480768065664:ggplot(aes(x = send_day, y = N, col = segment)) +
1480768065664:geom_point() + geom_line() +
1480768065665:addSTOline(start_date = .[perid == 'past', max(send_day)], text_position = 0) +
1480768065665:expand_limits(y = 0)
1480768071384:all_data %>%
1480768071384:.[, .N, by = .(send_day, segment)] %>%
1480768071385:ggplot(aes(x = send_day, y = N, col = segment)) +
1480768071386:geom_point() + geom_line() +
1480768071386:addSTOline(start_date = all_data[perid == 'past', max(send_day)], text_position = 0) +
1480768071387:expand_limits(y = 0)
1480768075820:all_data %>%
1480768075821:.[, .N, by = .(send_day, segment)] %>%
1480768075822:ggplot(aes(x = send_day, y = N, col = segment)) +
1480768075822:geom_point() + geom_line() +
1480768075822:addSTOline(start_date = all_data[period == 'past', max(send_day)], text_position = 0) +
1480768075823:expand_limits(y = 0)
1480768082911:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1480768086116:plotSendTimeDistributionEvolution(program_data)
1480768089239:campaign_summary <- calculateSummary(all_data)
1480768091610:plotOpenRateEvolution(campaign_summary)
1480768093215:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480768173098:source('global.R')
1480768381453:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480768386384:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = 'weekday')
1480768391151:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480768420862:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1480768425958:campaign_summary %>% plotOpenRatesByDays()
1480768480638:generateRelativeData(campaign_summary) %>% plotRelativeOpenRateEvolution(facet = 'weekend')
1480768501093:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(facet = 'weekend')
1480768526312:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1480768550218:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1480768550220:dt_with_median_hours_to_open %>%
1480768550220:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
1480768550221:geom_point() +
1480768550222:geom_line(aes(group = weekday)) +
1480768550222:addSTOline(
1480768550223:start_date = dt_with_hours_to_open[period == 'past', max(send_day)],
1480768550224:sto_line, sto_text, prior_change_dates
1480768550224:) +
1480768550225:expand_limits(y = 0) +
1480768550226:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1480768550227:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1480768550228:theme(legend.position = 'bottom') +
1480768550229:facet_wrap(~ segment)
1480768550230:}
1480768553409:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1480768563305:plotMedianHoursToOpen <- function(dt_with_median_hours_to_open, sto_line = TRUE, sto_text = TRUE, prior_change_dates = TRUE) {
1480768563306:dt_with_median_hours_to_open %>%
1480768563308:ggplot(aes(x = send_day, y = median_hours_to_open, col = weekday)) +
1480768563309:geom_point() +
1480768563310:geom_line(aes(group = weekday)) +
1480768563311:addSTOline(
1480768563312:start_date = dt_with_median_hours_to_open[period == 'past', max(send_day)],
1480768563313:sto_line, sto_text, prior_change_dates
1480768563314:) +
1480768563314:expand_limits(y = 0) +
1480768563315:labs(x = 'day of campaign send', y = 'median send-open distance in hours') +
1480768563317:scale_color_discrete(guide = guide_legend('', nrow = 1)) +
1480768563319:theme(legend.position = 'bottom') +
1480768563320:facet_wrap(~ segment)
1480768563320:}
1480768566892:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1480768588318:calculateMedianDistance(all_data) %>%
1480768588319:generateRelativeData(measure = 'median_hours_to_open') %>%
1480768588320:plotRelativeEvolution(trendlines = F, variable = 'median send-open distance (hours)', color = 'weekday')
1480768594728:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480768594728:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480768594729:labs(y = 'Relative open rate in first 2 hour') +
1480768594730:theme(legend.position = 'bottom') +
1480768594730:scale_color_discrete(guide = guide_legend(nrow = 1))
1480768606622:x <- 2
1480768607089:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480768607089:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480768607090:labs(y = 'Relative open rate in first 2 hour') +
1480768607090:theme(legend.position = 'bottom') +
1480768607091:scale_color_discrete(guide = guide_legend(nrow = 1))
1480768664312:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480768664313:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480768664315:labs(y = 'Relative open rate in first 2 hour')
1480768679793:sending_variability <- calculateVariabilityOfLastSends(all_data_active[period == 'sto' & segment == 'sto'], scope = 5)
1480768702992:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480768776497:all_data %>%
1480768776499:.[segment == 'control' & period == 'sto'] %>%
1480768776499:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1480768776499:ggplot(aes(x = send_day, y = min_send_hour)) +
1480768776500:geom_point()
1480768784816:campaign_summary <- calculateSummary(all_data)
1480768788040:plotOpenRateEvolution(campaign_summary)
1480768789685:plotOpenRateEvolution(campaign_summary, smooth = TRUE)
1480768799029:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480768810200:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = 'weekday')
1480768818607:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480768825467:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1480768838918:campaign_summary %>% plotOpenRatesByDays()
1480768845682:addActivity_(all_data)
1480768937811:all_data
1480768950090:all_data[, .(past_open_rate)]
1480768981104:cucc <- all_data[1:100000, .(past_open_rate)]
1480768982071:cucc
1480922467222:source('global.R')
1480922488256:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480922612408:all_data_bkp <- all_data
1480922617739:addActivity_(all_data)  # needs rewrite!
1480922632604:all_data
1480922655095:activity <- all_data[period == 'past', .(contact_id, past_open_rate = mean(opened)), by = contact_id]
1480922658609:activity
1480922666730:all_data[, .N, by=  contact_id]
1480922680716:all_data[period == 'past', .N, by=  contact_id]
1480922693633:activity
1480922705062:activity[, quantile(past_open_rate)]
1480922740945:activity[, quantile(past_open_rate, probs = seq(0, 1, by = 1/4))]
1480922773212:cucc <- c(0, 0, 0, 0, 1, 2, 3, 4, 5, 6)
1480922776567:quantile(cucc)
1480922784741:quantile(cucc, probs = seq(0, 1, by = 0.25))
1480922807274:cut(cucc, breaks = c(0, 1.5))
1480922819185:cut(cucc, breaks = c(0, 1.5), right = FALSE, include.lowest = T)
1480922833359:cut(cucc, breaks = c(0, 1.5, 3.75, 6), right = FALSE, include.lowest = T)
1480922856827:cut(cucc, breaks = c(0, 0, 1.5, 3.75, 6), right = FALSE, include.lowest = T)
1480923170510:rep(1, 10)
1480924046597:2/6
1480924048614:3/8
1480924207659:co <- readRDS('test/contact_opens.rds')
1480924209329:co
1480924227556:co[, .N, by = 'contact_id']
1480924247510:co[, .(.N, mean(opened)), by = 'contact_id']
1480924403533:cucc <- c(0, 0, 0, 1, 2, 3, 4, 5)
1480924420920:cucc(cucc == 0)
1480924426740:cucc[cucc == 0]
1480924443278:cucc[cucc == 0]/length(cucc)
1480924452162:length(cucc[cucc == 0])/length(cucc)
1480924463046:length
1480924653278:seq(0, 1, 0.25)
1480924672567:seq(0, 1, 0.25) > 0.375
1480924712479:quantile
1480924714143:View(hey)
1480924719020:?quantile
1480924753085:?cut
1480924984648:source('global.R')
1480924990109:calculateActivity(c(0, 1, 2, 3))
1480925035389:source('global.R')
1480925037370:calculateActivity(c(0, 1, 2, 3))
1480925047931:debug(calculateActivity)
1480925049625:calculateActivity(c(0, 1, 2, 3))
1480925059456:probs
1480925099742:cut(variable_to_calculate_from, breaks)
1480925174091:source('global.R')
1480925176408:debug(calculateActivity)
1480925179926:calculateActivity(c(0, 1, 2, 3))
1480925195396:calculateActivity(c(0, .1, .2, .3))
1480925237784:calculateActivity(c(0, .1, .2, .3))
1480925252631:cut(variable_to_calculate_from, breaks)
1480925263215:cut(variable_to_calculate_from, breaks, right = F, include.lowest = T)
1480925280022:cut(variable_to_calculate_from, breaks[2:5], right = F, include.lowest = T)
1480925406435:calculateActivity(c(0, .1, .2, .3))
1480925424748:cut(variable_to_calculate_from, breaks, right = F, include.lowest = T)
1480925435205:cut(variable_to_calculate_from, breaks, right = F, include.lowest = T, labels = c('a', 'b', 'c', 'd'))
1480925446707:labels
1480925499948:source('global.R')
1480925504139:calculateActivity(c(0, .1, .2, .3))
1480925514683:calculateActivity(c(.1, .2, .3, .4))
1480925526706:debug(calculateActivity)
1480925528917:calculateActivity(c(.1, .2, .3, .4))
1480925563108:pobs
1480925564867:probs
1480925581578:unique(c(0, 1, 0))
1480932721687:cucc <- fread('data/batiwiz_A-TD120.csv')
1480932724004:cucc
1480932728110:cucc <- fread('data/batiwiz_TD120.csv')
1480932731425:cucc
1480932748080:cucc <- fread('data/batiwiz_TD120_starters_history_2016-08-25.csv')
1480932764110:cucc
1480932774273:cucc_bk <- copy(cucc)
1480932790636:cucc[, as.Date(send_day)]
1480932860158:library(microbenchmark)
1480932907843:microbenchmark(cucc[, as.Date(send_day)], cucc[, as.Date(send_day, '%Y-%m-%d')], cucc[, as.Date(fast_strptime(send_day, '%Y-%m-%d'))])
1480947132811:source('global.R')
1480947143473:calculateActivity(c(0, 0, 0.1, 0.2))
1480947164674:calculateActivity(c(0, 0.1, 0.1, 0.2))
1480947185717:calculateActivity(c(0, 0.1, 0.15, 0.2))
1480947192004:calculateActivity(c(0, 0, 0.15, 0.2))
1480947206220:debug(calculateActivity)
1480947207921:calculateActivity(c(0, 0, 0.15, 0.2))
1480947224765:0.5
1480947272724:debug(calculateActivity)
1480947281476:source('global.R')
1480947285963:calculateActivity(c(0, 0, 0.15, 0.2))
1480947291036:debug(calculateActivity)
1480947292942:calculateActivity(c(0, 0, 0.15, 0.2))
1480947457468:share_of_zeros <- 0.1
1480947459986:c(unique(c(0, share_of_zeros)), seq(0, 1, 0.25)[seq(0, 1, 0.25) > share_of_zeros])
1480947825058:c(unique(c(0, share_of_zeros)), seq(0, 1, 0.25)[seq(0, 1, 0.25) > share_of_zeros])
1480947829283:share_of_zeros <- 0.25
1480947829930:share_of_zeros <- 0.25
1480947830946:c(unique(c(0, share_of_zeros)), seq(0, 1, 0.25)[seq(0, 1, 0.25) > share_of_zeros])
1480947834257:share_of_zeros <- 0.26
1480947835233:c(unique(c(0, share_of_zeros)), seq(0, 1, 0.25)[seq(0, 1, 0.25) > share_of_zeros])
1480947896794:share_of_zeros <- 0
1480947899316:c(unique(c(0, share_of_zeros)), seq(0, 1, 0.25)[seq(0, 1, 0.25) > share_of_zeros])
1480948028006:addActivity_(all_data)
1480948053461:source('global.R')
1480948058403:all_data
1480948084801:addActivity_(all_data)
1480948096069:all_data
1480948167562:source('global.R')
1480948172943:all_data <- addActivity(all_data)
1480948199992:campaign_summary_activity <- calculateSummary(all_data, additional_by = c('activity'))
1480948236258:generateRelativeData(campaign_summary_activity) %>% plotRelativeOpenRateEvolution()
1480948242163:generateRelativeData(campaign_summary_activity) %>% plotRelativeEvolution()
1480948250716:generateRelativeData(campaign_summary_activity)
1480948275703:campaign_summary_activity
1480948289089:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>% plotRelativeEvolution()
1480948298447:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>% plotRelativeEvolution(facet = 'activity')
1480948324845:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>% plotRelativeEvolution(color = 'activity')
1480948341679:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>% plotRelativeEvolution(color = 'activity', trendlines = FALSE)
1480948417621:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>% plotRelativeEvolution(color = 'activity', facet = 'weekday', trendlines = FALSE)
1480952188494:source('global.R')
1480952191377:customer <- 'batiwiz'
1480952191756:program <- 'TD120'
1480952194482:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480952199767:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480952267468:source('global.R')
1480952269857:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480952302780:source('global.R')
1480952302877:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1480952307398:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480952332663:all_data %>%
1480952332664:.[segment == 'control' & period == 'sto'] %>%
1480952332666:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1480952332667:ggplot(aes(x = send_day, y = min_send_hour)) +
1480952332668:geom_point()
1480952335252:all_data %>%
1480952335731:.[, .N, by = .(send_day, segment)] %>%
1480952336151:ggplot(aes(x = send_day, y = N, col = segment)) +
1480952336573:geom_point() + geom_line() +
1480952337005:addSTOline(start_date = all_data[period == 'past', max(send_day)], text_position = 0) +
1480952337404:expand_limits(y = 0)
1480952343737:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480952347103:campaign_summary <- calculateSummary(all_data)
1480952349203:plotOpenRateEvolution(campaign_summary)
1480952353972:plotOpenRateEvolution(campaign_summary)
1480952373239:plotRateEvolution(campaign_summary)
1480952396550:plotRateEvolution(campaign_summary)
1480952399657:source('global.R')
1480952402018:plotRateEvolution(campaign_summary)
1480952429973:plotRateEvolution(campaign_summary, smooth = TRUE)
1480952441499:campaign_summary
1480952457787:campaign_summary %>% ggplot(aes_str('send_day', 'sd'))
1480952461529:campaign_summary %>% ggplot(aes_string('send_day', 'sd'))
1480952465196:campaign_summary %>% ggplot(aes_string('send_day', 'sd')) + geom_line()
1480952478819:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line()
1480952569840:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes_string(min = 'open_rate' - 0.12))
1480952575156:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes_string(min = 'open_rate' - 0.1))
1480952588418:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1))
1480952595336:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1))
1480952604940:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment))
1480952617964:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), alpha = 0.3)
1480952630484:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), alpha = 0.3, color = NULL)
1480952691807:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), alpha = 0.3, color = NULL)
1480952696064:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), alpha = 0.3)
1480952705944:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), color = NULL, alpha = 0.3)
1480952710080:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), colour = NULL, alpha = 0.3)
1480952716448:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), col = NULL, alpha = 0.3)
1480952720535:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes(min = open_rate - 0.1, max = open_rate + 0.1, fill = segment), col = NA, alpha = 0.3)
1480952763220:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes_string(min = 'open_rate' - 0.1, max = 'open_rate' + 0.1, fill = 'segment'), col = NA, alpha = 0.3)
1480952775075:campaign_summary %>% ggplot(aes_string('send_day', 'open_rate', color = 'segment')) + geom_line() + geom_ribbon(aes_string(min = 'open_rate - 0.1', max = 'open_rate + 0.1', fill = 'segment'), col = NA, alpha = 0.3)
1480952852464:plotRateEvolution <- function(campaign_summary, rate = 'open', smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1480952852465:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1480952852466:ggplot(aes_string(x = 'send_day', y = str_c(rate, 'rate', sep = '_'), color = 'segment')) +
1480952852466:geom_line(aes(group = segment)) +
1480952852467:addSTOline(
1480952852467:start_date = campaign_summary[period == 'past', max(send_day)],
1480952852468:sto_line, sto_text, prior_changes, text_position
1480952852469:) +
1480952852470:labs(x = 'Day', y = str_c(str_to_title(rate), 'rate', sep = ' ')) +
1480952852471:theme(legend.position = 'bottom')
1480952852472:if (smooth) {
1480952852473:p + geom_smooth(aes(fill = segment), span = 0.3)
1480952852475:} else {
1480952852476:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21) +
1480952852477:geom_ribbon(
1480952852478:aes_string(
1480952852479:min = str_c(rate, '_rate + 2*sd/sqrt(n)'),
1480952852480:max = str_c(rate, '_rate - 2*sd/sqrt(n)'),
1480952852481:fill = 'segment'
1480952852482:),
1480952852482:alpha = 0.3, color = NA
1480952852484:)
1480952852485:}
1480952852486:}
1480952860902:plotRateEvolution(campaign_summary)
1480952864865:plotRateEvolution(campaign_summary, smooth = TRUE)
1480952872182:plotRateEvolution(campaign_summary)
1480952894079:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1480953091646:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480953095144:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1480953111220:campaign_summary %>% plotOpenRatesByDays()
1480953116295:all_data <- addActivity(all_data)
1480953125426:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1480953128579:campaign_summary_activity <- calculateSummary(all_data, additional_by = c('activity'))
1480953141923:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1480953143206:plotRelativeEvolution(color = 'activity', facet = 'weekday', trendlines = FALSE)
1480953169285:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1480953170080:plotRelativeEvolution(color = 'weekday', facet = 'activity', trendlines = FALSE)
1480953306555:all_data
1480953365917:all_data[, .N, by = .(contact_id, activity, segment)]
1480953396367:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)]
1480953427920:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953428502:ggplot(aes(activity, N)) + geom_col(fill = segment)
1480953438016:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953438724:ggplot(aes(activity, N)) + geom_col(aes(fill = segment))
1480953445994:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953446439:ggplot(aes(activity, N)) + geom_col(aes(fill = segment), position = 'dodge')
1480953525956:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953526628:ggplot(aes(activity, N)) + geom_bar(aes(fill = segment), position = 'fill')
1480953538111:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953538705:ggplot(aes(activity, N)) + geom_col(aes(fill = segment), position = 'fill')
1480953578720:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953579119:ggplot(aes(segment, N)) + geom_col(aes(fill = activity), position = 'fill')
1480953754522:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953754994:ggplot(aes(segment, N)) + geom_col(aes(fill = activity), position = 'fill') +
1480953755385:theme(legend.position = 'bottom')
1480953774241:library(forcats)
1480953801690:install.packages('forcats')
1480953819669:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953820087:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480953820743:theme(legend.position = 'bottom')
1480953929934:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480953930147:theme(legend.position = 'bottom') +
1480953930519:scale_fill_discrete(guide = guide_legend(reverse = TRUE))
1480953932570:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953933018:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480953933233:theme(legend.position = 'bottom') +
1480953933465:scale_fill_discrete(guide = guide_legend(reverse = TRUE))
1480953946215:all_data[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953946216:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480953946217:theme(legend.position = 'bottom') +
1480953946217:scale_fill_discrete(guide = guide_legend('Activity', reverse = TRUE))
1480953993169:addActivity <- function(all_data) {
1480953993170:activity <- all_data[period == 'past', .(contact_id, past_open_rate = mean(opened)), by = contact_id] %>%
1480953993170:.[, activity := calculateActivity(past_open_rate)]
1480953993171:merged <- merge(all_data, activity[, .(contact_id, activity)], by = 'contact_id')
1480953993171:p <- merged[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480953993172:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480953993172:theme(legend.position = 'bottom') +
1480953993173:scale_fill_discrete(guide = guide_legend('Activity', reverse = TRUE))
1480953993174:print(p)
1480953993174:merged
1480953993175:}
1480954000755:all_data <- addActivity(all_data)
1480954029552:debug(addActivity)
1480954032355:all_data <- addActivity(all_data)
1480954045393:merged
1480954083390:addActivity <- function(all_data) {
1480954083391:activity_dt <- all_data[period == 'past', .(contact_id, past_open_rate = mean(opened)), by = contact_id] %>%
1480954083392:.[, activity := calculateActivity(past_open_rate)]
1480954083392:merged <- merge(all_data, activity_dt[, .(contact_id, activity)], by = 'contact_id')
1480954083393:p <- merged[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480954083394:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480954083395:theme(legend.position = 'bottom') +
1480954083395:scale_fill_discrete(guide = guide_legend('Activity', reverse = TRUE))
1480954083396:print(p)
1480954083398:merged
1480954083399:}
1480954087296:all_data <- addActivity(all_data)
1480954107122:debug(addActivity)
1480954108967:all_data <- addActivity(all_data)
1480954122296:merged
1480954145908:addActivity <- function(all_data) {
1480954145908:activity_dt <- all_data[period == 'past', .(contact_id, past_open_rate = mean(opened)), by = contact_id] %>%
1480954145909:.[, activity := calculateActivity(past_open_rate)]
1480954145910:merged <- merge(all_data[, activity := NULL], activity_dt[, .(contact_id, activity)], by = 'contact_id')
1480954145910:p <- merged[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1480954145911:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1480954145912:theme(legend.position = 'bottom') +
1480954145912:scale_fill_discrete(guide = guide_legend('Activity', reverse = TRUE))
1480954145913:print(p)
1480954145914:merged
1480954145915:}
1480954150192:all_data <- addActivity(all_data)
1480954179012:co <- readRDS('test/contact_opens.rds')
1480954180260:co
1480954204933:all_data[contact_id %in% c(914777987, 885710965)]
1480954230478:all_data[contact_id %in% c(914777987, 885710965) & send_day > '2016-10-03']
1480954379418:source('global.R')
1480954382385:customer <- 'batiwiz'
1480954382591:program <- 'TD120'
1480954383591:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480954402428:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480954435503:o <- readRDS('test/opens.rds')
1480954436200:o
1480954447470:o[, send_time := NULL]
1480954448440:o
1480954467602:o[, bounced:= !is.na(bounce_time)]
1480954475866:o[, opened:= !is.na(open_time)]
1480954476810:o
1480954514476:o[, `:=`(open_time = NULL, bounce_time = NULL)]
1480954515348:o
1480954527862:o[, hours_to_open]
1480954535519:o[, hours_to_open := (1, NA, 1, 1, 2, 1, 2, 2, NA, NA)]
1480954539916:o[, hours_to_open := c(1, NA, 1, 1, 2, 1, 2, 2, NA, NA)]
1480954541117:o
1480954548957:o
1480954563270:saveRDS(o, 'test/opens.rds')
1480954613658:readRDS(co, 'test/contact_opens.rds')
1480954619977:co <- readRDS('test/contact_opens.rds')
1480954620570:co
1480954638746:co[, bounced := FALSE]
1480954648123:co[, opened := !is.na(open_time)]
1480954648706:co
1480954669531:co[, `:=`(open_time = NULL, bounce_time = NULL, send_time = NULL)]
1480954670323:co
1480954709661:co[contact_id == 914777987, activity := 'top25']
1480954722110:co[contact_id == 885710965, activity := 'bottom75']
1480954723278:co
1480954734309:saveRDS(co, 'test/contact_opens.rds')
1480954771394:calculateVariabilityOfLastSends(co)
1480954824540:all_data[period == 'sto' & segment == 'sto'] %>%
1480954824541:calculateCumulativeOpenRate() %>%
1480954824541:merge(
1480954824542:campaign_summary[period == 'sto' & segment == 'control', .(send_day, control_open_rate = open_rate)],
1480954824542:by = 'send_day'
1480954824543:) %>%
1480954824543:.[, .(send_day, hours_to_open, relative_rate = cumulative_open_rate / control_open_rate)] %>%
1480954824544:plotCumulatingOpenRates()
1480954833576:campaign_summary <- calculateSummary(all_data)
1480954837778:all_data[period == 'sto' & segment == 'sto'] %>%
1480954837778:calculateCumulativeOpenRate() %>%
1480954837779:merge(
1480954837779:campaign_summary[period == 'sto' & segment == 'control', .(send_day, control_open_rate = open_rate)],
1480954837780:by = 'send_day'
1480954837780:) %>%
1480954837781:.[, .(send_day, hours_to_open, relative_rate = cumulative_open_rate / control_open_rate)] %>%
1480954837781:plotCumulatingOpenRates()
1480954847181:all_data[period == 'sto' & segment == 'sto'] %>%
1480954847182:calculateCumulativeOpenRate()
1480954862260:all_data[period == 'sto' & segment == 'sto'] %>%
1480954862262:calculateCumulativeOpenRate() %>%
1480954862263:merge(
1480954862263:campaign_summary[period == 'sto' & segment == 'control', .(send_day, control_open_rate = open_rate)],
1480954862263:by = 'send_day'
1480954862264:)
1480954914567:cucc <- all_data[period == 'sto' & segment == 'sto'] %>%
1480954914568:calculateCumulativeOpenRate() %>%
1480954914569:merge(
1480954914569:campaign_summary[period == 'sto' & segment == 'control', .(send_day, control_open_rate = open_rate)],
1480954914569:by = 'send_day'
1480954914570:) %>%
1480954914570:.[, .(send_day, hours_to_open, relative_rate = cumulative_open_rate / control_open_rate)]
1480954916391:cucc
1480954960895:plotCumulatingOpenRates(all_data)
1480955010597:all_data %>% plot_ly(~hours_to_open, ~relative_rate, ~factor(send_day))
1480955017155:cucc %>% plot_ly(~hours_to_open, ~relative_rate, ~factor(send_day))
1480955026045:cucc %>% plot_ly(~hours_to_open, ~relative_rate, ~factor(send_day)) %>% add_lines()
1480955038406:cucc %>% plot_ly(x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>% add_lines()
1480955093330:cucc %>% plot_ly(x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>% add_lines() %>% add_line(y = 1)
1480955096985:cucc %>% plot_ly(x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>% add_lines() %>% add_lines(y = 1)
1480955107698:cucc %>% plot_ly(x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>% add_lines() %>% add_lines(y = 1, color = I('black'))
1480955121598:plotCumulatingOpenRates <- function(sto_data) {
1480955121601:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955121602:add_lines() %>%
1480955121603:add_line(y = 1, name = 'control', color = I('black'))
1480955121605:}
1480955126442:plotCumulatingOpenRates(cucc)
1480955132742:plotCumulatingOpenRates <- function(sto_data) {
1480955132743:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955132743:add_lines() %>%
1480955132744:add_lines(y = 1, name = 'control', color = I('black'))
1480955132744:}
1480955135444:plotCumulatingOpenRates(cucc)
1480955168588:?plotly::add_lines
1480955252027:plotCumulatingOpenRates <- function(sto_data) {
1480955252028:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955252029:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed')
1480955252030:add_lines() %>%
1480955252030:}
1480955256042:plotCumulatingOpenRates <- function(sto_data) {
1480955256042:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955256044:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed')
1480955256045:add_lines() %>%
1480955256046:}
1480955260649:plotCumulatingOpenRates <- function(sto_data) {
1480955260649:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955260650:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed'))
1480955260651:add_lines() %>%
1480955260652:}
1480955276634:plotCumulatingOpenRates <- function(sto_data) {
1480955276636:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955276637:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed') %>%
1480955276637:add_lines() %>%
1480955276638:}
1480955279079:plotCumulatingOpenRates <- function(sto_data) {
1480955279079:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955279080:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed') %>%
1480955279081:add_lines() %>%
1480955279081:}
1480955284678:plotCumulatingOpenRates <- function(sto_data) {
1480955284679:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955284679:add_lines(y = 1, name = 'control', color = I('black'), type = 'dashed') %>%
1480955284680:add_lines()
1480955284680:}
1480955289225:plotCumulatingOpenRates(cucc)
1480955302996:plotCumulatingOpenRates <- function(sto_data) {
1480955302996:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955302997:add_lines(y = 1, name = 'control', color = I('black'), linetype = 'dotted') %>%
1480955302998:add_lines()
1480955302998:}
1480955304323:plotCumulatingOpenRates(cucc)
1480955400886:plotCumulatingOpenRates <- function(sto_data) {
1480955400887:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955400888:add_lines(y = 1, name = 'control', color = I('black'), dash = 'dash') %>%
1480955400888:add_lines()
1480955400889:}
1480955403056:plotCumulatingOpenRates(cucc)
1480955435314:plotCumulatingOpenRates <- function(sto_data) {
1480955435315:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955435316:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash') %>%
1480955435317:add_lines()
1480955435317:}
1480955447587:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash')) %>%
1480955449470:plotCumulatingOpenRates <- function(sto_data) {
1480955449471:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955449472:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash')) %>%
1480955449472:add_lines()
1480955449473:}
1480955450938:plotCumulatingOpenRates <- function(sto_data) {
1480955450940:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955450940:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash')) %>%
1480955450941:add_lines()
1480955450942:}
1480955453305:plotCumulatingOpenRates(cucc)
1480955467371:plotCumulatingOpenRates <- function(sto_data) {
1480955467371:plot_ly(sto_data, x = ~hours_to_open, y = ~relative_rate, color = ~factor(send_day)) %>%
1480955467372:add_lines(y = 1, name = 'control', line = list(color = I('black'), dash = 'dash')) %>%
1480955467373:add_lines()
1480955467373:}
1480955469145:plotCumulatingOpenRates(cucc)
1480955508279:plotCumulatingOpenRates <- function(sto_data) {
1480955508281:plot_ly(sto_data, x = ~hours_to_open) %>%
1480955508282:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash') %>%
1480955508282:add_lines(y = ~relative_rate, color = ~factor(send_day))
1480955508282:}
1480955531321:plotCumulatingOpenRates <- function(sto_data) {
1480955531322:plot_ly(sto_data, x = ~hours_to_open) %>%
1480955531323:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash')) %>%
1480955531324:add_lines(y = ~relative_rate, color = ~factor(send_day))
1480955531325:}
1480955533323:plotCumulatingOpenRates(cucc)
1480955634716:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480955634717:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480955634718:cum_open_rates <- sto_data %>%
1480955634719:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480955634719:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480955634720:cum_open_rates[segment == 'control', send_hour := 99]
1480955634721:cum_open_rates %>%
1480955634721:plot_ly(
1480955634722:x = hours_to_open, y = cumulative_open_rate, color = factor(send_hour),
1480955634724:text = paste0(send_hour, 'h, ', round(cumulative_open_rate, 4), " - n: ", num_delivered),
1480955634725:hoverinfo = 'text', mode = 'lines'
1480955634726:)
1480955634726:}
1480955675355:all_data %>% plotCumulatingOpenRatesForGivenDate(customer, program, '2016-11-17')
1480955716564:plotCumulatingOpenRatesForGivenDate(all_data, customer, program, '2016-11-17')
1480955722550:debug(plotCumulatingOpenRates)
1480955731303:debug(plotCumulatingOpenRatesForGivenDate)
1480955733943:plotCumulatingOpenRatesForGivenDate(all_data, customer, program, '2016-11-17')
1480955752142:source('global.R')
1480955753930:customer <- 'batiwiz'
1480955753931:program <- 'TD120'
1480955754921:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1480955761923:all_data <- addPastData(customer, program, program_data, refetch = FALSE)
1480955771417:generateCumulativeOpenRates(all_data) %>% plotCumulatingOpenRates()
1480955783705:campaign_summary <- calculateSummary(all_data)
1480955792291:generateCumulativeOpenRates(all_data) %>% plotCumulatingOpenRates()
1480955833884:generateCumulativeOpenRates(all_data)
1480955863277:2*168
1480955884652:# add activity break-up to other functions as plotRateEvolution
1480955886941:generateCumulativeOpenRates(all_data)
1480955893717:generateCumulativeOpenRates(all_data) %>% plotCumulatingOpenRates()
1480955915803:plotCumulatingOpenRates <- function(cumulative_rates) {
1480955915805:cumulative_rates[hours_to_open <= 336] %>%  # two weeks
1480955915806:plot_ly(x = ~hours_to_open) %>%
1480955915807:add_lines(y = 1, name = 'control', line = list(color = 'black', dash = 'dash')) %>%
1480955915807:add_lines(y = ~relative_rate, color = ~factor(send_day))
1480955915809:}
1480955925718:generateCumulativeOpenRates(all_data) %>% plotCumulatingOpenRates()
1480955955033:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480955955034:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480955955035:cum_open_rates <- sto_data %>%
1480955955036:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480955955037:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480955955039:cum_open_rates[segment == 'control', send_hour := 99]
1480955955041:cum_open_rates %>%
1480955955042:plot_ly(
1480955955044:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480955955044:text = str_c(~send_hour, 'h, ', round(~cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480955955045:hoverinfo = 'text', mode = 'lines'
1480955955046:)
1480955955047:}
1480955965560:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-11-17')
1480955994382:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480955999082:cum_open_rates <- sto_data %>%
1480955999083:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480955999084:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956010106:sto_data <- all_data
1480956014083:cum_open_rates <- sto_data %>%
1480956014084:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956014085:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956030940:date <- '2016-09-01'
1480956033995:date
1480956075966:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480956075967:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480956075968:if !(date %in% id_date_dict[, send_day]) {
1480956075969:stop('There is no campaign for the given day.')
1480956075970:}
1480956075971:cum_open_rates <- sto_data %>%
1480956075971:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956075972:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956076096:cum_open_rates[segment == 'control', send_hour := 99]
1480956076097:cum_open_rates %>%
1480956076098:plot_ly(
1480956076098:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956076098:text = str_c(~send_hour, 'h, ', round(cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480956076099:hoverinfo = 'text', mode = 'lines'
1480956076100:)
1480956076103:}
1480956082019:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480956082020:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480956082020:if (!date %in% id_date_dict[, send_day]) {
1480956082021:stop('There is no campaign for the given day.')
1480956082022:}
1480956082022:cum_open_rates <- sto_data %>%
1480956082023:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956082024:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956082025:cum_open_rates[segment == 'control', send_hour := 99]
1480956082025:cum_open_rates %>%
1480956082026:plot_ly(
1480956082028:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956082030:text = str_c(~send_hour, 'h, ', round(cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480956082032:hoverinfo = 'text', mode = 'lines'
1480956082033:)
1480956082034:}
1480956086193:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-11-17')
1480956101203:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-09-08')
1480956110944:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480956110947:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480956110949:if (!date %in% id_date_dict[, send_day]) {
1480956110950:stop('There is no campaign for the given day.')
1480956110951:}
1480956110952:cum_open_rates <- sto_data %>%
1480956110953:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956110954:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956110954:cum_open_rates[segment == 'control', send_hour := 99]
1480956110955:cum_open_rates %>%
1480956110956:plot_ly(
1480956110957:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956110958:text = str_c(~send_hour, 'h, ', round(~cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480956110959:hoverinfo = 'text', mode = 'lines'
1480956110960:)
1480956110961:}
1480956114493:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-09-08')
1480956130137:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480956130138:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480956130139:if (!date %in% id_date_dict[, send_day]) {
1480956130139:stop('There is no campaign for the given day.')
1480956130140:}
1480956130141:cum_open_rates <- sto_data %>%
1480956130141:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956130142:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956130143:cum_open_rates[segment == 'control', send_hour := 99]
1480956130143:cum_open_rates %>%
1480956130144:plot_ly(
1480956130145:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956130146:text = str_c(~send_hour, 'h, ', ~round(cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480956130150:hoverinfo = 'text', mode = 'lines'
1480956130152:)
1480956130153:}
1480956132702:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-09-08')
1480956151465:date <- '2016-09-09'
1480956155531:cum_open_rates <- sto_data %>%
1480956155532:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956155534:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956158563:cum_open_rates[segment == 'control', send_hour := 99]
1480956162857:cum_open_rates
1480956182218:cum_open_rates %>% plot_ly(x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour))
1480956189379:cum_open_rates %>% plot_ly(x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour)) %>% add_lines()
1480956220700:cum_open_rates %>% plot_ly(x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour), mode = 'lines'
1480956222042:)
1480956224308:cum_open_rates %>% plot_ly(x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour), mode = 'lines')
1480956249595:cum_open_rates[hours_to_open <= 336] %>%
1480956249596:plot_ly(
1480956249596:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956249597:text = str_c(~send_hour, 'h, ', ~round(cumulative_open_rate, 4), " - n: ", ~num_delivered),
1480956249597:hoverinfo = 'text', mode = 'lines'
1480956249598:)
1480956343037:cum_open_rates[hours_to_open <= 336] %>%
1480956343038:plot_ly(
1480956343038:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956343039:text = ~str_c(send_hour, 'h, ', round(cumulative_open_rate, 4), " - n: ", num_delivered),
1480956343040:hoverinfo = 'text', mode = 'lines'
1480956343041:)
1480956365228:plotCumulatingOpenRatesForGivenDate(customer, program, all_data, '2016-09-08')
1480956371037:plotCumulatingOpenRatesForGivenDate <- function(customer, program, sto_data, date, condition = 'TRUE') {
1480956371038:id_date_dict <- getCampaignsForProgram(customer, program, refetch = FALSE)
1480956371038:if (!date %in% id_date_dict[, send_day]) {
1480956371039:stop('There is no campaign for the given day.')
1480956371040:}
1480956371043:cum_open_rates <- sto_data %>%
1480956371044:.[campaign_id %in% id_date_dict[send_day == date, campaign_id]] %>%
1480956371045:calculateCumulativeOpenRate(by = c('segment', 'send_day', 'send_hour'))
1480956371047:cum_open_rates[segment == 'control', send_hour := 99]
1480956371048:cum_open_rates[hours_to_open <= 336] %>%
1480956371049:plot_ly(
1480956371049:x = ~hours_to_open, y = ~cumulative_open_rate, color = ~factor(send_hour),
1480956371051:text = ~str_c(send_hour, 'h, ', round(cumulative_open_rate, 4), " - n: ", num_delivered),
1480956371052:hoverinfo = 'text', mode = 'lines'
1480956371052:)
1480956371053:}
1480956381145:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1480956396314:calculateMedianDistance(all_data) %>%
1480956397183:generateRelativeData(measure = 'median_hours_to_open') %>%
1480956397713:plotRelativeEvolution(trendlines = F, variable = 'median send-open distance (hours)', color = 'weekday')
1480956402857:x <- 2
1480956403768:generateRelativeData(calculateSummary(all_data, initial = x)) %>%
1480956404201:plotRelativeEvolution(trendlines = F, color = 'weekday') +
1480956408781:labs(y = 'Relative open rate in first 2 hour')
1480956416168:sending_variability <- calculateVariabilityOfLastSends(all_data_active[period == 'sto' & segment == 'sto'], scope = 5)
1480956421400:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1480956425812:all_data
1480956429691:all_data <- addActivity(all_data)
1480956439724:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1480956452717:aggregateVariability(sending_variability) %>%
1480956453416:plotSendingVariability()
1480956455934:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1480956456450:plotSendingVariability() +
1480956456972:labs(x = 'Send day', y = 'Number of different slots sent in last 5 mails') +
1480956457627:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1480956458262:theme(legend.position = 'bottom')
1481010598831:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481010683498:program_data
1481010732421:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481010861904:program_data
1481010880268:program_data[opened == TRUE & click == FALSE]
1481010883285:program_data[opened == TRUE & clicked == FALSE]
1481010984682:rm(program_data)
1481010987938:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481011164098:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481011275187:program_data
1481011282577:all_data <- addPastData(customer, program, program_data, refetch = TRUE)
1481018519030:all_data
1481019560817:all_data[, .N, by = .(period, segment)]
1481032648745:all_data %>%
1481032648749:.[segment == 'control' & period == 'sto'] %>%
1481032648750:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1481032648751:ggplot(aes(x = send_day, y = min_send_hour)) +
1481032648752:geom_point()
1481032681302:all_data %>%
1481032681302:.[, .N, by = .(send_day, segment)] %>%
1481032681303:ggplot(aes(x = send_day, y = N, col = segment)) +
1481032681304:geom_point() + geom_line() +
1481032681304:addSTOline(start_date = all_data[period == 'past', max(send_day)], text_position = 0) +
1481032681305:expand_limits(y = 0)
1481032818631:source('global.R')
1481033432168:plotEvolution(campaign_summary)
1481033442699:source('global.R')
1481033445001:plotEvolution(campaign_summary)
1481033452921:plotEvolution(campaign_summary, smooth = TRUE)
1481033476854:all_data %>%
1481033477353:.[, .N, by = .(send_day, segment)] %>%
1481033477765:plotEvolution(measure = 'N')
1481033497897:all_data %>%
1481033498266:.[, .N, by = .(send_day, period, segment)] %>%
1481033498635:plotEvolution(measure = 'N')
1481033605960:plotEvolution <- function(campaign_summary, measure = 'open_rate', se = TRUE, smooth = FALSE, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1481033605962:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1481033605965:ggplot(aes_string(x = 'send_day', y = measure, color = 'segment')) +
1481033605966:geom_line(aes(group = segment)) +
1481033605968:addSTOline(
1481033605969:start_date = campaign_summary[period == 'past', max(send_day)],
1481033605970:sto_line, sto_text, prior_changes, text_position
1481033605971:) +
1481033605972:labs(x = 'Day', y = str_to_title(str_replace(measure, '_', ' '))) +
1481033605973:theme(legend.position = 'bottom')
1481033605974:if (smooth) {
1481033605975:p + geom_smooth(aes(fill = segment), span = 0.3)
1481033605975:} else {
1481033605976:if (se) {
1481033605977:p <- p + geom_ribbon(
1481033605978:aes_string(
1481033605979:min = str_c(measure, '+ 2*sd/sqrt(n)'),
1481033605980:max = str_c(measure, '- 2*sd/sqrt(n)'),
1481033605981:fill = 'segment'
1481033605982:),
1481033605983:alpha = 0.3, color = NA
1481033605984:)
1481033605985:}
1481033605986:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21)
1481033605987:}
1481033605988:}
1481033617911:all_data %>%
1481033618375:.[, .N, by = .(send_day, period, segment)] %>%
1481033618801:plotEvolution(measure = 'N', se = FALSE)
1481033642086:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481033642609:plotEvolution(measure = 'N', se = FALSE)
1481033650022:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481033650343:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481033661620:?str_replace
1481033698704:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481033698974:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481033702996:source('global.R')
1481033708564:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481033708565:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481033937823:dog <- "The quick brown dog"
1481033941586:str_to_upper(dog)
1481033945603:str_to_lower(dog)
1481033950322:str_to_title(dog)
1481034187760:source('global.R')
1481034190867:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481034190868:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481034276194:all_data %>% .[segment == 'control' & period == 'sto'] %>%
1481034276195:.[, .(min_send_hour = min(send_hour)), by = send_day] %>%
1481034276196:ggplot(aes(x = send_day, y = min_send_hour)) +
1481034276196:geom_point()
1481034324504:pw_common_contacts <- sapply(
1481034324505:c('sto', 'control', 'both'),
1481034324505:getCommonContactMatrix, campaign_data = all_data[period == 'sto'],
1481034324506:simplify = FALSE
1481034324506:)
1481034625782:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
1481034649493:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1481034652003:plotHeatmapOfCommonContacts(pw_common_contacts$both)
1481034691387:all_data[period == 'sto']
1481034705346:campaign_data <- all_data[period == 'sto']
1481034718593:campaign_ids <- campaign_data[, .(campaign_id)] %>% unique()
1481034722538:campaign_ids
1481034732323:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1481034736108:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
1481034742168:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1481034747663:plotHeatmapOfCommonContacts(pw_common_contacts$both)
1481034794342:pw_common_contacts
1481034832018:campaign_data[segment == 'sto']
1481034835431:campaign_data[segment == 'control']
1481034839272:campaign_data[segment == 'sto']
1481034848945:campaign_data[segment == 'sto', .(send_day, campaign_id)]
1481034854183:campaign_data[segment == 'sto', .(send_day, campaign_id)] %>% unique()
1481034868632:all_data[campaign_id == 617271]
1481034880232:all_data[campaign_id == 617271][, .N, by = .(period, segment)]
1481034929306:pw_common_contacts
1481034980085:debug(getCommonContactMatrix)
1481035009914:getCommonContactMatrix(campaign_data, segment == 'sto')
1481035025573:campaign_data
1481035027781:getCommonContactMatrix(campaign_data, segment == 'sto')
1481035031087:segment
1481035035862:q()
1481035113749:pw_common_contacts <- sapply(
1481035113750:c('sto', 'control', 'both'), function(s) {
1481035113751:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481035113751:}
1481035113751:simplify = FALSE
1481035113752:)
1481035139566:pw_common_contacts <- sapply(
1481035139567:c('sto', 'control', 'both'), function(s) {
1481035139567:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481035139568:}
1481035139568:simplify = FALSE
1481035139568:)
1481035149741:pw_common_contacts <- sapply(
1481035149742:c('sto', 'control', 'both'),
1481035149743:function(s) {
1481035149743:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481035149744:},
1481035149744:simplify = FALSE
1481035149744:)
1481035164660:undebug(getCommonContactMatrix)
1481035169655:pw_common_contacts <- sapply(
1481035169656:c('sto', 'control', 'both'),
1481035169657:function(s) {
1481035169658:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481035169658:},
1481035169659:simplify = FALSE
1481035169659:)
1481035489731:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
1481035496626:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1481035519928:pw <- getCommonContactMatrix(all_data[period == 'sto'], 'sto', F)
1481035639820:pw
1481036535717:debug(getCommonContactMatrix)
1481036538484:pw <- getCommonContactMatrix(all_data[period == 'sto'], 'sto', F)
1481036549606:campaign_ids
1481036557117:campaign_data
1481036562630:campaign_data[segment == segment]
1481036569912:campaign_data[segment == 'sto']
1481036630933:getCommonContactMatrix <- function(campaign_data, segm = c('sto', 'control', 'both'), order_by_weekday = F) {
1481036630934:if (segm == 'both') {
1481036630934:campaign_ids <- campaign_data[, .(campaign_id)] %>%
1481036630935:unique() %>%
1481036630935:addWeekendToDt_(label = FALSE)
1481036630936:used_data <- campaign_data[period == 'sto']
1481036630937:} else {
1481036630940:campaign_ids <- campaign_data[segment == segm, .(send_day, campaign_id)] %>%
1481036630943:unique() %>%
1481036630949:addWeekdayToDt_(label = FALSE)
1481036630951:used_data <- campaign_data[segment == segm]
1481036630952:}
1481036630953:if (order_by_weekday) {
1481036630955:campaign_ids <- campaign_ids[order(weekday)]
1481036630957:}
1481036630961:common_contact_matrix <- outer(
1481036630962:campaign_ids$campaign_id,
1481036630963:campaign_ids$campaign_id,
1481036630965:calculateSharesOfCommonContacts,
1481036630974:dt = used_data
1481036630978:)
1481036630980:rownames(common_contact_matrix) <- paste(campaign_ids$weekday, campaign_ids$campaign_id, sep = "_")
1481036630981:colnames(common_contact_matrix) <- paste(campaign_ids$weekday, campaign_ids$campaign_id, sep = "_")
1481036630988:common_contact_matrix
1481036630989:}
1481036637142:pw <- getCommonContactMatrix(all_data[period == 'sto'], 'sto', F)
1481036650753:pw
1481036654866:plotHeatmapOfCommonContacts(pw)
1481037005635:na <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = FALSE)
1481037018816:a <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = FALSE)
1481037029177:rbindlist(program_data, na, a)
1481037035236:rbindlist(list(program_data, na, a))
1481037040842:program_data <- rbindlist(list(program_data, na, a))
1481037057379:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481037093085:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1481037136779:customer <- 'batiwiz'
1481037138602:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481037139286:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481037148908:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)]
1481037168003:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481037168003:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481037186684:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1481037206894:all_data[send_hour == 3]
1481037231327:all_data[send_hour == 3, .N, by = (campaign_id, period, segment)]
1481037235173:all_data[send_hour == 3, .N, by = .(campaign_id, period, segment)]
1481037307101:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1481037307102:.[, send_day := as.Date(fast_strptime(send_day, "%Y-%m-%d"))]
1481037317835:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE) %>%
1481037317836:.[, send_day := as.Date(fast_strptime(send_day, "%Y-%m-%d"))]
1481037330605:campaigns[campaign_id == 631550]
1481037343411:campaigns[campaign_id == 771620]
1481037870023:campaigns <- getCampaignsForProgram(customer, program, refetch = TRUE) %>%
1481037870024:.[, send_day := as.Date(fast_strptime(send_day, "%Y-%m-%d"))]
1481037875317:campaigns
1481037877974:campaigns
1481037898658:program <- 'TD120'
1481037908333:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481038002828:na <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = TRUE)
1481038043683:a <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = TRUE)
1481038074828:program_data <- rbindlist(list(program_data, na, a))
1481038095407:plotSendTimeDistributionEvolution(program_data)
1481101500220:program_data
1481101509043:program_data[campaign_id == 664220]
1481101514393:program_data[campaign_id == 664220][, .N, by = send_hour]
1481101527494:program_data[campaign_id == 664220][, .N, keyby = send_hour]
1481101720370:plotSendTimeDistributionEvolution <- function(campaign_data) {
1481101720370:calculateSendDistribution(campaign_data[segment == 'sto']) %>%
1481101720371:.[order(send_hour)] %>%
1481101720372:ggplot(aes(x = send_day, y = n)) +
1481101720373:geom_area(aes(fill = factor(send_hour))) +
1481101720374:addSTOline(sto_line = FALSE, sto_text = FALSE) +
1481101720375:labs(y = 'number of sends', x = 'day') +
1481101720376:theme(legend.position = 'bottom') +
1481101720377:scale_fill_discrete(guide = guide_legend('send hour', nrow = 1)) +
1481101720379:scale_y_continuous(labels = comma)
1481101720381:}
1481101727011:plotSendTimeDistributionEvolution(program_data)
1481101834755:plotSendTimeDistributionEvolution <- function(campaign_data) {
1481101834756:calculateSendDistribution(campaign_data[segment == 'sto']) %>%
1481101834757:.[order(send_hour)] %>%
1481101834757:ggplot(aes(x = send_day, y = n)) +
1481101834757:geom_area(aes(fill = factor(send_hour))) +
1481101834758:addSTOline(sto_line = FALSE, sto_text = FALSE) +
1481101834758:labs(y = 'number of sends', x = 'day') +
1481101834759:theme(legend.position = 'bottom') +
1481101834759:scale_fill_discrete(guide = guide_legend('send hour', nrow = 1)) +
1481101834759:scale_y_continuous(labels = scales::comma)
1481101834760:}
1481101837977:plotSendTimeDistributionEvolution(program_data)
1481102095865:program_data[segment == 'sto' & send_day == '2016-10-26', .N, by = send_hour]
1481102170254:program_data[, .N, by = .(segment, send_hour)]
1481102180849:program_data[, .N, by = .(segment, send_day, send_hour)]
1481102252836:program_data[, .N, by = .(segment, send_day, send_hour)][send_day == '2016-10-26']
1481102260247:program_data[, .N, by = .(segment, send_day, send_hour)][send_day == '2016-10-27']
1481102298820:program_data[, .N, by = .(segment, send_day, send_hour)][send_day == '2016-10-28']
1481102774654:program_data[segment == 'sto'][send_day == '2016-10-28']
1481103324268:program_data[, .N, by = .(segment, campaign_id, send_hour)][campaign_id == 664220]
1481103514934:program_data[campaign_id == 664220]
1481104402681:program_data[, .N, by = .(send_day, campaign_id, segment)]
1481104413215:program_data[, .N, by = .(send_day, campaign_id, segment)][send_day > '2016-11-01']
1481104474201:program_data[, .N, keyby = .(send_day, campaign_id, segment)][send_day > '2016-11-01' & segment == 'sto']
1481104539253:program_data[, .N, keyby = .(send_day, campaign_id, segment)][send_day == '2016-11-17' & segment == 'sto']
1481104835005:program_data
1481104869986:program_data[campaign_id = 664220]
1481104879539:program_data[campaign_id == 664220]
1481105177638:program_data[, .N, by = .(segment, send_date, campaign_id)][segment == 'sto' & send_day == '2016-11-17']
1481105182681:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto' & send_day == '2016-11-17']
1481114013644:plotSendTimeDistributionEvolution(program_data)
1481114017887:campaign_summary <- calculateSummary(all_data)
1481114026353:plotEvolution(campaign_summary)
1481114047471:plotEvolution(campaign_summary, smooth = TRUE)
1481114439912:getCommonContactsForCampaignPair <- function(program_data, campaign_id_pair) {
1481114439914:sapply(
1481114439914:c('sto', 'control'),
1481114439915:function(s) {
1481114439916:sapply(
1481114439916:unique(program_data[segment, contact_id])[segment == s, contact_id],
1481114439917:function(id) {
1481114439917:calculateShareOfCommonContacts(
1481114439918:campaign_id_pair[[s]],
1481114439919:id,
1481114439920:dt = program_data
1481114439920:)
1481114439923:}
1481114439925:)
1481114439926:},
1481114439928:simplify = FALSE
1481114439929:)
1481114439930:}
1481114526341:all_data
1481114543874:contactlist
1481114546786:contactlist <- getListOfFirstSTOReceivers(program_data)
1481114551355:customer
1481114564405:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1481114564406:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1481114564407:start_date <- campaigns[segment == 'sto', min(send_day)]
1481114564407:campaign_ids <- campaigns[send_day == start_date, .(campaign_id)]
1481114564408:merge(
1481114564409:program_data[, .(campaign_id, contact_id, sto = as.numeric(segment == 'sto'))],
1481114564410:campaign_ids,
1481114564412:by = 'campaign_id'
1481114564414:) %>%
1481114564415:.[, campaign_id := NULL] %>%
1481114564416:.[]
1481114564417:}
1481114567144:contactlist <- getListOfFirstSTOReceivers(program_data)
1481114575274:debug(getListOfFirstSTOReceivers)
1481114576712:contactlist <- getListOfFirstSTOReceivers(program_data)
1481114587052:program
1481114597179:getCampaignsForProgram(customer, program, F)
1481114612043:contactlist <- getListOfFirstSTOReceivers(program_data)
1481114663634:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481114676083:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481114682908:campaigns
1481114705318:getCampaignDataForCustomer(customer, program, F)
1481114708067:getCampaignDataForCustomer(customer, program, F)
1481114711894:getCampaignDataForCustomer(customer, program, T)
1481114769983:getCampaignDataForCustomer(customer, program, F)
1481114771744:getCampaignDataForCustomer(customer, program, F)
1481114775462:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481114790323:undebug(getListOfFirstSTOReceivers)
1481114792745:contactlist
1481114798383:contactlist[, .N, by = sto]
1481114876303:program_data
1481114892451:program_data[, .(send_day, segment)] %>% unique()
1481114915263:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481114920214:program_data[, .(send_day, segment)] %>% unique()
1481114961553:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1481114961556:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1481114961556:.[, send_day := as.Date(fast_strptime(send_day, "%Y-%m-%d"))]
1481114961562:opens_data <- readSqlResult(
1481114961563:sql_file = 'sql/opens_for_campaign_ids.sql',
1481114961563:result_file_name = str_c(customer, program, sep = '_'),
1481114961564:campaign_id_list = createStringListFromVector(campaigns[, campaign_id]),
1481114961570:start_date = campaigns[, min(send_day)],
1481114961571:end_date = campaigns[, max(send_day)],
1481114961572:customer_id = getIdFromName(customer),
1481114961573:refetch = refetch
1481114961573:)
1481114961576:merge(opens_data, campaigns, by = 'campaign_id')  # %>% unique()  # filter duplicated HDS sends
1481114961578:}
1481114965432:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481114967850:program_data
1481114974087:program_data[, .(send_day, segment)] %>% unique()
1481114993996:getCampaignDataForCustomer(customer, program F)
1481114997423:getCampaignDataForCustomer(customer, program, F)
1481115010515:getCampaignsForProgram(customer, program, F)
1481115022842:getCampaignsForProgram(customer, program, T)
1481115046482:customer
1481115049330:program
1481115262347:SETTINGS[[customer]]$programs[[program]]
1481115297087:getCampaignsForProgram(customer, program, refetch = FALSE)
1481115301858:getCampaignsForProgram(customer, program, refetch = TRUE)
1481115342130:getCampaignsForProgram(customer, program, refetch = TRUE) %>% .[, send_day := as.Date(fast_strptime((send_day, '%Y-%m-%d')))]
1481115367613:getCampaignsForProgram(customer, program, refetch = TRUE) %>% .[, send_day := as.Date(fast_strptime(send_day, '%Y-%m-%d'))]
1481115375302:getCampaignsForProgram(customer, program, refetch = TRUE) %>% .[, send_day := as.Date(fast_strptime(send_day, '%Y-%m-%d'))] %>% print()
1481115396445:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481115400646:program_data
1481115409562:program_data[, .N, by = segment]
1481115414281:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481115501430:rm(dog, date)
1481115509161:rm(pw)
1481115561037:readSqlResult(
1481115561039:sql_file = 'sql/campaigns_for_segment.sql',
1481115561040:database_name = SETTINGS[[customer]]$suite,
1481115561040:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115561041:customer_id = getIdFromName(customer),
1481115561041:start_date = start_date,
1481115561042:segment_name = program_properties$names[[.]],
1481115561042:refetch = FALSE
1481115561043:)
1481115569238:readSqlResult(
1481115569239:sql_file = 'sql/campaigns_for_segment.sql',
1481115569240:database_name = SETTINGS[[customer]]$suite,
1481115569240:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115569240:customer_id = getIdFromName(customer),
1481115569241:start_date = start_date,
1481115569241:segment_name = program_properties$names[[.]],
1481115569242:refetch = TRUE
1481115569242:)
1481115581023:readSqlResult(
1481115581024:sql_file = 'sql/campaigns_for_segment.sql',
1481115581030:database_name = SETTINGS[[customer]]$suite,
1481115581031:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115581033:customer_id = getIdFromName(customer),
1481115581033:start_date = '2016-07-01',
1481115581034:segment_name = program_properties$names[[.]],
1481115581035:refetch = TRUE
1481115581035:)
1481115597184:readSqlResult(
1481115597185:sql_file = 'sql/campaigns_for_segment.sql',
1481115597186:database_name = SETTINGS[[customer]]$suite,
1481115597189:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115597190:customer_id = getIdFromName(customer),
1481115597190:start_date = '2016-07-01',
1481115597191:segment_name = SETTINGS[[customer]]$programs[[program]]$names[[.]],
1481115597191:refetch = TRUE
1481115597192:)
1481115609273:readSqlResult(
1481115609274:sql_file = 'sql/campaigns_for_segment.sql',
1481115609275:database_name = SETTINGS[[customer]]$suite,
1481115609275:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115609276:customer_id = getIdFromName(customer),
1481115609276:start_date = '2016-07-01',
1481115609277:segment_name = SETTINGS[[customer]]$programs[[program]]$names[['control']],
1481115609278:refetch = TRUE
1481115609279:)
1481115990903:readSqlResult(
1481115990904:sql_file = 'sql/campaigns_for_segment.sql',
1481115990904:database_name = SETTINGS[[customer]]$suite,
1481115990905:result_file_name = str_c(customer, program, 'control', 'campaigns', sep = '_'),
1481115990905:customer_id = getIdFromName(customer),
1481115990905:start_date = '2016-07-01',
1481115990906:segment_name = SETTINGS[[customer]]$programs[[program]]$names[['control']],
1481115990906:refetch = TRUE
1481115990907:)
1481116017809:readSqlResult(
1481116017810:sql_file = 'sql/campaigns_for_segment.sql',
1481116017811:database_name = SETTINGS[[customer]]$suite,
1481116017811:result_file_name = str_c(customer, program, 'sto', 'campaigns', sep = '_'),
1481116017812:customer_id = getIdFromName(customer),
1481116017812:start_date = '2016-07-01',
1481116017812:segment_name = SETTINGS[[customer]]$programs[[program]]$names[['sto']],
1481116017813:refetch = TRUE
1481116017813:)
1481116158154:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1481116158155:program_properties <- SETTINGS[[customer]]$programs[[program]]
1481116158156:lapply(
1481116158157:c('sto', 'control'),
1481116158157:function(s) {
1481116158158:readSqlResult(
1481116158158:sql_file = 'sql/campaigns_for_segment.sql',
1481116158159:database_name = SETTINGS[[customer]]$suite,
1481116158160:result_file_name = str_c(customer, program, s, 'campaigns', sep = '_'),
1481116158160:customer_id = getIdFromName(customer),
1481116158161:start_date = start_date,
1481116158162:segment_name = program_properties$names[[s]],
1481116158162:refetch = refetch
1481116158163:) %>%
1481116158164:`if`(s == 'sto', .[n_launches > 1], .) %>%
1481116158164:.[, `:=`(segment = s, n_launches = NULL)]
1481116158165:}
1481116158166:) %>% rbindlist()
1481116158167:}
1481116172682:getCampaignsForProgram(customer, program, refetch = TRUE)
1481116254072:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481116390956:program_data
1481116411965:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481116415262:contactlist
1481116418377:contactlist[, .N, by = sto]
1481116437407:contactlist
1481116445363:program_data
1481116505110:getListOfFirstSTOReceivers <- function(program_data, customer, program) {
1481116505111:campaigns <- getCampaignsForProgram(customer, program, refetch = FALSE)
1481116505112:start_date <- campaigns[segment == 'sto', min(send_day)]
1481116505113:campaign_ids <- campaigns[send_day == start_date, .(campaign_id)]
1481116505113:merge(
1481116505114:program_data[, .(campaign_id, contact_id, segment)],
1481116505115:campaign_ids,
1481116505116:by = 'campaign_id'
1481116505116:) %>%
1481116505119:.[, campaign_id := NULL] %>%
1481116505120:.[]
1481116505121:}
1481116509360:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481116511302:contactlist
1481116591316:createStringValuesForSQLWith <- function(dt) {
1481116591318:dt[, paste0('(', paste(contact_id, as.numeric(segment == 'sto'), sep = ','), ')')] %>%
1481116591320:paste(collapse = ',')
1481116591321:}
1481116597958:createStringListFromVector(contactlist)
1481116609227:createStringListFromVector(contactlist) %>% tail()
1481116618940:a <- createStringListFromVector(contactlist)
1481116622846:a
1481116629667:a[100000:]
1481116632830:a[100000:20000]
1481116637507:a[1]
1481116680352:substr(a, nchar(a) - 100, nchar(a))
1481116686048:substr(a, nchar(a) - 1000, nchar(a))
1481116698362:createStringValuesForSQLWith <- function(dt) {
1481116698362:dt[, paste0('(', paste(contact_id, as.numeric(segment == 'sto'), sep = ','), ')')] %>%
1481116698363:paste(collapse = ',')
1481116698364:}
1481116704191:a <- createStringListFromVector(contactlist)
1481116707584:substr(a, nchar(a) - 1000, nchar(a))
1481116714935:a <- createStringListFromVector(contactlist[1:10])
1481116715951:a
1481116718798:rm(a)
1481116722783:createStringListFromVector(contactlist[1:10])
1481116737088:contactlist
1481116747263:contactlist[, as.numeric(segment == 'sto')]
1481116779220:contactlist[c(1:5, 157000:157005), as.numeric(segment == 'sto')]
1481116797636:contactlist[c(1:5, 157000:157005), str_c(contact_id, as.numeric(segment == 'sto'), sep = ',')]
1481116829520:contactlist[c(1:5, 157000:157005), str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), ')', sep = ','))]
1481116848332:contactlist[c(1:5, 157000:157005), str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), ')')]
1481116868709:contactlist[c(1:5, 157000:157005), str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), sep = ','), ')']
1481116871198:contactlist[c(1:5, 157000:157005), str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), sep = ','), ')')]
1481116879998:contactlist[c(1:5, 157000:157005), str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), sep = ','), ')')] %>% str_c(collapse = ',')
1481116895970:createStringValuesForSQLWith <- function(dt) {
1481116895972:dt[, str_c('(', str_c(contact_id, as.numeric(segment == 'sto'), sep = ','), ')')] %>%
1481116895972:str_c(collapse = ',')
1481116895973:}
1481116908927:contactlist[c(1:5, 157000:157005)] %>% createStringValuesForSQLWith()
1481116935093:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481116945254:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE)
1481117687503:all_data
1481117742621:sapply(class, all_data)
1481117749916:sapply(all_data, class)
1481117756464:'Date' %in% sapply(all_data, class)
1481117778866:!'Date' %in% sapply(all_data, class)
1481117891922:source('global.R')
1481117918957:getCampaignsForProgram(customer, program, refetch = F) %>% convertSendDayToFactor()
1481117924782:cucc <- getCampaignsForProgram(customer, program, refetch = F) %>% convertSendDayToFactor()
1481117932791:cucc <- getCampaignsForProgram(customer, program, refetch = T) %>% convertSendDayToFactor()
1481117951678:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE)
1481118507180:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481118598787:addPastData <- function(customer, program, program_data, contact_list, refetch = FALSE) {
1481118598789:past_data <- getHistoricalOpensForContactlists(
1481118598790:customer,
1481118598790:contactlists_dt = contact_list,
1481118598791:contactlists_name = str_c(program, 'starters', sep = '_'),
1481118598792:end_date = program_data[segment == 'sto', min(send_day)],
1481118598793:refetch = refetch
1481118598794:) %>%
1481118598794:.[, `:=`(segment = c('control', 'sto')[sto + 1], period = 'past')] %>%
1481118598795:convertSendDayToFactor()
1481118598800:combinePastAndSTO(past_data, program_data[, period := 'sto'])
1481118598802:}
1481118601493:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE)
1481119259919:all_data
1481119470663:contactlist
1481119492553:all_data
1481119506543:all_data[campaign_id == 711240]
1481119532739:merge(all_data[campaign_id == 711240], contactlist, by = 'contact_id', all.y = TRUE]
1481119535088:merge(all_data[campaign_id == 711240], contactlist, by = 'contact_id', all.y = TRUE)
1481119551712:merge(all_data[campaign_id == 711240], contactlist, by = 'contact_id', all.y = TRUE)[, mean(!is.na(campaign_id))]
1481119596753:merge(all_data[, .(segment, campaign_id, contact_id)]
1481119603695:all_data[, .(segment, campaign_id, contact_id)]
1481119637905:contactlist
1481119644451:split(contactlist, segment)
1481119649629:contactlist
1481119711458:all_data
1481119721656:all_data[send_day == '2016-08-25']
1481119866095:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481119866096:merge(all_data, contactlist, by = 'contact_list') %>%
1481119866096:.[, .N, by = .(segment, send_day)]
1481119866097:}
1481119880123:cucc <- getRecipientShareForContactlist(all_data, contactlist)
1481119887516:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481119887520:merge(all_data, contactlist, by = 'contact_id') %>%
1481119887520:.[, .N, by = .(segment, send_day)]
1481119887521:}
1481119890105:cucc <- getRecipientShareForContactlist(all_data, contactlist)
1481119912210:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481119912214:merge(all_data, contactlist, by = c('contact_id', 'segment')) %>%
1481119912214:.[, .N, by = .(segment, send_day)]
1481119912215:}
1481119917669:cucc <- getRecipientShareForContactlist(all_data, contactlist)
1481119921081:cucc
1481119940861:contactlist[, .N, by = segment]
1481119972221:merge(cucc, contactlist[, .(initial = .N), by = segment, by = 'segment']
1481119973763:)
1481119976630:merge(cucc, contactlist[, .(initial = .N), by = segment, by = 'segment')
1481119979316:merge(cucc, contactlist[, .(initial = .N), by = segment], by = 'segment')
1481119993175:merge(cucc, contactlist[, .(initial = .N), by = segment], by = 'segment') %>% .[, .(segment, send_day, N/initial)]
1481120139650:all_data[, .N, by = period]
1481120184815:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1481120189173:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481120208221:all_data[, .N, by= period]
1481120232385:all_data[, .(campaign_id, segment, send_day)] %>% unique()
1481120250678:all_data[, .(campaign_id, segment, send_day)] %>% unique() %>% .[send_day == '2016-09-01']
1481120338949:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481120338950:merge(all_data, contactlist, by = c('contact_id', 'segment')) %>%
1481120338951:.[, .N, by = .(segment, send_day, campaign_id)] %>%
1481120338951:merge(contactlist[, .(contactlist_size = .N), by = segment], by = 'segment') %>%
1481120338954:.[, .(segment, send_day, campaign_id, recipient_share = N/contactlist_size)]
1481120338957:}
1481120348867:cucc <- getRecipientShareForContactlist(all_data, contactlist)
1481120357484:cucc
1481120386580:all_data[, .N, by = .(segment, send_day, campaign_id)]
1481120573902:cucc %>% plotEvolution(measure = 'recipient_share')
1481120619463:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481120619464:merge(all_data, contactlist, by = c('contact_id', 'segment')) %>%
1481120619468:.[, .N, by = .(segment, send_day, campaign_id, period)] %>%
1481120619469:merge(contactlist[, .(contactlist_size = .N), by = segment], by = 'segment') %>%
1481120619470:.[, .(segment, period, send_day, campaign_id, recipient_share = N/contactlist_size)]
1481120619471:}
1481120642325:cucc <- getRecipientShareForContactlist(all_data, contactlist)
1481120649971:cucc
1481120652463:cucc %>% plotEvolution(measure = 'recipient_share')
1481120658168:cucc %>% plotEvolution(measure = 'recipient_share', se = FALSE)
1481120797314:cucc[recipient_share == 0]
1481120820846:cucc[recipient_share == 0]
1481120831418:cucc[recipient_share > 0.01] %>% plotEvolution(measure = 'recipient_share', se = FALSE)
1481120892363:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = TRUE)
1481121085721:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = TRUE)
1481121143625:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1481121156281:a_program_data
1481121162613:program_data
1481121174065:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1481121183153:program_data
1481121190620:a_program_data
1481121199928:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481121208018:contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481121214053:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481121232253:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481121232985:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481121266504:program_data <- rbindlist(list(program_data, na, a))
1481121304908:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1481121310201:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481121312520:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1481121316249:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481121326914:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481121327333:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481121450044:all_data %>%
1481121450600:getRecipientShareForContactlist(contactlist) %>%
1481121451228:plotEvolution(measure = 'recipient_share', se = FALSE)
1481121768758:getRecipientShareForContactlist <- function(all_data, contactlist) {
1481121768759:merge(all_data, contactlist, by = c('contact_id', 'segment'), all.x = TRUE) %>%
1481121768760:.[, .(.N, num_recipient = sum(!is.na(campaign_id))), by = .(segment, send_day, campaign_id, period)] %>%
1481121768761:.[N > 100] %>%
1481121768762:merge(contactlist[, .(contactlist_size = .N), by = segment], by = 'segment') %>%
1481121768764:.[, .(segment, period, send_day, campaign_id, recipient_share = num_recipient/contactlist_size)]
1481121768768:}
1481121783734:all_data %>%
1481121783735:getRecipientShareForContactlist(contactlist) %>%
1481121783736:plotEvolution(measure = 'recipient_share', se = FALSE)
1481121846845:merge(all_data, contactlist, by = c('contact_id', 'segment'), all.x = TRUE)
1481121854053:merged <- all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE)
1481121875300:merged <- merge(all_data, contactlist, by = c('contact_id', 'segment'), all.x = TRUE)
1481121892401:cucc <- merged[, .(.N, num_recipient = sum(!is.na(campaign_id))), by = .(segment, send_day, campaign_id, period)]
1481121895914:cucc
1481121901621:merged
1481121917259:contactlist
1481121979873:merged
1481122018278:merged
1481122022682:merged[is.na(contact_id)]
1481122568306:getRecipientShareForContactlist <- function(all_data, contactlist, unique = FALSE) {
1481122568307:by_vars <- c('segment', 'period', 'send_day')
1481122568308:if (unique) {
1481122568309:} else {
1481122568310:by_vars <- c(by_vars, 'campaign_id')
1481122568310:}
1481122568311:merge(all_data, contactlist, by = c('contact_id', 'segment')) %>%
1481122568311:.[, .N, by = by_vars] %>%
1481122568312:merge(contactlist[, .(contactlist_size = .N), by = segment], by = 'segment') %>%
1481122568313:.[, recipient_share := N/contactlist_size]
1481122568314:}
1481122581602:all_data %>%
1481122581603:getRecipientShareForContactlist(contactlist) %>%
1481122581603:plotEvolution(measure = 'recipient_share', se = FALSE)
1481122602451:all_data %>%
1481122602453:getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481122602453:plotEvolution(measure = 'recipient_share', se = FALSE)
1481122759577:getRecipientShareForContactlist <- function(all_data, contactlist, unique = FALSE) {
1481122759579:by_vars <- c('segment', 'period', 'send_day')
1481122759579:if (unique) {
1481122759580:base_data <- all_data[, .(segment, period, send_day, contact_id)] %>% unique()
1481122759581:} else {
1481122759582:by_vars <- c(by_vars, 'campaign_id')
1481122759583:base_data <- all_data
1481122759584:}
1481122759584:merge(base_data, contactlist, by = c('contact_id', 'segment')) %>%
1481122759585:.[, .N, by = by_vars] %>%
1481122759586:merge(contactlist[, .(contactlist_size = .N), by = segment], by = 'segment') %>%
1481122759589:.[, recipient_share := N/contactlist_size]
1481122759592:}
1481122761923:all_data %>%
1481122761924:getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481122761925:plotEvolution(measure = 'recipient_share', se = FALSE)
1481122959963:all_data
1481123195123:all_data[, .(campaign_id, send_day)] %>% unique()
1481123214044:getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481123231669:getCampaignsForProgram(customer, program, refetch = FALSE)
1481123233364:getCampaignsForProgram(customer, program, refetch = FALSE)
1481123234166:getCampaignsForProgram(customer, program, refetch = FALSE)
1481123237223:all_data[, .(campaign_id, send_day)] %>% unique()
1481123241181:getCampaignsForProgram(customer, program, refetch = FALSE)
1481123331928:source('global.R')
1481123360403:last_contactlist <- getListOfLastSTOReceivers(program_data, customer, program)
1481123422791:all_data[period == 'past', .N, by = contact_id][, quantile(N, seq(0, 1, 0.1))]
1481123454540:last_contactlist <- getListOfLastSTOReceivers(program_data, customer, program)
1481123495093:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1481123498554:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481123499948:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1481123507401:stable_contactlist[, .N, by= segment]
1481123621142:all_data <- addPastData(customer, program, program_data, contact_list = first_contactlist, refetch = FALSE) %>%
1481123621783:merge(stable_contactlist, by = c('contact_id', 'segment'))
1481123654269:all_data[, uniqueN(contact_id), by = segment]
1481123666834:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481123667560:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481123674645:all_data %>%
1481123675086:getRecipientShareForContactlist(contactlist) %>%
1481123675490:plotEvolution(measure = 'recipient_share', se = FALSE)
1481123697132:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481123697276:plotEvolution(measure = 'recipient_share', se = FALSE)
1481123752206:contactlist <- stable_contactlist
1481123798151:contactlist <- stable_contactlist
1481123799694:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1481123800770:merge(contactlist, by = c('contact_id', 'segment'))
1481123822240:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481123822764:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481123828673:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1481123828913:plotEvolution(measure = 'recipient_share', se = FALSE)
1481123834997:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481123835155:plotEvolution(measure = 'recipient_share', se = FALSE)
1481123887977:contactlist
1481123893331:contactlist[, .N, by =segment]
1481123945953:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1481123965445:campaign_summary <- calculateSummary(all_data)
1481123970382:plotEvolution(campaign_summary)
1481123972751:plotEvolution(campaign_summary, smooth = TRUE)
1481123982066:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1481123986762:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = 'weekday')
1481124021347:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1481124025781:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1481124031625:all_data <- addActivity(all_data)
1481124115515:campaign_summary_activity <- calculateSummary(all_data, additional_by = c('activity'))
1481124120701:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1481124121255:plotRelativeEvolution(color = 'weekday', facet = 'activity', trendlines = FALSE)
1481124195419:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1481124195420:plotRelativeEvolution(color = 'weekday', facet = 'activity', trendlines = FALSE) +
1481124195421:scale_y_continuous(limits = c(0, 2))
1481125747461:all_data
1481125765578:all_data[, uniqueN(campaign_id), by = .(segment, period)]
1481125954005:install.packages("RcppRoll")
1481125991039:library('RcppRoll')
1481126019799:example(rollit)
1481126095791:roll_sum(1:10, n = 2)
1481126105953:roll_sum(1:10, n = 5)
1481126161396:trydt <- data.table(id = rep(5, c(1, 2)), x = 1:10)
1481126166969:trydt <- data.table(id = rep(c(1, 2), 5), x = 1:10)
1481126169077:trydt
1481126173964:trydt[order(id)]
1481126183402:trydt[order(id)][, roll_sum(x, 2)]
1481126190921:trydt[order(id)][, .(roll_sum(x, 2)), by = id]
1481126201875:trydt[order(id)][, .(id, roll_sum(x, 2)), by = id]
1481126218692:trydt[order(id)][, y := roll_sum(x, 2), by = id]
1481126223663:trydt
1481126236984:trydt[, y := roll_sum(x, 2), by = id]
1481126240002:trydt
1481126247080:trydt[order(x)]
1481126251920:trydt[order(id)]
1481126275854:?roll_sum
1481126302499:trydt[, y := roll_sum(x, 2), by = id][order(id)]
1481126324717:trydt[, y := roll_sumr(x, 2), by = id][order(id)]
1481126339925:trydt[, y := roll_suml(x, 2), by = id][order(id)]
1481126343525:trydt[, y := roll_sumr(x, 2), by = id][order(id)]
1481126469941:all_data
1481126491929:trydt <- all_data[contact_id %in% c(86432, 999959797)]
1481126492890:trydt
1481126560087:calculateOpenFrequency <- function(dt, window_size = 10) {
1481126560088:dt[, .(contact_id, segment, period, send_day, activity, open_frequency = roll_sumr(opened)), by = contact_id]
1481126560089:}
1481126569058:calculateOpenFrequency(trydt)
1481126631342:calculateOpenFrequency <- function(dt, window_size = 10) {
1481126631343:dt[
1481126631344:,
1481126631345:.(
1481126631345:contact_id, segment, period, send_day, activity,
1481126631346:open_frequency = roll_sumr(opened, n = window_size)
1481126631346:),
1481126631347:by = contact_id
1481126631348:]
1481126631348:}
1481126634041:calculateOpenFrequency(trydt)
1481126794576:calculateAverageOpenFrequency <- function(dt_with_open_frequency) {
1481126794577:dt_with_open_frequency[
1481126794577:, .(open_frequency = mean(open_frequency)),
1481126794578:by = .(segment, period, send_day, activity)
1481126794578:]
1481126794579:}
1481126804211:calculateOpenFrequency(trydt) %>% calculateAverageOpenFrequency()
1481126852887:calculateOpenFrequency(all_data_activity) %>%
1481126852889:calculateAverageOpenFrequency() %>%
1481126852890:plotEvolution(measure = 'open_frequency', se = FALSE)
1481126862796:calculateOpenFrequency(all_data) %>%
1481126863211:calculateAverageOpenFrequency() %>%
1481126863646:plotEvolution(measure = 'open_frequency', se = FALSE)
1481126898038:calculateOpenFrequency(all_data) %>%
1481126898360:calculateAverageOpenFrequency() %>%
1481126898731:plotEvolution(measure = 'open_frequency', se = FALSE, facet = 'activity')
1481126917696:of <- calculateOpenFrequency(all_data) %>%
1481126918084:calculateAverageOpenFrequency()
1481126925915:of %>% plotEvolution(measure = 'open_frequency', se = FALSE, facet = 'activity')
1481126984211:plotEvolution <- function(campaign_summary, measure = 'open_rate', se = TRUE, smooth = FALSE, facet = NULL, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1481126984217:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1481126984219:ggplot(aes_string(x = 'send_day', y = measure, color = 'segment')) +
1481126984220:geom_line(aes(group = segment)) +
1481126984221:addSTOline(
1481126984222:start_date = campaign_summary[period == 'past', max(send_day)],
1481126984223:sto_line, sto_text, prior_changes, text_position
1481126984225:) +
1481126984226:labs(x = 'day', y = str_replace_all(measure, '_', ' ')) +
1481126984227:theme(legend.position = 'bottom')
1481126984228:if (!is.null(facet)) {
1481126984230:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1481126984231:}
1481126984232:if (smooth) {
1481126984233:p + geom_smooth(aes(fill = segment), span = 0.3)
1481126984234:} else {
1481126984236:if (se) {
1481126984237:p <- p + geom_ribbon(
1481126984240:aes_string(
1481126984242:min = str_c(measure, '+ 2*sd/sqrt(n)'),
1481126984243:max = str_c(measure, '- 2*sd/sqrt(n)'),
1481126984244:fill = 'segment'
1481126984245:),
1481126984247:alpha = 0.3, color = NA
1481126984248:)
1481126984249:}
1481126984250:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21)
1481126984251:}
1481126984252:}
1481126988388:of %>% plotEvolution(measure = 'open_frequency', se = FALSE, facet = 'activity')
1481127008688:plotEvolution <- function(campaign_summary, measure = 'open_rate', se = TRUE, smooth = FALSE, facet = NULL, cols = NULL, offset = 2, sto_line = TRUE, sto_text = TRUE, prior_changes = FALSE, text_position = 0) {
1481127008696:p <- campaign_summary[send_day < Sys.Date() - offset] %>%
1481127008697:ggplot(aes_string(x = 'send_day', y = measure, color = 'segment')) +
1481127008698:geom_line(aes(group = segment)) +
1481127008699:addSTOline(
1481127008700:start_date = campaign_summary[period == 'past', max(send_day)],
1481127008701:sto_line, sto_text, prior_changes, text_position
1481127008702:) +
1481127008703:labs(x = 'day', y = str_replace_all(measure, '_', ' ')) +
1481127008704:theme(legend.position = 'bottom')
1481127008705:if (!is.null(facet)) {
1481127008706:p <- p + facet_wrap(as.formula(paste('~', facet)), ncol = cols)
1481127008707:}
1481127008710:if (smooth) {
1481127008711:p + geom_smooth(aes(fill = segment), span = 0.3)
1481127008712:} else {
1481127008713:if (se) {
1481127008714:p <- p + geom_ribbon(
1481127008716:aes_string(
1481127008718:min = str_c(measure, '+ 2*sd/sqrt(n)'),
1481127008722:max = str_c(measure, '- 2*sd/sqrt(n)'),
1481127008727:fill = 'segment'
1481127008729:),
1481127008732:alpha = 0.3, color = NA
1481127008733:)
1481127008735:}
1481127008736:p + geom_point(aes(fill = segment), color = 'white', size = 3, pch = 21)
1481127008738:}
1481127008739:}
1481127012335:addActivity <- function(all_data) {
1481127012337:activity_dt <- all_data[period == 'past', .(contact_id, past_open_rate = mean(opened)), by = contact_id] %>%
1481127012338:.[, activity := calculateActivity(past_open_rate)]
1481127012339:merged <- merge(all_data, activity_dt[, .(contact_id, activity)], by = 'contact_id')
1481127012340:p <- merged[, .N, by = .(contact_id, activity, segment)][, .N, by = .(segment, activity)] %>%
1481127012340:ggplot(aes(segment, N)) + geom_col(aes(fill = forcats::fct_rev(activity)), position = 'fill') +
1481127012341:theme(legend.position = 'bottom') +
1481127012344:scale_fill_discrete(guide = guide_legend('activity', reverse = TRUE))
1481127012345:print(p)
1481127012346:merged
1481127012347:}
1481127017086:of %>% plotEvolution(measure = 'open_frequency', se = FALSE, facet = 'activity')
1481127264541:generateRelativeData(of, measure = 'open_frequency', additional_by = 'activity')
1481127281368:generateRelativeData(of, measure = 'open_frequency', base_by = c('period', 'send_day'), additional_by = 'activity')
1481127325852:generateRelativeData(of, measure = 'open_frequency', base_by = c('period', 'send_day'), additional_by = 'activity') %>% plotRelativeEvolution(trendlines = FALSE, facet = 'activity')
1481127346934:generateRelativeData(of, measure = 'open_frequency', base_by = c('period', 'send_day'), additional_by = 'activity') %>% plotRelativeEvolution(variable = 'open_frequency', trendlines = FALSE, facet = 'activity')
1481127553952:all_data[period == 'past', .N, by = .(segment, period, contact_id)]
1481127578915:past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1481127620536:n_past_campaigns %>% hist()
1481127622462:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1481127623486:n_past_campaigns %>% hist()
1481127637539:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1481127683002:all_data <- merge(all_data, n_past_campaigns[N >= 70, .(contact_id, segment)], by = c('contact_id', 'segment'))
1481127693525:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481127693924:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481127709670:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1481127709673:plotEvolution(measure = 'recipient_share', se = FALSE)
1481127718124:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481127718125:plotEvolution(measure = 'recipient_share', se = FALSE)
1481127734375:campaign_summary <- calculateSummary(all_data)
1481127737852:plotEvolution(campaign_summary, smooth = TRUE)
1481127758815:of <- calculateOpenFrequency(all_data) %>%
1481127759199:calculateAverageOpenFrequency()
1481127763929:of %>% plotEvolution(measure = 'open_frequency', se = FALSE, facet = 'activity')
1481127816407:source('global.R')
1481127826798:of <- calculateOpenFrequency(all_data) %>%
1481127827194:calculateAverageOpenFrequency()
1481127847334:of %>% plotEvolution(measure = 'open_frequency', se = FALSE)
1481127862696:of
1481127906076:of[period == 'past', max(send_day)]
1481127961727:of
1481127980527:of[1, open_frequency, by = segment]
1481128010567:of[, .GRP, by = segment]
1481128026113:of[, 1:.N, by = segment]
1481128034979:of[, .(seq(1, .N)), by = segment]
1481128090044:of[send_day >= last_past_date] %>%
1481128090722:.[, sequence := seq(1, .N), by = segment]
1481128093720:last_past_date <- of[period == 'past', max(send_day)]
1481128094153:of[send_day >= last_past_date] %>%
1481128094390:.[, sequence := seq(1, .N), by = segment]
1481128101580:of[send_day >= last_past_date] %>%
1481128101992:.[, sequence := seq(1, .N), by = segment] %>%
1481128102236:.[]
1481128135061:of[send_day >= last_past_date] %>%
1481128135401:.[, sequence := seq(1, .N), by = segment] %>%
1481128135801:.[seq(1, 81, 10)]
1481128152059:of[send_day >= last_past_date] %>%
1481128152448:.[, sequence := seq(1, .N), by = segment] %>%
1481128152790:.[sequence %in% seq(1, 81, 10)]
1481128245066:contactlist <- first_contactlist
1481128246794:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1481128247244:merge(contactlist, by = c('contact_id', 'segment'))
1481128268421:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1481128269262:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1481128272162:all_data <- merge(all_data, n_past_campaigns[N >= 70, .(contact_id, segment)], by = c('contact_id', 'segment'))
1481128346355:campaign_summary <- calculateSummary(all_data)
1481128351327:plotEvolution(campaign_summary)
1481128357187:generateRelativeData(campaign_summary) %>% plotRelativeEvolution(trendlines = F, color = 'weekday', text_position = 0.9)
1481128378441:of <- calculateOpenFrequency(all_data, window_size = 10) %>%
1481128378999:calculateAverageOpenFrequency()
1481128383982:of %>% plotEvolution(measure = 'open_frequency', se = FALSE)
1481128389847:last_past_date <- of[period == 'past', max(send_day)]
1481128390816:of[send_day >= last_past_date] %>%
1481128391663:.[, sequence := seq(1, .N), by = segment] %>%
1481128392252:.[sequence %in% seq(1, 81, 10)]
1481128420610:of[send_day >= last_past_date] %>%
1481128420885:.[, sequence := seq(1, .N), by = segment] %>%
1481128421172:.[sequence %in% seq(1, 81, 10)] %>%
1481128421560:dcast(~ send_day)
1481128434649:of[send_day >= last_past_date] %>%
1481128434969:.[, sequence := seq(1, .N), by = segment] %>%
1481128435218:.[sequence %in% seq(1, 81, 10)] %>%
1481128435593:dcast(send_day ~ .)
1481128462892:of[send_day >= last_past_date] %>%
1481128463326:.[, sequence := seq(1, .N), by = segment] %>%
1481128463488:.[sequence %in% seq(1, 81, 10)] %>%
1481128463710:dcast(send_day ~ ., value.vars = 'open_frequency')
1481128475350:of[send_day >= last_past_date] %>%
1481128475670:.[, sequence := seq(1, .N), by = segment] %>%
1481128475986:.[sequence %in% seq(1, 81, 10)] %>%
1481128476328:dcast(send_day ~ segment, value.vars = 'open_frequency')
1481128484596:of[send_day >= last_past_date] %>%
1481128489636:.[, sequence := seq(1, .N), by = segment] %>%
1481128489987:.[sequence %in% seq(1, 81, 10)] %>%
1481128490358:dcast(send_day + period ~ segment, value.vars = 'open_frequency')
1481128539082:of[send_day >= last_past_date] %>%
1481128539474:.[, sequence := seq(1, .N), by = segment] %>%
1481128539878:.[sequence %in% seq(1, 81, 10)] %>%
1481128540306:dcast(send_day + period ~ segment, value.var = 'open_frequency')
1481128579244:of[send_day >= last_past_date] %>%
1481128579244:.[, sequence := seq(1, .N), by = segment] %>%
1481128579245:.[sequence %in% seq(1, 81, 10)] %>%
1481128579246:dcast(period ~ segment, value.var = 'open_frequency')
1481128593661:of[send_day >= last_past_date] %>%
1481128593661:.[, sequence := seq(1, .N), by = segment] %>%
1481128593662:.[sequence %in% seq(1, 81, 10)] %>%
1481128593662:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481128695496:of[send_day >= last_past_date] %>%
1481128695496:.[, sequence := seq(1, .N), by = segment] %>%
1481128695497:.[sequence %in% seq(1, 81, 10)] %>%
1481128695498:dcast(sequence + period ~ segment, value.var = 'open_frequency') %>% fwrite('data/tmp.csv')
1481128994563:all_data
1481129253287:of <- calculateOpenFrequency(all_data, window_size = 30) %>%
1481129253731:calculateAverageOpenFrequency()
1481129258912:of %>% plotEvolution(measure = 'open_frequency', se = FALSE)
1481129264618:last_past_date <- of[period == 'past', max(send_day)]
1481129264621:of[send_day >= last_past_date] %>%
1481129264621:.[, sequence := seq(1, .N), by = segment] %>%
1481129264622:.[sequence %in% seq(1, 81, 10)] %>%
1481129264622:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129271365:of[send_day >= last_past_date] %>%
1481129271808:.[, sequence := seq(1, .N), by = segment] %>%
1481129272244:.[sequence %in% seq(1, 81, 30)] %>%
1481129272690:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129284292:of[send_day >= last_past_date] %>%
1481129284773:.[, sequence := seq(1, .N), by = segment] %>%
1481129285239:.[sequence %in% seq(1, 91, 30)] %>%
1481129288498:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129307182:of[send_day >= last_past_date] %>%
1481129307184:.[, sequence := seq(1, .N), by = segment] %>%
1481129307184:.[sequence %in% seq(1, 91, 30)]
1481129350183:of[send_day >= last_past_date] %>%
1481129350184:.[, sequence := seq(1, .N), by = segment]
1481129358050:of[send_day >= last_past_date] %>%
1481129358051:.[, sequence := seq(1, .N), by = segment] %>% .[]
1481129442876:of[send_day >= last_past_date] %>%
1481129442876:.[, sequence := seq(1, .N), by = segment] %>%
1481129442878:.[sequence %in% seq(1, 91, 30)] %>%
1481129442878:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129466495:of[send_day >= last_past_date] %>%
1481129466496:.[, sequence := seq(1, .N), by = segment] %>%
1481129466497:.[sequence %in% c(1, 31, 61, 77)] %>%
1481129466497:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129472837:of[send_day >= last_past_date] %>%
1481129472838:.[, sequence := seq(1, .N), by = segment] %>%
1481129472839:.[sequence %in% c(1, 31, 61, 76)] %>%
1481129472839:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481129479969:of[send_day >= last_past_date] %>%
1481129480232:.[, sequence := seq(1, .N), by = segment] %>%
1481129480548:.[sequence %in% c(1, 31, 61, 75)] %>%
1481129480898:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1481189874899:sessionInfo()
1481189885828:source('global.R')
1481189918554:.myfuncs$useEmarsysCRAN()
1481189928842:install.packages('emsconnectr', type = 'source')
1481189944094:source('global.R')
1481189977735:install_github('rstats-db/bigrquery')
1481189983408:devtools::install_github('rstats-db/bigrquery')
1481189996629:source('global.R')
1481190001975:install.packages('emsconnectr', type = 'source')
1481190065442:source('global.R')
1481190069639:sessionInfo()
1481190087168:types_to_read <- c('viewed', 'added', 'purchased')
1481190372244:source('global.R')
1481190373487:types_to_read <- c('viewed', 'added', 'purchased')
1481190374325:data_read <- lapply(setNames(types_to_read, types_to_read), readInPredictData)
1481190392357:data_read <- lapply(setNames(types_to_read, types_to_read), customer = 'evolution-slimming', readInPredictData)
1481190411892:readInPredictData <- function(customer, type, predict_data_folder = 'predict_data', list_of_headers = headers) {
1481190411893:if (!file.exists(file.path('data', predict_data_folder))) {
1481190411893:stop(
1481190411894:'Predict data folder does not exist. Now the data is only available
1481190411895:in text files, not in any db to query.'
1481190411895:)
1481190411896:}
1481190411897:if (!type %in% c('categories', 'viewed', 'added', 'purchased')) {
1481190411898:stop(
1481190411899:'The parameter type should be one of categories, viewed, added, purchased.'
1481190411900:)
1481190411903:}
1481190411905:column_names <- generatePredictHeader(type, list_of_headers)
1481190411906:rbindlist(lapply(
1481190411907:dir(file.path('data', predict_data_folder), pattern = paste0(customer, '.*', type), full.names = TRUE),
1481190411909:function(file) {
1481190411910:fread(
1481190411911:file,
1481190411912:col.names = column_names, sep = '\t'
1481190411913:)
1481190411914:}
1481190411915:))
1481190411920:}
1481190414626:data_read <- lapply(setNames(types_to_read, types_to_read), customer = 'evolution-slimming', readInPredictData)
1481190492138:source('global.R')
1481190493065:types_to_read <- c('viewed', 'added', 'purchased')
1481190493586:data_read <- lapply(setNames(types_to_read, types_to_read), customer = 'evolution-slimming', readInPredictData)
1481190500016:all_data <- rbindlist(lapply(data_read, cleanData), fill = TRUE)
1481190520302:all_data
1481190550099:all_data[, .N, by = email_hash]
1481190559232:all_data[, .N, by = email_hash][order(N)]
1481192059689:?querySuitesForCustomers
1481192133566:readEmailHashCorrespondence <- function(customer) {
1481192133568:email_hash_column <- querySuitesForCustomers(
1481192133569:file_name = 'sql/get_email_hash_column.sql',
1481192133569:customer_id_list = getIdFromName(customer),
1481192133570:customer_id = getIdFromName(customer)
1481192133571:)
1481192133571:email_hash_column
1481192133572:}
1481192140573:readEmailHashCorrespondence('evolution_slimming')
1481192160334:readEmailHashCorrespondence('evolution_slimming')
1481192162014:readEmailHashCorrespondence('evolution_slimming')
1481192163559:readEmailHashCorrespondence('evolution_slimming')
1481192186324:getIdFromName('evolution_slimming')
1481192224293:readEmailHashCorrespondence <- function(customer) {
1481192224294:email_hash_column <- querySuitesForCustomers(
1481192224294:file_name = 'sql/get_email_hash_column.sql',
1481192224295:customer_id_list = as.character(getIdFromName(customer)),
1481192224296:customer_id = getIdFromName(customer)
1481192224297:)
1481192224297:email_hash_column
1481192224298:}
1481192225923:getIdFromName('evolution_slimming')
1481192228383:readEmailHashCorrespondence('evolution_slimming')
1481192308085:debug(querySuitesForCustomers)
1481192312424:readEmailHashCorrespondence('evolution_slimming')
1481192333765:readEmailHashCorrespondence <- function(customer) {
1481192333766:email_hash_column <- querySuitesForCustomers(
1481192333768:file_name = 'sql/get_email_hash_column.sql',
1481192333770:customer_id_list = getIdFromName(customer),
1481192333770:customer_id = getIdFromName(customer)
1481192333771:)
1481192333772:email_hash_column
1481192333773:}
1481192338202:readEmailHashCorrespondence('evolution_slimming')
1481192352015:customer_id_list %>% as.character()
1481192362080:customer_id_list %>% as.character() %>% getSuiteDbNameOfCustomers()
1481192366757:debug(getSuiteDbNameOfCustomers)
1481192368757:customer_id_list %>% as.character() %>% getSuiteDbNameOfCustomers()
1481192413237:missing_customer_ids <- subset(customer_id_list, !customer_id_list %in%
1481192413238:all_customers[, customer_id])
1481192441468:data.table(customer_id = customer_id_list)
1481192453132:data.table(customer_id = customer_id_list) %>% sapply(class)
1481192466495:all_customers[, .(customer_id, env_id)]
1481192470369:all_customers[, .(customer_id, env_id)] %>% sapply(class)
1481192584489:querySuitesForCustomers(query = 'select now();', customer_id_list = '273234747')
1481192594620:querySuitesForCustomers(query = 'select now();', customer_id_list = 273234747)
1481192634521:getListOfAllCustomers()
1481192639601:getListOfAllCustomers() %>% sapply(class)
1481192654707:getListOfAllCustomers
1481192665346:getListOfCustomers
1481192721006:getIdFromName('batiwiz')
1481192724102:getIdFromName('batiwiz') %>% class()
1481192728328:getIdFromName('batiwiz') %>% class()
1481192820105:querySuitesForCustomers
1481192861734:querySuitesForCustomers <- function(file_name = NULL, query = NULL,
1481192861734:customer_id_list, debug = F, ...) {
1481192861736:customers_for_querying <- customer_id_list %>%
1481192861736:as.integer() %>%
1481192861736:getSuiteDbNameOfCustomers()
1481192861736:suite_db_names <- unique(customers_for_querying[,get(envNameCol())])
1481192861737:map(suite_db_names,
1481192861737:function(suite_db) {
1481192861738:customer_ids_in_env_string <- createCustomerIdsString(
1481192861738:customers_for_querying[get(envNameCol()) == suite_db, customer_id]
1481192861738:)
1481192861739:possibly( ~  getSqlResult(
1481192861740:file_name = file_name,
1481192861741:query = query,
1481192861742:database_name = suite_db,
1481192861743:debug = debug,
1481192861743:customer_id_list = customer_ids_in_env_string
1481192861744:,...
1481192861744:) %>%
1481192861745:.[, envNameCol() := suite_db],
1481192861746:otherwise = data.table(env = 'temp_env_name')
1481192861747:)(suite_db) %>%
1481192861747:.[, envNameCol() := suite_db]
1481192861748:}
1481192861748:) %>%
1481192861749:rbindlist(fill = TRUE)
1481192861750:}
1481192930979:readEmailHashCorrespondence('evolution_slimming')
1481193051293:getListOfAllCustomers() %>% sapply(class)
1481193057939:getListOfAllCustomers(refetch = TRUE) %>% sapply(class)
1481194173791:readEmailHashCorrespondence <- function(customer) {
1481194173793:email_hash_column <- getSqlResult(
1481194173793:file_name = 'sql/get_email_hash_column.sql',
1481194173794:database_name = 'suite7'  # make adaptive
1481194173797:customer_id = getIdFromName(customer)
1481194173798:)
1481194173799:email_hash_column
1481194173800:}
1481194179158:readEmailHashCorrespondence <- function(customer) {
1481194179160:email_hash_column <- getSqlResult(
1481194179163:file_name = 'sql/get_email_hash_column.sql',
1481194179165:database_name = 'suite7',  # make adaptive
1481194179166:customer_id = getIdFromName(customer)
1481194179167:)
1481194179168:email_hash_column
1481194179169:}
1481194186402:readEmailHashCorrespondence('evolution_slimming')
1481194242454:readEmailHashCorrespondence('evolution_slimming')
1481194427546:readEmailHashCorrespondence <- function(customer) {
1481194427548:email_hash_column <- getSqlResult(
1481194427548:file_name = 'sql/get_email_hash_column.sql',
1481194427549:database_name = 'suite7',  # make adaptive
1481194427550:customer_id = getIdFromName(customer)
1481194427550:)
1481194427551:getSqlResult(
1481194427552:file_name = 'sql/email_hash_contact_id_correspondence.sql',
1481194427552:database_name = 'suite7',
1481194427553:customer_id = getIdFromName(customer),
1481194427554:email_hash_column = email_hash_column
1481194427555:)
1481194427556:}
1481194429518:readEmailHashCorrespondence('evolution_slimming')
1481194460742:readEmailHashCorrespondence('evolution_slimming')
1481194611967:cucc <- readEmailHashCorrespondence('evolution_slimming')
1481194710549:all_data
1481194725459:merge(all_data, cucc, by = 'contact_id')
1481194732456:merge(all_data, cucc, by = 'email_hash')
1481194846402:readEmailHashCorrespondence <- function(customer) {
1481194846403:email_hash_column <- getSqlResult(
1481194846404:'sql/get_email_hash_column.sql',
1481194846404:database_name = 'suite7',  # make adaptive
1481194846404:customer_id = getIdFromName(customer)
1481194846405:)
1481194846405:readSqlResult(
1481194846406:sql_file = 'sql/email_hash_contact_id_correspondence.sql',
1481194846407:database_name = 'suite7',
1481194846407:result_file_name = paste(customer, 'email_hash_correspondence', sep = '_'),
1481194846409:customer_id = getIdFromName(customer),
1481194846410:email_hash_column = email_hash_column
1481194846411:)
1481194846412:}
1481194922949:data_read <- sapply(types_to_read, readInPredictData, customer = customer, simplify = FALSE)
1481194926454:customer <- 'evolution-slimming'
1481194930017:customer <- 'evolution_slimming'
1481194931306:data_read <- sapply(types_to_read, readInPredictData, customer = customer, simplify = FALSE)
1481194954380:?sapply
1481195013122:types_to_read <- c('viewed', 'added', 'purchased')
1481195013853:data_read <- sapply(
1481195014303:types_to_read,
1481195014715:function(type) readInPredictData(customer, type),
1481195015067:simplify = FALSE
1481195015643:)
1481195034641:readInPredictData(customer, 'added')
1481195039639:readInPredictData()
1481195041536:readInPredictData
1481195060025:getwd()
1481195085705:debug(readInPredictData)
1481195088547:readInPredictData(customer, 'added')
1481195110647:customer
1481195120681:dir(file.path('data', predict_data_folder), pattern = paste0(customer, '.*', type), full.names = TRUE)
1481195144429:dir(file.path('data', predict_data_folder), pattern = paste0('evolution_slimming.*added'), full.names = TRUE)
1481195163266:getIdFromName('evolution_slimming')
1481195165838:getIdFromName('evolution-slimming')
1481195221893:data_read <- sapply(
1481195221894:types_to_read,
1481195221894:function(type) readInPredictData(customer, type),
1481195221895:simplify = FALSE
1481195221895:)
1481195237921:undebug(readInPredictData)
1481195240609:all_data <- rbindlist(lapply(data_read, cleanData), fill = TRUE)
1481195242268:correspondence <- readEmailHashCorrespondence()
1481195248187:correspondence <- readEmailHashCorrespondence(customer)
1481195264418:all_data
1481195290572:merge(all_data, correspondence, by = 'email_hash')
1481195319639:correspondence
1481195323424:correspondence %>% unique()
1481195345277:correspondence[, email_hash] %>% unique()
1481195350912:correspondence[, .(email_hash)] %>% unique()
1481195354766:correspondence %>% unique()
1481195372862:correspondenc[, .N, by = email_hash][order(N)]
1481195375601:correspondence[, .N, by = email_hash][order(N)]
1481195396378:correspondence[email_hash == 'c18f79b869e038e61']
1481195640970:readEmailHashCorrespondence <- function(customer) {
1481195640972:email_hash_column <- getSqlResult(
1481195640972:'sql/get_email_hash_column.sql',
1481195640973:database_name = 'suite7',  # make adaptive
1481195640980:customer_id = getIdFromName(customer)
1481195640980:)
1481195640981:readSqlResult(
1481195640981:sql_file = 'sql/email_hash_contact_id_correspondence.sql',
1481195640982:database_name = 'suite7',
1481195640983:result_file_name = paste(customer, 'email_hash_correspondence', sep = '_'),
1481195640984:customer_id = getIdFromName(customer),
1481195640984:email_hash_column = email_hash_column
1481195640985:) %>%
1481195640986:.[!is.na(email_hash)]
1481195640987:}
1481195652715:correspondence <- readEmailHashCorrespondence(customer)
1481195662869:merge(all_data, correspondence, by = 'email_hash')
1481195665666:all_data
1481195693683:correspondence[is.na(email_hash)]
1481195705452:correspondence[, .N, by = email_hash][order(N)]
1481195718556:readEmailHashCorrespondence <- function(customer) {
1481195718557:email_hash_column <- getSqlResult(
1481195718558:'sql/get_email_hash_column.sql',
1481195718559:database_name = 'suite7',  # make adaptive
1481195718559:customer_id = getIdFromName(customer)
1481195718560:)
1481195718564:readSqlResult(
1481195718565:sql_file = 'sql/email_hash_contact_id_correspondence.sql',
1481195718566:database_name = 'suite7',
1481195718567:result_file_name = paste(customer, 'email_hash_correspondence', sep = '_'),
1481195718568:customer_id = getIdFromName(customer),
1481195718569:email_hash_column = email_hash_column
1481195718571:) %>%
1481195718572:.[!is.na(email_hash) & email_hash != '']
1481195718572:}
1481195732730:correspondence <- readEmailHashCorrespondence(customer)
1481195748748:merge(all_data, correspondence, by = 'email_hash')
1481195810697:?unique
1481195834746:correspondence
1481195842897:correspondence %>% unique(by = 'email_hash')
1481195852549:readEmailHashCorrespondence <- function(customer) {
1481195852554:email_hash_column <- getSqlResult(
1481195852555:'sql/get_email_hash_column.sql',
1481195852556:database_name = 'suite7',  # make adaptive
1481195852556:customer_id = getIdFromName(customer)
1481195852557:)
1481195852559:readSqlResult(
1481195852560:sql_file = 'sql/email_hash_contact_id_correspondence.sql',
1481195852561:database_name = 'suite7',
1481195852563:result_file_name = paste(customer, 'email_hash_correspondence', sep = '_'),
1481195852564:customer_id = getIdFromName(customer),
1481195852564:email_hash_column = email_hash_column
1481195852565:) %>%
1481195852566:.[!is.na(email_hash) & email_hash != ''] %>%
1481195852567:unique(by = 'email_hash')
1481195852568:}
1481195857310:correspondence <- readEmailHashCorrespondence(customer)
1481195880215:merge(all_data, correspondence, by = 'email_hash')
1481195901077:addContactId <- function(data, customer) {
1481195901077:correspondence <- readEmailHashCorrespondence(customer)
1481195901078:merge(data, correspondence, by = 'email_hash')
1481195901079:}
1481195915247:all_data <- addContactId(all_data, customer)
1481195925333:rm(cucc, correspondence)
1481195928344:all_data
1481195973050:all_data[, uniqueN(session_id), by = contact_id][order(N)]
1481195982458:all_data[, uniqueN(session_id), by = contact_id]
1481195993435:all_data[, uniqueN(session_id), by = contact_id] %>% .[, quantile(V!)]
1481195996088:all_data[, uniqueN(session_id), by = contact_id] %>% .[, quantile(V1)]
1481196306141:all_data
1481196379881:all_data[1:10, timestamp]
1481196388675:week(all_data[1:10, timestamp])
1481196546779:week('2016-12-31')
1481196564320:week('2017-01-01')
1481196592840:week('2017-01-02')
1481196595108:week('2017-01-03')
1481196597223:week('2017-01-01')
1481196605092:week('2017-12-31')
1481196606849:week('2017-12-30]')
1481196609665:week('2017-12-30')
1481196620038:week('2016-01-01')
1481196640462:week('2016-01-01')
1481196642077:?week
1481196657806:library(lubridate)
1481196664829:lubridate::week('2016-01-01')
1481196886644:lubridate::isoweek('2016-01-01')
1481196890632:isoweek('2016-01-01')
1481196902559:isoweek('2016-01-04')
1481196916526:isoweek('2017-01-01')
1481197255872:generateWebWeeklyNums <- function(web_data) {
1481197255873:web_data[, week := getWeekFromTimestamp(timestamp)] %>%
1481197255873:.[, .(num_session = uniqueN(session_id)), by = .(contact_id, week)]
1481197255874:}
1481197269942:generateWebWeeklyNums(all_data)
1481197274982:getWeekFromTimestamp <- function(timestamp) {
1481197274983:isoweek(timestamp)
1481197274984:}
1481197276616:generateWebWeeklyNums(all_data)
1481197322399:year('2016-12-30')
1481197329369:generateWebWeeklyNums <- function(web_data) {
1481197329372:web_data[, `:=`(year = year(timestamp), week = getWeekFromTimestamp(timestamp))] %>%
1481197329372:.[, .(num_session = uniqueN(session_id)), by = .(contact_id, year, week)]
1481197329373:}
1481197331640:year('2016-12-30')
1481197347160:generateWebWeeklyNums <- function(web_data) {
1481197347161:web_data[, `:=`(year = year(timestamp), week = isoweek(timestamp))] %>%
1481197347162:.[, .(num_session = uniqueN(session_id)), by = .(contact_id, year, week)]
1481197347162:}
1481197350897:generateWebWeeklyNums(all_data)
1481197534272:filterRelevantFeatureData(generateWebWeeklyNums(all_data), 2016, 40)
1481197562174:generateWebWeeklyNums(all_data) %>% createWeekSequence_()
1481197572890:web_data <- generateWebWeeklyNums(all_data) %>% createWeekSequence_()
1481197575405:web_data
1481197577627:web_data
1481197689895:filterRelevantFeatureData(web_data, 2016, 40)
1481197696287:filterRelevantFeatureData(web_data, 2016, 40, 8)
1481197715748:filterRelevantFeatureData(web_data, 2016, 40, 8) %>% .[, .(min(week), max(week))]
1481197944233:library(caret)
1481197945867:library(ROCR)
1481197946746:source('global.R')
1481197948939:getPurchaseData <- function(customer_name) {
1481197948940:readInRawData('purchase', customer_name = customer_name, start_date = '2015-05-04', end_date = '2016-08-01') %>%
1481197948941:.[!is.na(contact_id)] %>%
1481197948943:cleanRefunds() %>%
1481197948944:aggregateToDailyPurchase() %>%
1481197948945:createWeekSequence_()
1481197948947:}
1481197949861:getEmailRateData <- function(customer_name, start_date) {
1481197949863:readInRawData('email_rates', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1481197949864:createWeekSequence_()
1481197949864:}
1481197950612:getEmailNumberData <- function(customer_name, start_date) {
1481197950613:readInRawData('email_numbers', customer_name = customer_name, start_date = start_date, end_date = '2016-08-01') %>%
1481197950614:createWeekSequence_()
1481197950615:}
1481197952331:purchase_dt <- getPurchaseData('evolution_slimming')
1481197953957:email_number_dt <- getEmailNumberData('evolution_slimming', start_date = '2015-05-04')
1481198003268:splitData <- function(purchase_data, email_data, web_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1481198003271:default_pars <- list(
1481198003271:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1481198003272:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1481198003273:email_aggregation_frequency = email_aggregation_frequency,
1481198003275:email_features = email_features
1481198003276:)
1481198003277:list(
1481198003278:train = do.call(
1481198003279:putTogetherDataForTargetPeriod,
1481198003280:c(target_year = 2016, target_week = 27, default_pars)
1481198003283:),
1481198003284:test = do.call(
1481198003285:putTogetherDataForTargetPeriod,
1481198003286:c(target_year = 2016, target_week = 29, default_pars)
1481198003287:)
1481198003289:)
1481198003290:}
1481198030808:web_data # from explore_predict_data script
1481198260979:END_DATE <- '2016-11-28'
1481198266241:getPurchaseData <- function(customer_name) {
1481198266242:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1481198266243:.[!is.na(contact_id)] %>%
1481198266244:cleanRefunds() %>%
1481198266245:aggregateToDailyPurchase() %>%
1481198266245:createWeekSequence_()
1481198266246:}
1481198267810:getEmailRateData <- function(customer_name) {
1481198267811:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1481198267811:createWeekSequence_()
1481198267812:}
1481198268513:getEmailNumberData <- function(customer_name) {
1481198268514:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1481198268515:createWeekSequence_()
1481198268515:}
1481198270225:source('global.R')
1481198273936:purchase_dt <- getPurchaseData('evolution_slimming')
1481198318199:source('global.R')
1481198319983:getPurchaseData <- function(customer_name) {
1481198319984:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1481198319984:.[!is.na(contact_id)] %>%
1481198319985:cleanRefunds() %>%
1481198319986:aggregateToDailyPurchase() %>%
1481198319986:createWeekSequence_()
1481198319987:}
1481198321530:getEmailRateData <- function(customer_name) {
1481198321531:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1481198321532:createWeekSequence_()
1481198321533:}
1481198322515:getEmailNumberData <- function(customer_name) {
1481198322516:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1481198322517:createWeekSequence_()
1481198322517:}
1481198323777:purchase_dt <- getPurchaseData('evolution_slimming')
1481198336888:email_number_dt <- getEmailNumberData('evolution_slimming')
1481198358228:END_DATE
1481198365459:END_DATE - lubridate::period(62, 'week')
1481198375521:as.Date(END_DATE) - lubridate::period(62, 'week')
1481198394104:readInRawData <- function(type, customer_id, customer_name, end_date) {
1481198394107:if (!(type %in% c("email_rates", "email_numbers", "purchase"))) {
1481198394108:stop("type should be one of email_rates, email_numbers and purchase")
1481198394109:}
1481198394115:if (missing(customer_name)) {
1481198394116:customer_name <- nameFromId(customer_id)
1481198394118:}
1481198394119:if (missing(customer_id)) {
1481198394121:customer_id <- idFromName(customer_name)
1481198394122:}
1481198394124:data_file_name <- file.path(
1481198394125:'data',
1481198394130:paste0(
1481198394131:customer_name, '_', type, '_',
1481198394132:gsub('-', '', end_date), '.csv'
1481198394133:)
1481198394134:)
1481198394136:if (file.exists(data_file_name)) {
1481198394137:data <- fread(data_file_name)
1481198394139:} else {
1481198394140:data <- getSqlResult(
1481198394141:file = queries[[type]],
1481198394143:database_name = chooseDb(type),
1481198394144:customer_name = customer_name,
1481198394147:customer_id = customer_id,
1481198394149:start_date = as.Date(end_date) - lubridate::period(62, 'week'),
1481198394150:end_date = end_date
1481198394151:)
1481198394152:suppressWarnings(dir.create(file.path('data')))
1481198394153:write.csv(data, file = data_file_name, row.names = FALSE, quote = FALSE)
1481198394155:}
1481198394156:data
1481198394158:}
1481198402317:purchase_dt <- getPurchaseData('evolution_slimming')
1481198420534:purchase_dt
1481198423176:purchase_dt
1481198429001:email_number_dt <- getEmailNumberData('evolution_slimming')
1481201988740:email_number_dt
1481201990392:email_number_dt
1481201994760:web_data # from explore_predict_data script
1481201996542:splitData <- function(purchase_data, email_data, web_data, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1481201996544:default_pars <- list(
1481201996544:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1481201996548:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1481201996549:email_aggregation_frequency = email_aggregation_frequency,
1481201996550:email_features = email_features
1481201996551:)
1481201996553:list(
1481201996554:train = do.call(
1481201996555:putTogetherDataForTargetPeriod,
1481201996555:c(target_year = 2016, target_week = 27, default_pars)
1481201996556:),
1481201996557:test = do.call(
1481201996558:putTogetherDataForTargetPeriod,
1481201996559:c(target_year = 2016, target_week = 29, default_pars)
1481201996560:)
1481201996561:)
1481201996562:}
1481202006866:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481202037936:data_14months_number
1481202078178:data_14months_number$train[sum_open > 0]
1481202082837:data_14months_number$train[sum_open == 0]
1481202444451:n_send <- getSqlResult(
1481202444456:query = "SELECT count(distinct contact_id)
1481202444456:FROM email_sends
1481202444457:WHERE sent_at >= #{start_date}
1481202444457:AND sent_at < #{end_date}
1481202444458:AND customer_id = #{customer_id}",
1481202444459:start_date = as.Date(END_DATE) - lubridate::period(62, 'week')
1481202444461:end_date = as.Date(END_DATE) - lubridate::period(2, 'week')
1481202444463:customer_id = getIdFromName(customer)
1481202444486:)
1481202460573:n_send <- getSqlResult(
1481202461132:query = "SELECT count(distinct contact_id)
1481202461739:FROM email_sends
1481202461926:WHERE sent_at >= #{start_date}
1481202462185:AND sent_at < #{end_date}
1481202462365:AND customer_id = #{customer_id}",
1481202462523:start_date = as.Date(END_DATE) - lubridate::period(62, 'week'),
1481202462667:end_date = as.Date(END_DATE) - lubridate::period(2, 'week'),
1481202462987:customer_id = getIdFromName(customer)
1481202463324:)
1481202588864:n_send
1481202605747:n_send <- n_send[, count]
1481202607126:n_send
1481202609845:n_rfm6 <- nrow(data_6months_number$train[bought_last_period == 1])
1481202610195:n_rfm <- nrow(data_14months_number$train[bought_last_period == 1])
1481202611575:n_click <- nrow(data_14months_number$train[sum_click + bought_last_period > 0])
1481202611975:n_open <- nrow(data_14months_number$train[sum_open + bought_last_period > 0])
1481202612400:n_web <- nrow(data_14months_number$train[num_session + bought_last_period > 0])
1481202619781:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1481202630363:splitData <- function(purchase_data, email_data, web_data = NULL, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1481202630364:default_pars <- list(
1481202630364:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1481202630365:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1481202630366:email_aggregation_frequency = email_aggregation_frequency,
1481202630366:email_features = email_features
1481202630367:)
1481202630368:list(
1481202630369:train = do.call(
1481202630371:putTogetherDataForTargetPeriod,
1481202630372:c(target_year = 2016, target_week = 27, default_pars)
1481202630373:),
1481202630373:test = do.call(
1481202630374:putTogetherDataForTargetPeriod,
1481202630375:c(target_year = 2016, target_week = 29, default_pars)
1481202630376:)
1481202630377:)
1481202630378:}
1481202632316:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1481202647323:n_rfm6 <- nrow(data_6months_number$train[bought_last_period == 1])
1481202648843:n_rfm <- nrow(data_14months_number$train[bought_last_period == 1])
1481202649098:n_click <- nrow(data_14months_number$train[sum_click + bought_last_period > 0])
1481202649282:n_open <- nrow(data_14months_number$train[sum_open + bought_last_period > 0])
1481202649463:n_web <- nrow(data_14months_number$train[num_session + bought_last_period > 0])
1481202650073:methods = c(
1481202650429:'bought in last 6 months', 'bought in last 14 months',
1481202650657:'bought or clicked in last 14 months', 'bought or opened in last 14 months',
1481202650843:'bought or web in last 14 months'
1481202651060:)
1481202651341:coverage <- data.table(
1481202651665:method = methods,
1481202651883:n = c(n_rfm6/n_send, n_rfm/n_send, n_click/n_send, n_open/n_send, n_web/n_send)
1481202652077:)
1481202653243:ggplot(coverage, aes(method, n)) +
1481202653648:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1481202653956:geom_text(
1481202654335:aes(y = 0.02, label = paste0(round(n*100, 1), '%')),
1481202654722:hjust = 0, color = 'white'
1481202655209:) +
1481202655690:coord_flip() +
1481202656029:scale_x_discrete(limits = methods) +
1481202656414:scale_y_continuous(label = scales::percent) +
1481202656838:labs(x = '', y = 'percent of contacts')
1481203595448:data_14months_number$train
1481203599083:data_6months_number$train
1481203615708:debug(putTogetherDataForTargetPeriod)
1481203630921:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481203796625:library(caret)
1481203797052:library(ROCR)
1481203817587:getwd()
1481203848407:packrat::restore(prompt = FALSE)
1481203903365:source('global.R')
1481203912711:packrat::restore(prompt = FALSE)
1481203938297:install.packages("SparseM")
1481203990613:q()
1481204004489:packrat::restore(prompt = FALSE)
1481204328039:install.packages("RcppEigen")
1481204343141:packrat::restore(prompt = FALSE)
1481204398775:install.packages("quantreg")
1481204412578:packrat::restore(prompt = FALSE)
1481204574119:install.packages("data.table")
1481204588469:library(caret)
1481204590764:library(ROCR)
1481204593306:source('global.R')
1481204595803:END_DATE <- '2016-11-28'
1481204600932:getPurchaseData <- function(customer_name) {
1481204600933:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1481204600933:.[!is.na(contact_id)] %>%
1481204600934:cleanRefunds() %>%
1481204600934:aggregateToDailyPurchase() %>%
1481204600935:createWeekSequence_()
1481204600936:}
1481204601661:getEmailRateData <- function(customer_name) {
1481204601663:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1481204601663:createWeekSequence_()
1481204601664:}
1481204602151:getEmailNumberData <- function(customer_name) {
1481204602151:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1481204602152:createWeekSequence_()
1481204602153:}
1481204603155:purchase_dt <- getPurchaseData('evolution_slimming')
1481204619189:# email_rate_dt <- getEmailRateData('japancentre', start_date = '2015-05-04')
1481204619191:email_number_dt <- getEmailNumberData('evolution_slimming')
1481204625455:packrat::restore(prompt = FALSE)
1481204645836:customer <- 'evolution_slimming'
1481204647051:types_to_read <- c('viewed', 'added', 'purchased')
1481204647553:data_read <- sapply(
1481204648219:types_to_read,
1481204648486:function(type) readInPredictData(customer, type),
1481204648733:simplify = FALSE
1481204649037:)
1481204650772:all_data <- rbindlist(lapply(data_read, cleanData), fill = TRUE)
1481204651332:all_data <- addContactId(all_data, customer)
1481204676640:corr <- readEmailHashCorrespondence(customer)
1481204772926:getSqlResult("sql/get_email_hash_column.sql", database_name = 'suite7', customer_id = getIdFromName(customer))
1481204781473:getIdFromName(customer)
1481204799979:sessionInfo()
1481204810924:install.packages('emsconnectr', type = 'source')
1481204884221:devtools::install_github('rstats-db/bigrquery')
1481205004780:install.packages('emsconnectr', type = 'source')
1481205039037:packrat::snapshot(prompt = FALSE)
1481205081428:source('global.R')
1481205082788:customer <- 'evolution_slimming'
1481205084073:types_to_read <- c('viewed', 'added', 'purchased')
1481205084723:data_read <- sapply(
1481205085157:types_to_read,
1481205085474:function(type) readInPredictData(customer, type),
1481205086088:simplify = FALSE
1481205086269:)
1481205087405:all_data <- rbindlist(lapply(data_read, cleanData), fill = TRUE)
1481205089054:all_data <- addContactId(all_data, customer)
1481205106853:q()
1481205127171:source('global.R')
1481205136247:customer <- 'evolution_slimming'
1481205137944:types_to_read <- c('viewed', 'added', 'purchased')
1481205138506:data_read <- sapply(
1481205138945:types_to_read,
1481205139352:function(type) readInPredictData(customer, type),
1481205139740:simplify = FALSE
1481205140260:)
1481205142455:all_data <- rbindlist(lapply(data_read, cleanData), fill = TRUE)
1481205144087:all_data <- addContactId(all_data, customer)
1481205151946:web_data <- generateWebWeeklyFeatures(all_data) %>% createWeekSequence_()
1481205163943:all_data[, .N, keyby = as.Date(timestamp)][, diff := as.Date - shift(as.Date)][diff > 1]
1481205172418:all_data
1481205186211:all_data[, .N, keyby = as.Date(timestamp)]
1481205194757:all_data[, .N, keyby = as.Date(timestamp)][, diff := as.Date - shift(as.Date)]
1481205198973:all_data[, .N, keyby = as.Date(timestamp)][, diff := as.Date - shift(as.Date)][diff > 1]
1481205202437:all_data[, .N, keyby = as.Date(timestamp)][, .N, by = format(as.Date, '%b')]
1481205214222:END_DATE <- '2016-11-28'
1481205214911:getPurchaseData <- function(customer_name) {
1481205214912:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1481205214912:.[!is.na(contact_id)] %>%
1481205214913:cleanRefunds() %>%
1481205214914:aggregateToDailyPurchase() %>%
1481205214914:createWeekSequence_()
1481205214915:}
1481205215942:getEmailRateData <- function(customer_name) {
1481205215943:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1481205215944:createWeekSequence_()
1481205215944:}
1481205216660:getEmailNumberData <- function(customer_name) {
1481205216660:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1481205216662:createWeekSequence_()
1481205216663:}
1481205217394:purchase_dt <- getPurchaseData('evolution_slimming')
1481205218080:# email_rate_dt <- getEmailRateData('japancentre', start_date = '2015-05-04')
1481205218239:email_number_dt <- getEmailNumberData('evolution_slimming')
1481205223931:web_data # from explore_predict_data script
1481205258061:pe <- putTogetherDataForTargetPeriod(purchase_dt, email_number_dt)
1481205262976:pe <- putTogetherDataForTargetPeriod(purchase_dt, email_number_dt)
1481205264272:webdata
1481205267409:web_data
1481205273385:web_data[, max(week)]
1481205307344:pe <- putTogetherDataForTargetPeriod(purchase_dt, email_number_dt, target_year = 2016, target_week = 47)
1481205316833:pe
1481205330321:pew <- putTogetherDataForTargetPeriod(purchase_dt, email_number_dt, web_data, target_year = 2016, target_week = 47)
1481205358945:pew
1481205514584:generateWebFeatures <- function(weekly_web_data) {
1481205514585:weekly_web_data[, .(sum_session = sum(num_session)), by = contact_id]
1481205514586:}
1481205523257:generateWebFeatures(web_data)
1481205527283:web_data
1481205712054:generateWebFeatures(web_data) %>% names
1481205719560:generateWebFeatures(web_data) %>% names(-'contact_id')
1481205734761:generateWebFeatures(web_data) %>% names()
1481205767682:generateWebFeatures(web_data) %>% names() %>% setdiff('contact_id')
1481205801846:putTogetherDataForTargetPeriod <- function(
1481205803450:purchase_dt, email_dt = NULL, web_dt = NULL, target_year, target_week,
1481205803850:purchase_relevancy = PURCHASE_RELEVANCY,
1481205804024:email_relevancy = EMAIL_RELEVANCY,
1481205804187:email_aggregation_frequency = EMAIL_AGGREGATION_FREQ,
1481205804355:email_features = c('num_click'),
1481205804479:web_relevancy = WEB_RELEVANCY
1481205804838:) {
1481205804839:labels <- purchase_dt %>%
1481205804840:generateLabelsForTargetPeriod(target_year, target_week)
1481205804841:relevant_purchase <- purchase_dt %>%
1481205804842:filterRelevantFeatureData(target_year, target_week, relevancy = purchase_relevancy)
1481205804845:rfm <- relevant_purchase %>%
1481205804847:calculateRFMFeatures()
1481205804849:last_purchase <- relevant_purchase %>%
1481205804850:getUniquePurchase(last = TRUE) %>%
1481205804851:.[, .(contact_id, last_purchase = sales_amount)]
1481205804853:list_of_dts <- list(labels, rfm, last_purchase)
1481205804855:column_names_to_fill <- lapply(list_of_dts, names) %>% unlist() %>% unique()
1481205804856:if (!is.null(email_dt)) {
1481205804857:email <- getDataWithEmailFeatures(
1481205804858:email_dt, target_year, target_week,
1481205804859:email_relevancy = email_relevancy,
1481205804861:email_aggregation_frequency = email_aggregation_frequency,
1481205804863:features = email_features
1481205804865:)
1481205804866:list_of_dts <- c(list_of_dts, list(email))
1481205804867:}
1481205804869:if (!is.null(web_dt)) {
1481205804870:web <- filterRelevantFeatureData(web_dt, target_year, target_week, relevancy = web_relevancy) %>%
1481205804871:generateWebFeatures()
1481205804872:column_names_to_fill <- c(column_names_to_fill, setdiff(names(web), 'contact_id'))
1481205804873:list_of_dts <- c(list_of_dts, list(web))
1481205804875:}
1481205804877:Reduce(function(...) merge(..., by = 'contact_id', all = TRUE), list_of_dts) %>%
1481205804879:fillZerosForNA_(cols = c(purchase_columns, web_columns)) %>%
1481205804880:.[complete.cases(.)] %>%  # keep only those who got emails
1481205804881:.[, bought_last_period := ifelse(recency == 0, 0, 1)] %>%
1481205804882:factorizePurchased_()
1481205804885:}
1481205815032:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481205819343:source('global.R')
1481205821137:END_DATE <- '2016-11-28'
1481205821897:getPurchaseData <- function(customer_name) {
1481205821898:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1481205821899:.[!is.na(contact_id)] %>%
1481205821899:cleanRefunds() %>%
1481205821900:aggregateToDailyPurchase() %>%
1481205821901:createWeekSequence_()
1481205821901:}
1481205822868:getEmailRateData <- function(customer_name) {
1481205822868:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1481205822869:createWeekSequence_()
1481205822870:}
1481205823185:getEmailNumberData <- function(customer_name) {
1481205823186:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1481205823190:createWeekSequence_()
1481205823191:}
1481205823443:purchase_dt <- getPurchaseData('evolution_slimming')
1481205824120:# email_rate_dt <- getEmailRateData('japancentre', start_date = '2015-05-04')
1481205824120:email_number_dt <- getEmailNumberData('evolution_slimming')
1481205829546:web_data # from explore_predict_data script
1481205829551:# train target: 27-28 week of 2016
1481205829551:# test target: 29-30 week of 2016
1481205829552:splitData <- function(purchase_data, email_data, web_data = NULL, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1481205829553:default_pars <- list(
1481205829553:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1481205829554:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1481205829555:email_aggregation_frequency = email_aggregation_frequency,
1481205829555:email_features = email_features
1481205829556:)
1481205829557:list(
1481205829558:train = do.call(
1481205829559:putTogetherDataForTargetPeriod,
1481205829560:c(target_year = 2016, target_week = 45, default_pars)
1481205829562:),
1481205829562:test = do.call(
1481205829563:putTogetherDataForTargetPeriod,
1481205829566:c(target_year = 2016, target_week = 47, default_pars)
1481205829566:)
1481205829567:)
1481205829570:}
1481205838310:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1481205919564:putTogetherDataForTargetPeriod <- function(
1481205919568:purchase_dt, email_dt = NULL, web_dt = NULL, target_year, target_week,
1481205919569:purchase_relevancy = PURCHASE_RELEVANCY,
1481205919570:email_relevancy = EMAIL_RELEVANCY,
1481205919570:email_aggregation_frequency = EMAIL_AGGREGATION_FREQ,
1481205919573:email_features = c('num_click'),
1481205919574:web_relevancy = WEB_RELEVANCY
1481205919575:)
1481205925180:{
1481205925180:labels <- purchase_dt %>%
1481205925181:generateLabelsForTargetPeriod(target_year, target_week)
1481205925183:relevant_purchase <- purchase_dt %>%
1481205925184:filterRelevantFeatureData(target_year, target_week, relevancy = purchase_relevancy)
1481205925185:rfm <- relevant_purchase %>%
1481205925186:calculateRFMFeatures()
1481205925188:last_purchase <- relevant_purchase %>%
1481205925189:getUniquePurchase(last = TRUE) %>%
1481205925189:.[, .(contact_id, last_purchase = sales_amount)]
1481205925191:list_of_dts <- list(labels, rfm, last_purchase)
1481205925193:column_names_to_fill <- lapply(list_of_dts, names) %>% unlist() %>% unique()
1481205925195:if (!is.null(email_dt)) {
1481205925198:email <- getDataWithEmailFeatures(
1481205925200:email_dt, target_year, target_week,
1481205925203:email_relevancy = email_relevancy,
1481205925204:email_aggregation_frequency = email_aggregation_frequency,
1481205925206:features = email_features
1481205925211:)
1481205925212:list_of_dts <- c(list_of_dts, list(email))
1481205925213:}
1481205925219:if (!is.null(web_dt)) {
1481205925220:web <- filterRelevantFeatureData(web_dt, target_year, target_week, relevancy = web_relevancy) %>%
1481205925223:generateWebFeatures()
1481205925224:column_names_to_fill <- c(column_names_to_fill, setdiff(names(web), 'contact_id'))
1481205925226:list_of_dts <- c(list_of_dts, list(web))
1481205925229:}
1481205925237:Reduce(function(...) merge(..., by = 'contact_id', all = TRUE), list_of_dts) %>%
1481205925239:fillZerosForNA_(cols = column_names_to_fill) %>%
1481205925241:.[complete.cases(.)] %>%  # keep only those who got emails
1481205925242:.[, bought_last_period := ifelse(recency == 0, 0, 1)] %>%
1481205925243:factorizePurchased_()
1481205925246:}
1481205936877:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1481205956757:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481205982015:n_send <- getSqlResult(
1481205982324:query = "SELECT count(distinct contact_id)
1481205982524:FROM email_sends
1481205982733:WHERE sent_at >= #{start_date}
1481205982888:AND sent_at < #{end_date}
1481205983075:AND customer_id = #{customer_id}",
1481205983256:start_date = as.Date(END_DATE) - lubridate::period(62, 'week'),
1481205983397:end_date = as.Date(END_DATE) - lubridate::period(2, 'week'),
1481205983579:customer_id = getIdFromName(customer)
1481205983925:) %>% .[, count]
1481206133960:correspondence <- readEmailHashCorrespondence(customer)
1481206175275:n_rfm6 <- nrow(data_6months_number$train[bought_last_period == 1])
1481206175951:n_rfm <- nrow(data_14months_number$train[bought_last_period == 1])
1481206176613:n_click <- nrow(data_14months_number$train[sum_click + bought_last_period > 0])
1481206178896:n_open <- nrow(data_14months_number$train[sum_open + bought_last_period > 0])
1481206180482:n_web <- nrow(data_14months_number$train[num_session + bought_last_period > 0])
1481206187284:n_web <- nrow(data_14months_number$train[sum_session + bought_last_period > 0])
1481206196098:methods = c(
1481206196387:'bought in last 6 months', 'bought in last 14 months',
1481206196695:'bought or clicked in last 14 months', 'bought or opened in last 14 months',
1481206197018:'bought or web in last 14 months'
1481206197388:)
1481206199626:coverage <- data.table(
1481206199855:method = methods,
1481206200026:n = c(n_rfm6/n_send, n_rfm/n_send, n_click/n_send, n_open/n_send, n_web/n_send)
1481206200218:)
1481206200937:ggplot(coverage, aes(method, n)) +
1481206201103:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1481206201264:geom_text(
1481206201427:aes(y = 0.02, label = paste0(round(n*100, 1), '%')),
1481206201564:hjust = 0, color = 'white'
1481206201730:) +
1481206201884:coord_flip() +
1481206202067:scale_x_discrete(limits = methods) +
1481206202275:scale_y_continuous(label = scales::percent) +
1481206202418:labs(x = '', y = 'percent of contacts')
1481206240753:n_rfm6 <- nrow(data_6months_number$train[bought_last_period == 1])
1481206240759:n_rfm <- nrow(data_14months_number$train[bought_last_period == 1])
1481206240771:n_click <- nrow(data_14months_number$train[sum_click + bought_last_period > 0])
1481206240788:n_open <- nrow(data_14months_number$train[sum_open + sum_click + bought_last_period > 0])
1481206240819:n_web <- nrow(data_14months_number$train[sum_session + sum_open + sum_click + bought_last_period > 0])
1481206243635:methods = c(
1481206243636:'bought in last 6 months', 'bought in last 14 months',
1481206243637:'bought or clicked in last 14 months', 'bought or opened/clicked in last 14 months',
1481206243637:'bought or web/opened/clicked in last 14 months'
1481206243638:)
1481206243638:coverage <- data.table(
1481206243638:method = methods,
1481206243639:n = c(n_rfm6/n_send, n_rfm/n_send, n_click/n_send, n_open/n_send, n_web/n_send)
1481206243639:)
1481206243640:ggplot(coverage, aes(method, n)) +
1481206243640:geom_bar(stat = 'identity', fill = 'darkblue', alpha = 0.8) +
1481206243641:geom_text(
1481206243641:aes(y = 0.02, label = paste0(round(n*100, 1), '%')),
1481206243641:hjust = 0, color = 'white'
1481206243641:) +
1481206243642:coord_flip() +
1481206243642:scale_x_discrete(limits = methods) +
1481206243642:scale_y_continuous(label = scales::percent) +
1481206243643:labs(x = '', y = 'percent of contacts')
1481206285336:rfm_click <- train(
1481206285337:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1481206285339:data = data_14months_number$train[sum_click + bought_last_period > 0],
1481206285340:method = 'glm',
1481206285340:family = 'binomial'
1481206285341:)
1481206288212:library(caret)
1481206289908:library(ROCR)
1481206303687:rfm_click <- train(
1481206303687:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1481206303689:data = data_14months_number$train[sum_click + bought_last_period > 0],
1481206303690:method = 'glm',
1481206303691:family = 'binomial'
1481206303692:)
1481206318151:summary(rfm_click)
1481206318187:rfm_click_open <- train(
1481206318188:purchased ~ recency + frequency + monetary + bought_last_period + sum_open + sum_click,
1481206318188:data = data_14months_number$train[sum_click + bought_last_period > 0],
1481206318189:method = 'glm',
1481206318189:family = 'binomial'
1481206318190:)
1481206333381:summary(rfm_click_open)
1481206342828:rfm_click_open_web <- train(
1481206342829:purchased ~ recency + frequency + monetary + bought_last_period + sum_open + sum_click + sum_session,
1481206342830:data = data_14months_number$train[sum_click + bought_last_period > 0],
1481206342831:method = 'glm',
1481206342831:family = 'binomial'
1481206342835:)
1481206359595:summary(rfm_click_open_web)
1481206436388:calculateAUC <- function(prediction, label) {
1481206436389:predictions <- prediction(prediction, label)
1481206436389:perf <- performance(predictions, measure = "auc")
1481206436390:round(perf@y.values[[1]]*100, 2)
1481206436390:}
1481206437629:createROCDf <- function(prediction, label) {
1481206437631:predictions <- prediction(prediction, label)
1481206437633:perf <- performance(predictions, measure = "tpr", x.measure = "fpr")
1481206437634:roc_df <- data.frame(
1481206437635:FPR = perf@x.values[[1]],
1481206437640:TPR = perf@y.values[[1]],
1481206437641:cutoff = perf@alpha.values[[1]]
1481206437643:)
1481206437644:}
1481206438512:plotROC <- function(models, ROCcolors = c('darkblue', 'darkgreen', 'darkred', 'orange', 'black')) {
1481206438513:results <- lapply(models, function(m) {
1481206438514:prediction <- predict(m$model, m$test, 'prob')$yes
1481206438514:label <- m$test$purchased
1481206438515:list(
1481206438515:ROCdf = createROCDf(prediction, label),
1481206438516:AUC = calculateAUC(prediction, label)
1481206438517:)
1481206438517:})
1481206438518:ROCplot <- ggplot() +
1481206438519:geom_segment(
1481206438520:aes(x = 0, y = 0, xend = 1, yend = 1),
1481206438522:linetype = "dotted", col = "black"
1481206438523:) +
1481206438524:scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1481206438525:scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1481206438525:xlab("False Positive Rate") + ylab("True Positive Rate")
1481206438528:for (i in seq_along(results)) {
1481206438529:ROCplot <- ROCplot +
1481206438529:geom_line(data = results[[i]]$ROCdf, aes(FPR, TPR), size = 2, col = ROCcolors[i])
1481206438530:}
1481206438532:n_estimation = nrow(models[[1]]$test)
1481206438533:ROCplot +
1481206438534:geom_text(
1481206438535:aes(
1481206438536:x = 0.55, y = seq_len(length(results))/10,
1481206438537:label = paste0(names(results), ': ', sapply(results, function(x) x$AUC), '%')
1481206438538:),
1481206438539:hjust = 0, col = ROCcolors[seq_len(length(results))]
1481206438540:) +
1481206438542:geom_text(
1481206438544:aes(
1481206438545:x = 0, y = 0.9, hjust = 0,
1481206438547:label = paste('Estimated for', format(n_estimation, big.mark = ','), 'persons')
1481206438549:)
1481206438551:)
1481206438553:}
1481206444331:models_14months <- list(
1481206444332:RFM_click = list(
1481206444332:model = rfm_click,
1481206444333:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206444333:),
1481206444334:RFM_click_open = list(
1481206444334:model = rfm_click_open,
1481206444335:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206444335:),
1481206444336:RFM_click_open_web = list(
1481206444336:model = RFM_click_open_web,
1481206444337:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206444337:)
1481206444338:)
1481206454548:plotROC(models_14months)
1481206467485:models_14months <- list(
1481206467486:RFM_click = list(
1481206467486:model = rfm_click,
1481206467487:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206467487:),
1481206467488:RFM_click_open = list(
1481206467488:model = rfm_click_open,
1481206467489:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206467490:),
1481206467491:RFM_click_open_web = list(
1481206467491:model = rfm_click_open_web,
1481206467492:test = data_14months_number$test[sum_click + bought_last_period > 0]
1481206467492:)
1481206467493:)
1481206468736:plotROC(models_14months)
1481206548638:data_14months_number$train[actual_cart_value > 0 & bought_last_period > 0] %>%
1481206549201:ggplot(aes(last_purchase, actual_cart_value)) + geom_point(size = 2, alpha = 0.3) +
1481206549522:scale_x_log10() +
1481206549886:scale_y_log10() +
1481206550201:geom_smooth()
1481206554006:rfm_cartvalue <- train(
1481206554502:actual_cart_value ~ recency + frequency + monetary + sum_click,
1481206554849:data = data_14months_number$train[bought_last_period > 0 & actual_cart_value > 0],
1481206555171:method = 'glm'
1481206555529:)
1481206563165:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1481206563602:.[, .(
1481206563937:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1481206564269:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2))
1481206564631:)]
1481206594799:rfm_cartvalue_web <- train(
1481206595223:actual_cart_value ~ recency + frequency + monetary + sum_click + sum_session,
1481206595474:data = data_14months_number$train[bought_last_period > 0 & actual_cart_value > 0],
1481206595718:method = 'glm'
1481206596284:)
1481206619230:summary(rfm_cartvalue_web)
1481206626989:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1481206626989:.[, .(
1481206626990:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1481206626990:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2),
1481206626991:rfm_click_web_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue_web, .))^2))
1481206626991:)]
1481206655754:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1481206656954:.[, .(
1481206657364:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1481206657707:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2)),
1481206658036:rfm_click_web_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue_web, .))^2))
1481206658510:)]
1481206708307:sessionInfo()
1481206731505:all_data
1481206835439:source('global.R')
1481206843831:web_data # from explore_predict_data script
1481206852100:web_data <- generateWebWeeklyData(all_data) %>% createWeekSequence_()
1481206862522:web_data
1481206863933:web_data
1481206961256:source('global.R')
1481206975546:web_data <- generateWebWeeklyData(all_data) %>% createWeekSequence_()
1481206995741:web_data
1481206997613:web_data
1481207037879:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481207078613:rfm_cartvalue_web <- train(
1481207078613:actual_cart_value ~ recency + frequency + monetary + sum_click + sum_session + avg_price,
1481207078614:data = data_14months_number$train[bought_last_period > 0 & actual_cart_value > 0],
1481207078614:method = 'glm'
1481207078615:)
1481207078635:summary(rfm_cartvalue_web)
1481207119760:source('global.R')
1481207132193:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1481207311916:data_14months_number$train
1481207335428:data_14months_number$train[actual_cart_value>0]
1481207343050:rfm_cartvalue_web <- train(
1481207343383:actual_cart_value ~ recency + frequency + monetary + sum_click + sum_session + avg_added_price,
1481207343692:data = data_14months_number$train[bought_last_period > 0 & actual_cart_value > 0],
1481207344019:method = 'glm'
1481207344306:)
1481207345809:summary(rfm_cartvalue_web)
1481207353529:data_14months_number$test[actual_cart_value > 0 & bought_last_period > 0] %>%
1481207353530:.[, .(
1481207353531:last_purchase = sqrt(mean((actual_cart_value - last_purchase)^2)),
1481207353531:rfm_click_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue, .))^2)),
1481207353533:rfm_click_web_model = sqrt(mean((actual_cart_value - predict(rfm_cartvalue_web, .))^2))
1481207353534:)]
1481207607809:data_14months_number$test[, mean(actual_cart_value)]
1481207612943:data_14months_number$test[actual_cart_value>0, mean(actual_cart_value)]
1481208782956:source('global.R')
1481208784756:customer <- 'luisaviaroma'
1481208815593:program <- 'test'
1481208818729:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481208855789:getCampaignsForProgram(customer, program, refetch = TRUE)
1481208881350:SETTINGS[[customer]]$programs[[program]]
1481208896369:SETTINGS[[customer]]$programs[[program]]$names
1481208910540:SETTINGS[[customer]]$programs[[program]]$names %>% names()
1481208922666:getCampaignsForProgram <- function(customer, program, start_date = '2016-07-01', refetch = TRUE) {
1481208922668:program_properties <- SETTINGS[[customer]]$programs[[program]]
1481208922669:lapply(
1481208922669:names(program_properties$names),
1481208922670:function(s) {
1481208922671:readSqlResult(
1481208922672:sql_file = 'sql/campaigns_for_segment.sql',
1481208922673:database_name = SETTINGS[[customer]]$suite,
1481208922674:result_file_name = str_c(customer, program, s, 'campaigns', sep = '_'),
1481208922674:customer_id = getIdFromName(customer),
1481208922675:start_date = start_date,
1481208922676:segment_name = program_properties$names[[s]],
1481208922676:refetch = refetch
1481208922679:) %>%
1481208922681:`if`(s == 'sto', .[n_launches > 1], .) %>%
1481208922682:.[, `:=`(segment = s, n_launches = NULL)]
1481208922683:}
1481208922684:) %>% rbindlist()
1481208922685:}
1481208939240:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481209053818:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1481209099150:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1481209103251:first_contactlist
1481209109042:contactlist <- first_contactlist
1481209113203:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1481209114599:merge(contactlist, by = c('contact_id', 'segment'))
1481209182680:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1481209185258:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1481209196659:n_past_campaigns
1481209199884:all_data
1481209208745:all_data[, .N, by = period]
1481209219686:program_data[, .N, by = period()]
1481209221673:program_data[, .N, by = period]
1481209274431:contactlist
1481209283489:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1481209284042:merge(contactlist, by = c('contact_id', 'segment'))
1481209302511:all_data
1481209327090:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1481209330818:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1481209381457:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1481209381905:plotEvolution(measure = 'number_of_emails', se = FALSE)
1481210785136:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1481210785137:plotEvolution(measure = 'recipient_share', se = FALSE)
1481210789198:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1481210789198:plotEvolution(measure = 'recipient_share', se = FALSE)
1481210789839:pw_common_contacts <- sapply(
1481210789840:c('sto', 'control', 'both'),
1481210789840:function(s) {
1481210789841:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481210789841:},
1481210789841:simplify = FALSE
1481210789842:)
1481210843666:all_data[, segment]
1481210847208:all_data[, segment] %>% unique()
1481210910717:segments <- unique(all_data[, segment]) %>%
1481210910718:ifelse('control' %in% ., c(., 'both'), .)
1481210916354:pw_common_contacts <- sapply(
1481210916354:segments,
1481210916355:function(s) {
1481210916356:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1481210916357:},
1481210916357:simplify = FALSE
1481210916361:)
1481210959474:for (s in segments) {
1481210959474:plotHeatmapOfCommonContacts(pw_common_contacts[[s]])
1481210959475:}
1481210971097:for (s in segments) {
1481210971098:print(plotHeatmapOfCommonContacts(pw_common_contacts[[s]]))
1481210971099:}
1481210984294:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1481211102726:customer <- 'batiwiz'
1481211103131:program <- 'TD120'
1481211109703:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481211123738:plotSendTimeDistributionEvolution(program_data)
1481211145717:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = FALSE)
1481211151853:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = FALSE)
1481211157981:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1481211198665:plotSendTimeDistributionEvolution(program_data)
1481211228239:program_data[, .N, by = send_day]
1481211250076:program_data[, .N, by = .(segment, send_day)][segment == 'sto']
1481211259028:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto']
1481211271870:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto'][send_day == '2016-12-02']
1481211280192:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto'][send_day > '2016-12-01']
1481211286224:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto'][send_day >= '2016-12-01']
1481273559927:p
1481273570271:program_data[, .N, by = .(segment, send_day, campaign_id)][segment == 'sto'][send_day == '2016-10-27']
1481287685503:program_data
1481287702437:program_data[campaign_id == 617271, .N, by = send_hour]
1481287737558:program_data[campaign_id == 617271, .N, keyby = send_hour]
1481288134144:program_data[, .N, by = .(campaign_id, send_day)]
1481288143569:program_data[, .N, by = .(campaign_id, send_day)][send_day == '2016-09-09']
1481288158265:program_data[campaign_id == 664220, .N, keyby = send_hour]
1481288386873:customer <- 'travelist_market'
1481288388270:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481288395983:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1481288401329:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288411037:debug(getCampaignDataForCustomer)
1481288412352:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288441317:program <- 'test'
1481288442664:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288455708:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1481288455709:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1481288455710:convertSendDayToFactor()
1481288455710:opens_data <- readSqlResult(
1481288455711:sql_file = 'sql/opens_for_campaign_ids.sql',
1481288455711:result_file_name = str_c(customer, program, sep = '_'),
1481288455711:campaign_id_list = createStringListFromVector(campaigns[, campaign_id]),
1481288455712:start_date = campaigns[, min(send_day)],
1481288455712:end_date = campaigns[, max(send_day)],
1481288455712:customer_id = getIdFromName(customer),
1481288455713:refetch = refetch
1481288455713:)
1481288455714:merge(opens_data, campaigns, by = 'campaign_id') %>% unique()  # filter duplicated HDS sends
1481288455715:}
1481288460025:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288462426:program <- 'test'
1481288464589:customer <- 'travelist_market'
1481288466355:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288492422:customer <- 'travelist_market'
1481288492677:program <- 'test1'
1481288494413:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1481288936933:plotSendTimeDistributionEvolution(program_data)
1481288950102:program_data
1481288973727:program_data[campaign_id == 667052, .N, keyby = send_hour]
1482159646880:source('global.R')
1482159651265:customer <- 'edigital'
1482159652503:program <- 'test'
1482159655225:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1482160589587:customer <- 'batiwiz'
1482160590449:program <- 'TD120'
1482160594150:program_data <- getCampaignDataForCustomer(customer, program, refetch = FALSE)
1482160616278:if (customer == 'batiwiz') {
1482160616280:# append new programs
1482160616280:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = F)
1482160616280:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = F)
1482160616281:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1482160616281:}
1482160625912:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482160626828:last_contactlist <- getListOfLastSTOReceivers(program_data, customer, program)
1482160627429:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1482160628846:contactlist <- stable_contactlist
1482160630427:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482160630427:merge(contactlist, by = c('contact_id', 'segment'))
1482160660306:open_frequency <- calculateOpenFrequency(all_data, window_size = 30) %>%
1482160660307:calculateAverageOpenFrequency()
1482160668405:open_frequency %>% plotEvolution(measure = 'open_frequency', se = FALSE)
1482160683216:last_past_date <- open_frequency[period == 'past', max(send_day)]
1482160684096:open_frequency[send_day >= last_past_date] %>%
1482160684096:.[, sequence := seq(1, .N), by = segment] %>%
1482160684097:.[sequence %in% c(1, 31, 61, 75)] %>%
1482160684097:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1482161673727:getCampaignsForProgram('edigital', 'test', '2016-11-28')
1482161744898:getCampaignsForProgram('edigital', 'test', '2016-11-27')
1482162145500:getCampaignsForProgram('edigital', 'test', '2016-11-26')
1482162187223:getCampaignsForProgram('edigital', 'test', '2016-11-20')
1482162247874:getCampaignsForProgram('edigital', 'test', '2016-11-28')
1482162253428:getCampaignsForProgram('edigital', 'test', '2016-11-27')
1482162289573:customer <- 'edigital'
1482162289947:program <- 'test'
1482162291636:program_data <- getCampaignDataForCustomer(customer, program, refetch = TRUE)
1482162558899:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1482162578059:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482162584213:contactlist <- first_contactlist
1482162586534:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482162586535:merge(contactlist, by = c('contact_id', 'segment'))
1482162918081:all_data
1482162938434:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1482162939190:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1482162951848:n_past_campaigns
1482162961536:all_data[period == 'past']
1482163057566:customer
1482163060797:program
1482163063597:contactlist
1482163073304:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482163073305:merge(contactlist, by = c('contact_id', 'segment'))
1482163145247:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1482163147041:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1482163176444:quantile(n_past_campaigns)
1482163196692:n_past_campaigns[, quantile(N)]
1482163211270:n_past_campaigns[, quantile(N, seq(0, 1, 0.1))]
1482163256677:group_by <- NULL
1482163258433:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482163258434:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482163300491:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482163300491:plotEvolution(measure = 'recipient_share', se = FALSE)
1482163324476:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482163324476:plotEvolution(measure = 'recipient_share', se = FALSE)
1482163339145:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482163354469:campaign_summary <- calculateSummary(all_data)
1482163358836:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482163380980:campaign_summary
1482163389099:campaign_summary[order(send_day)]
1482163438063:campaign_summary[period == 'sto', order(send_day)]
1482163449814:campaign_summary[period == 'sto'] %>% .[order(send_day)]
1482163484938:n_past_campaigns[, quantile(N, seq(0, 1, 0.1))]
1482163493387:all_data <- merge(all_data, n_past_campaigns[N >= 25, .(contact_id, segment)], by = c('contact_id', 'segment'))
1482163502387:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482163502388:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482163508602:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482163508603:plotEvolution(measure = 'recipient_share', se = FALSE)
1482163520702:campaign_summary <- calculateSummary(all_data)
1482163523598:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482163566900:campaign_summary
1482163596102:campaign_summary[open_rate > 0.5]
1482163618921:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 1000')
1482163623928:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482163673484:generateRelativeData(campaign_summary) %>%
1482163673485:plotRelativeEvolution(trendlines = F, color = group_by, text_position = 0.9)
1482163719076:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1482222931444:source('global.R')
1482222932680:customer <- 'edigital'
1482222932681:program <- 'test'
1482222941756:packrat::restore(prompt = FALSE)
1482222981211:install.packages('emsconnectr', type = 'source')
1482223005786:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482223018473:source('global.R')
1482223020465:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482223044521:source('global.R')
1482223048372:customer <- 'edigital'
1482223049193:program <- 'test'
1482223052647:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482223056186:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1482223075850:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482223075850:merge(contactlist, by = c('contact_id', 'segment'))
1482223091563:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482223094340:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1482223100934:contactlist <- unique_contactlist
1482223102727:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482223102727:merge(contactlist, by = c('contact_id', 'segment'))
1482223167914:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223167915:merge(contactlist, by = c('contact_id', 'segment'))
1482223173562:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223173563:merge(contactlist, by = c('contact_id', 'segment'))
1482223203422:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223203422:merge(contactlist, by = c('contact_id', 'segment'))
1482223272139:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223272140:merge(contactlist, by = c('contact_id', 'segment'))
1482223307900:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223307901:merge(contactlist, by = c('contact_id', 'segment'))
1482223386233:source('global.R')
1482223394431:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482223394432:merge(contactlist, by = c('contact_id', 'segment'))
1482224026758:source('global.R')
1482224046022:getContactlistsForSegments(customer, program)
1482224055838:getContactlistsForSegments('edigital', 'test')
1482224066853:cucc <- getContactlistsForSegments('edigital', 'test')
1482224068047:cucc
1482224100070:program_properties <- SETTINGS[['edigital']]$programs[['test']]
1482224101704:program_properties
1482224148682:clist_ids <- map(program_properties$names, ~ getContactlistId('edigital', contactlist_name = .))
1482224151817:clist_ids
1482224174929:map(clist_ids, ~ .+1)
1482224190221:map(clist_ids, ~ str_c(., names(.)))
1482224196500:map(clist_ids, ~ str_c(.)
1482224198362:)
1482224200505:map(clist_ids, ~ str_c(.))
1482224213170:map(names(clist_ids), ~ str_c(.))
1482224245066:map(names(clist_ids), ~ str_c(., clist_ids[[.]]))
1482224275287:source('global.R')
1482224283311:source('global.R')
1482224292434:getContactlistsForSegments('edigital', 'test', T)
1482224306320:.Last.value
1482224591020:source('global.R')
1482224611149:cucc <- getContactlistsForSegments('edigital', 'test', F)
1482224612524:cucc
1482224662999:cucc2 <- getHistoricalOpensForContactlists('edigital', cucc, 'cucc', '2016-12-20', T)
1482224734218:cucc2
1482224740856:cucc2[, .N, by = segment]
1482225370490:customer <- 'edigital'
1482225371271:program <- 'test'
1482225372871:source('global.R')
1482225376840:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482225377848:getHistoricalOpensForContactlists(
1482225378422:customer,
1482225379106:contactlists_dt = .,
1482225379481:contactlists_name = program,
1482225379894:end_date = SETTINGS[[customer]][["programs"]][[program]][['start_date']],
1482225380270:refetch = FALSE
1482225380666:)
1482225483009:source('global.R')
1482225495094:customer <- 'edigital'
1482225495669:program <- 'test'
1482225552093:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482225552094:getHistoricalOpensForContactlists(
1482225552095:customer,
1482225552095:contactlists_dt = .,
1482225552095:contactlists_name = program,
1482225552096:end_date = SETTINGS$customer[["programs"]]$program[['start_date']],
1482225552096:refetch = FALSE
1482225552096:)
1482225574209:getContactlistsForSegments(customer, program, refetch = FALSE)
1482225584671:SETTINGS$customer[["programs"]]$program[['start_date']]
1482225623037:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482225623037:getHistoricalOpensForContactlists(
1482225623038:customer,
1482225623038:contactlists_dt = .,
1482225623039:contactlists_name = program,
1482225623039:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482225623040:refetch = FALSE
1482225623041:)
1482225796590:source('global.R')
1482225799937:customer <- 'edigital'
1482225800372:program <- 'test'
1482225809204:debug(getHistoricalOpensForContactlists)
1482225838416:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482225838417:getHistoricalOpensForContactlists(
1482225838418:customer,
1482225838419:contactlists_dt = .,
1482225838420:contactlists_name = program,
1482225838420:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482225838421:refetch = FALSE
1482225838421:)
1482225855867:str_c(customer, contactlists_name, 'history', end_date, sep = '_')
1482225890598:getIdFromName(customer)
1482225976230:createStringValuesForSQLWith(contactlists_dt)
1482225987353:as.Date(end_date) - period(2, 'month')
1482226052466:getHistoricalOpensForContactlists <- function(customer, contactlists_dt, contactlists_name = 'sto-starters', end_date, refetch = FALSE) {
1482226052467:readSqlResult(
1482226052468:sql_file = 'sql/opens_for_segment_contactlists.sql',
1482226052468:result_file_name = str_c(customer, contactlists_name, 'history', end_date, sep = '_'),
1482226052469:customer_id = getIdFromName(customer),
1482226052469:values_string = createStringValuesForSQLWith(contactlists_dt),
1482226052470:start_date = as.Date(end_date) - period(2, 'day'),
1482226052471:end_date = end_date,
1482226052471:refetch = refetch
1482226052471:)
1482226052472:}
1482226083657:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226083658:.[1:10]
1482226086961:data_by_segment
1482226108036:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226108037:.[c(1:5, 100000:100005)]
1482226113626:data_by_segment
1482226147250:getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226147250:.[c(1:5, 200000:200005)]
1482226159251:getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226159252:.[c(1:5, 300000:300005)]
1482226171722:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226171722:.[c(1:5, 300000:300005)] %>%
1482226171724:getHistoricalOpensForContactlists(
1482226171724:customer,
1482226171724:contactlists_dt = .,
1482226171724:contactlists_name = program,
1482226171725:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482226171725:refetch = FALSE
1482226171725:)
1482226222534:data_by_segment
1482226256232:source('global.R')
1482226259613:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226259614:.[c(1:5, 300000:300005)] %>%
1482226259615:getHistoricalOpensForContactlists(
1482226259615:customer,
1482226259615:contactlists_dt = .,
1482226259616:contactlists_name = program,
1482226259616:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482226259617:refetch = FALSE
1482226259617:)
1482226279008:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482226279011:.[c(1:5, 300000:300005)] %>%
1482226279011:getHistoricalOpensForContactlists(
1482226279012:customer,
1482226279013:contactlists_dt = .,
1482226279014:contactlists_name = program,
1482226279015:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482226279015:refetch = T
1482226279016:)
1482226383049:data_by_segment
1482228233220:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482228233221:getHistoricalOpensForContactlists(
1482228233221:customer,
1482228233222:contactlists_dt = .,
1482228233222:contactlists_name = program,
1482228233222:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482228233223:refetch = T
1482228233223:)
1482228719308:data_by_segment[, .N, by = segment]
1482228725830:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1482228726384:.[, mean(open_rate), by = segment]
1482228731065:calculateSummary <- function(data, segment_var = 'segment') {
1482228731065:calculateCampaignOpenRate(
1482228731066:dt = data[bounced == FALSE],
1482228731067:by = c(segment_var, 'send_day')
1482228731067:) %>%
1482228731068:dcast(as.formula(paste0('send_day ~', segment_var)), value.var = 'open_rate') %>%
1482228731068:.[, `:=`(relative_measure = sto/control, segment = segment_var)]
1482228731069:}
1482228732168:addRandomSegments <- function(dt, n = 5, p = c(0.5, 0.5)) {
1482228732169:random_names <- sapply(1:n, function(i) paste0('rand', i))
1482228732170:unique(dt[, .(contact_id)]) %>%
1482228732170:.[, (random_names) := replicate(
1482228732171:n,
1482228732171:sample(c('control', 'sto'), size = .N, replace = TRUE, prob = p),
1482228732171:simplify = FALSE
1482228732172:)] %>%
1482228732172:merge(dt, ., by = 'contact_id')
1482228732173:}
1482228734446:summary <- calculateSummary(data_by_segment)
1482228739799:summary %>%
1482228740398:.[,period := 'past'] %>%
1482228741646:plotRelativeEvolution(., text = FALSE, prior_change_dates = FALSE, trendlines = FALSE, sto_text = F, sto_line = F)
1482228752371:data_by_segment_random <- addRandomSegments(data_by_segment)
1482228759648:history_summaries <- lapply(
1482228760167:c('segment', grep('rand', names(data_by_segment_random), value = T)),
1482228760548:calculateSummary,
1482228760934:data = data_by_segment_random
1482228761519:)
1482228781266:history_summaries %>%
1482228781683:rbindlist() %>%
1482228782049:plot_ly(x = ~send_day) %>%
1482228782302:add_lines(y = 1, line = list(dash = 'dot', color = 'gray'), showlegend = FALSE, hoverinfo = 'none') %>%
1482228782556:add_lines(y = ~relative_measure, color = ~segment) %>%
1482228783025:layout(yaxis = list(range = c(0.9, 1.1)))
1482228795504:data_by_segment
1482228808322:data_by_segment[, .N, by = .(send_day, segment)]
1482228818491:data_by_segment[, .N, by = .(send_day, segment)] %>% plotEvolution(measure = N)
1482228824578:data_by_segment[, .N, by = .(send_day, segment)] %>% plotEvolution(measure = 'N')
1482228874351:data_by_segment[, .N, by = .(send_day, segment)] %>% ggplot(send_day, N, col = segment) + geom_line()
1482228885238:data_by_segment[, .N, by = .(send_day, segment)] %>% ggplot(aes(send_day, N, col = segment)) + geom_line()
1482229779827:data_by_segment[, .N, by = .(send_day, segment)] %>% ggplot(aes(N)) + geom_histogram()
1482229793292:data_by_segment[, .N, by = .(send_day, segment)] %>% ggplot(aes(N)) + geom_histogram() + scale_x_log10()
1482229810465:data_by_segment
1482229828324:data_by_segment[, .N, by = campaign_id]
1482229930099:excludeIrrelevantCampaigns <- function(dt, cutoff = 1000) {
1482229930100:relevant_campaigns <- dt[, .N, by = campaign_id][N >= cutoff, campaign_id]
1482229930101:merge(dt, relevant_campaigns, by = 'campaign_id')
1482229930101:}
1482229967786:cucc <- data_by_segment %>% excludeIrrelevantCampaigns() %>% calculateSummary()
1482229977219:data_by_segment
1482229995475:excludeIrrelevantCampaigns <- function(dt, cutoff = 1000) {
1482229995476:relevant_campaigns <- dt[, .N, by = campaign_id][N >= cutoff, .(campaign_id)]
1482229995476:merge(dt, relevant_campaigns, by = 'campaign_id')
1482229995477:}
1482229998176:cucc <- data_by_segment %>% excludeIrrelevantCampaigns() %>% calculateSummary()
1482230003827:cucc
1482230111143:cucc
1482230121177:calculateSummary <- function(campaign_data, initial = Inf, contact_condition = 'TRUE', campaign_condition = 'TRUE', base_by = c('period', 'segment', 'send_day'), additional_by = NULL) {
1482230121177:by <- c(base_by, additional_by)
1482230121178:campaign_data %>%
1482230121179:.[bounced == FALSE & eval(parse(text = contact_condition))] %>%
1482230121179:calculateCampaignOpenRate(by = by, initial = initial) %>%
1482230121180:.[eval(parse(text = campaign_condition))] %>%
1482230121180:addWeekdayToDt_() %>%
1482230121181:addWeekendToSummary_()
1482230121182:}
1482230141810:calculateSummary(data_by_segment)
1482230157712:program_data
1482230166652:cucc
1482230179060:customer <- 'edigital'
1482230179348:program <- 'test'
1482230180364:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482230190092:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 1000')
1482230201467:calculateSummary(program_data)
1482230228606:calculateSummary(program_data, base_by = c('segment', 'send_day'))
1482230232446:.Last.value
1482230276486:.Last.value
1482230284512:.Last.value %>% generateRelativeData()
1482230329930:calculateSummary(data_by_segment, base_by = c('segment', 'send_day')) %>%
1482230329930:generateRelativeData(base_by = c('segment', 'send_day'))
1482230345585:calculateSummary(data_by_segment, base_by = c('segment', 'send_day'))
1482230352322:.Last.value
1482230355562:cucc <- .Last.value
1482230356350:cucc
1482230415066:dcast(cucc, send_day ~ segment, value.var = 'open_rate')
1482230431553:calculateSummary(data_by_segment, base_by = c('segment', 'send_day')) %>%
1482230432140:generateRelativeData(base_by = 'send_day')
1482230445842:calculateSummary(data_by_segment, base_by = c('segment', 'send_day')) %>%
1482230445843:generateRelativeData(base_by = 'send_day') %>%
1482230445844:plotRelativeEvolution(., text = FALSE, prior_change_dates = FALSE, trendlines = FALSE, sto_text = F, sto_line = F)
1482230488877:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482230488878:getHistoricalOpensForContactlists(
1482230488878:customer,
1482230488879:contactlists_dt = .,
1482230488879:contactlists_name = program,
1482230488879:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482230488880:refetch = FALSE
1482230488880:) %>%
1482230488881:excludeIrrelevantCampaigns()
1482230545934:calculateSummary(data_by_segment, base_by = c('segment', 'send_day')) %>%
1482230546456:generateRelativeData(base_by = 'send_day') %>%
1482230546954:plotRelativeEvolution(., text = FALSE, prior_change_dates = FALSE, trendlines = FALSE, sto_text = F, sto_line = F)
1482230566892:data_by_segment %>% sapply(class)
1482230579590:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482230579591:getHistoricalOpensForContactlists(
1482230579592:customer,
1482230579592:contactlists_dt = .,
1482230579593:contactlists_name = program,
1482230579593:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482230579594:refetch = FALSE
1482230579594:)
1482230587236:data_by_segment %>% sapply(class)
1482230598615:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482230598616:getHistoricalOpensForContactlists(
1482230598617:customer,
1482230598617:contactlists_dt = .,
1482230598618:contactlists_name = program,
1482230598618:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482230598618:refetch = FALSE
1482230598619:) %>%
1482230598619:convertSendDayToDate() %>%
1482230598620:excludeSmallCampaigns()
1482230609719:source('global.R')
1482230614888:data_by_segment <- getContactlistsForSegments(customer, program, refetch = FALSE) %>%
1482230614889:getHistoricalOpensForContactlists(
1482230614890:customer,
1482230614891:contactlists_dt = .,
1482230614891:contactlists_name = program,
1482230614892:end_date = SETTINGS[[customer]]$programs[[program]]$start_date,
1482230614893:refetch = FALSE
1482230614893:) %>%
1482230614894:convertSendDayToDate() %>%
1482230614894:excludeSmallCampaigns()
1482230624961:data_by_segment[, .N, by = segment]
1482230626594:data_by_segment[bounced == FALSE, .(open_rate = mean(opened)), by = .(segment, contact_id)] %>%
1482230626983:.[, mean(open_rate), by = segment]
1482230635742:calculateSummary(data_by_segment, base_by = c('segment', 'send_day')) %>%
1482230635968:generateRelativeData(base_by = 'send_day') %>%
1482230636281:plotRelativeEvolution(., text = FALSE, prior_change_dates = FALSE, trendlines = FALSE, sto_text = F, sto_line = F)
1482230754567:source('global.R')
1482230755678:customer <- 'edigital'
1482230755678:program <- 'test'
1482230760795:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482230763683:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1482230779359:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1482230781292:contactlist <- unique_contactlist
1482230881789:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1482230881790:merge(contactlist, by = c('contact_id', 'segment'))
1482231515307:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482231515310:merge(contactlist, by = c('contact_id', 'segment'))
1482231573539:group_by <- NULL
1482231574874:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482231575409:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482231584425:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482231584858:plotEvolution(measure = 'recipient_share', se = FALSE)
1482231598018:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482231598770:plotEvolution(measure = 'recipient_share', se = FALSE)
1482231613829:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 1000')
1482231622306:campaign_summary <- calculateSummary(all_data)
1482231625927:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482231636086:generateRelativeData(campaign_summary) %>%
1482231636684:plotRelativeEvolution(trendlines = F, color = group_by, text_position = 0.9)
1482231765829:a <- readSqlResult(sql_file = 'sql/tmp.sql', result_file_name = 'tmp')
1482232231869:a
1482232276043:readSqlResult(sql_file = 'sql/tmp.sql', result_file_name = 'tmp', refetch = TRUE) %>% print()
1482232667533:getHistoricalOpensForContactlists <- function(customer, contactlists_dt, contactlists_name = 'sto-starters', end_date, refetch = FALSE) {
1482232667534:readSqlResult(
1482232667534:sql_file = 'sql/opens_for_segment_contactlists.sql',
1482232667535:result_file_name = str_c(customer, contactlists_name, 'history', end_date, sep = '_'),
1482232667535:customer_id = getIdFromName(customer),
1482232667536:values_string = createStringValuesForSQLWith(contactlists_dt),
1482232667536:start_date = as.Date(end_date) - period(2, 'day'),
1482232667537:end_date = end_date,
1482232667537:refetch = refetch
1482232667538:)
1482232667538:}
1482232755911:a <- getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE)
1482232762695:a
1482232816978:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% .[period := 'past']
1482232830514:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% print()
1482232913828:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% class()
1482232926016:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% .[, period := 'past']
1482232982425:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% .[, period := 'past'] %>% convertSendDayToDate() %>% excludeSmallCampaigns()
1482233001209:getHistoricalOpensForContactlists('edigital', unique_contactlist[c(1:5, 200000:200005)], end_date = '2016-12-20', refetch = TRUE) %>% .[, period := 'past'] %>% convertSendDayToDate() %>% print()
1482233370965:customer <- 'luisaviaroma'
1482233372513:program <- 'test'
1482233377010:program_data <- getCampaignDataForCustomer(customer, program, refetch = T)
1482233462151:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1482233478234:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1482233480876:contactlist <- unique_contactlist
1482233485069:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482233485583:merge(contactlist, by = c('contact_id', 'segment'))
1482233490785:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1482233492522:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1482233590775:group_by <- NULL
1482233594604:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482233595169:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482233605837:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482233606805:plotEvolution(measure = 'recipient_share', se = FALSE)
1482233611653:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482233612157:plotEvolution(measure = 'recipient_share', se = FALSE)
1482233632491:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482233659060:plotSendTimeDistributionEvolution(program_data)
1482233668196:program_data
1482233680915:program_data[campaign_id == 2096155]
1482233685396:program_data[campaign_id == 2096155, .N, by = send_hour]
1482233912529:program_data[campaign_id == 2096155, .N, by = send_hour][, .N]
1482233917942:program_data[campaign_id == 2096155, .N, by = send_hour][, sum(N)]
1482235701417:program_data <- getCampaignDataForCustomer(customer, program, refetch = T)
1482235801765:program_data[campaign_id == 2096155, .N]
1482235863624:campaigns <- getCampaignsForProgram(customer, program) %>% convertSendDayToDate()
1482235867383:campaigns
1482235868855:campaigns
1482236027752:campaigns[, max(send_day)]
1482236029549:campaigns[, max(send_day)+1]
1482236044901:getCampaignDataForCustomer <- function(customer, program, refetch = TRUE) {
1482236044903:campaigns <- getCampaignsForProgram(customer, program, refetch = refetch) %>%
1482236044904:convertSendDayToDate()
1482236044906:opens_data <- readSqlResult(
1482236044907:sql_file = 'sql/opens_for_campaign_ids.sql',
1482236044908:result_file_name = str_c(customer, program, sep = '_'),
1482236044909:campaign_id_list = createStringListFromVector(campaigns[, campaign_id]),
1482236044910:start_date = campaigns[, min(send_day)],
1482236044911:end_date = campaigns[, max(send_day) + 1],
1482236044913:customer_id = getIdFromName(customer),
1482236044914:refetch = refetch
1482236044914:)
1482236044916:merge(opens_data, campaigns, by = 'campaign_id') %>%
1482236044917:unique()  # filter duplicated HDS sends
1482236044919:}
1482236048271:program_data <- getCampaignDataForCustomer(customer, program, refetch = T)
1482236141453:plotSendTimeDistributionEvolution(program_data)
1482236314847:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482236314848:merge(contactlist, by = c('contact_id', 'segment'))
1482236322837:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482236322838:plotEvolution(measure = 'recipient_share', se = FALSE)
1482236331260:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482236334772:campaign_summary <- calculateSummary(all_data)
1482236339879:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482236362259:campaign_summary
1482236447875:getOption('datatable.print.topn')
1482236452511:getOption('datatable.print.nrows')
1482236456815:getOption('datatable.print.class')
1482236476689:print(campaign_summary, nrows = 10)
1482236486265:print(campaign_summary, nrows = 10, class = TRUE)
1482236499067:print(campaign_summary, nrows = 20, class = TRUE)
1482236507284:print(campaign_summary, class = TRUE)
1482236512762:print(campaign_summary, nrows = 20, class = TRUE)
1482236541587:print(campaign_summary, nrows = 100, class = TRUE)
1482236549995:getOption('max.print')
1482236574616:options(max.print = 1000)
1482236577041:print(campaign_summary, nrows = 100, class = TRUE)
1482236589685:print(campaign_summary, nrows = 20, class = TRUE)
1482236593613:print(campaign_summary, class = TRUE)
1482236602381:print(campaign_summary, nrows = 20, class = TRUE)
1482236607278:print(campaign_summary, nrows = 20, class = TRUE, topn = 10)
1482236715869:source('global.R')
1482236717031:customer <- 'luisaviaroma'
1482236717031:program <- 'test'
1482236720806:program_data <- getCampaignDataForCustomer(customer, program, refetch = F)
1482236722835:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1482236731566:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1482236733374:contactlist <- unique_contactlist
1482236734873:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482236734874:merge(contactlist, by = c('contact_id', 'segment'))
1482236744198:group_by <- NULL
1482236744980:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482236744981:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482236747912:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482236747912:plotEvolution(measure = 'recipient_share', se = FALSE)
1482236749320:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482236749322:plotEvolution(measure = 'recipient_share', se = FALSE)
1482236754978:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482236755861:plotSendTimeDistributionEvolution(program_data)
1482236756712:campaign_summary <- calculateSummary(all_data)
1482236761436:campaign_summary
1482236762916:campaign_summary
1482236805877:options(datatable.print.nrows = 20)
1482236806846:campaign_summary
1482237026514:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482237044535:campaign_summary[open_rate > 0.2]
1482237107267:campaign_summary[n > 5000]
1482237111835:campaign_summary[n < 5000]
1482237114749:campaign_summary <- calculateSummary(all_data, campaign_condition = 'n > 5000')
1482237116772:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482238959951:plotEvolution(campaign_summary, smooth = TRUE) +  scale_y_continuous(labels = scales::percent_format())
1482238989758:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1482239113740:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482239130379:all_data <- addActivity(all_data)
1482239132104:plotActivityDistribution(all_data)
1482239177021:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482239184563:aggregateVariability(sending_variability) %>%
1482239184564:plotSendingVariability()
1482239219589:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482239223526:contactlist <- first_contactlist
1482239229882:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482239229883:merge(contactlist, by = c('contact_id', 'segment'))
1482239258635:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482239265598:all_data <- addActivity(all_data)
1482239280681:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482239286402:aggregateVariability(sending_variability) %>%
1482239286402:plotSendingVariability()
1482239290666:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1482239290667:plotSendingVariability() +
1482239290668:labs(x = 'Send day', y = 'Number of different slots sent in last 5 mails') +
1482239290668:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482239290669:theme(legend.position = 'bottom')
1482239748237:sending_variability
1482239769958:sending_variability[contact_id == 15275]
1482239779784:all_data[contact_id == 15275]
1482239789527:all_data[contact_id == 15275, .(send_day, send_hour)]
1482239802513:all_data[contact_id == 15275, .(send_day, send_hour)] %>% print(nrows = 100)
1482239809241:sending_variability[contact_id == 15275]
1482239828412:all_data[contact_id == 15275 & send_day > '2016-08-11', .(send_day, send_hour)]
1482239862536:q
1482239990842:all_data[contact_id == 15275, .(send_day, send_hour)][send_day > '2016-08-11']
1482239994569:sending_variability[contact_id == 15275]
1482240098793:cucc <- aggregateVariability(sending_variability)
1482240100005:cucc
1482240165157:cucc %>% ggplot(aes(send_day, variability)) + geom_line()
1482240244780:campaign_summary
1482240421755:calculateVariabilityOfLastSends <- function(contact_data, scope = 5) {
1482240421756:contact_data[
1482240421757:order(contact_id, send_day),
1482240421757:.(
1482240421758:send_day,
1482240421758:activity,
1482240421758:variability = partialUniqueN(send_hour, scope),
1482240421759:num_send = .N,
1482240421759:num_open = sum(opened)
1482240421759:),
1482240421760:by = contact_id
1482240421760:]
1482240421761:}
1482240445110:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482240451844:aggregateVariability(sending_variability) %>%
1482240452397:plotSendingVariability()
1482240560091:cucc <- aggregateVariability(sending_variability)
1482240561169:cucc
1482240587163:plotEvolution(cucc, measure = 'variability', sto_line = FALSE)
1482240702996:plotSendingVariability <- function(dt) {
1482240702999:p <- ggplot(dt, aes(x = send_day, y = variability)) +
1482240703000:scale_y_continuous(limit = c(0, 5))
1482240703001:if ('activity' %in% names(dt)) {
1482240703002:p <- p + geom_point(aes(fill = activity), color = 'white', size = 3, pch = 21) + geom_line(aes(color = activity))
1482240703003:} else {
1482240703004:p <- p + geom_point(fill = 'black', color = 'white', size = 3, pch = 21) + geom_line()
1482240703005:}
1482240703007:p + addSTOline(sto_line = FALSE, sto_text = FALSE)
1482240703008:}
1482240707178:aggregateVariability(sending_variability) %>%
1482240707179:plotSendingVariability()
1482240724089:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1482240724090:plotSendingVariability() +
1482240724090:labs(x = 'Send day', y = 'Number of different slots sent in last 5 mails') +
1482240724091:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482240724091:theme(legend.position = 'bottom')
1482240830266:plotSendingVariability <- function(dt) {
1482240830267:p <- ggplot(dt, aes(x = send_day, y = variability)) +
1482240830267:scale_y_continuous(limit = c(0, 5))
1482240830268:if ('activity' %in% names(dt)) {
1482240830269:p <- p + geom_point(aes(fill = activity), color = 'white', size = 3, pch = 21) + geom_line(aes(color = activity))
1482240830269:} else {
1482240830271:p <- p + geom_point(fill = 'black', color = 'white', size = 3, pch = 21) + geom_line()
1482240830272:}
1482240830274:p + addSTOline(sto_line = FALSE, sto_text = FALSE) +
1482240830275:labs(x = 'send day', y = 'number of different slots sent in last 5 mails') +
1482240830277:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482240830278:theme(legend.position = 'bottom')
1482240830279:}
1482240833313:aggregateVariability(sending_variability) %>%
1482240833313:plotSendingVariability()
1482240839662:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1482240839663:plotSendingVariability()
1482240889643:cucc
1482240900848:cucc[, i := seq(.N)]
1482240902821:cucc
1482240967350:aggregateVariability <- function(variability_dt, by_active_status = FALSE) {
1482240967351:if (by_active_status) {
1482240967352:by <- c('send_day', 'activity')
1482240967352:} else {
1482240967353:by <- c('send_day')
1482240967353:}
1482240967354:variability_dt[num_send == max(num_send), .(variability = mean(variability)), keyby = by] %>%
1482240967354:.[, rank := seq(.N), by = by]
1482240967355:}
1482240978332:cucc <- aggregateVariability(sending_variability)
1482240979612:cucc
1482240980867:cucc
1482241026526:aggregateVariability <- function(variability_dt, by_active_status = FALSE) {
1482241026526:if (by_active_status) {
1482241026527:by <- c('send_day', 'activity')
1482241026528:} else {
1482241026528:by <- c('send_day')
1482241026529:}
1482241026530:variability_dt[num_send == max(num_send), .(variability = mean(variability)), keyby = by] %>%
1482241026531:.[, rank := .GRP, by = by] %>%
1482241026531:.[]
1482241026532:}
1482241032164:aggregateVariability(sending_variability)
1482241037733:aggregateVariability(sending_variability, by_active_status = T)
1482241072507:aggregateVariability <- function(variability_dt, by_active_status = FALSE) {
1482241072507:if (by_active_status) {
1482241072508:by <- c('send_day', 'activity')
1482241072509:} else {
1482241072509:by <- c('send_day')
1482241072510:}
1482241072510:variability_dt[num_send == max(num_send), .(variability = mean(variability)), keyby = by] %>%
1482241072511:.[, rank := .GRP, by] %>%
1482241072511:.[]
1482241072512:}
1482241074551:aggregateVariability(sending_variability, by_active_status = T)
1482241104193:aggregateVariability(sending_variability, by_active_status = T) %>% .[, rank := seq(.N), by = 'send_day']
1482241109490:aggregateVariability(sending_variability, by_active_status = T) %>% .[, rank := seq(.N), by = 'send_day'] %>% .[]
1482241119466:aggregateVariability(sending_variability, by_active_status = T) %>% .[, rank := .GRP, by = 'send_day'] %>% .[]
1482241132057:aggregateVariability <- function(variability_dt, by_active_status = FALSE) {
1482241132057:if (by_active_status) {
1482241132058:by <- c('send_day', 'activity')
1482241132059:} else {
1482241132059:by <- c('send_day')
1482241132060:}
1482241132060:variability_dt[num_send == max(num_send), .(variability = mean(variability)), keyby = by] %>%
1482241132061:.[, rank := .GRP, by = 'send_day'] %>%
1482241132061:.[]
1482241132062:}
1482241137418:aggregateVariability(sending_variability)
1482241141035:aggregateVariability(sending_variability, by_active_status = TRUE)
1482241213027:plotSendingVariability <- function(dt, by_sequence = FALSE) {
1482241213028:if (by_sequence) {
1482241213029:xvar <- 'rank'
1482241213029:xlab <- '#STO-email'
1482241213030:} else {
1482241213030:xvar <- 'send_day'
1482241213030:xlab <- 'send day'
1482241213031:}
1482241213032:p <- ggplot(dt, aes_string(x = xvar, y = 'variability')) +
1482241213032:scale_y_continuous(limit = c(0, 5))
1482241213032:if ('activity' %in% names(dt)) {
1482241213033:p <- p + geom_point(aes(fill = activity), color = 'white', size = 3, pch = 21) + geom_line(aes(color = activity))
1482241213033:} else {
1482241213034:p <- p + geom_point(fill = 'black', color = 'white', size = 3, pch = 21) + geom_line()
1482241213034:}
1482241213035:p + addSTOline(sto_line = FALSE, sto_text = FALSE) +
1482241213037:labs(x = xlab, y = 'number of different slots sent in last 5 mails') +
1482241213039:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482241213041:theme(legend.position = 'bottom')
1482241213043:}
1482241217711:aggregateVariability(sending_variability) %>%
1482241217712:plotSendingVariability()
1482241270105:aggregateVariability(sending_variability) %>% plotSendingVariability(by_sequence = TRUE)
1482241325319:plotSendingVariability <- function(dt, by_sequence = FALSE) {
1482241325320:if (by_sequence) {
1482241325320:xvar <- 'rank'
1482241325321:xlab <- '#STO-email'
1482241325321:show_prior_changes <- FALSE
1482241325322:} else {
1482241325322:xvar <- 'send_day'
1482241325323:xlab <- 'send day'
1482241325323:show_prior_changes <- TRUE
1482241325324:}
1482241325324:p <- ggplot(dt, aes_string(x = xvar, y = 'variability')) +
1482241325325:scale_y_continuous(limit = c(0, 5))
1482241325326:if ('activity' %in% names(dt)) {
1482241325327:p <- p + geom_point(aes(fill = activity), color = 'white', size = 3, pch = 21) + geom_line(aes(color = activity))
1482241325329:} else {
1482241325330:p <- p + geom_point(fill = 'black', color = 'white', size = 3, pch = 21) + geom_line()
1482241325332:}
1482241325333:p + addSTOline(sto_line = FALSE, sto_text = FALSE, prior_change_dates = show_prior_changes) +
1482241325334:labs(x = xlab, y = 'number of different slots sent in last 5 mails') +
1482241325335:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482241325336:theme(legend.position = 'bottom')
1482241325337:}
1482241327803:aggregateVariability(sending_variability) %>% plotSendingVariability(by_sequence = TRUE)
1482241344905:plotSendingVariability <- function(dt, by_sequence = FALSE) {
1482241344905:if (by_sequence) {
1482241344906:xvar <- 'rank'
1482241344906:xlab <- '#STO-email'
1482241344909:show_prior_changes <- FALSE
1482241344910:} else {
1482241344911:xvar <- 'send_day'
1482241344912:xlab <- 'send day'
1482241344913:show_prior_changes <- TRUE
1482241344914:}
1482241344916:p <- ggplot(dt, aes_string(x = xvar, y = 'variability')) +
1482241344917:scale_y_continuous(limit = c(0, 5))
1482241344918:if ('activity' %in% names(dt)) {
1482241344918:p <- p + geom_point(aes(fill = activity), color = 'white', size = 3, pch = 21) + geom_line(aes(color = activity))
1482241344919:} else {
1482241344920:p <- p + geom_point(fill = 'black', color = 'white', size = 3, pch = 21) + geom_line()
1482241344921:}
1482241344922:p + addSTOline(sto_line = FALSE, sto_text = FALSE, prior_changes = show_prior_changes) +
1482241344922:labs(x = xlab, y = 'number of different slots sent in last 5 mails') +
1482241344924:scale_color_discrete(guide = guide_legend(nrow = 1)) +
1482241344925:theme(legend.position = 'bottom')
1482241344925:}
1482241348005:aggregateVariability(sending_variability) %>% plotSendingVariability()
1482241350795:aggregateVariability(sending_variability) %>% plotSendingVariability(by_sequence = TRUE)
1482241376996:aggregateVariability(sending_variability) %>% plotSendingVariability()
1482241392870:aggregateVariability(sending_variability) %>% plotSendingVariability(by_sequence = TRUE)
1482241412611:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1482241412613:plotSendingVariability()
1482241471914:customer <- 'batiwiz'
1482241471915:program <- 'TD120'
1482241478449:program_data <- getCampaignDataForCustomer(customer, program, refetch = T)
1482310496187:if (customer == 'batiwiz') {
1482310496189:# append new programs
1482310496190:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = F)
1482310496190:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = F)
1482310496191:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1482310496191:}
1482310520415:refetch <- TRUE
1482310521478:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1482310722999:if (customer == 'batiwiz') {
1482310723001:# append new programs
1482310723002:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = refetch)
1482310723002:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = refetch)
1482310723002:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1482310723003:}
1482311101899:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482311104601:contactlist <- first_contactlist
1482311107876:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482311107876:merge(contactlist, by = c('contact_id', 'segment'))
1482311222198:customer <- 'batiwiz'
1482311222716:program <- 'TD120'
1482311223790:group_by <- NULL
1482311224711:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1482311224712:plotEvolution(measure = 'number_of_emails', se = FALSE)
1482311236867:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482311236868:plotEvolution(measure = 'recipient_share', se = FALSE)
1482311246010:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482311246011:plotEvolution(measure = 'recipient_share', se = FALSE)
1482311265950:if (FALSE) {
1482311265951:segments <- unique(all_data[, segment]) %>%
1482311265951:ifelse('control' %in% ., c(., 'both'), .)
1482311265952:pw_common_contacts <- sapply(
1482311265952:c('sto', 'control', 'both'),
1482311265953:function(s) {
1482311265953:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1482311265954:},
1482311265954:simplify = FALSE
1482311265955:)
1482311265956:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
1482311265957:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1482311265959:plotHeatmapOfCommonContacts(pw_common_contacts$both)
1482311265959:}
1482311270457:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482311297034:campaign_summary <- calculateSummary(all_data)
1482311304713:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482311331727:plotEvolution(campaign_summary, smooth = TRUE) +  scale_y_continuous(labels = scales::percent_format())
1482311436570:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1482311437473:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1482311438087:last_contactlist <- getListOfLastSTOReceivers(program_data, customer, program)
1482311438701:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1482311443258:contactlist <- stable_contactlist
1482311444635:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1482311444636:merge(contactlist, by = c('contact_id', 'segment'))
1482311465978:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1482311467642:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1482311480723:n_past_campaigns[, quantile(N, seq(0, 1, 0.1))]
1482311486204:all_data <- merge(all_data, n_past_campaigns[N >= 60, .(contact_id, segment)], by = c('contact_id', 'segment'))
1482311500980:plotSendTimeDistributionEvolution(program_data)
1482311503846:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1482311511731:campaign_summary <- calculateSummary(all_data)
1482311517100:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482311527548:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1482311527548:plotEvolution(measure = 'recipient_share', se = FALSE)
1482311533190:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1482311533191:plotEvolution(measure = 'recipient_share', se = FALSE)
1482311548938:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1482311550159:plotEvolution(campaign_summary, smooth = TRUE) +  scale_y_continuous(labels = scales::percent_format())
1482311558544:generateRelativeData(campaign_summary) %>%
1482311558545:plotRelativeEvolution(trendlines = F, color = group_by, text_position = 0.9)
1482311591074:generateRelativeData(campaign_summary) %>%
1482311591076:plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = group_by)
1482311594560:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1482311603526:all_data <- addActivity(all_data)
1482311606792:plotActivityDistribution(all_data)
1482311613725:campaign_summary_activity <- calculateSummary(all_data, additional_by = c('activity'))
1482311617937:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1482311617938:plotRelativeEvolution(color = group_by, facet = 'activity', trendlines = FALSE)
1482311644018:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1482312512860:sending_variability <- calculateVariabilityOfLastSends(all_data[period == 'sto' & segment == 'sto'], scope = 5)
1482312559380:aggregateVariability(sending_variability) %>% plotSendingVariability()
1482312569400:aggregateVariability(sending_variability) %>% plotSendingVariability(by_sequence = TRUE)
1482312572925:aggregateVariability(sending_variability) %>% plotSendingVariability()
1482312576632:aggregateVariability(sending_variability, by_active_status = TRUE) %>%
1482312576632:plotSendingVariability()
1483440615907:source('global.R')
1483440618913:customer <- 'batiwiz'
1483440619533:program <- 'TD120'
1483440620974:group_by <- NULL
1483440633258:refetch <- TRUE
1483440633938:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1483441252790:reportStatistics(customer, program_data, check_pairwise_common = FALSE)
1483441264395:if (customer == 'batiwiz') {
1483441264396:# append new programs
1483441264397:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = refetch)
1483441264397:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = refetch)
1483441264397:program_data <- rbindlist(list(program_data, na_program_data, a_program_data))
1483441264400:}
1483441781928:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1483441788306:first_contactlist <- getListOfFirstSTOReceivers(program_data, customer, program)
1483441789019:last_contactlist <- getListOfLastSTOReceivers(program_data, customer, program)
1483441789722:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1483441792738:contactlist <- stable_contactlist
1483441796292:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1483441796293:merge(contactlist, by = c('contact_id', 'segment'))
1483441823142:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1483441826485:n_past_campaigns %>% ggplot(aes(x = N)) + geom_histogram()
1483441831301:n_past_campaigns[, quantile(N, seq(0, 1, 0.1))]
1483441835977:all_data <- merge(all_data, n_past_campaigns[N >= 60, .(contact_id, segment)], by = c('contact_id', 'segment'))
1483441841383:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1483441841385:plotEvolution(measure = 'number_of_emails', se = FALSE)
1483441846576:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1483441846577:plotEvolution(measure = 'recipient_share', se = FALSE)
1483441851110:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1483441851111:plotEvolution(measure = 'recipient_share', se = FALSE)
1483441861674:if (FALSE) {
1483441861674:segments <- unique(all_data[, segment]) %>%
1483441861675:ifelse('control' %in% ., c(., 'both'), .)
1483441861676:pw_common_contacts <- sapply(
1483441861676:c('sto', 'control', 'both'),
1483441861676:function(s) {
1483441861677:getCommonContactMatrix(all_data[period == 'sto'], s, order_by_weekday = F)
1483441861677:},
1483441861678:simplify = FALSE
1483441861678:)
1483441861679:plotHeatmapOfCommonContacts(pw_common_contacts$sto)
1483441861679:plotHeatmapOfCommonContacts(pw_common_contacts$control)
1483441861680:plotHeatmapOfCommonContacts(pw_common_contacts$both)
1483441861680:}
1483441862806:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1483441864110:plotSendTimeDistributionEvolution(program_data)
1483441870654:campaign_summary <- calculateSummary(all_data)
1483441877142:plotEvolution(campaign_summary) +  scale_y_continuous(labels = scales::percent_format())
1483441886497:plotEvolution(campaign_summary, smooth = TRUE) +  scale_y_continuous(labels = scales::percent_format())
1483441920449:generateRelativeData(campaign_summary) %>%
1483441920451:plotRelativeEvolution(trendlines = F, color = group_by, text_position = 0.9)
1483442073864:generateRelativeData(campaign_summary) %>%
1483442073865:plotRelativeEvolution(trendlines = FALSE, sto_text = FALSE, facet = group_by)
1483442077467:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution()
1483442083142:aggregateSummaryToWeeks(campaign_summary) %>% plotWeeklyRelativeEvolution(filter_dots = FALSE)
1483442093928:campaign_summary %>% plotOpenRatesByDays()
1483442119523:all_data <- addActivity(all_data)
1483442127193:plotActivityDistribution(all_data)
1483442137233:campaign_summary_activity <- calculateSummary(all_data, additional_by = c('activity'))
1483442140635:generateRelativeData(campaign_summary_activity, additional_by = 'activity') %>%
1483442140635:plotRelativeEvolution(color = group_by, facet = 'activity', trendlines = FALSE)
1483442175615:generateCumulativeOpenRates(all_data) %>% plotCumulatingOpenRates()
1483442226476:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1483442247519:calculateMedianDistance(all_data) %>%
1483442247519:generateRelativeData(measure = 'median_hours_to_open') %>%
1483442247520:plotRelativeEvolution(trendlines = F, variable = 'median send-open distance (hours)', color = 'weekday')
1483442277887:frequency_summary %>%
1483442277887:plotEvolution(measure = 'open_frequency', se = F, sto_line = F, sto_text = F) +
1483442277888:addSTOline(start_date = as.Date(SETTINGS[[customer]]$programs[[program]]$start_date))
1483442301272:open_frequency <- calculateOpenFrequency(all_data, window_size = 30) %>%
1483442301273:calculateAverageOpenFrequency()
1483442308072:open_frequency %>% plotEvolution(measure = 'open_frequency', se = FALSE)
1483442341782:last_past_date <- open_frequency[period == 'past', max(send_day)]
1483442344766:open_frequency[send_day >= last_past_date] %>%
1483442344767:.[, sequence := seq(1, .N), by = segment] %>%
1483442344767:.[sequence %in% c(1, 31, 61, 75)] %>%
1483442344768:dcast(sequence + period ~ segment, value.var = 'open_frequency')
1484212611419:source('global.R')
1484212646596:customer <- 'edigital'
1484212647474:program <- 'test'
1484212648881:refetch <- TRUE
1484212655987:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484212665844:packrat::restore(prompt = FALSE)
1484212718633:install.packages('emsconnectr', type = 'source')
1484212760385:packrat::snapshot(prompt = FALSE)
1484213008388:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484213426755:source('global.R')
1484213462507:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484213499559:source('global.R')
1484213501924:customer <- 'edigital'
1484213501941:program <- 'test'
1484213501943:refetch <- TRUE
1484213513373:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484213579911:unique_contacts <- unique(program_data[, .(segment, contact_id)])
1484213581016:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1484213581873:common_contacts <- program_data[, .N, by = .(segment, contact_id)] %>%
1484213581874:.[N == n_campaigns, .(segment, contact_id)]
1484213583298:reportStatistics(
1484213583312:customer, program_data,
1484213583312:unique_contacts, common_contacts,
1484213583313:check_pairwise_common = FALSE
1484213583313:)
1484213750401:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1484213751043:first_contactlist <- getListOfFirstSTOReceivers(program_data)
1484213751482:last_contactlist <- getListOfLastSTOReceivers(program_data)
1484213751912:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1484213752782:contactlist <- unique_contactlist
1484213769258:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484213769259:merge(contactlist, by = c('contact_id', 'segment'))
1484213841613:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1484213844731:n_past_campaigns %>% ggplot(aes(x = N)) +
1484213844731:geom_histogram(binwidth = 5) +
1484213844732:scale_x_continuous(breaks = seq(0,90,5))
1484213852905:past_campaign_num_limit <- quantile(n_past_campaigns$N, 0.33)
1484213877485:all_data <- merge(
1484213877486:all_data,
1484213877486:n_past_campaigns[N >= past_campaign_num_limit, .(contact_id, segment)],
1484213877487:by = c('contact_id', 'segment')
1484213877487:)
1484213882315:all_data
1484213899758:all_data[period == 'sto', .N, by = 'segment']
1484213914147:all_data[period == 'sto', .N, by = .(contact_id, segment)][, .N, by = segment]
1484213937426:saveRDS(all_data, file.path('data', str_c(customer, '_', program, '_all_data.rds')))
1484214066284:all_data <- readAllData(customer, program)
1484214151858:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484214151860:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484214171277:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)]
1484214199336:cucc <- all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)]
1484214201350:cucc
1484214205172:plotEvolution(cucc)
1484214212403:plotEvolution(cucc, measure = 'number_of_emails')
1484214218436:plotEvolution(cucc, measure = 'number_of_emails', se = FALSE)
1484214341297:Sys.Date()
1484214347523:Sys.Date() - 2
1484214359192:cucc[send_day < Sys.Date() - 2]
1484214369247:debug(plotEvolution)
1484214373280:plotEvolution(cucc, measure = 'number_of_emails', se = FALSE)
1484214388281:p
1484214510223:q
1484214535205:source('global.R')
1484214539084:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484214539086:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484214626929:cucc %>% ggplot(aes(send_day, number_of_emails, color = segment)) + geom_line(aes(group = segment))
1484214652521:cucc %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment))
1484214665720:cucc[send_day < Sys.Date() - offset] %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment))
1484214673379:cucc[send_day < Sys.Date() - 2] %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment))
1484214700284:cucc[send_day < Sys.Date() - 2] %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment)) + addSTOline(start_date = cucc[period == 'past', max(send_day)])
1484214708427:cucc[period=='past', max(send_day)]
1484214724401:cucc[send_day < Sys.Date() - 2] %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment)) + addSTOline(start_date = '2016-11-27')
1484214732309:cucc[send_day < Sys.Date() - 2] %>% ggplot(aes_string('send_day', 'number_of_emails', color = 'segment')) + geom_line(aes(group = segment)) + addSTOline(start_date = as.Date('2016-11-27'))
1484214857602:source('global.R')
1484214859921:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484214859921:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484214865256:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1484214865260:plotEvolution(measure = 'recipient_share', se = FALSE)
1484214886928:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1484214886930:plotEvolution(measure = 'recipient_share', se = FALSE)
1484214891150:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1484214891151:plotEvolution(measure = 'recipient_share', se = FALSE)
1484214899594:campaign_summary <- calculateCampaignSummary(all_data)
1484214902916:measure <- 'open_rate'
1484214905351:plotEvolution(campaign_summary, measure = measure) +
1484214905351:scale_y_continuous(labels = scales::percent_format())
1484214922425:plotEvolution(campaign_summary, measure = measure, smooth = TRUE) +
1484214922426:scale_y_continuous(labels = scales::percent_format())
1484214932378:measure <- 'click_rate'
1484214933229:plotEvolution(campaign_summary, measure = measure) +
1484214933229:scale_y_continuous(labels = scales::percent_format())
1484214937924:plotEvolution(campaign_summary, measure = measure, smooth = TRUE) +
1484214937924:scale_y_continuous(labels = scales::percent_format())
1484214943411:measure <- 'open_rate'
1484214944932:generateRelativeData(campaign_summary, measure = measure) %>%
1484214944932:plotRelativeEvolution(
1484214944933:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484214944933:) +
1484214944934:coord_cartesian(ylim = c(0.9, 1.2))
1484214954840:generateRelativeData(campaign_summary, measure = measure) %>%
1484214954840:plotRelativeEvolution(
1484214954841:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484214954842:) +
1484214954842:coord_cartesian(ylim = c(0.9, 1.2))
1484214960100:generateRelativeData(campaign_summary, measure = measure)
1484214965824:generateRelativeData(campaign_summary, measure = measure) %>% .[]
1484214981252:generateRelativeData(campaign_summary, measure = measure) %>%
1484214981252:plotRelativeEvolution(
1484214981253:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484214981253:)
1484214998026:generateRelativeData(campaign_summary, measure = measure) %>%
1484214998026:plotRelativeEvolution(
1484214998027:trendlines = F, measure = 'open_rate', color = group_by, text_position = 0.9
1484214998028:) +
1484214998028:coord_cartesian(ylim = c(0.9, 1.2))
1484215053442:generateRelativeData(campaign_summary, measure = measure) %>%
1484215053443:plotRelativeEvolution(
1484215053443:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484215053443:) +
1484215053444:coord_cartesian(ylim = c(0.9, 1.2))
1484215060593:generateRelativeData(campaign_summary, measure = measure) %>%
1484215060593:plotRelativeEvolution(
1484215060594:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484215060594:)
1484215065502:generateRelativeData(campaign_summary, measure = measure)
1484215086694:group_by <- NULL
1484215098265:generateRelativeData(campaign_summary, measure = measure) %>%
1484215098266:plotRelativeEvolution(
1484215098267:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484215098268:) +
1484215098268:coord_cartesian(ylim = c(0.9, 1.2))
1484215107012:generateRelativeData(campaign_summary, measure = measure) %>%
1484215107013:plotRelativeEvolution(
1484215107014:trendlines = F, measure = measure, color = group_by, text_position = 0.9
1484215107015:)
1484215118403:generateRelativeData(campaign_summary, measure = measure) %>%
1484215118404:plotRelativeEvolution(
1484215118405:trendlines = F, measure = measure, color = group_by, text_position = 0.95
1484215118405:)
1484215156146:all_data <- addActivity(all_data)
1484215158665:plotActivityDistribution(all_data)
1484215161250:campaign_summary_activity <- calculateCampaignSummary(all_data, additional_by = c('activity'))
1484215167109:generateRelativeData(campaign_summary_activity, measure = measure, additional_by = 'activity') %>%
1484215167110:plotRelativeEvolution(color = group_by, measure = measure, facet = 'activity', trendlines = FALSE)
1484215261588:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1484215272299:calculateMedianDistance(all_data) %>%
1484215272300:generateRelativeData(measure = 'median_hours_to_open') %>%
1484215272300:plotRelativeEvolution(trendlines = F, measure = 'median send-open distance (hours)', color = 'weekday')
1484215298966:calculateMedianDistance(all_data) %>%
1484215298967:generateRelativeData(measure = 'median_hours_to_open') %>%
1484215298967:plotRelativeEvolution(trendlines = F, prior_change_dates = F, measure = 'median send-open distance (hours)', color = 'weekday')
1484218304935:customer <- 'travelist_market'
1484218305758:program <- 'test2'
1484218307612:refetch <- TRUE
1484218308504:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484218445526:unique_contacts <- unique(program_data[, .(segment, contact_id)])
1484218446256:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1484218446757:common_contacts <- program_data[, .N, by = .(segment, contact_id)] %>%
1484218446758:.[N == n_campaigns, .(segment, contact_id)]
1484218447319:reportStatistics(
1484218447320:customer, program_data,
1484218447320:unique_contacts, common_contacts,
1484218447320:check_pairwise_common = FALSE
1484218447321:)
1484218561518:getCampaignsForProgram()
1484218567988:getCampaignsForProgram(customer, program)
1484218590345:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1484218615270:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484218615271:merge(contactlist, by = c('contact_id', 'segment'))
1484218757623:contactlist <- unique_contactlist
1484218760207:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1484218760587:first_contactlist <- getListOfFirstSTOReceivers(program_data)
1484218760891:last_contactlist <- getListOfLastSTOReceivers(program_data)
1484218761179:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1484218762175:contactlist <- unique_contactlist
1484218768696:all_data <- addPastData(customer, program, program_data, contactlist, refetch = TRUE) %>%
1484218768696:merge(contactlist, by = c('contact_id', 'segment'))
1484224024545:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1484224030834:n_past_campaigns %>% ggplot(aes(x = N)) +
1484224030834:geom_histogram(binwidth = 5) +
1484224030835:scale_x_continuous(breaks = seq(0,90,5))
1484224032421:past_campaign_num_limit <- quantile(n_past_campaigns$N, 0.33)
1484224037412:all_data <- merge(
1484224037413:all_data,
1484224037414:n_past_campaigns[N >= past_campaign_num_limit, .(contact_id, segment)],
1484224037414:by = c('contact_id', 'segment')
1484224037415:)
1484224055501:saveRDS(all_data, file.path('data', str_c(customer, '_', program, '_all_data.rds')))
1484224740496:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484224740499:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484224766721:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1484224766722:plotEvolution(measure = 'recipient_share', se = FALSE)
1484224790309:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1484224790310:plotEvolution(measure = 'recipient_share', se = FALSE)
1484224840872:getCampaignsForProgram(customer, program, FALSE)
1484224864044:getCampaignsForProgram(customer, program, refetch =FALSE)
1484224871487:program
1484224874167:customer
1484224883336:getCampaignsForProgram(customer, program, refetch = T)
1484224888055:getCampaignsForProgram(customer, program, refetch = F)
1484224916854:all_data[period = 'sto', .N, by = .(segment, send_day)]
1484224921055:all_data[period == 'sto', .N, by = .(segment, send_day)]
1484224947670:all_data[, .N, by = .(segment, send_day)][send_day > '2016-12-28']
1484224961187:all_data[, .N, by = .(segment, send_day, period)][send_day > '2016-12-28']
1484224992451:all_data[, .N, by = .(segment, send_day, period, campaign_id)][send_day > '2016-12-28']
1484225824182:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484225824184:merge(contactlist, by = c('contact_id', 'segment'))
1484226119813:all_data
1484226123876:all_data[period == 'past']
1484226160545:all_data[period == 'sto', min(send_day)]
1484226206696:all_data[period == 'period', send_day == '2016-12-30']
1484226210287:all_data[period == 'period' & send_day == '2016-12-30']
1484226767023:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484226767026:merge(contactlist, by = c('contact_id', 'segment'))
1484226910400:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1484226915480:n_past_campaigns %>% ggplot(aes(x = N)) +
1484226915482:geom_histogram(binwidth = 5) +
1484226915482:scale_x_continuous(breaks = seq(0,90,5))
1484226917040:past_campaign_num_limit <- quantile(n_past_campaigns$N, 0.33)
1484226919247:all_data <- merge(
1484226919247:all_data,
1484226919249:n_past_campaigns[N >= past_campaign_num_limit, .(contact_id, segment)],
1484226919250:by = c('contact_id', 'segment')
1484226919250:)
1484226934105:saveRDS(all_data, file.path('data', str_c(customer, '_', program, '_all_data.rds')))
1484226999633:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484226999635:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484227016392:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1484227031613:plotSendTimeDistributionEvolution(program_data, position = 'fill')
1484227044140:plotSendTimeDistributionEvolution(program_data)
1484227054109:campaign_summary <- calculateCampaignSummary(all_data)
1484227074603:measure <- 'open_rate'
1484227074605:plotEvolution(campaign_summary, measure = measure) +
1484227074607:scale_y_continuous(labels = scales::percent_format())
1484227094174:plotEvolution(campaign_summary, measure = measure, smooth = TRUE) +
1484227094174:scale_y_continuous(labels = scales::percent_format())
1484227098457:plotEvolution(campaign_summary, measure = measure, se = FALSE, smooth = TRUE) +
1484227098459:scale_y_continuous(labels = scales::percent_format())
1484227102926:generateRelativeData(campaign_summary, measure = measure) %>%
1484227102927:plotRelativeEvolution(
1484227102928:trendlines = F, measure = measure, color = group_by, text_position = 0.95
1484227102929:)
1484227113243:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484227113243:plotRelativeEvolution(
1484227113244:trendlines = F, measure = measure, time_var = 'campaign_tally',
1484227113245:facet = 'period', cols = 2,  color = group_by,
1484227113246:prior_change_dates = F, sto_line = F, sto_text = F) +
1484227113247:coord_cartesian(ylim = c(0.9, 1.2))
1484227267148:generateRelativeData(campaign_summary, measure = measure) %>%
1484227267148:plotRelativeEvolution(trendlines = F, measure = measure, sto_text = FALSE, facet = group_by)
1484227291675:all_data <- addActivity(all_data)
1484227315813:plotActivityDistribution(all_data)
1484227325868:campaign_summary_activity <- calculateCampaignSummary(all_data, additional_by = c('activity'))
1484227361186:generateRelativeData(campaign_summary_activity, measure = measure, additional_by = 'activity') %>%
1484227361187:plotRelativeEvolution(color = group_by, measure = measure, facet = 'activity', trendlines = FALSE)
1484227362302:myggsave(str_c('relative_', measure, '_by_activity.png'))
1484227388342:calculateMedianDistance(all_data) %>% plotMedianHoursToOpen(prior_change_dates = FALSE)
1484227404033:calculateMedianDistance(all_data) %>%
1484227404033:generateRelativeData(measure = 'median_hours_to_open') %>%
1484227404034:plotRelativeEvolution(trendlines = F, prior_change_dates = F, measure = 'median send-open distance (hours)', color = 'weekday')
1484227487359:customer <- 'lingualeo'
1484227487360:program <- 'test'
1484227490268:refetch <- TRUE
1484227491064:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484227647168:unique_contacts <- unique(program_data[, .(segment, contact_id)])
1484227647777:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1484227648619:common_contacts <- program_data[, .N, by = .(segment, contact_id)] %>%
1484227648619:.[N == n_campaigns, .(segment, contact_id)]
1484227649603:reportStatistics(
1484227649603:customer, program_data,
1484227649604:unique_contacts, common_contacts,
1484227649604:check_pairwise_common = FALSE
1484227649605:)
1484227656992:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1484227659290:contactlist <- unique_contactlist
1484227662069:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484227662070:merge(contactlist, by = c('contact_id', 'segment'))
1484227842408:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1484227844437:n_past_campaigns %>% ggplot(aes(x = N)) +
1484227844437:geom_histogram(binwidth = 5) +
1484227844438:scale_x_continuous(breaks = seq(0,90,5))
1484227856051:past_campaign_num_limit <- quantile(n_past_campaigns$N, 0.33)
1484227860517:all_data <- merge(
1484227860517:all_data,
1484227860518:n_past_campaigns[N >= past_campaign_num_limit, .(contact_id, segment)],
1484227860518:by = c('contact_id', 'segment')
1484227860519:)
1484227861921:saveRDS(all_data, file.path('data', str_c(customer, '_', program, '_all_data.rds')))
1484227886588:all_data %>% .[, .(number_of_emails = .N), by = .(send_day, period, segment)] %>%
1484227886589:plotEvolution(measure = 'number_of_emails', se = FALSE)
1484227898123:all_data %>% getRecipientShareForContactlist(contactlist) %>%
1484227898124:plotEvolution(measure = 'recipient_share', se = FALSE)
1484227901334:all_data %>% getRecipientShareForContactlist(contactlist, unique = TRUE) %>%
1484227901335:plotEvolution(measure = 'recipient_share', se = FALSE)
1484227908922:plotSendTimeDistributionEvolution(all_data[period == 'sto' & segment == 'sto'])
1484227913994:campaign_summary <- calculateCampaignSummary(all_data)
1484227916930:plotEvolution(campaign_summary, measure = measure) +
1484227916931:scale_y_continuous(labels = scales::percent_format())
1484227927759:plotEvolution(campaign_summary, measure = measure, smooth = TRUE) +
1484227927759:scale_y_continuous(labels = scales::percent_format())
1484227932803:plotEvolution(campaign_summary, measure = measure, se = FALSE, smooth = TRUE) +
1484227932804:scale_y_continuous(labels = scales::percent_format())
1484227937935:generateRelativeData(campaign_summary, measure = measure) %>%
1484227937935:plotRelativeEvolution(
1484227937936:trendlines = F, measure = measure, color = group_by, text_position = 0.95
1484227937936:)
1484227947490:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484227947491:plotRelativeEvolution(
1484227947492:trendlines = F, measure = measure, time_var = 'campaign_tally',
1484227947493:facet = 'period', cols = 2,  color = group_by,
1484227947494:prior_change_dates = F, sto_line = F, sto_text = F) +
1484227947495:coord_cartesian(ylim = c(0.9, 1.2))
1484233443811:all_data[, .N, by = activity]
1484233475601:all_data <- addActivity(all_data)
1484233479331:all_data[, .N, by = activity]
1484233531957:all_data[activity == 'inactive48' & period == 'sto'] %>% plotSendTimeDistributionEvolution()
1484580427971:library(caret)
1484580429859:library(ROCR)
1484580429952:source('global.R')
1484580430933:END_DATE <- '2016-11-28'
1484580432594:getPurchaseData <- function(customer_name) {
1484580432594:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1484580432595:.[!is.na(contact_id)] %>%
1484580432596:cleanRefunds() %>%
1484580432596:aggregateToDailyPurchase() %>%
1484580432597:createWeekSequence_()
1484580432597:}
1484580433495:getEmailRateData <- function(customer_name) {
1484580433495:readInRawData('email_rates', customer_name = customer_name, end_date = END_DATE) %>%
1484580433497:createWeekSequence_()
1484580433498:}
1484580434450:getEmailNumberData <- function(customer_name) {
1484580434450:readInRawData('email_numbers', customer_name = customer_name, end_date = END_DATE) %>%
1484580434451:createWeekSequence_()
1484580434452:}
1484580437084:purchase_dt <- getPurchaseData('evolution_slimming')
1484580438405:# email_rate_dt <- getEmailRateData('japancentre', start_date = '2015-05-04')
1484580438885:email_number_dt <- getEmailNumberData('evolution_slimming')
1484580446743:splitData <- function(purchase_data, email_data, web_data = NULL, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1484580446744:default_pars <- list(
1484580446745:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1484580446745:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1484580446746:email_aggregation_frequency = email_aggregation_frequency,
1484580446747:email_features = email_features
1484580446747:)
1484580446748:list(
1484580446749:train = do.call(
1484580446750:putTogetherDataForTargetPeriod,
1484580446750:c(target_year = 2016, target_week = 45, default_pars)
1484580446751:),
1484580446751:test = do.call(
1484580446752:putTogetherDataForTargetPeriod,
1484580446753:c(target_year = 2016, target_week = 47, default_pars)
1484580446755:)
1484580446756:)
1484580446757:}
1484580479056:data_14months_number <- splitData(purchase_dt, email_number_dt, web_data, email_features = c('num_click', 'num_open'))
1484580486990:data_14months_number <- splitData(purchase_dt, email_number_dt, email_features = c('num_click', 'num_open'))
1484580507552:rfm_glm <- train(
1484580522171:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1484580533085:rfm6_glm <- train(
1484580533085:purchased ~ recency + frequency + monetary + bought_last_period,
1484580533086:data = data_6months_number$train[sum_click + bought_last_period > 0],
1484580533086:method = 'glm',
1484580533087:family = 'binomial'
1484580533087:)
1484580542542:rfm_glm <- train(
1484580542542:purchased ~ recency + frequency + monetary + bought_last_period,
1484580542543:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484580542544:method = 'glm',
1484580542545:family = 'binomial'
1484580542545:)
1484580554822:rfm_click <- train(
1484580554822:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484580554823:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484580554824:method = 'glm',
1484580554824:family = 'binomial'
1484580554825:)
1484580568034:rfm_click_open <- train(
1484580568035:purchased ~ recency + frequency + monetary + bought_last_period + sum_open + sum_click,
1484580568036:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484580568037:method = 'glm',
1484580568037:family = 'binomial'
1484580568038:)
1484580716902:calculateAUC <- function(prediction, label) {
1484580716903:predictions <- prediction(prediction, label)
1484580716904:perf <- performance(predictions, measure = "auc")
1484580716904:round(perf@y.values[[1]]*100, 2)
1484580716905:}
1484580718439:createROCDf <- function(prediction, label) {
1484580718440:predictions <- prediction(prediction, label)
1484580718441:perf <- performance(predictions, measure = "tpr", x.measure = "fpr")
1484580718441:roc_df <- data.frame(
1484580718442:FPR = perf@x.values[[1]],
1484580718442:TPR = perf@y.values[[1]],
1484580718443:cutoff = perf@alpha.values[[1]]
1484580718443:)
1484580718444:}
1484580719239:plotROC <- function(models, ROCcolors = c('darkblue', 'darkgreen', 'darkred', 'orange', 'black')) {
1484580719240:results <- lapply(models, function(m) {
1484580719241:prediction <- predict(m$model, m$test, 'prob')$yes
1484580719241:label <- m$test$purchased
1484580719241:list(
1484580719242:ROCdf = createROCDf(prediction, label),
1484580719242:AUC = calculateAUC(prediction, label)
1484580719243:)
1484580719243:})
1484580719244:ROCplot <- ggplot() +
1484580719245:geom_segment(
1484580719245:aes(x = 0, y = 0, xend = 1, yend = 1),
1484580719246:linetype = "dotted", col = "black"
1484580719246:) +
1484580719247:scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1484580719248:scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .1)) +
1484580719249:xlab("False Positive Rate") + ylab("True Positive Rate")
1484580719252:for (i in seq_along(results)) {
1484580719253:ROCplot <- ROCplot +
1484580719254:geom_line(data = results[[i]]$ROCdf, aes(FPR, TPR), size = 2, col = ROCcolors[i])
1484580719255:}
1484580719257:n_estimation = nrow(models[[1]]$test)
1484580719258:ROCplot +
1484580719258:geom_text(
1484580719259:aes(
1484580719259:x = 0.55, y = seq_len(length(results))/10,
1484580719260:label = paste0(names(results), ': ', sapply(results, function(x) x$AUC), '%')
1484580719260:),
1484580719261:hjust = 0, col = ROCcolors[seq_len(length(results))]
1484580719261:) +
1484580719262:geom_text(
1484580719262:aes(
1484580719263:x = 0, y = 0.9, hjust = 0,
1484580719263:label = paste('Estimated for', format(n_estimation, big.mark = ','), 'persons')
1484580719264:)
1484580719266:)
1484580719267:}
1484580723680:email_models_6months <- list(
1484580723681:RFM_6 = list(
1484580723682:model = rfm6_glm,
1484580723683:test = data_6months_number$test[bought_last_period == 1]
1484580723683:),
1484580723684:RFM_14 = list(
1484580723684:model = rfm_glm,
1484580723684:test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])
1484580723685:),
1484580723685:RFM_click = list(model = rfm_click, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])),
1484580723686:RFM_click_open = list(model = rfm_click_open, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)]))
1484580723687:)
1484580725208:plotROC(email_models_6months)
1484580888227:END_DATE <- '2016-08-01'
1484580890781:getPurchaseData <- function(customer_name) {
1484580890782:readInRawData('purchase', customer_name = customer_name, end_date = END_DATE) %>%
1484580890783:.[!is.na(contact_id)] %>%
1484580890783:cleanRefunds() %>%
1484580890784:aggregateToDailyPurchase() %>%
1484580890784:createWeekSequence_()
1484580890785:}
1484580893314:purchase_dt <- getPurchaseData('evolution_slimming')
1484580899274:purchase_dt
1484580900630:purchase_dt
1484580908746:email_number_dt <- getEmailNumberData('evolution_slimming')
1484580932097:splitData <- function(purchase_data, email_data, web_data = NULL, purchase_relevancy = PURCHASE_RELEVANCY, email_relevancy = EMAIL_RELEVANCY, email_aggregation_frequency = EMAIL_AGGREGATION_FREQ, email_features = c('num_click', 'num_open'), web_relevancy = WEB_RELEVANCY) {
1484580932098:default_pars <- list(
1484580932099:purchase_dt = purchase_data, email_dt = email_data, web_dt = web_data,
1484580932099:purchase_relevancy = purchase_relevancy, email_relevancy = email_relevancy,
1484580932100:email_aggregation_frequency = email_aggregation_frequency,
1484580932100:email_features = email_features
1484580932101:)
1484580932101:list(
1484580932102:train = do.call(
1484580932103:putTogetherDataForTargetPeriod,
1484580932104:c(target_year = 2016, target_week = 27, default_pars)
1484580932104:),
1484580932105:test = do.call(
1484580932105:putTogetherDataForTargetPeriod,
1484580932106:c(target_year = 2016, target_week = 29, default_pars)
1484580932107:)
1484580932107:)
1484580932108:}
1484580933299:data_6months_number <- splitData(purchase_dt, email_number_dt, purchase_relevancy = 24)
1484580944594:data_14months_number <- splitData(purchase_dt, email_number_dt, email_features = c('num_click', 'num_open'))
1484580960154:rfm6_glm <- train(
1484580961503:purchased ~ recency + frequency + monetary + bought_last_period,
1484580961914:data = data_6months_number$train[sum_click + bought_last_period > 0],
1484580962203:method = 'glm',
1484580962550:family = 'binomial'
1484580963217:)
1484580972703:rfm_glm <- train(
1484580972704:purchased ~ recency + frequency + monetary + bought_last_period,
1484580972705:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484580972705:method = 'glm',
1484580972705:family = 'binomial'
1484580972706:)
1484580986279:rfm_click <- train(
1484580986279:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484580986281:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484580986281:method = 'glm',
1484580986281:family = 'binomial'
1484580988314:)
1484581002290:rfm_click_open <- train(
1484581002291:purchased ~ recency + frequency + monetary + bought_last_period + sum_open + sum_click,
1484581002292:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484581002292:method = 'glm',
1484581002292:family = 'binomial'
1484581002293:)
1484581017086:plotROC(email_models_6months)
1484581029217:email_models_6months <- list(
1484581029218:RFM_6 = list(
1484581029218:model = rfm6_glm,
1484581029219:test = data_6months_number$test[bought_last_period == 1]
1484581029219:),
1484581029220:RFM_14 = list(
1484581029220:model = rfm_glm,
1484581029220:test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])
1484581029221:),
1484581029222:RFM_click = list(model = rfm_click, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)])),
1484581029222:RFM_click_open = list(model = rfm_click_open, test = merge(data_14months_number$test, data_6months_number$test[bought_last_period == 1, .(contact_id)]))
1484581029223:)
1484581032167:plotROC(email_models_6months)
1484581105885:results <- lapply(email_models_6months, function(m) {}
1484581112260:results <- lapply(email_models_6months, function(m) {
1484581132206:prediction <- predict(m$model, m$test, 'prob')$yes
1484581139342:label <- m$test$purchased
1484581152488:createROCDf(prediction, label)
1484581155037:)
1484581165408:results <- lapply(email_models_6months, function(m) {
1484581168111:prediction <- predict(m$model, m$test, 'prob')$yes
1484581171167:label <- m$test$purchased
1484581174168:createROCDf(prediction, label)
1484581175783:}
1484581176630:)
1484581178495:results
1484581204567:names(results)
1484581237434:lapply(names(results), function(name) {results[[name]][, model := name]})
1484581244081:results[[1]]
1484581248378:results[[1]] %>% class
1484581260148:lapply(names(results), function(name) {results[[name]]$model <- name})
1484581263466:results
1484581297564:lapply(names(results), function(name) {results[[name]]$model <- name; results})
1484581304013:cucc <- lapply(names(results), function(name) {results[[name]]$model <- name; results})
1484581329877:cucc <- lapply(names(results), function(name) {results[[name]]$model <- name; results[[name]]})
1484581332118:cucc
1484581340437:rbindlist(cucc)
1484581357899:rbindlist(cucc) %>% fwrite('data/rfm1_data.csv')
1484581406021:methods <- list(
1484581406022:tree = list(
1484581406023:model = rfm_click_tree,
1484581406023:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484581406023:),
1484581406024:forest = list(
1484581406025:model = rfm_click_rf,
1484581406026:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484581406026:),
1484581406026:gbm = list(
1484581406027:model = rfm_click_gbm,
1484581406027:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484581406027:),
1484581406028:glm = list(
1484581406028:model = rfm_click,
1484581406028:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484581406029:),
1484581406029:neuralnet = list(
1484581406030:model = rfm_click_nnet,
1484581406030:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484581406031:)
1484581406031:)
1484581419405:rfm_click_tree <- train(
1484581419405:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484581419406:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484581419406:method = 'rpart'
1484581419407:)
1484581429328:rfm_click_rf <- train(
1484581429329:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484581429330:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484581429330:method = 'rf'
1484581429331:)
1484594565955:rfm_click_nnet <- train(
1484594565957:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484594565957:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484594565958:method = 'nnet'
1484594565958:)
1484595062183:rfm_click_gbm <- train(
1484595062185:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484595062185:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484595062185:method = 'gbm'
1484595062186:)
1484645255325:methods <- list(
1484645255327:tree = list(
1484645255327:model = rfm_click_tree,
1484645255328:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645255328:),
1484645255329:forest = list(
1484645255330:model = rfm_click_rf,
1484645255330:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645255331:),
1484645255331:gbm = list(
1484645255332:model = rfm_click_gbm,
1484645255332:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645255332:),
1484645255333:glm = list(
1484645255333:model = rfm_click,
1484645255333:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645255336:),
1484645255336:neuralnet = list(
1484645255337:model = rfm_click_nnet,
1484645255338:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645255339:)
1484645255340:)
1484645257477:plotROC(methods)
1484645336787:rfm_click_nnet <- train(
1484645336788:purchased ~ recency + frequency + monetary + bought_last_period + sum_click,
1484645336789:data = data_14months_number$train[sum_click + bought_last_period > 0],
1484645336789:method = 'nnet'
1484645336789:)
1484645837299:summary(rfm_click_nnet)
1484645853665:methods <- list(
1484645853666:tree = list(
1484645853667:model = rfm_click_tree,
1484645853667:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645853667:),
1484645853668:forest = list(
1484645853668:model = rfm_click_rf,
1484645853669:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645853670:),
1484645853671:gbm = list(
1484645853671:model = rfm_click_gbm,
1484645853672:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645853672:),
1484645853672:glm = list(
1484645853673:model = rfm_click,
1484645853673:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645853673:),
1484645853674:neuralnet = list(
1484645853674:model = rfm_click_nnet,
1484645853674:test = data_14months_number$test[sum_click + bought_last_period > 0]
1484645853675:)
1484645853679:)
1484645853741:plotROC(methods)
1484646151616:results <- lapply(methods, function(m) {
1484646171025:pr <- predict(m$model, m$test, 'prob')$yes
1484646179369:l <- m$test$purchased
1484646189608:createROCDf(pr, l)
1484646190827:}
1484646191527:)
1484646198121:results
1484646233195:lapply(names(results), function(n) {results[[n]]$model <- n; results[[n]]})
1484646253653:lapply(names(results), function(n) {results[[n]]$model <- n; results[[n]]}) %>% rbindlist %>% fwrite('data/tmp_roc2.csv')
1484647287827:data_14months_number$test
1484647300099:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)]
1484647318395:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(~contact-id)
1484647321002:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(~contact_id)
1484647324916:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars =contact_id)
1484647333245:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id')
1484647356414:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(fill = variable, alpha = 0.6)
1484647365701:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6)
1484647387817:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6) + scale_x_log10()
1484647412102:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, span = 0.1) + scale_x_log10()
1484647416766:?geom_density
1484647492244:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 0.1) + scale_x_log10()
1484647497211:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 2) + scale_x_log10()
1484647506299:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 1.5) + scale_x_log10()
1484647538276:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% fwrite('data/tmp_cart.csv')
1484648140777:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 1.5) + scale_x_log10()
1484648152780:data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 1.5) + scale_x_log10() %>% ggplot_build()
1484648161638:p <- data_14months_number$test[, .(contact_id, actual_cart_value, last_purchase)] %>% melt(id.vars = 'contact_id') %>% ggplot(aes(value)) + geom_density(aes(fill = variable), alpha = 0.6, adjust = 1.5) + scale_x_log10()
1484648162298:p
1484648166034:ggplot_build(p)
1484648171379:cucc <- ggplot_build(p)
1484648172625:cucc
1484648199188:cucc$data
1484648226678:class(cucc$data)
1484648231519:class(cucc$data[[1]])
1484648254322:fwrite(cucc$data[[1]], 'data/tmp_density.csv')
1484651544345:source('global.R')
1484651547974:customer <- 'batiwiz'
1484651548492:program <- 'TD120'
1484651549670:all_data <- readAllData(customer, program)
1484651556711:source('global.R')
1484651557629:customer <- 'batiwiz'
1484651558244:program <- 'TD120'
1484651559517:refetch <- FALSE
1484651560362:program_data <- getCampaignDataForCustomer(customer, program, refetch = refetch)
1484651563350:unique_contacts <- unique(program_data[, .(segment, contact_id)])
1484651563594:n_campaigns <- program_data[segment == 'sto', uniqueN(campaign_id)]
1484651563678:common_contacts <- program_data[, .N, by = .(segment, contact_id)] %>%
1484651563678:.[N == n_campaigns, .(segment, contact_id)]
1484651567883:if (customer == 'batiwiz') {
1484651567883:# append new programs
1484651567884:na_program_data <- getCampaignDataForCustomer(customer, 'NA-TD120', refetch = refetch)
1484651567884:a_program_data <- getCampaignDataForCustomer(customer, 'A-TD120', refetch = refetch)
1484651567885:common_dates <- as.Date(
1484651567885:intersect(
1484651567886:unique(a_program_data$send_day),
1484651567887:unique(na_program_data$send_day))
1484651567887:, origin = '1970-01-01'
1484651567888:)
1484651567888:a_filtered <- a_program_data[send_day %in% common_dates]
1484651567889:na_filtered <- na_program_data[send_day %in% common_dates]
1484651567891:program_data <- rbindlist(list(program_data, na_filtered, a_filtered))
1484651567892:}
1484651613692:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1484651616086:unique_contactlist <- unique(program_data[, .(segment, contact_id)])
1484651617354:first_contactlist <- getListOfFirstSTOReceivers(program_data)
1484651618021:last_contactlist <- getListOfLastSTOReceivers(program_data)
1484651618153:stable_contactlist <- merge(first_contactlist, last_contactlist, by = c('contact_id', 'segment'))
1484651619389:contactlist <- stable_contactlist
1484651621697:all_data <- addPastData(customer, program, program_data, contactlist, refetch = FALSE) %>%
1484651621697:merge(contactlist, by = c('contact_id', 'segment'))
1484651644392:n_past_campaigns <- all_data[period == 'past', .N, by = .(segment, contact_id)]
1484651644885:past_campaign_num_limit <- quantile(n_past_campaigns$N, 0.1)
1484651651872:past_campaign_num_limit <- 66
1484651652524:all_data <- merge(
1484651652524:all_data,
1484651652525:n_past_campaigns[N >= past_campaign_num_limit, .(contact_id, segment)],
1484651652527:by = c('contact_id', 'segment')
1484651652528:)
1484651655580:saveRDS(all_data, file.path('data', str_c(customer, '_', program, '_all_data.rds')))
1484651678601:campaign_summary <- calculateCampaignSummary(all_data)
1484651743191:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484651743191:.[relative_measure < 1.15] %>%
1484651743192:plotRelativeEvolution(
1484651743193:trendlines = T, measure = measure, time_var = 'send_day',
1484651743193:color = group_by,
1484651743193:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484651743194:theme_bw(base_family = 'Times', base_size = 14) +
1484651743194:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484651743194:ggtitle('Uplift of STO open rate compared to control group',
1484651743195:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484651743195:scale_y_continuous(labels = scales::percent_format()) +
1484651743196:theme(plot.title = element_text(face = 'bold'))
1484651749532:measure <- 'open_rate'
1484651751994:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484651751994:.[relative_measure < 1.15] %>%
1484651751995:plotRelativeEvolution(
1484651751996:trendlines = T, measure = measure, time_var = 'send_day',
1484651751996:color = group_by,
1484651751996:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484651751997:theme_bw(base_family = 'Times', base_size = 14) +
1484651751997:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484651751998:ggtitle('Uplift of STO open rate compared to control group',
1484651751999:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484651752000:scale_y_continuous(labels = scales::percent_format()) +
1484651752000:theme(plot.title = element_text(face = 'bold'))
1484651761579:group_by <- NULL
1484651771976:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484651771977:.[relative_measure < 1.15] %>%
1484651771978:plotRelativeEvolution(
1484651771978:trendlines = T, measure = measure, time_var = 'send_day',
1484651771978:color = group_by,
1484651771979:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484651771979:theme_bw(base_family = 'Times', base_size = 14) +
1484651771979:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484651771980:ggtitle('Uplift of STO open rate compared to control group',
1484651771980:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484651771981:scale_y_continuous(labels = scales::percent_format()) +
1484651771983:theme(plot.title = element_text(face = 'bold'))
1484651835160:fonts()
1484651862064:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484651862065:.[relative_measure < 1.15] %>%
1484651862066:plotRelativeEvolution(
1484651862066:trendlines = T, measure = measure, time_var = 'send_day',
1484651862066:color = group_by,
1484651862067:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484651862067:theme_bw(base_family = 'Times', base_size = 14) +
1484651862068:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484651862069:ggtitle('Uplift of STO open rate compared to control group',
1484651862070:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484651862072:scale_y_continuous(labels = scales::percent_format()) +
1484651862072:theme(plot.title = element_text(face = 'bold', family = 'Courier'))
1484651884372:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484651884373:.[relative_measure < 1.15] %>%
1484651884374:plotRelativeEvolution(
1484651884374:trendlines = T, measure = measure, time_var = 'send_day',
1484651884374:color = group_by,
1484651884375:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484651884375:theme_bw(base_family = 'Times', base_size = 14) +
1484651884375:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484651884376:ggtitle('Uplift of STO open rate compared to control group',
1484651884376:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484651884377:scale_y_continuous(labels = scales::percent_format()) +
1484651884377:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Courier'))
1484652009035:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1484652009036:plot_list <- list()
1484652009037:if (sto_line) {
1484652009037:date_df <- data.table(x = start_date, y = text_position)
1484652009038:plot_list <- list(
1484652009038:plot_list,
1484652009038:geom_vline(
1484652009039:data = date_df,
1484652009039:aes(xintercept = as.numeric(x)),
1484652009039:color = 'black', linetype = 'dashed'
1484652009040:)
1484652009040:)
1484652009041:if (sto_text) {
1484652009041:plot_list <- list(
1484652009041:plot_list,
1484652009042:geom_text(
1484652009042:data = data.frame(x = start_date, y = text_position),
1484652009042:aes(x, y, label = 'Start of STO', family = 'Times New Roman'),
1484652009043:color = 'black', hjust = 1.1
1484652009043:)
1484652009044:)
1484652009044:}
1484652009044:}
1484652009045:if (prior_changes) {
1484652009045:plot_list <- list(
1484652009046:plot_list,
1484652009046:geom_vline(
1484652009047:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1484652009047:aes(xintercept = date),
1484652009047:color = 'black', linetype = 'dotted'
1484652009048:)
1484652009049:)
1484652009049:}
1484652009050:plot_list
1484652009050:}
1484652021786:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652021787:.[relative_measure < 1.15] %>%
1484652021788:plotRelativeEvolution(
1484652021788:trendlines = T, measure = measure, time_var = 'send_day',
1484652021788:color = group_by,
1484652021789:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652021789:theme_bw(base_family = 'Times', base_size = 14) +
1484652021789:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652021790:ggtitle('Uplift of STO open rate compared to control group',
1484652021791:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652021792:scale_y_continuous(labels = scales::percent_format()) +
1484652021792:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Courier'))
1484652094624:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1484652094625:plot_list <- list()
1484652094626:if (sto_line) {
1484652094626:date_df <- data.table(x = start_date, y = text_position)
1484652094627:plot_list <- list(
1484652094628:plot_list,
1484652094629:geom_vline(
1484652094629:data = date_df,
1484652094630:aes(xintercept = as.numeric(x)),
1484652094631:color = 'black', linetype = 'dashed'
1484652094631:)
1484652094632:)
1484652094632:if (sto_text) {
1484652094633:plot_list <- list(
1484652094634:plot_list,
1484652094635:geom_text(
1484652094635:data = data.frame(x = start_date, y = text_position),
1484652094636:aes(x, y, label = 'Start of STO', family = 'AvantGarde'),
1484652094637:color = 'black', hjust = 1.1
1484652094638:)
1484652094638:)
1484652094639:}
1484652094640:}
1484652094640:if (prior_changes) {
1484652094641:plot_list <- list(
1484652094642:plot_list,
1484652094643:geom_vline(
1484652094643:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1484652094644:aes(xintercept = date),
1484652094645:color = 'black', linetype = 'dotted'
1484652094649:)
1484652094653:)
1484652094655:}
1484652094656:plot_list
1484652094657:}
1484652104141:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652104141:.[relative_measure < 1.15] %>%
1484652104142:plotRelativeEvolution(
1484652104143:trendlines = T, measure = measure, time_var = 'send_day',
1484652104143:color = group_by,
1484652104143:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652104144:theme_bw(base_family = 'Times', base_size = 14) +
1484652104144:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652104145:ggtitle('Uplift of STO open rate compared to control group',
1484652104146:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652104147:scale_y_continuous(labels = scales::percent_format()) +
1484652104148:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'AvantGarde'))
1484652145587:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1484652145588:plot_list <- list()
1484652145588:if (sto_line) {
1484652145589:date_df <- data.table(x = start_date, y = text_position)
1484652145589:plot_list <- list(
1484652145591:plot_list,
1484652145591:geom_vline(
1484652145592:data = date_df,
1484652145592:aes(xintercept = as.numeric(x)),
1484652145593:color = 'black', linetype = 'dashed'
1484652145594:)
1484652145594:)
1484652145595:if (sto_text) {
1484652145596:plot_list <- list(
1484652145597:plot_list,
1484652145597:geom_text(
1484652145598:data = data.frame(x = start_date, y = text_position),
1484652145599:aes(x, y, label = 'Start of STO', family = 'Helvetica'),
1484652145599:color = 'black', hjust = 1.1
1484652145600:)
1484652145601:)
1484652145601:}
1484652145602:}
1484652145603:if (prior_changes) {
1484652145603:plot_list <- list(
1484652145604:plot_list,
1484652145605:geom_vline(
1484652145605:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1484652145606:aes(xintercept = date),
1484652145607:color = 'black', linetype = 'dotted'
1484652145607:)
1484652145609:)
1484652145609:}
1484652145610:plot_list
1484652145611:}
1484652152742:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652152742:.[relative_measure < 1.15] %>%
1484652152743:plotRelativeEvolution(
1484652152743:trendlines = T, measure = measure, time_var = 'send_day',
1484652152744:color = group_by,
1484652152744:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652152744:theme_bw(base_family = 'Times', base_size = 14) +
1484652152745:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652152745:ggtitle('Uplift of STO open rate compared to control group',
1484652152746:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652152747:scale_y_continuous(labels = scales::percent_format()) +
1484652152748:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Helvetica'))
1484652186231:myggsave('prezi_relative_open_rate.png')
1484652255597:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652255598:.[relative_measure < 1.15] %>%
1484652255599:plotRelativeEvolution(
1484652255599:trendlines = T, measure = measure, time_var = 'send_day',
1484652255600:color = group_by,
1484652255601:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652255602:theme_bw(base_family = 'Times', base_size = 14) +
1484652255603:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652255604:ggtitle('Uplift of STO open rate compared to control group',
1484652255604:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652255604:scale_y_continuous(labels = scales::percent_format()) +
1484652255605:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Helvetica-Narrow'))
1484652282009:install.packages('extrafont')
1484652298007:font_import()
1484652302526:library(extrafont)
1484652321202:font_import()
1484652331244:font_import()
1484652442533:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652442534:.[relative_measure < 1.15] %>%
1484652442535:plotRelativeEvolution(
1484652442535:trendlines = T, measure = measure, time_var = 'send_day',
1484652442535:color = group_by,
1484652442536:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652442537:theme_bw(base_family = 'Times', base_size = 14) +
1484652442538:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652442538:ggtitle('Uplift of STO open rate compared to control group',
1484652442539:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652442540:scale_y_continuous(labels = scales::percent_format()) +
1484652442541:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'teen'))
1484652525385:fonts()
1484652533191:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652533192:.[relative_measure < 1.15] %>%
1484652533193:plotRelativeEvolution(
1484652533193:trendlines = T, measure = measure, time_var = 'send_day',
1484652533193:color = group_by,
1484652533194:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652533195:theme_bw(base_family = 'Times', base_size = 14) +
1484652533195:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652533196:ggtitle('Uplift of STO open rate compared to control group',
1484652533197:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652533198:scale_y_continuous(labels = scales::percent_format()) +
1484652533199:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Teen'))
1484652570101:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1484652570102:plot_list <- list()
1484652570103:if (sto_line) {
1484652570103:date_df <- data.table(x = start_date, y = text_position)
1484652570104:plot_list <- list(
1484652570104:plot_list,
1484652570105:geom_vline(
1484652570105:data = date_df,
1484652570106:aes(xintercept = as.numeric(x)),
1484652570106:color = 'black', linetype = 'dashed'
1484652570107:)
1484652570107:)
1484652570108:if (sto_text) {
1484652570108:plot_list <- list(
1484652570109:plot_list,
1484652570110:geom_text(
1484652570110:data = data.frame(x = start_date, y = text_position),
1484652570111:aes(x, y, label = 'Start of STO', family = 'Teen'),
1484652570112:color = 'black', hjust = 1.1
1484652570113:)
1484652570117:)
1484652570118:}
1484652570119:}
1484652570119:if (prior_changes) {
1484652570120:plot_list <- list(
1484652570121:plot_list,
1484652570122:geom_vline(
1484652570122:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1484652570123:aes(xintercept = date),
1484652570124:color = 'black', linetype = 'dotted'
1484652570125:)
1484652570125:)
1484652570126:}
1484652570127:plot_list
1484652570128:}
1484652574571:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652574571:.[relative_measure < 1.15] %>%
1484652574572:plotRelativeEvolution(
1484652574573:trendlines = T, measure = measure, time_var = 'send_day',
1484652574573:color = group_by,
1484652574573:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652574574:theme_bw(base_family = 'Times', base_size = 14) +
1484652574574:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652574574:ggtitle('Uplift of STO open rate compared to control group',
1484652574575:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652574575:scale_y_continuous(labels = scales::percent_format()) +
1484652574575:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Teen'))
1484652587394:fonts()
1484652598767:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652598767:.[relative_measure < 1.15] %>%
1484652598768:plotRelativeEvolution(
1484652598768:trendlines = T, measure = measure, time_var = 'send_day',
1484652598769:color = group_by,
1484652598769:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652598769:theme_bw(base_family = 'Times', base_size = 14) +
1484652598769:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652598770:ggtitle('Uplift of STO open rate compared to control group',
1484652598770:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652598771:scale_y_continuous(labels = scales::percent_format()) +
1484652598771:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Luminari'))
1484652615034:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652615035:.[relative_measure < 1.15] %>%
1484652615036:plotRelativeEvolution(
1484652615036:trendlines = T, measure = measure, time_var = 'send_day',
1484652615036:color = group_by,
1484652615037:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652615037:theme_bw(base_family = 'Times', base_size = 14) +
1484652615038:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652615038:ggtitle('Uplift of STO open rate compared to control group',
1484652615038:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652615039:scale_y_continuous(labels = scales::percent_format()) +
1484652615039:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Yanone Kaffeesatz Regular'))
1484652659465:addSTOline <- function(start_date = NULL, sto_line = TRUE, sto_text = TRUE, prior_changes = TRUE, text_position = 0.8) {
1484652659466:plot_list <- list()
1484652659467:if (sto_line) {
1484652659468:date_df <- data.table(x = start_date, y = text_position)
1484652659469:plot_list <- list(
1484652659470:plot_list,
1484652659470:geom_vline(
1484652659471:data = date_df,
1484652659472:aes(xintercept = as.numeric(x)),
1484652659472:color = 'black', linetype = 'dashed'
1484652659473:)
1484652659474:)
1484652659474:if (sto_text) {
1484652659475:plot_list <- list(
1484652659476:plot_list,
1484652659477:geom_text(
1484652659478:data = data.frame(x = start_date, y = text_position),
1484652659478:aes(x, y, label = 'Start of STO', family = 'Yanone Kaffeesatz Regular'),
1484652659479:color = 'black', hjust = 1.1
1484652659479:)
1484652659480:)
1484652659481:}
1484652659481:}
1484652659482:if (prior_changes) {
1484652659482:plot_list <- list(
1484652659484:plot_list,
1484652659484:geom_vline(
1484652659485:data = data.table(date = as.numeric(as.Date(PRIOR_CHANGE_DATES))),
1484652659485:aes(xintercept = date),
1484652659485:color = 'black', linetype = 'dotted'
1484652659486:)
1484652659487:)
1484652659488:}
1484652659489:plot_list
1484652659491:}
1484652670177:myggsave('prezi_relative_open_rate.png')
1484652787211:myggsave <- function(plot_name) {
1484652787212:if (!dir.exists(file.path('figure', customer))) {
1484652787213:dir.create(file.path('figure', customer))
1484652787214:}
1484652787214:ggsave(
1484652787215:file.path('figure', customer, str_c(customer, Sys.Date(), plot_name, sep = '_')),
1484652787215:width = 23.5, height = 13.375
1484652787216:)
1484652787216:}
1484652819501:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652819502:.[relative_measure < 1.15] %>%
1484652819503:plotRelativeEvolution(
1484652819503:trendlines = T, measure = measure, time_var = 'send_day',
1484652819504:color = group_by,
1484652819504:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652819505:theme_bw(base_family = 'Times', base_size = 14) +
1484652819505:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652819506:ggtitle('Uplift of STO open rate compared to control group',
1484652819507:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652819507:scale_y_continuous(labels = scales::percent_format()) +
1484652819508:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Yanone Kaffeesatz Regular'))
1484652822230:myggsave('prezi_relative_open_rate.png')
1484652892575:myggsave <- function(plot_name) {
1484652892576:if (!dir.exists(file.path('figure', customer))) {
1484652892577:dir.create(file.path('figure', customer))
1484652892578:}
1484652892579:ggsave(
1484652892579:file.path('figure', customer, str_c(customer, Sys.Date(), plot_name, sep = '_')),
1484652892580:width = 5.875, height = 3.34375
1484652892580:)
1484652892581:}
1484652897899:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652897899:.[relative_measure < 1.15] %>%
1484652897900:plotRelativeEvolution(
1484652897901:trendlines = T, measure = measure, time_var = 'send_day',
1484652897901:color = group_by,
1484652897901:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652897901:theme_bw(base_family = 'Times', base_size = 14) +
1484652897902:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652897902:ggtitle('Uplift of STO open rate compared to control group',
1484652897903:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652897903:scale_y_continuous(labels = scales::percent_format()) +
1484652897903:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Yanone Kaffeesatz Regular'))
1484652898290:myggsave('prezi_relative_open_rate.png')
1484652977616:myggsave <- function(plot_name) {
1484652977617:if (!dir.exists(file.path('figure', customer))) {
1484652977617:dir.create(file.path('figure', customer))
1484652977618:}
1484652977618:ggsave(
1484652977619:file.path('figure', customer, str_c(customer, Sys.Date(), plot_name, sep = '_')),
1484652977620:width = 8.8, height = 5
1484652977620:)
1484652977621:}
1484652980849:generateRelativeData(campaign_summary, measure = measure, window_size = 5) %>%
1484652980850:.[relative_measure < 1.15] %>%
1484652980851:plotRelativeEvolution(
1484652980851:trendlines = T, measure = measure, time_var = 'send_day',
1484652980852:color = group_by,
1484652980852:prior_change_dates = F, sto_line = T, sto_text = T, text_position = 0.93) +
1484652980852:theme_bw(base_family = 'Times', base_size = 14) +
1484652980853:labs(x = 'campaign send day', y = 'uplift of STO open rate') +
1484652980854:ggtitle('Uplift of STO open rate compared to control group',
1484652980854:subtitle = 'measured on contacts receiving campaigns throughout the whole period') +
1484652980854:scale_y_continuous(labels = scales::percent_format()) +
1484652980855:theme(plot.title = element_text(face = 'bold'), text = element_text(family = 'Yanone Kaffeesatz Regular'))
1484652981191:myggsave('prezi_relative_open_rate.png')
1484653066102:myggsave <- function(plot_name) {
1484653066103:if (!dir.exists(file.path('figure', customer))) {
1484653066104:dir.create(file.path('figure', customer))
1484653066104:}
1484653066105:ggsave(
1484653066105:file.path('figure', customer, str_c(customer, Sys.Date(), plot_name, sep = '_')),
