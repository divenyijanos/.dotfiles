1491900103199:debug(queryFromFileOrQueryAndParams)
1491900126507:debug(substituteParamsInQuery)
1491900139964:all_params
1491900145357:class(all_params)
1491900148827:class(all_params[[1]])
1491900158930:params
1491900202382:?str_replace_all
1491900216878:str_replace('hey', 'e', 'a')
1491900219317:str_replace('hey', 'e', 1)
1491900293298:suppressPackageStartupMessages(
1491900293298:source('global.R')
1491900293299:)
1491900295923:recom_history <- getRecomHistory(selected_customer, refetch = TRUE)
1491900312410:undebug(getRecomHistory)
1491900327301:undebug(getBigQueryResult)
1491900339062:recom_history <- getRecomHistory(selected_customer, refetch = TRUE)
1491901979617:str_replace('hay', 'a', 1)
1491901986426:str_replace('hay', 'a', '1')
1491902003714:sessionInfo()
1491902398725:getIdFromName('cunda_at')
1491902403876:getIdFromName('cunda_ch')
1491902429400:cl <- c(295565849, 297655489)
1491902611240:querySuitesForCustomers(query = 'select count(*) from contact_element', customer_id_list = cl)
1491903834269:str_match('bq.ems-incentives', '^bq')
1491903841358:str_match('bq.ems-incentives', '^bq')
1491903856614:?str_match
1491903957061:str_detect('bq.ems-incentives', '^bq')
1491903995628:str_detect('bq.ems-incentives', '\..*')
1491904001515:str_detect('bq.ems-incentives', '/..*')
1491904006941:str_match('bq.ems-incentives', '/..*')
1491904010003:str_match('bq.ems-incentives', '.*')
1491904013721:str_match('bq.ems-incentives', '\\..*')
1491904018965:str_match('bq.ems-incentives', '\\.(.*)')
1491904042650:str_match('bq.ems-incentives', 'bq\\.(.*)')
1491904120731:str_match('bq.ems-incentives', 'bq.(.*)')
1491904147536:str_match('bq.ems-incentives', 'bq\\.(.*)')[[2]]
1491904446438:install.packages("git2r")
1491904482295:packrat::status()
1491904494749:packrat::restore()
1491904552663:packrat::restore(prompt = FALSE)
1491904587532:install.packages("git2r")
1491904629773:packrat::restore(prompt = FALSE)
1491904759092:install.packages("stringi")
1491904815111:packrat::restore(prompt = FALSE)
1491905134664:packrat::status()
1491905616565:devtools::document()
1491906833054:install.packages('emsconnectr', type = 'source')
1491906858561:sessionInfo()
1491907097284:install.packages("emsconnectr", type = 'source')
1491907158545:sessionInfo()
1491907205310:library(emsconnectr)
1491907209883:sessionInfo()
1491907310118:suppressPackageStartupMessages(
1491907310120:source('global.R')
1491907310120:)
1491907315250:args = commandArgs(trailingOnly=TRUE)
1491907317051:if (length(args)==0) {
1491907317051:selected_customer <- DEFAULT_SELECTED_CUSTOMER
1491907317052:} else{
1491907317052:selected_customer <- args[1]
1491907317053:}
1491907318961:message(sprintf("Currently selected customer: %s", selected_customer))
1491907321857:recom_history <- getRecomHistory(selected_customer, refetch = TRUE)
1491914942453:getRecomHistory <- function(customer, refetch = FALSE) {
1491914942454:file_name <- file.path('data', paste(customer, 'recom_history.csv', sep = '_'))
1491914942455:if (file.exists(file_name) & !refetch) {
1491914942455:recom_history <- fread(file_name)
1491914942455:} else {
1491914942456:recom_history <- getBigQueryResult(
1491914942456:query = 'SELECT contact_id, campaign_id, email_sent_date,
1491914942457:buying_probability, buying_probability_group,
1491914942457:incentive_value, incentive_type, incentive_class, incentive_min_cart_value
1491914942457:FROM incentives.recommendation_histories_#{customer_id} WHERE customer_id = #{customer_id}',
1491914942457:debug = F,
1491914942458:project = "ems-incentives" ,
1491914942458:customer_id = getIdFromName(customer)
1491914942458:)
1491914942459:if (length(recom_history) == 0) {
1491914942459:stop("Your query returned no result.")
1491914942460:} else {
1491914942460:fwrite(recom_history, file_name)
1491914942460:message(paste(file_name, ' written.'))
1491914942461:}
1491914942461:}
1491914942461:recom_history %>%
1491914942462:.[, campaign_start_date := convertTimeToDate(email_sent_date)]
1491914942465:}
1491914945733:recom_history <- getRecomHistory(selected_customer, refetch = TRUE)
1491916033956:if (!is.null(customer_settings[[selected_customer]]$first_incentive_campaign_date)) {
1491916033957:recom_history <- recom_history[campaign_start_date >= ymd(customer_settings[[selected_customer]]$first_incentive_campaign_date)]
1491916033957:}
1491916033959:if (!is.null(customer_settings[[selected_customer]]$campaigns_to_exclude)) {
1491916033959:recom_history <- recom_history[!campaign_id %in% customer_settings[[selected_customer]]$campaigns_to_exclude]
1491916033960:}
1491916041853:recom_history
1491916044549:recom_history
1491919981543:suppressPackageStartupMessages(
1491919981545:source('global.R')
1491919981546:)
1491919983112:args = commandArgs(trailingOnly=TRUE)
1491919984288:if (length(args)==0) {
1491919984291:selected_customer <- DEFAULT_SELECTED_CUSTOMER
1491919984292:} else{
1491919984293:selected_customer <- args[1]
1491919984294:}
1491919985361:message(sprintf("Currently selected customer: %s", selected_customer))
1491919986529:load(sprintf('data/attribution_variants_%s.RData', selected_customer))
1491920777010:alpha_prior <- 0.5
1491920777549:beta_prior <- 0.5
1491920777996:lower_percentile <- 0.05
1491920778404:higher_percentile <- 0.95
1491920780379:createVariantSubtitle <- function(attribution_dt) {
1491920780380:attribution_metadata <- attr(attribution_dt, 'attribution')
1491920780380:if (attribution_metadata$source == 'hds') {
1491920780381:c('HDS')
1491920780381:}
1491920780382:}
1491920781261:createVariantSubtitle <- function(attribution_dt) {
1491920781261:num_campaigns <- sprintf('Aggregated over %d campaign(s).', length(attribution_dt[, unique(campaign_id)]))
1491920781262:attribution_metadata <- attr(attribution_dt, 'attribution')
1491920781263:if (attribution_metadata$source == 'hds') {
1491920781263:data_source <- 'Source: HDS.'
1491920781264:return(paste(num_campaigns, data_source))
1491920781264:} else {
1491920781265:if (attribution_metadata$method == 'webextend') {
1491920781265:data_source <- 'Source: SI. Attribution: Webextend.'
1491920781266:} else {
1491920781266:data_source <- sprintf('Source: SI. Attribution: time-based with %d days window.', attribution_metadata$time_window)
1491920781267:if (attribution_metadata$filter == 'none') {
1491920781268:return(paste(num_campaigns, data_source))
1491920781269:} else {
1491920781271:filter <- sprintf('Only %s emails.', attribution_metadata$filter)
1491920781272:return(paste(num_campaigns, data_source, filter))
1491920781274:}
1491920781276:}
1491920781278:}
1491920781280:}
1491920782493:createVariantFileSuffix <- function(attribution_dt) {
1491920782494:attribution_metadata <- attr(attribution_dt, 'attribution')
1491920782495:if (attribution_metadata$source == 'hds') {
1491920782495:return('hds')
1491920782496:} else {
1491920782496:if (attribution_metadata$method == 'webextend') {
1491920782497:return('si_webextend')
1491920782497:} else {
1491920782498:if (attribution_metadata$filter == 'none') {
1491920782499:return(paste(attribution_metadata[1:3], collapse = '_'))
1491920782499:} else {
1491920782500:return(paste(attribution_metadata, collapse = '_'))
1491920782500:}
1491920782501:}
1491920782502:}
1491920782504:}
1491920783787:plotPurchaseRateForSegments <- function(attribution_dt) {
1491920783788:attribution_dt[, .(.N, num_purchases = sum(num_purchases, na.rm = T)), by = incentive_class] %>%
1491920783789:.[, `:=`(
1491920783790:alpha = alpha_prior + num_purchases,
1491920783791:beta = beta_prior + N - num_purchases
1491920783792:)] %>%
1491920783793:.[, `:=`(
1491920783794:rate_lower = qbeta(lower_percentile, alpha, beta),
1491920783795:rate = alpha / (alpha + beta),
1491920783796:rate_higher = qbeta(higher_percentile, alpha, beta)
1491920783797:)] %>%
1491920783797:ggplot(aes(x = class, y = rate, fill = class)) +
1491920783798:geom_bar(stat = 'identity', position = 'dodge') +
1491920783799:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1491920783800:geom_label(aes(label = sprintf('%0.3f%%', 100*rate)), show.legend = F) +
1491920783801:geom_text(aes(y = 0, label = sprintf('N = %d\nNum.purch. = %d', N, num_purchases)), vjust = 'top') +
1491920783803:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1491920783805:labs(x = 'Segment',
1491920783807:y = "Purchase rate",
1491920783809:fill = 'Segment',
1491920783810:title = "Purchase rates in different segments",
1491920783811:subtitle = createVariantSubtitle(attribution_dt)
1491920783813:)
1491920783813:}
1491920800840:attribution_variants[[1]]
1491920817712:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491920837050:attribution_variants[[1]]
1491920855808:plotPurchaseRateForSegments <- function(attribution_dt) {
1491920855810:attribution_dt[, .(.N, num_purchases = sum(num_purchases, na.rm = T)), by = incentive_class] %>%
1491920855810:.[, `:=`(
1491920855811:alpha = alpha_prior + num_purchases,
1491920855811:beta = beta_prior + N - num_purchases
1491920855811:)] %>%
1491920855812:.[, `:=`(
1491920855812:rate_lower = qbeta(lower_percentile, alpha, beta),
1491920855813:rate = alpha / (alpha + beta),
1491920855813:rate_higher = qbeta(higher_percentile, alpha, beta)
1491920855814:)] %>%
1491920855815:ggplot(aes(x = class, y = rate, fill = incentive_class)) +
1491920855816:geom_bar(stat = 'identity', position = 'dodge') +
1491920855817:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1491920855817:geom_label(aes(label = sprintf('%0.3f%%', 100*rate)), show.legend = F) +
1491920855818:geom_text(aes(y = 0, label = sprintf('N = %d\nNum.purch. = %d', N, num_purchases)), vjust = 'top') +
1491920855819:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1491920855820:labs(x = 'Segment',
1491920855820:y = "Purchase rate",
1491920855821:fill = 'Segment',
1491920855822:title = "Purchase rates in different segments",
1491920855824:subtitle = createVariantSubtitle(attribution_dt)
1491920855825:)
1491920855826:}
1491920857952:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491920872734:plotPurchaseRateForSegments <- function(attribution_dt) {
1491920872734:attribution_dt[, .(.N, num_purchases = sum(num_purchases, na.rm = T)), by = incentive_class] %>%
1491920872735:.[, `:=`(
1491920872735:alpha = alpha_prior + num_purchases,
1491920872736:beta = beta_prior + N - num_purchases
1491920872736:)] %>%
1491920872736:.[, `:=`(
1491920872737:rate_lower = qbeta(lower_percentile, alpha, beta),
1491920872737:rate = alpha / (alpha + beta),
1491920872737:rate_higher = qbeta(higher_percentile, alpha, beta)
1491920872738:)] %>%
1491920872738:ggplot(aes(x = incentive_class, y = rate, fill = incentive_class)) +
1491920872739:geom_bar(stat = 'identity', position = 'dodge') +
1491920872740:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1491920872741:geom_label(aes(label = sprintf('%0.3f%%', 100*rate)), show.legend = F) +
1491920872741:geom_text(aes(y = 0, label = sprintf('N = %d\nNum.purch. = %d', N, num_purchases)), vjust = 'top') +
1491920872742:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1491920872742:labs(x = 'Segment',
1491920872743:y = "Purchase rate",
1491920872743:fill = 'Segment',
1491920872744:title = "Purchase rates in different segments",
1491920872744:subtitle = createVariantSubtitle(attribution_dt)
1491920872745:)
1491920872745:}
1491920874811:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491920902867:setEmsTheme()
1491920904691:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491920950291:plotRevenueForSegments <- function(attribution_dt) {
1491920950292:attribution_dt[, .(.N, sales_amount = sum(sales_amount, na.rm = T), num_purchases = sum(num_purchases, na.rm = T)), by = class] %>%
1491920950293:ggplot(aes(x = class, y = sales_amount, fill = class)) +
1491920950294:geom_bar(stat = 'identity', position = 'dodge') +
1491920950295:geom_label(aes(label = sprintf('%0.0f', sales_amount)), font_family = 'Canaro Medium', show.legend = F) +
1491920950296:geom_text(aes(y = 0, label = sprintf('Num.purch. = %d\nunit revenue = %0.1f', num_purchases, sales_amount/num_purchases)), vjust = 'top') +
1491920950297:scale_y_continuous(expand = c(0.1, 0)) +
1491920950298:labs(x = 'Segment',
1491920950299:y = "",
1491920950299:fill = 'Segment',
1491920950299:title = "Total revenue in different segments",
1491920950300:subtitle = createVariantSubtitle(attribution_dt)
1491920950300:)
1491920950301:}
1491920951916:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491921078352:plotPurchaseRateForSegments <- function(attribution_dt) {
1491921078353:attribution_dt[, .(.N, num_purchases = sum(num_purchases, na.rm = T)), by = incentive_class] %>%
1491921078355:.[, `:=`(
1491921078356:alpha = alpha_prior + num_purchases,
1491921078356:beta = beta_prior + N - num_purchases
1491921078357:)] %>%
1491921078357:.[, `:=`(
1491921078358:rate_lower = qbeta(lower_percentile, alpha, beta),
1491921078358:rate = alpha / (alpha + beta),
1491921078359:rate_higher = qbeta(higher_percentile, alpha, beta)
1491921078359:)] %>%
1491921078360:ggplot(aes(x = incentive_class, y = rate, fill = incentive_class)) +
1491921078360:geom_bar(stat = 'identity', position = 'dodge') +
1491921078360:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1491921078361:geom_label(aes(label = sprintf('%0.3f%%', 100*rate)), family = 'Canaro Medium', show.legend = F) +
1491921078361:geom_text(aes(y = 0, label = sprintf('N = %d\nNum.purch. = %d', N, num_purchases)), family = 'Canaro Medium', vjust = 'top') +
1491921078362:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1491921078363:labs(x = 'Segment',
1491921078364:y = "Purchase rate",
1491921078364:fill = 'Segment',
1491921078365:title = "Purchase rates in different segments",
1491921078365:subtitle = createVariantSubtitle(attribution_dt)
1491921078367:)
1491921078368:}
1491921079828:attribution_variants[[1]] %>% plotPurchaseRateForSegments()
1491921547702:recom_history
1491921559239:recom_history[, sum(buying_probability_group)]
1491921562933:recom_history[, summary(buying_probability_group)]
1491921609623:floor(100/25)
1491921612775:floor(99/25)
1491921616760:ceiling(99/25)
1491921619680:ceiling(23/25)
1491921667624:ceiling(23/100 * 4)
1491921670573:ceiling(26/100 * 4)
1491921673233:ceiling(66/100 * 4)
1491921684794:n_bins <- 4
1491921722534:n_bins <- 4
1491921722535:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1491921784219:recom_history
1491921797457:recom_history[, table(incentive_value)]
1491921812859:recom_history[, table(incentive_value, incentive_type, useNA = 'ifany')]
1491921932228:str_c('free_shipping', NA)
1491921939151:paste9('free_shipping', NA)
1491921941900:paste0('free_shipping', NA)
1491922015721:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1491922021966:n_bins <- 4
1491922032201:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1491922041523:recom_history <- recom_history[!is.na(buying_probability)]
1491922047796:selected_time_window <- ifelse(
1491922047797:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1491922047798:ATTRIBUTION_TIME_WINDOW,
1491922047798:customer_settings[[selected_customer]]$incentive_expiration_days
1491922047798:)
1491922047799:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1491922047799:recom_history, purchases,
1491922047799:source = 'si',
1491922047800:method = 'time',
1491922047800:time_window = selected_time_window
1491922047800:)
1491922048996:recom_history_w_attributions[, did_buy := !(is.na(num_purchases))]
1491922053385:if(balance == TRUE) {
1491922053387:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491922053387:} else {
1491922053388:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491922053388:}
1491922064390:balance <- TRUE
1491922068195:resample <- F
1491922071617:if(balance == TRUE) {
1491922071618:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491922071619:} else {
1491922071619:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491922071620:}
1491922132763:calculateBalancingWeights <- function(dt_with_class_buying_prob, comparison_class = 'control') {
1491922132764:matching_data <- dt_with_class_buying_prob[
1491922132765:incentive_class %in% c("smart", comparison_class) & is.na(buying_prob) == FALSE,
1491922132767:.(
1491922132767:contact_id,
1491922132768:campaign_id,
1491922132768:is_smart = ifelse(class == "smart", 1, 0),
1491922132768:buying_prob_category = cut(log(buying_prob), 50),
1491922132769:sales_amount = ifelse(is.na(sales_amount), 0, sales_amount)
1491922132769:)
1491922132770:]
1491922132770:p <- ggplot(data = matching_data, aes(x = buying_prob_category, fill = factor(is_smart))) +
1491922132771:geom_bar() +
1491922132771:facet_wrap(~ campaign_id, ncol = 1) +
1491922132772:scale_x_discrete('Matching category (log buying probability bin)', labels = NULL) +
1491922132772:scale_fill_discrete(guide_legend('class'), labels = c(comparison_class, 'smart'))
1491922132772:print(p)
1491922132773:m.out <- matchit(
1491922132774:is_smart ~ campaign_id + buying_prob_category,
1491922132774:data = matching_data,
1491922132775:method = "exact")
1491922132776:matching_data[, is_matched := ifelse(!is.na(m.out$subclass), "matched", "unmatched")]
1491922132777:matching_data[, table(is_matched, is_smart)] %>%
1491922132778:print()
1491922132780:matching_data[
1491922132782:,
1491922132783:.(n_purchase = sum(sales_amount > 0), sum_sales = sum(sales_amount)),
1491922132784:by = .(is_smart, is_matched)
1491922132785:] %>%
1491922132787:dcast(is_smart ~ is_matched, value.var = c("n_purchase", "sum_sales")) %>%
1491922132787:print()
1491922132789:data.table(match.data(m.out))[, .(contact_id, campaign_id, is_smart, weights)]
1491922132790:}
1491922134264:addBalancingWeights <- function(dt_with_class_buying_prob) {
1491922134265:weights <- lapply(c('control', 'static'), function(comparison) {
1491922134265:weights <- calculateBalancingWeights(dt_with_class_buying_prob, comparison)
1491922134266:list(smart = weights[is_smart == 1], comparison = weights[is_smart == 0])
1491922134267:})
1491922134267:smart <- lapply(weights, function(w) w$smart) %>% do.call(merge, .)
1491922134268:comparison <- lapply(weights, function(w) w$comparison)
1491922134269:merged_weights <- rbindlist(c(comparison, list(smart))) %>% .[, is_smart := NULL]
1491922134269:merge(dt_with_class_buying_prob, merged_weights, by = c('contact_id', 'campaign_id'), all.x = TRUE)
1491922134270:}
1491922151352:if (balance == TRUE) {
1491922151352:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491922151353:} else {
1491922151354:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491922151354:}
1491922174892:calculateBalancingWeights <- function(dt_with_class_buying_prob, comparison_class = 'control') {
1491922174893:matching_data <- dt_with_class_buying_prob[
1491922174894:incentive_class %in% c("smart", comparison_class) & is.na(buying_probability) == FALSE,
1491922174895:.(
1491922174895:contact_id,
1491922174896:campaign_id,
1491922174897:is_smart = ifelse(class == "smart", 1, 0),
1491922174898:buying_prob_category = cut(log(buying_probability), 50),
1491922174899:sales_amount = ifelse(is.na(sales_amount), 0, sales_amount)
1491922174900:)
1491922174902:]
1491922174903:p <- ggplot(data = matching_data, aes(x = buying_prob_category, fill = factor(is_smart))) +
1491922174904:geom_bar() +
1491922174905:facet_wrap(~ campaign_id, ncol = 1) +
1491922174906:scale_x_discrete('Matching category (log buying probability bin)', labels = NULL) +
1491922174907:scale_fill_discrete(guide_legend('class'), labels = c(comparison_class, 'smart'))
1491922174908:print(p)
1491922174910:m.out <- matchit(
1491922174911:is_smart ~ campaign_id + buying_prob_category,
1491922174913:data = matching_data,
1491922174914:method = "exact")
1491922174917:matching_data[, is_matched := ifelse(!is.na(m.out$subclass), "matched", "unmatched")]
1491922174918:matching_data[, table(is_matched, is_smart)] %>%
1491922174921:print()
1491922174923:matching_data[
1491922174926:,
1491922174928:.(n_purchase = sum(sales_amount > 0), sum_sales = sum(sales_amount)),
1491922174930:by = .(is_smart, is_matched)
1491922174932:] %>%
1491922174933:dcast(is_smart ~ is_matched, value.var = c("n_purchase", "sum_sales")) %>%
1491922174935:print()
1491922174939:data.table(match.data(m.out))[, .(contact_id, campaign_id, is_smart, weights)]
1491922174942:}
1491922177439:if (balance == TRUE) {
1491922177439:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491922177440:} else {
1491922177440:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491922177441:}
1491922196129:calculateBalancingWeights <- function(dt_with_class_buying_prob, comparison_class = 'control') {
1491922196130:matching_data <- dt_with_class_buying_prob[
1491922196131:incentive_class %in% c("smart", comparison_class) & is.na(buying_probability) == FALSE,
1491922196131:.(
1491922196132:contact_id,
1491922196133:campaign_id,
1491922196133:is_smart = ifelse(incentive_class == "smart", 1, 0),
1491922196134:buying_prob_category = cut(log(buying_probability), 50),
1491922196135:sales_amount = ifelse(is.na(sales_amount), 0, sales_amount)
1491922196136:)
1491922196137:]
1491922196138:p <- ggplot(data = matching_data, aes(x = buying_prob_category, fill = factor(is_smart))) +
1491922196138:geom_bar() +
1491922196139:facet_wrap(~ campaign_id, ncol = 1) +
1491922196139:scale_x_discrete('Matching category (log buying probability bin)', labels = NULL) +
1491922196140:scale_fill_discrete(guide_legend('class'), labels = c(comparison_class, 'smart'))
1491922196140:print(p)
1491922196141:m.out <- matchit(
1491922196142:is_smart ~ campaign_id + buying_prob_category,
1491922196143:data = matching_data,
1491922196143:method = "exact")
1491922196144:matching_data[, is_matched := ifelse(!is.na(m.out$subclass), "matched", "unmatched")]
1491922196145:matching_data[, table(is_matched, is_smart)] %>%
1491922196146:print()
1491922196147:matching_data[
1491922196148:,
1491922196148:.(n_purchase = sum(sales_amount > 0), sum_sales = sum(sales_amount)),
1491922196149:by = .(is_smart, is_matched)
1491922196150:] %>%
1491922196150:dcast(is_smart ~ is_matched, value.var = c("n_purchase", "sum_sales")) %>%
1491922196151:print()
1491922196152:data.table(match.data(m.out))[, .(contact_id, campaign_id, is_smart, weights)]
1491922196154:}
1491922198395:if (balance == TRUE) {
1491922198395:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491922198396:} else {
1491922198396:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491922198397:}
1491922354881:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1491922354882:dcast(campaign_id + campaign_start_date ~ incentive_class)
1491922355003:recom_history_w_attributions[, table(incentive_class, incentive_type, useNA = 'ifany')]
1491922355195:recom_history_w_attributions[, table(incentive_class, incentive_value, useNA = 'ifany')]
1491922355457:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_value)] %>%
1491922355458:dcast(campaign_id ~ incentive_value)
1491922355522:recom_history_w_attributions[, .N, by = .(prob_group, incentive_value)] %>%
1491922355522:dcast(prob_group ~ incentive_value)
1491922374780:recom_history_w_attributions[,
1491922374780:.(rate = mean(weights*did_open, na.rm = TRUE)),
1491922374781:by = .(campaign_start_date, incentive_class)
1491922374782:] %>%
1491922374782:plotRatesByCampaigns(label = 'Open rate')
1491922423150:recom_history_w_attributions[,
1491922423151:.(rate = mean(weights*did_open, na.rm = TRUE)),
1491922423152:by = .(campaign_start_date, incentive_class)
1491922423153:]
1491922434852:recom_history_w_attributions[,
1491922434852:.(rate = mean(weights*did_open, na.rm = TRUE)),
1491922434853:by = .(campaign_start_date, incentive_class)
1491922434853:] %>%
1491922434854:plotRatesByCampaigns(label = 'Open rate')
1491922448902:plotRatesByCampaigns <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1491922448902:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1491922448903:geom_line(aes_string(color = color_var), size = 2) +
1491922448903:scale_y_continuous(limits = c(0, NA), label = scales::percent) +
1491922448904:labs(
1491922448904:title = paste0(label, "s in different campaigns"),
1491922448905:x = 'Campaign date',
1491922448905:y = label,
1491922448906:color = 'Segment'
1491922448906:) +
1491922448906:theme_bw() +
1491922448907:theme(legend.position = 'top')
1491922448907:}
1491922451567:recom_history_w_attributions[,
1491922451568:.(rate = mean(weights*did_open, na.rm = TRUE)),
1491922451568:by = .(campaign_start_date, incentive_class)
1491922451569:] %>%
1491922451569:plotRatesByCampaigns(label = 'Open rate')
1491922456507:plotRatesBySegments <- function(rate_by_segments, label, by_prob_group = FALSE, by_numericValue = FALSE) {
1491922456508:p <- ggplot(rate_by_segments, aes(x = incentive_class, y = rate, fill = incentive_class)) +
1491922456509:geom_bar(stat = 'identity', position = 'dodge') +
1491922456510:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1491922456510:geom_label(aes(label = scales::percent(signif(rate*100, 2)/100)), family = 'Canaro Medium') +
1491922456511:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1491922456512:theme(legend.position = 'none')
1491922456513:title_label <- paste0(label, "s in different segments")
1491922456513:if (by_prob_group) {
1491922456514:p <- p + facet_wrap(~ prob_group, nrow = 1)
1491922456515:title_label <- paste0(title_label, ", by buying prob groups")
1491922456516:}
1491922456518:if (by_numericValue) {
1491922456519:p <- p + facet_wrap(~ numericValue, nrow = 1)
1491922456519:title_label <- paste0(title_label, ", by discount value")
1491922456520:}
1491922456520:p + labs(
1491922456521:x = 'Segment',
1491922456522:y = label,
1491922456523:title = title_label
1491922456523:)
1491922456524:}
1491922463353:recom_history_w_attributions %>%
1491922463354:calculateRateWithErrors(variable = 'did_open') %>%
1491922463355:plotRatesBySegments(label = 'Open rate')
1491922470632:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_value = FALSE) {
1491922470633:if (by_prob_group) {
1491922470633:by_var = c('incentive_class', 'prob_group')
1491922470634:} else if (by_incentive_value) {
1491922470635:by_var = c('incentive_class', 'incentive_value')
1491922470635:}  else {
1491922470636:by_var = 'incentive_class'
1491922470636:}
1491922470637:history %>%
1491922470637:.[, .(.N, num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1491922470638:.[, `:=`(
1491922470639:alpha = alpha_prior + num_variable,
1491922470639:beta = beta_prior + N - num_variable
1491922470640:)] %>%
1491922470640:.[, `:=`(
1491922470641:rate_lower = qbeta(error, alpha, beta),
1491922470641:rate = alpha / (alpha + beta),
1491922470642:rate_higher = qbeta(1 - error, alpha, beta)
1491922470642:)]
1491922470643:}
1491922473683:recom_history_w_attributions %>%
1491922473684:calculateRateWithErrors(variable = 'did_open') %>%
1491922473685:plotRatesBySegments(label = 'Open rate')
1491922830337:source('global.R')
1491922839733:rm(recom_history_w_attributions)
1491922842157:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1491922842157:recom_history, purchases,
1491922842158:source = 'si',
1491922842158:method = 'time',
1491922842159:time_window = selected_time_window
1491922842160:)
1491922853822:names(recom_history_w_attributions)
1491922870790:recom_history_w_attributions %>%
1491922870791:.[did_click == TRUE] %>%
1491922870791:calculateRateWithErrors(variable = 'did_buy') %>%
1491922870792:plotRatesBySegments(label = 'Purchase rate')
1491922886549:recom_history_w_attributions[, weights:=1]
1491922889387:recom_history_w_attributions %>%
1491922889388:.[did_click == TRUE] %>%
1491922889388:calculateRateWithErrors(variable = 'did_buy') %>%
1491922889389:plotRatesBySegments(label = 'Purchase rate')
1491923013036:recom_history[, incentive_content := ifelse(incentive_type == 'free_shipping', incentive_type, str_c(incentive_type, incentive_value))]
1491923022604:recom_history[, incentive_content := ifelse(incentive_type == 'free_shipping', incentive_type, paste0(incentive_type, incentive_value))]
1491923037806:recom_history[, table(incentive_content, useNA = 'ifany')]
1491923044485:recom_history[, table(incentive_class, incentive_content, useNA = 'ifany')]
1491923102380:useNA = 'ifany')]
1491988098365:balance
1491988109328:recom_history_w_attributions[, summary(weights)]
1491988114521:if (balance == TRUE) {
1491988114522:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491988114522:} else {
1491988114523:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1491988114523:}
1491988425859:recom_history_w_attributions
1491988436830:recom_history_w_attributions[, .N, by = prob_group]
1491988447898:recom_history_w_attributions[, .N, by = .(prob_group, incentive_class)]
1491988457415:recom_history_w_attributions[, .N, by = .(prob_group, incentive_class)] %>% dcast(incentive_class ~ N)
1491988473046:recom_history_w_attributions[, .N, by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988490944:recom_history_w_attributions[, mean(weight), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988496495:recom_history_w_attributions[, mean(weights), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988506017:recom_history_w_attributions[!is.na(prob_group), mean(weights), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988521082:recom_history_w_attributions[, mean(weights, na.rm = TRUE), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988532524:warnings()
1491988547842:recom_history_w_attributions[, weights] %>% head()
1491988556859:recom_history_w_attributions %>% names()
1491988599887:recom_history_w_attributions[, weights.x := NULL]
1491988602676:recom_history_w_attributions[, weights.y := NULL]
1491988622030:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1491988753836:recom_history_w_attributions[!is.na(prob_group), mean(weights), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988763482:recom_history_w_attributions[, mean(weights, na.rm = TRUE), by = .(prob_group, incentive_class)] %>% dcast(prob_group ~ incentive_class)
1491988857715:recom_history_w_attributions[, mean(weights, na.rm = TRUE), by = .(incentive_class)]
1491993832985:recom_history_w_attributions[,
1491993832987:.(rate = mean(weights*did_open, na.rm = TRUE)),
1491993832988:by = .(campaign_start_date, incentive_class)
1491993832988:] %>%
1491993832989:plotRatesByCampaigns(label = 'Open rate')
1491993840710:recom_history_w_attributions %>%
1491993840710:calculateRateWithErrors(variable = 'did_open') %>%
1491993840711:plotRatesBySegments(label = 'Open rate')
1491993850224:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_content = FALSE) {
1491993850225:if (by_prob_group) {
1491993850226:by_var = c('incentive_class', 'prob_group')
1491993850226:} else if (by_incentive_content) {
1491993850227:by_var = c('incentive_class', 'incentive_content')
1491993850227:}  else {
1491993850227:by_var = 'incentive_class'
1491993850228:}
1491993850228:history %>%
1491993850228:.[, .(N = sum(weights), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1491993850229:.[, `:=`(
1491993850229:alpha = alpha_prior + num_variable,
1491993850230:beta = beta_prior + N - num_variable
1491993850230:)] %>%
1491993850231:.[, `:=`(
1491993850233:rate_lower = qbeta(error, alpha, beta),
1491993850234:rate = alpha / (alpha + beta),
1491993850234:rate_higher = qbeta(1 - error, alpha, beta)
1491993850235:)]
1491993850236:}
1491993855796:recom_history_w_attributions %>%
1491993855796:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE) %>%
1491993855797:plotRatesBySegments(label = 'Open rate', by_prob_group = TRUE)
1491993866411:recom_history_w_attributions %>%
1491993866412:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE)
1491993870441:recom_history_w_attributions %>%
1491993870442:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE) %>% .[]
1491994550422:recom_history_w_attributions[, .(.N, sum = sum(weights), num = sum(num_purchases*weights)), by = .(incentive_class, prob_group))]
1491994552660:recom_history_w_attributions[, .(.N, sum = sum(weights), num = sum(num_purchases*weights)), by = .(incentive_class, prob_group)]
1491994566967:recom_history_w_attributions[, .(.N, sum = sum(weights, na.rm = T), num = sum(num_purchases*weights, na.rm = T)), by = .(incentive_class, prob_group)]
1491994585943:recom_history_w_attributions[, .(.N, sum = sum(weights, na.rm = T), num = sum(num_purchases*weights, na.rm = T)), by = .(incentive_class, prob_group)]
1491994601207:recom_history_w_attributions[!is.na(prob_group) & is.na(weights)]
1491994614357:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_content = FALSE) {
1491994614358:if (by_prob_group) {
1491994614358:by_var = c('incentive_class', 'prob_group')
1491994614359:} else if (by_incentive_content) {
1491994614359:by_var = c('incentive_class', 'incentive_content')
1491994614360:}  else {
1491994614360:by_var = 'incentive_class'
1491994614360:}
1491994614361:history %>%
1491994614361:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1491994614361:.[, `:=`(
1491994614362:alpha = alpha_prior + num_variable,
1491994614362:beta = beta_prior + N - num_variable
1491994614363:)] %>%
1491994614363:.[, `:=`(
1491994614364:rate_lower = qbeta(error, alpha, beta),
1491994614366:rate = alpha / (alpha + beta),
1491994614367:rate_higher = qbeta(1 - error, alpha, beta)
1491994614368:)]
1491994614370:}
1491994620736:recom_history_w_attributions %>%
1491994620737:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE) %>% .[]
1491994793366:recom_history_w_attributions %>%
1491994793366:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE) %>%
1491994793367:plotRatesBySegments(label = 'Open rate', by_prob_group = TRUE)
1491998967868:scales::percent(signif(0.1412*100, 2)/100))
1491998971062:scales::percent(signif(0.1412*100, 2)/100)
1491998985638:scales::percent(signif(0.1412*100, 2)/100)
1491998989366:scales::percent(signif(0.1412*100, 4)/100)
1491998994917:scales::percent(signif(0.141215*100, 4)/100)
1491999015598:rates <- c(0.141234, 0.01234, 0.001234, 0.0001234)
1491999021087:scales::percent(signif(rates*100, 4)/100)
1491999029746:scales::percent(signif(rates*100, 2)/100)
1491999034319:scales::percent(signif(rates*10000, 2)/100)
1491999036969:scales::percent(signif(rates*10000, 2)/10000)
1491999040119:scales::percent(signif(rates*10000, 4)/10000)
1491999044808:?sifnif
1491999046799:?signif
1491999071269:scales::percent(signif(rates*10000, digits = 2)/10000)
1491999076488:scales::percent(signif(rates*100, digits = 2)/100)
1491999089242:getOption('digits')
1491999096879:scales::percent(signif(rates*100, digits = 4)/100)
1491999105874:signif(rates*100, digits = 4)/100
1491999111738:signif(rates*100, digits = 2)/100
1491999128249:signif(rates*100, digits = 2)
1491999135816:signif(rates*100)
1491999143603:signif(rates*100, digits = 2)
1491999162092:round(rates*100, digits = 2)
1491999183317:round(rates*100, digits = 2)
1491999186086:rates
1491999199750:round(rates*100, digits = 2)
1491999321755:sprintf("%.0f%%", rates*100)
1491999326211:sprintf("%.2f%%", rates*100)
1491999330648:sprintf("%.3f%%", rates*100)
1491999370127:rates
1491999380150:rates*100 - floor(rates*100)
1491999393360:signif(rates*100 - floor(rates*100), digits = 2)
1491999403631:signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100)
1491999415072:scales::percent(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100))
1491999426783:?scales::percent
1491999430887:?scales::percent_format
1491999441616:?prettyNum
1491999475832:prettyNum(rates)
1491999486275:prettyNum(rates, digits = 2)
1491999492290:prettyNum(rates*100, digits = 2)
1491999500161:prettyNum(rates*100, digits = 3)
1491999523163:prettyNum(rates*100, digits = 3, format = 'g')
1491999532935:prettyNum(rates*100, digits = 3, format = 'fg')
1491999564602:sprintf(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100))
1491999567325:sprintf(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100))
1491999572630:(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100))
1491999581582:paste0(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100)), '%')
1491999589730:paste0(c(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100)), '%'))
1491999595327:paste0(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100))
1491999620800:sapply(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100), paste0)
1491999626183:sapply(signif(rates*100 - floor(rates*100), digits = 2) + floor(rates*100), paste0, y = '%')
1491999723473:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_content = FALSE) {
1491999723474:if (by_prob_group) {
1491999723475:by_var = c('incentive_class', 'prob_group')
1491999723475:} else if (by_incentive_content) {
1491999723476:by_var = c('incentive_class', 'incentive_content')
1491999723476:}  else {
1491999723477:by_var = 'incentive_class'
1491999723477:}
1491999723478:history %>%
1491999723479:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1491999723479:.[, `:=`(
1491999723481:alpha = alpha_prior + num_variable,
1491999723483:beta = beta_prior + N - num_variable
1491999723485:)] %>%
1491999723486:.[, `:=`(
1491999723487:rate_lower = qbeta(error, alpha, beta),
1491999723489:rate = alpha / (alpha + beta),
1491999723492:rate_higher = qbeta(1 - error, alpha, beta)
1491999723493:)]
1491999723494:}
1491999724239:formatPercent <- function(numbers, digits = 2) {
1491999724240:sapply(signif(numbers*100 - floor(numbers*100), digits) + floor(numbers*100), paste0, y = '%')
1491999724241:}
1491999725021:plotRatesByCampaigns <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1491999725022:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1491999725023:geom_line(aes_string(color = color_var), size = 2) +
1491999725023:scale_y_continuous(limits = c(0, NA), label = scales::percent) +
1491999725024:labs(
1491999725025:title = paste0(label, "s in different campaigns"),
1491999725025:x = 'Campaign date',
1491999725026:y = label,
1491999725026:color = 'Segment'
1491999725027:) +
1491999725028:theme_bw() +
1491999725028:theme(legend.position = 'top')
1491999725028:}
1491999731640:recom_history_w_attributions %>%
1491999731641:calculateRateWithErrors(variable = 'did_buy') %>%
1491999731641:plotRatesBySegments(label = 'Purchase rate')
1491999771450:formatPercent <- function(numbers, digits = 3) {
1491999771451:sapply(signif(numbers*100 - floor(numbers*100), digits) + floor(numbers*100), paste0, y = '%')
1491999771452:}
1491999774643:recom_history_w_attributions %>%
1491999774644:calculateRateWithErrors(variable = 'did_buy') %>%
1491999774645:plotRatesBySegments(label = 'Purchase rate')
1491999787082:recom_history_w_attributions %>%
1491999787082:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1491999787084:plotRatesBySegments(label = 'Purchase rate', by_prob_group = TRUE)
1491999842226:formatPercent <- function(numbers, digits = 2) {
1491999842227:sapply(signif(numbers*100 - floor(numbers*100), digits) + floor(numbers*100), paste0, y = '%')
1491999842227:}
1491999845158:recom_history_w_attributions %>%
1491999845159:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1491999845159:plotRatesBySegments(label = 'Purchase rate', by_prob_group = TRUE)
1491999910720:recom_history_w_attributions %>%
1491999910721:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>% .[]
1492000032002:recom_history_w_attributions %>%
1492000032003:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>% .[, formatPercent(rate)]
1492000039213:recom_history_w_attributions %>%
1492000039214:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>% .[, .(rate, formatPercent(rate))]
1492000151751:recom_history_w_attributions %>%
1492000151751:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>% .[, .(rate, formatPercent(rate, 3))]
1492002653009:plotRatesBySegments <- function(rate_by_segments, label, by_prob_group = FALSE, by_numericValue = FALSE) {
1492002667741:plotRatesBySegments <- function(rate_by_segments, label, by_prob_group = FALSE, by_numericValue = FALSE) {
1492002667742:p <- ggplot(rate_by_segments, aes(x = incentive_class, y = rate, fill = incentive_class)) +
1492002667743:geom_bar(stat = 'identity', position = 'dodge') +
1492002667743:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1492002667744:geom_label(aes(label = scales::percent(rate)), family = 'Canaro Medium') +
1492002667744:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1492002667745:theme(legend.position = 'none')
1492002667746:title_label <- paste0(label, "s in different segments")
1492002667747:if (by_prob_group) {
1492002667749:p <- p + facet_wrap(~ prob_group, nrow = 1)
1492002667749:title_label <- paste0(title_label, ", by buying prob groups")
1492002667750:}
1492002667751:if (by_numericValue) {
1492002667752:p <- p + facet_wrap(~ numericValue, nrow = 1)
1492002667752:title_label <- paste0(title_label, ", by discount value")
1492002667753:}
1492002667754:p + labs(
1492002667755:x = 'Segment',
1492002667755:y = label,
1492002667756:title = title_label
1492002667756:)
1492002667757:}
1492002673076:recom_history_w_attributions %>%
1492002673076:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>% .[]
1492002673305:plotRatesBySegments(label = 'Purchase rate', by_prob_group = TRUE)
1492002684189:recom_history_w_attributions %>%
1492002684189:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1492002684190:plotRatesBySegments(label = 'Purchase rate', by_prob_group = TRUE)
1492002715357:recom_history_w_attributions %>%
1492002715358:.[did_click == TRUE] %>%
1492002715358:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1492002715359:plotRatesBySegments(label = 'Purchase rate', by_prob_group = TRUE)
1492002752664:recom_history_w_attributions %>%
1492002752665:.[did_open == TRUE] %>%
1492002752666:calculateRateWithErrors(variable = 'did_click', by_prob_group = TRUE) %>%
1492002752667:plotRatesBySegments(label = 'Click-through rate', by_prob_group = TRUE)
1492002775727:recom_history_w_attributions[,
1492002775728:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1492002775729:by = .(campaign_start_date, incentive_class)
1492002775729:] %>%
1492002775729:plotRatesByCampaigns(label = 'Purchase rate')
1492002781079:recom_history_w_attributions %>%
1492002781080:calculateRateWithErrors(variable = 'did_buy') %>%
1492002781080:plotRatesBySegments(label = 'Purchase rate')
1492003138761:plotRates <- function(rate_by_segments) {
1492003138762:ggplot(rate_by_segments, aes(x = incentive_class, y = rate, fill = incentive_class)) +
1492003138763:geom_bar(stat = 'identity', position = 'dodge') +
1492003138763:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1492003138764:geom_label(aes(label = scales::percent(rate)), family = 'Canaro Medium') +
1492003138764:scale_y_continuous(expand = c(0.1, 0), labels = scales::percent) +
1492003138765:theme(legend.position = 'none')
1492003138766:}
1492003138769:plotSums <- function(sum_by_segments) {
1492003138770:ggplot(sum_by_segments, aes(x = incentive_class, y = sum, fill = incentive_class)) +
1492003138770:geom_bar(stat = 'identity', position = 'dodge') +
1492003138771:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1492003138772:scale_y_continuous(expand = c(0.1, 0)) +
1492003138772:theme(legend.position = 'none')
1492003138772:}
1492003138774:plotBy <- function(plot, label, by_prob_group = FALSE, by_incentive_value = FALSE) {
1492003138774:title_label <- paste(label, "in different segments")
1492003138774:if (by_prob_group) {
1492003138775:plot <- plot + facet_wrap(~ prob_group, nrow = 1)
1492003138775:title_label <- paste0(title_label, ", by buying prob groups")
1492003138775:}
1492003138776:if (by_incentive_value) {
1492003138776:plot <- plot + facet_wrap(~ incentive_value, nrow = 1)
1492003138777:title_label <- paste0(title_label, ", by incentive")
1492003138777:}
1492003138777:plot + labs(
1492003138778:x = 'Segment',
1492003138778:y = label,
1492003138779:title = title_label
1492003138780:)
1492003138780:}
1492003160414:recom_history_w_attributions %>%
1492003160414:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1492003160415:plotRates() %>%
1492003160416:plotBy(label = 'Purchase rate', by_prob_group = TRUE)
1492003183431:recom_history_w_attributions %>%
1492003183432:calculateRateWithErrors(variable = 'did_buy') %>%
1492003183433:plotRates() %>%
1492003183433:plotBy(label = 'Purchase rate')
1492004555521:recom_history_w_attributions[,
1492004555523:.(rate = mean(weights*did_open, na.rm = TRUE)),
1492004555523:by = .(campaign_start_date, incentive_class)
1492004555523:] %>%
1492004555524:plotRatesByCampaigns(label = 'Open rate')
1492004561106:recom_history_w_attributions %>%
1492004561106:calculateRateWithErrors(variable = 'did_open') %>%
1492004561107:plotRates() %>%
1492004561107:plotBy(label = 'Open rate')
1492004566865:recom_history_w_attributions %>%
1492004566866:calculateRateWithErrors(variable = 'did_open', by_prob_group = TRUE) %>%
1492004566867:plotRates() %>%
1492004566868:plotBy(label = 'Open rate', by_prob_group = TRUE)
1492004576007:recom_history_w_attributions %>%
1492004576008:.[did_open == TRUE] %>%
1492004576009:calculateRateWithErrors(variable = 'did_click') %>%
1492004576009:plotRates() %>%
1492004576009:plotBy(label = 'Click-through rate')
1492004582919:recom_history_w_attributions %>%
1492004582920:.[did_open == TRUE] %>%
1492004582921:calculateRateWithErrors(variable = 'did_click', by_prob_group = TRUE) %>%
1492004582922:plotRates() %>%
1492004582922:plotBy(label = 'Click-through rate', by_prob_group = TRUE)
1492004597279:recom_history_w_attributions %>%
1492004597281:.[did_open == TRUE] %>%
1492004597282:calculateRateWithErrors(variable = 'did_click') %>%
1492004597282:plotRates() %>%
1492004597282:plotBy(label = 'Click-through rate')
1492004604737:recom_history_w_attributions %>%
1492004604738:.[did_open == TRUE] %>%
1492004604739:calculateRateWithErrors(variable = 'did_click', by_prob_group = TRUE) %>%
1492004604739:plotRates() %>%
1492004604740:plotBy(label = 'Click-through rate', by_prob_group = TRUE)
1492004620530:if (exists('predict_data')) {
1492004620530:recom_history_w_visits %>%
1492004620531:calculateRateWithErrors(variable = 'num_visit') %>%
1492004620531:plotRates() %>%
1492004620532:plotBy(label = 'Web visit rate')
1492004620532:}
1492004626340:if (exists('predict_data')) {
1492004626341:recom_history_w_visits %>%
1492004626342:calculateRateWithErrors(variable = 'num_visit', by_prob_group = TRUE) %>%
1492004626342:plotRates() %>%
1492004626343:plotBy(label = 'Web visit rate', by_prob_group = TRUE)
1492004626343:}
1492004631447:recom_history_w_attributions[
1492004631448:did_click == TRUE,
1492004631448:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1492004631449:by = .(campaign_start_date, incentive_class)
1492004631449:] %>%
1492004631449:plotRatesByCampaigns(label = 'Purchase rate')
1492004636525:recom_history_w_attributions %>%
1492004636526:.[did_click == TRUE] %>%
1492004636527:calculateRateWithErrors(variable = 'did_buy') %>%
1492004636528:plotRates() %>%
1492004636529:plotBy(label = 'Purchase rate')
1492004639921:recom_history_w_attributions %>%
1492004639922:.[did_click == TRUE] %>%
1492004639923:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1492004639923:plotRates() %>%
1492004639924:plotBy(label = 'Purchase rate', by_prob_group = TRUE)
1492004645558:recom_history_w_attributions[
1492004645558:did_open == TRUE,
1492004645560:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1492004645560:by = .(campaign_start_date, incentive_class)
1492004645561:] %>%
1492004645561:plotRatesByCampaigns(label = 'Purchase rate')
1492004649310:recom_history_w_attributions %>%
1492004649311:.[did_open == TRUE] %>%
1492004649312:calculateRateWithErrors(variable = 'did_buy') %>%
1492004649312:plotRates() %>%
1492004649312:plotBy(label = 'Purchase rate')
1492004652910:recom_history_w_attributions %>%
1492004652911:.[did_open == TRUE] %>%
1492004652912:calculateRateWithErrors(variable = 'did_buy', by_prob_group = TRUE) %>%
1492004652912:plotRates() %>%
1492004652912:plotBy(label = 'Purchase rate', by_prob_group = TRUE)
1492004656707:recom_history_w_attributions[,
1492004656708:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1492004656708:by = .(campaign_start_date, incentive_class)
1492004656709:] %>%
1492004656709:plotRatesByCampaigns(label = 'Purchase rate')
1492004723151:recom_history_w_attributions[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)]
1492004774144:recom_history_w_attributions %>%
1492004774144:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492004774145:plotSums() %>%
1492004774146:plotBy(label = 'Total revenue', by_prob_group = TRUE)
1492004785338:recom_history_w_attributions %>%
1492004785339:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1492004785340:plotSums() %>%
1492004785340:plotBy(label = 'Total revenue', by_prob_group = TRUE)
1492004805052:recom_history_w_attributions %>%
1492004805054:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492004805054:plotSums() %>%
1492004805055:plotBy(label = 'Total revenue')
1492004889720:recom_history_w_attributions %>%
1492004889721:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1492004889722:plotSums() %>%
1492004889722:plotBy(label = 'Revenue per person', by_prob_group = TRUE)
1492004915301:recom_history_w_attributions %>%
1492004915302:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492004915302:plotSums() %>%
1492004915303:plotBy(label = 'Revenue per person')
1492004950662:recom_history_w_attributions %>%
1492004950662:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492004950663:plotRatesByCampaigns(label = 'Total revenue')
1492005093817:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_content = FALSE) {
1492005093817:if (by_prob_group) {
1492005093818:by_var = c('incentive_class', 'prob_group')
1492005093819:} else if (by_incentive_content) {
1492005093819:by_var = c('incentive_class', 'incentive_content')
1492005093819:}  else {
1492005093820:by_var = 'incentive_class'
1492005093820:}
1492005093820:history %>%
1492005093821:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1492005093821:.[, `:=`(
1492005093822:alpha = alpha_prior + num_variable,
1492005093822:beta = beta_prior + N - num_variable
1492005093823:)] %>%
1492005093824:.[, `:=`(
1492005093825:rate_lower = qbeta(error, alpha, beta),
1492005093825:rate = alpha / (alpha + beta),
1492005093826:rate_higher = qbeta(1 - error, alpha, beta)
1492005093826:)]
1492005093827:}
1492005093828:plotLineBy <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1492005093828:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1492005093829:geom_line(aes_string(color = color_var), size = 2) +
1492005093829:scale_y_continuous(limits = c(0, NA), label = scales::percent) +
1492005093830:labs(
1492005093830:title = paste0(label, "s in different campaigns"),
1492005093831:x = 'Campaign date',
1492005093831:y = label,
1492005093832:color = 'Segment'
1492005093832:) +
1492005093833:theme(legend.position = 'top')
1492005093833:}
1492005093834:plotRates <- function(rate_by_segments) {
1492005093834:ggplot(rate_by_segments, aes(x = incentive_class, y = rate, fill = incentive_class)) +
1492005093835:geom_bar(stat = 'identity', position = 'dodge') +
1492005093835:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1492005093836:geom_label(aes(label = scales::percent(rate)), family = 'Canaro Medium') +
1492005093837:scale_y_continuous(limits = c(0, NA), labels = scales::percent) +
1492005093837:theme(legend.position = 'none')
1492005093838:}
1492005093840:plotSums <- function(sum_by_segments) {
1492005093840:ggplot(sum_by_segments, aes(x = incentive_class, y = sum, fill = incentive_class)) +
1492005093841:geom_bar(stat = 'identity', position = 'dodge') +
1492005093841:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1492005093842:scale_y_continuous(limits = c(0, NA)) +
1492005093842:theme(legend.position = 'none')
1492005093843:}
1492005093844:plotBy <- function(plot, label, by_prob_group = FALSE, by_incentive_value = FALSE) {
1492005093844:title_label <- paste(label, "in different segments")
1492005093844:if (by_prob_group) {
1492005093845:plot <- plot + facet_wrap(~ prob_group, nrow = 1)
1492005093845:title_label <- paste0(title_label, ", by buying prob groups")
1492005093846:}
1492005093846:if (by_incentive_value) {
1492005093846:plot <- plot + facet_wrap(~ incentive_value, nrow = 1)
1492005093847:title_label <- paste0(title_label, ", by incentive")
1492005093847:}
1492005093848:plot + labs(
1492005093848:x = 'Segment',
1492005093849:y = label,
1492005093849:title = title_label
1492005093850:)
1492005093850:}
1492005098414:recom_history_w_attributions[
1492005098415:did_open == TRUE,
1492005098415:.(rate = mean(weights*did_click)),
1492005098416:by = .(campaign_start_date, incentive_class)
1492005098416:] %>%
1492005098416:plotLineBy(label = 'Click-through rate')
1492005108594:recom_history_w_attributions[
1492005108595:did_open == TRUE,
1492005108596:.(rate = mean(weights*did_click)),
1492005108596:by = .(campaign_start_date, incentive_class)
1492005108597:]
1492005131118:recom_history_w_attributions[
1492005131119:did_open == TRUE,
1492005131120:.(rate = mean(weights*did_click, na.rm = TRUE)),
1492005131120:by = .(campaign_start_date, incentive_class)
1492005131120:] %>%
1492005131121:plotLineBy(label = 'Click-through rate')
1492005170865:recom_history_w_attributions[,
1492005170867:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1492005170867:by = .(campaign_start_date, incentive_class)
1492005170867:] %>%
1492005170868:plotLineBy(label = 'Purchase rate')
1492005182584:recom_history_w_attributions %>%
1492005182584:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005182587:plotLineBy(label = 'Total revenue')
1492005287896:calculateRateWithErrors <- function(history, variable, alpha_prior = 0.5, beta_prior = 0.5, error = 0.05, by_prob_group = FALSE, by_incentive_content = FALSE) {
1492005287897:if (by_prob_group) {
1492005287898:by_var = c('incentive_class', 'prob_group')
1492005287899:} else if (by_incentive_content) {
1492005287900:by_var = c('incentive_class', 'incentive_content')
1492005287901:}  else {
1492005287902:by_var = 'incentive_class'
1492005287903:}
1492005287905:history %>%
1492005287906:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by_var] %>%
1492005287906:.[, `:=`(
1492005287907:alpha = alpha_prior + num_variable,
1492005287907:beta = beta_prior + N - num_variable
1492005287908:)] %>%
1492005287908:.[, `:=`(
1492005287909:rate_lower = qbeta(error, alpha, beta),
1492005287909:rate = alpha / (alpha + beta),
1492005287910:rate_higher = qbeta(1 - error, alpha, beta)
1492005287911:)]
1492005287911:}
1492005287912:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1492005287913:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1492005287914:geom_line(aes_string(color = color_var), size = 2) +
1492005287915:scale_y_continuous(limits = c(0, NA), label = scales::percent) +
1492005287916:labs(
1492005287916:title = paste0(label, "s in different campaigns"),
1492005287917:x = 'Campaign date',
1492005287917:y = label,
1492005287918:color = 'Segment'
1492005287918:) +
1492005287919:theme(legend.position = 'top')
1492005287919:}
1492005287920:plotSumLineByCampaign <- function(sum_by_campaigns, label, color_var = 'incentive_class') {
1492005287921:ggplot(sum_by_campaigns, aes(x = campaign_start_date, y = sum)) +
1492005287921:geom_line(aes_string(color = color_var), size = 2) +
1492005287921:scale_y_continuous(limits = c(0, NA)) +
1492005287922:labs(
1492005287922:title = paste0(label, "s in different campaigns"),
1492005287922:x = 'Campaign date',
1492005287923:y = label,
1492005287923:color = 'Segment'
1492005287924:) +
1492005287924:theme(legend.position = 'top')
1492005287924:}
1492005287925:plotRates <- function(rate_by_segments) {
1492005287925:ggplot(rate_by_segments, aes(x = incentive_class, y = rate, fill = incentive_class)) +
1492005287926:geom_bar(stat = 'identity', position = 'dodge') +
1492005287927:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher)) +
1492005287927:geom_label(aes(label = scales::percent(rate)), family = 'Canaro Medium') +
1492005287928:scale_y_continuous(limits = c(0, NA), labels = scales::percent) +
1492005287928:theme(legend.position = 'none')
1492005287929:}
1492005287930:plotSums <- function(sum_by_segments) {
1492005287930:ggplot(sum_by_segments, aes(x = incentive_class, y = sum, fill = incentive_class)) +
1492005287931:geom_bar(stat = 'identity', position = 'dodge') +
1492005287931:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1492005287932:scale_y_continuous(limits = c(0, NA)) +
1492005287932:theme(legend.position = 'none')
1492005287933:}
1492005287934:plotBy <- function(plot, label, by_prob_group = FALSE, by_incentive_value = FALSE) {
1492005287934:title_label <- paste(label, "in different segments")
1492005287934:if (by_prob_group) {
1492005287935:plot <- plot + facet_wrap(~ prob_group, nrow = 1)
1492005287935:title_label <- paste0(title_label, ", by buying prob groups")
1492005287935:}
1492005287936:if (by_incentive_value) {
1492005287936:plot <- plot + facet_wrap(~ incentive_value, nrow = 1)
1492005287937:title_label <- paste0(title_label, ", by incentive")
1492005287937:}
1492005287938:plot + labs(
1492005287938:x = 'Segment',
1492005287939:y = label,
1492005287939:title = title_label
1492005287940:)
1492005287941:}
1492005293038:recom_history_w_attributions %>%
1492005293039:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005293040:plotSumLineBy(label = 'Total revenue')
1492005305590:recom_history_w_attributions %>%
1492005305591:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005305592:plotSumLineByCampaign(label = 'Total revenue')
1492005320422:recom_history_w_attributions[
1492005320423:did_open == TRUE,
1492005320424:.(rate = mean(weights*did_click, na.rm = TRUE)),
1492005320424:by = .(campaign_start_date, incentive_class)
1492005320424:] %>%
1492005320425:plotRateLineByCampaign(label = 'Click-through rate')
1492005332211:recom_history_w_attributions %>%
1492005332211:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005332212:plotSumLineByCampaign(label = 'Total revenue')
1492005345379:recom_history_w_attributions %>%
1492005345379:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492005345380:plotSums() %>%
1492005345380:plotBy(label = 'Total revenue')
1492005377661:recom_history_w_attributions %>%
1492005377662:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005377663:plotSumLineByCampaign(label = 'Revenue per person')
1492005408196:recom_history_w_attributions %>%
1492005408199:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492005408199:plotSums() %>%
1492005408200:plotBy(label = 'Revenue per person')
1492005429038:recom_history_w_attributions
1492005434832:recom_history_w_attributions[sales_amount]
1492005438565:recom_history_w_attributions[, sales_amount]
1492005484612:fillZerosForNA_(recom_history_w_attributions, cols = 'sales_amount')
1492005490303:recom_history_w_attributions %>%
1492005490304:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1492005490304:plotSums() %>%
1492005490305:plotBy(label = 'Revenue per person')
1492005499366:recom_history_w_attributions %>%
1492005499367:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1492005499368:plotSumLineByCampaign(label = 'Revenue per person')
1492072521788:source('global.R')
1492072531651:getEnvNameOfCustomer('posterxxl_de')
1492072538173:getEnvNameOfCustomer('posterxxl')
1492072554475:getIdFromName('posterxxl_de')
1492072560582:getEnvNameOfCustomer('posterxxl')
1492072564774:getEnvNameOfCustomer('posterxxl_de')
1492072580839:getEnvNameOfCustomer(getIdFromName('posterxxl_de'))
1492072611992:getSegmentId <- function(customer, segment_name) {
1492072611993:getSqlResult(
1492072611993:query = paste0("SELECT id
1492072611994:FROM ugroup_definitions
1492072611994:WHERE customer = #{customer_id}
1492072611994:AND name = '", segment_name, "'"),
1492072611994:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072611995:customer_id = getIdFromName(customer)
1492072611995:) %>% .[, id]
1492072611996:}
1492072636867:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich')
1492072698729:excluded_segment <- getSegmentId('posterxxl_de', 'Standard Ausschlsse Weekly Newsletter (ab Sep. 16)')
1492072804708:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072804708:getContactlistId('posterxxl_de', .)
1492072805203:excluded_segment <- getSegmentId('posterxxl_de', 'Standard Ausschlsse Weekly Newsletter (ab Sep. 16)')
1492072812186:getContactlistId <- function(customer, segment_id = NULL) {
1492072812187:getSqlResult(
1492072812188:query = "SELECT id
1492072812188:FROM userlists
1492072812189:WHERE customer = #{customer_id}
1492072812189:AND ugroup_def = #{segment_id})",
1492072812189:database_name = SETTINGS[[customer]]$suite,
1492072812190:customer_id = getIdFromName(customer)
1492072812190:) %>% .[, id]
1492072812191:}
1492072814726:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072814727:getContactlistId('posterxxl_de', .)
1492072841941:getContactlistId <- function(customer, segment_id = NULL) {
1492072841941:getSqlResult(
1492072841942:query = "SELECT id
1492072841942:FROM userlists
1492072841942:WHERE customer = #{customer_id}
1492072841943:AND ugroup_def = #{segment_id})",
1492072841943:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072841943:customer_id = getIdFromName(customer)
1492072841944:) %>% .[, id]
1492072841944:}
1492072842829:getListOfContacts <- function(customer, contactlist_id) {
1492072842830:getSqlResult(
1492072842831:query = "SELECT user_id as contact_id
1492072842831:FROM ul_#{customer_id}_#{userlist_id};",
1492072842832:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072842832:customer_id = getIdFromName(customer),
1492072842832:userlist_id = contactlist_id
1492072842833:)
1492072842833:}
1492072844105:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072844106:getContactlistId('posterxxl_de', .)
1492072867050:getContactlistId <- function(customer, segment_id = NULL) {
1492072867051:getSqlResult(
1492072867052:query = "SELECT id
1492072867053:FROM userlists
1492072867053:WHERE customer = #{customer_id}
1492072867054:AND ugroup_def = #{segment_id})",
1492072867054:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072867055:customer_id = getIdFromName(customer),
1492072867055:segment_id = segment_id
1492072867055:) %>% .[, id]
1492072867056:}
1492072868950:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072868950:getContactlistId('posterxxl_de', .)
1492072882334:getContactlistId <- function(customer, segment_id = NULL) {
1492072882335:getSqlResult(
1492072882335:query = "SELECT id
1492072882336:FROM userlists
1492072882336:WHERE customer = #{customer_id}
1492072882337:AND ugroup_def = #{segment})",
1492072882337:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072882337:customer_id = getIdFromName(customer),
1492072882338:segment = segment_id
1492072882338:) %>% .[, id]
1492072882339:}
1492072884494:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072884494:getContactlistId('posterxxl_de', .)
1492072894446:whole_segment
1492072905263:getContactlistId('posterxxl', 55516)
1492072916406:getContactlistId('posterxxl_de', 55516)
1492072932301:getContactlistId <- function(customer, segment_id = NULL) {
1492072932302:getSqlResult(
1492072932302:query = "SELECT id
1492072932303:FROM userlists
1492072932303:WHERE customer = #{customer_id}
1492072932303:AND ugroup_def = #{segment}",
1492072932304:database_name = getEnvNameOfCustomer(getIdFromName(customer)),
1492072932304:customer_id = getIdFromName(customer),
1492072932305:segment = segment_id
1492072932305:) %>% .[, id]
1492072932305:}
1492072934112:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072934113:getContactlistId('posterxxl_de', .)
1492072961066:whole_segment <- getSegmentId('posterxxl_de', 'Kundenversand monatlich') %>%
1492072961066:getContactlistId('posterxxl_de', .) %>%
1492072961068:getListOfContacts('posterxxl_de', .)
1492073039681:getContactlistForSegment <- function(customer, segment_id) {
1492073039683:getSegmentId(customer, 'Kundenversand monatlich') %>%
1492073039684:getContactlistId(customer, .) %>%
1492073039684:getListOfContacts(customer, .)
1492073039685:}
1492073041436:excluded_segment <- getContactlistForSegment('posterxxl_de', 'Standard Ausschlsse Weekly Newsletter (ab Sep. 16)')
1492073084229:excluded_segment <- getContactlistForSegment('posterxxl_de', 'Standard Ausschlsse Weekly Newsletter (ab Sep. 16)')
1492073093671:getContactlistForSegment <- function(customer, segment_name) {
1492073093674:getSegmentId(customer, segment_name) %>%
1492073093674:getContactlistId(customer, .) %>%
1492073093674:getListOfContacts(customer, .)
1492073093674:}
1492073152400:excluded_segment <- getContactlistForSegment('posterxxl_de', 'Standard Ausschlsse Weekly Newsletter (ab Sep. 16)')
1492073344914:targeted_segment <- merge(whole_segment, excluded_segment[, exclude := TRUE], by = 'contact_id', all.x = TRUE)
1492073362572:targeted_segment <- merge(whole_segment, excluded_segment[, exclude := TRUE], by = 'contact_id', all.x = TRUE) %>%
1492073362573:.[is.na(exclude)]
1492507059665:devtools::install_github('ropensci/plotly')
1492507090076:intall.packages('leaflet')
1492507093476:install.packages('leaflet')
1492507115622:devtools::install_github('hadley/ggplot2')
1492507137496:?subset
1492507153533:library(plotly)
1492507165720:txhousing
1492507183094:Abilene <- filter(txhousing, city == 'Abilene')
1492507184996:Abilene
1492507200824:p <- ggplot(Abilene, aes(month, sales, group = year)) + geom_line()
1492507208137:ggplotly(p, dynamicTicks = TRUE)
1492507233306:ggplotly(p, dynamicTicks = FALSE)
1492507241947:ggplotly(p, dynamicTicks = TRUE)
1492507262748:p <- ggplot(Abilene, aes(month, sales, frame = year)) + geom_line()
1492507263921:p
1492507269626:ggplotly(p)
1492507372248:p <- plot_ly(Abilene, x = ~month, y = ~sales, frame = ~year, showlegend = F)
1492507377168:add_lines(p)
1492507392237:p
1492507721329:library(crosstalk)
1492507721341:d <- SharedData$new(Abilene, ~year)
1492507721348:p <- ggplot(d, aes(month, sales)) +
1492507721348:geom_line(aes(group = year))
1492507721351:gg <- ggplotly(p, tooltip = "year")
1492507721439:highlight(gg, on = "plotly_click", off = "plotly_doubleclick")
1492508383652:knitr::opts_knit$set(root.dir = normalizePath(".."))
1492508383654:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1492508383656:selected_customer <- params$customer
1492508383658:balance <- params$balance
1492508383661:resample <- params$resample
1492508391735:source('global.R')
1492508394650:setEmsTheme(base_size = 12)
1492508394714:# Load incentive history
1492508394715:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1492508401891:n_bins <- 4
1492508401893:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1492508403999:recom_history <- recom_history[!is.na(buying_probability)]
1492508409059:selected_time_window <- ifelse(
1492508409061:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1492508409062:ATTRIBUTION_TIME_WINDOW,
1492508409064:customer_settings[[selected_customer]]$incentive_expiration_days
1492508409065:)
1492508409070:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1492508409071:recom_history, purchases,
1492508409073:source = 'si',
1492508409074:method = 'time',
1492508409076:time_window = selected_time_window
1492508409078:)
1492508434292:recom_history_w_attributions
1492508435960:recom_history_w_attributions
1492508441965:recom_history_w_attributions[, .N, by = class]
1492508446323:recom_history_w_attributions[, .N, by = incentive_class]
1492508699513:recom_history_w_attributions[is.na(incentive_class)]
1492508787740:recom_history[
1492508787741:is.na(incentive_class),
1492508787742:`:=`(incentive_class = 'control', incentive_type = 'percentage', incentive_value = 0)
1492508787742:]
1492508787758:recom_history[, incentive_content := ifelse(incentive_type == 'free_shipping', incentive_type, paste0(incentive_type, incentive_value))]
1492508792200:selected_time_window <- ifelse(
1492508792203:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1492508792206:ATTRIBUTION_TIME_WINDOW,
1492508792207:customer_settings[[selected_customer]]$incentive_expiration_days
1492508792209:)
1492508792211:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1492508792212:recom_history, purchases,
1492508792213:source = 'si',
1492508792214:method = 'time',
1492508792215:time_window = selected_time_window
1492508792217:)
1492508802056:recom_history_w_attributions[, .N, by = incentive_class]
1492508806446:if (balance == TRUE) {
1492508806448:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1492508806450:} else {
1492508806451:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1492508806453:}
1492508828116:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1492510537192:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1492510548493:recom_history
1492510555906:recom_history[, .N, by = incentive_class]
1492510574646:recom_history[, .N, by = .(campaign_id, incentive_class)] %>% dcast(campaign_id ~ incentive_class)
1492510702188:recom_history[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>% dcast(campaign_id + campaign_start_date ~ incentive_class)
1492510758508:n_bins <- 4
1492510758900:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1492510762469:selected_time_window <- ifelse(
1492510762470:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1492510762471:ATTRIBUTION_TIME_WINDOW,
1492510762474:customer_settings[[selected_customer]]$incentive_expiration_days
1492510762476:)
1492510763753:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1492510763754:recom_history, purchases,
1492510763757:source = 'si',
1492510763758:method = 'time',
1492510763759:time_window = selected_time_window
1492510763760:)
1492511114959:recom_history[campaign_id == 824442 & incentive_class == 'smart', .N, by = .(incentive_content)]
1492511124687:recom_history[campaign_id == 824442 & incentive_class == 'smart', .N, keyby = .(incentive_content)]
1492514351426:recom_history[is.na(incentive_value), incentive_value := 0]
1492514357804:recom_history[, incentive_content := ifelse(
1492514357805:incentive_type == 'free_shipping',
1492514357806:incentive_type,
1492514357807:paste0(incentive_type, incentive_value)
1492514357807:)]
1492514443116:selected_time_window <- ifelse(
1492514443117:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1492514443119:ATTRIBUTION_TIME_WINDOW,
1492514443121:customer_settings[[selected_customer]]$incentive_expiration_days
1492514443122:)
1492514443124:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1492514443126:recom_history, purchases,
1492514443127:source = 'si',
1492514443128:method = 'time',
1492514443131:time_window = selected_time_window
1492514443133:)
1492514454247:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1492514454249:dcast(campaign_id + campaign_start_date ~ incentive_class)
1492514454346:recom_history_w_attributions[, table(incentive_content, incentive_class, useNA = 'ifany')]
1492514454887:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)] %>%
1492514454889:dcast(campaign_id ~ incentive_content)
1492514454989:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1492514454990:dcast(prob_group ~ incentive_content)
1492514518287:n_bins <- 4
1492514518289:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1492514525641:if (resample == TRUE) {
1492514525642:recom_history_w_attributions[, sampling_weight := weights/.N]
1492514525643:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1492514525646:recom_history_w_attributions[, weights := 1]
1492514525648:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1492514525649:}
1492514545255:recom_history
1492514550707:recom_history[is.na(prob_group)]
1492514574373:recom_history[is.na(prob_group) & !is.na(buying_prob_group)]
1492514578129:recom_history[is.na(prob_group) & !is.na(prob_group)]
1492515459925:recom_history
1492515490854:weights <- calculateBalancingWeights(recom_history[!is.na(buying_probability)], 'control')
1492515507646:weights <- calculateBalancingWeights(recom_history_w_attribution[!is.na(buying_probability)], 'control')
1492515513744:weights <- calculateBalancingWeights(recom_history_w_attributions[!is.na(buying_probability)], 'control')
1492515566296:weights
1492515589489:weights[, mean(weights), by = is.smart]
1492515593048:weights[, mean(weights), by = is_smart]
1492516124042:?split
1492516146578:split(weights, is.smart)
1492516160001:split(weights, by = is.smart)
1492516175897:split(weights, by = 'is_smart')
1492516210955:split(recom_history, f = is.na(buying_probability)
1492516212746:)
1492516215306:split(recom_history, f = is.na(buying_probability))
1492526876933:0.8*0.2+0.2*0.1
1492526959645:weights
1492527328352:dt_to_balance <- recom_history_w_attributions
1492527346079:share_control <- dt_to_balance[, mean(incentive_class == 'control')]
1492527349445:share_control
1492527378911:share_control_with_buying_prob <- dt_to_balance[!is.na(buying_prob), mean(incentive_class == 'control')]
1492527385681:share_control_with_buying_prob <- dt_to_balance[!is.na(buying_probability), mean(incentive_class == 'control')]
1492527401118:share_control_without_buying_prob <- dt_to_balance[is.na(buying_probability), mean(incentive_class == 'control')]
1492527451265:adjust_factor <- share_control/share_control_with_buying_prob
1492527733613:recom_history <- recom_history[!is.na(buying_probability)]
1492527812351:packrat::restore(prompt = FALSE)
1492586818854:weights
1492586836029:weights[is_smart == 0]
1492586868682:weights[is_smart == 0, weights < 0.5]
1492586879673:weights[is_smart == 0 & weights < 0.5]
1492586897963:weights[is_smart == 0 & weights == 0.419045]
1492586922632:weights[, mean(weight), by = is_smart]
1492586925361:weights[, mean(weights), by = is_smart]
1492592773760:debug(addBalancingWeights)
1492592788871:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1492592800304:debug(calculateBalancingWeights)
1492592859856:m.out
1492592876073:m.out$subclass
1492592888188:m.out$weights
1492592915742:data.table(m.out$weights, m.out$subclass)
1492592929765:data.table(m.out$weights, m.out$subclass)[V2 == 9]
1492592932101:data.table(m.out$weights, m.out$subclass)[V2 == 1]
1492592934722:data.table(m.out$weights, m.out$subclass)[V2 == 35]
1492592975039:12*0.01164
1492592984520:data.table(m.out$weights, m.out$subclass)[V2 == 36]
1492592987536:data.table(m.out$weights, m.out$subclass)[V2 == 34]
1492592989607:data.table(m.out$weights, m.out$subclass)[V2 == 33]
1492592990959:data.table(m.out$weights, m.out$subclass)[V2 == 32]
1492592992279:data.table(m.out$weights, m.out$subclass)[V2 == 31]
1492592993943:data.table(m.out$weights, m.out$subclass)[V2 == 21]
1492592996582:data.table(m.out$weights, m.out$subclass)[V2 == 45]
1492592998520:data.table(m.out$weights, m.out$subclass)[V2 == 47]
1492593000176:data.table(m.out$weights, m.out$subclass)[V2 == 49]
1492593005141:data.table(m.out$weights, m.out$subclass)[V2 == 50]
1492593007110:data.table(m.out$weights, m.out$subclass)[V2 == 52]
1492593008839:data.table(m.out$weights, m.out$subclass)[V2 == 53]
1492593010416:data.table(m.out$weights, m.out$subclass)[V2 == 54]
1492593011927:data.table(m.out$weights, m.out$subclass)[V2 == 56]
1492593014527:data.table(m.out$weights, m.out$subclass)[V2 == 58]
1492593025017:15*0.009312
1492593053122:matching_data[, mean(is_smart)]
1492593058266:matching_data[, table(is_smart)]
1492593067601:89127/637984
1492593084676:data.table(m.out$weights, m.out$subclass)[V2 == 59]
1492593097628:0.5587*2
1492593100509:0.5587*2/8
1492593128151:undebug(calculateBalancingWeights)
1492593133575:undebug(addBalancingWeights)
1492593146318:undebug(addBalancingWeights)
1492593780383:data.table(a = c(1,2,3), b = 1:.N)
1492593862186:sample_dt <- data.table(
1492593862187:contact_id = 1:9,
1492593862188:campaign_id = 1,
1492593862188:buying_probability = c(rep(0.5, 3), rep(NA, 6)),
1492593862189:incentive_class = c('smart', 'static', 'control', 'smart', 'smart', 'static', 'control', 'control', 'control'),
1492593862189:sales_amount = 10
1492593862189:)
1492593869189:sample_dt
1492593889958:calculateMatchingWeights <- function(dt_with_class_buying_prob, comparison_class = 'control') {
1492593889960:matching_data <- dt_with_class_buying_prob[
1492593889961:incentive_class %in% c("smart", comparison_class) & is.na(buying_probability) == FALSE,
1492593889962:.(
1492593889963:contact_id,
1492593889963:campaign_id,
1492593889964:is_smart = ifelse(incentive_class == "smart", 1, 0),
1492593889965:buying_prob_category = cut(log(buying_probability), 50),
1492593889965:sales_amount = ifelse(is.na(sales_amount), 0, sales_amount)
1492593889965:)
1492593889966:]
1492593889967:p <- ggplot(data = matching_data, aes(x = buying_prob_category, fill = factor(is_smart))) +
1492593889967:geom_bar() +
1492593889967:facet_wrap(~ campaign_id, ncol = 1) +
1492593889968:scale_x_discrete('Matching category (log buying probability bin)', labels = NULL) +
1492593889968:scale_fill_discrete(guide_legend('class'), labels = c(comparison_class, 'smart'))
1492593889969:print(p)
1492593889970:m.out <- matchit(
1492593889971:is_smart ~ campaign_id + buying_prob_category,
1492593889972:data = matching_data,
1492593889973:method = "exact")
1492593889975:matching_data[, is_matched := ifelse(!is.na(m.out$subclass), "matched", "unmatched")]
1492593889976:matching_data[, table(is_matched, is_smart)] %>%
1492593889978:print()
1492593889979:matching_data[
1492593889980:,
1492593889981:.(n_purchase = sum(sales_amount > 0), sum_sales = sum(sales_amount)),
1492593889981:by = .(is_smart, is_matched)
1492593889982:] %>%
1492593889983:dcast(is_smart ~ is_matched, value.var = c("n_purchase", "sum_sales")) %>%
1492593889983:print()
1492593889985:data.table(match.data(m.out))[, .(contact_id, campaign_id, is_smart, weights)]
1492593889987:}
1492593905162:calculateMatchingWeights(sample_dt[!is.na(buying_probability)])
1492593916020:a <- calculateMatchingWeights(sample_dt[!is.na(buying_probability)])
1492593917261:a
1492594068553:sample_dt
1492594157922:sample_dt <- data.table(
1492594157923:contact_id = 1:10,
1492594157924:campaign_id = 1,
1492594157924:buying_probability = c(rep(0.5, 4), rep(NA, 6)),
1492594157924:incentive_class = c('smart', 'smart', 'static', 'control', 'smart', 'smart', 'static', 'control', 'control', 'control'),
1492594157925:sales_amount = 10
1492594157925:)
1492594163501:a <- calculateMatchingWeights(sample_dt[!is.na(buying_probability)])
1492594166988:a
1492594195669:sample_dt
1492594786367:source('global.R')
1492594811094:sample_dt
1492594817471:addBalancingWeights(sample_dt)
1492594881267:debug(addBalancingWeights)
1492594882317:addBalancingWeights(sample_dt)
1492595473845:undebug(addBalancingWeights)
1492595480730:a <- addBalancingWeights(sample_dt)
1492595487418:source('global.R')
1492595489658:a <- addBalancingWeights(sample_dt)
1492595491771:a
1492595585165:0.833*60
1492595965677:source('global.R')
1492595968302:a <- addBalancingWeights(sample_dt)
1492595970415:a
1492598989636:dt_to_balance[, incentive_class %in% c('smart', 'control'), sum(incentive_class == 'control')/sum(incentive_class == 'smart'), by = is.na(buying_probability)]
1492599000500:dt_to_balance[incentive_class %in% c('smart', 'control'), sum(incentive_class == 'control')/sum(incentive_class == 'smart'), by = is.na(buying_probability)]
1492599488096:source('global.R')
1492599490879:a <- addBalancingWeights(sample_dt)
1492599492870:a
1493739720740:packrat::restore(prompt = FALSE)
1493739756951:knitr::opts_knit$set(root.dir = normalizePath(".."))
1493739756953:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1493739756956:selected_customer <- params$customer
1493739756959:balance <- params$balance
1493739756962:resample <- params$resample
1493739759717:source('global.R')
1493739762675:setEmsTheme(base_size = 12)
1493739762742:# Load incentive history
1493739762745:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493739765639:n_bins <- 4
1493739765642:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1493739818275:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493739818277:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493739825647:selected_time_window <- ifelse(
1493739825649:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493739825652:ATTRIBUTION_TIME_WINDOW,
1493739825654:customer_settings[[selected_customer]]$incentive_expiration_days
1493739825656:)
1493739825659:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493739825661:recom_history, purchases,
1493739825665:source = 'si',
1493739825667:method = 'time',
1493739825670:time_window = selected_time_window
1493739825672:)
1493739835854:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493739835858:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493739835915:recom_history_w_attributions[, table(incentive_content, incentive_class, useNA = 'ifany')]
1493739836111:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)] %>%
1493739836112:dcast(campaign_id ~ incentive_content)
1493739836151:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1493739836152:dcast(prob_group ~ incentive_content)
1493739925497:recom_history_w_attributions[, .N, by = campaign_id]
1493739938827:recom_history_w_attributions[, .N, by = sent_date]
1493739945012:recom_history_w_attributions[, .N, by = campaign_start_date]
1493739969379:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)]
1493739981518:recom_history_w_attributions[campaign_id != 1530509, .N, by = .(campaign_id, incentive_content)]
1493739989721:recom_history_w_attributions[campaign_id != 1530509, .N, by = .(campaign_id, incentive_class, incentive_content)]
1493740008365:recom_history_w_attributions[campaign_id != 1530509, .N, by = .(campaign_id, incentive_class, incentive_content)] %>% dcast(campaign_id + incentive_class ~ incentive_content)
1493740319317:recom_history_w_attributions[,
1493740319319:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493740319320:by = .(campaign_start_date, incentive_class)
1493740319322:] %>%
1493740319325:plotRateLineByCampaign(label = 'Open rate')
1493740325387:if (balance == TRUE) {
1493740325388:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1493740325390:} else {
1493740325392:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1493740325395:}
1493740329454:recom_history_w_attributions[,
1493740329455:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493740329457:by = .(campaign_start_date, incentive_class)
1493740329459:] %>%
1493740329461:plotRateLineByCampaign(label = 'Open rate')
1493740329974:```
1493740377554:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)]
1493740410213:recom_history_w_attributions[campaign_id == 1502697]
1493740417726:recom_history_w_attributions[campaign_id == 1502697, mean(did_open)]
1493740441675:recom_history_w_attributions[, mean(did_open), by = campaign_id]
1493740544426:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493740559173:recom_history
1493740565291:recom_history[campaign_id != 1502697]
1493740586478:recom_history[campaign_id != 1530509]
1493740591026:recom_history <- recom_history[campaign_id != 1530509]
1493740607483:selected_customer
1493740611815:save(
1493740611816:list = c('recom_history', 'purchases'),
1493740611816:file = sprintf('data/enriched_recom_history_data_%s.RData', selected_customer)
1493740611817:)
1493740648991:purchases
1493740654719:class(purchases)
1493740660977:purchases$si
1493740678173:purchases$si[!is.na(campaign_id)]
1493740690843:purchases$si[campaign_id == 1502697]
1493740769188:selected_time_window <- ifelse(
1493740769189:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493740769191:ATTRIBUTION_TIME_WINDOW,
1493740769192:customer_settings[[selected_customer]]$incentive_expiration_days
1493740769194:)
1493740769196:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493740769197:recom_history, purchases,
1493740769199:source = 'si',
1493740769201:method = 'time',
1493740769202:time_window = selected_time_window
1493740769203:)
1493740771796:if (balance == TRUE) {
1493740771797:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1493740771798:} else {
1493740771799:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1493740771800:}
1493740773943:if (resample == TRUE) {
1493740773944:recom_history_w_attributions[, sampling_weight := weights/.N]
1493740773946:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1493740773947:recom_history_w_attributions[, weights := 1]
1493740773949:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1493740773951:}
1493740777586:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493740777588:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493740777634:recom_history_w_attributions[, table(incentive_content, incentive_class, useNA = 'ifany')]
1493740777844:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)] %>%
1493740777846:dcast(campaign_id ~ incentive_content)
1493740777886:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1493740777889:dcast(prob_group ~ incentive_content)
1493740795334:recom_history
1493740799414:recom_history %>% names()
1493740809276:source('global.R')
1493740809371:setEmsTheme(base_size = 12)
1493740809393:# Load incentive history
1493740809394:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493740811206:n_bins <- 4
1493740811209:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1493742192867:knitr::opts_knit$set(root.dir = normalizePath(".."))
1493742192869:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1493742192871:selected_customer <- params$customer
1493742192881:balance <- params$balance
1493742192885:resample <- params$resample
1493742197013:source('global.R')
1493742199835:setEmsTheme(base_size = 12)
1493742199892:# Load incentive history
1493742199893:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493742202431:n_bins <- 4
1493742202434:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1493742220583:selected_time_window <- ifelse(
1493742220585:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493742220586:ATTRIBUTION_TIME_WINDOW,
1493742220588:customer_settings[[selected_customer]]$incentive_expiration_days
1493742220589:)
1493742220592:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493742220593:recom_history, purchases,
1493742220595:source = 'si',
1493742220596:method = 'time',
1493742220598:time_window = selected_time_window
1493742220599:)
1493742224396:if (balance == TRUE) {
1493742224398:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1493742224399:} else {
1493742224400:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1493742224402:}
1493742228172:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493742228173:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493742228227:recom_history_w_attributions[, table(incentive_content, incentive_class, useNA = 'ifany')]
1493742228427:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)] %>%
1493742228429:dcast(campaign_id ~ incentive_content)
1493742228472:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1493742228473:dcast(prob_group ~ incentive_content)
1493742262374:recom_history_w_attributions[,
1493742262375:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742262376:by = .(campaign_start_date, incentive_class)
1493742262378:] %>%
1493742262379:plotRateLineByCampaign(label = 'Open rate')
1493742262750:```
1493742279504:recom_history_w_attributions[,
1493742279505:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742279507:by = .(campaign_start_date, incentive_class)
1493742279508:] %>%
1493742279510:plotRateLineByCampaign(label = 'Open rate')
1493742279991:```
1493742318880:recom_history_w_attributions[, .(rate = mean(weights * did_open, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)]
1493742342825:recom_history_w_attributions[, .(rate = mean(weights * did_open, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>% plotRateLineByCampaign(label = 'OR')
1493742357671:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1493742357671:+     dcast(prob_group ~ incentive_content)
1493742369280:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>% dcast(prob_group ~ incentive_content)
1493742378277:recom_history_w_attributions[,
1493742378278:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742378279:by = .(campaign_start_date, incentive_class)
1493742378281:] %>%
1493742378283:plotRateLineByCampaign(label = 'Open rate')
1493742379159:```
1493742392629:recom_history_w_attributions[,
1493742392629:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742392630:by = .(campaign_start_date, incentive_class)
1493742392630:] %>%
1493742392630:plotRateLineByCampaign(label = 'Open rate')
1493742412902:recom_history_w_attributions %>%
1493742412903:calculateRateWithErrors(variable = 'did_open') %>%
1493742412903:plotRates() %>%
1493742412903:plotBy(label = 'Open rate')
1493742454973:recom_history_w_attributions[campaign_id == 1502697] %>%
1493742454974:calculateRateWithErrors(variable = 'did_open') %>%
1493742454975:plotRates() %>%
1493742454975:plotBy(label = 'Open rate')
1493742476330:recom_history_w_attributions[campaign_id == 1528948] %>%
1493742476331:calculateRateWithErrors(variable = 'did_open') %>%
1493742476332:plotRates() %>%
1493742476333:plotBy(label = 'Open rate')
1493742634579:recom_history_w_attributions[,
1493742634581:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742634582:by = .(campaign_start_date, incentive_class)
1493742634583:] %>%
1493742634584:plotRateLineByCampaign(label = 'Open rate')
1493742635345:```
1493742642722:recom_history_w_attributions[,
1493742642723:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493742642724:by = .(campaign_start_date, incentive_class)
1493742642725:] %>%
1493742642725:plotRateLineByCampaign(label = 'Open rate')
1493742648722:recom_history_w_attributions %>%
1493742648723:calculateRateWithErrors(variable = 'did_open') %>%
1493742648724:plotRates() %>%
1493742648725:plotBy(label = 'Open rate')
1493742656197:recom_history_w_attributions %>%
1493742656199:calculateRateWithErrors(variable = 'did_open', by = 'prob_group') %>%
1493742656200:plotRates() %>%
1493742656201:plotBy(label = 'Open rate', by = 'prob_group', nrow = 1)
1493742665910:top10_domain <- recom_history_w_attributions %>%
1493742665911:.[, .(count = .N), by = domain] %>%
1493742665912:.[order(-count)] %>%
1493742665913:.[1:5, domain]
1493742665930:recom_history_w_attributions[domain %in% top10_domain] %>%
1493742665932:calculateRateWithErrors(variable = 'did_open', by = c('campaign_id', 'domain')) %>%
1493742665933:plotRatesBy("domain") %>%
1493742665934:plotBy(label = 'Open rate', by = 'campaign_id', scales = 'free', ncol = 1)
1493742688190:recom_history_w_attributions[
1493742688192:did_open == TRUE,
1493742688193:.(rate = mean(weights*did_click, na.rm = TRUE)),
1493742688194:by = .(campaign_start_date, incentive_class)
1493742688196:] %>%
1493742688197:plotRateLineByCampaign(label = 'Click-through rate')
1493742688499:```
1493742696026:recom_history_w_attributions[
1493742696027:did_open == TRUE,
1493742696028:.(rate = mean(weights*did_click, na.rm = TRUE)),
1493742696029:by = .(campaign_start_date, incentive_class)
1493742696030:] %>%
1493742696031:plotRateLineByCampaign(label = 'Click-through rate')
1493742709025:recom_history_w_attributions %>%
1493742709026:.[did_open == TRUE] %>%
1493742709027:calculateRateWithErrors(variable = 'did_click') %>%
1493742709028:plotRates() %>%
1493742709029:plotBy(label = 'Click-through rate')
1493742727743:recom_history_w_attributions[, mean(did_click)]
1493742734341:recom_history_w_attributions[, mean(did_click), by = campaign_id]
1493743089462:recom_history_w_attributions %>%
1493743089463:.[did_open == TRUE] %>%
1493743089464:calculateRateWithErrors(variable = 'did_click', by = 'prob_group') %>%
1493743089466:plotRates() %>%
1493743089467:plotBy(label = 'Click-through rate', by = 'prob_group', nrow = 1)
1493743095592:try(predict_data <- getWebData(
1493743095593:selected_customer,
1493743095594:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493743095595:))
1493743111918:recom_history_w_attributions[
1493743111919:did_click == TRUE,
1493743111920:.(rate = mean(did_buy*weights, na.rm = TRUE)),
1493743111921:by = .(campaign_start_date, incentive_class)
1493743111923:] %>%
1493743111924:plotRateLineByCampaign(label = 'Purchase rate')
1493743714092:recom_history_w_attributions[,
1493743714093:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493743714093:by = .(campaign_start_date, incentive_class)
1493743714094:] %>%
1493743714095:plotRateLineByCampaign(label = 'Open rate')
1493743753122:recom_history_w_attributions[,
1493743753123:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493743753124:by = .(campaign_start_date, incentive_class)
1493743753125:] %>%
1493743753126:plotRateLineByCampaign(label = 'Open rate')
1493743793934:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493743793934:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493743793935:geom_line(aes_string(color = color_var)) +
1493743793935:scale_y_continuous(label = scales::percent) +
1493743793936:labs(
1493743793936:title = paste0(label, "s in different campaigns"),
1493743793936:x = 'Campaign date',
1493743793936:y = label,
1493743793937:color = 'Segment'
1493743793937:) +
1493743793937:theme(legend.position = 'top')
1493743793937:}
1493743798173:recom_history_w_attributions[,
1493743798174:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493743798175:by = .(campaign_start_date, incentive_class)
1493743798177:] %>%
1493743798178:plotRateLineByCampaign(label = 'Open rate')
1493743798693:```
1493743810655:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493743810655:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493743810656:geom_line(aes_string(color = color_var), size = 1) +
1493743810657:scale_y_continuous(label = scales::percent) +
1493743810657:labs(
1493743810657:title = paste0(label, "s in different campaigns"),
1493743810657:x = 'Campaign date',
1493743810658:y = label,
1493743810658:color = 'Segment'
1493743810658:) +
1493743810659:theme(legend.position = 'top')
1493743810659:}
1493743816516:recom_history_w_attributions[,
1493743816517:.(rate = mean(weights*did_open, na.rm = TRUE)),
1493743816518:by = .(campaign_start_date, incentive_class)
1493743816520:] %>%
1493743816522:plotRateLineByCampaign(label = 'Open rate')
1493743817459:```
1493743889822:recom_history_w_attributions %>%
1493743889823:calculateRateWithErrors(variable = 'did_open') %>%
1493743889824:plotRateLineByCampaign(label = 'Open rate')
1493743922405:recom_history_w_attributions %>%
1493743922406:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493743922407:plotRateLineByCampaign(label = 'Open rate')
1493743945174:recom_history_w_attributions %>%
1493743945175:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date')
1493743948427:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date')
1493743949895:recom_history_w_attributions %>%
1493743950946:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date')
1493743953198:recom_history_w_attributions %>%
1493743957642:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>% .[]
1493744014540:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493744014541:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493744014541:geom_line(aes_string(color = color_var), size = 1) +
1493744014542:geom_ribbon(aes_string(ymin = 'rate_lower', ymax = 'rate_higher', color = color_var)) +
1493744014542:scale_y_continuous(label = scales::percent) +
1493744014543:labs(
1493744014543:title = paste0(label, "s in different campaigns"),
1493744014544:x = 'Campaign date',
1493744014544:y = label,
1493744014544:color = 'Segment'
1493744014545:) +
1493744014545:theme(legend.position = 'top')
1493744014545:}
1493744023499:recom_history_w_attributions %>%
1493744023500:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493744023501:plotRateLineByCampaign(label = 'Open rate')
1493744034158:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493744034160:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493744034161:geom_line(aes_string(color = color_var), size = 1) +
1493744034162:geom_ribbon(aes_string(ymin = 'rate_lower', ymax = 'rate_higher', fill = color_var)) +
1493744034162:scale_y_continuous(label = scales::percent) +
1493744034162:labs(
1493744034163:title = paste0(label, "s in different campaigns"),
1493744034163:x = 'Campaign date',
1493744034163:y = label,
1493744034164:color = 'Segment'
1493744034164:) +
1493744034164:theme(legend.position = 'top')
1493744034164:}
1493744038581:recom_history_w_attributions %>%
1493744038582:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493744038584:plotRateLineByCampaign(label = 'Open rate')
1493744050140:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493744050142:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493744050143:geom_line(aes_string(color = color_var), size = 1) +
1493744050143:geom_ribbon(aes_string(ymin = 'rate_lower', ymax = 'rate_higher', fill = color_var), alpha = 0.3) +
1493744050144:scale_y_continuous(label = scales::percent) +
1493744050144:labs(
1493744050144:title = paste0(label, "s in different campaigns"),
1493744050144:x = 'Campaign date',
1493744050145:y = label,
1493744050145:color = 'Segment'
1493744050145:) +
1493744050145:theme(legend.position = 'top')
1493744050146:}
1493744058602:recom_history_w_attributions %>%
1493744058603:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493744058604:plotRateLineByCampaign(label = 'Open rate')
1493744091879:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493744091879:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493744091881:geom_line(aes_string(color = color_var), size = 1) +
1493744091881:geom_ribbon(aes_string(ymin = 'rate_lower', ymax = 'rate_higher', fill = color_var), alpha = 0.1) +
1493744091881:scale_y_continuous(label = scales::percent) +
1493744091881:labs(
1493744091881:title = paste0(label, "s in different campaigns"),
1493744091882:x = 'Campaign date',
1493744091882:y = label,
1493744091882:color = 'Segment'
1493744091882:) +
1493744091883:theme(legend.position = 'top')
1493744091883:}
1493744098207:recom_history_w_attributions %>%
1493744098208:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493744098209:plotRateLineByCampaign(label = 'Open rate')
1493744250537:plotRateLineByCampaign <- function(rate_by_campaigns, label, color_var = 'incentive_class') {
1493744250538:ggplot(rate_by_campaigns, aes(x = campaign_start_date, y = rate)) +
1493744250539:geom_line(aes_string(color = color_var), size = 1) +
1493744250539:geom_ribbon(aes_string(ymin = 'rate_lower', ymax = 'rate_higher', fill = color_var), alpha = 0.2) +
1493744250539:scale_y_continuous(label = scales::percent) +
1493744250540:scale_fill_discrete(guide = FALSE) +
1493744250540:labs(
1493744250540:title = paste0(label, "s in different campaigns"),
1493744250541:x = 'Campaign date',
1493744250541:y = label,
1493744250541:color = 'Segment'
1493744250542:) +
1493744250542:theme(legend.position = 'top')
1493744250542:}
1493744255092:recom_history_w_attributions %>%
1493744255093:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493744255094:plotRateLineByCampaign(label = 'Open rate')
1493744288606:recom_history_w_attributions %>%
1493744288607:calculateRateWithErrors(variable = 'did_open') %>%
1493744288608:plotRates() %>%
1493744288609:plotBy(label = 'Open rate')
1493744302909:recom_history_w_attributions[campaign_id == 1528948] %>%
1493744302910:calculateRateWithErrors(variable = 'did_open') %>%
1493744302912:plotRates() %>%
1493744302913:plotBy(label = 'Open rate')
1493794418238:recom_history[, .N, by = (campaign_id, incentive_content, incentive_class)]
1493794422739:recom_history[, .N, by = .(campaign_id, incentive_content, incentive_class)]
1493794438450:recom_history[, .N, by = .(campaign_id, incentive_content, incentive_class)] %>% dcast(campaign_id + incentive_content ~ incentive_class)
1493821446804:recom_history_w_attributions %>%
1493821446805:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493821446805:plotRates() %>%
1493821446806:plotBy(label = 'Open rate', by = 'campaign_start_date')
1493821546780:selected_customer
1493821554789:recom_history_w_attributions %>%
1493821554789:calculateRateWithErrors(variable = 'did_open') %>%
1493821554790:plotRates() %>%
1493821554791:plotBy(label = 'Open rate')
1493821572537:recom_history_w_attributions %>%
1493821572538:calculateRateWithErrors(variable = 'did_open', by = 'prob_group') %>%
1493821572539:plotRates() %>%
1493821572539:plotBy(label = 'Open rate', by = 'prob_group', nrow = 1)
1493821625533:plotRatesBy <- function(rate_by_segments, by = 'incentive_class') {
1493821625534:ggplot(rate_by_segments,
1493821625535:aes_string(x = by, y = "rate", fill = "incentive_class")) +
1493821625536:geom_bar(stat = 'identity', position = position_dodge(width = NULL)) +
1493821625537:geom_linerange(aes(ymin = rate_lower, ymax = rate_higher), position = position_dodge(width = 0.9)) +
1493821625537:geom_label(aes(label = scales::percent(rate)), family = 'Canaro Medium', position = position_dodge(width = 0.9)) +
1493821625538:scale_y_continuous(limits = c(0, NA), labels = scales::percent) +
1493821625539:theme(legend.position = 'none')
1493821625539:}
1493821632808:recom_history_w_attributions %>%
1493821632808:calculateRateWithErrors(variable = 'did_open') %>%
1493821632809:plotRatesBy() %>%
1493821632809:plotBy(label = 'Open rate')
1493821649041:recom_history_w_attributions[domain %in% top_domains] %>%
1493821649042:calculateRateWithErrors(variable = 'did_open', by = c('campaign_id', 'domain')) %>%
1493821649042:plotRatesBy("domain") %>%
1493821649043:plotBy(label = 'Open rate', by = 'campaign_id', scales = 'free', ncol = 1)
1493821653510:top_domains <- recom_history_w_attributions %>%
1493821653510:.[, .(count = .N), by = domain] %>%
1493821653511:.[order(-count)] %>%
1493821653511:.[count > 10000, domain]
1493821653529:recom_history_w_attributions[domain %in% top_domains] %>%
1493821653529:calculateRateWithErrors(variable = 'did_open', by = c('campaign_id', 'domain')) %>%
1493821653530:plotRatesBy("domain") %>%
1493821653530:plotBy(label = 'Open rate', by = 'campaign_id', scales = 'free', ncol = 1)
1493821667910:recom_history_w_attributions[domain %in% top_domains] %>%
1493821667911:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1493821667912:plotRatesBy("domain") %>%
1493821667912:plotBy(label = 'Open rate', by = 'campaign_start_date', scales = 'free', ncol = 1)
1493821831067:facetBy <- function(plot, by = NULL, label, ...) {
1493821831068:title_label <- paste(label, "in different segments")
1493821831068:if(!is.null(by)) {
1493821831069:plot <- plot + facet_wrap(as.formula(paste('~', by)), ...)
1493821831069:title_label <- paste0(title_label, ", by ", by)
1493821831069:}
1493821831069:plot + labs(x = 'Segment', y = label, title = title_label)
1493821831070:}
1493821838867:recom_history_w_attributions %>%
1493821838867:calculateRateWithErrors(variable = 'did_open') %>%
1493821838868:plotRatesBy() %>%
1493821838868:facetBy(label = 'Open rate')
1493821853136:recom_history_w_attributions %>%
1493821853137:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1493821853138:plotRatesBy() %>%
1493821853138:facetBy('campaign_start_date', label = 'Open rate')
1493821866398:recom_history_w_attributions %>%
1493821866399:calculateRateWithErrors(variable = 'did_open') %>%
1493821866400:plotRatesBy()
1493821874970:recom_history_w_attributions %>%
1493821874970:calculateRateWithErrors(variable = 'did_open') %>%
1493821874972:plotRatesBy() %>%
1493821874972:facetBy(label = 'Open rate')
1493821892953:recom_history_w_attributions %>%
1493821892954:calculateRateWithErrors(variable = 'did_open', by = 'prob_group') %>%
1493821892954:plotRatesBy() %>%
1493821892955:facetBy('prob_group', label = 'Open rate', nrow = 1)
1493822077073:try(predict_data <- getWebData(
1493822077073:selected_customer,
1493822077074:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493822077075:))
1493822090279:predict_data
1493822102201:selected_customer
1493822144084:readInPredictData(selected_customer)
1493822163211:readInPredictData(selected_customer, 'purchased')
1493822207785:debug(readInPredictData)
1493822237868:readInPredictData(selected_customer, 'purchased')
1493822246080:merchant_id
1493822460559:recom_history_w_attributions %>%
1493822460559:.[did_open == TRUE] %>%
1493822460560:calculateRateWithErrors(variable = 'did_click', by = c('prob_group', 'incentive_content')) %>%
1493822460560:plotRatesBy("incentive_content") %>%
1493822460560:plotBy('prob_group', label = 'Click rate from opens', ncol = 3, nrow = 2, scales = "free")
1493822544250:recom_history_w_attributions %>%
1493822544250:.[did_open == TRUE] %>%
1493822544251:calculateRateWithErrors(variable = 'did_click', by = c('campaign_start_date', 'incentive_content')) %>%
1493822544251:plotRatesBy("incentive_content") %>%
1493822544251:plotBy('campaign_start_date', label = 'Click rate from opens', ncol = 1, scales = "free")
1493822637573:recom_history_w_attributions[, incentive_content]
1493822648421:recom_history_w_attributions[, unique(incentive_content)]
1493822653981:cucc <- recom_history_w_attributions[, unique(incentive_content)]
1493822668080:cucc2 <- recom_history_w_attributions[, unique(incentive_value)]
1493822669918:cucc2
1493822673102:cucc
1493822687326:sort(cucc2)
1493822690722:cucc2
1493822730688:recom_history_w_attributions[order(incentive_value), unique(incentive_content)]
1493822818943:ordered_content <- recom_history[order(incentive_value), unique(incentive_content)]
1493822848280:recom_history[, incentive_content := ordered(incentive_content, ordered_content)]
1493823021835:selected_time_window <- ifelse(
1493823021837:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493823021837:ATTRIBUTION_TIME_WINDOW,
1493823021838:customer_settings[[selected_customer]]$incentive_expiration_days
1493823021838:)
1493823021839:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493823021840:recom_history, purchases,
1493823021840:source = 'si',
1493823021841:method = 'time',
1493823021842:time_window = selected_time_window
1493823021842:)
1493823027148:if (balance == TRUE) {
1493823027148:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1493823027149:} else {
1493823027149:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1493823027150:}
1493823053044:recom_history_w_attributions %>%
1493823053045:.[did_open == TRUE] %>%
1493823053046:calculateRateWithErrors(variable = 'did_click', by = c('campaign_start_date', 'incentive_content')) %>%
1493823053046:plotRatesBy("incentive_content") %>%
1493823053046:plotBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1493823086163:recom_history_w_attributions %>%
1493823086165:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1493823086165:plotRatesBy("incentive_content") %>%
1493823086165:plotBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1493823912830:top_domains <- recom_history_w_attributions %>%
1493823912831:.[, .(count = .N), by = domain] %>%
1493823912832:.[order(-count)] %>%
1493823912832:.[count > 10000, domain]
1493823912852:recom_history_w_attributions[domain %in% top_domains] %>%
1493823912852:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1493823912853:plotRatesBy("domain") %>%
1493823912853:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1493824189123:source('global.R')
1493824193886:try(predict_data <- getWebData(
1493824193886:selected_customer,
1493824193887:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493824193887:))
1493824205218:predict_data
1493824208809:rm(predict_data)
1493824212525:try(predict_data <- getWebData(
1493824212526:selected_customer,
1493824212527:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493824212527:))
1493824216067:predict_data
1493824222740:exists(predict_data)
1493824227991:object.exists(predict_data)
1493824243863:success <- try(predict_data <- getWebData(
1493824243863:selected_customer,
1493824243864:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493824243864:))
1493824247375:success
1493824340948:try(predict_data <- getWebData(
1493824340948:selected_customer,
1493824340949:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1493824340949:))
1493824346497:exists(predict_data)
1493824361218:exists('predict_data')
1493883222601:knitr::opts_knit$set(root.dir = normalizePath(".."))
1493883222665:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1493883222687:selected_customer <- params$customer
1493883222711:balance <- params$balance
1493883222755:resample <- params$resample
1493883225308:source('global.R')
1493883228979:setEmsTheme(base_size = 12)
1493883229184:# Load incentive history
1493883229185:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493883231732:n_bins <- 4
1493883231735:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1493883239644:recom_history[, .N, by = campaign_id]
1493885073831:a <- 1:20
1493885074228:a
1493885077076:a[1:10]
1493885079133:a[1:30]
1493885095817:head(a)
1493885098177:head(a, 10)
1493885100033:head(a, 30)
1493886261885:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886261886:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493886265798:selected_time_window <- ifelse(
1493886265800:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493886265802:ATTRIBUTION_TIME_WINDOW,
1493886265804:customer_settings[[selected_customer]]$incentive_expiration_days
1493886265805:)
1493886265809:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493886265812:recom_history, purchases,
1493886265816:source = 'si',
1493886265819:method = 'time',
1493886265820:time_window = selected_time_window
1493886265822:)
1493886270824:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886270824:dcast(campaign_id + campaign_start_date ~ incentive_class)
1493886324828:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886324829:ggplot(aes(x = incentive_class, y = N, fill = incentive_class)) +
1493886324830:geom_col() +
1493886324830:facet_wrap(~ campaign_start_date)
1493886339370:recom_history_w_attributions[, .N, by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886339370:ggplot(aes(x = incentive_class, y = N, fill = incentive_class)) +
1493886339371:geom_col() +
1493886339372:facet_wrap(~ campaign_start_date + campaign_id)
1493886418734:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] +
1493886418734:plotSums()
1493886428700:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886428701:plotSums()
1493886443726:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886443726:plotSums() +
1493886443727:facetBy('campaign_id + campaign_start_date')
1493886451800:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886451801:plotSums() +
1493886451801:facetBy('campaign_id + campaign_start_date', label = 'Count')
1493886502574:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886502575:plotSums() +
1493886502576:facetBy('campaign_start_date', label = 'Count')
1493886531416:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886531417:plotSums() +
1493886531418:facetBy('campaign_id + campaign_start_date', label = 'N')
1493886557457:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886557458:plotSums() +
1493886557459:facetBy('campaign_id + campaign_start_date', label = 'Sends')
1493886563853:debug(facetBy)
1493886568460:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886568461:plotSums() +
1493886568462:facetBy('campaign_id + campaign_start_date', label = 'Sends')
1493886590764:plot
1493886599406:Q()
1493886607919:undebug(facetBy)
1493886619822:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886619823:plotSums() %>%
1493886619824:facetBy('campaign_id + campaign_start_date', label = 'Sends')
1493886632467:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886632468:plotSums() %>%
1493886632468:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886646074:recom_history_w_attributions[, table(incentive_content, incentive_class, useNA = 'ifany')]
1493886716158:plotSumsBy <- function(sum_by_segments, by = 'incentive_class') {
1493886716159:ggplot(sum_by_segments, aes_string(x = by, y = sum, fill = incentive_class)) +
1493886716160:geom_bar(stat = 'identity', position = 'dodge') +
1493886716160:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1493886716161:scale_y_continuous(limits = c(0, NA)) +
1493886716161:theme(legend.position = 'none')
1493886716162:}
1493886720647:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886720648:plotSumsBy() %>%
1493886720649:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886738406:plotSumsBy <- function(sum_by_segments, by = 'incentive_class') {
1493886738407:ggplot(sum_by_segments, aes_string(x = by, y = sum, fill = "incentive_class")) +
1493886738408:geom_bar(stat = 'identity', position = 'dodge') +
1493886738409:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1493886738410:scale_y_continuous(limits = c(0, NA)) +
1493886738411:theme(legend.position = 'none')
1493886738412:}
1493886741932:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886741933:plotSumsBy() %>%
1493886741934:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886768368:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886768369:plotSumsBy() %>%
1493886768369:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886773379:plotSumsBy <- function(sum_by_segments, by = 'incentive_class') {
1493886773380:ggplot(sum_by_segments, aes_string(x = by, y = "sum", fill = "incentive_class")) +
1493886773381:geom_bar(stat = 'identity', position = 'dodge') +
1493886773381:geom_label(aes(label = prettyNum(sum, big.mark = ',')), family = 'Canaro Medium', show.legend = F) +
1493886773382:scale_y_continuous(limits = c(0, NA)) +
1493886773382:theme(legend.position = 'none')
1493886773383:}
1493886784621:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493886784622:plotSumsBy() %>%
1493886784622:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886818097:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1493886818098:plotSumsBy('incentive_content') %>%
1493886818099:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493886827356:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1493886827357:plotSumsBy('incentive_content') %>%
1493886827357:facetBy('campaign_start_date', label = 'Sends', ncol = 1)
1493891952860:top_domains <- recom_history_w_attributions %>%
1493891952861:.[, .(count = .N), by = domain] %>%
1493891952863:.[order(-count)] %>%
1493891952864:.[count > 10000, domain] %>%
1493891952866:head(10)
1493891952888:recom_history_w_attributions[domain %in% top_domains] %>%
1493891952889:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1493891952891:plotRatesBy("domain", label = FALSE) %>%
1493891952892:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1493894629604:knitr::opts_knit$set(root.dir = normalizePath(".."))
1493894629606:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1493894629608:selected_customer <- params$customer
1493894629612:balance <- params$balance
1493894629614:resample <- params$resample
1493894631059:source('global.R')
1493894631158:setEmsTheme(base_size = 12)
1493894631186:# Load incentive history
1493894631187:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1493894632604:n_bins <- 4
1493894632607:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1493894634526:selected_time_window <- ifelse(
1493894634527:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1493894634529:ATTRIBUTION_TIME_WINDOW,
1493894634531:customer_settings[[selected_customer]]$incentive_expiration_days
1493894634533:)
1493894634537:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1493894634539:recom_history, purchases,
1493894634541:source = 'si',
1493894634544:method = 'time',
1493894634546:time_window = selected_time_window
1493894634547:)
1493894636994:if (balance == TRUE) {
1493894636995:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1493894636996:} else {
1493894636997:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1493894636999:}
1493894639206:if (resample == TRUE) {
1493894639208:recom_history_w_attributions[, sampling_weight := weights/.N]
1493894639209:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1493894639211:recom_history_w_attributions[, weights := 1]
1493894639213:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1493894639215:}
1493894641372:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1493894641374:plotSumsBy() %>%
1493894641376:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493894641977:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1493894641978:plotSumsBy() %>%
1493894641979:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1493894696853:warnings()
1493903825853:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1493903825854:plotSumsBy('incentive_content') %>%
1493903825855:facetBy('campaign_start_date', label = 'Sends', ncol = 1)
1493903846339:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1493903846340:plotSumsBy('incentive_content') %>%
1493903846341:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'free')
1493903857163:recom_history_w_attributions[, .N, by = .(campaign_id, incentive_content)] %>%
1493903857164:dcast(campaign_id ~ incentive_content)
1493903867084:recom_history_w_attributions[, .N, by = .(prob_group, incentive_content)] %>%
1493903867084:dcast(prob_group ~ incentive_content)
1493904282846:recom_history_w_attributions[, .(sum = .N), by = .(prob_group, incentive_content)] %>%
1493904282846:dcast(prob_group ~ incentive_content)
1493904353017:recom_history_w_attributions[, .(sum = .N), by = .(prob_group, incentive_content)] %>%
1493904353018:plotSumsBy('incentive_content') %>%
1493904353019:facetBy('prob_group', label = 'Sends')
1493904373059:recom_history_w_attributions[incentive_class == 'smart', .(sum = .N), by = .(prob_group, incentive_content)] %>%
1493904373059:plotSumsBy('incentive_content') %>%
1493904373060:facetBy('prob_group', label = 'Sends')
1493904396834:recom_history_w_attributions[, .(sum = .N), by = .(prob_group, incentive_class, incentive_content)] %>%
1493904396835:plotSumsBy('incentive_content') %>%
1493904396836:facetBy('prob_group', label = 'Sends')
1495035109616:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495035109620:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495035109622:selected_customer <- params$customer
1495035109627:balance <- params$balance
1495035109631:resample <- params$resample
1495035124753:source('global.R')
1495035127661:setEmsTheme(base_size = 12)
1495035127842:# Load incentive history
1495035127843:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495035138579:n_bins <- 4
1495035138593:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495035138977:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495035145787:selected_time_window <- ifelse(
1495035145788:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495035145789:ATTRIBUTION_TIME_WINDOW,
1495035145791:customer_settings[[selected_customer]]$incentive_expiration_days
1495035145792:)
1495035145795:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1495035145797:recom_history, purchases,
1495035145799:source = 'si',
1495035145802:method = 'time',
1495035145804:time_window = selected_time_window
1495035145806:)
1495035270129:if (balance == TRUE) {
1495035270131:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495035270134:} else {
1495035270136:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495035270139:}
1495035278257:recom_history_w_attributions[, .(sum = .N), by = .(campaign_id, campaign_start_date, incentive_class)] %>%
1495035278258:plotSumsBy() %>%
1495035278260:facetBy('campaign_id + campaign_start_date', label = 'Sends', ncol = 1)
1495035278985:recom_history_w_attributions[, .(sum = .N), by = .(campaign_start_date, incentive_class, incentive_content)] %>%
1495035278986:plotSumsBy('incentive_content') %>%
1495035278988:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'free')
1495035287119:recom_history_w_attributions %>%
1495035287121:.[, .(sum = .N), by = .(campaign_start_date, incentive_class)] %>%
1495035287122:plotSumsBy() %>%
1495035287124:facetBy("campaign_start_date", label = 'Number of contacts')
1495092388803:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495092388808:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495092388810:selected_customer <- params$customer
1495092388818:balance <- params$balance
1495092388821:resample <- params$resample
1495092388835:source('global.R')
1495092389152:setEmsTheme(base_size = 12)
1495092389251:# Load incentive history
1495092389253:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495092392245:n_bins <- 4
1495092392249:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495092392674:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495092392693:selected_time_window <- ifelse(
1495092392694:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495092392695:ATTRIBUTION_TIME_WINDOW,
1495092392697:customer_settings[[selected_customer]]$incentive_expiration_days
1495092392698:)
1495092392702:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1495092392704:recom_history, purchases,
1495092392705:source = 'si',
1495092392707:method = 'time',
1495092392708:time_window = selected_time_window
1495092392709:)
1495092395261:if (balance == TRUE) {
1495092395262:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495092395264:} else {
1495092395265:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495092395266:}
1495092395278:if (resample == TRUE) {
1495092395279:recom_history_w_attributions[, sampling_weight := weights/.N]
1495092395280:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1495092395282:recom_history_w_attributions[, weights := 1]
1495092395283:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1495092395285:}
1495092395291:options(scipen=999)
1495092395293:recom_history_w_attributions %>%
1495092395294:.[, .(sum = .N), by = .(campaign_start_date, incentive_class)] %>%
1495092395296:plotSumsBy() %>%
1495092395297:facetBy("campaign_start_date", label = 'Number of contacts')
1495092395822:recom_history_w_attributions[incentive_class == 'smart', .(sum = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495092395823:plotSumsBy('incentive_value') %>%
1495092395825:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495092396540:recom_history_w_attributions %>%
1495092396542:calculateRateWithErrors(variable = 'did_open') %>%
1495092396544:plotRatesBy() %>%
1495092396545:facetBy(label = 'Open rate')
1495092499124:recom_history_w_attributions %>% calculateRateWithErrors(variable = 'did_open')
1495092503274:recom_history_w_attributions %>% calculateRateWithErrors(variable = 'did_open') %>% .[]
1495092516228:recom_history_w_attributions %>% calculateRateWithErrors(variable = 'did_open') %>% .[] %>% plotMeansBy()
1495092531879:source('global.R')
1495092533117:recom_history_w_attributions %>% calculateRateWithErrors(variable = 'did_open') %>% .[] %>% plotMeansBy()
1495092550543:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495092550546:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495092550548:selected_customer <- params$customer
1495092550551:balance <- params$balance
1495092550553:resample <- params$resample
1495092550569:source('global.R')
1495092550677:setEmsTheme(base_size = 12)
1495092550708:# Load incentive history
1495092550710:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495092553434:n_bins <- 4
1495092553437:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495092553590:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495092554195:selected_time_window <- ifelse(
1495092554197:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495092554198:ATTRIBUTION_TIME_WINDOW,
1495092554199:customer_settings[[selected_customer]]$incentive_expiration_days
1495092554200:)
1495092554203:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1495092554205:recom_history, purchases,
1495092554207:source = 'si',
1495092554208:method = 'time',
1495092554209:time_window = selected_time_window
1495092554211:)
1495092555321:if (balance == TRUE) {
1495092555323:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495092555325:} else {
1495092555326:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495092555328:}
1495092555340:if (resample == TRUE) {
1495092555344:recom_history_w_attributions[, sampling_weight := weights/.N]
1495092555345:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1495092555347:recom_history_w_attributions[, weights := 1]
1495092555349:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1495092555352:}
1495092555360:options(scipen=999)
1495092555362:recom_history_w_attributions %>%
1495092555364:.[, .(sum = .N), by = .(campaign_start_date, incentive_class)] %>%
1495092555365:plotSumsBy() %>%
1495092555367:facetBy("campaign_start_date", label = 'Number of contacts')
1495092555900:recom_history_w_attributions[incentive_class == 'smart', .(sum = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495092555901:plotSumsBy('incentive_value') %>%
1495092555903:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495092556608:recom_history_w_attributions %>%
1495092556609:calculateRateWithErrors(variable = 'did_open') %>%
1495092556611:plotMeansBy() %>%
1495092556612:facetBy(label = 'Open rate')
1495092557251:recom_history_w_attributions %>%
1495092557253:calculateRateWithErrors(variable = 'did_open', by = 'campaign_start_date') %>%
1495092557255:plotMeansBy() %>%
1495092557256:facetBy('campaign_start_date', label = 'Open rate')
1495092558015:recom_history_w_attributions %>%
1495092558016:calculateRateWithErrors(variable = 'did_open', by = 'prob_group') %>%
1495092558018:plotMeansBy() %>%
1495092558020:facetBy('prob_group', label = 'Open rate', nrow = 1)
1495092559362:recom_history_w_attributions %>%
1495092559364:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1495092559365:plotMeansBy("incentive_content") %>%
1495092559367:facetBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1495092560341:top_domains <- recom_history_w_attributions %>%
1495092560342:.[, .(count = .N), by = domain] %>%
1495092560344:.[order(-count)] %>%
1495092560345:.[count > 10000, domain] %>%
1495092560346:head(10)
1495092560386:recom_history_w_attributions[domain %in% top_domains] %>%
1495092560390:calculateRateWithErrors(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1495092560393:plotMeansBy("domain", label = FALSE, legend = TRUE) %>%
1495092560394:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1495092561477:recom_history_w_attributions[did_open == TRUE] %>%
1495092561479:calculateRateWithErrors(variable = 'did_click') %>%
1495092561480:plotMeansBy() %>%
1495092561481:facetBy(label = 'Click-through rate')
1495092561993:recom_history_w_attributions[did_open == TRUE] %>%
1495092561995:calculateRateWithErrors(variable = 'did_click', by = 'campaign_start_date') %>%
1495092561996:plotMeansBy() %>%
1495092561997:facetBy('campaign_start_date', label = 'Click-through rate')
1495092562795:recom_history_w_attributions[did_open == TRUE] %>%
1495092562797:calculateRateWithErrors(variable = 'did_click', by = 'prob_group') %>%
1495092562799:plotMeansBy() %>%
1495092562800:facetBy('prob_group', label = 'Click-through rate', nrow = 1)
1495092564021:recom_history_w_attributions[did_open == TRUE] %>%
1495092564022:calculateRateWithErrors(variable = 'did_click', by = c('campaign_start_date', 'incentive_content')) %>%
1495092564024:plotMeansBy("incentive_content") %>%
1495092564025:facetBy('campaign_start_date', label = 'Click rate', ncol = 1, scales = "free")
1495092564832:# Load predict data
1495092564833:try(predict_data <- getWebData(
1495092564834:selected_customer,
1495092564836:events_to_ignore = customer_settings[[selected_customer]]$predict_missing_fields
1495092564838:))
1495092564853:if (exists('predict_data')) {
1495092564856:# Calculate web numbers & merge (30 day attribution)
1495092564857:daily_visits <- predict_data %>%
1495092564859:.[, .(contact_id, day = as.Date(timestamp))] %>%
1495092564861:unique()
1495092564862:daily_visits[, join_date := day]
1495092564864:recom_history_w_attributions[, join_date := campaign_start_date]
1495092564866:setkeyv(daily_visits, c('contact_id', 'join_date'))
1495092564868:setkeyv(recom_history_w_attributions, c('contact_id', 'join_date'))
1495092564870:merged <- recom_history_w_attributions[daily_visits, roll = 7] %>%
1495092564874:.[, .(num_visit = .N), by = .(contact_id, campaign_id)]
1495092564876:recom_history_w_visits <- merge(
1495092564877:recom_history_w_attributions,
1495092564879:merged,
1495092564880:by = c('contact_id', 'campaign_id'),
1495092564882:all.x = TRUE
1495092564884:)
1495092564885:}
1495092564892:if (exists('predict_data')) {
1495092564893:recom_history_w_visits %>%
1495092564895:calculateRateWithErrors(variable = 'num_visit') %>%
1495092564896:plotMeansBy() %>%
1495092564897:facetBy(label = 'Web visit rate')
1495092564899:}
1495092564910:if (exists('predict_data')) {
1495092564911:recom_history_w_visits %>%
1495092564913:calculateRateWithErrors(variable = 'num_visit', by = 'campaign_start_date') %>%
1495092564914:plotMeansBy() %>%
1495092564915:facetBy('campaign_start_date', label = 'Web visit rate')
1495092564917:}
1495092564924:if (exists('predict_data')) {
1495092564926:recom_history_w_visits %>%
1495092564928:calculateRateWithErrors(variable = 'num_visit', by = 'prob_group') %>%
1495092564929:plotMeansBy() %>%
1495092564930:facetBy('prob_group', label = 'Web visit rate', nrow = 1)
1495092564932:}
1495092564939:recom_history_w_attributions[did_click == TRUE] %>%
1495092564941:calculateRateWithErrors(variable = 'did_buy') %>%
1495092564943:plotMeansBy() %>%
1495092564945:facetBy(label = 'Purchase rate')
1495092565461:recom_history_w_attributions[did_click == TRUE] %>%
1495092565463:calculateRateWithErrors(variable = 'did_buy', by = 'campaign_start_date') %>%
1495092565464:plotMeansBy() %>%
1495092565465:facetBy('campaign_start_date', label = 'Purchase rate')
1495092566214:recom_history_w_attributions[did_click == TRUE] %>%
1495092566216:calculateRateWithErrors(variable = 'did_buy', by = 'prob_group') %>%
1495092566217:plotMeansBy() %>%
1495092566219:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495092567473:recom_history_w_attributions[did_click == TRUE] %>%
1495092567474:calculateRateWithErrors(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495092567475:plotMeansBy("incentive_content") %>%
1495092567477:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495092568363:recom_history_w_attributions[did_open == TRUE] %>%
1495092568364:calculateRateWithErrors(variable = 'did_buy') %>%
1495092568365:plotMeansBy() %>%
1495092568367:facetBy(label = 'Purchase rate')
1495092568883:recom_history_w_attributions[did_open == TRUE] %>%
1495092568885:calculateRateWithErrors(variable = 'did_buy', by = 'campaign_start_date') %>%
1495092568886:plotMeansBy() %>%
1495092568888:facetBy('campaign_start_date', label = 'Purchase rate')
1495092569693:recom_history_w_attributions[did_open == TRUE] %>%
1495092569695:calculateRateWithErrors(variable = 'did_buy', by = 'prob_group') %>%
1495092569697:plotMeansBy() %>%
1495092569699:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495092570995:recom_history_w_attributions[did_open == TRUE] %>%
1495092570997:calculateRateWithErrors(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495092570998:plotMeansBy("incentive_content") %>%
1495092570999:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495092571881:recom_history_w_attributions %>%
1495092571882:calculateRateWithErrors(variable = 'did_buy') %>%
1495092571883:plotMeansBy() %>%
1495092571884:facetBy(label = 'Purchase rate')
1495092572506:recom_history_w_attributions %>%
1495092572508:calculateRateWithErrors(variable = 'did_buy', by = 'campaign_start_date') %>%
1495092572509:plotMeansBy() %>%
1495092572511:facetBy('campaign_start_date', label = 'Purchase rate')
1495092573476:recom_history_w_attributions %>%
1495092573478:calculateRateWithErrors(variable = 'did_buy', by = 'prob_group') %>%
1495092573479:plotMeansBy() %>%
1495092573480:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495092574930:recom_history_w_attributions %>%
1495092574932:calculateRateWithErrors(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495092574933:plotMeansBy("incentive_content") %>%
1495092574934:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495092575895:recom_history_w_attributions %>%
1495092575897:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495092575899:plotSumsBy() %>%
1495092575900:facetBy("campaign_start_date", label = 'Total revenue')
1495092576525:recom_history_w_attributions %>%
1495092576527:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1495092576529:plotSumsBy() %>%
1495092576531:facetBy(label = 'Total revenue')
1495092576912:recom_history_w_attributions %>%
1495092576914:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495092576915:plotSumsBy() %>%
1495092576917:facetBy('prob_group', label = 'Total revenue', nrow = 1)
1495092578025:fillZerosForNA_(recom_history_w_attributions, cols = 'sales_amount')
1495092578119:recom_history_w_attributions %>%
1495092578121:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495092578122:plotSumsBy() %>%
1495092578124:facetBy("campaign_start_date", label = 'Revenue per person')
1495092578790:recom_history_w_attributions %>%
1495092578792:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1495092578793:plotSumsBy() %>%
1495092578795:facetBy(label = 'Revenue per person')
1495092579209:recom_history_w_attributions %>%
1495092579211:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495092579213:plotSumsBy() %>%
1495092579215:facetBy('prob_group', label = 'Revenue per person', nrow = 1)
1495092580365:recom_history_w_attributions %>%
1495092580366:.[sales_amount > 0] %>%
1495092580368:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495092580369:plotSumsBy() %>%
1495092580370:facetBy("campaign_start_date", label = 'Avg cart value per person')
1495092580928:recom_history_w_attributions %>%
1495092580930:.[sales_amount > 0] %>%
1495092580932:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1495092580933:plotSumsBy() %>%
1495092580934:facetBy(label = 'Avg cart value per person')
1495092581338:recom_history_w_attributions %>%
1495092581340:.[sales_amount > 0] %>%
1495092581341:.[, .(sum = mean(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495092581342:plotSumsBy() %>%
1495092581344:facetBy('prob_group', label = 'Avg cart value per person', nrow = 1)
1495092582333:recom_history_w_attributions %>%
1495092582334:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495092582335:plotSumsBy() %>%
1495092582336:facetBy("campaign_start_date", label = 'Total revenue')
1495092583049:recom_history_w_attributions %>%
1495092583050:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495092583051:plotSumsBy() %>%
1495092583053:facetBy('prob_group', label = 'Total revenue', nrow = 1)
1495092584149:recom_history_w_attributions %>%
1495092584151:.[, .(sum = sum(net_profit*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495092584152:plotSumsBy() %>%
1495092584153:facetBy("campaign_start_date", label = 'Total net revenue')
1495092657215:recom_history_w_attributions %>%
1495092657216:calculateMeanWithErrors(variable = 'sales_amount') %>%
1495092657216:plotMeanWithErrorBy() %>%
1495092657217:facetBy(label = 'Revenue per person')
1495092711703:calculateRateWithErrors <- function(history, variable, error = 0.05, by = NULL, method = c('bayesian', 'frequentist'), alpha_prior = 0.5, beta_prior = 0.5) {
1495092711704:if (!is.null(by)) {
1495092711705:by = c('incentive_class', by)
1495092711705:} else {
1495092711705:by = 'incentive_class'
1495092711706:}
1495092711706:if (method == 'bayesian') {
1495092711706:history %>%
1495092711707:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by] %>%
1495092711707:.[, `:=`(
1495092711707:alpha = alpha_prior + num_variable,
1495092711708:beta = beta_prior + N - num_variable
1495092711708:)] %>%
1495092711709:.[, `:=`(
1495092711709:EV_lower = qbeta(error, alpha, beta),
1495092711709:EV = alpha / (alpha + beta),
1495092711710:EV_higher = qbeta(1 - error, alpha, beta)
1495092711710:)]
1495092711711:} else {
1495092711711:history %>%
1495092711712:.[, .(
1495092711712:count = .N,
1495092711714:EV = mean(get(variable)*weights, na.rm = TRUE),
1495092711715:sd = sd(get(variable)*weights, na.rm = TRUE)
1495092711716:)] %>%
1495092711716:.[,
1495092711717:.(
1495092711717:EV_lower = EV - qt(1 - error, df = .N - 1)*sd/sqrt(.N),
1495092711718:EV_higher = value + qt(1 - error, df = .N - 1)*sd/sqrt(.N)
1495092711719:),
1495092711719:by = by
1495092711720:]
1495092711720:}
1495092711721:}
1495092722035:recom_history_w_attributions %>%
1495092722037:calculateRateWithErrors(variable = 'did_open') %>%
1495092722038:plotMeansBy() %>%
1495092722039:facetBy(label = 'Open rate')
1495092833803:calculateRateWithErrors <- function(history, variable, error = 0.05, by = NULL, method = 'bayesian', alpha_prior = 0.5, beta_prior = 0.5) {
1495092833805:if (!is.null(by)) {
1495092833805:by = c('incentive_class', by)
1495092833806:} else {
1495092833806:by = 'incentive_class'
1495092833807:}
1495092833807:if (method == 'bayesian') {
1495092833807:history %>%
1495092833808:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by] %>%
1495092833808:.[, `:=`(
1495092833808:alpha = alpha_prior + num_variable,
1495092833809:beta = beta_prior + N - num_variable
1495092833809:)] %>%
1495092833810:.[, `:=`(
1495092833810:EV_lower = qbeta(error, alpha, beta),
1495092833810:EV = alpha / (alpha + beta),
1495092833811:EV_higher = qbeta(1 - error, alpha, beta)
1495092833811:)]
1495092833811:} else if (method == 'frequentist') {
1495092833812:history %>%
1495092833812:.[, .(
1495092833813:count = .N,
1495092833813:EV = mean(get(variable)*weights, na.rm = TRUE),
1495092833814:sd = sd(get(variable)*weights, na.rm = TRUE)
1495092833814:)] %>%
1495092833815:.[,
1495092833816:.(
1495092833817:EV_lower = EV - qt(1 - error, df = .N - 1)*sd/sqrt(.N),
1495092833817:EV_higher = value + qt(1 - error, df = .N - 1)*sd/sqrt(.N)
1495092833818:),
1495092833819:by = by
1495092833820:]
1495092833821:} else {
1495092833823:stop(paste('Invalid method', method, '- it should be either bayesian or frequentist'))
1495092833824:}
1495092833825:}
1495092843497:recom_history_w_attributions %>%
1495092843498:calculateRateWithErrors(variable = 'did_open') %>%
1495092843499:plotMeansBy() %>%
1495092843501:facetBy(label = 'Open rate')
1495092866918:recom_history_w_attributions %>%
1495092866920:calculateRateWithErrors(variable = 'did_open', method = 'frequentist') %>%
1495092866921:plotMeansBy() %>%
1495092866922:facetBy(label = 'Open rate')
1495092922565:calculateRateWithErrors <- function(history, variable, error = 0.05, by = NULL, method = 'bayesian', alpha_prior = 0.5, beta_prior = 0.5) {
1495092922566:if (!is.null(by)) {
1495092922567:by = c('incentive_class', by)
1495092922568:} else {
1495092922568:by = 'incentive_class'
1495092922569:}
1495092922569:if (method == 'bayesian') {
1495092922570:history %>%
1495092922571:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by] %>%
1495092922572:.[, `:=`(
1495092922572:alpha = alpha_prior + num_variable,
1495092922573:beta = beta_prior + N - num_variable
1495092922573:)] %>%
1495092922574:.[, `:=`(
1495092922574:EV_lower = qbeta(error, alpha, beta),
1495092922575:EV = alpha / (alpha + beta),
1495092922576:EV_higher = qbeta(1 - error, alpha, beta)
1495092922577:)]
1495092922578:} else if (method == 'frequentist') {
1495092922579:history %>%
1495092922580:.[, .(
1495092922581:count = .N,
1495092922581:EV = mean(get(variable)*weights, na.rm = TRUE),
1495092922582:sd = sd(get(variable)*weights, na.rm = TRUE)
1495092922583:), by = by] %>%
1495092922583:.[, .(
1495092922584:EV_lower = EV - qt(1 - error, df = count - 1)*sd/sqrt(count),
1495092922584:EV_higher = value + qt(1 - error, df = count - 1)*sd/sqrt(count)
1495092922585:)]
1495092922585:} else {
1495092922586:stop(paste('Invalid method', method, '- it should be either bayesian or frequentist'))
1495092922587:}
1495092922590:}
1495092929274:recom_history_w_attributions %>%
1495092929276:calculateRateWithErrors(variable = 'did_open', method = 'frequentist') %>%
1495092929277:plotMeansBy() %>%
1495092929279:facetBy(label = 'Open rate')
1495092950421:recom_history_w_attributions %>%
1495092950423:calculateRateWithErrors(variable = 'did_open', method = 'frequentist')
1495092972277:calculateRateWithErrors <- function(history, variable, error = 0.05, by = NULL, method = 'bayesian', alpha_prior = 0.5, beta_prior = 0.5) {
1495092972278:if (!is.null(by)) {
1495092972279:by = c('incentive_class', by)
1495092972279:} else {
1495092972280:by = 'incentive_class'
1495092972280:}
1495092972280:if (method == 'bayesian') {
1495092972280:history %>%
1495092972281:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by] %>%
1495092972281:.[, `:=`(
1495092972282:alpha = alpha_prior + num_variable,
1495092972282:beta = beta_prior + N - num_variable
1495092972282:)] %>%
1495092972283:.[, `:=`(
1495092972283:EV_lower = qbeta(error, alpha, beta),
1495092972283:EV = alpha / (alpha + beta),
1495092972284:EV_higher = qbeta(1 - error, alpha, beta)
1495092972284:)]
1495092972285:} else if (method == 'frequentist') {
1495092972285:history %>%
1495092972285:.[, .(
1495092972286:count = .N,
1495092972286:EV = mean(get(variable)*weights, na.rm = TRUE),
1495092972287:sd = sd(get(variable)*weights, na.rm = TRUE)
1495092972287:), by = by] %>%
1495092972288:.[, .(
1495092972288:EV_lower = EV - qt(1 - error, df = count - 1)*sd/sqrt(count),
1495092972289:EV_higher = EV + qt(1 - error, df = count - 1)*sd/sqrt(count)
1495092972291:)]
1495092972292:} else {
1495092972293:stop(paste('Invalid method', method, '- it should be either bayesian or frequentist'))
1495092972295:}
1495092972296:}
1495092975900:recom_history_w_attributions %>%
1495092975902:calculateRateWithErrors(variable = 'did_open', method = 'frequentist') %>%
1495092975903:plotMeansBy() %>%
1495092975906:facetBy(label = 'Open rate')
1495093008390:recom_history_w_attributions %>%
1495093008391:calculateRateWithErrors(variable = 'did_open', method = 'frequentist') %>% .[]
1495093036170:calculateRateWithErrors <- function(history, variable, error = 0.05, by = NULL, method = 'bayesian', alpha_prior = 0.5, beta_prior = 0.5) {
1495093036171:if (!is.null(by)) {
1495093036172:by = c('incentive_class', by)
1495093036172:} else {
1495093036173:by = 'incentive_class'
1495093036173:}
1495093036173:if (method == 'bayesian') {
1495093036174:history %>%
1495093036174:.[, .(N = sum(weights, na.rm = TRUE), num_variable = sum(get(variable)*weights, na.rm = TRUE)), by = by] %>%
1495093036175:.[, `:=`(
1495093036175:alpha = alpha_prior + num_variable,
1495093036176:beta = beta_prior + N - num_variable
1495093036177:)] %>%
1495093036177:.[, `:=`(
1495093036179:EV_lower = qbeta(error, alpha, beta),
1495093036180:EV = alpha / (alpha + beta),
1495093036182:EV_higher = qbeta(1 - error, alpha, beta)
1495093036182:)]
1495093036183:} else if (method == 'frequentist') {
1495093036184:history %>%
1495093036184:.[, .(
1495093036185:count = .N,
1495093036185:EV = mean(get(variable)*weights, na.rm = TRUE),
1495093036186:sd = sd(get(variable)*weights, na.rm = TRUE)
1495093036186:), by = by] %>%
1495093036187:.[, `:=`(
1495093036187:EV_lower = EV - qt(1 - error, df = count - 1)*sd/sqrt(count),
1495093036188:EV_higher = EV + qt(1 - error, df = count - 1)*sd/sqrt(count)
1495093036189:)]
1495093036189:} else {
1495093036189:stop(paste('Invalid method', method, '- it should be either bayesian or frequentist'))
1495093036190:}
1495093036191:}
1495093038827:recom_history_w_attributions %>%
1495093038829:calculateRateWithErrors(variable = 'did_open', method = 'frequentist') %>%
1495093038832:plotMeansBy() %>%
1495093038834:facetBy(label = 'Open rate')
1495093049008:recom_history_w_attributions %>%
1495093049011:calculateRateWithErrors(variable = 'did_open') %>%
1495093049014:plotMeansBy() %>%
1495093049016:facetBy(label = 'Open rate')
1495093068872:recom_history_w_attributions %>%
1495093068874:calculateRateWithErrors(variable = 'sales_amount', method = 'frequentist') %>%
1495093068875:plotMeanWithErrorBy() %>%
1495093068877:facetBy(label = 'Revenue per person')
1495093286608:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495093286610:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495093286612:selected_customer <- params$customer
1495093286616:balance <- params$balance
1495093286618:resample <- params$resample
1495093288545:source('global.R')
1495093288673:setEmsTheme(base_size = 12)
1495093288703:# Load incentive history
1495093288705:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495093291333:n_bins <- 4
1495093291336:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495093291580:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495093292699:selected_time_window <- ifelse(
1495093292701:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495093292703:ATTRIBUTION_TIME_WINDOW,
1495093292704:customer_settings[[selected_customer]]$incentive_expiration_days
1495093292706:)
1495093292711:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1495093292712:recom_history, purchases,
1495093292714:source = 'si',
1495093292715:method = 'time',
1495093292717:time_window = selected_time_window
1495093292718:)
1495093295245:if (balance == TRUE) {
1495093295247:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495093295248:} else {
1495093295249:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495093295251:}
1495093297710:if (resample == TRUE) {
1495093297712:recom_history_w_attributions[, sampling_weight := weights/.N]
1495093297713:recom_history_w_attributions <- recom_history_w_attributions[!is.na(weights)][sample(1:.N, prob = sampling_weight, replace = TRUE)]
1495093297715:recom_history_w_attributions[, weights := 1]
1495093297716:recom_history_w_attributions[order(buying_probability), prob_group := ceiling(n_bins * (1:.N / .N)), by = campaign_start_date]
1495093297718:}
1495093301070:options(scipen=999)
1495093301071:recom_history_w_attributions %>%
1495093301073:.[, .(sum = .N), by = .(campaign_start_date, incentive_class)] %>%
1495093301074:plotSumsBy() %>%
1495093301076:facetBy("campaign_start_date", label = 'Number of contacts')
1495093301671:recom_history_w_attributions[incentive_class == 'smart', .(sum = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495093301673:plotSumsBy('incentive_value') %>%
1495093301674:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495093307901:recom_history_w_attributions %>%
1495093307903:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495093307906:plotMeansBy() %>%
1495093307908:facetBy(label = 'Open rate')
1495093311933:recom_history_w_attributions %>%
1495093311935:calculateRateWithErrorsBayesian(variable = 'did_open', by = 'campaign_start_date') %>%
1495093311937:plotMeansBy() %>%
1495093311938:facetBy('campaign_start_date', label = 'Open rate')
1495093343711:recom_history_w_attributions %>%
1495093343713:calculateMeanWithErrorsFrequentist(variable = 'did_open', by = 'campaign_start_date') %>%
1495093343714:plotMeansBy() %>%
1495093343715:facetBy('campaign_start_date', label = 'Open rate')
1495093363843:recom_history_w_attributions %>%
1495093363845:calculateRateWithErrorsBayesian(variable = 'did_open', by = 'prob_group') %>%
1495093363847:plotMeansBy() %>%
1495093363849:facetBy('prob_group', label = 'Open rate', nrow = 1)
1495093368161:recom_history_w_attributions %>%
1495093368162:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1495093368163:plotMeansBy("incentive_content") %>%
1495093368166:facetBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1495093372219:top_domains <- recom_history_w_attributions %>%
1495093372221:.[, .(count = .N), by = domain] %>%
1495093372222:.[order(-count)] %>%
1495093372224:.[count > 10000, domain] %>%
1495093372226:head(10)
1495093372270:recom_history_w_attributions[domain %in% top_domains] %>%
1495093372271:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1495093372273:plotMeansBy("domain", label = FALSE, legend = TRUE) %>%
1495093372275:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1495093376477:recom_history_w_attributions[did_open == TRUE] %>%
1495093376479:calculateRateWithErrorsBayesian(variable = 'did_click') %>%
1495093376480:plotMeansBy() %>%
1495093376482:facetBy(label = 'Click-through rate')
1495093391620:recom_history_w_attributions %>%
1495093391622:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495093391624:plotSumsBy() %>%
1495093391626:facetBy("campaign_start_date", label = 'Total revenue')
1495093402821:recom_history_w_attributions %>%
1495093402822:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1495093402824:plotSumsBy() %>%
1495093402825:facetBy(label = 'Total revenue')
1495093636425:plotMeansBy <- function(rate_by_segments, by = 'incentive_class', label = TRUE, rate = TRUE, legend = FALSE) {
1495093636426:p <- ggplot(rate_by_segments, aes_string(x = by, y = "EV", fill = "incentive_class")) +
1495093636427:geom_bar(stat = 'identity', position = position_dodge(width = NULL)) +
1495093636427:geom_linerange(aes(ymin = EV_lower, ymax = EV_higher), position = position_dodge(width = 0.9)) +
1495093636428:scale_y_continuous(limits = c(0, NA), labels = scales::percent)
1495093636428:if (label) {
1495093636428:if (rate) {
1495093636429:p <- p + geom_label(aes(label = scales::percent(EV)), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495093636429:} else {
1495093636430:p <- p + geom_label(aes(label = prettyNum(EV, big.mark = ',')), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495093636430:}
1495093636431:}
1495093636431:if (!legend) {
1495093636432:p <- p + theme(legend.position = 'none')
1495093636432:}
1495093636433:p
1495093636434:}
1495095513938:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495095514311:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495095514315:selected_customer <- params$customer
1495095514320:balance <- params$balance
1495095514325:resample <- params$resample
1495095516451:source('global.R')
1495095525967:getwd()
1495095564278:dir()
1495095751070:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495095751114:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495095751137:selected_customer <- params$customer
1495095751160:balance <- params$balance
1495095751205:resample <- params$resample
1495095752904:source('global.R')
1495095756236:setEmsTheme(base_size = 12)
1495095756303:# Load incentive history
1495095756305:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495095760914:n_bins <- 4
1495095760916:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495095761357:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495095763546:selected_time_window <- ifelse(
1495095763548:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495095763549:ATTRIBUTION_TIME_WINDOW,
1495095763551:customer_settings[[selected_customer]]$incentive_expiration_days
1495095763553:)
1495095763557:recom_history_w_attributions <- attributePurchasesToRecomHistory(
1495095763559:recom_history, purchases,
1495095763560:source = 'si',
1495095763563:method = 'time',
1495095763565:time_window = selected_time_window
1495095763567:)
1495095767938:if (balance == TRUE) {
1495095767940:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495095767943:} else {
1495095767945:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495095767946:}
1495095776298:options(scipen=999)
1495095776300:recom_history_w_attributions %>%
1495095776302:.[, .(sum = .N), by = .(campaign_start_date, incentive_class)] %>%
1495095776304:plotSumsBy() %>%
1495095776306:facetBy("campaign_start_date", label = 'Number of contacts')
1495095796735:options(scipen=999)
1495095796736:recom_history_w_attributions %>%
1495095796738:.[, .(value = .N), by = .(campaign_start_date, incentive_class)] %>%
1495095796740:plotValueBy(error = FALSE) %>%
1495095796742:facetBy("campaign_start_date", label = 'Number of contacts')
1495095816325:options(scipen=999)
1495095816327:recom_history_w_attributions %>%
1495095816328:.[, .(value = .N), by = .(campaign_start_date, incentive_class)] %>%
1495095816330:plotValuesBy(error = FALSE) %>%
1495095816332:facetBy("campaign_start_date", label = 'Number of contacts')
1495095817250:recom_history_w_attributions[incentive_class == 'smart', .(value = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495095817251:plotValuesBy('incentive_value', error = FALSE) %>%
1495095817253:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495095840921:options(scipen=999)
1495095840923:recom_history_w_attributions %>%
1495095840924:.[, .(value = .N), by = .(campaign_start_date, incentive_class)] %>%
1495095840926:plotValuesBy(error = FALSE, rate = FALSE) %>%
1495095840928:facetBy("campaign_start_date", label = 'Number of contacts')
1495095841469:recom_history_w_attributions[incentive_class == 'smart', .(value = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495095841470:plotValuesBy('incentive_value', error = FALSE, rate = FALSE) %>%
1495095841471:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495095916914:plotValuesBy <- function(rate_by_segments, by = 'incentive_class', error = TRUE, label = TRUE, rate = FALSE, legend = FALSE) {
1495095916916:p <- ggplot(rate_by_segments, aes_string(x = by, y = "value", fill = "incentive_class")) +
1495095916917:geom_bar(stat = 'identity', position = position_dodge(width = NULL)) +
1495095916918:scale_y_continuous(limits = c(0, NA), labels = scales::percent)
1495095916919:if (error) {
1495095916920:p <- geom_linerange(aes(ymin = value_lower, ymax = value_higher), position = position_dodge(width = 0.9))
1495095916921:}
1495095916921:if (label) {
1495095916922:if (rate) {
1495095916923:p <- p + geom_label(aes(label = scales::percent(value)), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495095916924:} else {
1495095916925:p <- p + geom_label(aes(label = prettyNum(value, big.mark = ',')), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495095916926:}
1495095916927:}
1495095916928:if (!legend) {
1495095916929:p <- p + theme(legend.position = 'none')
1495095916930:}
1495095916931:p
1495095916932:}
1495095923822:options(scipen=999)
1495095923824:recom_history_w_attributions %>%
1495095923825:.[, .(value = .N), by = .(campaign_start_date, incentive_class)] %>%
1495095923827:plotValuesBy(error = FALSE) %>%
1495095923829:facetBy("campaign_start_date", label = 'Number of contacts')
1495095924399:recom_history_w_attributions[incentive_class == 'smart', .(value = .N), keyby = .(campaign_start_date, incentive_class, incentive_value)] %>%
1495095924400:plotValuesBy('incentive_value', error = FALSE) %>%
1495095924402:facetBy('campaign_start_date', label = 'Sends', ncol = 1, scales = 'fix')
1495095936425:recom_history_w_attributions %>%
1495095936427:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495095936428:plotValuesBy() %>%
1495095936430:facetBy(label = 'Open rate')
1495095997972:recom_history_w_attributions %>%
1495095997973:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495095997975:plotValuesBy(rate = TRUE) %>%
1495095997977:facetBy(label = 'Open rate')
1495096008698:recom_history_w_attributions %>%
1495096008699:calculateRateWithErrorsBayesian(variable = 'did_open')
1495096012797:recom_history_w_attributions %>%
1495096013798:calculateRateWithErrorsBayesian(variable = 'did_open')
1495096017373:recom_history_w_attributions %>%
1495096020042:calculateRateWithErrorsBayesian(variable = 'did_open') %>% .[]
1495096029262:recom_history_w_attributions %>%
1495096034444:calculateRateWithErrorsBayesian(variable = 'did_open') %>% .[] -> cucc
1495096035567:cucc
1495096041560:plotValuesBy(cucc)
1495096061598:plotValuesBy <- function(rate_by_segments, by = 'incentive_class', error = TRUE, label = TRUE, rate = FALSE, legend = FALSE) {
1495096061599:p <- ggplot(rate_by_segments, aes_string(x = by, y = "value", fill = "incentive_class")) +
1495096061599:geom_bar(stat = 'identity', position = position_dodge(width = NULL)) +
1495096061600:scale_y_continuous(limits = c(0, NA), labels = scales::percent)
1495096061600:if (error) {
1495096061601:p <- p + geom_linerange(aes(ymin = value_lower, ymax = value_higher), position = position_dodge(width = 0.9))
1495096061601:}
1495096061602:if (label) {
1495096061603:if (rate) {
1495096061603:p <- p + geom_label(aes(label = scales::percent(value)), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495096061604:} else {
1495096061604:p <- p + geom_label(aes(label = prettyNum(value, big.mark = ',')), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495096061605:}
1495096061606:}
1495096061607:if (!legend) {
1495096061608:p <- p + theme(legend.position = 'none')
1495096061610:}
1495096061612:p
1495096061613:}
1495096064077:plotValuesBy(cucc)
1495096068106:recom_history_w_attributions %>%
1495096068108:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495096068109:plotValuesBy(rate = TRUE) %>%
1495096068111:facetBy(label = 'Open rate')
1495096074844:recom_history_w_attributions %>%
1495096074846:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495096074847:plotValuesBy(rate = TRUE) %>%
1495096074849:facetBy(label = 'Open rate')
1495096253678:plotValuesBy <- function(rate_by_segments, by = 'incentive_class', error = TRUE, label = TRUE, rate = FALSE, legend = FALSE) {
1495096253679:p <- ggplot(rate_by_segments, aes_string(x = by, y = "value", fill = "incentive_class")) +
1495096253679:geom_bar(stat = 'identity', position = position_dodge(width = NULL))
1495096253680:if (rate) {
1495096253680:p <- p + scale_y_continuous(limits = c(0, NA), labels = scales::percent)
1495096253681:} else {
1495096253682:p <- p + scale_y_continuous(limits = c(0, NA), labels = scales::comma)
1495096253683:}
1495096253684:if (error) {
1495096253685:p <- p + geom_linerange(aes(ymin = value_lower, ymax = value_higher), position = position_dodge(width = 0.9))
1495096253686:}
1495096253686:if (label) {
1495096253687:if (rate) {
1495096253688:p <- p + geom_label(aes(label = scales::percent(value)), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495096253689:} else {
1495096253689:p <- p + geom_label(aes(label = prettyNum(value, big.mark = ',')), family = 'Canaro Medium', position = position_dodge(width = 0.9))
1495096253690:}
1495096253690:}
1495096253691:if (!legend) {
1495096253692:p <- p + theme(legend.position = 'none')
1495096253693:}
1495096253693:p
1495096253694:}
1495096298321:recom_history_w_attributions %>%
1495096298323:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495096298324:plotValuesBy(rate = TRUE) %>%
1495096298327:facetBy(label = 'Open rate')
1495096303265:recom_history_w_attributions %>%
1495096303267:calculateRateWithErrorsBayesian(variable = 'did_open', by = 'campaign_start_date') %>%
1495096303268:plotValuesBy(rate = TRUE) %>%
1495096303270:facetBy('campaign_start_date', label = 'Open rate')
1495096323211:recom_history_w_attributions %>%
1495096323212:calculateMeanWithErrorsFrequentist(variable = 'did_open', by = 'campaign_start_date') %>%
1495096323213:plotValuesBy(rate = TRUE) %>%
1495096323215:facetBy('campaign_start_date', label = 'Open rate')
1495096340067:recom_history_w_attributions %>%
1495096340071:calculateRateWithErrorsBayesian(variable = 'did_open', by = 'prob_group') %>%
1495096340074:plotValuesBy(rate = TRUE) %>%
1495096340077:facetBy('prob_group', label = 'Open rate', nrow = 1)
1495096343905:recom_history_w_attributions %>%
1495096343906:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1495096343908:plotValuesBy("incentive_content", rate = TRUE) %>%
1495096343910:facetBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1495096389277:recom_history_w_attributions %>%
1495096389279:calculateMeanWithErrorsFrequentist(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1495096389280:plotValuesBy("incentive_content", rate = TRUE) %>%
1495096389282:facetBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1495096405482:recom_history_w_attributions %>%
1495096405483:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'incentive_content')) %>%
1495096405485:plotValuesBy("incentive_content", rate = TRUE) %>%
1495096405486:facetBy('campaign_start_date', label = 'Open rate', ncol = 1, scales = "free")
1495096428665:top_domains <- recom_history_w_attributions %>%
1495096428666:.[, .(count = .N), by = domain] %>%
1495096428667:.[order(-count)] %>%
1495096428669:.[count > 10000, domain] %>%
1495096428670:head(10)
1495096428710:recom_history_w_attributions[domain %in% top_domains] %>%
1495096428712:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1495096428713:plotValuesBy("domain", label = FALSE, legend = TRUE) %>%
1495096428715:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1495096448663:top_domains <- recom_history_w_attributions %>%
1495096448664:.[, .(count = .N), by = domain] %>%
1495096448666:.[order(-count)] %>%
1495096448667:.[count > 10000, domain] %>%
1495096448669:head(10)
1495096448712:recom_history_w_attributions[domain %in% top_domains] %>%
1495096448713:calculateRateWithErrorsBayesian(variable = 'did_open', by = c('campaign_start_date', 'domain')) %>%
1495096448715:plotValuesBy("domain", label = FALSE, rate = TRUE, legend = TRUE) %>%
1495096448716:facetBy('campaign_start_date', label = 'Open rate', scales = 'free', ncol = 1)
1495096562521:recom_history_w_attributions[did_click == TRUE] %>%
1495096562522:calculateRateWithErrorsBayesian(variable = 'did_buy') %>%
1495096562524:plotValuesBy(rate = TRUE) %>%
1495096562526:facetBy(label = 'Purchase rate')
1495096567833:recom_history_w_attributions[did_click == TRUE] %>%
1495096567835:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'campaign_start_date') %>%
1495096567836:plotValuesBy(rate = TRUE) %>%
1495096567838:facetBy('campaign_start_date', label = 'Purchase rate')
1495096583447:recom_history_w_attributions[did_click == TRUE] %>%
1495096583448:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>%
1495096583450:plotValuesBy(rate = TRUE) %>%
1495096583452:facetBy('campaign_start_date', label = 'Purchase rate')
1495096612237:recom_history_w_attributions[did_click == TRUE] %>%
1495096612237:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'campaign_start_date') %>% .{}
1495096615329:recom_history_w_attributions[did_click == TRUE] %>%
1495096615329:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'campaign_start_date') %>% .[]
1495096630370:recom_history_w_attributions[did_click == TRUE] %>%
1495096630371:calculateMeansWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>% .[]
1495096636507:recom_history_w_attributions[did_click == TRUE] %>%
1495096636507:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>% .[]
1495096692276:qt(0.975, 10000)
1495096727351:calculateMeanWithErrorsFrequentist <- function(history, variable, error = 0.05, by = NULL) {
1495096727352:if (!is.null(by)) {
1495096727352:by = c('incentive_class', by)
1495096727353:} else {
1495096727354:by = 'incentive_class'
1495096727355:}
1495096727356:history %>%
1495096727357:.[, .(
1495096727358:count = .N,
1495096727358:value = mean(get(variable)*weights, na.rm = TRUE),
1495096727360:sd = sd(get(variable)*weights, na.rm = TRUE)
1495096727360:), by = by] %>%
1495096727361:.[, `:=`(
1495096727362:value_lower = max(0, value - qt(1 - error, df = count - 1)*sd/sqrt(count)),
1495096727363:value_higher = value + qt(1 - error, df = count - 1)*sd/sqrt(count)
1495096727364:)]
1495096727364:}
1495096741421:recom_history_w_attributions[did_click == TRUE] %>%
1495096741423:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>%
1495096741424:plotValuesBy(rate = TRUE) %>%
1495096741426:facetBy('campaign_start_date', label = 'Purchase rate')
1495096768258:recom_history_w_attributions[did_click == TRUE] %>%
1495096768259:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>% .[]
1495096821052:0.202+1.96*0.1414
1495096916168:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')]
1495096946539:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, .(value_lower = max(0, value - qt(1-0.05, count -1)*sd/sqrt(count.fields())))]
1495096950706:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, .(value_lower = max(0, value - qt(1-0.05, count -1)*sd/sqrt(count))]
1495096970428:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')]
1495096985957:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = 0)]
1495096989098:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = 0)] %>% .[]
1495097007090:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = value - qt(1 - 0.05, df = count - 1))] %>% .[]
1495097018444:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = value - qt(1 - 0.05, df = count - 1)*sd/sqrt(count))] %>% .[]
1495097031141:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = max(0, value - qt(1 - 0.05, df = count - 1)*sd/sqrt(count)))] %>% .[]
1495097035227:?max
1495097052443:recom_history_w_attributions[did_click == TRUE][, .(count = .N, value = mean(did_buy * weights, na.rm = T), sd = sd(did_buy * weights, na.rm = T)), by = c('incentive_class', 'campaign_start_date')][, `:=`(value_lower = pmax(0, value - qt(1 - 0.05, df = count - 1)*sd/sqrt(count)))] %>% .[]
1495097059345:calculateMeanWithErrorsFrequentist <- function(history, variable, error = 0.05, by = NULL) {
1495097059346:if (!is.null(by)) {
1495097059346:by = c('incentive_class', by)
1495097059347:} else {
1495097059347:by = 'incentive_class'
1495097059347:}
1495097059348:history %>%
1495097059348:.[, .(
1495097059349:count = .N,
1495097059349:value = mean(get(variable)*weights, na.rm = TRUE),
1495097059349:sd = sd(get(variable)*weights, na.rm = TRUE)
1495097059350:), by = by] %>%
1495097059350:.[, `:=`(
1495097059350:value_lower = pmax(0, value - qt(1 - error, df = count - 1)*sd/sqrt(count)),
1495097059351:value_higher = value + qt(1 - error, df = count - 1)*sd/sqrt(count)
1495097059351:)]
1495097059352:}
1495097063070:recom_history_w_attributions[did_click == TRUE] %>%
1495097063073:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>%
1495097063075:plotValuesBy(rate = TRUE) %>%
1495097063077:facetBy('campaign_start_date', label = 'Purchase rate')
1495097150645:recom_history_w_attributions[did_click == TRUE] %>%
1495097150647:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495097150648:plotValuesBy(rate = TRUE) %>%
1495097150649:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495097176702:recom_history_w_attributions[did_click == TRUE] %>%
1495097176703:calculateRateWithErrorsBayesian(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495097176705:plotValuesBy("incentive_content", rate = TRUE) %>%
1495097176707:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495097181111:recom_history_w_attributions[did_open == TRUE] %>%
1495097181113:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'campaign_start_date') %>%
1495097181115:plotValuesBy(rate = TRUE) %>%
1495097181117:facetBy('campaign_start_date', label = 'Purchase rate')
1495097184808:recom_history_w_attributions[did_open == TRUE] %>%
1495097184810:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495097184811:plotValuesBy(rate = TRUE) %>%
1495097184813:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495097189174:recom_history_w_attributions[did_open == TRUE] %>%
1495097189176:calculateRateWithErrorsBayesian(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495097189178:plotValuesBy("incentive_content", rate = TRUE) %>%
1495097189180:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495097194165:recom_history_w_attributions %>%
1495097194167:calculateRateWithErrorsBayesian(variable = 'did_buy') %>%
1495097194168:plotValuesBy(rate = TRUE) %>%
1495097194169:facetBy(label = 'Purchase rate')
1495097197057:recom_history_w_attributions %>%
1495097197059:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'campaign_start_date') %>%
1495097197061:plotValuesBy(rate = TRUE) %>%
1495097197062:facetBy('campaign_start_date', label = 'Purchase rate')
1495097200879:recom_history_w_attributions %>%
1495097200881:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495097200882:plotValuesBy(rate = TRUE) %>%
1495097200884:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495097205292:recom_history_w_attributions %>%
1495097205294:calculateRateWithErrorsBayesian(variable = 'did_buy', by = c('campaign_start_date', 'incentive_content')) %>%
1495097205295:plotValuesBy("incentive_content", rate = TRUE) %>%
1495097205297:facetBy('campaign_start_date', label = 'Purchase rate', ncol = 1, scales = "free")
1495097216546:recom_history_w_attributions %>%
1495097216547:.[, .(sum = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495097216549:plotSumsBy() %>%
1495097216550:facetBy("campaign_start_date", label = 'Total revenue')
1495097231215:recom_history_w_attributions %>%
1495097231217:.[, .(value = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495097231218:plotValuesBy() %>%
1495097231219:facetBy("campaign_start_date", label = 'Total revenue')
1495097238675:recom_history_w_attributions %>%
1495097238677:.[, .(value = sum(sales_amount*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495097238678:plotValuesBy(error = FALSE) %>%
1495097238680:facetBy("campaign_start_date", label = 'Total revenue')
1495097255660:recom_history_w_attributions %>%
1495097255661:.[, .(value = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class)] %>%
1495097255663:plotValuesBy(error = FALSE) %>%
1495097255665:facetBy(label = 'Total revenue')
1495097274924:recom_history_w_attributions %>%
1495097274925:.[, .(value = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495097274927:plotValuesBy(error = FALSE) %>%
1495097274928:facetBy('prob_group', label = 'Total revenue', nrow = 1)
1495097351289:recom_history_w_attributions %>%
1495097351290:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097351292:plotValuesBy('campaign_start_date') %>%
1495097351293:facetBy("campaign_start_date", label = 'Revenue per person')
1495097405137:recom_history_w_attributions %>%
1495097405138:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>% .[]
1495097418030:recom_history_w_attributions %>%
1495097418031:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097418033:plotValuesBy('campaign_start_date', label = F) %>%
1495097418034:facetBy("campaign_start_date", label = 'Revenue per person')
1495097437295:recom_history_w_attributions %>%
1495097437296:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097437297:plotValuesBy('campaign_start_date', label = F, rate = T) %>%
1495097437299:facetBy("campaign_start_date", label = 'Revenue per person')
1495097463643:recom_history_w_attributions %>%
1495097463645:calculateMeanWithErrorsFrequentist(variable = 'did_buy', by = 'campaign_start_date') %>%
1495097463646:plotValuesBy('campaign_start_date', label = F, rate = T) %>%
1495097463648:facetBy("campaign_start_date", label = 'Revenue per person')
1495097484589:recom_history_w_attributions %>%
1495097484591:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097484592:plotValuesBy('campaign_start_date', label = F, rate = T) %>%
1495097484595:facetBy("campaign_start_date", label = 'Revenue per person')
1495097503860:recom_history_w_attributions %>%
1495097503861:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097503863:plotValuesBy(label = F, rate = T) %>%
1495097503864:facetBy("campaign_start_date", label = 'Revenue per person')
1495097515212:recom_history_w_attributions %>%
1495097515213:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097515215:plotValuesBy() %>%
1495097515217:facetBy("campaign_start_date", label = 'Revenue per person')
1495097561264:recom_history_w_attributions %>%
1495097561265:calculateMeanWithErrorsFrequentist('sales_amount') %>%
1495097561267:plotSumsBy() %>%
1495097561269:facetBy(label = 'Revenue per person')
1495097571206:recom_history_w_attributions %>%
1495097571208:calculateMeanWithErrorsFrequentist(variable = 'sales_amount') %>%
1495097571209:plotSumsBy() %>%
1495097571211:facetBy(label = 'Revenue per person')
1495097577902:recom_history_w_attributions %>%
1495097577903:calculateMeanWithErrorsFrequentist(variable = 'sales_amount') %>%
1495097577905:plotValuesBy() %>%
1495097577906:facetBy(label = 'Revenue per person')
1495097631057:recom_history_w_attributions %>%
1495097631058:calculateMeanWithErrorsFrequentist('sales_amount', by = 'prob_group') %>%
1495097631060:plotValuesBy() %>%
1495097631061:facetBy('prob_group', label = 'Revenue per person', nrow = 1)
1495097649258:recom_history_w_attributions %>%
1495097649259:calculateRateWithErrorsBayesian(variable = 'sales_amount', method = 'frequentist') %>%
1495097649261:plotMeanWithErrorBy() %>%
1495097649262:facetBy(label = 'Revenue per person')
1495097718615:recom_history_w_attributions[sales_amount > 0] %>%
1495097718617:calculateMeanWithErrorsFrequentist('sales_amount', by = 'campaign_start_date') %>%
1495097718618:plotValuesBy() %>%
1495097718620:facetBy("campaign_start_date", label = 'Avg cart value per person')
1495097739194:recom_history_w_attributions %>%
1495097739195:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097739197:plotValuesBy() %>%
1495097739198:facetBy("campaign_start_date", label = 'Revenue per person')
1495097748641:fillZerosForNA_(recom_history_w_attributions, cols = 'sales_amount')
1495097750349:recom_history_w_attributions %>%
1495097750350:calculateMeanWithErrorsFrequentist(variable = 'sales_amount') %>%
1495097750352:plotValuesBy() %>%
1495097750354:facetBy(label = 'Revenue per person')
1495097754963:recom_history_w_attributions %>%
1495097754964:calculateMeanWithErrorsFrequentist(variable = 'sales_amount', by = 'campaign_start_date') %>%
1495097754966:plotValuesBy() %>%
1495097754967:facetBy("campaign_start_date", label = 'Revenue per person')
1495097786911:recom_history_w_attributions[sales_amount > 0] %>%
1495097786913:calculateMeanWithErrorsFrequentist('sales_amount') %>%
1495097786914:plotValuesBy() %>%
1495097786916:facetBy(label = 'Avg cart value per person')
1495097833649:recom_history_w_attributions[sales_amount > 0] %>%
1495097833651:calculateMeanWithErrorsFrequentist('sales_amount', by = 'prob_group') %>%
1495097833653:plotValuesBy() %>%
1495097833655:facetBy('prob_group', label = 'Avg cart value per person', nrow = 1)
1495097927341:recom_history_w_attributions
1495097930724:recom_history_w_attributions %>% names()
1495099251315:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495099251318:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495099251320:selected_customer <- params$customer
1495099251324:balance <- params$balance
1495099251326:resample <- params$resample
1495099251328:use_label <- params$use_label
1495099253377:source('global.R')
1495099253490:setEmsTheme(base_size = 12)
1495099253525:# Load customer data
1495099253527:load(sprintf('data/%s_extra_sent_clean.RData', selected_customer))
1495099494401:raw_data <- read_excel('data/customer-sent-IR-purchases/orders 02.22-03.01 Emarsys.xlsx') %>% data.table()
1495099507548:raw_data
1495099510808:setnames(
1495099510809:raw_data,
1495099510810:c("Order ID", "Order Date", "Customer ID", "Coupon Codes", "Discount", "TOTAL  before vouchers", "TOTAL  after vouchers",
1495099510811:"Margin before discount value", "Margin after discount value", "Date of Order"),
1495099510812:c("order_id", "event_time", "external_id", "coupon_code", "discount_value", "sales_amount_before_vouchers", "sales_amount",
1495099510813:"net_profit_before_dicount", "net_profit", "purchase_date")
1495099510814:)
1495099512380:contact_id_external_id <- getSqlResult(
1495099512380:query = 'SELECT external_id, source_id as contact_id
1495099512381:FROM #{customer_name}.dim_contact
1495099512382:WHERE external_id IN (#{external_id_list});',
1495099512382:database_name = 'si',
1495099512382:customer_name = "brand_alley",
1495099512383:external_id_list = paste0("'", unique(raw_data[, external_id]),"'", collapse = ',')
1495099512383:)
1495099521980:contact_id_external_id <- getSqlResult(
1495099521982:query = 'SELECT external_id, source_id as contact_id
1495099521982:FROM #{customer_name}.dim_contact
1495099521983:WHERE external_id IN (#{external_id_list});',
1495099521983:database_name = 'si',
1495099521984:customer_name = "brand_alley",
1495099521984:external_id_list = paste0("'", unique(raw_data[, external_id]),"'", collapse = ',')
1495099521984:)
1495099540971:contact_id_external_id[, external_id := as.numeric(external_id)]
1495099542093:product_level_purchases <- merge(raw_data, contact_id_external_id, by = 'external_id', all.x = T) %>%
1495099542094:.[, external_id := NULL]
1495099543517:product_level_purchases[, purchase_date := as.Date(purchase_date, format = '%d/%m/%Y')]
1495099545260:# aggregate by orders
1495099545528:purchases_customer <- product_level_purchases[,
1495099546222:lapply(.SD, sum),
1495099546534:.SDcols = c('sales_amount', 'net_profit'),
1495099546853:by = .(event_time, purchase_date, contact_id, order_id)
1495099547140:] %>%
1495099547141:.[order(event_time)] %>%
1495099547142:.[, shipping_paid := 5.95]
1495099551533:save(
1495099551535:list = c('product_level_purchases', 'purchases_customer'),
1495099551535:file = 'data/brand_alley_extra_sent_clean.RData'
1495099551536:)
1495099559105:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495099559108:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495099559111:selected_customer <- params$customer
1495099559116:balance <- params$balance
1495099559118:resample <- params$resample
1495099559120:use_label <- params$use_label
1495099561163:source('global.R')
1495099561268:setEmsTheme(base_size = 12)
1495099561300:# Load customer data
1495099561302:load(sprintf('data/%s_extra_sent_clean.RData', selected_customer))
1495099561411:# Load incentive history
1495099561412:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495099564189:n_bins <- 4
1495099564192:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495099564353:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495099575003:recom_history
1495099578654:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495099587423:recom_history[, table(incentive_class)]
1495099594688:recom_history[, table(incentive_class, useNA = 'ifany')]
1495099601653:source('global.R')
1495099601741:setEmsTheme(base_size = 12)
1495099601770:# Load customer data
1495099601772:load(sprintf('data/%s_extra_sent_clean.RData', selected_customer))
1495099601875:# Load incentive history
1495099601877:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495099604684:n_bins <- 4
1495099604687:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495099608053:selected_time_window <- ifelse(
1495099608055:is.null(customer_settings[[selected_customer]]$incentive_expiration_days),
1495099608056:ATTRIBUTION_TIME_WINDOW,
1495099608058:customer_settings[[selected_customer]]$incentive_expiration_days
1495099608061:)
1495099608064:recom_history_w_attributions <- attributePurchasesToRecomHistoryByTime(recom_history[campaign_start_date == '2017-02-22'],
1495099608066:purchases = purchases_customer,
1495099608067:time_window = 7,
1495099608069:filter = "clicked")
1495099686817:recom_history_w_attributions[, .(
1495099686819:count = .N,
1495099686837:purchased = sum(did_buy),
1495099686839:total_sales_amount = sum(sales_amount, na.rm = T),
1495099686840:total_net_profit = sum(net_profit, na.rm = TRUE)
1495099686843:), keyby = .(incentive_class, incentive_value)]
1495099697105:recom_history_w_attributions %>%
1495099697107:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495099697108:plotValuesBy(label = use_label) %>%
1495099697110:facetBy(label = 'Open rate')
1495099713990:recom_history_w_attributions %>%
1495099713991:calculateRateWithErrorsBayesian(variable = 'did_open')
1495099722070:recom_history_w_attributions
1495099733689:recom_history_w_attributions %>% calculateRateWithErrorsBayesian(variable = 'did_open')
1495099744914:if (balance == TRUE) {
1495099744916:recom_history_w_attributions <- addBalancingWeights(recom_history_w_attributions)
1495099744918:} else {
1495099744921:recom_history_w_attributions <- recom_history_w_attributions[, weights := 1]
1495099744923:}
1495099747969:recom_history_w_attributions %>%
1495099747971:calculateRateWithErrorsBayesian(variable = 'did_open') %>%
1495099747972:plotValuesBy(label = use_label) %>%
1495099747975:facetBy(label = 'Open rate')
1495099751985:recom_history_w_attributions %>%
1495099751986:calculateRateWithErrorsBayesian(variable = 'did_open', by = 'prob_group') %>%
1495099751988:plotValuesBy(label = use_label) %>%
1495099751990:facetBy('prob_group', label = 'Open rate', nrow = 1)
1495099756097:recom_history_w_attributions[did_open == TRUE] %>%
1495099756098:calculateRateWithErrorsBayesian(variable = 'did_click') %>%
1495099756100:plotValuesBy(label = use_label) %>%
1495099756101:facetBy(label = 'Click-through rate')
1495099759133:recom_history_w_attributions[did_open == TRUE] %>%
1495099759134:calculateRateWithErrorsBayesian(variable = 'did_click', by = 'prob_group') %>%
1495099759136:plotValuesBy(label = use_label) %>%
1495099759137:facetBy('prob_group', label = 'Click-through rate', nrow = 1)
1495099764006:recom_history_w_attributions %>%
1495099764008:calculateRateWithErrorsBayesian(variable = 'did_buy') %>%
1495099764009:plotValuesBy(label = use_label) %>%
1495099764011:facetBy(label = 'Purchase rate')
1495099767317:recom_history_w_attributions %>%
1495099767319:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495099767321:plotValuesBy(label = use_label) %>%
1495099767323:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495099772771:recom_history_w_attributions[did_open == TRUE] %>%
1495099772772:calculateRateWithErrorsBayesian(variable = 'did_buy') %>%
1495099772773:plotValuesBy(label = use_label) %>%
1495099772775:facetBy(label = 'Purchase rate')
1495099775351:recom_history_w_attributions[did_open == TRUE] %>%
1495099775353:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495099775356:plotValuesBy(label = use_label) %>%
1495099775359:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495099779714:recom_history_w_attributions[did_click == TRUE] %>%
1495099779716:calculateRateWithErrorsBayesian(variable = 'did_buy') %>%
1495099779717:plotValuesBy(label = use_label) %>%
1495099779719:facetBy(label = 'Purchase rate')
1495099782640:recom_history_w_attributions[did_click == TRUE] %>%
1495099782642:calculateRateWithErrorsBayesian(variable = 'did_buy', by = 'prob_group') %>%
1495099782643:plotValuesBy(label = use_label) %>%
1495099782645:facetBy('prob_group', label = 'Purchase rate', nrow = 1)
1495099821147:recom_history_w_attributions %>%
1495099821148:.[, .(value = sum(sales_amount*weights, na.rm = TRUE)), by = .(incentive_class, prob_group)] %>%
1495099821150:plotValuesBy(error = FALSE) %>%
1495099821151:facetBy('prob_group', label = 'Total revenue', nrow = 1)
1495099885863:recom_history_w_attributions %>%
1495099885865:.[, .(value = sum(net_profit*weights, na.rm = TRUE)), by = .(campaign_start_date, incentive_class)] %>%
1495099885867:plotValuesBy(error = FALSE) %>%
1495099885869:facetBy("campaign_start_date", label = 'Total net revenue')
1495099963802:recom_history_w_attributions %>%
1495099963803:.[, .(value = sum(net_profit*weights, na.rm = TRUE)), by = .(prob_group, incentive_class)] %>%
1495099963804:plotValuesBy(error = FALSE) %>%
1495099963806:facetBy("prob_group", label = 'Total net revenue')
1495100056688:fillZerosForNA_(recom_history_w_attributions, cols = 'net_profit')
1495100058088:recom_history_w_attributions %>%
1495100058090:calculateMeanWithErrorsFrequentist(variable = 'net_profit') %>%
1495100058091:plotValuesBy() %>%
1495100058093:facetBy(label = 'Net revenue per person')
1495100122640:recom_history_w_attributions %>%
1495100122643:.[, .(value = sum(net_profit*weights, na.rm = TRUE)), by = .(prob_group, incentive_class)] %>%
1495100122644:plotValuesBy(error = FALSE) %>%
1495100122646:facetBy("prob_group", label = 'Total net revenue', nrow = 1)
1495100130457:recom_history_w_attributions %>%
1495100130458:calculateMeanWithErrorsFrequentist(variable = 'net_profit', by = 'prob_group') %>%
1495100130460:plotValuesBy() %>%
1495100130461:facetBy('prob_group', label = 'Net revenue per person', nrow = 1)
1495101360263:recom_history
1495101395536:recom_history[campaign_id == 1246965][!is.na(buying_probability)]
1495101407145:recom_history[campaign_id == 1246965][!is.na(buying_probability)][buying_probability > 0.7]
1495101409587:recom_history[campaign_id == 1246965][!is.na(buying_probability)][buying_probability > 0.5]
1495101412241:recom_history[campaign_id == 1246965][!is.na(buying_probability)][buying_probability > 0.2]
1495101413998:recom_history[campaign_id == 1246965][!is.na(buying_probability)][buying_probability > 0.1]
1495101430614:recom_history[table(campaign_id)]
1495101463330:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495101463333:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495101463334:selected_customer <- params$customer
1495101463338:balance <- params$balance
1495101463340:resample <- params$resample
1495101463341:source <- params$source
1495101465852:source('global.R')
1495101476303:source('global.R')
1495101485458:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495101507907:recom_history[, table(campaign_id)]
1495101531876:recom_history[buying_probability > 0.7]
1495101546156:recom_history[, table(buying_probability > 0.7)]
1495101559160:recom_history[, table(buying_probability > 0.7, campaign_id)]
1495101577182:recom_history[, table(buying_probability > 0.5, campaign_id)]
1495101597007:recom_history[, table(buying_probability > 0.1, campaign_id)]
1495101666120:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495101666123:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495101666126:selected_customer <- params$customer
1495101666128:balance <- params$balance
1495101666130:resample <- params$resample
1495101666132:data_source <- params$source
1495101668191:source('global.R')
1495101691520:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495101691522:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495101691525:selected_customer <- params$customer
1495101691529:balance <- params$balance
1495101691531:resample <- params$resample
1495101691532:data_source <- params$data_source
1495101693073:source('global.R')
1495101703111:source
1495101724901:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495101724903:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495101724904:selected_customer <- params$customer
1495101724907:balance <- params$balance
1495101724910:resample <- params$resample
1495101724914:data_source <- params$source
1495101727398:source('global.R')
1495101727500:setEmsTheme(base_size = 12)
1495101727537:# Load incentive history
1495101727538:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495101733248:n_bins <- 4
1495101733251:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495101733708:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495544040295:packrat::status()
1495544065071:packrat::restore(prompt = FALSE)
1495544082913:install.packages("git2r")
1495544091886:packrat::restore()
1495544169411:devtools::install_github('Rexamine/stringi')
1495544180433:install.packages("devtools")
1495544189938:devtools::install_github('Rexamine/stringi')
1495544685225:packrat::restore(prompt = FALSE)
1495544987831:source('app.R')
1495609589324:knitr::opts_knit$set(root.dir = normalizePath(".."))
1495609589327:knitr::opts_chunk$set(echo = FALSE, results = "hide", message = FALSE)
1495609589329:selected_customer <- params$customer
1495609589331:balance <- params$balance
1495609589334:resample <- params$resample
1495609589338:data_source <- params$source
1495609591508:source('global.R')
1495609594593:setEmsTheme(base_size = 12)
1495609594651:# Load incentive history
1495609594653:load(sprintf('data/enriched_recom_history_data_%s.RData', selected_customer))
1495609605565:n_bins <- 4
1495609605569:recom_history[, prob_group := ceiling(buying_probability_group/100 * n_bins)]
1495609605600:recom_history <- recom_history[incentive_class == '', incentive_class := 'control']
1495609619606:recom_history
1495609621332:recom_history
1495609635709:recom_history[, table(campaign_id)]
1495610044278:q()
1495709139738:packrat::status()
1495709250018:source("global.R")
1495709272070:install.packages('emsconnectr', type = 'source')
1495709314747:devtools::install_github('rstats-db/bigrquery)
1495709321060:devtools::install_github('rstats-db/bigrquery')
1495709516015:install.packages('emsconnectr', type = 'source')
1495709978350:source('global.R')
1495710127558:install.packages('data.table')
1495710155072:remove.packages("data.table", lib="~/projects/360-view/packrat/lib/x86_64-apple-darwin13.4.0/3.3.3")
1495710161884:install.packages('data.table')
1495710179566:install.packages('data.table', type = 'source')
1495711780561:source('global.R')
1495711790669:cucc <- emsconnectr::getListOfAllCustomers()
1495711792091:cucc
1495711833198:cucc <- emsconnectr::getListOfAllCustomers()
1495711839421:emsconnectr::getListOfAllCustomers()
1495711844517:emsconnectr::getListOfAllCustomers(refetch = TRUE)
1495711848438:warnings()
1495711864584:emsconnectr::getListOfAllCustomers()
1495711867831:emsconnectr::getListOfAllCustomers(refetch = TRUE)
1495711881693:cucc <- emsconnectr::getListOfAllCustomers()
1495711882902:cucc
1495711892342:head(cucc, 200)
1495711899336:head(cucc, 500)
1495711902974:head(cucc, 400)
1495711907519:head(cucc, 450)
1495712251417:packrat::snapshot(prompt = FALSE)
1495712364358:source('app.R')
1495712434532:source('app.R')
1495712670499:selected_customer <- 'Bulk_Powders'
1495712671832:all_data <- merge(
1495712671833:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495712671834:readInPurchase(customer_name = selected_customer),
1495712671834:by = 'contact_id',
1495712671834:all.x = TRUE
1495712671835:)[
1495712671835:is.na(amount),
1495712671836:amount := 0
1495712671836:]
1495712677087:all_data
1495712678553:all_data
1495713042196:all_data <- merge(
1495713042197:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495713042198:readInPurchase(customer_name = selected_customer),
1495713042198:by = 'contact_id',
1495713042199:all.x = TRUE
1495713042199:)[
1495713042200:is.na(amount),
1495713042200:amount := 0
1495713042201:]
1495713048376:all_data
1495713049224:all_data
1495713071202:all_data <- merge(
1495713071203:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495713071203:readInPurchase(customer_name = selected_customer),
1495713071204:by = 'contact_id',
1495713071204:all.x = TRUE
1495713071205:) %>%
1495713071205:.[is.na(amount), amount := 0] %>% .[]
1495718818048:all_data
1495718955732:set.seed(20170525)
1495718957755:contact_clusters <- kmeans(all_data[, .(num_delivered, open_rate, click_rate, amount)], centers = 6)
1495718974328:all_data[, .(num_delivered, open_rate, click_rate, amount)]
1495718979975:all_data[, .(num_delivered, open_rate, click_rate, amount)] %>% na.omit()
1495718995231:all_data[, .(num_delivered, open_rate, click_rate, amount)] %>% .[is.na(num_delivered)]
1495719001702:all_data[, .(num_delivered, open_rate, click_rate, amount)] %>% .[is.na(open_rate)]
1495719018376:contact_clusters <- kmeans(
1495719018376:all_data[num_delivered > 0, .(num_delivered, open_rate, click_rate, amount)],
1495719018377:centers = 6
1495719018378:)
1495719024584:contact_clusters
1495719043972:contact_clusters$centeres
1495719049997:contact_clusters$centers
1495719468631:selected_customer <- 'Bulk_Powders'
1495719469927:all_data <- merge(
1495719469927:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495719469928:readInPurchase(customer_name = selected_customer),
1495719469929:by = 'contact_id',
1495719469929:all.x = TRUE
1495719469930:) %>%
1495719469930:.[is.na(amount), amount := 0] %>% .[]
1495719610651:all_data
1495719711188:all_data <- merge(
1495719711188:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495719711189:readInPurchase(customer_name = selected_customer),
1495719711190:by = 'contact_id',
1495719711190:all.x = TRUE
1495719711191:) %>%
1495719711191:.[is.na(amount), amount := 0] %>% .[]
1495720107590:all_data
1495720129541:set.seed(20170525)
1495720129939:contact_clusters <- kmeans(
1495720129940:all_data[num_delivered > 0, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)],
1495720129941:centers = 6
1495720129941:)
1495720130833:contact_clusters$centers
1495720866837:contact_clusters <- kmeans(
1495720866839:all_data[num_delivered > 0, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)],
1495720866839:centers = 4
1495720866840:)
1495720867214:contact_clusters$centers
1495720911784:all_data$targeted_for %>% hist()
1495720920783:all_data$targeted_since %>% hist()
1495721065970:data_to_clustering <- all_data[num_delivered > 0, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)] %>%
1495721065972:scale()
1495721070385:data_to_clustering
1495721090309:data_for_clustering <- all_data[num_delivered > 0, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)] %>%
1495721090309:scale()
1495721092769:set.seed(20170525)
1495721093343:contact_clusters <- kmeans(
1495721093344:data_for_clustering,
1495721093344:centers = 4
1495721093345:)
1495721094864:contact_clusters$centers
1495721127306:data_for_clustering
1495721138002:data_for_clustering %>% str()
1495721156585:data_for_clustering$dimnames(0)
1495721158465:data_for_clustering$dimnames()
1495721171265:attr(data_for_clustering)
1495721200302:attributes(data_for_clustering)
1495721213581:attributes(data_for_clustering)
1495721216733:attributes(data_for_clustering) %>% str
1495721223940:attributes(data_for_clustering)['dimnames']
1495721234765:attributes(data_for_clustering)['scaled:center']
1495721244366:contact_clusters
1495721333046:norm_means <- attributes(data_for_clustering)['scaled:center']
1495721336304:norm_means
1495721341235:norm_means %>% class
1495721354996:norm_means <- attributes(data_for_clustering)[['scaled:center']]
1495721357771:norm_means %>% class
1495721360426:norm_means
1495721367335:contact_clusters$centers * norm_sds
1495721370300:norm_sds <- attributes(data_for_clustering)[['scaled:scale']]
1495721372898:contact_clusters$centers * norm_sds
1495721378523:contact_clusters$centers
1495721382202:norm_sds
1495721412339:20.7633*7.09356
1495721464681:contact_clusters$centers
1495721469118:contact_clusters$centers$targeted_since
1495721474640:contact_clusters$centers['targeted_since']
1495721480952:contact_clusters$centers %>% str
1495721591930:contact_clusters$cluster
1495721595997:all_data[, cluster := contact_clusters$cluster]
1495721617027:all_data <- merge(
1495721617028:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495721617029:readInPurchase(customer_name = selected_customer),
1495721617030:by = 'contact_id',
1495721617031:all.x = TRUE
1495721617031:) %>%
1495721617032:.[num_delivered > 0] %>%
1495721617032:.[is.na(amount), amount := 0] %>% .[]
1495721619162:data_for_clustering <- all_data[, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)] %>%
1495721619162:scale()
1495721620620:norm_means <- attributes(data_for_clustering)[['scaled:center']]
1495721623533:set.seed(20170525)
1495721623933:contact_clusters <- kmeans(
1495721623934:data_for_clustering,
1495721623935:centers = 4
1495721623935:)
1495721626111:all_data[, cluster := contact_clusters$cluster]
1495721631006:all_data
1495721641903:all_data[, lapply(.SD, mean)]
1495721717366:all_data <- merge(
1495721717367:readInRates(customer_name = selected_customer) %>% calculateRates(),
1495721717368:readInPurchase(customer_name = selected_customer),
1495721717369:by = 'contact_id',
1495721717369:all.x = TRUE
1495721717369:) %>%
1495721717370:.[num_delivered > 0] %>%
1495721717370:.[is.na(amount), amount := 0]
1495721718654:cluster_data <- all_data[, .(targeted_since, targeted_for, num_delivered, open_rate, click_rate, amount)]
1495721720514:set.seed(20170525)
1495721721018:contact_clusters <- kmeans(
1495721721018:scale(cluster_data),
1495721721019:centers = 4
1495721721020:)
1495721730549:all_data[, cluster := contact_clusters$cluster]
1495721784155:variables_used_for_clustering <- c('targeted_since', 'targeted_for', 'num_delivered', 'open_rate', 'click_rate', 'amount')
1495721784930:cluster_data <- all_data[, variables_used_for_clustering, with = FALSE]
1495721788806:cluster_data
1495721810894:set.seed(20170525)
1495721811218:contact_clusters <- kmeans(
1495721811218:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495721811219:centers = 4
1495721811220:)
1495721812517:all_data[, cluster := contact_clusters$cluster]
1495721812942:all_data[, lapply(.SD, mean, .SDcols = variables_used_for_clustering)]
1495721826837:all_data[, lapply(.SD, mean), .SDcols = variables_used_for_clustering]
1495721835695:all_data[, lapply(.SD, mean), .SDcols = variables_used_for_clustering, by = cluster]
1495721839197:all_data[, lapply(.SD, mean), .SDcols = variables_used_for_clustering, keyby = cluster]
1495721867286:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495721881718:contact_clusters <- kmeans(
1495721881719:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495721881720:centers = 6
1495721881721:)
1495721882845:all_data[, cluster := contact_clusters$cluster]
1495721882919:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495721933993:variables_used_for_clustering <- c('targeted_for', 'num_delivered', 'open_rate', 'click_rate', 'amount')
1495721934753:set.seed(20170525)
1495721935054:contact_clusters <- kmeans(
1495721935055:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495721935056:centers = 6
1495721935056:)
1495721935868:all_data[, cluster := contact_clusters$cluster]
1495721936085:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495722077125:set.seed(201705)
1495722077505:contact_clusters <- kmeans(
1495722077505:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495722077506:centers = 6
1495722077506:)
1495722079424:all_data[, cluster := contact_clusters$cluster]
1495722080129:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495722139175:set.seed(20170525)
1495722140312:contact_clusters <- kmeans(
1495722140312:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495722140313:centers = 6
1495722140314:)
1495722144443:all_data[, cluster := contact_clusters$cluster]
1495722144947:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495722173749:all_data[cluster == 4]
1495722184134:all_data[cluster == 4, quantile(open_rate)]
1495722200775:all_data[cluster == 4, quantile(open_rate, c(0.25, 0.5, 0.75))]
1495723161952:all_data[1:3, by = cluster]
1495723174569:all_data[1:3, contact_id, by = cluster]
1495723182720:all_data[1:3, .(contact_id), by = cluster]
1495723188397:all_data[head(3), .(contact_id), by = cluster]
1495723218996:all_data[sample(3), .(contact_id), by = cluster]
1495723246143:all_data[sample(.N, 3), .(contact_id), by = cluster]
1495723264817:all_data[sample(.GRP, 3), .(contact_id), by = cluster]
1495723276656:all_data[sample(.N, 3), .(contact_id), by = cluster]
1495723322942:all_data[, .I(sample(.N, 3)), by = cluster]
1495723469741:all_data[, .I[sample(.N, 3)], by = cluster]
1495723497622:all_data[, .I[sample(.N, 3)], by = cluster]$contact_id
1495723513904:y = c('a','b','c','d','e','f','g','h')
1495723513905:x = sample(2:10,8,replace = TRUE)
1495723513906:z = rep(y,x)
1495723513906:dt = as.data.table( z )
1495723515493:dt
1495723525103:dt[, .I[sample(.N, 1)]]
1495723527838:dt[, .I[sample(.N, 1)]]$z
1495723533121:dt[, .I[sample(.N, 1)]]$V1
1495723538207:dt[, .I[sample(.N, 1)], by = z]$V1
1495723540494:dt[, .I[sample(.N, 1)], by = z]
1495723546059:dt[, .I[sample(.N, 1)], by = z]$V1
1495723561761:all_data[all_data[, .I[sample(.N, 3)], by = cluster]]
1495723570506:all_data[, .I[sample(.N, 3)], by = cluster]
1495723577472:all_data[all_data[, .I[sample(.N, 3)], by = cluster]$V1]
1495723592281:all_data[all_data[, .I[sample(.N, 3)], by = cluster]$V1, .(cluster, contact_id)]
1495723609206:all_data[all_data[, .I[sample(.N, 3)], keyby = cluster]$V1, .(cluster, contact_id)]
1495723652126:all_data[all_data[, .I[sample(.N, 3)], keyby = cluster]$V1, .(cluster, contact_id)] %>%
1495723652127:fwrite(file.path('data', paste(selected_customer, 'cluster_examples.csv', sep = '_')))
1495723703878:set.seed(20170525)
1495723703879:contact_clusters <- kmeans(
1495723703879:scale(all_data[, variables_used_for_clustering, with = FALSE]),
1495723703880:centers = 30
1495723703880:)
1495723706358:all_data[, cluster := contact_clusters$cluster]
1495723706359:all_data[, c(.N, lapply(.SD, mean)), .SDcols = variables_used_for_clustering, keyby = cluster]
1495723706387:# Get typical contacts
1495723706388:all_data[all_data[, .I[sample(.N, 3)], keyby = cluster]$V1, .(cluster, contact_id)] %>%
1495723706389:fwrite(file.path('data', paste(selected_customer, 'cluster_examples_30.csv', sep = '_')))
1495784967130:source('global.R')
1495785509419:install.packages('emsconnectr', type = 'source')
1495785530690:getOption('repos')
1495785538764:.myfuncs$useEmarsysCRAN()
1495785540887:getOption('repos')
1495785544545:install.packages('emsconnectr', type = 'source')
1495785580372:library(emsconnectr)
1495785584905:readSqlResult(
1495785584905:query = "
1495785584906:SELECT *
1495785584907:FROM contact_locations
1495785584907:WHERE customer_id = 295565849
1495785584908:AND source_event_type = 'open'
1495785584909:AND event_time > '2017-05-22'
1495785584909:",
1495785584910:result_file_name = 'cunda-at_opens-with-geo.csv'
1495785584910:)
1495785602021:?readSqlResult
1495785682291:readSqlResult(
1495785682292:query = 'sql/cunda_opens_with_geo.sql',
1495785682293:result_file_name = 'cunda-at_opens-with-geo.csv'
1495785682294:)
1495785689430:readSqlResult(
1495785689432:sql_file = 'sql/cunda_opens_with_geo.sql',
1495785689433:result_file_name = 'cunda-at_opens-with-geo.csv'
1495785689433:)
1495785757456:cunda_geo <- readSqlResult(
1495785757458:sql_file = 'sql/cunda_opens_with_geo.sql',
1495785757459:result_file_name = 'cunda-at_opens-with-geo.csv'
1495785757460:)
1495785768877:cunda_geo[, .N, by = zip_code]
1495785782603:cunda_geo[, .N, by = .(country_code, zip_code)]
1495785797706:cunda_geo[, .N, by = .(country_code, city, zip_code)][order(-N)]
1495785898179:cunda_geo[, .N, by = .(country_code, city, zip_code)][order(-N)][1:25]
1495785904387:cunda_geo[, .N, by = .(country_code, city, zip_code)][order(-N)][1:20]
1495785965076:cunda_geo[, c(.N, mean(latitude), mean(longitude)), by = .(country_code, city, zip_code)][order(-N)]
1495786176969:cunda_geo <- readSqlResult(
1495786176970:sql_file = 'sql/cunda_opens_with_geo.sql',
1495786176971:result_file_name = 'cunda-at_opens-with-geo.csv',
1495786176971:refetch = TRUE
1495786176971:)
1495786280384:cunda_geo <- readSqlResult(
1495786280385:sql_file = 'sql/cunda_opens_with_geo.sql',
1495786280385:result_file_name = 'cunda-at_opens-with-geo.csv',
1495786280386:refetch = TRUE
1495786280386:)
1495786341524:cunda_geo[, c(.N, mean(latitude), mean(longitude)), by = .(country_code, city, zip_code)][order(-N)]
1495786354186:cunda_geo[, .(.N, mean(latitude), mean(longitude)), by = .(country_code, city, zip_code)][order(-N)]
1495786669775:names(cunda_geo)
1495787291945:cunda_geo$city_geoname_id[1:]
1495787293354:cunda_geo$city_geoname_id[1:5]
1495787325403:cunda_geo$state_province_region[1:5]
1495787376441:cunda_geo[, .(
1495787376442:contact_id,
1495787376442:launch_id = NULL,
1495787376443:domain = NULL,
1495787376444:email_sent_at = NULL,
1495787376444:campaign_type = NULL,
1495787376445:platform = NULL,
1495787376446:md5 = NULL,
1495787376446:mobile = NULL,
1495787376447:anonymized = NULL,
1495787376447:uid = NULL,
1495787376448:ip_address = ip,
1495787376448:user_agent = NULL,
1495787376448:customer_id,
1495787376449:campaign_id = NULL,
1495787376449:message_id = NULL,
1495787376450:event_time,
1495787376451:loaded_at,
1495787376451:latitude,
1495787376452:longitude,
1495787376452:country_code,
1495787376453:city,
1495787376453:zip_code,
1495787376454:geo_name_id = city_geoname_id,
1495787376455:locale_code,
1495787376458:subdivision_name = state_province_region,
1495787376459:timezone = time_zone
1495787376459:)]
1495787393667:cunda_geo[, .(
1495787393668:contact_id,
1495787393669:launch_id = NULL,
1495787393669:domain = NULL,
1495787393670:email_sent_at = NULL,
1495787393670:campaign_type = NULL,
1495787393671:platform = NULL,
1495787393671:md5 = NULL,
1495787393672:mobile = NULL,
1495787393673:anonymized = NULL,
1495787393673:uid = NULL,
1495787393674:ip = ip_address,
1495787393675:user_agent = NULL,
1495787393676:customer_id,
1495787393676:campaign_id = NULL,
1495787393677:message_id = NULL,
1495787393677:event_time,
1495787393681:loaded_at,
1495787393682:latitude,
1495787393683:longitude,
1495787393683:country_code,
1495787393684:city,
1495787393685:zip_code,
1495787393685:geo_name_id = city_geoname_id,
1495787393686:locale_code,
1495787393687:subdivision_name = state_province_region,
1495787393687:timezone = time_zone
1495787393688:)]
1495787416346:cunda_geo[, .(
1495787416347:contact_id,
1495787416348:launch_id = NULL,
1495787416349:domain = NULL,
1495787416349:email_sent_at = NULL,
1495787416350:campaign_type = NULL,
1495787416350:platform = NULL,
1495787416351:md5 = NULL,
1495787416351:mobile = NULL,
1495787416352:anonymized = NULL,
1495787416352:uid = NULL,
1495787416353:ip = ip_address,
1495787416353:user_agent = NULL,
1495787416354:customer_id,
1495787416355:campaign_id = NULL,
1495787416356:message_id = NULL,
1495787416357:event_time,
1495787416358:loaded_at,
1495787416358:latitude,
1495787416359:longitude,
1495787416360:country_code,
1495787416360:city,
1495787416361:zip_code,
1495787416362:geo_name_id = city_geoname_id,
1495787416363:locale_code,
1495787416363:subdivision_name = state_province_region,
1495787416364:timezone = time_zone
1495787416364:)] %>% fwrite('cunda_geo_to_load.csv')
1495787435489:source('global.R')
1495787461260:fwrite(cunda_geo[, .(
1495787461260:contact_id,
1495787461261:launch_id = NULL,
1495787461262:domain = NULL,
1495787461262:email_sent_at = NULL,
1495787461263:campaign_type = NULL,
1495787461263:platform = NULL,
1495787461264:md5 = NULL,
1495787461264:mobile = NULL,
1495787461265:anonymized = NULL,
1495787461265:uid = NULL,
1495787461266:ip = ip_address,
1495787461266:user_agent = NULL,
1495787461267:customer_id,
1495787461267:campaign_id = NULL,
1495787461268:message_id = NULL,
1495787461268:event_time,
1495787461269:loaded_at,
1495787461269:latitude,
1495787461270:longitude,
1495787461271:country_code,
1495787461275:city,
1495787461276:zip_code,
1495787461277:geo_name_id = city_geoname_id,
1495787461278:locale_code,
1495787461278:subdivision_name = state_province_region,
1495787461280:timezone = time_zone
1495787461280:)], 'cunda_geo_to_load.csv')
1495787475728:install.packages('data.table', type = 'source')
1495787496096:source('global.R')
1495787519828:cunda_geo[, .(
1495787519829:contact_id,
1495787519830:launch_id = NULL,
1495787519831:domain = NULL,
1495787519831:email_sent_at = NULL,
1495787519832:campaign_type = NULL,
1495787519832:platform = NULL,
1495787519833:md5 = NULL,
1495787519834:mobile = NULL,
1495787519837:anonymized = NULL,
1495787519838:uid = NULL,
1495787519839:ip = ip_address,
1495787519839:user_agent = NULL,
1495787519840:customer_id,
1495787519841:campaign_id = NULL,
1495787519842:message_id = NULL,
1495787519845:event_time,
1495787519846:loaded_at,
1495787519847:latitude,
1495787519848:longitude,
1495787519849:country_code,
1495787519850:city,
1495787519852:zip_code,
1495787519853:geo_name_id = city_geoname_id,
1495787519854:locale_code,
1495787519855:subdivision_name = state_province_region,
1495787519856:timezone = time_zone
1495787519856:)] %>% fwrite('cunda_geo_to_load.csv')
1495787991428:cunda_geo[, .(
1495787991428:.N,
1495787991429:latitude = mean(latitude),
1495787991430:longitude = mean(longitude)
1495787991431:),
1495787991432:by = .(country_code, city, zip_code)
1495787991433:][order(-N)]
1495788004838:mapWorld <- borders("world", colour = "gray70", fill = "gray50", size = 0.1)
1495788025631:aggregated_dt <- cunda_geo[, .(
1495788025633:.N,
1495788025633:latitude = mean(latitude),
1495788025634:longitude = mean(longitude)
1495788025634:),
1495788025635:by = .(country_code, city, zip_code)
1495788025635:]
1495788027854:ggplot() +
1495788027855:mapWorld +
1495788027856:geom_point(
1495788027856:aes(x = longitude, y = latitude, size = log(n_opens)),
1495788027857:alpha = alpha, color = 'firebrick',
1495788027857:data = aggregated_dt
1495788027858:)
1495788039051:ggplot() +
1495788039051:mapWorld +
1495788039052:geom_point(
1495788039053:aes(x = longitude, y = latitude, size = N),
1495788039053:alpha = alpha, color = 'firebrick',
1495788039054:data = aggregated_dt
1495788039055:)
1495788052854:aggregated_dt
1495788066919:aggregated_dt[is.na(latitude)]
1495788071243:aggregated_dt[is.na(longitude)]
1495788084546:ggplot() + mapWorld
1495788106332:ggplot(aggregated_dt, aes(x = longitude, y = latitude)) + geom_point(alpha = 0.3)
1495788124778:ggplot() +
1495788124779:mapWorld +
1495788124780:geom_point(
1495788124780:aes(x = longitude, y = latitude),
1495788124781:alpha = alpha, color = 'firebrick',
1495788124781:data = aggregated_dt
1495788124782:)
1495788142426:ggplot(aggregated_dt, aes(x = longitude, y = latitude)) + geom_point(alpha = 0.3) +
1495788142427:mapWorld
1495788165266:mapWorld +
1495788165266:ggplot(aggregated_dt, aes(x = longitude, y = latitude)) + geom_point(alpha = 0.3) +
1495788174410:mapWorld +
1495788174410:ggplot(aggregated_dt, aes(x = longitude, y = latitude)) + geom_point(alpha = 0.3)
1495788198464:ggplot() + geom_point(aes(x = longitude, y = latitude), alpha = 0.3, data = aggregated_dt)
1495788208129:ggplot() + mapWorld +geom_point(aes(x = longitude, y = latitude), alpha = 0.3, data = aggregated_dt)
1495788227548:ggplot() +
1495788227549:mapWorld +
1495788227550:geom_point(
1495788227550:aes(x = longitude, y = latitude),
1495788227551:alpha = 0.2, color = 'firebrick',
1495788227551:data = aggregated_dt
1495788227552:)
1495788305052:ggplot() +
1495788305052:mapWorld +
1495788305053:geom_point(
1495788305053:aes(x = longitude, y = latitude, size = N),
1495788305054:alpha = 0.1, color = 'firebrick',
1495788305054:data = aggregated_dt
1495788305055:)
1495788326851:mapWorld <- borders("world", colour = "gray70", fill = "gray50", size = 0.1)
1495788326957:ggplot() +
1495788326957:mapWorld +
1495788326958:geom_point(
1495788326958:aes(x = longitude, y = latitude, size = log(N)),
1495788326958:alpha = 0.1, color = 'firebrick',
1495788326959:data = aggregated_dt
1495788326959:)
1495788354676:ggplot() +
1495788354676:mapWorld +
1495788354677:geom_point(
1495788354678:aes(x = longitude, y = latitude, color = log(N)),
1495788354678:alpha = 0.1, color = 'firebrick',
1495788354679:data = aggregated_dt
1495788354680:)
1495788363170:ggplot() +
1495788363171:mapWorld +
1495788363172:geom_point(
1495788363172:aes(x = longitude, y = latitude, fill = log(N)),
1495788363173:alpha = 0.1, color = 'firebrick',
1495788363174:data = aggregated_dt
1495788363175:)
1495788379255:ggplot() +
1495788379255:mapWorld +
1495788379256:geom_point(
1495788379257:aes(x = longitude, y = latitude, color = log(N)),
1495788379257:alpha = 0.1,
1495788379258:data = aggregated_dt
1495788379258:)
1495788470070:ggplot() +
1495788470071:mapWorld +
1495788470072:geom_point(
1495788470072:aes(x = longitude, y = latitude, size = log(N)),
1495788470072:alpha = 0.1, color = 'firebrick', show_guide = FALSE,
1495788470073:data = aggregated_dt
1495788470073:)
1495788680443:library(plotly)
1495788728870:plot_ly(
1495788728870:aggregated_dt,
1495788728871:lat = latitude, lon = longitude, text = paste0(city, ': ', N),
1495788728871:type = 'scattergeo', mode = 'markers',
1495788728872:marker = list(
1495788728872:size = 2*log(N),
1495788728873:opacity = 0.5,
1495788728873:line = list(width = 0)
1495788728874:)
1495788728874:) %>%
1495788728874:layout(
1495788728875:geo = list(
1495788728875:showframe = FALSE,
1495788728876:showland = TRUE,
1495788728876:resolution = 50,
1495788728877:showcountries = TRUE,
1495788728877:projection = list(type = 'Mercator'),
1495788728878:landcolor = toRGB("gray80"),
1495788728878:countrycolor = toRGB("white"),
1495788728880:showcoastlines = TRUE,
1495788728881:coastlinecolor = toRGB("white"),
1495788728881:countrywidth = 0.5
1495788728882:)
1495788728883:)
1495788909528:plot_ly(
1495788909528:aggregated_dt,
1495788909529:lat = latitude, lon = longitude, text = paste0(city, ': ', N),
1495788909530:type = 'scattergeo', mode = 'markers',
1495788909530:marker = list(
1495788909531:size = 10*log(N),
1495788909531:opacity = 0.5,
1495788909532:line = list(width = 0)
1495788909532:)
1495788909533:) %>%
1495788909533:layout(
1495788909534:geo = list(
1495788909534:showframe = FALSE,
1495788909535:showland = TRUE,
1495788909536:resolution = 50,
1495788909536:showcountries = TRUE,
1495788909537:projection = list(type = 'Mercator'),
1495788909538:landcolor = toRGB("gray80"),
1495788909539:countrycolor = toRGB("white"),
1495788909539:showcoastlines = TRUE,
1495788909540:coastlinecolor = toRGB("white"),
1495788909541:countrywidth = 0.5
1495788909541:)
1495788909542:)
